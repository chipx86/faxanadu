<!DOCTYPE html>

<html>
 <head>
  <title>PRG15_MIRROR - Faxanadu (U).nes</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <style>

 @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');

body {
  background: #1c212d;
  color: white;
  padding: 0.5em;
}

body, * {
  font-family: "Roboto Mono", monospace;
  font-size: 9.5pt;
  font-style: normal;
}

a:link,
a:visited {
  color: #9bdeff;
}

pre {
  display: grid;
  grid-template-columns: minmax(70ch, max-content) 1fr;
  gap: 0 4em;
  margin: 0;
  padding: 0;
}

.equs {
  display: grid;
  grid-template-columns: minmax(50ch, max-content) min-content auto;
  gap: 0 1em;
}

.l {
  display: grid;
  grid-template-columns: subgrid;
  min-height: 1lh;
}

.c,
.cp,
.equs,
.l {
  grid-column: 1 / -1;
}

.cp {
  color: #6fafb5;
}

.c {
  margin-left: 4em;
}

.c, .ce {
  color: #8aa9ac;
}

.ce {
  text-wrap: wrap;
  text-indent: 2ch hanging;
}

.lla {
  margin-left: 2em;
}

.la,
.lla {
  font-weight: bold;
}

.la,
.la:link,
.la:visited {
  color: #e8e801;
}

.lla,
.lla:link,
.lla:visited {
  color: #caca00;
}

.i {
  color: #f26969;
  margin-left: 4em;
  min-width: 3em;
}

.o {
  color: #e3e3e3;
  margin-left: 1ch;
}

  </style>
 </head>
 <body>
  <pre>
<div class="cp">;============================================================================
; Faxanadu (U).nes
;
; PRG15_MIRROR ($c000 - $ffff)
;============================================================================
</div><span class="l"></span>
<span class="l">BASE $c000</span>
<span class="l"></span>
</pre><pre><span class="l"></span>
<div class="cp">;============================================================================
; Write attribute data for the HUD to the PPU.
;
; The attribute data will be written from
; <a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a> based on the
; <a href="RAM.html#HUD_AttributeDataIndex">HUD_AttributeDataIndex</a> set when loading the
; screen.
;
; INPUTS:
;     <a href="RAM.html#HUD_AttributeDataIndex">HUD_AttributeDataIndex</a>:
;         The index into the lookup table for the current
;         screen.
;
;     <a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a>:
;         The lookup table of attribute data to write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The updated PPU address.
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The written data.
;
; CALLS:
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;
; XREFS:
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;============================================================================
</div><span class="l"><a name="UI_SetHUDPPUAttributes" href="#UI_SetHUDPPUAttributes" class="la">UI_SetHUDPPUAttributes:</a><span class="ce">; [$c000]</span></span>
<div class="c">;
; Set the PPUADDR to 0x23C0, the top row where the status
; bar resides.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$23</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper PPUADDR as 0x23.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper PPUADDR as 0xC0.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#HUD_AttributeDataIndex">HUD_AttributeDataIndex</a></span></span><span class="ce">; X = HUD attribute data index, computed when setting up the screen.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c01b,X</span></span><span class="ce">; Load the value for the attribute data.</span></span>
<span class="l"></span>
<div class="c">;
; Write 8 bytes based on data from the lookup table
; <a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a> at index
; <a href="RAM.html#HUD_AttributeDataIndex">HUD_AttributeDataIndex</a>.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; X = 8 (loop counter).</span></span>
<span class="l"></span>
<span class="l"><a name="@_writeLoop" href="#@_writeLoop" class="lla">@_writeLoop:</a><span class="ce">; [$c012]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_writeLoop">@_writeLoop</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Draw the HUD.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawHUD">UI_DrawHUD</a></span></span><span class="ce">; Jump to draw the HUD.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attribute data used for the HUD.
;
; These are indexed by values from lookup table
; <a href="PRG11.html#PALETTE_INDEX_TO_HUD_ATTRIBUTE_INDEX">PALETTE_INDEX_TO_HUD_ATTRIBUTE_INDEX</a> (stored in
; <a href="RAM.html#HUD_AttributeDataIndex">HUD_AttributeDataIndex</a>.
;
; Only values 0, 1, 2, and 3 are used.
;
; The rest seem to be unused, but many end up styled to
; better match regions of the game.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a>
;
</div><span class="l"><a name="HUD_ATTRIBUTE_DATA_BY_INDEX" href="#HUD_ATTRIBUTE_DATA_BY_INDEX" class="la">HUD_ATTRIBUTE_DATA_BY_INDEX:</a><span class="ce">; [$c01b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Dartmoor, Castle of Fraternal, King Grieve's Room</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$55</span></span><span class="ce">; [1]: Start Screen</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$aa</span></span><span class="ce">; [2]: Most exterior areas.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [3]: Most interior areas.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$41</span></span><span class="ce">; [4]: Here and below are unused.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$61</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [12]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [14]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [15]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [16]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [17]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$56</span></span><span class="ce">; [18]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [19]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [20]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [21]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [22]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [23]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; XXX Maybe unused?
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__c033" href="#FUN_PRG15_MIRROR__c033" class="la">FUN_PRG15_MIRROR__c033:</a><span class="ce">; [$c033]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c04a" href="#@LAB_PRG15_MIRROR__c04a" class="lla">@LAB_PRG15_MIRROR__c04a:</a><span class="ce">; [$c04a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c04a">@LAB_PRG15_MIRROR__c04a</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw the player's state on the HUD UI.
;
; INPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's current MP.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;     <a href="#UI_DrawGoldValue">UI_DrawGoldValue</a>
;     <a href="#UI_DrawPlayerExperience">UI_DrawPlayerExperience</a>
;     <a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a>
;     <a href="#Player_SetMP">Player_SetMP</a>
;     <a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a>
;
; XREFS:
;     <a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a>
;============================================================================
</div><span class="l"><a name="UI_DrawHUD" href="#UI_DrawHUD" class="la">UI_DrawHUD:</a><span class="ce">; [$c058]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawTimeValue">UI_DrawTimeValue</a></span></span><span class="ce">; Draw the time value.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawGoldValue">UI_DrawGoldValue</a></span></span><span class="ce">; Draw the gold value.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerExperience">UI_DrawPlayerExperience</a></span></span><span class="ce">; Draw the player experience value.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw the player's HP bar.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Load the player's MP.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetMP">Player_SetMP</a></span></span><span class="ce">; Set it and draw.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Increase the player's HP.
;
; This will be capped to 80HP.
;
; INPUTS:
;     A:
;         The number of health points to add.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The upper byte of player health to add to.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The new upper byte of player health.
;
; CALLS:
;     <a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a>
;
; XREFS:
;     <a href="PRG14.html#Player_HandleTouchBread">Player_HandleTouchBread</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a name="Player_AddHP" href="#Player_AddHP" class="la">Player_AddHP:</a><span class="ce">; [$c07b]</span></span>
<div class="c">;
; Update the player's HP with the provided value.
;
</div><span class="l"><span><span class="i">CLC</span></span><span class="ce">; Clear carry so it's not added.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Add the provided HP to the player's health.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Store as the new health.</span></span>
<span class="l"></span>
<div class="c">;
; Check against the cap.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Cap at 80 HP.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_drawHP">@_drawHP</a></span></span><span class="ce">; Jump if it's under.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$50</span></span><span class="ce">; Else, cap it to 80HP.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Store as the new health.</span></span>
<span class="l"></span>
<span class="l"><a name="@_drawHP" href="#@_drawHP" class="lla">@_drawHP:</a><span class="ce">; [$c08b]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Decrease the player's HP.
;
; If the HP hits &lt;= 0, and an elixir is in the inventory, it will be used.
; If it hits &lt;= 0 and there's no elixir, the player will die.
;
; INPUTS
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The player's current health.
;
;     <a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a>:
;     <a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a>:
;         The health to add.
;
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's current special items.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The new player health.
;
;     <a href="RAM.html#PlayerIsDead">PlayerIsDead</a>:
;         Set to 1 if the player dies.
;
; CALLS:
;     <a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a>
;     <a href="#Player_UseElixir">Player_UseElixir</a>
;
; XREFS:
;     <a href="PRG14.html#HandlePlayerHitByMagic">HandlePlayerHitByMagic</a>
;     <a href="PRG14.html#Player_ApplyDamage">Player_ApplyDamage</a>
;     <a href="PRG14.html#SpriteBehavior__MaybeSugata">SpriteBehavior__MaybeSugata</a>
;============================================================================
</div><span class="l"><a name="Player_ReduceHP" href="#Player_ReduceHP" class="la">Player_ReduceHP:</a><span class="ce">; [$c08e]</span></span>
<div class="c">;
; Reduce the lower byte of player health.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_L">Player_HP_L</a></span></span><span class="ce">; Load the lower byte of the player's health.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span><span class="ce">; Subtract the specified lower byte of health.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_L">Player_HP_L</a></span></span><span class="ce">; Store it as the new player health.</span></span>
<span class="l"></span>
<div class="c">;
; Reduce the upper byte of player health.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the upper byte of the player's health.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span><span class="ce">; Subtract the specified upper byte of health.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Store it as the new player health.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_isStillAlive">@_isStillAlive</a></span></span><span class="ce">; If there's still health left, the player is still alive.</span></span>
<span class="l"></span>
<div class="c">;
; The player is out of health. They may die.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Set the player's upper byte of health to 0.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw the health.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the player has an elixir before killing them.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the player's special items.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span><span class="ce">; Check if the player has an elixir.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_killPlayer">@_killPlayer</a></span></span><span class="ce">; If not, kill the player.</span></span>
<span class="l"></span>
<div class="c">;
; The player has an elixir. Fill up their health instead
; of killing the player.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_UseElixir">Player_UseElixir</a></span></span><span class="ce">; Use the Elixir.</span></span>
<span class="l"></span>
<div class="c">;
; Mark the player as dead.
;
</div><span class="l"><a name="@_killPlayer" href="#@_killPlayer" class="lla">@_killPlayer:</a><span class="ce">; [$c0b5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; Mark the player as dead.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span><span class="ce">; Store that.</span></span>
<span class="l"></span>
<div class="c">;
; Draw the player's health.
;
</div><span class="l"><a name="@_isStillAlive" href="#@_isStillAlive" class="lla">@_isStillAlive:</a><span class="ce">; [$c0ba]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw player health.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw the player's health.
;
; INPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The full value of the player's health.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a>
;
; XREFS:
;     <a href="#Player_ReduceHP">Player_ReduceHP</a>
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a name="UI_DrawPlayerHP" href="#UI_DrawPlayerHP" class="la">UI_DrawPlayerHP:</a><span class="ce">; [$c0bd]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the player's current health.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a></span></span><span class="ce">; Draw it.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Decrement the MP for a spell.
;
; This will look at the selected magic type and deduct the
; cost from the player's total MP if there's enough to cast.
;
; INPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's current MP.
;
;     <a href="RAM.html#SelectedMagic">SelectedMagic</a>:
;         The selected magic.
;
;     <a href="PRG14.html#MAGIC_COSTS">MAGIC_COSTS</a>:
;         The table of magic costs per spell.
;
; OUTPUTS:
;     C:
;         0 = Cost deducted for the spell.
;         1 = Not enough MP for the spell.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The new MP amount.
;
; CALLS:
;     <a href="#Player_SetMP">Player_SetMP</a>
;
; XREFS:
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;============================================================================
</div><span class="l"><a name="Player_ReduceMP" href="#Player_ReduceMP" class="la">Player_ReduceMP:</a><span class="ce">; [$c0c3]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#SelectedMagic">SelectedMagic</a></span></span><span class="ce">; Load the selected magic spell.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Load the player's total MP.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$b7a9,X</span></span><span class="ce">; Look up the cost of this spell.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_notEnoughMP">@_notEnoughMP</a></span></span><span class="ce">; If there's not enough MP for the spell, then jump.</span></span>
<span class="l"></span>
<div class="c">;
; The player has enough MP for the spell.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Else, store the reduced MP.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetMP">Player_SetMP</a></span></span><span class="ce">; Set that on the player and draw.</span></span>
<span class="l"><span><span class="i">CLC</span></span><span class="ce">; Clear the carry flag to indicate a success.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The player does not have enough mana.
;
</div><span class="l"><a name="@_notEnoughMP" href="#@_notEnoughMP" class="lla">@_notEnoughMP:</a><span class="ce">; [$c0d7]</span></span>
<span class="l"><span><span class="i">SEC</span></span><span class="ce">; Set the carry flag to 1 to indicate not enough MP.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Add points to the player's MP.
;
; This will be capped to 80 points.
;
; INPUTS:
;     A:
;         The MP to add.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's current MP.
;
; OUTPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The new MP.
;
; CALLS:
;     <a href="#Player_SetMP">Player_SetMP</a>
;
; XREFS:
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;============================================================================
</div><span class="l"><a name="Player_AddMP" href="#Player_AddMP" class="la">Player_AddMP:</a><span class="ce">; [$c0d9]</span></span>
<div class="c">;
; Add the provided MP to the player's MP.
;
</div><span class="l"><span><span class="i">CLC</span></span><span class="ce">; Clear carry so it's not added.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Add to the player's  MP.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Check if it's &gt; 80 points.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_drawMP">@_drawMP</a></span></span><span class="ce">; If we're under the cap, return.</span></span>
<span class="l"></span>
<div class="c">;
; Cap the MP to the total allowed amount.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$50</span></span><span class="ce">; Cap to 80 points.</span></span>
<span class="l"></span>
<div class="c">;
; Store it.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_drawMP" href="#@_drawMP" class="lla">@_drawMP:</a><span class="ce">; [$c0e9]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_SetMP">Player_SetMP</a></span></span><span class="ce">; Set the player's mana points and draw.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_Something_ChangeHP
;
; INPUTS:
;     X
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG14.html#FUN_PRG14__8329">FUN_PRG14__8329</a>
;============================================================================
</div><span class="l"><a name="Player_Something_ChangeHP" href="#Player_Something_ChangeHP" class="la">Player_Something_ChangeHP:</a><span class="ce">; [$c0ec]</span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c0fe" href="#@LAB_PRG15_MIRROR__c0fe" class="lla">@LAB_PRG15_MIRROR__c0fe:</a><span class="ce">; [$c0fe]</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">a:<a href="RAM.html#BYTE_04be">BYTE_04be</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#BYTE_04bf">BYTE_04bf</a></span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c124">@LAB_PRG15_MIRROR__c124</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#BYTE_04be">BYTE_04be</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#BYTE_04bf">BYTE_04bf</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c124" href="#@LAB_PRG15_MIRROR__c124" class="lla">@LAB_PRG15_MIRROR__c124:</a><span class="ce">; [$c124]</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c0fe">@LAB_PRG15_MIRROR__c0fe</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear sprite state.
;
; This will clear out all the current sprites and the selected
; weapon, and reset the screen color mode.
;
; INPUTS:
;     <a href="RAM.html#ScreenColorMode">ScreenColorMode</a>:
;         The current screen color mode.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The cleared sprite entities.
;
;     <a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>:
;         The cleared sprite HPs.
;
;     <a href="RAM.html#CurrentSprites_HitCounter">CurrentSprites_HitCounter</a>:
;         The cleared sprite hit counters.
;
;     <a href="RAM.html#CurrentSprites_Subtypes">CurrentSprites_Subtypes</a>:
;         The cleared sprite subtypes.
;
;     <a href="RAM.html#ScreenColorMode">ScreenColorMode</a>:
;         The new color mode with greyscale removed.
;
;     <a href="RAM.html#Temp_03C7">Temp_03C7</a>:
;         Set to 0xFF.
;
; CALLS:
;     <a href="#PPUResetOffset">PPUResetOffset</a>
;
; XREFS:
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_SetupSprites">Screen_SetupSprites</a>
;============================================================================
</div><span class="l"><a name="GameLoop_ClearSprites" href="#GameLoop_ClearSprites" class="la">GameLoop_ClearSprites:</a><span class="ce">; [$c130]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; X = 7 (loop counter -- looping 8 times)</span></span>
<span class="l"></span>
<span class="l"><a name="@_clearSpritesLoop" href="#@_clearSpritesLoop" class="lla">@_clearSpritesLoop:</a><span class="ce">; [$c132]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Set sprite to 0xFF (cleared).</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>,X</span></span><span class="ce">; Set sprite hit points to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HitCounter">CurrentSprites_HitCounter</a>,X</span></span><span class="ce">; Set sprite hit counter to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Subtypes">CurrentSprites_Subtypes</a>,X</span></span><span class="ce">; Set sprite subtype to 0.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_clearSpritesLoop">@_clearSpritesLoop</a></span></span><span class="ce">; If we're not done, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're out of the loop. Reset the PPU draw offset and restore
; screen state.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUResetOffset">PPUResetOffset</a></span></span><span class="ce">; Reset the PPU offset.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenColorMode">ScreenColorMode</a></span></span><span class="ce">; Load the current screen color mode.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fe</span></span><span class="ce">; Set to color mode (clear bit 1)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenColorMode">ScreenColorMode</a></span></span><span class="ce">; Store the new color mode.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load extra information about the contents of the screen.
;
; This may include data such as sprite values, NPC IScript
; entrypoints, and special screen events (such as boss kill
; triggers).
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The area being loaded.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The screen being loaded within the area.
;
;     <a href="PRG11.html#AREA_SPRITE_ADDRESSES">AREA_SPRITE_ADDRESSES</a>:
;         The table of areas to screen lists.
;
; OUTPUTS:
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>:
;         The starting read address for the screen info.
;
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The screen's loaded special event ID (0xFF if
;         there is none).
;
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;         Used internally and clobbered.
;
; CALLS:
;     <a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a>
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a>
;============================================================================
</div><span class="l"><a name="Screen_LoadAllScreenInfo" href="#Screen_LoadAllScreenInfo" class="la">Screen_LoadAllScreenInfo:</a><span class="ce">; [$c154]</span></span>
<div class="c">;
; Set the address of the sprites-for-screen lookup table
; for the area.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; A = Current area index.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word offset for the lookup table.</span></span>
<span class="l"></span>
<div class="c">;
; Set the starting address of the screen data.
;
</div><span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$8210,Y</span></span><span class="ce">; Load the upper byte of the address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store for reading.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$8211,Y</span></span><span class="ce">; Load the lower byte of thea ddress.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Check the first byte of the address. If 0xFF,
; nothing will be loaded.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$01</span></span><span class="ce">; Y = 1</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the address for the screens list.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_C1B3">RETURN_C1B3</a></span></span><span class="ce">; If so, there's nothing to load. Return.</span></span>
<span class="l"></span>
<div class="c">;
; Set the start address for a screen's sprite and metadata
; information.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; A = Current screen index.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word offset for the lookup table.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<div class="c">;
; Read the address for the screen information.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the lower byte of the screen address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; Store it as the lower byte of the of the sprites read address.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr.U">Sprites_ReadInfoAddr.U</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<div class="c">;
; Find the end of the sprites list for the screen.
;
; Sprites are in 2-byte pairs of (Entity ID, Sprite Value).
; This will skip those bytes until the end of the list is
; hit.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<span class="l"><a name="@_readLoop" href="#@_readLoop" class="lla">@_readLoop:</a><span class="ce">; [$c179]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte from the screen data.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextLoopIter">@_prepareNextLoopIter</a></span></span><span class="ce">; If not, jump to prepare for the next loop</span></span>
<span class="l"></span>
<div class="c">;
; The sprite information is 0xFF, so we're done looping.
; Read the screen information.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; Increment the read address by 2 bytes.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr.U">Sprites_ReadInfoAddr.U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry, if lower byte overflowed.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr.U">Screen_ExtraInfoAddr.U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a></span></span><span class="ce">; Read the extra screen information.</span></span>
<span class="l"></span>
<div class="c">;
; Increment by 2 (the sprite entity and value).
;
</div><span class="l"><a name="@_prepareNextLoopIter" href="#@_prepareNextLoopIter" class="lla">@_prepareNextLoopIter:</a><span class="ce">; [$c18f]</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_readLoop">@_readLoop</a></span></span><span class="ce">; If Y &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear the special event ID for the current screen.
;
; This disables any custom logic specific to certain screens.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         Set to 0xFF (unset).
;
; XREFS:
;     <a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a>
;============================================================================
</div><span class="l"><a name="Screen_SetNoSpecialEventID" href="#Screen_SetNoSpecialEventID" class="la">Screen_SetNoSpecialEventID:</a><span class="ce">; [$c193]</span></span>
<div class="c">;
; No special event information was found for the screen.
; Clear that state (set to 0xFF).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Clear the special event ID (0xFF).</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load extra information about the current screen.
;
; Screens may contain a special event ID, which adds custom
; logic to perform on each tick on a screen. This is used
; for three things:
;
; 1. Managing the pushable block status on the path to
;    Mascon.
; 2. Boss battle logic.
; 3. Final boss logic.
;
; INPUTS:
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     #$cd:
;         The address containing the extra screen
;         information.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The special event ID loaded from the screen info,
;         or 0xFF (unset) if not found.
;
; XREFS:
;     <a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a>
;============================================================================
</div><span class="l"><a name="Screen_LoadSpecialEventID" href="#Screen_LoadSpecialEventID" class="la">Screen_LoadSpecialEventID:</a><span class="ce">; [$c199]</span></span>
<div class="c">;
; Begin scanning for a 0xFF in the screen information. This
; will indicate the start of extra information for the screen
; (special screen event states, IScripts entrypoint references).
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (loop counter)</span></span>
<span class="l"></span>
<span class="l"><a name="@_scanLoop" href="#@_scanLoop" class="lla">@_scanLoop:</a><span class="ce">; [$c19b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte in the screen info data.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_noFFMarker">@_noFFMarker</a></span></span><span class="ce">; If so, we found the start of the extra data to load. Jump.</span></span>
<span class="l"></span>
<div class="c">;
; We found the start of the extra info for the screen. We're
; looking for 0x80, which indicates special event code will
; run on this screen every tick. The type of event will be
; indicated in the following byte.
;
; An example of this would be running code when a boss is
; defeated, producing an item.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte to see what we're working with.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$80</span></span><span class="ce">; Is it 0x80?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Screen_SetNoSpecialEventID">Screen_SetNoSpecialEventID</a></span></span><span class="ce">; If not, then we won't be running special event code on this screen.</span></span>
<span class="l"></span>
<div class="c">;
; This screen runs special event code. Load it.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte containing the special event ID.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Store it while on the screen.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_noFFMarker" href="#@_noFFMarker" class="lla">@_noFFMarker:</a><span class="ce">; [$c1af]</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<div class="c">;
; If we hit 256 loops, we're done.
;
</div><span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_scanLoop">@_scanLoop</a></span></span><span class="ce">; If we haven't wrapped, then loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span><span class="ce">; Else, we're done.</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a>
;
</div><span class="l"><a name="RETURN_C1B3" href="#RETURN_C1B3" class="la">RETURN_C1B3:</a><span class="ce">; [$c1b3]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load information on a sprite from the screens list.
;
; This will read the next sprite entity ID in the screen
; information, followed by the block X/Y position where
; the sprite should be placed.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>:
;     #$cb:
;         The address in the screens table to read from.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The loaded sprite entity ID.
;
;     <a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a>:
;         The loaded block X position of the sprite.
;
;     <a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a>:
;         The loaded block Y position of the sprite.
;
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>:
;     #$cb:
;         The updated address in the screens table to read
;         from.
;
; CALLS:
;     <a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a>
;     <a href="#Sprites_PopulateNextAvailableSprite">Sprites_PopulateNextAvailableSprite</a>
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Screen_SetupSprites">Screen_SetupSprites</a>
;============================================================================
</div><span class="l"><a name="GameLoop_LoadSpriteInfo" href="#GameLoop_LoadSpriteInfo" class="la">GameLoop_LoadSpriteInfo:</a><span class="ce">; [$c1b4]</span></span>
<div class="c">;
; Switch to ROM bank 11, where sprite information lives.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<div class="c">;
; Load all the sprites for this screen.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a></span></span><span class="ce">; Load the sprite information for the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Switch bank to our previous bank.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A (our saved bank).</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<div class="c">;
; Begin our loop for reading all sprites for the screen.
;
</div><span class="l"><a name="@_readSpriteLoop" href="#@_readSpriteLoop" class="lla">@_readSpriteLoop:</a><span class="ce">; [$c1c5]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y =  0 (info read offset)</span></span>
<span class="l"></span>
<div class="c">;
; Switch back to ROM bank 11 (sprite info).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; A = current ROM bank</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<div class="c">;
; Read information on the next sprite on the screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Read the current byte of the screen information.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (our end-of-sprites list)?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; If it is, we're done. Restore our bank and return.</span></span>
<span class="l"></span>
<div class="c">;
; Store the sprite's entity ID.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store this byte as the sprite entity ID.</span></span>
<span class="l"></span>
<div class="c">;
; Load the sprite's Y block position.
;
; This will be the upper nibble of the byte following the
; sprite entity ID.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Take only the upper nibble.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a></span></span><span class="ce">; Store it as the sprite's starting Y position.</span></span>
<span class="l"></span>
<div class="c">;
; Load the sprite's X block position.
;
; This will be the lower nibble, which will then be placed
; in the upper nibble.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Load the same byte.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift the X coordinate from the lower nibble to the upper nibble.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a></span></span><span class="ce">; Store as the sprite's X position.</span></span>
<span class="l"></span>
<div class="c">;
; Restore our bank.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A (the saved bank) from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<div class="c">;
; Finish processing this sprite. We'll add to the next
; available slot and fill in any information needed based
; on what we loaded.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_PopulateNextAvailableSprite">Sprites_PopulateNextAvailableSprite</a></span></span><span class="ce">; Add this sprite to the next available slot.</span></span>
<span class="l"></span>
<div class="c">;
; Increment the read address for the next sprite in the
; screen data.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; A = lower byte of the screen information address</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; Increment by 2 (sprite entity ID and position).</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; Store as the new lower byte of the address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr.U">Sprites_ReadInfoAddr.U</a></span></span><span class="ce">; A = upper byte of the screen information address</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry if the lower byte overflowed.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr.U">Sprites_ReadInfoAddr.U</a></span></span><span class="ce">; Store it as the new upper byte of the address.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_readSpriteLoop">@_readSpriteLoop</a></span></span><span class="ce">; Loop to read the next sprite.</span></span>
<span class="l"></span>
<span class="l"><a name="@_restoreBankAndReturn" href="#@_restoreBankAndReturn" class="lla">@_restoreBankAndReturn:</a><span class="ce">; [$c202]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Populate the loaded sprite in the next available slot.
;
; This will set the default state of the sprite, the
; sprite's HP, hitbox type, subtype, and behavior
; addresses.
;
; If the sprite can't fit on the screen, it will not be
; loaded.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The loaded sprite entity ID.
;
;     <a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a>:
;         The loaded block X position.
;
;     <a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a>:
;         The loaded block Y position.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The updated sprite entities.
;
;     <a href="RAM.html#CurrentSprites_Flags">CurrentSprites_Flags</a>:
;         The updated sprite flags.
;
;     <a href="RAM.html#CurrentSprites_Phases">CurrentSprites_Phases</a>:
;         The updated sprite phases.
;
;     <a href="RAM.html#CurrentSprites_HitByMagicBehavior">CurrentSprites_HitByMagicBehavior</a>:
;         The updated behaviors when hit by magic.
;
;     <a href="RAM.html#CurrentSprites_XPos">CurrentSprites_XPos</a>:
;         The updated sprite X positions.
;
;     <a href="RAM.html#CurrentSprites_YPos">CurrentSprites_YPos</a>:
;         The updated sprite Y positions.
;
;     <a href="RAM.html#CurrentSprites_HitBoxTypes">CurrentSprites_HitBoxTypes</a>:
;         The updated sprite hit box types.
;
;     <a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>:
;         The updated sprite HPs.
;
;     <a href="RAM.html#CurrentSprites_BehaviorAddrs_L">CurrentSprites_BehaviorAddrs_L</a>:
;         The updated sprite behavior address lower bytes.
;
;     <a href="RAM.html#CurrentSprites_BehaviorAddrs_U">CurrentSprites_BehaviorAddrs_U</a>:
;         The updated sprite behavior address upper bytes.
;
;     <a href="RAM.html#CurrentSprites_Subtypes">CurrentSprites_Subtypes</a>:
;         The updated sprite subtypes.
;
; CALLS:
;     <a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a>
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a>
;============================================================================
</div><span class="l"><a name="Sprites_PopulateNextAvailableSprite" href="#Sprites_PopulateNextAvailableSprite" class="la">Sprites_PopulateNextAvailableSprite:</a><span class="ce">; [$c205]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c207" href="#@LAB_PRG15_MIRROR__c207" class="lla">@LAB_PRG15_MIRROR__c207:</a><span class="ce">; [$c207]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c252">@LAB_PRG15_MIRROR__c252</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Phases">CurrentSprites_Phases</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Flags">CurrentSprites_Flags</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HitByMagicBehavior">CurrentSprites_HitByMagicBehavior</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_XPos">CurrentSprites_XPos</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_YPos">CurrentSprites_YPos</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$b4df,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HitBoxTypes">CurrentSprites_HitBoxTypes</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$b5a9,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>,X</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ad2d,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_BehaviorAddrs_L">CurrentSprites_BehaviorAddrs_L</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ad2e,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_BehaviorAddrs_U">CurrentSprites_BehaviorAddrs_U</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Subtypes">CurrentSprites_Subtypes</a>,X</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c252" href="#@LAB_PRG15_MIRROR__c252" class="lla">@LAB_PRG15_MIRROR__c252:</a><span class="ce">; [$c252]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c207">@LAB_PRG15_MIRROR__c207</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Banks storing the images for a range of sprites.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;
</div><span class="l"><a name="SPRITE_IMAGE_BANKS" href="#SPRITE_IMAGE_BANKS" class="la">SPRITE_IMAGE_BANKS:</a><span class="ce">; [$c259]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [0]: Bank for sprites 0-54</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;
</div><span class="l"><a name="SPRITE_IMAGE_BANKS_1_" href="#SPRITE_IMAGE_BANKS_1_" class="la">SPRITE_IMAGE_BANKS_1_:</a><span class="ce">; [$c25a]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [1]: Bank for sprites 55-100</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load the value for a sprite from the screen's sprite info table.
;
; This loads the value information associated with a sprite
; on the screen. This may represent a message ID or some
; other value, depending on the sprite and situation.
;
; INPUTS:
;     X:
;         The sprite index to load the value for,
;
;     CurrentROMBank:
;         The currently-loaded ROM bank.
;
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     #$cd:
;         The current address for the extra sprite values
;         on the screen.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Values">CurrentSprites_Values</a>:
;         The updated sprite values.
;
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     #$cd:
;         The incremented address for the extra sprite
;         values on the screen.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;
; XREFS:
;     <a href="#Sprites_PopulateNextAvailableSprite">Sprites_PopulateNextAvailableSprite</a>
;============================================================================
</div><span class="l"><a name="Sprites_LoadSpriteValue" href="#Sprites_LoadSpriteValue" class="la">Sprites_LoadSpriteValue:</a><span class="ce">; [$c25b]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X (sprite index)</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<div class="c">;
; Save the current ROM bank and switch to bank 11.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Get the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0b</span></span><span class="ce">; X = 11 (bank)</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<div class="c">;
; Restore our sprite index to X so it's not clobbered
; when this returns.
;
</div><span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<div class="c">;
; Load the extra information for this sprite and store it
; in the sprite list.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; A = Extra information for the sprite.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Values">CurrentSprites_Values</a>,X</span></span><span class="ce">; Store in <a href="RAM.html#CurrentSprites_Values">CurrentSprites_Values</a>.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (unset)?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; If so, we're done. Jump.</span></span>
<span class="l"></span>
<div class="c">;
; Increment the position in the info data.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a></span></span><span class="ce">; Increment the lower byte of the offset in the extra info data.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; If this didn't wrap to 0, we're done. Jump.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr.U">Screen_ExtraInfoAddr.U</a></span></span><span class="ce">; Else, increment the upper byte as well.</span></span>
<span class="l"></span>
<span class="l"><a name="@_restoreBankAndReturn" href="#@_restoreBankAndReturn" class="lla">@_restoreBankAndReturn:</a><span class="ce">; [$c279]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore the bank saved to the stack.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Determine and store the bank for images for the current sprite.
;
; This will determine which bank would store images for the
; currently-processed sprite.
;
; If the sprite entity ID is 0-54, this will be bank 6.
;
; If the sprite entity ID is 55-100, this will be bank 7.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The entity ID for the currently-processed sprite.
;
;     <a href="#SPRITE_IMAGE_BANKS">SPRITE_IMAGE_BANKS</a>:
;         The lookup table for sprite entity IDs to banks.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_ImagesBank">CurrentSprite_ImagesBank</a>:
;         The bank for the images for this sprite.
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;============================================================================
</div><span class="l"><a name="Sprites_StoreBankForCurrentSprite" href="#Sprites_StoreBankForCurrentSprite" class="la">Sprites_StoreBankForCurrentSprite:</a><span class="ce">; [$c27c]</span></span>
<div class="c">;
; Y = 0
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; A = current sprite entity</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$37</span></span><span class="ce">; Is it &lt; sprite 55 (Unused Child sprite)?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_loadBank">@_loadBank</a></span></span><span class="ce">; If yes, then load bank from table at index 0.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Else, load bank from table at index 1.</span></span>
<span class="l"></span>
<div class="c">;
; Load the image for the bank.
;
</div><span class="l"><a name="@_loadBank" href="#@_loadBank" class="lla">@_loadBank:</a><span class="ce">; [$c286]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c259,Y</span></span><span class="ce">; Load the address for the sprite entity.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_ImagesBank">CurrentSprite_ImagesBank</a></span></span><span class="ce">; Store as the bank for this sprite.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c28c]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load images for all sprites on the scren.
;
; This will loop through each sprite and load the images,
; drawing them in the PPU buffer.
;
; If any sprites become off-screen (vertically), they'll be
; removed.
;
; As a special case, if the sprite is the boss Pakukame, a
; Lilith will be spawned.
;
; INPUTS:
;     <a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a>:
;         The current sprite index at the start of this
;         call.
;
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The list of sprite entities for all sprites on
;         screen.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         Updated if sprites are removed or added.
;
;     <a href="RAM.html#CurrentSprites_PPUAddrs">CurrentSprites_PPUAddrs</a>:
;         PPU addresses for sprite data.
;
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#PPUResetOffset">PPUResetOffset</a>
;     <a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a>
;     <a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a>
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__dacd">FUN_PRG15_MIRROR__dacd</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#IScripts_ClearPortrait">IScripts_ClearPortrait</a>
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;     <a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a>
;     <a href="#Maybe_Game_ExitBuildingHandler">Maybe_Game_ExitBuildingHandler</a>
;============================================================================
</div><span class="l"><a name="GameLoop_LoadSpriteImages" href="#GameLoop_LoadSpriteImages" class="la">GameLoop_LoadSpriteImages:</a><span class="ce">; [$c28d]</span></span>
<div class="c">;
; Save state and prepare for image loading.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; A = current sprite index</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUResetOffset">PPUResetOffset</a></span></span><span class="ce">; Reset the PPU drawing coordinates.</span></span>
<span class="l"></span>
<div class="c">;
; Begin our loop for all 7 sprite slots.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; X = 7 (sprite index counter)</span></span>
<span class="l"></span>
<div class="c">;
; Set this as the currently-processed sprite, and update
; the entity.
;
; We'll only process if the entity is not unset.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$c296]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; Store it as the currently-processed sprite index.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Load the associated sprite entity ID.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (unset)?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_nextLoop">@_nextLoop</a></span></span><span class="ce">; If so, jump and prepare for the next loop.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store this as the entity at this index.</span></span>
<span class="l"></span>
<div class="c">;
; Load the image for this sprite.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a></span></span><span class="ce">; Store the image bank for the current sprite.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a></span></span><span class="ce">; Load the sprite's image from the bank.</span></span>
<span class="l"></span>
<div class="c">;
; Special-case the Pakukame boss. If that was placed, then
; replace it with a Lilith instead. They spawn Liliths.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the current entity.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$30</span></span><span class="ce">; Is it the Pakukame boss?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loadSpriteInfo">@_loadSpriteInfo</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; This is the Pakukame. Swap in a Lilith and load the image.
;
; This will then restore the entity back to Pakukame.
; Effectively, each Lilith on screen seems t be backed by
; a Pakukame.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the Pakukame entity ID</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Index">PPUOffset_Index</a></span></span><span class="ce">; Load the offset row.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$09</span></span><span class="ce">; A = 9 (Lilith)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store as the new entity.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a></span></span><span class="ce">; Store the bank for Lilith.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a></span></span><span class="ce">; Load Lilth's image from the bank.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the PPU offset row.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUOffset_Index">PPUOffset_Index</a></span></span><span class="ce">; Store it again.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the current sprite entity.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store it again.</span></span>
<span class="l"></span>
<div class="c">;
; Load the PPU address and Y posiiton for the sprite.
;
; If the Y position is off the screen (row 30 or higher),
; then the sprite will be unset.
;
</div><span class="l"><a name="@_loadSpriteInfo" href="#@_loadSpriteInfo" class="lla">@_loadSpriteInfo:</a><span class="ce">; [$c2c9]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Index">PPUOffset_Index</a></span></span><span class="ce">; A = PPU offset row</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_PPUAddrs">CurrentSprites_PPUAddrs</a>,X</span></span><span class="ce">; Set this in the PPU addresses for this sprite.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_YPos">CurrentSprites_YPos</a>,X</span></span><span class="ce">; Load the Y position for this sprite.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f0</span></span><span class="ce">; Is it less than 0xF0?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_nextLoop">@_nextLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<div class="c">;
; It's off-screen. Unset it.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; Else, it's off the screen.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Unset the entity.</span></span>
<span class="l"></span>
<div class="c">;
; Done with any loading required for the sprite. Prepare for
; the next loop, if needed.
;
</div><span class="l"><a name="@_nextLoop" href="#@_nextLoop" class="lla">@_nextLoop:</a><span class="ce">; [$c2dc]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index (loop counter).</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X &gt;= 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're done. Restore the original current sprite index and
; wait until everything's drawn to the screen.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A (current sprite index) from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; Store that back as the current sprite index.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a></span></span><span class="ce">; Wait until everything's drawn to the screen.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document CastMagic_Maybe_FinishHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;============================================================================
</div><span class="l"><a name="CastMagic_Maybe_FinishHandler" href="#CastMagic_Maybe_FinishHandler" class="la">CastMagic_Maybe_FinishHandler:</a><span class="ce">; [$c2e9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$bb28,Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$bb27,Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c314]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Calculate the visibility of the cast magic.
;
; This will check the cast magic against any foreground
; blocks, checking if it's fully visible, partially
; obscured, or fully obscured.
;
; INPUTS:
;     <a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a>:
;         The X pixel position of the magic.
;
;     <a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a>:
;         The Y pixel position of the magic.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a>:
;         The visibility state of the cast magic.
;
;     <a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a>:
;         The visibility state of the cast magic.
;
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a>
;     <a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a>
;
; XREFS:
;     <a href="#CastMagic_Maybe_FinishHandler">CastMagic_Maybe_FinishHandler</a>
;============================================================================
</div><span class="l"><a name="CastMagic_CalculateVisibility" href="#CastMagic_CalculateVisibility" class="la">CastMagic_CalculateVisibility:</a><span class="ce">; [$c315]</span></span>
<div class="c">;
; Set the default to visible.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Set the default visibility to visible.</span></span>
<span class="l"></span>
<div class="c">;
; Convert the cast magic's position to block positions.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span><span class="ce">; Load the magic's Y position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Set it as an argument for getting the block property.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a></span></span><span class="ce">; Load the magic's X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4 to that to better check block alignment.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Set it as an argument.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert to a block position.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span><span class="ce">; Get the block property for this position.</span></span>
<span class="l"></span>
<div class="c">;
; Check if a block overlaps the left.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this block type 4?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_leftIsObscured">@_leftIsObscured</a></span></span><span class="ce">; If so, the left is obscured.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0d</span></span><span class="ce">; Else, is this block type 13?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_leftIsObscured">@_leftIsObscured</a></span></span><span class="ce">; If so, the left is obscured.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$09</span></span><span class="ce">; Else, is this block type 9?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkRightObscured">@_checkRightObscured</a></span></span><span class="ce">; If not, the left is not obscured. Start checking the right.</span></span>
<span class="l"></span>
<div class="c">;
; This is a foreground layer block. The trailing part
; is obscured.
;
</div><span class="l"><a name="@_leftIsObscured" href="#@_leftIsObscured" class="lla">@_leftIsObscured:</a><span class="ce">; [$c338]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Load the cast magic's visibility state.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$01</span></span><span class="ce">; Mark the left-hand side as obscured.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Now check the right-hand side of the magic.
;
</div><span class="l"><a name="@_checkRightObscured" href="#@_checkRightObscured" class="lla">@_checkRightObscured:</a><span class="ce">; [$c33e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Load the pixel X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$08</span></span><span class="ce">; Add 8 to it, to better check the right side.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the new pixel argument.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert to a block position.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"></span>
<div class="c">;
; Check if a block overlaps the right.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this block 4?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkNeedToFlipBits">@_checkNeedToFlipBits</a></span></span><span class="ce">; If not, it's not obscured.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Again, is this block 4?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_rightIsObscured">@_rightIsObscured</a></span></span><span class="ce">; If so, the right is obscured.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0d</span></span><span class="ce">; Else, is this block 13?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_rightIsObscured">@_rightIsObscured</a></span></span><span class="ce">; If so, the right is obscured.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$09</span></span><span class="ce">; Else, is this block 9?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkNeedToFlipBits">@_checkNeedToFlipBits</a></span></span><span class="ce">; If not, it's not obscured. Move to the next step.</span></span>
<span class="l"></span>
<div class="c">;
; The trailing side of the magic is obscured.
;
</div><span class="l"><a name="@_rightIsObscured" href="#@_rightIsObscured" class="lla">@_rightIsObscured:</a><span class="ce">; [$c35b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Load the cast magic's visibility state.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$02</span></span><span class="ce">; Mark the right-hand side as obscured.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the magic is partially-obscured (just left or
; right). If so, make sure the flips are flipped for the
; facing direction.
;
</div><span class="l"><a name="@_checkNeedToFlipBits" href="#@_checkNeedToFlipBits" class="lla">@_checkNeedToFlipBits:</a><span class="ce">; [$c361]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Flags">CastMagic_Flags</a></span></span><span class="ce">; A = cast magic flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is it facing right?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_facingRight">@_facingRight</a></span></span><span class="ce">; If so, there's nothing to do. We're done.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; A = cast magic visibility</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_storeVisibility">@_storeVisibility</a></span></span><span class="ce">; If the block is fully visible, jump.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Else, is it full obscured?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_storeVisibility">@_storeVisibility</a></span></span><span class="ce">; If yes, jump.</span></span>
<span class="l"></span>
<div class="c">;
; Swap the bits to face the other direction.
;
</div><span class="l"><span><span class="i">EOR</span> <span class="o">#$03</span></span><span class="ce">; Swap the visibility of leading and trailing flags.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_storeVisibility">@_storeVisibility</a></span></span><span class="ce">; Jump to store.</span></span>
<span class="l"></span>
<span class="l"><a name="@_facingRight" href="#@_facingRight" class="lla">@_facingRight:</a><span class="ce">; [$c378]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Load the previously-calculated visibility from above.</span></span>
<span class="l"></span>
<span class="l"><a name="@_storeVisibility" href="#@_storeVisibility" class="lla">@_storeVisibility:</a><span class="ce">; [$c37a]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span><span class="ce">; Store the new visibility state.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the appearance of the magic sprite.
;
; This will take in an offset into the magic's list of
; frames and set that as the new appearance.
;
; INPUTS:
;     A:
;         The offset into the list of frames.
;
;     <a href="RAM.html#CastMagic_Type">CastMagic_Type</a>:
;         The type of cast magic.
;
;     <a href="#SPRITE_MAGIC_IMAGE_ADDRS_U">SPRITE_MAGIC_IMAGE_ADDRS_U</a>:
;         The lookup table of upper addresses of magic
;         sprite images.
;
; CALLS:
;     <a href="#Sprite_Maybe_SetAppearanceAddrFromOffset">Sprite_Maybe_SetAppearanceAddrFromOffset</a>
;
; XREFS:
;     <a href="#CastMagic_FinishHandler_Death">CastMagic_FinishHandler_Death</a>
;     <a href="#CastMagic_FinishHandler_Deluge">CastMagic_FinishHandler_Deluge</a>
;     <a href="#CastMagic_FinishHandler_DelugeOrDeathAfterHit">CastMagic_FinishHandler_DelugeOrDeathAfterHit</a>
;     <a href="#CastMagic_FinishHandler_Fire">CastMagic_FinishHandler_Fire</a>
;     <a href="#CastMagic_FinishHandler_Thunder">CastMagic_FinishHandler_Thunder</a>
;     <a href="#CastMagic_FinishHandler_Tilte">CastMagic_FinishHandler_Tilte</a>
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;     <a href="#CastMagic_FinishHandler_Unknown10">CastMagic_FinishHandler_Unknown10</a>
;============================================================================
</div><span class="l"><a name="CastMagic_Maybe_SetAppearance" href="#CastMagic_Maybe_SetAppearance" class="la">CastMagic_Maybe_SetAppearance:</a><span class="ce">; [$c37d]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span><span class="ce">; Y = cast magic type</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$c387,Y</span></span><span class="ce">; Add the value from the lookup table.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Sprite_Maybe_SetAppearanceAddrFromOffset">Sprite_Maybe_SetAppearanceAddrFromOffset</a></span></span><span class="ce">; Set the sprite appearance.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Table of upper address bytes for magic sprite images.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;
</div><span class="l"><a name="SPRITE_MAGIC_IMAGE_ADDRS_U" href="#SPRITE_MAGIC_IMAGE_ADDRS_U" class="la">SPRITE_MAGIC_IMAGE_ADDRS_U:</a><span class="ce">; [$c387]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$95</span></span><span class="ce">; [0]: Deluge</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$99</span></span><span class="ce">; [1]: Thunder</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9b</span></span><span class="ce">; [2]: Fire</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9d</span></span><span class="ce">; [3]: Death</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a1</span></span><span class="ce">; [4]: Tilte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [5]: UNUSED: Deluge after first hit</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$99</span></span><span class="ce">; [6]: Thunder after first hit</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9b</span></span><span class="ce">; [7]: Fire after first hit</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [8]: UNUSED: Death after first hit</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [9]: UNUSED</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [10]: UNUSED</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [11]: Tilte after first hit</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set whether a cast magic's sprite is flipped based on the cast direction.
;
; INPUTS:
;     <a href="RAM.html#CastMagic_Flags">CastMagic_Flags</a>:
;         The cast magic's flags.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a>:
;         The sprite's flip state.
;
; XREFS:
;     <a href="#CastMagic_FinishHandler_Death">CastMagic_FinishHandler_Death</a>
;     <a href="#CastMagic_FinishHandler_Deluge">CastMagic_FinishHandler_Deluge</a>
;     <a href="#CastMagic_FinishHandler_DelugeOrDeathAfterHit">CastMagic_FinishHandler_DelugeOrDeathAfterHit</a>
;     <a href="#CastMagic_FinishHandler_Fire">CastMagic_FinishHandler_Fire</a>
;     <a href="#CastMagic_FinishHandler_Thunder">CastMagic_FinishHandler_Thunder</a>
;     <a href="#CastMagic_FinishHandler_Tilte">CastMagic_FinishHandler_Tilte</a>
;============================================================================
</div><span class="l"><a name="CastMagic_UpdateSpriteDirection" href="#CastMagic_UpdateSpriteDirection" class="la">CastMagic_UpdateSpriteDirection:</a><span class="ce">; [$c393]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Flags">CastMagic_Flags</a></span></span><span class="ce">; Load the cast magic's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Take only the facing direction bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Set as the sprite's flip mask.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Finish updating the Deluge spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb27]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_Deluge" href="#CastMagic_FinishHandler_Deluge" class="la">CastMagic_FinishHandler_Deluge:</a><span class="ce">; [$c39b]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Set the sprite's direction.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate an appearance index.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Keep the 2 right-most bits (effectively, bits 3 and 4 of the interrupt counter).</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Finish updating the Thunder spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; It will update the appearance for 2 frames at a time,
; and wait 2 frames in-between.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb29]
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb33]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_Thunder" href="#CastMagic_FinishHandler_Thunder" class="la">CastMagic_FinishHandler_Thunder:</a><span class="ce">; [$c3a7]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Set the sprite's direction.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate a value to check against.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If this should not update the appearance, return.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the right-most bit (effectively, bit 2 of the interrupt counter).</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c3b5]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Finish updating the Fire spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; It will run for 2 frames, skip 2 frames, run for 2 frames,
; etc.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb2b]
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb35]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_Fire" href="#CastMagic_FinishHandler_Fire" class="la">CastMagic_FinishHandler_Fire:</a><span class="ce">; [$c3b6]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$02</span></span><span class="ce">; Is bit 1 set?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_updateFire">@_updateFire</a></span></span><span class="ce">; If so, jump to update.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_updateFire" href="#@_updateFire" class="lla">@_updateFire:</a><span class="ce">; [$c3bd]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Set the sprite's direction.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate an appearance index.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the right-most bit (effectively, bit 2 of the interrupt counter).</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Finish updating the Death spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb2d]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_Death" href="#CastMagic_FinishHandler_Death" class="la">CastMagic_FinishHandler_Death:</a><span class="ce">; [$c3c9]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Update the sprite's direction.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate an appearance index.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Keep the 2 right-most bits (effectively, bits 3 and 4 of the interrupt counter).</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document CastMagic_FinishHandler_Tilte
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb2f]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_Tilte" href="#CastMagic_FinishHandler_Tilte" class="la">CastMagic_FinishHandler_Tilte:</a><span class="ce">; [$c3d6]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Phase">CastMagic_Phase</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c3ec">@LAB_PRG15_MIRROR__c3ec</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c3e8">@LAB_PRG15_MIRROR__c3e8</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c3e8" href="#@LAB_PRG15_MIRROR__c3e8" class="lla">@LAB_PRG15_MIRROR__c3e8:</a><span class="ce">; [$c3e8]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c3ec" href="#@LAB_PRG15_MIRROR__c3ec" class="lla">@LAB_PRG15_MIRROR__c3ec:</a><span class="ce">; [$c3ec]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c3f3">@LAB_PRG15_MIRROR__c3f3</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c3f3" href="#@LAB_PRG15_MIRROR__c3f3" class="lla">@LAB_PRG15_MIRROR__c3f3:</a><span class="ce">; [$c3f3]</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; UNUSED: Finish handling updates to Deluge and Death spells that have
; collided at least once.
;
; This would maintain the sprite's direction and appearance.
;
; It's never actually run, due to both these spells clearing
; immediately when colliding.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb31]
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb37]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_DelugeOrDeathAfterHit" href="#CastMagic_FinishHandler_DelugeOrDeathAfterHit" class="la">CastMagic_FinishHandler_DelugeOrDeathAfterHit:</a><span class="ce">; [$c3fb]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; UNUSED
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb3b]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_Unknown10" href="#CastMagic_FinishHandler_Unknown10" class="la">CastMagic_FinishHandler_Unknown10:</a><span class="ce">; [$c403]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Something_Appearance">CastMagic_Something_Appearance</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Something_Appearance">CastMagic_Something_Appearance</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document CastMagic_FinishHandler_TilteAfterFirstHit
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_FINISH_HANDLERS">CAST_MAGIC_FINISH_HANDLERS</a> [$PRG14::bb3d]
;============================================================================
</div><span class="l"><a name="CastMagic_FinishHandler_TilteAfterFirstHit" href="#CastMagic_FinishHandler_TilteAfterFirstHit" class="la">CastMagic_FinishHandler_TilteAfterFirstHit:</a><span class="ce">; [$c42c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c432" href="#@LAB_PRG15_MIRROR__c432" class="lla">@LAB_PRG15_MIRROR__c432:</a><span class="ce">; [$c432]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Counter">CastMagic_Counter</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o">#$c46c,X</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c442">@LAB_PRG15_MIRROR__c442</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c442" href="#@LAB_PRG15_MIRROR__c442" class="lla">@LAB_PRG15_MIRROR__c442:</a><span class="ce">; [$c442]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o">#$c470,X</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c456">@LAB_PRG15_MIRROR__c456</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c456" href="#@LAB_PRG15_MIRROR__c456" class="lla">@LAB_PRG15_MIRROR__c456:</a><span class="ce">; [$c456]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c474,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c432">@LAB_PRG15_MIRROR__c432</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="MAGICHITHANDLER_c42c_ARRAY1" href="#MAGICHITHANDLER_c42c_ARRAY1" class="la">MAGICHITHANDLER_c42c_ARRAY1:</a><span class="ce">; [$c46c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a name="MAGICHITHANDLER_c42c_ARRAY1_2_" href="#MAGICHITHANDLER_c42c_ARRAY1_2_" class="la">MAGICHITHANDLER_c42c_ARRAY1_2_:</a><span class="ce">; [$c46e]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a name="MAGICHITHANDLER_c42c_ARRAY1_3_" href="#MAGICHITHANDLER_c42c_ARRAY1_3_" class="la">MAGICHITHANDLER_c42c_ARRAY1_3_:</a><span class="ce">; [$c46f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__c470_3_" href="#BYTE_ARRAY_PRG15_MIRROR__c470_3_" class="la">BYTE_ARRAY_PRG15_MIRROR__c470_3_:</a><span class="ce">; [$c473]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__c474_3_" href="#BYTE_ARRAY_PRG15_MIRROR__c474_3_" class="la">BYTE_ARRAY_PRG15_MIRROR__c474_3_:</a><span class="ce">; [$c477]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Check whether the user wants to use the selected item.
;
; This will check if the player has both initiated an action
; to use the item and is in a position to use one.
;
; If these conditions are met, the action handler for the
; item will be invoked.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The currently-held buttons.
;
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The newly-pressed buttons.
;
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_CheckUseCurrentItem" href="#GameLoop_CheckUseCurrentItem" class="la">GameLoop_CheckUseCurrentItem:</a><span class="ce">; [$c478]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the player is in a state where they'd be allowed
; to use an item.
;
</div><span class="l"><span><span class="i">AND</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if the Down button has been pressed. If not, return.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Load the button mask.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$04</span></span><span class="ce">; Check if the Down button is pressed.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the B button has been pressed. If not, return.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Load the changed button mask.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Check if the B button is pressed.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Down-B was pressed. The item can be used, if a valid one is
; selected. Figure out if there's a valid one first...
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 2 to get a word boundary for address lookup.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$22</span></span><span class="ce">; Is it a valid item?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Look up this item in the jump table and run it.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$c49e,Y</span></span><span class="ce">; Load the lower byte of the item handler address.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c49d,Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c49c]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handler functions for using specific items.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a>
;
</div><span class="l"><a name="USE_ITEM_JUMP_TABLE" href="#USE_ITEM_JUMP_TABLE" class="la">USE_ITEM_JUMP_TABLE:</a><span class="ce">; [$c49d]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [0]: Ring of Elf</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [1]: Ring of Ruby</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [2]: Ring of Dworf</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [3]: Demon's Ring</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [4]: "A" Key</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [5]: "K" Key</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [6]: "Q" Key</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [7]: "J" Key</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [8]: "Jo" Key</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#Player_UseMattock">Player_UseMattock</a>-1</span></span><span class="ce">; [9]: Mattock</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [10]: Magical Rod</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [11]: Crystal</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [12]: Lamp</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#Player_UseHourGlass">Player_UseHourGlass</a>-1</span></span><span class="ce">; [13]: Hour Glass</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [14]: Book</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#Player_UseWingBoots">Player_UseWingBoots</a>-1</span></span><span class="ce">; [15]: Wing Boots</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#Player_UseRedPotion">Player_UseRedPotion</a>-1</span></span><span class="ce">; [16]: Red Potion</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear the selected item.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The cleared item selection.
;
; CALLS:
;     <a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a>
;
; XREFS:
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;============================================================================
</div><span class="l"><a name="Player_ClearSelectedItem" href="#Player_ClearSelectedItem" class="la">Player_ClearSelectedItem:</a><span class="ce">; [$c4bf]</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Set selected item to 0xFF (unset).</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a></span></span><span class="ce">; Update the UI for the cleared image.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A from the stack.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Use the player's Elixir.
;
; This will remove the Elixir from the inventory and update the player's
; health.
;
; This then falls through to <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The special items bitmask to update.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's MP.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The new special items bitmask with the
;         Elixir removed.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's updated HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's updated MP.
;
; CALLS:
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#Player_AddMP">Player_AddMP</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Wait3969Cycles">Wait3969Cycles</a>
;
; XREFS:
;     <a href="#Player_ReduceHP">Player_ReduceHP</a>
;============================================================================
</div><span class="l"><a name="Player_UseElixir" href="#Player_UseElixir" class="la">Player_UseElixir:</a><span class="ce">; [$c4ca]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f7</span></span><span class="ce">; Clear the elixir bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Run the "Use Elixir" IScript.
;
; IScript 0x85 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$85</span></span><span class="ce">; 0x85 == Use Elixir.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Progressively fill the player's HP and MP.
;
; This will add 4HP and 4MP at a time, playing a sound
; effect for each segment. This appears to the player as
; the HP and MP bars filling up.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The special items bitmask to update.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's MP.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The new special items bitmask with the
;         Elixir removed.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's updated HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's updated MP.
;
; CALLS:
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#Player_AddMP">Player_AddMP</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Wait3969Cycles">Wait3969Cycles</a>
;
; XREFS:
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;============================================================================
</div><span class="l"><a name="Player_FillHPAndMP" href="#Player_FillHPAndMP" class="la">Player_FillHPAndMP:</a><span class="ce">; [$c4da]</span></span>
<div class="c">;
; Progressively fill the HP, 4 units at a time.
;
; Start by playing the sound.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; Set sound 0x13 (fill HP/MP bar).</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the HP.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; Set the HP to 4 units.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_AddHP">Player_AddHP</a></span></span><span class="ce">; Add it to the player.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Wait a short period of time before filling up the
; next units of HP, to help animate the bar.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait a bit.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the player's HP.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it below the cap of 80HP?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#Player_FillHPAndMP">Player_FillHPAndMP</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Progressively fill the MP, 4 units at a time.
;
; Start by playing the sound.
;
</div><span class="l"><a name="@_fillMPLoop" href="#@_fillMPLoop" class="lla">@_fillMPLoop:</a><span class="ce">; [$c506]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; Set sound 0x13 (fill HP/MP bar).</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the MP.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; Set the MP to 4 units.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_AddMP">Player_AddMP</a></span></span><span class="ce">; Add it to the player.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Wait a short period of time before filling up the
; next units of MP, to help animate the bar.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait a bit.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Load the player's MP.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it below the cap of 80MP?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_fillMPLoop">@_fillMPLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Use the Red Potion item.
;
; This will play the Red Potion message and a sound
; effect, and remove the item from the inventory.
;
; Health will be progressively filled.
;
; INPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's HP.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's updated HP.
;
; CALLS:
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Wait3969Cycles">Wait3969Cycles</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4bd]
;============================================================================
</div><span class="l"><a name="Player_UseRedPotion" href="#Player_UseRedPotion" class="la">Player_UseRedPotion:</a><span class="ce">; [$c533]</span></span>
<div class="c">;
; Run the "Used Red Potion" IScript.
;
; IScript 0x80 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$80</span></span><span class="ce">; 0x80 == Use Red Potion IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c53b]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<div class="c">;
; Play the initial sound effect.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; 0x1A == Initial item used sound effect.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Set up the HP fill loop. This will fill up to 80.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$50</span></span><span class="ce">; X = Maximum HP / our loop counter.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$c545]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Play the unit fill sound effect.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; 0x13 = Unit of HP fill sound effect.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<div class="c">;
; Add 2HP.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_AddHP">Player_AddHP</a></span></span><span class="ce">; Add the 2HP to the player.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Wait a bit before filling the next 2HP.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if we're done.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the max HP.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the player's current HP.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is the player at max HP?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c578]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Use the Wing Boots item.
;
; This will play the Wing Boots message and a sound
; effect, and remove the item from the inventory.
;
; The duration of the Wing Boots will depend on the
; player's title:
;
; * 40 seconds: Novice, Aspirant, Battler, Fighter
; * 30 seconds: Adept, Chevalier, Veteran, Warrior
; * 20 seconds: Swordman, Hero, Soldier, Myrmidon
; * 10 seconds: Champion, Superhero, Paladin, Lor
;
; INPUTS:
;     <a href="RAM.html#PlayerTitle">PlayerTitle</a>:
;         The player's current title.
;
;     <a href="#TITLE_TO_WINGBOOTS_DURATION">TITLE_TO_WINGBOOTS_DURATION</a>:
;         The table of player titles to Wingboots duration.
;
; OUTPUTS:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         The starting number of seconds remaining for the
;         Wing Boots.
;
; CALLS:
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>:
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4bb]
;============================================================================
</div><span class="l"><a name="Player_UseWingBoots" href="#Player_UseWingBoots" class="la">Player_UseWingBoots:</a><span class="ce">; [$c579]</span></span>
<div class="c">;
; Run the "Wing Boots Used" IScript.
;
; IScript 0x83 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$83</span></span><span class="ce">; 0x83 == Wing Boots used IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Remove the item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c581]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<div class="c">;
; Play a sound effect for the item usage.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; Set the sound to play to 0x1A (special item sound).</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<div class="c">;
; Calculate the index into the duration table based on
; the player's title.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span><span class="ce">; Load the player's title.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Divide by 4.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A (index)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c599,X</span></span><span class="ce">; Look up in the duration table.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Set that as the starting duration.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawTimeValue">UI_DrawTimeValue</a></span></span><span class="ce">; Draw the time on the HUD.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Wing Boots durations by player title.
;
; The duration decreases every 4 player titles.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;
</div><span class="l"><a name="TITLE_TO_WINGBOOTS_DURATION" href="#TITLE_TO_WINGBOOTS_DURATION" class="la">TITLE_TO_WINGBOOTS_DURATION:</a><span class="ce">; [$c599]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [0]: 40 seconds: Novice, Aspirant, Battler, Fighter</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1e</span></span><span class="ce">; [1]: 30 seconds: Adept, Chevalier, Veteran, Warrior</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [2]: 20 seconds: Swordman, Hero, Soldier, Myrmidon</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [3]: 10 seconds: Champion, Superhero, Paladin, Lord</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Decrement the Wing Boot's duration.
;
; This will decrement and then draw the time in the HUD.
;
; INPUTS:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         The remaining duration for the Wing Boots.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         The new duration for the Wing Boots.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a name="Game_DecWingBootsDuration" href="#Game_DecWingBootsDuration" class="la">Game_DecWingBootsDuration:</a><span class="ce">; [$c59d]</span></span>
<div class="c">;
; Check if there's any time remaining on the Wing Boots.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Load the remaining time on the Wing Boots.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If the counter is unset (0xFF), return.</span></span>
<span class="l"></span>
<div class="c">;
; Update the player's status to mark Wing Boots as on.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Enable the Wing Boots bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Update at most once every second.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if we're at the 1 second mark.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Reduce time on the Wing Boots by a second.
;
</div><span class="l"><span><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Decrement the remaining time for the Wing Boots.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Load that duration</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_wingBootsDone">@_wingBootsDone</a></span></span><span class="ce">; If it wrapped from 0 to 0xFF, it's used up. Jump.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawTimeValue">UI_DrawTimeValue</a></span></span><span class="ce">; Else, draw the time remaining.</span></span>
<span class="l"></span>
<div class="c">;
; The Wing Boots ran out. Remove the flag from the player's
; status.
;
</div><span class="l"><a name="@_wingBootsDone" href="#@_wingBootsDone" class="lla">@_wingBootsDone:</a><span class="ce">; [$c5b9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Clear the Wing Boots flag.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Run "Wing Boots are gone" IScript.
;
; IScript 0x96 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$96</span></span><span class="ce">; 0x96 == Wing Boots are gone IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; It will resume here.
;
</div><span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c5c7]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Use the Hour Glass.
;
; This will invoke the IScript for the Hour Glass's
; message, play a sound, and begin the Hour Glass
; effect.
;
; The player's health will be reduced by half in the
; process.
;
; INPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The player's current health.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The player's new health, reduced by half.
;
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The duration of the Hour Glass.
;
;     <a href="RAM.html#CurrentMusic">CurrentMusic</a>:
;         The music to play while the Hour Glass is
;         active.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     UI_DrawPlayerHP
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4b7]
;============================================================================
</div><span class="l"><a name="Player_UseHourGlass" href="#Player_UseHourGlass" class="la">Player_UseHourGlass:</a><span class="ce">; [$c5c8]</span></span>
<div class="c">;
; Run the "Hour Glass Used" IScript.
;
; IScript 0x82 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$82</span></span><span class="ce">; Set the IScript to run to 0x82.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Remove the item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c5d0]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<div class="c">;
; Play a sound effect for the item usage.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; Set the sound to play to 0x1A (special item sound).</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<div class="c">;
; Reduce the player's health by half. This is the cost of
; the Hour Glass.
;
</div><span class="l"><span><span class="i">LSR</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Divide the upper value of the player's HP by half.</span></span>
<span class="l"><span><span class="i">ROR</span> <span class="o">a:<a href="RAM.html#Player_HP_L">Player_HP_L</a></span></span><span class="ce">; Divide the lower byte of the player's HP by half, and add carry from the upper.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw the new HP.</span></span>
<span class="l"></span>
<div class="c">;
; Set the duration of the Hour Glass to 15 seconds.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$0f</span></span><span class="ce">; Set the duration to 15 seconds.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Change the music.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$0b</span></span><span class="ce">; Set the new music to play.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; And play it.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Decrement the Hour Glass's duration.
;
; INPUTS:
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The remaining duration for the Hour Glass.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The new duration for the Hour Glass..
;
;     <a href="RAM.html#CurrentMusic">CurrentMusic</a>:
;         The restored music for the area.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a name="Game_DecHourGlassDuration" href="#Game_DecHourGlassDuration" class="la">Game_DecHourGlassDuration:</a><span class="ce">; [$c5eb]</span></span>
<div class="c">;
; Check if there's any time remaining on the Hour Glass.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Load the remaining time on the Hour Glass.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If the counter is unset (0xFF), return.</span></span>
<span class="l"></span>
<div class="c">;
; Update at most once every second.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if we're at the 1 second mark.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Reduce time on the Hour Glass by a second.
;
</div><span class="l"><span><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Decrement the remaining time for the Hour Glass.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it wrapped from 0 to 0xFF, it's used up. Jump.</span></span>
<span class="l"></span>
<div class="c">;
; Run "Hour Glass is gone" IScript.
;
; IScript 0x97 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$97</span></span><span class="ce">; 0x97 == Hour Glass is gone IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Load the area's default music.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c603]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Load the music for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c608]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Add 100XP to the player's experience.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     #$ed:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_UpdateExperience">Player_UpdateExperience</a>
;
; XREFS:
;     <a href="#Maybe_Player_PickUpGlove">Maybe_Player_PickUpGlove</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;============================================================================
</div><span class="l"><a name="Player_Add100XP" href="#Player_Add100XP" class="la">Player_Add100XP:</a><span class="ce">; [$c609]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$64</span></span><span class="ce">; A = 100 (lower byte of XP)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store it as an argument.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (upper byte of XP).</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Store it as an argument.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_UpdateExperience">Player_UpdateExperience</a></span></span><span class="ce">; Update the player's experience using those values.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Use the Mattock.
;
; This will check if the Mattock can be used at the current
; player position. If so, it will invoke the IScript for the
; Mattock's message, play a sound, and update the level state.
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The player's current X position.
;
;     <a href="RAM.html#PlayerPosY">PlayerPosY</a>:
;         The player's current Y position.
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's flags.
;
;     <a href="#USE_MATTOCK_BLOCK_DISTANCES">USE_MATTOCK_BLOCK_DISTANCES</a>:
;         TODO
;
; OUTPUTS:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4af]
;============================================================================
</div><span class="l"><a name="Player_UseMattock" href="#Player_UseMattock" class="la">Player_UseMattock:</a><span class="ce">; [$c616]</span></span>
<div class="c">;
; Check if the block check position will be in bounds.
;
; The offset will be dependent on the facing direction.
;
; If facing left, this will check the block immediately
; to the left (0xFF -- wrapping around the screen).
;
; If facing right, this will check block + 16 (within or
; at the end of the blocks to clear).
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Lookup table index = 0 (default)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is the player facing right?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c61f">@LAB_PRG15_MIRROR__c61f</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; The player is facing right. Set our offset into the block
; distances table to 1.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Lookup table index = 1</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c61f" href="#@LAB_PRG15_MIRROR__c61f" class="lla">@LAB_PRG15_MIRROR__c61f:</a><span class="ce">; [$c61f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Get the player's X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$c68d,Y</span></span><span class="ce">; Add the block distance for the facing direction.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f0</span></span><span class="ce">; Is the player too near to the right edge of the screen?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<div class="c">;
; Begin fetching the block at this offset.
;
; Same logic as above for block calculation.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store the calculated position as the X argument.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span><span class="ce">; Load the player's current Y position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store that as the Y argument.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert those pixel positions to block positions.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the screen buffer contains the blocks to clear.
; If not, there's nothing to do.
;
; Each block is composed of 4 tiles, which are represented
; in the lookup table. This only needs to check for the
; presence of one of those blocks.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current area.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a 4 byte index.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = index</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the value from the screen buffer.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$c68f,Y</span></span><span class="ce">; Is this block already cleared by the Mattock?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_useMattock">@_useMattock</a></span></span><span class="ce">; If not, use the Mattock to clear them.</span></span>
<span class="l"><span><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
<div class="c">;
; The Mattock will be used. Store the offsets into the
; screen buffer and array on the stack for later.
;
</div><span class="l"><a name="@_useMattock" href="#@_useMattock" class="lla">@_useMattock:</a><span class="ce">; [$c640]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Run the "Used Mattock" IScript.
;
; IScript 0x81 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$81</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Remove the Mattock.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c64c]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for the Mattock usage.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; 0x1A == Special item sound effect.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Prepare for the loop.
;
; This loop will handle animating the destruction/crumbling
; of blocks. This uses 4 frames of animation, all defined in
; <a href="#USE_MATTOCK_BLOCK_TRANSITIONS">USE_MATTOCK_BLOCK_TRANSITIONS</a>.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<div class="c">;
; Only update every 4 frames, to get a quick animation effect.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$c658]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for 4 frames.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Update the screen to place the next block in the sequence.
;
</div><span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c68f,Y</span></span><span class="ce">; Load the block for this position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; And store it in the screen buffer.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the level data.</span></span>
<span class="l"></span>
<div class="c">;
; Update to the next block.
;
</div><span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 32</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a></span></span><span class="ce">; Load a value.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; And write it to the screen buffer.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Upate the level data.</span></span>
<span class="l"></span>
<div class="c">;
; Prepare for the next loop iteration.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Have we finished updating the blocks?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; Else, loop.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c68c]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Block distances for checking if a player is on-screen.
;
; This is used when using the Mattock.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;
</div><span class="l"><a name="USE_MATTOCK_BLOCK_DISTANCES" href="#USE_MATTOCK_BLOCK_DISTANCES" class="la">USE_MATTOCK_BLOCK_DISTANCES:</a><span class="ce">; [$c68d]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;
</div><span class="l"><a name="USE_MATTOCK_BLOCK_DISTANCES_1_" href="#USE_MATTOCK_BLOCK_DISTANCES_1_" class="la">USE_MATTOCK_BLOCK_DISTANCES_1_:</a><span class="ce">; [$c68e]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; New block IDs to place when clearing blocks.
;
; This is divided into regions, each with 4 blocks.
; Those 4 blocks are an animation transition between
; the placed blocks (index 0 within a group) and
; cleared blocks (index 3).
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;
</div><span class="l"><a name="USE_MATTOCK_BLOCK_TRANSITIONS" href="#USE_MATTOCK_BLOCK_TRANSITIONS" class="la">USE_MATTOCK_BLOCK_TRANSITIONS:</a><span class="ce">; [$c68f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$63</span></span><span class="ce">; [4]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$85</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$86</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [8]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [12]: Mascon</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [15]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [16]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [17]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [18]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [20]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [21]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [22]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [23]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [24]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [25]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [26]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [27]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [28]: Evil Fortress</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [29]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [30]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [31]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear timers on all temporary status items.
;
; This applies to the Glove, Ointment, Wing Boots, and
; Hour Glass.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#DurationGlove">DurationGlove</a>:
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         All set to 0xFF (not active).
;
; XREFS:
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a name="Game_ClearTimedItems" href="#Game_ClearTimedItems" class="la">Game_ClearTimedItems:</a><span class="ce">; [$c6af]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Clear the Glove duration.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Clear the Ointment duration.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Clear the Wing Boots duration.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Clear the Hour Glass duration.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Hour Glass.
;
; This will invoke the IScript, play the sound, and add
; the Hour Glass to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpHourGlass" href="#Player_PickUpHourGlass" class="la">Player_PickUpHourGlass:</a><span class="ce">; [$c6be]</span></span>
<div class="c">;
; Run the "Got Hour Glass" IScript.
;
; IScript 0x8A via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$8a</span></span><span class="ce">; 0x8A == Hour Glass picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c6c6]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Pick up the item.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$0d</span></span><span class="ce">; 0xD == Hour Glass.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick it up.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Wing Boots for the quest.
;
; This will invoke the IScript, play the sound, and add
; the Wing Boots to the inventory.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The player's current completed quests.
;
; OUTPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The updated set of completed quests.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpWingBootsWithQuest" href="#Player_PickUpWingBootsWithQuest" class="la">Player_PickUpWingBootsWithQuest:</a><span class="ce">; [$c6d0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the completed quests.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; Mark this quest as completed.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Store it back out.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Wing Boots.
;
; This will invoke the IScript, play the sound, and add
; the Wing Boots to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpWingBoots" href="#Player_PickUpWingBoots" class="la">Player_PickUpWingBoots:</a><span class="ce">; [$c6d8]</span></span>
<div class="c">;
; Run the "Got Wing Boots" IScript.
;
; IScript 0x89 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$89</span></span><span class="ce">; 0x89 == Wing boots picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c6e0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x8 == Item pick-up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Pick up the item.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$0f</span></span><span class="ce">; 0xF == Wing Boots.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick it up.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Pick up the Battle Suit and add to the inventory.
;
; This will invoke the IScript, play the sound, and then
; attempt to cap the armor insert position and add the item
; there.
;
; BUGS:
;     This has a bug where it checks the caps against the
;     WEAPON slots, not the ARMOR slots!
;
;     Player_PickUpDragonSlayer has the inverse
;     bug.
;
; INPUTS:
;     <a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a>:
;         The number of weapons the player is carrying.
;
; OUTPUTS:
;     <a href="RAM.html#ArmorInventory">ArmorInventory</a>:
;         The updated armor inventory.
;
;     <a href="RAM.html#NumberOfArmors">NumberOfArmors</a>:
;         The number of armors in the inventory.
;
;     See CALLS.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpBattleSuit" href="#Player_PickUpBattleSuit" class="la">Player_PickUpBattleSuit:</a><span class="ce">; [$c6ea]</span></span>
<div class="c">;
; Run the "Got Battle Suit" IScript.
;
; IScript 0x8B via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$8b</span></span><span class="ce">; 0x8B == Battle Suit picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c6f2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Cap the number of WEAPONS in the inventory.
;
; Yes, weapons. This *should* be armor. This code is swapped
; with the code that equips the Dragon Slayer.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a></span></span><span class="ce">; X = Number of weapons.</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$04</span></span><span class="ce">; If &lt; 4</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_addItem">@_addItem</a></span></span><span class="ce">; Then, add it to the latest slot.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; Else, cap X to 3.</span></span>
<span class="l"></span>
<div class="c">;
; Add the Battle Suit to the inventory.
;
</div><span class="l"><a name="@_addItem" href="#@_addItem" class="lla">@_addItem:</a><span class="ce">; [$c700]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span><span class="ce">; 0x03 == Battle Suit</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ArmorInventory">ArmorInventory</a>,X</span></span><span class="ce">; Set in the inventory slot</span></span>
<span class="l"></span>
<div class="c">;
; Increase the number of armors collected.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfArmors">NumberOfArmors</a></span></span><span class="ce">; Store as the number of armors.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Pick up the Battle Helmet and add to the inventory.
;
; This will invoke the IScript, play the sound, and then
; cap the shield insertion point and add the item there.
;
; Keep in mind, the Battle Helmet is considered a shield in
; this game.
;
; INPUTS:
;     <a href="RAM.html#NumberOfShields">NumberOfShields</a>:
;         The number of shields the player is carrying.
;
; OUTPUTS:
;     <a href="RAM.html#ShieldInventory">ShieldInventory</a>:
;         The updated armor inventory.
;
;     <a href="RAM.html#NumberOfShields">NumberOfShields</a>:
;         The number of armors in the inventory.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpBattleHelmet" href="#Player_PickUpBattleHelmet" class="la">Player_PickUpBattleHelmet:</a><span class="ce">; [$c70a]</span></span>
<div class="c">;
; Run the "Got Battle Helmet" IScript.
;
; IScript 0x8C via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$8c</span></span><span class="ce">; 0x8C == Battle Helmet picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run it.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c712]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Cap the number of shields in the inventory.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfShields">NumberOfShields</a></span></span><span class="ce">; X = Number of shields.</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$04</span></span><span class="ce">; If X &lt; 4:</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_addItem">@_addItem</a></span></span><span class="ce">; Then, add to the latest slot.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; Else, cap X to 3.</span></span>
<span class="l"></span>
<div class="c">;
; Add the Battle Helmet to the inventory.
;
</div><span class="l"><a name="@_addItem" href="#@_addItem" class="lla">@_addItem:</a><span class="ce">; [$c720]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span><span class="ce">; 0x03 == Battle Helmet.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ShieldInventory">ShieldInventory</a>,X</span></span><span class="ce">; Set in the inventory slot.</span></span>
<span class="l"></span>
<div class="c">;
; Increase the number of shields collected.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfShields">NumberOfShields</a></span></span><span class="ce">; Store as the number of shields.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Pick up the Dragon Slayer and add to the inventory.
;
; This will invoke the IScript, play the sound, and then
; attempt to cap the armor insert position and add the item
; there.
;
; BUGS:
;     This has a bug where it checks the caps against the
;     ARMOR slots, not the WEAPON slots!
;
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a> has the inverse
;     bug.
;
; INPUTS:
;     <a href="RAM.html#NumberOfArmors">NumberOfArmors</a>:
;         The number of armors the player is carrying.
;
; OUTPUTS:
;     <a href="RAM.html#WeaponInventory">WeaponInventory</a>:
;         The updated weapon inventory.
;
;     <a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a>:
;         The number of weapons in the inventory.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpDragonSlayer" href="#Player_PickUpDragonSlayer" class="la">Player_PickUpDragonSlayer:</a><span class="ce">; [$c72a]</span></span>
<div class="c">;
; Run the "Got Dragon Slayer" IScript.
;
; IScript 0x8D via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$8d</span></span><span class="ce">; 0x8D == Dragon Slayer picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run it.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c732]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Cap the number of ARMORS in the inventory.
;
; Yes, armors. This *should* be weapons. This code is swapped
; with the code that equips the Battle Suit.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfArmors">NumberOfArmors</a></span></span><span class="ce">; X = number of armors.</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$04</span></span><span class="ce">; If &lt; 4</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_addItem">@_addItem</a></span></span><span class="ce">; Then, add it to the latest slot.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; Else, cap X to 3.</span></span>
<span class="l"></span>
<div class="c">;
; Add the Dragon Slayer to the inventory.
;
</div><span class="l"><a name="@_addItem" href="#@_addItem" class="lla">@_addItem:</a><span class="ce">; [$c740]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span><span class="ce">; 0x03 == Dragon Slayer</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#WeaponInventory">WeaponInventory</a>,X</span></span><span class="ce">; Set in the inventory slot.</span></span>
<span class="l"></span>
<div class="c">;
; Increase the number of weapons collected.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a></span></span><span class="ce">; Store as the number of weapons.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Mattock for the quest.
;
; This will invoke the IScript, play the sound, and set
; the Mattock bit in the quests and in the inventory.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The current completed quests.
;
; OUTPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The updated completed quests.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpMattockWithQuest" href="#Player_PickUpMattockWithQuest" class="la">Player_PickUpMattockWithQuest:</a><span class="ce">; [$c74a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the quests bitmask.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$10</span></span><span class="ce">; Bit 0x10 == Mattock</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through to the next function. --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Mattock.
;
; This will invoke the IScript, play the sound, and add
; the Mattock to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpMattock" href="#Player_PickUpMattock" class="la">Player_PickUpMattock:</a><span class="ce">; [$c752]</span></span>
<div class="c">;
; Run the "Got Mattock" IScript.
;
; IScript 0x88 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$88</span></span><span class="ce">; 0x88 == Mattock picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c75a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Load the Mattock into the inventory.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$09</span></span><span class="ce">; 0x09 == Mattock</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick up the Mattock.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up an item.
;
; INPUTS:
;     A:
;         The sprite entity that was interacted with.
;
;         This will determine the proper handler for the
;         item pick-up.
;
; OUTPUTS:
;     See CALLS.
;
; CALLS:
;     Player_PickUpBattleHelmet
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a>
;     Player_PickUpBlackOnyx
;     Player_PickUpDragonSlayer
;     <a href="#Player_PickUpElixir">Player_PickUpElixir</a>
;     <a href="PRG15.html#Player_PickUpGlove">Player_PickUpGlove</a>
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMagicalRod">Player_PickUpMagicalRod</a>
;     Player_PickUpMattock
;     <a href="#Player_PickUpMattockWithQuest">Player_PickUpMattockWithQuest</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;     Player_PickUpPendant
;     <a href="#Player_PickUpPoison">Player_PickUpPoison</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;     <a href="#Player_PickUpWingBootsWithQuest">Player_PickUpWingBootsWithQuest</a>
;
; XREFS:
;     <a href="PRG14.html#Player_HandleTouchItem">Player_HandleTouchItem</a>
;============================================================================
</div><span class="l"><a name="Player_PickUp" href="#Player_PickUp" class="la">Player_PickUp:</a><span class="ce">; [$c764]</span></span>
<div class="c">;
; Check if this is the Mattock.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; 0x50 == Mattock</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpMattock">Player_PickUpMattock</a></span></span><span class="ce">; If 0x50, this is the Mattock. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Magical Rod.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$57</span></span><span class="ce">; 0x57 == Magical Rod</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkBattleSuit">@_checkBattleSuit</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpMagicalRod">Player_PickUpMagicalRod</a></span></span><span class="ce">; This is the Magical Rod. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the battle suit.
;
</div><span class="l"><a name="@_checkBattleSuit" href="#@_checkBattleSuit" class="lla">@_checkBattleSuit:</a><span class="ce">; [$c76f]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$58</span></span><span class="ce">; 0x58 == Battle Suit</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkBattleHelmet">@_checkBattleHelmet</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a></span></span><span class="ce">; This is the Battle Suit. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the battle helmet.
;
</div><span class="l"><a name="@_checkBattleHelmet" href="#@_checkBattleHelmet" class="lla">@_checkBattleHelmet:</a><span class="ce">; [$c776]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$59</span></span><span class="ce">; 0x59 == Battle Helmet</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpBattleHelmet">Player_PickUpBattleHelmet</a></span></span><span class="ce">; This is the Battle Helmet. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Dragon Slayer.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$5a</span></span><span class="ce">; 0x5A == Dragon Slayer</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpDragonSlayer">Player_PickUpDragonSlayer</a></span></span><span class="ce">; This is the Dragon Slayer. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Mattock.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$5b</span></span><span class="ce">; 0x5B == Mattock</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpMattockWithQuest">Player_PickUpMattockWithQuest</a></span></span><span class="ce">; This is the Mattock. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Wing Boots.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$55</span></span><span class="ce">; 0x55 == Wing Boots</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkWingBootsQuest8">@_checkWingBootsQuest8</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a></span></span><span class="ce">; This is the Wing Boots. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Wing Boots (with Quest 0x08).
;
</div><span class="l"><a name="@_checkWingBootsQuest8" href="#@_checkWingBootsQuest8" class="lla">@_checkWingBootsQuest8:</a><span class="ce">; [$c789]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$5c</span></span><span class="ce">; 0x5C == Wing Boots for Quest 8</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkHourGlass">@_checkHourGlass</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpWingBootsWithQuest">Player_PickUpWingBootsWithQuest</a></span></span><span class="ce">; This is the Wing Boots for Quest 8. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Hour Glass.
;
</div><span class="l"><a name="@_checkHourGlass" href="#@_checkHourGlass" class="lla">@_checkHourGlass:</a><span class="ce">; [$c790]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$56</span></span><span class="ce">; 0x56 == Hour Glass</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkRedPotion">@_checkRedPotion</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a></span></span><span class="ce">; This is the Hour Glass.  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Red Potion.
;
</div><span class="l"><a name="@_checkRedPotion" href="#@_checkRedPotion" class="lla">@_checkRedPotion:</a><span class="ce">; [$c797]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$5d</span></span><span class="ce">; 0x5D == Red Potion (1)</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkPoison">@_checkPoison</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a></span></span><span class="ce">; This is the Red Potion (1).  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Poison.
;
</div><span class="l"><a name="@_checkPoison" href="#@_checkPoison" class="lla">@_checkPoison:</a><span class="ce">; [$c79e]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$5e</span></span><span class="ce">; 0x5E == Poison</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c7a5">@LAB_PRG15_MIRROR__c7a5</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpPoison">Player_PickUpPoison</a></span></span><span class="ce">; This is the Poison.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c7a5" href="#@LAB_PRG15_MIRROR__c7a5" class="lla">@LAB_PRG15_MIRROR__c7a5:</a><span class="ce">; [$c7a5]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$5f</span></span><span class="ce">; 0x5F == Glove</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Maybe_Player_PickUpGlove">Maybe_Player_PickUpGlove</a></span></span><span class="ce">; This is the Glove.  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Ointment.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$60</span></span><span class="ce">; 0x60 == Ointment</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c7b0">@LAB_PRG15_MIRROR__c7b0</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpOintment">Player_PickUpOintment</a></span></span><span class="ce">; This is the Ointment.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c7b0" href="#@LAB_PRG15_MIRROR__c7b0" class="lla">@LAB_PRG15_MIRROR__c7b0:</a><span class="ce">; [$c7b0]</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$48</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Maybe_Player_PickUpGlove">Maybe_Player_PickUpGlove</a></span></span><span class="ce">; This is the Glove. Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Black Onyx.
;
</div><span class="l"><span><span class="i">DEY</span></span><span class="ce">; 0x49 == Black Onyx</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpBlackOnyx">Player_PickUpBlackOnyx</a></span></span><span class="ce">; If 0x49, this is the Black Onyx.  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Pendant.
;
</div><span class="l"><span><span class="i">DEY</span></span><span class="ce">; 0x4A == Pendant</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpPendant">Player_PickUpPendant</a></span></span><span class="ce">; If 0x4A, this is the pendant.  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Red Potion (another variant).
;
</div><span class="l"><span><span class="i">DEY</span></span><span class="ce">; 0x4B == Red Potion (2)</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a></span></span><span class="ce">; If 0x4B, this is the Red Potion (2).  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Poison.
;
</div><span class="l"><span><span class="i">DEY</span></span><span class="ce">; 0x4C == Poison</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpPoison">Player_PickUpPoison</a></span></span><span class="ce">; If 0x4C, this is the Poison.  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Elixir.
;
</div><span class="l"><span><span class="i">DEY</span></span><span class="ce">; 0x4D == Elixir</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkOintment">@_checkOintment</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpElixir">Player_PickUpElixir</a></span></span><span class="ce">; This is the Elixir.  Pick it up.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Ointment.
;
</div><span class="l"><a name="@_checkOintment" href="#@_checkOintment" class="lla">@_checkOintment:</a><span class="ce">; [$c7c8]</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; 0x4E == Ointment</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_exit">@_exit</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpOintment">Player_PickUpOintment</a></span></span><span class="ce">; This is the Ointment.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"><a name="@_exit" href="#@_exit" class="lla">@_exit:</a><span class="ce">; [$c7ce]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Glove.
;
; This will invoke the IScript, play the sound, and enable
; the Glove state.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_Add100XP">Player_Add100XP</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_PickUpGlove" href="#Maybe_Player_PickUpGlove" class="la">Maybe_Player_PickUpGlove:</a><span class="ce">; [$c7cf]</span></span>
<div class="c">;
; Run the "Got Glove" IScript.
;
; IScript 0x92 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$92</span></span><span class="ce">; 0x92 == Glove picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c7d7]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Activate the Glove by setting its duration, and then
; add 100XP to the player.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$14</span></span><span class="ce">; A = 20 seconds.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Set as the Glove duration.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_Add100XP">Player_Add100XP</a></span></span><span class="ce">; Give the player 100XP.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Black Onyx.
;
; This will invoke the IScript, play the sound, and add
; the Black Onyx to the special items inventory.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's special items.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The updated special items.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpBlackOnyx" href="#Player_PickUpBlackOnyx" class="la">Player_PickUpBlackOnyx:</a><span class="ce">; [$c7e4]</span></span>
<div class="c">;
; Run the "Got Black Onyx" IScript.
;
; IScript 0x8E via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$8e</span></span><span class="ce">; 0x8E == Black Onyx picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c7ec]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the item to the player's special items list.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the current special items bitmask.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$01</span></span><span class="ce">; Bit 0x01 == Black Onyx.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Save it back out.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Pendant.
;
; This will invoke the IScript, play the sound, and add
; the Pendant to the special items inventory.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's special items.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The updated special items.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpPendant" href="#Player_PickUpPendant" class="la">Player_PickUpPendant:</a><span class="ce">; [$c7fa]</span></span>
<div class="c">;
; Run the "Got Glove" IScript.
;
; IScript 0x8F via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$8f</span></span><span class="ce">; 0x8F = Pendant picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c802]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 = Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the item to the player's special items list.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the curent special items bitmask.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$02</span></span><span class="ce">; Bit 0x02 == Pendant.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Save it back out.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Magical Rod.
;
; This will invoke the IScript, play the sound, and add
; the Magical Rod to the special items inventory.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's special items.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The updated special items.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpMagicalRod" href="#Player_PickUpMagicalRod" class="la">Player_PickUpMagicalRod:</a><span class="ce">; [$c810]</span></span>
<div class="c">;
; Run the "Got Pendant" IScript.
;
; IScript 0x90 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$90</span></span><span class="ce">; 0x90 == Pendant picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c818]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the Magical Rod to the inventory.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the current special items bitmask.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$04</span></span><span class="ce">; Bit 0x04 == Magical Rod.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Red Potion.
;
; This will invoke the IScript, play the sound, and add
; the Red Potion to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     X:
;         Set to the current sprite index.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpRedPotion" href="#Player_PickUpRedPotion" class="la">Player_PickUpRedPotion:</a><span class="ce">; [$c826]</span></span>
<div class="c">;
; Run the "Got Red Potion" IScript.
;
; IScript 0x87 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$87</span></span><span class="ce">; 0x87 == Red Potion picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c82e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the Red Potion to the inventory.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; 0x10 == Red Potion.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick up the item.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index (restored?)</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Poison.
;
; This will invoke the IScript, play the sound, and decrease
; the player health.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     X:
;         Set to the current sprite index.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_ReduceHP">Player_ReduceHP</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpPoison" href="#Player_PickUpPoison" class="la">Player_PickUpPoison:</a><span class="ce">; [$c83c]</span></span>
<div class="c">;
; Run the "Got Poison" IScript.
;
; IScript 0x91 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$91</span></span><span class="ce">; 0x91 = Poison picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for the player taking damage.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c844]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; 0x084 = Player took damage sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Set temporary invincibility frames for the player.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$3c</span></span><span class="ce">; A = 60 iframes</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Set it as the starting invincibility phase.</span></span>
<span class="l"></span>
<div class="c">;
; Mark the player as hit.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$02</span></span><span class="ce">; Bit 0x02 == Player was hit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"></span>
<div class="c">;
; Remove 16 points from the player's health.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span><span class="ce">; Store as the lower byte of HP to remove.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span><span class="ce">; Store as the upper byte of HP to remove.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_ReduceHP">Player_ReduceHP</a></span></span><span class="ce">; Reduce the HP by that amount.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index (restored?)</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Elixir.
;
; This will invoke the IScript, play the sound, and add
; the Elixir to the special items inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     X:
;         Set to the current sprite index.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpElixir" href="#Player_PickUpElixir" class="la">Player_PickUpElixir:</a><span class="ce">; [$c864]</span></span>
<div class="c">;
; Run the "Got Elixir" IScript.
;
; IScript 0x86 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$86</span></span><span class="ce">; 0x86 == Elixir picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c86c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Add the Elixir to the inventory.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the current special items bitmask.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; Bit 0x08 == Elixir.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Save it back out.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle picking up the Ointment.
;
; This will invoke the IScript, play the sound, and set
; the Ointment state.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_Add100XP">Player_Add100XP</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpOintment" href="#Player_PickUpOintment" class="la">Player_PickUpOintment:</a><span class="ce">; [$c87a]</span></span>
<div class="c">;
; Run "Got Ointment" IScript.
;
; IScript 0x94 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$94</span></span><span class="ce">; 0x94 == Ointment picked up IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c882]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<div class="c">;
; Activate the Ointment by setting its duration, and then
; add 100XP to the player.
;
; Duration is initially set to a base of 30, but will be
; modified by level separately.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$1e</span></span><span class="ce">; A = 30 seconds.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Set as the Ointment duration.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_Add100XP">Player_Add100XP</a></span></span><span class="ce">; Give the player 100XP.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Count down all the player's special items.
;
; This will count down the Hour Glass, Wing Boots,
; Glove, and Ointment durations.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#Game_DecHourGlassDuration">Game_DecHourGlassDuration</a>
;     <a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a>
;     <a href="#Game_DecGloveDuration">Game_DecGloveDuration</a>
;     <a href="#Game_DecOintmentDuration">Game_DecOintmentDuration</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_CountdownItems" href="#GameLoop_CountdownItems" class="la">GameLoop_CountdownItems:</a><span class="ce">; [$c88f]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DecHourGlassDuration">Game_DecHourGlassDuration</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DecGloveDuration">Game_DecGloveDuration</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_DecOintmentDuration">Game_DecOintmentDuration</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Decrement the Glove's duration.
;
; INPUTS:
;     <a href="RAM.html#DurationGlove">DurationGlove</a>:
;         The remaining duration for the glove.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationGlove">DurationGlove</a>:
;         The new duration for the glove.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a name="Game_DecGloveDuration" href="#Game_DecGloveDuration" class="la">Game_DecGloveDuration:</a><span class="ce">; [$c89b]</span></span>
<div class="c">;
; Check if the Glove is active.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Load the Glove's duration.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's 0xFF (not activated), return.</span></span>
<span class="l"></span>
<div class="c">;
; Check if a second has passed.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if it's an even second boundary.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Decrement and check if the Glove is still active.
;
</div><span class="l"><span><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Decrement the Glove's duration by 1 second.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's &gt;= 0, it's still active. Return.</span></span>
<span class="l"></span>
<div class="c">;
; Countdown finished.
;
; Run "Glove is gone" IScript.
;
; IScript 0x93 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$93</span></span><span class="ce">; 0x93 == Glove is gone IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c8b3]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Decrement the Ointment's duration.
;
; INPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The remaining duration for the Ointment.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The new duration for the Ointment.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a name="Game_DecOintmentDuration" href="#Game_DecOintmentDuration" class="la">Game_DecOintmentDuration:</a><span class="ce">; [$c8b4]</span></span>
<div class="c">;
; Check if the Ointment is active.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Load the Ointment's duration.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's 0xFF (not activated), return.</span></span>
<span class="l"></span>
<div class="c">;
; Check if a second has passed.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if it's an even second boundary.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Decrement and check if the Ointment is still active.
;
</div><span class="l"><span><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Decrement the Ointment's duration by 1 second.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's &gt;= 0, it's still active. Return.</span></span>
<span class="l"></span>
<div class="c">;
; Countdown finished.
;
; Run "Ointment is gone" IScript.
;
; IScript 0x95 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$95</span></span><span class="ce">; 0x95 == Ointment is gone IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c8cc]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Pick up a standard item and place it in the inventory.
;
; This will be placed in the last available inventory slot.
; If the inventory is full, this does nothing.
;
; INPUTS:
;     A:
;         The ID of the item to place in the inventory.
;
;     <a href="RAM.html#NumberOfItems">NumberOfItems</a>:
;         The number of items the player has.
;
; OUTPUTS:
;     <a href="RAM.html#ItemInventory">ItemInventory</a>:
;         The updated item inventory.
;
;     <a href="RAM.html#NumberOfItems">NumberOfItems</a>:
;         The new number of items the player has.
;
; XREFS:
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMattock">Player_PickUpMattock</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;============================================================================
</div><span class="l"><a name="Player_PickUpItem" href="#Player_PickUpItem" class="la">Player_PickUpItem:</a><span class="ce">; [$c8cd]</span></span>
<div class="c">;
; Check first if the inventory is full.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfItems">NumberOfItems</a></span></span><span class="ce">; Load the number of items in the inventory.</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$08</span></span><span class="ce">; Is there room?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If full, exit.</span></span>
<span class="l"></span>
<div class="c">;
; There's room. Set the item in the inventory and increment
; the item counter.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ItemInventory">ItemInventory</a>,X</span></span><span class="ce">; Store the item in the next available slot.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Set the next available slot.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfItems">NumberOfItems</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$c8db]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear the selected item picture from the HUD.
;
; This will loop through the 4 tiles of the selected item
; attribute area in the HUD, setting all to 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         New upper bounds of the PPU buffer.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         Clobbered.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;============================================================================
</div><span class="l"><a name="UI_ClearSelectedItemPic" href="#UI_ClearSelectedItemPic" class="la">UI_ClearSelectedItemPic:</a><span class="ce">; [$c8dc]</span></span>
<div class="c">;
; Set the draw position to 0x13C0 (top-left of selected
; item tiles).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; A = 0x13</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Set as upper byte.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span><span class="ce">; A = 0xC0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set as lower byte.</span></span>
<span class="l"></span>
<div class="c">;
; Begin the draw loop. This will draw 4 tiles of the sprite.
; All 4 tiles making up the sprite are adjacent within this
; tile attribute.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$04</span></span><span class="ce">; X = 4 (counter).</span></span>
<span class="l"></span>
<span class="l"><a name="@_vertLoop" href="#@_vertLoop" class="lla">@_vertLoop:</a><span class="ce">; [$c8e8]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Set the draw length as 16 bytes (this tile).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Write as the length.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"></span>
<span class="l"><a name="@_horizLoop" href="#@_horizLoop" class="lla">@_horizLoop:</a><span class="ce">; [$c8f3]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write a 0 to the PPU buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_horizLoop">@_horizLoop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; This row is finished. Prepare to draw the next (if any).
;
</div><span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Store X as the new upper bounds.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; A = target address to draw to.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Increment by 16 (next tile).</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store as the new lower byte of the target address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry flag, if any.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; And save it.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack (full 0..4 loop counter).</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_vertLoop">@_vertLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Main entry point for the game.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_FinishGame">IScriptAction_FinishGame</a>
;============================================================================
</div><span class="l"><a name="Game_Init" href="#Game_Init" class="la">Game_Init:</a><span class="ce">; [$c913]</span></span>
<span class="l"><span><span class="i">SEI</span></span></span>
<span class="l"><span><span class="i">CLD</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">TXS</span></span></span>
<span class="l"></span>
<div class="c">;
; Set the PPU settings.
;
; For PPUMASK:
;
; * Color
; * Show background and sprites in leftmost 8 pixels
;
;
; For PPUCTRL:
;
; * Base nametable address = 0x2000
; * VRAM address increment per CPU read/write: add 1, going across
; * Sprite pattern table address for 8x8 sprites: 0x1000
; * Background pattern table address: 0x1000
; * Sprite size: 8x8 pixels
; * PPU master/slave select: Read backdrop from EXT pins
; * Vblank NMI disabled
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$18</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Read the PPUSTATUS register several times before writing.
;
; NESdev says this is common to ensure writes occur in the
; correct order.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c925" href="#@LAB_PRG15_MIRROR__c925" class="lla">@LAB_PRG15_MIRROR__c925:</a><span class="ce">; [$c925]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c925">@LAB_PRG15_MIRROR__c925</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c92a" href="#@LAB_PRG15_MIRROR__c92a" class="lla">@LAB_PRG15_MIRROR__c92a:</a><span class="ce">; [$c92a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c92a">@LAB_PRG15_MIRROR__c92a</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set PPUMASK to 0 to allow transferring large amounts of
; Data to VRAM.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">TXS</span></span></span>
<span class="l"></span>
<div class="c">;
; Clear RAM, setting all ranges of bytes used for state to 0.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$c939]</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$fc</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c93f">@LAB_PRG15_MIRROR__c93f</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a>,X</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c93f" href="#@LAB_PRG15_MIRROR__c93f" class="lla">@LAB_PRG15_MIRROR__c93f:</a><span class="ce">; [$c93f]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_0200">Temp_0200</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0300,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0400,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check whether the OAM needs to be reset.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a name="OnInterrupt__updatePPUOAMAndAudio" href="#OnInterrupt__updatePPUOAMAndAudio" class="la">OnInterrupt__updatePPUOAMAndAudio:</a><span class="ce">; [$c95d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span><span class="ce">; Check the reset flag.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#OnInterrupt__updatePPUAndAudio">OnInterrupt__updatePPUAndAudio</a></span></span><span class="ce">; If 0, don't reset. Jump to PPU/audio management.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMADDR">OAMADDR</a></span></span><span class="ce">; Reset OAMADDR to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span><span class="ce">; Clear the reset flag.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMDMA">OAMDMA</a></span></span><span class="ce">; Initialize the OAM, writing from $0700.</span></span>
<span class="l"></span>
<div class="c">;
; Update the PPU.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a name="OnInterrupt__updatePPUAndAudio" href="#OnInterrupt__updatePPUAndAudio" class="la">OnInterrupt__updatePPUAndAudio:</a><span class="ce">; [$c96d]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a></span></span><span class="ce">; Run PPU on-interrupt handlers.</span></span>
<span class="l"></span>
<div class="c">;
; Update the audio so music keeps playing.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a name="OnInterrupt__updateAudio" href="#OnInterrupt__updateAudio" class="la">OnInterrupt__updateAudio:</a><span class="ce">; [$c970]</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Increment the interrupt counter.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch to bank 5.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$8009</span></span><span class="ce">; Run audio interrupt handlers.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$8003</span></span><span class="ce">; Run sound playback interrupt handlers.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the bank from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch back to the bank.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#OnInterrupt__popAndReturn">OnInterrupt__popAndReturn</a></span></span><span class="ce">; Prepare to exit the interrupt handler.</span></span>
<span class="l"></span>
<div class="c">;
; Main interrupt handling code won't be run. Update the
; paused interrupt counter state and clear the PPU mask
; to enable transfering large amounts of data to VRAM.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a name="OnInterrupt__noProcessInterrupts" href="#OnInterrupt__noProcessInterrupts" class="la">OnInterrupt__noProcessInterrupts:</a><span class="ce">; [$c989]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$02</span></span><span class="ce">; Is it &lt; 2?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_clearPPUMask">@_clearPPUMask</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Increment the counter.</span></span>
<span class="l"></span>
<span class="l"><a name="@_clearPPUMask" href="#@_clearPPUMask" class="lla">@_clearPPUMask:</a><span class="ce">; [$c991]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span><span class="ce">; Clear PPUMASK.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#OnInterrupt__updateAudio">OnInterrupt__updateAudio</a></span></span><span class="ce">; Update the audio.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Main interrupt handler for the game.
;
; This controls PPU interactions, audio playback, and
; controller input. Normally, these will run every
; two frames.
;
; Processing of these can be enabled or disabled
; by other code as needed by other code by setting
; <a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a> and
; <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>.
;
; Even if main input handlers are disabled, this will
; generally write to the PPU and play audio (so music
; doesn't skip).
;
; INPUTS:
;     <a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a>:
;         Whether to run game state interrupt handlers.
;
;     <a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a>:
;         A counter indicating if interrupt handlers have
;         been paused (range 0..2).
;
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         The current frame toggle. Game state interrupt
;         handlers will only be run if 0.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter to increment.
;
;     <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>:
;         If &gt; 0, OAM will be reset.
;
; OUTPUTS:
;     <a href="RAM.html#PPUMASK">PPUMASK</a>:
;         May be cleared.
;
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         May be set to 1 to skip the next frame.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The updated interrupt counter.
;
;     <a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a>:
;         Incremented if interrupt handlers are paused
;         (capped to 2).
;
;     <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>:
;     <a href="RAM.html#OAMADDR">OAMADDR</a>
;         May be set to 0.
;
;     <a href="RAM.html#OAMDMA">OAMDMA</a>:
;         May be set to 7.
;
; CALLS:
;     <a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a>
;     <a href="PRG5.html#Audio_HandleOnInterrupt">Audio_HandleOnInterrupt</a>
;     <a href="#Input_HandleOnInterrupt">Input_HandleOnInterrupt</a>
;     <a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a>
;     <a href="PRG5.html#Sound_HandleOnInterrupt">Sound_HandleOnInterrupt</a>
;============================================================================
</div><span class="l"><a name="OnInterrupt" href="#OnInterrupt" class="la">OnInterrupt:</a><span class="ce">; [$c999]</span></span>
<div class="c">;
; Push all registers to the stack.
;
</div><span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"></span>
<div class="c">;
; Check what will be handled this interrupt.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a></span></span><span class="ce">; Check whether interrupt handling code should be run.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#OnInterrupt__noProcessInterrupts">OnInterrupt__noProcessInterrupts</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; Interrupts may be run. See if it's time to run them.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Check if we're on a frame where we should run interrupts.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#OnInterrupt__updatePPUOAMAndAudio">OnInterrupt__updatePPUOAMAndAudio</a></span></span><span class="ce">; Jump to update the PPU, OAM, and Audio.</span></span>
<span class="l"></span>
<div class="c">;
; Ready to handle routine operations.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Flip the toggle.</span></span>
<span class="l"></span>
<div class="c">;
; Reset the OAM.
;
; This will write $00 to OAMADDR and then use OAMDMA.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMADDR">OAMADDR</a></span></span><span class="ce">; Clear OAMADDR.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span><span class="ce">; Turn off the reset flag.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMDMA">OAMDMA</a></span></span><span class="ce">; Initialize the OAM, writing from $0700.</span></span>
<span class="l"></span>
<div class="c">;
; Update the PPU state.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 5 (audio logic) and run audio updates.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch to bank 5.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$8009</span></span><span class="ce">; Run audio interrupt handling code.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$8003</span></span><span class="ce">; Run sound playback interrupt handling code.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the previous bank from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch back to it.</span></span>
<span class="l"></span>
<div class="c">;
; Handle input management and final state.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Input_HandleOnInterrupt">Input_HandleOnInterrupt</a></span></span><span class="ce">; Run input interrupt handlers.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Increment the interrupt counter.</span></span>
<span class="l"></span>
<div class="c">;
; Restore all registers from the stack.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a name="OnInterrupt__popAndReturn" href="#OnInterrupt__popAndReturn" class="la">OnInterrupt__popAndReturn:</a><span class="ce">; [$c9d0]</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Set Y = A</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; Set X = A</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the satck</span></span>
<span class="l"><span><span class="i">RTI</span></span><span class="ce">; Return from interrupt</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPU_HandleOnInterrupt
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;============================================================================
</div><span class="l"><a name="PPU_HandleOnInterrupt" href="#PPU_HandleOnInterrupt" class="la">PPU_HandleOnInterrupt:</a><span class="ce">; [$c9d6]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d61d">FUN_PRG15_MIRROR__d61d</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenColorMode">ScreenColorMode</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_Something_PauseUpdates">PPU_Something_PauseUpdates</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ca11">@LAB_PRG15_MIRROR__ca11</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_clearNametable2400">@_clearNametable2400</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Clear the following flags:
;
; * Nametable 2400
; * Sprite pattern 1000
; * BGTable Addr 1000
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$e6</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c9fa">@LAB_PRG15_MIRROR__c9fa</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Clear the Nametable 2400 flag.
;
</div><span class="l"><a name="@_clearNametable2400" href="#@_clearNametable2400" class="lla">@_clearNametable2400:</a><span class="ce">; [$c9f3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fe</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__c9fa" href="#@LAB_PRG15_MIRROR__c9fa" class="lla">@LAB_PRG15_MIRROR__c9fa:</a><span class="ce">; [$c9fa]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ca02" href="#@LAB_PRG15_MIRROR__ca02" class="lla">@LAB_PRG15_MIRROR__ca02:</a><span class="ce">; [$ca02]</span></span>
<span class="l"><span><span class="i">BIT</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><span><span class="i">BVS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ca02">@LAB_PRG15_MIRROR__ca02</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ca07" href="#@LAB_PRG15_MIRROR__ca07" class="lla">@LAB_PRG15_MIRROR__ca07:</a><span class="ce">; [$ca07]</span></span>
<span class="l"><span><span class="i">BIT</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><span><span class="i">BVC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ca07">@LAB_PRG15_MIRROR__ca07</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$a0</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ca0e" href="#@LAB_PRG15_MIRROR__ca0e" class="lla">@LAB_PRG15_MIRROR__ca0e:</a><span class="ce">; [$ca0e]</span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ca0e">@LAB_PRG15_MIRROR__ca0e</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ca11" href="#@LAB_PRG15_MIRROR__ca11" class="lla">@LAB_PRG15_MIRROR__ca11:</a><span class="ce">; [$ca11]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Wait for the next frame.
;
; This will wait for the next frame, looping until
; the frame change occurs.
;
; INPUTS:
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         The frame toggle flag.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__8b71">FUN_PRG12__8b71</a>
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#SplashAnimation_RunOutro">SplashAnimation_RunOutro</a>
;     <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>
;     <a href="PRG12.html#_handleWrongPassword">_handleWrongPassword</a> [$PRG12::9162]
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#FUN_PRG15_MIRROR__dacd">FUN_PRG15_MIRROR__dacd</a>
;     <a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;     <a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a>
;     <a href="#Maybe_Game_ExitBuildingHandler">Maybe_Game_ExitBuildingHandler</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a name="WaitForNextFrame" href="#WaitForNextFrame" class="la">WaitForNextFrame:</a><span class="ce">; [$ca25]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Set as the frame toggle state.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$ca29]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Load the frame toggle state from the interrupt handler.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If it's 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Wait for the next interrupt.
;
; This will loop until the interrupt counter has changed.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The interrupt counter.
;
; OUTTPUTS:
;     None
;
; XREFS:
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;============================================================================
</div><span class="l"><a name="WaitForInterrupt" href="#WaitForInterrupt" class="la">WaitForInterrupt:</a><span class="ce">; [$ca2e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt count.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$ca30]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Has the interrupt counter changed?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle input management on interrupt.
;
; This will read from the controller ports, storing
; the current button bitmasks and determining which buttons
; have been held down and which have changed since the last
; time the interrupt handler was run.
;
; Controller 2 is read for the purpose of the debug level
; switch code at <a href="#Debug_ChooseArea">Debug_ChooseArea</a>.
;
; INPUTS:
;     <a href="RAM.html#JOY1">JOY1</a>:
;     <a href="RAM.html#JOY2">JOY2</a>:
;         The controller inputs.
;
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The previous controller 1 button mask.
;
; OUTPUTS:
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The new controller 1 button mask.
;
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The buttons that changed since the last interrupt.
;
;     <a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a>:
;         The buttons held down since last interrupt.
;
;     <a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a>:
;         The new controller 2 button mask.
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;============================================================================
</div><span class="l"><a name="Input_HandleOnInterrupt" href="#Input_HandleOnInterrupt" class="la">Input_HandleOnInterrupt:</a><span class="ce">; [$ca35]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#JOY1">JOY1</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#JOY1">JOY1</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_loop1" href="#@_loop1" class="lla">@_loop1:</a><span class="ce">; [$ca49]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#JOY1">JOY1</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop1">@_loop1</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_loop2" href="#@_loop2" class="lla">@_loop2:</a><span class="ce">; [$ca5a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#JOY2">JOY2</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop2">@_loop2</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o"><a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return a pseudo-random value.
;
; Every time this is called, a new pseudo-random value will
; be returned.
;
; The set of random values is the first 256 bytes of bank
; 14. If any buttons are pressed, the button bitmask will
; affect the random value (the result value and button
; bitmask is XOR'd).
;
; INPUTS:
;     <a href="RAM.html#Random_Offset">Random_Offset</a>:
;         The current offset into the bank.
;
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The controller 1 button mask.
;
; OUTPUTS:
;     A:
;         The pseudo-random value.
;
;     <a href="RAM.html#Random_Offset">Random_Offset</a>:
;         The incremented offset (which will wrap from 0xFF
;         to 0x00).
;
; XREFS:
;     <a href="PRG14.html#CurrentSprite_RandomlyChangeHorizDirection">CurrentSprite_RandomlyChangeHorizDirection</a>
;     <a href="PRG14.html#CurrentSprite_RandomlyChangeVertDirection">CurrentSprite_RandomlyChangeVertDirection</a>
;============================================================================
</div><span class="l"><a name="GetRandom" href="#GetRandom" class="la">GetRandom:</a><span class="ce">; [$ca6e]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Random_Offset">Random_Offset</a></span></span><span class="ce">; Load the current offset into the bank.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a>,X</span></span><span class="ce">; Load the byte value at that offset.</span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; XOR with the controler 1 button mask.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Random_Offset">Random_Offset</a></span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Initialize all the game state.
;
; This is called early at startup to set initial state
; for the game, including the PPU, scroll positions,
; PPU attribute tables, sound, sound effects, pause flag,
; and more.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
;
; XREFS:
;     <a href="#Game_Init">Game_Init</a>
;============================================================================
</div><span class="l"><a name="Game_InitScreenAndMusic" href="#Game_InitScreenAndMusic" class="la">Game_InitScreenAndMusic:</a><span class="ce">; [$ca78]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$1e</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenColorMode">ScreenColorMode</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_FrameAltToggleWithPausePPU">Something_FrameAltToggleWithPausePPU</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Maybe_GameScreenStart">Maybe_GameScreenStart</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 5 and set up sound.
;
</div><span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$8006</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PauseFlag">PauseFlag</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPU_InitVBlank">PPU_InitVBlank</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the PPU address to the specified value.
;
; INPUTS:
;     A:
;         The upper byte of the address.
;
;     X:
;         The lower byte of the address.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The updated address.
;
; XREFS:
;     <a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a>
;============================================================================
</div><span class="l"><a name="PPU_SetAddr" href="#PPU_SetAddr" class="la">PPU_SetAddr:</a><span class="ce">; [$cab5]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set the upper byte.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set the lower byte.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPU_InitAttributeAndNameTables
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;============================================================================
</div><span class="l"><a name="PPU_InitAttributeAndNameTables" href="#PPU_InitAttributeAndNameTables" class="la">PPU_InitAttributeAndNameTables:</a><span class="ce">; [$cabc]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_PPU_NametableValue">Temp_PPU_NametableValue</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set address 0x2000: Name table 0.
;
; Write 32 to 8 bytes.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddr">PPU_SetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_PPU_NametableValue">Temp_PPU_NametableValue</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set address 0x23C0: Attribute table 0.
;
; Write 64 entries of byte 0x55 to the table. This is color bit 01
; for each quadrant of each sprite.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$23</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddr">PPU_SetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$55</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set address 0x27C0: Attribute table 1.
;
; Write 64 entries here with the same information.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$27</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddr">PPU_SetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$55</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Fills a grid in the PPU with a value.
;
; This writes a value to the PPU up to X times, and then
; again 256 * Y times.
;
; This seems a bit strange, but in practice it's never
; really used this way. Always 256 columns for every row,
; or only ever one row.
;
; INPUTS:
;     A:
;         The value to write.
;
;     X:
;         Initial number of columns for the first row
;         (256 columns per row after).
;
;     Y:
;         The number of rows.
;
; OUTPUTS:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         Updated with the new written data.
;
; XREFS:
;     <a href="#PPU_FillGrid">PPU_FillGrid</a>
;     <a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a>
;============================================================================
</div><span class="l"><a name="PPU_FillGrid" href="#PPU_FillGrid" class="la">PPU_FillGrid:</a><span class="ce">; [$caed]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write the value to PPUDATA.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; An inner loop was finished. Decrement and begin again.
;
; It appears it should write 256 more times on this iteration.
;
</div><span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span><span class="ce">; If Y &gt; 0, loop</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Wait until all buffered data to the PPU is flushed.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The upper bounds of the PPU buffer to write.
;
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The current offset within the PPU buffer to write.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_DrawScenery">SplashAnimation_DrawScenery</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#FUN_PRG15_MIRROR__dacd">FUN_PRG15_MIRROR__dacd</a>
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;     <a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a>
;     <a href="#Maybe_Game_ExitBuildingHandler">Maybe_Game_ExitBuildingHandler</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;============================================================================
</div><span class="l"><a name="PPU_WaitUntilFlushed" href="#PPU_WaitUntilFlushed" class="la">PPU_WaitUntilFlushed:</a><span class="ce">; [$caf7]</span></span>
<div class="c">;
; Wait until the PPU buffer has been emptied (flushed to the
; PPU).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Load the upper bounds of the PPU buffer.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Has the read offset hit the upper bounds?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; If not, loop until it's cleared.</span></span>
<span class="l"></span>
<div class="c">;
; Pause interrupt handling for 2 interrupts.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Reset the paused interrupt counter.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a></span></span><span class="ce">; Disable processing of interrupts.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Wait for 2 interrupts (at least).
;
</div><span class="l"><a name="@_waitForInterruptLoop" href="#@_waitForInterruptLoop" class="lla">@_waitForInterruptLoop:</a><span class="ce">; [$cb05]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Load the paused interrupt counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Has it reached 2 interrupts?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_waitForInterruptLoop">@_waitForInterruptLoop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; DEADCODE
;
; XREFS:
;     <a href="#DEADCODE_FUN_PRG15_MIRROR__cb0c">DEADCODE_FUN_PRG15_MIRROR__cb0c</a>
;============================================================================
</div><span class="l"><a name="DEADCODE_FUN_PRG15_MIRROR__cb0c" href="#DEADCODE_FUN_PRG15_MIRROR__cb0c" class="la">DEADCODE_FUN_PRG15_MIRROR__cb0c:</a><span class="ce">; [$cb0c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#DEADCODE_FUN_PRG15_MIRROR__cb0c">DEADCODE_FUN_PRG15_MIRROR__cb0c</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__cb11" href="#@LAB_PRG15_MIRROR__cb11" class="lla">@LAB_PRG15_MIRROR__cb11:</a><span class="ce">; [$cb11]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__cb11">@LAB_PRG15_MIRROR__cb11</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__cb17
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__dacd">FUN_PRG15_MIRROR__dacd</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;     <a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a>
;     <a href="#Maybe_Game_ExitBuildingHandler">Maybe_Game_ExitBuildingHandler</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__cb17" href="#FUN_PRG15_MIRROR__cb17" class="la">FUN_PRG15_MIRROR__cb17:</a><span class="ce">; [$cb17]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; MAYBE DEADCODE
;============================================================================
</div><span class="l"><a name="MAYBE_UNUSED_FUN_PRG15_MIRROR__cb1f" href="#MAYBE_UNUSED_FUN_PRG15_MIRROR__cb1f" class="la">MAYBE_UNUSED_FUN_PRG15_MIRROR__cb1f:</a><span class="ce">; [$cb1f]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb3f">FUN_PRG15_MIRROR__cb3f</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__cb27
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#SplashAnimation_RunOutro">SplashAnimation_RunOutro</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__cb27" href="#FUN_PRG15_MIRROR__cb27" class="la">FUN_PRG15_MIRROR__cb27:</a><span class="ce">; [$cb27]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_FrameAltToggleWithPausePPU">Something_FrameAltToggleWithPausePPU</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_EnableInterruptHandlers">Game_EnableInterruptHandlers</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Initialize VBlank for the PPU.
;
; INPUTS:
;     <a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a>:
;         The current PPU control flags.
;
; OUTPUTS:
;     <a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a>:
;         The updated PPU control flags.
;
; XREFS:
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;============================================================================
</div><span class="l"><a name="PPU_InitVBlank" href="#PPU_InitVBlank" class="la">PPU_InitVBlank:</a><span class="ce">; [$cb2f]</span></span>
<div class="c">;
; Enable VBlank NMI.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span><span class="ce">; Load the PPU control flags.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Enable the VBlank bit.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_savePPUCtrl">@_savePPUCtrl</a></span></span><span class="ce">; If SavedPPUCtrl was zero, undo this

??</span></span>
<span class="l"></span>
<div class="c">;
; Disable VBlank NMI.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span></span>
<span class="l"></span>
<div class="c">;
; Write our copy of the bitmask and set on the PPU.
;
</div><span class="l"><a name="@_savePPUCtrl" href="#@_savePPUCtrl" class="lla">@_savePPUCtrl:</a><span class="ce">; [$cb39]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; MAYBE DEADCODE
;
; XREFS:
;     <a href="#MAYBE_UNUSED_FUN_PRG15_MIRROR__cb1f">MAYBE_UNUSED_FUN_PRG15_MIRROR__cb1f</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__cb3f" href="#FUN_PRG15_MIRROR__cb3f" class="la">FUN_PRG15_MIRROR__cb3f:</a><span class="ce">; [$cb3f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_Something_PauseUpdates">PPU_Something_PauseUpdates</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Something_FrameAltToggle">Something_FrameAltToggle</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document GameLoop_Maybe_SetupDrawState
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__8b71">FUN_PRG12__8b71</a>
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;     <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;============================================================================
</div><span class="l"><a name="GameLoop_Maybe_SetupDrawState" href="#GameLoop_Maybe_SetupDrawState" class="la">GameLoop_Maybe_SetupDrawState:</a><span class="ce">; [$cb47]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_Something_PauseUpdates">PPU_Something_PauseUpdates</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Something_FrameAltToggle">Something_FrameAltToggle</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Something_FrameAltToggleWithPausePPU
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#SplashAnimation_RunOutro">SplashAnimation_RunOutro</a>
;     <a href="#FUN_PRG15_MIRROR__cb27">FUN_PRG15_MIRROR__cb27</a>
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;============================================================================
</div><span class="l"><a name="Something_FrameAltToggleWithPausePPU" href="#Something_FrameAltToggleWithPausePPU" class="la">Something_FrameAltToggleWithPausePPU:</a><span class="ce">; [$cb4f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; A = 0xFF</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_Something_PauseUpdates">PPU_Something_PauseUpdates</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Something_FrameAltToggle
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__cb3f">FUN_PRG15_MIRROR__cb3f</a>
;     <a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a>
;============================================================================
</div><span class="l"><a name="Something_FrameAltToggle" href="#Something_FrameAltToggle" class="la">Something_FrameAltToggle:</a><span class="ce">; [$cb53]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span><span class="ce">; <a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a> = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Unused_0034">Maybe_Unused_0034</a></span></span><span class="ce">; <a href="RAM.html#Maybe_Unused_0034">Maybe_Unused_0034</a> = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Unused_0035">Maybe_Unused_0035</a></span></span><span class="ce">; <a href="RAM.html#Maybe_Unused_0035">Maybe_Unused_0035</a> = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Unused_0038">Maybe_Unused_0038</a></span></span><span class="ce">; <a href="RAM.html#Maybe_Unused_0038">Maybe_Unused_0038</a> = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Unused_0037">Maybe_Unused_0037</a></span></span><span class="ce">; <a href="RAM.html#Maybe_Unused_0037">Maybe_Unused_0037</a> = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Something_Sprites_ResetAtFrame">Something_Sprites_ResetAtFrame</a></span></span><span class="ce">; <a href="RAM.html#Something_Sprites_ResetAtFrame">Something_Sprites_ResetAtFrame</a> = 0</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span><span class="ce">; BYTE_0025 = 0</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_Something_PauseUpdates">PPU_Something_PauseUpdates</a></span></span><span class="ce">; Load our byte from before.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__cb82">@LAB_PRG15_MIRROR__cb82</a></span></span><span class="ce">; If 0xFF, then jump.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cb96,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#BYTE_0700">BYTE_0700</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$7f</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DAT_0701">DAT_0701</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$23</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DAT_0702">DAT_0702</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cb98,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DAT_0703">DAT_0703</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$04</span></span><span class="ce">; Y = 4 (loop counter).</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__cb82" href="#@LAB_PRG15_MIRROR__cb82" class="lla">@LAB_PRG15_MIRROR__cb82:</a><span class="ce">; [$cb82]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f0</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__cb84" href="#@LAB_PRG15_MIRROR__cb84" class="lla">@LAB_PRG15_MIRROR__cb84:</a><span class="ce">; [$cb84]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y += 4</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__cb84">@LAB_PRG15_MIRROR__cb84</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Flip bit 7.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_FrameAltToggleFlags">Maybe_FrameAltToggleFlags</a></span></span><span class="ce">; Load the frame flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$80</span></span><span class="ce">; Discard all but bit 7.</span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o">#$80</span></span><span class="ce">; Flip bit 7.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_FrameAltToggleFlags">Maybe_FrameAltToggleFlags</a></span></span><span class="ce">; Store the flags.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$17</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$48</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Request a reset of the OAM and wait for the next interrupt.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>:
;         Set to 1 to request a reset.
;
; CALLS:
;     <a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a>
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__f24d">FUN_PRG15_MIRROR__f24d</a>
;     <a href="#IScripts_ClearPortrait">IScripts_ClearPortrait</a>
;============================================================================
</div><span class="l"><a name="Game_WaitForOAMReset" href="#Game_WaitForOAMReset" class="la">Game_WaitForOAMReset:</a><span class="ce">; [$cb9a]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_waitForInterruptLoop" href="#@_waitForInterruptLoop" class="lla">@_waitForInterruptLoop:</a><span class="ce">; [$cba3]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_waitForInterruptLoop">@_waitForInterruptLoop</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Wait3969Cycles
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a name="Wait3969Cycles" href="#Wait3969Cycles" class="la">Wait3969Cycles:</a><span class="ce">; [$cba8]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$84</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$cbac]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0700,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,Y</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Initialize the MMC1 chip and switch to bank 14.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Set to 0.
;
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         Set to bank 14.
;
;     <a href="RAM.html#SavedROMBank">SavedROMBank</a>:
;         Set to bank 14.
;
; CALLS:
;     <a href="#MMC1_Init">MMC1_Init</a>
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;
; XREFS:
;     <a href="#Game_Init">Game_Init</a>
;============================================================================
</div><span class="l"><a name="Game_InitMMCAndBank" href="#Game_InitMMCAndBank" class="la">Game_InitMMCAndBank:</a><span class="ce">; [$cbbf]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_Init">MMC1_Init</a></span></span><span class="ce">; Initialize the MMC1 chipset.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Set the previous and current ROM banks to 14.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#SavedROMBank">SavedROMBank</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Initialize the MMC1 chip.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; XREFS:
;     <a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a>
;============================================================================
</div><span class="l"><a name="MMC1_Init" href="#MMC1_Init" class="la">MMC1_Init:</a><span class="ce">; [$cbd0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0e</span></span><span class="ce">; Horizontal Mirroring
Regular Mirroring
Swap ROM bank at 0x8000
Swap 8K of VROM at PPU 0x0000
Don't reset</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span><span class="ce">; VROM_SIZE_SELECT</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x0000
Switch 4KB only
Don't reset</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span><span class="ce">; VROM_PAGE_SELECT_1</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x1000
Switch 4KB only
Don't reset</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Save the current ROM bank and switch to a new one.
;
; INPUTS:
;     X:
;         The new bank to switch to.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         The new ROM bank.
;
;     <a href="RAM.html#SavedROMBank">SavedROMBank</a>:
;         The previously-saved ROM bank.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag used to manage/reinitialize MMC1 state.
;
; XREFS:
;     <a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a>
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a name="MMC1_SavePRGBankAndUpdateTo" href="#MMC1_SavePRGBankAndUpdateTo" class="la">MMC1_SavePRGBankAndUpdateTo:</a><span class="ce">; [$cc15]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Get the currently-loaded ROM bank</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#SavedROMBank">SavedROMBank</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Switch the active PRG ROM bank.
;
; INPUTS:
;     X:
;         The new bank to switch to.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         The new ROM bank.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag used to manage/reinitialize MMC1 state.
;
; XREFS:
;     <a href="#Area_LoadBlockProperties">Area_LoadBlockProperties</a>
;     <a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a>
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#FUN_PRG15_MIRROR__ce80">FUN_PRG15_MIRROR__ce80</a>
;     <a href="#FUN_PRG15_MIRROR__ee93">FUN_PRG15_MIRROR__ee93</a>
;     <a href="#FUN_PRG15_MIRROR__eea9">FUN_PRG15_MIRROR__eea9</a>
;     <a href="#FUN_PRG15_MIRROR__eebf">FUN_PRG15_MIRROR__eebf</a>
;     <a href="#FUN_PRG15_MIRROR__f01b">FUN_PRG15_MIRROR__f01b</a>
;     <a href="#FUN_PRG15_MIRROR__f039">FUN_PRG15_MIRROR__f039</a>
;     <a href="#FUN_PRG15_MIRROR__f2e3">FUN_PRG15_MIRROR__f2e3</a>
;     <a href="#FUN_PRG15_MIRROR__f316">FUN_PRG15_MIRROR__f316</a>
;     <a href="#FUN_PRG15_MIRROR__f7b7">FUN_PRG15_MIRROR__f7b7</a>
;     <a href="#FUN_PRG15_MIRROR__fbaf">FUN_PRG15_MIRROR__fbaf</a>
;     <a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a>
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;     <a href="#Game_LoadAreaTable">Game_LoadAreaTable</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#LoadPalette2">LoadPalette2</a>
;     <a href="#LoadPalette">LoadPalette</a>
;     <a href="#LookupSpriteDataPointer">LookupSpriteDataPointer</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;     <a href="#Maybe_Player_LoadArmorSprite">Maybe_Player_LoadArmorSprite</a>
;     <a href="#Maybe_Player_LoadShieldSprite">Maybe_Player_LoadShieldSprite</a>
;     <a href="#Maybe_Player_LoadWeaponSprite">Maybe_Player_LoadWeaponSprite</a>
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;     <a href="#Maybe_Screen_Scroll_D2A6">Maybe_Screen_Scroll_D2A6</a>
;     <a href="#Messages_Load">Messages_Load</a>
;     <a href="#PPU_LoadGlyphsForStrings">PPU_LoadGlyphsForStrings</a>
;     <a href="#PPU_WriteTilesFromCHRRAM">PPU_WriteTilesFromCHRRAM</a>
;     <a href="#Palette_PopulateData">Palette_PopulateData</a>
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a>
;     <a href="#Sprite_Maybe_SetAppearanceAddrFromOffset">Sprite_Maybe_SetAppearanceAddrFromOffset</a>
;     <a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a>
;     <a href="#TextBox_Maybe_GetPaletteBehindTextbox">TextBox_Maybe_GetPaletteBehindTextbox</a>
;     <a href="#TextBox_Maybe_ShowNextCharFromBank">TextBox_Maybe_ShowNextCharFromBank</a>
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;     <a href="#TextBox_ShowNextChar">TextBox_ShowNextChar</a>
;============================================================================
</div><span class="l"><a name="MMC1_UpdatePRGBank" href="#MMC1_UpdatePRGBank" class="la">MMC1_UpdatePRGBank:</a><span class="ce">; [$cc1a]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Set the bank we're switching to.</span></span>
<span class="l"></span>
<span class="l"><a name="@_setupMMC1" href="#@_setupMMC1" class="lla">@_setupMMC1:</a><span class="ce">; [$cc1d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Write 5 LSBs of A to $FFFF, one bit per write (MMC1 serial protocol):
;
</div><span class="l"><span><span class="i">TXA</span></span><span class="ce">; ROM_PAGE_SELECT parameter in X</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"></span>
<div class="c">;
; Check the MMC1 synchronization state.
;
; If 0, this will re-initialize the MMC1 and switch banks.
;
; If 1, the interrupt handler is already switching banks.
; This can then return.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_finish">@_finish</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Slow path. Re-initialize the MMC1.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span><span class="ce">; Reset the MMC1 shifter/controler.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0e</span></span><span class="ce">; Horizontal Mirroring
Regular Mirroring
Swap ROM bank at 0x8000
Swap 8K of VROM at PPU 0x000
Don't reset</span></span>
<span class="l"></span>
<div class="c">;
; Set the CHR banking mode.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 0 = 0.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x000
Switch 4K only
Don't reset</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 1 = 0.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x1000
Switch 4K only
Don't reset</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_setupMMC1">@_setupMMC1</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_finish" href="#@_finish" class="lla">@_finish:</a><span class="ce">; [$cc82]</span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Watchdog handler to ensure the correct ROM bank is set.
;
; This is called by the interrupt handler to keep the MMC1
; in a known configuration and keep the desired ROM bank
; set.
;
; If other code is in the middle of switching ROM banks,
; this will notice and perform a full MMC1 re-initialization
; before setting the bank.
;
; INPUTS:
;     X:
;         The ROM bank to ensure is set.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag indicating if a ROM bank is currently being
;         set.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         The new ROM bank.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag used to manage/reinitialize MMC1 state.
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;============================================================================
</div><span class="l"><a name="MMC1_EnsurePRG" href="#MMC1_EnsurePRG" class="la">MMC1_EnsurePRG:</a><span class="ce">; [$cc85]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if any code was in the process of switching banks.
;
; If 0, we can exit.
;
; If 1, <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a> was in the process of
; switching banks.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_fastPath">@_fastPath</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The sync state was set, so something is switching banks.
; Increment the sync state and reset the MMC1 chip.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Reset MMC1.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0e</span></span><span class="ce">; Horizontal Mirroring
Regular Mirroring
Swap ROM bank at 0x8000
Swap 8K of VROM at PPU 0x000
Don't reset</span></span>
<span class="l"></span>
<span class="l"><a name="@_setMMC1State" href="#@_setMMC1State" class="lla">@_setMMC1State:</a><span class="ce">; [$cc95]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$9fff</span></span></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 0 = 0
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$bfff</span></span></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 1 = 0.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$dfff</span></span></span>
<span class="l"></span>
<div class="c">;
; Set the bank.
;
</div><span class="l"><a name="@_fastPath" href="#@_fastPath" class="lla">@_fastPath:</a><span class="ce">; [$ccd2]</span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:#$ffff</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Restore the previously-saved ROM bank.
;
; This will switch to the bank stored in
; <a href="RAM.html#SavedROMBank">SavedROMBank</a>.
;
; INPUTS:
;     <a href="RAM.html#SavedROMBank">SavedROMBank</a>:
;         The saved ROM bank to switch back to.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;
; XREFS:
;     <a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a>
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a name="MMC1_RestorePrevPRGBank" href="#MMC1_RestorePrevPRGBank" class="la">MMC1_RestorePrevPRGBank:</a><span class="ce">; [$cce7]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#SavedROMBank">SavedROMBank</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPUBuffer_DrawCommand_RemoveVerticalLines
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc8]
;============================================================================
</div><span class="l"><a name="PPUBuffer_DrawCommand_RemoveVerticalLines" href="#PPUBuffer_DrawCommand_RemoveVerticalLines" class="la">PPUBuffer_DrawCommand_RemoveVerticalLines:</a><span class="ce">; [$ccec]</span></span>
<div class="c">;
; Read the first byte from the buffer as the phase.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Load our current PPU buffer offset into X.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the first address byte from the buffer into A.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment buffer offset (X = X + 1).</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store the upper byte (A) into a temporary variable.</span></span>
<span class="l"></span>
<div class="c">;
; Read the upper address from the buffer and set in PPUADDR.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the next byte from the buffer into A.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment buffer offset.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = lower byte.</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write the upper byte to PPUADDR.</span></span>
<span class="l"></span>
<div class="c">;
; Read the lower address from the buffer and set in PPUADDR.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Set the new offset.</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write the lower byte to PPUADDR.</span></span>
<span class="l"></span>
<div class="c">;
; Begin preparing for the loop. There will be 16 iterations.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; Set to 16 iterations in <a href="RAM.html#Temp_06">Temp_06</a>.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Read a byte from PPUDATA.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$cd0d]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_07">Temp_07</a></span></span><span class="ce">; Store X (offset) into our temp state.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Read the next byte of data.</span></span>
<span class="l"></span>
<div class="c">;
; Set the address again. The PPUDATA read advanced the offset.
;
</div><span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper byte of PPU address to Y.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set lower byte of PPU address to X.</span></span>
<span class="l"></span>
<div class="c">;
; Add the phase byte and oop index together and get the three
; least-significant bits. This will be our index into the lookup
; table.
;
</div><span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Load the loop index.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Add the phase byte to it.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Retain only the 3 least-significant bits.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; Store in X.</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"></span>
<div class="c">;
; Take the PPU data we loaded before and AND the value in the
; lookup table. This will be the replacement for the data we
; loaded.
;
</div><span class="l"><span><span class="i">AND</span> <span class="o">#$cd33,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Set as the new PPU data.</span></span>
<span class="l"></span>
<div class="c">;
; Load the offset into the buffer and increment.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_07">Temp_07</a></span></span><span class="ce">; Load the saved offset.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment by 1.</span></span>
<span class="l"></span>
<div class="c">;
; Prepare either for the next loop or for termination.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Load our next PPU data byte for the next loop.</span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Decrement our loop index by 1.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>
;
</div><span class="l"><a name="PPUBUFFER_DRAWCOMMAND_0xFA_MASKS" href="#PPUBUFFER_DRAWCOMMAND_0xFA_MASKS" class="la">PPUBUFFER_DRAWCOMMAND_0xFA_MASKS:</a><span class="ce">; [$cd33]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$fe</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$df</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$f7</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$fd</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$bf</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7f</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$fb</span></span><span class="ce">; [7]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Rotate 16 bytes of tiles right by 1 pixel.
;
; This PPUBuffer draw command will read the upper and
; lower bytes of a PPU address and then iterate over the
; next 16 bytes at that address, rotating all data right
; by 1 pixel.
;
; INPUTS:
;     {@sybmol PPUBuffer}:
;         The PPU buffer to read from.
;
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The offset within the PPU buffer to read from.
;
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The PPU address to read and write.
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The PPU data to read and write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The updated offset within the PPU buffer.
;
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The written PPU address.
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The written PPU data.
;
; TEMP VARIABLES:
;     <a href="RAM.html#Temp_06">Temp_06</a>
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc4]
;============================================================================
</div><span class="l"><a name="PPUBuffer_Command_RotateTilesRight1Pixel" href="#PPUBuffer_Command_RotateTilesRight1Pixel" class="la">PPUBuffer_Command_RotateTilesRight1Pixel:</a><span class="ce">; [$cd3b]</span></span>
<div class="c">;
; Read the first two bytes from the offset and set as
; the PPUADDR.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Load our current PPU buffer offset.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the first address byte from the buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = byte 1</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the upper byte of the PPU address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the next address byte.</span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Update the offset to skip these bytes.</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the lower byte of the PPU address.</span></span>
<span class="l"></span>
<div class="c">;
; Begin preparing for drawing.
;
; We'll draw 16 bytes from the buffer.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; Set our loop for 16 bytes.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Load byte 1 from the PPU.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$cd56]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Load a byte from the PPU.</span></span>
<span class="l"></span>
<div class="c">;
; Set the address again. The PPUDATA read advanced the offset.
;
</div><span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper byte of PPU address to Y.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set lower byte of PPU address to X.</span></span>
<span class="l"></span>
<div class="c">;
; Rotate the tile data from this address right by 1 pixel.
;
</div><span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Rotate the pixel data right by 1.</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">ROR</span> <span class="o">A</span></span><span class="ce">; OR it to the data rotated left by 7.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Store the rotated data.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment the lower byte of the PPU address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if we're at the end of the loop.
;
; If we've processed 16 entries, we're done.
;
</div><span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Decrement our loop counter.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If it's &gt; 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Reset the PPU draw offset.
;
; The row will be set to 9 and the column to 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUOffset_Col">PPUOffset_Col</a>:
;         The updated column (set to 0).
;
;     PPUOffset_Row:
;         The updated row (set to 9).
;
; XREFS:
;     <a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;============================================================================
</div><span class="l"><a name="PPUResetOffset" href="#PPUResetOffset" class="la">PPUResetOffset:</a><span class="ce">; [$cd6f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$09</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUOffset_Row">PPUOffset_Row</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUOffset_Col">PPUOffset_Col</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Look up the offset of the sprite data for a given sprite ID.
;
; This will also load the number of PPU tiles needed to draw the sprite.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a>
;============================================================================
</div><span class="l"><a name="LookupSpriteDataPointer" href="#LookupSpriteDataPointer" class="la">LookupSpriteDataPointer:</a><span class="ce">; [$cd78]</span></span>
<div class="c">;
; Save the current ROM bank to the stack.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"></span>
<div class="c">;
; Switch to the bank for the current sprite's images.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSprite_ImagesBank">CurrentSprite_ImagesBank</a></span></span><span class="ce">; Load the bank where the images for the current sprite are found</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Read the first byte of the ROM bank and store as the start of
; the lower byte of the sprite images address.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Read the second byte as the upper address, and add 0x80 to it.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8001</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Compute the starting index for the sprite based on the
; entity ID.
;
; Entities 0-55 are in the first sprite bank. 56+
; are in the second.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the current sprite ID</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$37</span></span><span class="ce">; Each bank has 0x37 sprites.

Check if we're on the next bank.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_loadImages">@_loadImages</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$37</span></span><span class="ce">; We are, so subtract 0x37 for the new sprite ID.</span></span>
<span class="l"></span>
<div class="c">;
; Compute the address for the sprite image.
;
</div><span class="l"><a name="@_loadImages" href="#@_loadImages" class="lla">@_loadImages:</a><span class="ce">; [$cd98]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert the sprite ID to a word boundary.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Get the pointer to the sprite data from the bank address computed above.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_Image_L">CurrentSprite_Image_L</a></span></span><span class="ce">; A = Lower byte of the image data address.</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; A = Upper byte of the address.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_Image_U">CurrentSprite_Image_U</a></span></span><span class="ce">; Upper byte of pointer to the sprite bitmap</span></span>
<span class="l"></span>
<div class="c">;
; Get the PPU tile numbers for the sprite entity and store
; it for lookup.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the current sprite ID</span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ce1b,Y</span></span><span class="ce">; Get the number of tiles needed</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_PPUTileCount">CurrentSprite_PPUTileCount</a></span></span><span class="ce">; Store that for the render</span></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load all tiles required for a sprite into the PPU.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;============================================================================
</div><span class="l"><a name="Sprites_LoadImageForCurrentSprite" href="#Sprites_LoadImageForCurrentSprite" class="la">Sprites_LoadImageForCurrentSprite:</a><span class="ce">; [$cdb5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Col">PPUOffset_Col</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Row">PPUOffset_Row</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUOffset_Index">PPUOffset_Index</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LookupSpriteDataPointer">LookupSpriteDataPointer</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_PPUTileCount">CurrentSprite_PPUTileCount</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loadSpriteToPPUBuffer">@_loadSpriteToPPUBuffer</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; Transfer all PPU tiles for a sprite to the PPU buffer.
;
</div><span class="l"><a name="@_loadSpriteToPPUBuffer" href="#@_loadSpriteToPPUBuffer" class="lla">@_loadSpriteToPPUBuffer:</a><span class="ce">; [$cdd1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSprite_ImagesBank">CurrentSprite_ImagesBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Row">PPUOffset_Row</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Col">PPUOffset_Col</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Copy the sprite data for this tile to the PPU buffer.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_copySpriteImage" href="#@_copySpriteImage" class="lla">@_copySpriteImage:</a><span class="ce">; [$cdea]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentSprite_Image_L">CurrentSprite_Image_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_copySpriteImage">@_copySpriteImage</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_Image_L">CurrentSprite_Image_L</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_Image_L">CurrentSprite_Image_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_Image_U">CurrentSprite_Image_U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_Image_U">CurrentSprite_Image_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Col">PPUOffset_Col</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUOffset_Col">PPUOffset_Col</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUOffset_Row">PPUOffset_Row</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUOffset_Row">PPUOffset_Row</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#CurrentSprite_PPUTileCount">CurrentSprite_PPUTileCount</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loadSpriteToPPUBuffer">@_loadSpriteToPPUBuffer</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; The number of PPU tiles each sprite needs.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#LookupSpriteDataPointer">LookupSpriteDataPointer</a>
;
</div><span class="l"><a name="SPRITES_PPU_TILE_COUNTS" href="#SPRITES_PPU_TILE_COUNTS" class="la">SPRITES_PPU_TILE_COUNTS:</a><span class="ce">; [$ce1b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Dropped bread</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [2]: Dropped coin</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [3]: TODO: Garbled 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [4]: Enemy: Raiden</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [5]: Enemy: Necron Aides</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [6]: Enemy: Zombie</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [7]: Enemy: Hornet</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [8]: Enemy: Bihoruda</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [9]: Enemy: Lilith</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [10]: TODO: Garbled 10</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [11]: Enemy: Yuinaru</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [12]: Enemy: Snowman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [13]: Enemy: Nash</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [14]: Enemy: Fire Giant</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [15]: Enemy: Ishiisu</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [16]: Enemy: Execution Hood</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$26</span></span><span class="ce">; [17]: Boss: Rokusutahn</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [18]: Enemy: Unused #18</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]: Effect: Enemy Death</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [20]: Effect: Lightning Ball</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; [21]: Enemy: Charron</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$17</span></span><span class="ce">; [22]: Enemy: Unused 22</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [23]: Enemy: Geributa</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [24]: Enemy: Sugata</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [25]: Enemy: Grimlock</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [26]: Enemy: Giant Bees</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [27]: Enemy: Myconid</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [28]: Enemy: Naga</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [29]: Enemy: Unused #29</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [30]: Enemy: Giant Strider</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [31]: Enemy: Sir Gawaine</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1f</span></span><span class="ce">; [32]: Enemy: Maskman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; [33]: Enemy: Wolfman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [34]: Enemy: Yareeka</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [35]: Enemy: Magman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [36]: Enemy: Unused #36</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [37]: Enemy: Unused #37</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [38]: Enemy: Ikeda</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [39]: Enemy: Unused #39</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [40]: Enemy: Lamprey</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [41]: Enemy: Unused #41</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [42]: Enemy: Monodron</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [43]: Unused #43</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [44]: Enemy: Tamazutsu</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3e</span></span><span class="ce">; [45]: Boss: Ripasheiku</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [46]: Boss: Zoradohna</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1c</span></span><span class="ce">; [47]: Boss: Borabohra</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [48]: Boss: Pakukame</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$25</span></span><span class="ce">; [49]: Boss: Zorugeriru</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$54</span></span><span class="ce">; [50]: Boss: King Grieve</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$69</span></span><span class="ce">; [51]: Boss: Shadow Eura</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [52]: NPC: Walking man 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [53]: NPC: Unused Blue Lady</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [54]: NPC: Unused Child</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [55]: NPC: Armor Salesman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [56]: NPC: Martial Arts</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [57]: NPC: Priest</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [58]: NPC: King</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [59]: NPC: Magic Teacher</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [60]: NPC: Key Salesman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [61]: NPC: Smoking Man</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [62]: NPC: Man in Chair</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [63]: NPC: Sitting Man 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [64]: NPC: Meat Salesman</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [65]: NPC: Lady in blue dress with cup</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [66]: NPC: King's Guard</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [67]: NPC: Doctor</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [68]: NPC: Walking Woman 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [69]: NPC: Walking Woman 2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [70]: Enemy: Unused eyeball</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [71]: Enemy: Zozura</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [72]: Item: Glove</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [73]: Item: Black Onyx</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [74]: Item: Pendant</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [75]: Item: Red Potion</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [76]: Item: Poison</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [77]: Item: Elixir</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [78]: Item: Ointment</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [79]: Item: Intro trigger start point</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [80]: Item: Mattock</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [81]: TODO: Garbled #81</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [82]: Deco: Fountain</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [83]: TODO: Unknown #83</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [84]: TODO: Unknown #84</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [85]: Item: Wing Boots</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [86]: Item: Hour Glass</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [87]: Item: Magical Rod</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [88]: Item: Battle Suit</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [89]: Item: Battle Helmet</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [90]: Item: Dragon Slayer</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [91]: Item: Mattock #2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [92]: Item: Wing Boots (for quest)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [93]: Item: Red Potion #2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [94]: Item: Poison #2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [95]: Item: Glove #2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [96]: Item: Ointment #2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [97]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [98]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [99]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [100]: Effect: Boss Death</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__ce80
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__ce80" href="#FUN_PRG15_MIRROR__ce80" class="la">FUN_PRG15_MIRROR__ce80:</a><span class="ce">; [$ce80]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8008</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8009</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__cea4" href="#@LAB_PRG15_MIRROR__cea4" class="lla">@LAB_PRG15_MIRROR__cea4:</a><span class="ce">; [$cea4]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__cea4">@LAB_PRG15_MIRROR__cea4</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__cea4">@LAB_PRG15_MIRROR__cea4</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load tilesets from PRG ROM (bank 4) into CHR RAM.
;
; INPUTS:
;     <a href="RAM.html#TilesIndex">TilesIndex</a>:
;         The index of the tileset to load.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a name="CHR_LoadTilesetPages" href="#CHR_LoadTilesetPages" class="la">CHR_LoadTilesetPages:</a><span class="ce">; [$ceb8]</span></span>
<div class="c">;
; Load the address for the tile data based on the tiles index.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span><span class="ce">; Set A = tileset index</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Set A = tileset index * 2 (word offset)</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Set Y = word offset into the pointer table</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cf07,Y</span></span><span class="ce">; Read the low byte from the table</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesAddress">TilesAddress</a></span></span><span class="ce">; Save low byte to TilesAddress</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cf08,Y</span></span><span class="ce">; Read the high byte from the table</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesAddress">TilesAddress</a>+1</span></span><span class="ce">; Set high byte to TilesAddress</span></span>
<span class="l"></span>
<div class="c">;
; Set the PPU to increment by +1 after each PPUDATA write.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetVRAMIncrementAdd1Across">PPU_SetVRAMIncrementAdd1Across</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load and set the PPU address for the current set of
; tiles. Set the upper byte from the table and lower
; byte to 0.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cf19,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set the high byte of the PPU address (0x18 or 0x1A)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set the low byte (0x00 -- start of page)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Set the low byte of the remaining page count to 0</span></span>
<span class="l"></span>
<div class="c">;
; Set the 16-bit total byte count to (CHRPageCount &lt;&lt; 8) | 0.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$cf22,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and switch to bank 4 (tile data).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 4 (tile data)</span></span>
<span class="l"></span>
<div class="c">;
; Begin loading tiles into PPUDATA.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Set Y = 0 (start page of loop)</span></span>
<span class="l"></span>
<div class="c">;
; Stream 1 byte from PRG to PPU.
;
</div><span class="l"><a name="@_copyLoop" href="#@_copyLoop" class="lla">@_copyLoop:</a><span class="ce">; [$cee8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#TilesAddress">TilesAddress</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Increment our source pointer (Y++).
;
; Carries into high on wrap.
;
</div><span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_noCarry">@_noCarry</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#TilesAddress">TilesAddress</a>+1</span></span></span>
<span class="l"></span>
<div class="c">;
; Decrement the 16-bit remaining count.
;
</div><span class="l"><a name="@_noCarry" href="#@_noCarry" class="lla">@_noCarry:</a><span class="ce">; [$cef2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Low--</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; High -= borrow</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_copyLoop">@_copyLoop</a></span></span><span class="ce">; Keep going until the total reaches 0</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"></span>
<div class="c">;
; Switch back to our previous bank.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Offsets of the tiles in the bank
;
; Index into the table are based on <a href="RAM.html#TilesIndex">TilesIndex</a>.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;
</div><span class="l"><a name="TILE_INDEX_TO_ADDR" href="#TILE_INDEX_TO_ADDR" class="la">TILE_INDEX_TO_ADDR:</a><span class="ce">; [$cf07]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$8000</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$9800</span></span><span class="ce">; [1]: Tree world</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$8800</span></span><span class="ce">; [2]: Between first town and Fog</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$9000</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$b800</span></span><span class="ce">; [4]: Last World, Final Maze</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$a000</span></span><span class="ce">; [5]: Town</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$a800</span></span><span class="ce">; [6]: Building</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ae00</span></span><span class="ce">; [7]: ?</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$b400</span></span><span class="ce">; [8]: ?</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Which parts of the PPU tiles are loaded.
;
; Index into the table are based on <a href="RAM.html#TilesIndex">TilesIndex</a>.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;
</div><span class="l"><a name="TILE_INDEX_TO_PPU_ADDR_UPPER" href="#TILE_INDEX_TO_PPU_ADDR_UPPER" class="la">TILE_INDEX_TO_PPU_ADDR_UPPER:</a><span class="ce">; [$cf19]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [0]: 0x1800 - First Town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [1]: 0x1800 - Tree World</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [2]: 0x1800 - Between first town and fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [3]: 0x1800 - Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [4]: 0x1800 - Last world, final maze</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [5]: 0x1800 - Town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; [6]: 0x1A00 - Building</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; [7]: 0x1A00 - ?</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; [8]: 0x1A00 - ?</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; The number of CHR pages to load for a tiles index.
;
; Index into the table are based on <a href="RAM.html#TilesIndex">TilesIndex</a>.
;
; The results are further translated as:
;
;     8 == 0x80
;     6 == 0x60
;     4 == 0x40
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;
</div><span class="l"><a name="TILE_INDEX_TO_NUM_CHR_PAGES" href="#TILE_INDEX_TO_NUM_CHR_PAGES" class="la">TILE_INDEX_TO_NUM_CHR_PAGES:</a><span class="ce">; [$cf22]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]: Tree world</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]: Between first town and fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [4]: Last world, final maze</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [5]: Town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [6]: Building</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [7]: ?</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [8]: ?</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the VRAM address increment per CPU read/write of PPUDATA to 0: Add 1,
; going across.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;============================================================================
</div><span class="l"><a name="PPU_SetVRAMIncrementAdd1Across" href="#PPU_SetVRAMIncrementAdd1Across" class="la">PPU_SetVRAMIncrementAdd1Across:</a><span class="ce">; [$cf2b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fb</span></span><span class="ce">; Set VRAM address increment per CPU read/write of PPUDATA to 0: Add 1, going across.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span><span class="ce">; Set it to SavedPPUCtrl.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Set it to PPUCTRL.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear the PPU buffer.
;
; Both the offset and upper bounds will be reset back to 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The offset to clear.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The upper bounds value to clear.
;============================================================================
</div><span class="l"><a name="PPUBuffer_Clear" href="#PPUBuffer_Clear" class="la">PPUBuffer_Clear:</a><span class="ce">; [$cf35]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Set offset = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Set upper bounds = 0</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
</div><span class="l"><a name="RETURN_CF3B" href="#RETURN_CF3B" class="la">RETURN_CF3B:</a><span class="ce">; [$cf3b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [$cf3b] undefined</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw from the PPU buffer to the PPU.
;
; This will take the entries in the current buffer and draw
; them to the PPU. Buffer entries may contain a command
; opcode, or it may contain values to write.
;
; Let's look into the two methods for drawing.
;
; 1. Command control
;
;    If the first byte to process in the buffer is a value
;    decreasing from 0x00 to 0xFA, it will be treated as a
;    command, and the entry in
;    <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a> will
;    process the remaining bytes (or just return).
;
;    The following commands are supported:
;
;    0x00: Write palette data
;
;          <a href="#PPUBuffer_DrawCommand_WritePalette">PPUBuffer_DrawCommand_WritePalette</a>
;
;    0xFC: Rotate 16 pixels of tiles right by 1 pixel at
;          a given address (at the next two bytes from
;          the buffer).
;
;          <a href="#PPUBuffer_Command_RotateTilesRight1Pixel">PPUBuffer_Command_RotateTilesRight1Pixel</a>
;
;    0xFA: TODO
;    <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>
;
;    Commands 0xFF, 0xFE, 0xFD, and 0xFB just return.
;
;    Once a command is processed, the operation is complete.
;    Further entries in the buffer will be processed in
;    future calls.
;
; 2. Data drawing
;
;    The first byte at the buffer offset will contain a
;    value with a PPUCTRL flag in bit 7 and the number of
;    bytes to write in the remaining bit.
;
;    The second and third contain the upper and lower bytes
;    of PPUADDR (respectively).
;
;    Additional bytes are the &lt;length&gt; bytes to write.
;
;    Drawing finishes after any of the following conditions
;    are met:
;
;    1. The buffer is empty.
;    2. 6 entries from the buffer have been drawn.
;    3. A maximum number of bytes have been written
;       (48 bytes).
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer to process.
;
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The offset within the PPU buffer to process.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The upper bounds within the PPU buffer to process.
;
; OUTPUTS:
;     <a href="RAM.html#PPUCTRL">PPUCTRL</a>:
;         PPU control flags.
;
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         PPU write address (reset back to 0).
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         PPU draw data.
;
; TEMP VARIABLES:
;     <a href="RAM.html#PPUBuffer_Temp_PendingEntryCount">PPUBuffer_Temp_PendingEntryCount</a>:
;         The maximum number of entries remaining to
;         process.
;
;     <a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a>:
;         The total number of bytes processed.
;
; CALLS:
;     <a href="#PPUBuffer_DrawCommand_WritePalette">PPUBuffer_DrawCommand_WritePalette</a>
;     <a href="#PPUBuffer_Command_RotateTilesRight1Pixel">PPUBuffer_Command_RotateTilesRight1Pixel</a>
;     <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a>
;     <a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_Draw" href="#PPUBuffer_Draw" class="la">PPUBuffer_Draw:</a><span class="ce">; [$cf3c]</span></span>
<div class="c">;
; Check if there's anything in the buffer to write.
; If not, we're done.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; A = current buffer offset</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Compare against the upper bound of the PPU buffer.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_CF3B">RETURN_CF3B</a></span></span><span class="ce">; If they're the same, we have nothing to write. We're done.</span></span>
<span class="l"></span>
<div class="c">;
; Check the value in the offset and see if it appears to
; be a command opcode of some sort (an index into
; <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; X = current PPU offset</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Take a value from $00 to $FA (decreasing) and turn it
into an index.

$00 = 0
$FF = 1
$FE = 2
$FD = 3
$FC = 4
$FB = 5
$FA = 6</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Get the value from the buffer at this offset.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Check if it's a command code.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_beginDraw">@_beginDraw</a></span></span><span class="ce">; If not, draw normally.</span></span>
<span class="l"></span>
<div class="c">;
; It is a command code. Increment to the next byte, look up
; the entry for the command in our table, and call it.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Consume the byte in the buffer.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Begin looking up in the table.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cfbd,Y</span></span><span class="ce">; High byte of the address.</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$cfbc,Y</span></span><span class="ce">; Low byte of the address.</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_beginDraw" href="#@_beginDraw" class="lla">@_beginDraw:</a><span class="ce">; [$cf5b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_PendingEntryCount">PPUBuffer_Temp_PendingEntryCount</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Loop through the buffer until either it's cleared or we've
; processed 6 entries.
;
</div><span class="l"><a name="@_loopBuffer" href="#@_loopBuffer" class="lla">@_loopBuffer:</a><span class="ce">; [$cf63]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Compute the PPUCTRL to set for this series of writes.
;
; If the most-significant bit is set, we'll set it to
; Add32 Down mode. Otherwise, we'll set it to Add1 Across
; mode.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_processData">@_processData</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_processData" href="#@_processData" class="lla">@_processData:</a><span class="ce">; [$cf79]</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load the first byte from the buffer at our offset.
; Mask out bit 7 (our flag above). This will be our
; data length counter.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; A = value from the buffer</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Mask out control bit 7.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A (save until we load the address)</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Set to the next byte.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the upper PPU byte address from the buffer.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the upper byte in PPUADDR.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the lower PPU byte address from the buffer.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the lower byte in PPUADDR.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; Y = A (restore from above)</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span><span class="ce">; Add the length to our running total.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Begin writing &lt;length&gt; bytes from the buffer to the PPU.
;
</div><span class="l"><a name="@_loopData" href="#@_loopData" class="lla">@_loopData:</a><span class="ce">; [$cf97]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the byte to draw at our current offset.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Set the byte in our PPUDATA.</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Decrement the nuber of bytes to write.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loopData">@_loopData</a></span></span><span class="ce">; If we're not done yet, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're done writing the data bytes. We can now update the
; offset and check whether to move on to the next, or if
; we're done with the buffer for now.
;
; We're done with the buffer if we've hit 6 entries, maxed
; out our byte length counter, or hit a new command opcode.
;
</div><span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Increment our offset into the buffer to skip the length
and address bytes and all the data bytes.</span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_PendingEntryCount">PPUBuffer_Temp_PendingEntryCount</a></span></span><span class="ce">; Decrement our total allowed entries for this operation.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span><span class="ce">; If we can't do any more, we're done.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the next byte to process from the buffer.</span></span>
<span class="l"><span><span class="i">DEY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$f9</span></span><span class="ce">; Check if it's a command byte.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span><span class="ce">; If it is, we're done. This will be handled next call.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span><span class="ce">; Check the total byte length.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_loopBuffer">@_loopBuffer</a></span></span><span class="ce">; If there's room to go, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're done with everything. Clear out the PPU addresses and
; return.
;
</div><span class="l"><a name="@_finishLoop" href="#@_finishLoop" class="lla">@_finishLoop:</a><span class="ce">; [$cfb3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper PPUADDR to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set lower PPUADDR to 0.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; No-op draw command.
;
; This is just used as a destination for the draw commands
; lookup table below. It's also the end of the function.
; above.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfbe]
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc0]
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc2]
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc6]
;============================================================================
</div><span class="l"><a name="PPUBuffer_DrawCommand_Noop" href="#PPUBuffer_DrawCommand_Noop" class="la">PPUBuffer_DrawCommand_Noop:</a><span class="ce">; [$cfbb]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handlers for special PPU buffer draw commands.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
</div><span class="l"><a name="PPUBUFFER_DRAW_COMMANDS" href="#PPUBUFFER_DRAW_COMMANDS" class="la">PPUBUFFER_DRAW_COMMANDS:</a><span class="ce">; [$cfbc]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_WritePalette">PPUBuffer_DrawCommand_WritePalette</a>-1</span></span><span class="ce">; [0]: Command 0x00</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [1]: Command 0xFF</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [2]: Command 0xFE</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [3]: Command 0xFD</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_Command_RotateTilesRight1Pixel">PPUBuffer_Command_RotateTilesRight1Pixel</a>-1</span></span><span class="ce">; [4]: Command 0xFC</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [5]: Command 0xFB</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>-1</span></span><span class="ce">; [6]: Command 0xFA</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPUBuffer_WaitForSomething
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_WaitForSomething">PPUBuffer_WaitForSomething</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_WaitForSomething" href="#PPUBuffer_WaitForSomething" class="la">PPUBuffer_WaitForSomething:</a><span class="ce">; [$cfca]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_SomethingCompareTo24">PPUBuffer_SomethingCompareTo24</a></span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#PPUBuffer_WaitForSomething">PPUBuffer_WaitForSomething</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPUBuffer_SomethingCompareTo24
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     C
;
; XREFS:
;     <a href="#PPUBuffer_WaitForSomething">PPUBuffer_WaitForSomething</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_SomethingCompareTo24" href="#PPUBuffer_SomethingCompareTo24" class="la">PPUBuffer_SomethingCompareTo24:</a><span class="ce">; [$cfd0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; A = PPU buffer offset.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Subtract the upper bounds.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's 0, return.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$24</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$cfd9]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09,$80</span></span><span class="ce">; [$cfda] word</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPUBuffer_QueueCommandOrLength
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__9041">FUN_PRG12__9041</a>
;     <a href="PRG12.html#FUN_PRG12__92ed">FUN_PRG12__92ed</a>
;     <a href="PRG12.html#IScriptAction_AddItem_Something8EC1">IScriptAction_AddItem_Something8EC1</a>
;     <a href="PRG12.html#Maybe_DrawItemName">Maybe_DrawItemName</a>
;     <a href="PRG12.html#Maybe_Draw_Textbox">Maybe_Draw_Textbox</a>
;     <a href="PRG12.html#Maybe_Draw_Textbox_Something8F51">Maybe_Draw_Textbox_Something8F51</a>
;     <a href="PRG12.html#PasswrodScreen_DrawMessage">PasswrodScreen_DrawMessage</a>
;     <a href="PRG12.html#Strings_Draw">Strings_Draw</a>
;     <a href="#Area_WriteTwoBlocksFromData12ToPPUBuffer">Area_WriteTwoBlocksFromData12ToPPUBuffer</a>
;     <a href="#Area_WriteTwoBlocksFromData34ToPPUBuffer">Area_WriteTwoBlocksFromData34ToPPUBuffer</a>
;     <a href="#FUN_PRG15_MIRROR__c033">FUN_PRG15_MIRROR__c033</a>
;     <a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a>
;     <a href="#FUN_PRG15_MIRROR__eebf">FUN_PRG15_MIRROR__eebf</a>
;     <a href="#FUN_PRG15_MIRROR__f316">FUN_PRG15_MIRROR__f316</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;     <a href="#TextBox_FillPlaceholderTextAtLineWithStartChar">TextBox_FillPlaceholderTextAtLineWithStartChar</a>
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;     <a href="#TextBox_QueueRightCoordInPPUBuffer">TextBox_QueueRightCoordInPPUBuffer</a>
;     <a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a>
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_QueueCommandOrLength" href="#PPUBuffer_QueueCommandOrLength" class="la">PPUBuffer_QueueCommandOrLength:</a><span class="ce">; [$cfdc]</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WaitForSomething">PPUBuffer_WaitForSomething</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Load the upper bounds of the buffer.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store the provided value (A) there.</span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Load the upper address byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write it to the buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Load the lower address byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write it to the buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Wait until the PPU buffer is clear.
;
; This will continuously loop until the PPU buffer's
; offset and upper bounds match.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The offset to compare.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The upper bounds to compare.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_WaitUntilClear" href="#PPUBuffer_WaitUntilClear" class="la">PPUBuffer_WaitUntilClear:</a><span class="ce">; [$cff4]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Load the upper bounds of the buffer.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Does it == the offset?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Invoke all draws on the PPU buffer until it's cleared.
;
; This will continuously run <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a> until
; the
; draw buffer has been cleared.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a>:
;         The offset to compare.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The upper bounds to compare.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
; XREFS:
;     <a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_DrawAll" href="#PPUBuffer_DrawAll" class="la">PPUBuffer_DrawAll:</a><span class="ce">; [$cffb]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span><span class="ce">; Draw from the buffer.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Load the upper bounds.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span><span class="ce">; Does it match the offset?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d005
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d005" href="#FUN_PRG15_MIRROR__d005" class="la">FUN_PRG15_MIRROR__d005:</a><span class="ce">; [$d005]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LoadPalette2">LoadPalette2</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d00d
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d00d" href="#FUN_PRG15_MIRROR__d00d" class="la">FUN_PRG15_MIRROR__d00d:</a><span class="ce">; [$d00d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LoadPalette2">LoadPalette2</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPUBuffer_DrawCommand_WritePalette
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfbc]
;============================================================================
</div><span class="l"><a name="PPUBuffer_DrawCommand_WritePalette" href="#PPUBuffer_DrawCommand_WritePalette" class="la">PPUBuffer_DrawCommand_WritePalette:</a><span class="ce">; [$d016]</span></span>
<div class="c">;
; Write all 32 palettes to 0x3F00.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$3f</span></span><span class="ce">; Write the the upper byte of the address</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; Write the the lower byte of the address</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$20</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_nextPalette" href="#@_nextPalette" class="lla">@_nextPalette:</a><span class="ce">; [$d022]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentPaletteData">CurrentPaletteData</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">DEY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_nextPalette">@_nextPalette</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Avoid palette corruption by setting to address 0x3F00,
; and then zeroing out (0x0000).
;
; See https://www.nesdev.org/wiki/PPU_registers#Palette_corruption
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$3f</span></span><span class="ce">; Write the the upper byte of the address</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write the the lower byte of the address</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Now zero out</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document LoadPalette2
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#FUN_PRG15_MIRROR__d005">FUN_PRG15_MIRROR__d005</a>
;     <a href="#FUN_PRG15_MIRROR__d00d">FUN_PRG15_MIRROR__d00d</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;============================================================================
</div><span class="l"><a name="LoadPalette2" href="#LoadPalette2" class="la">LoadPalette2:</a><span class="ce">; [$d03b]</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and load bank 11 (palette data).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<div class="c">;
; Set the attribute data index for the HUD.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$81f0,Y</span></span><span class="ce">; Load the HUD attribute data for this index.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#HUD_AttributeDataIndex">HUD_AttributeDataIndex</a></span></span><span class="ce">; Set it for the HUD.</span></span>
<span class="l"></span>
<div class="c">;
; Restore our current bank.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A (previous bank) from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch back to the bank.</span></span>
<span class="l"></span>
<div class="c">;
; Get the offset into the bank.
;
</div><span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Palette_PopulateData">Palette_PopulateData</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load a 16-byte palette and copy into RAM.
;
; This will load the palette from PRG bank #11, copying
; into the RAM palette buffer.
;
; A ROM address in bank #11 will be calculated as:
;
;     PaletteAddr = 0x81C0 + (paletteIndex * 16)
;
; Then 16 bytes will be copied from PaletteAddr into the
; RAM palette buffer at ${@address 0x0293}..${@address 0x02B2} (entries
; 16-31).
;
; INPUTS:
;     A:
;         The palette index to load.
;
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         The high/low address for the palette pointer.
;
;         These will be overwritten.
;
; OUTPUTS:
;     RAM ${@address 0x0293}..${@address 0x02B2}:
;         The loaded 16-byte palette.
;
;     <a href="RAM.html#Palette_CurrentIndex">Palette_CurrentIndex</a>:
;         The new palette index.
;
;     A, X, Y, processor flags:
;         Clobbered/undefined on return.
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#FUN_PRG15_MIRROR__f24d">FUN_PRG15_MIRROR__f24d</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#IScripts_ClearPortrait">IScripts_ClearPortrait</a>
;     <a href="#Screen_Load">Screen_Load</a>
;============================================================================
</div><span class="l"><a name="Palette_LoadFromIndex" href="#Palette_LoadFromIndex" class="la">Palette_LoadFromIndex:</a><span class="ce">; [$d062]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Palette_CurrentIndex">Palette_CurrentIndex</a></span></span><span class="ce">; Store the selected palette index</span></span>
<span class="l"></span>
<div class="c">;
; Compute the ROM address for this palette.
;
; This should be 0x81C0 + palette offset.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$81</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Save the previous bank and switch to bank 11 (palette data).
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$1f</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Populate palette data for the screen.
;
; This will load the palette data from the data stored
; in bank 11 at the address stored in <a href="RAM.html#Temp_08">Temp_08</a> and
; populate <a href="RAM.html#CurrentPaletteData">CurrentPaletteData</a>.
;
; INPUTS:
;     Y:
;         The index into the data to load.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;         The address to load data from in bank 11.
;
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentPaletteData">CurrentPaletteData</a>:
;         The resulting palette data.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;
; XREFS:
;     <a href="#LoadPalette2">LoadPalette2</a>
;============================================================================
</div><span class="l"><a name="Palette_PopulateData" href="#Palette_PopulateData" class="la">Palette_PopulateData:</a><span class="ce">; [$d074]</span></span>
<div class="c">;
; Save the current bank.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<div class="c">;
; Copy 16 bytes into ROM.
;
</div><span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y (palette data index)</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$0f</span></span><span class="ce">; Y = 15 (loop counter)</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$d081]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Load the byte to copy.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentPaletteData">CurrentPaletteData</a>,X</span></span><span class="ce">; Store as the palette data at the index.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Switch bank to the previous bank.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the previous bank.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Append a 0 value to the PPU buffer.
;
; The end of the buffer will contain a 0, and the buffer
; size will grow.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The upper bounds of the buffer.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer to append to.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The new size of the buffer.
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_DrawScenery">SplashAnimation_DrawScenery</a>
;     <a href="PRG12.html#SplashAnimation_SomethingA708">SplashAnimation_SomethingA708</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#FUN_PRG15_MIRROR__d005">FUN_PRG15_MIRROR__d005</a>
;     <a href="#FUN_PRG15_MIRROR__d00d">FUN_PRG15_MIRROR__d00d</a>
;     <a href="#FUN_PRG15_MIRROR__f24d">FUN_PRG15_MIRROR__f24d</a>
;     <a href="#IScripts_ClearPortrait">IScripts_ClearPortrait</a>
;     <a href="#LoadPalette">LoadPalette</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_SetupSprites">Screen_SetupSprites</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_Append0" href="#PPUBuffer_Append0" class="la">PPUBuffer_Append0:</a><span class="ce">; [$d090]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; X = upper bounds of the buffer</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store the 0 in the buffer at the upper bounds.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment the upper bounds.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return a 16-bit offset for a value.
;
; This multiplies the provided index by 16 and splits the
; 16-bit result into a low byte (A) and a high byte
; (<a href="RAM.html#Temp_09">Temp_09</a>).
;
; Carry is cleared on exit so the caller can 16-bit add a
; base address with ADC (low) / ADC (high) cleanly.
;
; This is used by palette code to build a ROM pointer in
; the form of:
;
;     PaletteAddr = Base + (index * 16)
;
; INPUTS:
;     A:
;         The index to convert to a 16-byte offset.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         The high byte (index * 16)
;
;     A:
;         The low byte (index * 16)
;
;     C (Carry):
;         Cleared (0) for subsequent 16-bit ADC adds.
;
;     Y:
;         Set to 0 (clobbered).
;
; XREFS:
;     <a href="#LoadPalette2">LoadPalette2</a>
;     <a href="#LoadPalette">LoadPalette</a>
;     <a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a>
;============================================================================
</div><span class="l"><a name="Palette_IndexToROMOffset16" href="#Palette_IndexToROMOffset16" class="la">Palette_IndexToROMOffset16:</a><span class="ce">; [$d09b]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document LoadPalette
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_NextTransitionState">Screen_NextTransitionState</a>
;============================================================================
</div><span class="l"><a name="LoadPalette" href="#LoadPalette" class="la">LoadPalette:</a><span class="ce">; [$d0ad]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$0f</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$d0c8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$d0e0,X</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d0d2">@LAB_PRG15_MIRROR__d0d2</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0f</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d0d2" href="#@LAB_PRG15_MIRROR__d0d2" class="lla">@LAB_PRG15_MIRROR__d0d2:</a><span class="ce">; [$d0d2]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentPaletteData">CurrentPaletteData</a>,Y</span></span></span>
<span class="l"><span><span class="i">DEY</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#LoadPalette">LoadPalette</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d0e0" href="#BYTE_ARRAY_PRG15_MIRROR__d0e0" class="la">BYTE_ARRAY_PRG15_MIRROR__d0e0:</a><span class="ce">; [$d0e0]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$40</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Play a sound effect.
;
; INPUTS:
;     A:
;         The sound ID to play.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_SoundIDToPlay">Temp_SoundIDToPlay</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#PlaySoundInner">PlaySoundInner</a>
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__8b71">FUN_PRG12__8b71</a>
;     <a href="PRG12.html#FUN_PRG12__8bce">FUN_PRG12__8bce</a>
;     <a href="PRG12.html#FUN_PRG12__8be5">FUN_PRG12__8be5</a>
;     <a href="PRG12.html#FUN_PRG12__906d">FUN_PRG12__906d</a>
;     <a href="PRG12.html#IScripts_PlayFillingSound">IScripts_PlayFillingSound</a>
;     <a href="PRG12.html#IScripts_PlayGoldChangeSound">IScripts_PlayGoldChangeSound</a>
;     <a href="PRG12.html#Menu_Something_9405">Menu_Something_9405</a>
;     <a href="PRG12.html#Sound_PlayInputSound">Sound_PlayInputSound</a>
;     <a href="PRG12.html#Sound_PlayMoveCursorSound">Sound_PlayMoveCursorSound</a>
;     <a href="PRG12.html#SplashAnimation_Maybe_AnimPlayerStep">SplashAnimation_Maybe_AnimPlayerStep</a>
;     <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>
;     <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>
;     <a href="PRG14.html#CastMagic_UpdateDeluge">CastMagic_UpdateDeluge</a>
;     <a href="PRG14.html#CastMagic_UpdateFire">CastMagic_UpdateFire</a>
;     <a href="PRG14.html#FUN_PRG14__87cb">FUN_PRG14__87cb</a>
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;     <a href="PRG14.html#Player_HandleTouchBread">Player_HandleTouchBread</a>
;     <a href="PRG14.html#Player_HandleTouchCoin">Player_HandleTouchCoin</a>
;     <a href="PRG14.html#Player_HandleTouchEnemy">Player_HandleTouchEnemy</a>
;     <a href="PRG14.html#Player_HitEnemyWithMagic">Player_HitEnemyWithMagic</a>
;     <a href="PRG14.html#Player_HitSpriteWithWeapon">Player_HitSpriteWithWeapon</a>
;     <a href="PRG14.html#SpriteBehavior__9cf2">SpriteBehavior__9cf2</a>
;     <a href="PRG14.html#SpriteBehavior__9e6d">SpriteBehavior__9e6d</a>
;     <a href="PRG14.html#SpriteBehavior__MaybeSugata">SpriteBehavior__MaybeSugata</a>
;     <a href="PRG14.html#SpriteBehavior__ab67">SpriteBehavior__ab67</a>
;     <a href="PRG14.html#Sprites_ReplaceWithCoinDrop">Sprites_ReplaceWithCoinDrop</a>
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#Game_UnlockDoor">Game_UnlockDoor</a>
;     <a href="#Maybe_Player_PickUpGlove">Maybe_Player_PickUpGlove</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_PickUpBattleHelmet">Player_PickUpBattleHelmet</a>
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a>
;     <a href="#Player_PickUpBlackOnyx">Player_PickUpBlackOnyx</a>
;     <a href="#Player_PickUpDragonSlayer">Player_PickUpDragonSlayer</a>
;     <a href="#Player_PickUpElixir">Player_PickUpElixir</a>
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMattock">Player_PickUpMattock</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;     <a href="#ScreenEvents_HandleFinalBossKilled">ScreenEvents_HandleFinalBossKilled</a>
;     <a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a>
;============================================================================
</div><span class="l"><a name="Sound_PlayEffect" href="#Sound_PlayEffect" class="la">Sound_PlayEffect:</a><span class="ce">; [$d0e4]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_SoundIDToPlay">Temp_SoundIDToPlay</a></span></span><span class="ce">; Store the provided sound effect to play.</span></span>
<span class="l"></span>
<div class="c">;
; Push X and Y on the stack. They will be clobbered when
; playing the sound.
;
</div><span class="l"><span><span class="i">TXA</span></span><span class="ce">; Push X</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; Push Y</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp_SoundIDToPlay">Temp_SoundIDToPlay</a></span></span><span class="ce">; Load the sound ID we stored.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PlaySoundInner">PlaySoundInner</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<div class="c">;
; Pop X and Y from the stack and restore.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A into Y.</span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A into X.</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_Maybe_ShowRoomTransition
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;============================================================================
</div><span class="l"><a name="Area_Maybe_ShowRoomTransition" href="#Area_Maybe_ShowRoomTransition" class="la">Area_Maybe_ShowRoomTransition:</a><span class="ce">; [$d0f6]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0047">Something_Blocks_0047</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MaybeUnused_006d">MaybeUnused_006d</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0047">Something_Blocks_0047</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0077">Something_0077</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0073">Something_0073</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0074">Something_0074</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0075">Something_0075</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0076">Something_0076</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d11c" href="#@LAB_PRG15_MIRROR__d11c" class="lla">@LAB_PRG15_MIRROR__d11c:</a><span class="ce">; [$d11c]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d61d">FUN_PRG15_MIRROR__d61d</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d11c">@LAB_PRG15_MIRROR__d11c</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_ScrollToNextRoom
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a>
;     <a href="#Area_Maybe_ShowRoomTransition">Area_Maybe_ShowRoomTransition</a>
;============================================================================
</div><span class="l"><a name="Area_ScrollToNextRoom" href="#Area_ScrollToNextRoom" class="la">Area_ScrollToNextRoom:</a><span class="ce">; [$d127]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#CurrentArea_ScrollingDataAddr">CurrentArea_ScrollingDataAddr</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#ScrollingData_U">ScrollingData_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_loadScrollData" href="#@_loadScrollData" class="lla">@_loadScrollData:</a><span class="ce">; [$d153]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a>,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_loadScrollData">@_loadScrollData</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load blocks to the left of the screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_copyLastColumnLeftScreenLoop" href="#@_copyLastColumnLeftScreenLoop" class="lla">@_copyLastColumnLeftScreenLoop:</a><span class="ce">; [$d170]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,Y</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_copyLastColumnLeftScreenLoop">@_copyLastColumnLeftScreenLoop</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load blocks to the right of the screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheRight">Area_ScreenToTheRight</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_copyRowScreenAboveLoop" href="#@_copyRowScreenAboveLoop" class="lla">@_copyRowScreenAboveLoop:</a><span class="ce">; [$d189]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,Y</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_copyRowScreenAboveLoop">@_copyRowScreenAboveLoop</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load blocks from the screen above.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenAbove">Area_ScreenAbove</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span><span class="ce">; Load blocks from screen above.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$f0</span></span><span class="ce">; X = 240</span></span>
<span class="l"></span>
<span class="l"><a name="@_copyRowScreenBelowLoop" href="#@_copyRowScreenBelowLoop" class="lla">@_copyRowScreenBelowLoop:</a><span class="ce">; [$d1a0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$05d0,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0316,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_copyRowScreenBelowLoop">@_copyRowScreenBelowLoop</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load blocks from the screen below.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenBelow">Area_ScreenBelow</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span><span class="ce">; Load blocks from screen below.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$f0</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d1b0" href="#@LAB_PRG15_MIRROR__d1b0" class="lla">@LAB_PRG15_MIRROR__d1b0:</a><span class="ce">; [$d1b0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0510,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0326,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d1b0">@LAB_PRG15_MIRROR__d1b0</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load blocks for the current screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_VerticalScroll">@_VerticalScroll</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d1e7,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_VerticalScroll" href="#@_VerticalScroll" class="lla">@_VerticalScroll:</a><span class="ce">; [$d1d6]</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d1e9,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a>
;
</div><span class="l"><a name="SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE" href="#SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE" class="la">SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE:</a><span class="ce">; [$d1e7]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$f0</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a>
;
</div><span class="l"><a name="SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE_2_" href="#SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE_2_" class="la">SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE_2_:</a><span class="ce">; [$d1e9]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d0</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Fill the screen buffer with 0s.
;
; This will clear 256 bytes of screen data from $0600
; to $06FF.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         256 bytes of screen buffer will be cleared.
;
; XREFS:
;     <a href="#Area_LoadBlocks">Area_LoadBlocks</a>
;============================================================================
</div><span class="l"><a name="ScreenBuffer_Clear" href="#ScreenBuffer_Clear" class="la">ScreenBuffer_Clear:</a><span class="ce">; [$d1eb]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"></span>
<div class="c">;
; Begin writing empty blocks.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$d1ef]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Write 0 to the screen buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X hasn't wrapped back to 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load blocks for the given screen from the level data.
;
; This will load the compressed block data for a given
; screen. Block data is stored [...]
;
; XREFS:
;     <a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a>
;============================================================================
</div><span class="l"><a name="Area_LoadBlocks" href="#Area_LoadBlocks" class="la">Area_LoadBlocks:</a><span class="ce">; [$d1f6]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Check if the screen index is set.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#ScreenBuffer_Clear">ScreenBuffer_Clear</a></span></span><span class="ce">; If not, then clear the screen buffer.</span></span>
<span class="l"></span>
<div class="c">;
; We'll be loading blocks for this screen. Calculate
; the address we'll be loading from.
;
</div><span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply screen index by 2</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = New screen index offset value</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a>),Y</span></span><span class="ce">; Set the lower block data address for this screen index.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a>),Y</span></span><span class="ce">; Set the upper block data address for this screen index.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store this as our total CHR page count.</span></span>
<span class="l"></span>
<div class="c">;
; Set our initial state for compressed block loading.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a></span></span><span class="ce">; Set byte offset to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; Set count to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Set bit offset to 0.</span></span>
<span class="l"></span>
<div class="c">;
; Load the control bits for the block. This will dictate
; how loading will proceed.
;
; The value will be 0-3.
;
; 0x00: Copy from previous block value (same row of previous,
;       if at column 0)
;
; 0x01: Copy from the block directly above
;
; 0x02: Copy from the block directly up and to the left
;       (or last block 2 rows up, if at column 0)
;
; 0x03: Read the block
;
</div><span class="l"><a name="@_nextBlock" href="#@_nextBlock" class="lla">@_nextBlock:</a><span class="ce">; [$d210]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Begin loading this block.</span></span>
<span class="l"></span>
<div class="c">;
; Shift our block value left by 2 and add load the next two
; compressed bits into those spots.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a></span></span><span class="ce">; Load next bit from compressed data.</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Shift our block to the left 1 and add the bit.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a></span></span><span class="ce">; Load next bit from compressed data.</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Shift our block to the left 1 and add the bit.</span></span>
<span class="l"></span>
<div class="c">;
; Check what bits we just loaded.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Load the current block value.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Check the 2 least-significant bits we loaded.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = Our loaded bits value</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$03</span></span><span class="ce">; Is the value 3?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_read8BitBlock">@_read8BitBlock</a></span></span><span class="ce">; If so, start a new block.</span></span>
<span class="l"></span>
<div class="c">;
; Load the block value stored in the screen buffer at
; the current offset + bitValue-specific offset.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; Else, load our blocks count.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$d273,X</span></span><span class="ce">; Add that to the value for this bit in the lookup table.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; Set as X</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block value from the screen buffer at the offset for this bit value.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_storeBlock">@_storeBlock</a></span></span><span class="ce">; Proceed to store the block.</span></span>
<span class="l"></span>
<div class="c">;
; Read an 8-bit block.
;
</div><span class="l"><a name="@_read8BitBlock" href="#@_read8BitBlock" class="lla">@_read8BitBlock:</a><span class="ce">; [$d234]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; X = 8 (total bits)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (new block value)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Store that value.</span></span>
<span class="l"></span>
<div class="c">;
; Load the block data. We'll load 8 bits worth.
;
; This is essentially going to be the same as the byte
; value, except the bits loaded may span multiple bytes.
;
</div><span class="l"><a name="@_load8BitsOfBlockData" href="#@_load8BitsOfBlockData" class="lla">@_load8BitsOfBlockData:</a><span class="ce">; [$d23a]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a></span></span><span class="ce">; Load next bit from compressed data.</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Shift our block to the left 1 and add the bit.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X-- (total bits)</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_load8BitsOfBlockData">@_load8BitsOfBlockData</a></span></span><span class="ce">; If we're not at 0, loop.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Else, load the resulting block value.</span></span>
<span class="l"></span>
<div class="c">;
; Store the block value in the screen buffer at the
; current offset.
;
</div><span class="l"><a name="@_storeBlock" href="#@_storeBlock" class="lla">@_storeBlock:</a><span class="ce">; [$d244]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; X = loaded block count, as our new offset</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store the byte in the screen buffer at that offset.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; Increment our block count.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_nextBlock">@_nextBlock</a></span></span><span class="ce">; If we haven't loaded 256 blocks, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're done loading the blocks. We now need to
; fill in the last row of 16 blocks with zeroes.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$f0</span></span><span class="ce">; X = 0xF0 (offset into the screen buffer to fill)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (value to store)</span></span>
<span class="l"></span>
<div class="c">;
; Fill the last line.
;
</div><span class="l"><a name="@_fillLastLine" href="#@_fillLastLine" class="lla">@_fillLastLine:</a><span class="ce">; [$d251]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store in the screen buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_fillLastLine">@_fillLastLine</a></span></span><span class="ce">; If we haven't hit 16 blocks (value 256 and wrapped around), then loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load the next bit from compressed data.
;
; This is used when decompressing screen data. It will
; process a bit at a time and make that result available
; to the caller.
;
; INPUTS:
;     0x08:
;         The address of the table of bytes to load from,
;         based on the byte offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a>:
;         The current byte offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a>:
;         The current bit offset within the byte offset.
;
; OUTPUTS:
;     <a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a>:
;         The new byte offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a>:
;         The new bit offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_CurByte">LoadCompressedScreenData_CurByte</a>:
;         The new loaded byte.
;
; XREFS:
;     <a href="#Area_LoadBlocks">Area_LoadBlocks</a>
;============================================================================
</div><span class="l"><a name="Area_LoadNextCompressedScreenBit" href="#Area_LoadNextCompressedScreenBit" class="la">Area_LoadNextCompressedScreenBit:</a><span class="ce">; [$d258]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Load the current bit.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_update">@_update</a></span></span><span class="ce">; Is this 0? If so, branch.</span></span>
<span class="l"></span>
<div class="c">;
; We're at the first bit. We need to load the byte we'll be
; working with from RAM as an index into 0x08.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a></span></span><span class="ce">; Get the offset of the byte we'll be processing.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Load the next byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_CurByte">LoadCompressedScreenData_CurByte</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Shift the current byte left by 1 and increment the bit
; offset by 1, for comparison.
;
</div><span class="l"><a name="@_update" href="#@_update" class="lla">@_update:</a><span class="ce">; [$d262]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_CurByte">LoadCompressedScreenData_CurByte</a></span></span><span class="ce">; Shift the current byte we're processing.</span></span>
<span class="l"><span><span class="i">PHP</span></span><span class="ce">; Save all flags.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Increment the next bit in the byte.</span></span>
<span class="l"></span>
<div class="c">;
; See if the lower 3 bits are cleared. If so, we need to
; advance the byte offset and reset the bit offset.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Check if we've hit the last bit in the byte.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If we have any data in bits 1-3...</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Reset the current bit to 0.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a></span></span><span class="ce">; Increase the byte offset.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$d271]</span></span>
<span class="l"><span><span class="i">PLP</span></span><span class="ce">; Restore all flags.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_LoadBlocks">Area_LoadBlocks</a>
;
</div><span class="l"><a name="BLOCK_DATA_OFFSETS_FOR_BIT_VALUES" href="#BLOCK_DATA_OFFSETS_FOR_BIT_VALUES" class="la">BLOCK_DATA_OFFSETS_FOR_BIT_VALUES:</a><span class="ce">; [$d273]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$f0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [2]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load block properties from Bank 3 into RAM.
;
; This will loop through all block properties for the
; current area, loading it into a table in RAM.
;
; Each pair of bytes in the block properties come
; together as the two nibbles for a new byte. The
; first byte represents the lower nibble, and the
; second byte's value is shifted into the upper nibble.
;
; INPUTS:
;     CurrentROMBank:
;         The current ROM bank to save and restore.
;
;     <a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a>:
;         The address of the current area's block
;         properties data.
;
; OUTPUTS:
;     BlockProperties:
;         The block properties in RAM to update.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;
; XREFS:
;     <a href="#Screen_BeginScrollAndLoadBlockProperties">Screen_BeginScrollAndLoadBlockProperties</a>
;============================================================================
</div><span class="l"><a name="Area_LoadBlockProperties" href="#Area_LoadBlockProperties" class="la">Area_LoadBlockProperties:</a><span class="ce">; [$d276]</span></span>
<div class="c">;
; Switch to bank 3, where the level data is stored.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Prepare for the read loop.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0</span></span>
<span class="l"></span>
<div class="c">;
; Load the lower nibble from the block properties.
;
</div><span class="l"><a name="@_nextBlockProperty" href="#@_nextBlockProperty" class="lla">@_nextBlockProperty:</a><span class="ce">; [$d283]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a>),Y</span></span><span class="ce">; A = block property in the current area at offset Y.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Retain the lower nibble.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store that for later lookup.</span></span>
<span class="l"></span>
<div class="c">;
; Load the next block property as the upper nibble.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Increment the index in the block properties table.;</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a>),Y</span></span><span class="ce">; Load it into A.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Move the lower nibble to the upper nibble.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"></span>
<div class="c">;
; Combine the two nibbles for the new value and store it in
; BlockProperties.
;
</div><span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; OR it to the lower nibble we saved.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BlockProperties">BlockProperties</a>,X</span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Keep going while the index is positive.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y = Y + 1</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_nextBlockProperty">@_nextBlockProperty</a></span></span><span class="ce">; If we haven't overflowed, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're done. Switch back to our previous bank.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull our saved bank.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; Set to X and...</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch banks.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Screen_BeginScrollAndLoadBlockProperties
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;     <a href="#Maybe_Screen_Scroll_D2A6">Maybe_Screen_Scroll_D2A6</a>
;============================================================================
</div><span class="l"><a name="Screen_BeginScrollAndLoadBlockProperties" href="#Screen_BeginScrollAndLoadBlockProperties" class="la">Screen_BeginScrollAndLoadBlockProperties:</a><span class="ce">; [$d29f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Area_LoadBlockProperties">Area_LoadBlockProperties</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Screen_Scroll_D2A6
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;============================================================================
</div><span class="l"><a name="Maybe_Screen_Scroll_D2A6" href="#Maybe_Screen_Scroll_D2A6" class="la">Maybe_Screen_Scroll_D2A6:</a><span class="ce">; [$d2a6]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d2ac">@LAB_PRG15_MIRROR__d2ac</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d0</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d2ac" href="#@LAB_PRG15_MIRROR__d2ac" class="lla">@LAB_PRG15_MIRROR__d2ac:</a><span class="ce">; [$d2ac]</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d2b8">@LAB_PRG15_MIRROR__d2b8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_BeginScrollAndLoadBlockProperties">Screen_BeginScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d2b8" href="#@LAB_PRG15_MIRROR__d2b8" class="lla">@LAB_PRG15_MIRROR__d2b8:</a><span class="ce">; [$d2b8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d393">FUN_PRG15_MIRROR__d393</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d2ce
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a>
;     <a href="#FUN_PRG15_MIRROR__dd0f">FUN_PRG15_MIRROR__dd0f</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d2ce" href="#FUN_PRG15_MIRROR__d2ce" class="la">FUN_PRG15_MIRROR__d2ce:</a><span class="ce">; [$d2ce]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_UpdatePlayerOnScroll">Game_UpdatePlayerOnScroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d61d">FUN_PRG15_MIRROR__d61d</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d2e2">@LAB_PRG15_MIRROR__d2e2</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d2e2" href="#@LAB_PRG15_MIRROR__d2e2" class="lla">@LAB_PRG15_MIRROR__d2e2:</a><span class="ce">; [$d2e2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;
</div><span class="l"><a name="RETURN_D2E6" href="#RETURN_D2E6" class="la">RETURN_D2E6:</a><span class="ce">; [$d2e6]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Screen_Scroll
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_Maybe_ShowRoomTransition">Area_Maybe_ShowRoomTransition</a>
;     <a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="Maybe_Screen_Scroll" href="#Maybe_Screen_Scroll" class="la">Maybe_Screen_Scroll:</a><span class="ce">; [$d2e7]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_notScrolling">@_notScrolling</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The screen is currently scrolling.
;
</div><span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d31e">@LAB_PRG15_MIRROR__d31e</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Maybe_Screen_Scroll_D2A6">Maybe_Screen_Scroll_D2A6</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_D2E6">RETURN_D2E6</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$d0</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d308">@LAB_PRG15_MIRROR__d308</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_BeginScrollAndLoadBlockProperties">Screen_BeginScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d308" href="#@LAB_PRG15_MIRROR__d308" class="lla">@LAB_PRG15_MIRROR__d308:</a><span class="ce">; [$d308]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ScrollIndex">Something_ScrollIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d3a6">FUN_PRG15_MIRROR__d3a6</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d31e" href="#@LAB_PRG15_MIRROR__d31e" class="lla">@LAB_PRG15_MIRROR__d31e:</a><span class="ce">; [$d31e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">PHP</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">PLP</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d334">@LAB_PRG15_MIRROR__d334</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_BeginScrollAndLoadBlockProperties">Screen_BeginScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d334" href="#@LAB_PRG15_MIRROR__d334" class="lla">@LAB_PRG15_MIRROR__d334:</a><span class="ce">; [$d334]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d4dc">FUN_PRG15_MIRROR__d4dc</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The screen is not currently scrolling.
;
</div><span class="l"><a name="@_notScrolling" href="#@_notScrolling" class="lla">@_notScrolling:</a><span class="ce">; [$d34a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$fc</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d364">@LAB_PRG15_MIRROR__d364</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">PHP</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">PLP</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d364">@LAB_PRG15_MIRROR__d364</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_BeginScrollAndLoadBlockProperties">Screen_BeginScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d364" href="#@LAB_PRG15_MIRROR__d364" class="lla">@LAB_PRG15_MIRROR__d364:</a><span class="ce">; [$d364]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d37c">@LAB_PRG15_MIRROR__d37c</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d37c">@LAB_PRG15_MIRROR__d37c</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d37c" href="#@LAB_PRG15_MIRROR__d37c" class="lla">@LAB_PRG15_MIRROR__d37c:</a><span class="ce">; [$d37c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d4f0">FUN_PRG15_MIRROR__d4f0</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d38e
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d393">FUN_PRG15_MIRROR__d393</a>
;     <a href="#FUN_PRG15_MIRROR__d3a6">FUN_PRG15_MIRROR__d3a6</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d38e" href="#FUN_PRG15_MIRROR__d38e" class="la">FUN_PRG15_MIRROR__d38e:</a><span class="ce">; [$d38e]</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d393
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Screen_Scroll_D2A6">Maybe_Screen_Scroll_D2A6</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d393" href="#FUN_PRG15_MIRROR__d393" class="la">FUN_PRG15_MIRROR__d393:</a><span class="ce">; [$d393]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d38e">FUN_PRG15_MIRROR__d38e</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d3a6
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d3a6" href="#FUN_PRG15_MIRROR__d3a6" class="la">FUN_PRG15_MIRROR__d3a6:</a><span class="ce">; [$d3a6]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d38e">FUN_PRG15_MIRROR__d38e</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Area_LoadBlocks
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d38e">FUN_PRG15_MIRROR__d38e</a>
;     <a href="#FUN_PRG15_MIRROR__d393">FUN_PRG15_MIRROR__d393</a>
;     <a href="#FUN_PRG15_MIRROR__d3a6">FUN_PRG15_MIRROR__d3a6</a>
;============================================================================
</div><span class="l"><a name="Maybe_Area_LoadBlocks" href="#Maybe_Area_LoadBlocks" class="la">Maybe_Area_LoadBlocks:</a><span class="ce">; [$d3ba]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$d4cb,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Blocks_0049">Unused_Blocks_0049</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MaybeUnused_006d">MaybeUnused_006d</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Blocks_0048">Temp_Blocks_0048</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Blocks_0048">Temp_Blocks_0048</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d3e6">@LAB_PRG15_MIRROR__d3e6</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d445">@LAB_PRG15_MIRROR__d445</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d3e6" href="#@LAB_PRG15_MIRROR__d3e6" class="lla">@LAB_PRG15_MIRROR__d3e6:</a><span class="ce">; [$d3e6]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d3ea" href="#@LAB_PRG15_MIRROR__d3ea" class="lla">@LAB_PRG15_MIRROR__d3ea:</a><span class="ce">; [$d3ea]</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData3CurAddr">CurrentArea_BlockData3CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData4CurAddr">CurrentArea_BlockData4CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ShopItems">ShopItems</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0221,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d3ea">@LAB_PRG15_MIRROR__d3ea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f8</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_L">Something_ShopItem_PPUAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0073">Something_0073</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d445" href="#@LAB_PRG15_MIRROR__d445" class="lla">@LAB_PRG15_MIRROR__d445:</a><span class="ce">; [$d445]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$16</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$f8</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d452" href="#@LAB_PRG15_MIRROR__d452" class="lla">@LAB_PRG15_MIRROR__d452:</a><span class="ce">; [$d452]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0192,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d452">@LAB_PRG15_MIRROR__d452</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d458" href="#@LAB_PRG15_MIRROR__d458" class="lla">@LAB_PRG15_MIRROR__d458:</a><span class="ce">; [$d458]</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$d4d3,Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Something_BlocksPPUData">Something_BlocksPPUData</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_BlocksPPUData">Something_BlocksPPUData</a>,Y</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d458">@LAB_PRG15_MIRROR__d458</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d48a">@LAB_PRG15_MIRROR__d48a</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0f</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d48a" href="#@LAB_PRG15_MIRROR__d48a" class="lla">@LAB_PRG15_MIRROR__d48a:</a><span class="ce">; [$d48a]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0044">Something_Blocks_0044</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$e0</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr2_L">Something_Blocks_PPUAddr2_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$23</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr2_U">Something_Blocks_PPUAddr2_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d4cf,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d4d1,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d4b4" href="#@LAB_PRG15_MIRROR__d4b4" class="lla">@LAB_PRG15_MIRROR__d4b4:</a><span class="ce">; [$d4b4]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Something_BlocksPPUData">Something_BlocksPPUData</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_BlocksPPUData">Something_BlocksPPUData</a>,X</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d4b4">@LAB_PRG15_MIRROR__d4b4</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0075">Something_0075</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [$d4cb] undefined</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a>
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__d4cc" href="#BYTE_PRG15_MIRROR__d4cc" class="la">BYTE_PRG15_MIRROR__d4cc:</a><span class="ce">; [$d4cc]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$00,$08</span></span><span class="ce">; [$d4cc] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a>
;     <a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a>
;     <a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d4cf" href="#BYTE_ARRAY_PRG15_MIRROR__d4cf" class="la">BYTE_ARRAY_PRG15_MIRROR__d4cf:</a><span class="ce">; [$d4cf]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a>
;     <a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a>
;     <a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d4d1" href="#BYTE_ARRAY_PRG15_MIRROR__d4d1" class="la">BYTE_ARRAY_PRG15_MIRROR__d4d1:</a><span class="ce">; [$d4d1]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a>
;     <a href="#Maybe_Area_LoadBlocks">Maybe_Area_LoadBlocks</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d4d3" href="#BYTE_ARRAY_PRG15_MIRROR__d4d3" class="la">BYTE_ARRAY_PRG15_MIRROR__d4d3:</a><span class="ce">; [$d4d3]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d4d7
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d4dc">FUN_PRG15_MIRROR__d4dc</a>
;     <a href="#FUN_PRG15_MIRROR__d4f0">FUN_PRG15_MIRROR__d4f0</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d4d7" href="#FUN_PRG15_MIRROR__d4d7" class="la">FUN_PRG15_MIRROR__d4d7:</a><span class="ce">; [$d4d7]</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d4dc
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d4dc" href="#FUN_PRG15_MIRROR__d4dc" class="la">FUN_PRG15_MIRROR__d4dc:</a><span class="ce">; [$d4dc]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d4d7">FUN_PRG15_MIRROR__d4d7</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d4f0
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d4f0" href="#FUN_PRG15_MIRROR__d4f0" class="la">FUN_PRG15_MIRROR__d4f0:</a><span class="ce">; [$d4f0]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d4d7">FUN_PRG15_MIRROR__d4d7</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d503
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d4d7">FUN_PRG15_MIRROR__d4d7</a>
;     <a href="#FUN_PRG15_MIRROR__d4dc">FUN_PRG15_MIRROR__d4dc</a>
;     <a href="#FUN_PRG15_MIRROR__d4f0">FUN_PRG15_MIRROR__d4f0</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d503" href="#FUN_PRG15_MIRROR__d503" class="la">FUN_PRG15_MIRROR__d503:</a><span class="ce">; [$d503]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$d619,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$d61b,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0047">Something_Blocks_0047</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MaybeUnused_006d">MaybeUnused_006d</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_Counter_006E">Something_Blocks_Counter_006E</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d587">@LAB_PRG15_MIRROR__d587</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d52c" href="#@LAB_PRG15_MIRROR__d52c" class="lla">@LAB_PRG15_MIRROR__d52c:</a><span class="ce">; [$d52c]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData3CurAddr">CurrentArea_BlockData3CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData4CurAddr">CurrentArea_BlockData4CurAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0045">Something_Blocks_0045</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_0200">Temp_0200</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#IScriptEntity">IScriptEntity</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$1e</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d52c">@LAB_PRG15_MIRROR__d52c</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0074">Something_0074</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr_L">Something_Blocks_PPUAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0047">Something_Blocks_0047</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr_U">Something_Blocks_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d587" href="#@LAB_PRG15_MIRROR__d587" class="lla">@LAB_PRG15_MIRROR__d587:</a><span class="ce">; [$d587]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$f8</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d58b" href="#@LAB_PRG15_MIRROR__d58b" class="lla">@LAB_PRG15_MIRROR__d58b:</a><span class="ce">; [$d58b]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$018a,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d58b">@LAB_PRG15_MIRROR__d58b</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d593" href="#@LAB_PRG15_MIRROR__d593" class="lla">@LAB_PRG15_MIRROR__d593:</a><span class="ce">; [$d593]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$d4d3,Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Something_PPUData">Something_PPUData</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_PPUData">Something_PPUData</a>,Y</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d593">@LAB_PRG15_MIRROR__d593</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$cc</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d5d5">@LAB_PRG15_MIRROR__d5d5</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$33</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d5d5" href="#@LAB_PRG15_MIRROR__d5d5" class="lla">@LAB_PRG15_MIRROR__d5d5:</a><span class="ce">; [$d5d5]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0046">Something_Blocks_0046</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_PPUAddr_L">Something_PPUAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_0047">Something_Blocks_0047</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$23</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_PPUAddr_U">Something_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d4cf,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d4d1,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d5fa" href="#@LAB_PRG15_MIRROR__d5fa" class="lla">@LAB_PRG15_MIRROR__d5fa:</a><span class="ce">; [$d5fa]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Something_PPUData">Something_PPUData</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_PPUData">Something_PPUData</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d5fa">@LAB_PRG15_MIRROR__d5fa</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0076">Something_0076</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d619" href="#BYTE_ARRAY_PRG15_MIRROR__d619" class="la">BYTE_ARRAY_PRG15_MIRROR__d619:</a><span class="ce">; [$d619]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d503">FUN_PRG15_MIRROR__d503</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d61b" href="#BYTE_ARRAY_PRG15_MIRROR__d61b" class="la">BYTE_ARRAY_PRG15_MIRROR__d61b:</a><span class="ce">; [$d61b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d61d
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_Maybe_ShowRoomTransition">Area_Maybe_ShowRoomTransition</a>
;     <a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a>
;     <a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d61d" href="#FUN_PRG15_MIRROR__d61d" class="la">FUN_PRG15_MIRROR__d61d:</a><span class="ce">; [$d61d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_0077">Something_0077</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d623" href="#@LAB_PRG15_MIRROR__d623" class="lla">@LAB_PRG15_MIRROR__d623:</a><span class="ce">; [$d623]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_0073">Something_0073</a>,X</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d631">@LAB_PRG15_MIRROR__d631</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d623">@LAB_PRG15_MIRROR__d623</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d631" href="#@LAB_PRG15_MIRROR__d631" class="lla">@LAB_PRG15_MIRROR__d631:</a><span class="ce">; [$d631]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_0073">Something_0073</a>,X</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_0077">Something_0077</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d650,X</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d64c,X</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d61d">FUN_PRG15_MIRROR__d61d</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d64c" href="#BYTE_ARRAY_PRG15_MIRROR__d64c" class="la">BYTE_ARRAY_PRG15_MIRROR__d64c:</a><span class="ce">; [$d64c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$53</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$72</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$98</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b0</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d61d">FUN_PRG15_MIRROR__d61d</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d650" href="#BYTE_ARRAY_PRG15_MIRROR__d650" class="la">BYTE_ARRAY_PRG15_MIRROR__d650:</a><span class="ce">; [$d650]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d654
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#BYTE_ARRAY_PRG15_MIRROR__d64c">BYTE_ARRAY_PRG15_MIRROR__d64c</a>
;     [$PRG15_MIRROR::d64c]
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d654" href="#FUN_PRG15_MIRROR__d654" class="la">FUN_PRG15_MIRROR__d654:</a><span class="ce">; [$d654]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_U">Something_ShopItem_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_ShopItem_PPUAddr_L">Something_ShopItem_PPUAddr_L</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d667" href="#@LAB_PRG15_MIRROR__d667" class="lla">@LAB_PRG15_MIRROR__d667:</a><span class="ce">; [$d667]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ShopItems">ShopItems</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d667">@LAB_PRG15_MIRROR__d667</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d673
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#BYTE_ARRAY_PRG15_MIRROR__d64c">BYTE_ARRAY_PRG15_MIRROR__d64c</a>
;     [$PRG15_MIRROR::d64d]
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d673" href="#FUN_PRG15_MIRROR__d673" class="la">FUN_PRG15_MIRROR__d673:</a><span class="ce">; [$d673]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr_U">Something_Blocks_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr_L">Something_Blocks_PPUAddr_L</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d686" href="#@LAB_PRG15_MIRROR__d686" class="lla">@LAB_PRG15_MIRROR__d686:</a><span class="ce">; [$d686]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_0200">Temp_0200</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$1a</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d686">@LAB_PRG15_MIRROR__d686</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#SavedPPUCtrl">SavedPPUCtrl</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d699
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#BYTE_ARRAY_PRG15_MIRROR__d64c">BYTE_ARRAY_PRG15_MIRROR__d64c</a>
;     [$PRG15_MIRROR::d64e]
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d699" href="#FUN_PRG15_MIRROR__d699" class="la">FUN_PRG15_MIRROR__d699:</a><span class="ce">; [$d699]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr2_U">Something_Blocks_PPUAddr2_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Blocks_PPUAddr2_L">Something_Blocks_PPUAddr2_L</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d6a5" href="#@LAB_PRG15_MIRROR__d6a5" class="lla">@LAB_PRG15_MIRROR__d6a5:</a><span class="ce">; [$d6a5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_BlocksPPUData">Something_BlocksPPUData</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d6a5">@LAB_PRG15_MIRROR__d6a5</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d6b1
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#BYTE_ARRAY_PRG15_MIRROR__d64c">BYTE_ARRAY_PRG15_MIRROR__d64c</a>
;     [$PRG15_MIRROR::d64f]
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d6b1" href="#FUN_PRG15_MIRROR__d6b1" class="la">FUN_PRG15_MIRROR__d6b1:</a><span class="ce">; [$d6b1]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d6b3" href="#@LAB_PRG15_MIRROR__d6b3" class="lla">@LAB_PRG15_MIRROR__d6b3:</a><span class="ce">; [$d6b3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_PPUAddr_U">Something_PPUAddr_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Something_PPUAddr_L">Something_PPUAddr_L</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_PPUData">Something_PPUData</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d6b3">@LAB_PRG15_MIRROR__d6b3</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d6ce
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_FallToGround">Player_FallToGround</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d6ce" href="#FUN_PRG15_MIRROR__d6ce" class="la">FUN_PRG15_MIRROR__d6ce:</a><span class="ce">; [$d6ce]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d6d4" href="#@LAB_PRG15_MIRROR__d6d4" class="lla">@LAB_PRG15_MIRROR__d6d4:</a><span class="ce">; [$d6d4]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$d6ef,X</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_incI">@_incI</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d6d4">@LAB_PRG15_MIRROR__d6d4</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d6e1">@LAB_PRG15_MIRROR__d6e1</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_incI" href="#@_incI" class="lla">@_incI:</a><span class="ce">; [$d6e0]</span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__d6e1" href="#@LAB_PRG15_MIRROR__d6e1" class="lla">@LAB_PRG15_MIRROR__d6e1:</a><span class="ce">; [$d6e1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d6ef,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d6ce">FUN_PRG15_MIRROR__d6ce</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d6ef" href="#BYTE_ARRAY_PRG15_MIRROR__d6ef" class="la">BYTE_ARRAY_PRG15_MIRROR__d6ef:</a><span class="ce">; [$d6ef]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$34</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d6ce">FUN_PRG15_MIRROR__d6ce</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d6ef_1_" href="#BYTE_ARRAY_PRG15_MIRROR__d6ef_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__d6ef_1_:</a><span class="ce">; [$d6f0]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$2c</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d6ce">FUN_PRG15_MIRROR__d6ce</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d6ef_2_" href="#BYTE_ARRAY_PRG15_MIRROR__d6ef_2_" class="la">BYTE_ARRAY_PRG15_MIRROR__d6ef_2_:</a><span class="ce">; [$d6f1]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$5c</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d6f3" href="#BYTE_ARRAY_PRG15_MIRROR__d6f3" class="la">BYTE_ARRAY_PRG15_MIRROR__d6f3:</a><span class="ce">; [$d6f3]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [0]: Ladder</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$24</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Open the path to Mascon.
;
; This will animate the removal of the stone coverings on
; the fountain and then drop down the ladder so it can be
; climbed to Mascon.
;
; INPUTS:
;     <a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a>:
;         The block position of the top of the fountain
;         cover.
;
;     <a href="#GAME_LADDER_TO_MASCON_BLOCK_OFFSETS">GAME_LADDER_TO_MASCON_BLOCK_OFFSETS</a>:
;         The offsets for animating the fountain cover.
;
; OUTPUTS:
;     <a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a>:
;         The number of ladder blocks remaining to place.
;
;     <a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a>:
;         The position of the next ladder block to place.
;
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         The updated screen buffer.
;
; CALLS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;
; XREFS:
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#ScreenEvents_HandlePathToMasconEvent">ScreenEvents_HandlePathToMasconEvent</a>
;============================================================================
</div><span class="l"><a name="Game_OpenPathToMascon" href="#Game_OpenPathToMascon" class="la">Game_OpenPathToMascon:</a><span class="ce">; [$d6f5]</span></span>
<div class="c">;
; Push the stone covering block offset to the stack for later.
;
</div><span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the top stone covering.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; X = Block position (in $YX form).</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_1_AIR">MASCON_FOUNTAIN_BLOCK_1_AIR</a></span></span><span class="ce">; A = Block ID to place.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store it in the screen buffer at the target location.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the bottom stone covering.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; X = Block position (in $YX form).</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; X += 16 (next row down; YPos += 1).</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_2_AIR">MASCON_FOUNTAIN_BLOCK_2_AIR</a></span></span><span class="ce">; A = Block ID to place.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store it in the screen buffer at the target location.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Pop the original stone covering block offset.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack (original block position)</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d76c,X</span></span><span class="ce">; A = Block position offset, based on the arguments.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; A += Target block position.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; Update the block position.</span></span>
<span class="l"></span>
<div class="c">;
; Place the top stone covering.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_1_STONE">MASCON_FOUNTAIN_BLOCK_1_STONE</a></span></span><span class="ce">; A = Stone block.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Place it in the screen buffer at the offset.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Place the bottom stone covering.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; A = Block position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16 (next row).</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_2_STONE">MASCON_FOUNTAIN_BLOCK_2_STONE</a></span></span><span class="ce">; A = Stone block.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Place it in the screen buffer.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Prepare to animate the dropping of the ladder.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a></span></span><span class="ce">; Set the ladder block count to 7.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$22</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; Set the position of the top of the ladder to X=2, Y=2.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the Path to Mascon quest is not yet complete.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the completed quests.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Is Path to Mascon completed?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_clearCoverings">@_clearCoverings</a></span></span><span class="ce">; If it is, jump.</span></span>
<span class="l"></span>
<div class="c">;
; Path to Mascon is not complete. Wait for 30 interrupts.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$1e</span></span><span class="ce">; X = 30 (loop counter)</span></span>
<span class="l"></span>
<span class="l"><a name="@_waitforInterruptLoop" href="#@_waitforInterruptLoop" class="lla">@_waitforInterruptLoop:</a><span class="ce">; [$d745]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span><span class="ce">; Wait for an interrupt.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--;</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_waitforInterruptLoop">@_waitforInterruptLoop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the top stone block on the fountain.
;
</div><span class="l"><a name="@_clearCoverings" href="#@_clearCoverings" class="lla">@_clearCoverings:</a><span class="ce">; [$d74b]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; X = Fountain cover block position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_1_AIR">MASCON_FOUNTAIN_BLOCK_1_AIR</a></span></span><span class="ce">; A = Air block.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Set in the screen buffer at the cover position.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the bottom stone block on the fountain.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; A = Fountain cover block position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16 (next row).</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_2_AIR">MASCON_FOUNTAIN_BLOCK_2_AIR</a></span></span><span class="ce">; A = Air block.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Set in the screen buffer at the cover position.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Drop the ladder to the path to Mascon.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a></span></span><span class="ce">; Drop the ladder.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Two cleared fountain stone block coverings.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a name="MASCON_FOUNTAIN_BLOCK_1_AIR" href="#MASCON_FOUNTAIN_BLOCK_1_AIR" class="la">MASCON_FOUNTAIN_BLOCK_1_AIR:</a><span class="ce">; [$d768]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; Air</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a name="MASCON_FOUNTAIN_BLOCK_2_AIR" href="#MASCON_FOUNTAIN_BLOCK_2_AIR" class="la">MASCON_FOUNTAIN_BLOCK_2_AIR:</a><span class="ce">; [$d769]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; Air</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Two set fountain stone block coverings.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a name="MASCON_FOUNTAIN_BLOCK_1_STONE" href="#MASCON_FOUNTAIN_BLOCK_1_STONE" class="la">MASCON_FOUNTAIN_BLOCK_1_STONE:</a><span class="ce">; [$d76a]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$88</span></span><span class="ce">; Stone cover</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a name="MASCON_FOUNTAIN_BLOCK_2_STONE" href="#MASCON_FOUNTAIN_BLOCK_2_STONE" class="la">MASCON_FOUNTAIN_BLOCK_2_STONE:</a><span class="ce">; [$d76b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$88</span></span><span class="ce">; Stone cover</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Lookup table for quickly calculating a relative X or Y position for placing
; a block.
;
; At index 0, X will be incremented by 1.
;
; At index 1, Y will be incremented by 1 (screen wrap-around).
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a name="GAME_LADDER_TO_MASCON_BLOCK_OFFSETS" href="#GAME_LADDER_TO_MASCON_BLOCK_OFFSETS" class="la">GAME_LADDER_TO_MASCON_BLOCK_OFFSETS:</a><span class="ce">; [$d76c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]: X + 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [1]: Y + 1</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Drop the ladder down to open the path to Mascon.
;
; This will animate placing all the ladder blocks, clearing
; a path up to the door to Mascon.
;
; Despite this only ever being called from the screen leading
; to Mascon, this will first check if it's on that screen.
; This appears to be code from some older design.
;
; INPUTS:
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The current region.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen.
;
;     <a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a>:
;         The starting ladder position to place.
;
;     <a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a>:
;         The total number of ladder blocks to place.
;
; OUTPUTS:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         The updated screen buffer.
;
;     <a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a>:
;     <a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a>:
;         Clobbered.
;
;     <a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a>:
;         Cleared (0).
;
; CALLS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;============================================================================
</div><span class="l"><a name="Game_DropLadderToMascon" href="#Game_DropLadderToMascon" class="la">Game_DropLadderToMascon:</a><span class="ce">; [$d76e]</span></span>
<div class="c">;
; Check if we're on the screen with the path to Mascon.
;
; NOTE: This is only ever called from this screen,
;       so it's interesting that this check exists.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Load the current region.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Are we in Trunk?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_dropLadderLoop">@_dropLadderLoop</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Load the current screen.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$28</span></span><span class="ce">; Is it the screen with the blocked path?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_dropLadderLoop">@_dropLadderLoop</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; We're on the right screen. Mark the path as opened.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the quests.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$20</span></span><span class="ce">; Mark the path to Mascon opened.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Wait for 4 interrupts.
;
</div><span class="l"><a name="@_dropLadderLoop" href="#@_dropLadderLoop" class="lla">@_dropLadderLoop:</a><span class="ce">; [$d783]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Play the Drop Ladder sound effect.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$17</span></span><span class="ce">; 0x17 == Drop ladder sound effect.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound effect.</span></span>
<span class="l"></span>
<div class="c">;
; Place the ladder block.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; X = Next ladder block position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="#DROP_LADDER_TO_MASCON_LADDER_BLOCK">DROP_LADDER_TO_MASCON_LADDER_BLOCK</a></span></span><span class="ce">; A = Ladder block.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store in the screen buffer at X.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update blocks on the screen.</span></span>
<span class="l"></span>
<div class="c">;
; Increment the ladder position, decrement the number of blocks
; to place, and loop.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; A = Ladder position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16 (next row)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; Store as the new position.</span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a></span></span><span class="ce">; Decrement the number of ladder blocks to place.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_dropLadderLoop">@_dropLadderLoop</a></span></span><span class="ce">; If there are still blocks remaining, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the "Opening Path" flag.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a></span></span><span class="ce">; Set opening to 0.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;
</div><span class="l"><a name="DROP_LADDER_TO_MASCON_LADDER_BLOCK" href="#DROP_LADDER_TO_MASCON_LADDER_BLOCK" class="la">DROP_LADDER_TO_MASCON_LADDER_BLOCK:</a><span class="ce">; [$d7af]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; Ladder block</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d7b0
;
; INPUTS:
;     X
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG14.html#FUN_PRG14__9991">FUN_PRG14__9991</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d7b0" href="#FUN_PRG15_MIRROR__d7b0" class="la">FUN_PRG15_MIRROR__d7b0:</a><span class="ce">; [$d7b0]</span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#BYTE_03cf">BYTE_03cf</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#BYTE_03ce">BYTE_03ce</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_SetBlocks
;
; INPUTS:
;     A
;     X
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d6ce">FUN_PRG15_MIRROR__d6ce</a>
;     <a href="#FUN_PRG15_MIRROR__d7b0">FUN_PRG15_MIRROR__d7b0</a>
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;============================================================================
</div><span class="l"><a name="Area_SetBlocks" href="#Area_SetBlocks" class="la">Area_SetBlocks:</a><span class="ce">; [$d7c5]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_SetPPUAddrForXYTransformed">Something_SetPPUAddrForXYTransformed</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_WriteTwoBlocksFromData12ToPPUBuffer">Area_WriteTwoBlocksFromData12ToPPUBuffer</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_WriteTwoBlocksFromData34ToPPUBuffer">Area_WriteTwoBlocksFromData34ToPPUBuffer</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write two blocks from area data 1 and 2 to the PPU buffer.
;
; This will load two tiles from the area data from
; <a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a> and
; <a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a> at offset
; <a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a> and write them to the PPU
; buffer at the provided offset.
;
; INPUTS:
;     X:
;         The offset within the PPU buffer to write to.
;
;     <a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>:
;         The block data used for the first block.
;
;     <a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>:
;         The block data used for the second block.
;
;     <a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a>:
;         The offset within the area block data to read from.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The updated PPU buffer.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The updated upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a name="Area_WriteTwoBlocksFromData12ToPPUBuffer" href="#Area_WriteTwoBlocksFromData12ToPPUBuffer" class="la">Area_WriteTwoBlocksFromData12ToPPUBuffer:</a><span class="ce">; [$d7ff]</span></span>
<div class="c">;
; Set the tile length to 2.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Write length of 2.</span></span>
<span class="l"></span>
<div class="c">;
; Load the first block and write to the PPU.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a></span></span><span class="ce">; Load the block position within the level.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>),Y</span></span><span class="ce">; Load the block at that position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store it the PPU buffer.</span></span>
<span class="l"></span>
<div class="c">;
; Load the second block and write to the PPU.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>),Y</span></span><span class="ce">; Load the block position within the level.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the block at that position.Store it the PPU buffer.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"></span>
<div class="c">;
; Set the new upper bounds of the buffer.
;
</div><span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Set X as the new upper bounds of the PPU buffer.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write two blocks from area data 3 and 4 to the PPU buffer.
;
; This will load two tiles from the area data from
; <a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a> and
; <a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a> at offset
; <a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a> and write them to the PPU
; buffer at the provided offset.
;
; INPUTS:
;     X:
;         The offset within the PPU buffer to write to.
;
;     <a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>:
;         The block data used for the first block.
;
;     <a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>:
;         The block data used for the second block.
;
;     <a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a>:
;         The offset within the area block data to read from.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The updated PPU buffer.
;
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The updated upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a name="Area_WriteTwoBlocksFromData34ToPPUBuffer" href="#Area_WriteTwoBlocksFromData34ToPPUBuffer" class="la">Area_WriteTwoBlocksFromData34ToPPUBuffer:</a><span class="ce">; [$d816]</span></span>
<div class="c">;
; Set the tile length to 2.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load the first block and write to the PPU.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"></span>
<div class="c">;
; Load the second block and write to the PPU.
;
</div><span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"></span>
<div class="c">;
; Set the new upper bounds of the buffer.
;
</div><span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__d82d
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__d82d" href="#FUN_PRG15_MIRROR__d82d" class="la">FUN_PRG15_MIRROR__d82d:</a><span class="ce">; [$d82d]</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$38</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Something_Maybe_BlockOffset">Something_Maybe_BlockOffset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$d8a4,X</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d4cf,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d4d1,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$d6f3,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$d8a8,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d8a4" href="#BYTE_ARRAY_PRG15_MIRROR__d8a4" class="la">BYTE_ARRAY_PRG15_MIRROR__d8a4:</a><span class="ce">; [$d8a4]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d82d">FUN_PRG15_MIRROR__d82d</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d8a8" href="#BYTE_ARRAY_PRG15_MIRROR__d8a8" class="la">BYTE_ARRAY_PRG15_MIRROR__d8a8:</a><span class="ce">; [$d8a8]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$fc</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$f3</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$cf</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3f</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Something_SetPPUAddrForXYTransformed
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a name="Something_SetPPUAddrForXYTransformed" href="#Something_SetPPUAddrForXYTransformed" class="la">Something_SetPPUAddrForXYTransformed:</a><span class="ce">; [$d8ac]</span></span>
<div class="c">;
; Build an address based on the X, Y position.
;
; X = X * 2
; Y = Y * 4
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$d8ea,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Something_SetPPUAddrForXYTransformed">Something_SetPPUAddrForXYTransformed</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__d8ea" href="#BYTE_ARRAY_PRG15_MIRROR__d8ea" class="la">BYTE_ARRAY_PRG15_MIRROR__d8ea:</a><span class="ce">; [$d8ea]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$24</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Reset the state for the player upon death.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
; OUTPUTS:
;     <a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a>:
;     <a href="RAM.html#Player_MovementTick">Player_MovementTick</a>:
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         Cleared.
;
; CALLS:
;     <a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a>
;     <a href="#LoadPalette2">LoadPalette2</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;     <a href="#PPUBuffer_Append0">PPUBuffer_Append0</a>
;     <a href="PRG14.html#PlayerDeath_ResetSelectedItemState">PlayerDeath_ResetSelectedItemState</a>
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;     <a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;     <a href="#Screen_NextTransitionState">Screen_NextTransitionState</a>
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="Player_HandleDeath" href="#Player_HandleDeath" class="la">Player_HandleDeath:</a><span class="ce">; [$d8ec]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><span><span class="i">TXS</span></span><span class="ce">; Set as stack pointer</span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14 (Logic)
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 14.</span></span>
<span class="l"></span>
<div class="c">;
; Clear all player bits but the facing direction.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Remove all but the facing direction bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"></span>
<div class="c">;
; Clear out more player state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Set player status to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span><span class="ce">; Set the movement tick to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Set invincibility phase to 0.</span></span>
<span class="l"></span>
<div class="c">;
; Push the inventory state to the stack.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Load the selected weapon.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span><span class="ce">; Load the selected armor.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Load the selected shield.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedMagic">SelectedMagic</a></span></span><span class="ce">; Load the selected magic.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Wait for interrupt and call other functions to
; reset state.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span><span class="ce">; Wait for interrupt.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span><span class="ce">; Reset animations.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7bf</span></span><span class="ce">; Reset selected item state.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a></span></span><span class="ce">; Update player sprite.</span></span>
<span class="l"></span>
<div class="c">;
; Prepare state for screen transitions.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Clear the screen transition counter.</span></span>
<span class="l"></span>
<div class="c">;
; Reset the player death state.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span><span class="ce">; Clear the dead flag.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Clear the death animation phase.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Clear the death animation counter.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span><span class="ce">; Clear the palette index.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the sprites and music.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a></span></span><span class="ce">; Clear sprites from the screen.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Clear the music.</span></span>
<span class="l"></span>
<div class="c">;
; Play the death sound effect.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$16</span></span><span class="ce">; 0x16 == Player death sound.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound effect.</span></span>
<span class="l"></span>
<div class="c">;
; Begin our death animation loop.
;
; This will dissolve the user's sprite.
;
</div><span class="l"><a name="@_dissolvePlayerLoop" href="#@_dissolvePlayerLoop" class="lla">@_dissolvePlayerLoop:</a><span class="ce">; [$d941]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span><span class="ce">; Reset animations.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_NextTransitionState">Screen_NextTransitionState</a></span></span><span class="ce">; Prepare for the next screen state.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the player.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a></span></span><span class="ce">; Draw the next cycle of the death animation.</span></span>
<span class="l"></span>
<div class="c">;
; Check whether to reset the animation state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Load the animation phase.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (complete)?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextLoop">@_prepareNextLoop</a></span></span><span class="ce">; If not, prepare for the next loop.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Load the screen transition counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$10</span></span><span class="ce">; Is it &gt;= 16?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_prepareNextLoop">@_prepareNextLoop</a></span></span><span class="ce">; If so, prepare for next loop.</span></span>
<span class="l"></span>
<div class="c">;
; Clear animation state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Clear the animation phase.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Clear the animation counter.</span></span>
<span class="l"></span>
<span class="l"><a name="@_prepareNextLoop" href="#@_prepareNextLoop" class="lla">@_prepareNextLoop:</a><span class="ce">; [$d966]</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Increment the screen transition counter.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_continueDissolvePlayerLoop">@_continueDissolvePlayerLoop</a></span></span><span class="ce">; If transition counter != 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We're past the player death animation.
;
; Load the palette and update the screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LoadPalette2">LoadPalette2</a></span></span><span class="ce">; Load the palette.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span><span class="ce">; Append 0 to the PPU buffer.</span></span>
<span class="l"></span>
<div class="c">;
; Restore the player's inventory.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the selected item from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the magic from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedMagic">SelectedMagic</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the shield from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the armor from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the weapon from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<div class="c">;
; Set the death music.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Death music.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the sprite loaded state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a></span></span><span class="ce">; Set loaded state to 0xFF.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0xFF via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterIScriptFarJump" href="#@_afterIScriptFarJump" class="lla">@_afterIScriptFarJump:</a><span class="ce">; [$d996]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set initial gold and experience via jump
; to <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterSetExpGoldFarJump" href="#@_afterSetExpGoldFarJump" class="lla">@_afterSetExpGoldFarJump:</a><span class="ce">; [$d9a0]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span><span class="ce">; Fade the screen to black.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a></span></span><span class="ce">; Reset state for spawn.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_Spawn">Player_Spawn</a></span></span><span class="ce">; Spawn the player.</span></span>
<span class="l"></span>
<span class="l"><a name="@_continueDissolvePlayerLoop" href="#@_continueDissolvePlayerLoop" class="lla">@_continueDissolvePlayerLoop:</a><span class="ce">; [$d9a9]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_dissolvePlayerLoop">@_dissolvePlayerLoop</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Begin the end-game sequence following the final boss kill.
;
; This will freeze the game briefly, fade to black, and then
; briefly wait while playing music before moving the player
; into the King's room for the final dialogue sequence.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a>
;     <a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a>
;     <a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#ScreenEvents_HandleFinalBossKilled">ScreenEvents_HandleFinalBossKilled</a>
;============================================================================
</div><span class="l"><a name="EndGame_Begin" href="#EndGame_Begin" class="la">EndGame_Begin:</a><span class="ce">; [$d9ac]</span></span>
<div class="c">;
; Clear all sprites from the screen.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a></span></span><span class="ce">; Clear sprites.</span></span>
<span class="l"></span>
<div class="c">;
; Wait 120 frames before beginning the fade-out.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$78</span></span><span class="ce">; X = 120 (loop counter)</span></span>
<span class="l"></span>
<span class="l"><a name="@_beforeFadeLoop" href="#@_beforeFadeLoop" class="lla">@_beforeFadeLoop:</a><span class="ce">; [$d9b1]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span><span class="ce">; Reset for this frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span><span class="ce">; Draw the screen and player in a semi-paused state.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop our loop counter.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_beforeFadeLoop">@_beforeFadeLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Fade the screen to black.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span><span class="ce">; Fade to black.</span></span>
<span class="l"></span>
<div class="c">;
; Wait another 120 frames before switching screens.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$78</span></span><span class="ce">; X = 120 (loop counter)</span></span>
<span class="l"></span>
<span class="l"><a name="@_beforeTransitionLoop" href="#@_beforeTransitionLoop" class="lla">@_beforeTransitionLoop:</a><span class="ce">; [$d9c6]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span><span class="ce">; Reset for this frame.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop our loop counter.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_beforeTransitionLoop">@_beforeTransitionLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Move the player to the King's room and begin the
; end-game dialogue sequence.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a></span></span><span class="ce">; Begin the next transition into the King's room.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_DrawDeathAnimation
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;============================================================================
</div><span class="l"><a name="Player_DrawDeathAnimation" href="#Player_DrawDeathAnimation" class="la">Player_DrawDeathAnimation:</a><span class="ce">; [$d9d6]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Load the death animation phase.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &gt;= 8?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Load the animation death counter.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_dissolveSprite">@_dissolveSprite</a></span></span><span class="ce">; If &gt;= 0, jump to dissolve the sprite.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Else, load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Every 3 out of 4 ticks...</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; Return.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Clear the death counter.</span></span>
<span class="l"></span>
<div class="c">;
; Queue draw command 0xFA, dissolving the character's sprite
; by removal of vertical lines.
;
; This is
; <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>.
;
; Draw 250 frames.
;
</div><span class="l"><a name="@_dissolveSprite" href="#@_dissolveSprite" class="lla">@_dissolveSprite:</a><span class="ce">; [$d9ed]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; X = PPU buffer upper bounds.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fa</span></span><span class="ce">; A = 0xFA (Remove Vertical Lines draw command).</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set that as the command to execute.</span></span>
<span class="l"></span>
<div class="c">;
; Set the current player phase for the draw.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Load the animation phase.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set that as the phase parameter.</span></span>
<span class="l"></span>
<div class="c">;
; Set the upper byte of the address to 0.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set 0 as the upper address.</span></span>
<span class="l"></span>
<div class="c">;
; Set the lower byte of the address based on the counter.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Load the animation counter.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$da21,Y</span></span><span class="ce">; Load the lower address for Y.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set it as the lower address.</span></span>
<span class="l"></span>
<div class="c">;
; Store the new upper bounds of the PPU buffer.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Set as the new upper bounds for the PPU buffer.</span></span>
<span class="l"></span>
<div class="c">;
; Update the animation counter.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Increment the animation counter.</span></span>
<span class="l"></span>
<div class="c">;
; If &gt;= 8, reset the counter and increment the phase.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Load the new animation counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &lt; 8?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<div class="c">;
; Reset the animation counter and increment the phase.
; <a href="#Player_HandleDeath">Player_HandleDeath</a> will see this and prepare the
; next
; round of vertical line removals.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Set the animation counter to 0xFF.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Increment the animation phase.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$da20]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a>
;
</div><span class="l"><a name="DEATH_ANIMATION_DRAW_ADDR_LOWER" href="#DEATH_ANIMATION_DRAW_ADDR_LOWER" class="la">DEATH_ANIMATION_DRAW_ADDR_LOWER:</a><span class="ce">; [$da21]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$40</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$70</span></span><span class="ce">; [7]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; DEADCODE: Set palette index to 0xFF.
;============================================================================
</div><span class="l"><a name="UNUSED_FUN_PRG15_MIRROR__da29" href="#UNUSED_FUN_PRG15_MIRROR__da29" class="la">UNUSED_FUN_PRG15_MIRROR__da29:</a><span class="ce">; [$da29]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Fade the screen out to black.
;
; This is called during door transitions or after
; dissolving a character during death.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PaletteIndex">PaletteIndex</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;     <a href="#Screen_NextTransitionState">Screen_NextTransitionState</a>
;
; XREFS:
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;     <a href="#_afterSetExpGoldFarJump">_afterSetExpGoldFarJump</a>
;     [$PRG15_MIRROR::d9a0]
;============================================================================
</div><span class="l"><a name="Screen_FadeToBlack" href="#Screen_FadeToBlack" class="la">Screen_FadeToBlack:</a><span class="ce">; [$da2f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (loop counter)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span><span class="ce">; Set as the index into the screen palette lookup.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$da34]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span><span class="ce">; Wait for the next interrupt.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_NextTransitionState">Screen_NextTransitionState</a></span></span><span class="ce">; Update the screen for this palete.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span><span class="ce">; Load the palette index.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &lt; 4?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle the next state for a screen transition.
;
; This may be used when entering a building or when dying.
; An outer loop will call this each tick. It won't begin
; the fadeout until <a href="RAM.html#PaletteIndex">PaletteIndex</a> is a value 0-4.
;
; The palette will increase at periodic intervals,
; eventually ending with a black screen.
;
; INPUTS:
;     <a href="RAM.html#PaletteIndex">PaletteIndex</a>:
;         The current palette index.
;
;     <a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a>:
;         The counter for this loop.
;
;     <a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a>:
;         The palette index to apply for the transition.
;
; OUTPUTS:
;     <a href="RAM.html#PaletteIndex">PaletteIndex</a>:
;         The new palette index.
;
;     <a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a>:
;         The fade-out counter.
;
; XREFS:
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;============================================================================
</div><span class="l"><a name="Screen_NextTransitionState" href="#Screen_NextTransitionState" class="la">Screen_NextTransitionState:</a><span class="ce">; [$da42]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span><span class="ce">; Load the current palette index.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &gt;= 4?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__da5d">@LAB_PRG15_MIRROR__da5d</a></span></span><span class="ce">; If so, jump to finish up.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a></span></span><span class="ce">; A = fadeout counter.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$32</span></span><span class="ce">; A += 0x32 (50)</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a></span></span><span class="ce">; Store as the new value.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__da5d">@LAB_PRG15_MIRROR__da5d</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Fade out to the next palette towards black.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LoadPalette">LoadPalette</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__da5d" href="#@LAB_PRG15_MIRROR__da5d" class="lla">@LAB_PRG15_MIRROR__da5d:</a><span class="ce">; [$da5d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; We're doing player death, and have finished dissolving
; the player. We can now begin fading to black.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PaletteIndex">PaletteIndex</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$da69]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_InitStateForStartScreen
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_Init">Game_Init</a>
;============================================================================
</div><span class="l"><a name="Game_InitStateForStartScreen" href="#Game_InitStateForStartScreen" class="la">Game_InitStateForStartScreen:</a><span class="ce">; [$da6a]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">TXS</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7ae</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_ShowStartScreen">Game_ShowStartScreen</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_InitStateForSpawn
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a>
;============================================================================
</div><span class="l"><a name="Game_InitStateForSpawn" href="#Game_InitStateForSpawn" class="la">Game_InitStateForSpawn:</a><span class="ce">; [$da7d]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Offset">PPUBuffer_Offset</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetInitialState">Player_SetInitialState</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$ba55</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__ce80">FUN_PRG15_MIRROR__ce80</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Maybe_GameScreenStart">Maybe_GameScreenStart</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Game_EnterScreenHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a name="Maybe_Game_EnterScreenHandler" href="#Maybe_Game_EnterScreenHandler" class="la">Maybe_Game_EnterScreenHandler:</a><span class="ce">; [$daa0]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Game_EnterBuildingHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#EndGame_MoveToKingsRoom">EndGame_MoveToKingsRoom</a>
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a name="Maybe_Game_EnterBuildingHandler" href="#Maybe_Game_EnterBuildingHandler" class="la">Maybe_Game_EnterBuildingHandler:</a><span class="ce">; [$daaf]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_EnterBuilding">Game_EnterBuilding</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Game_ExitBuildingHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Game_MainExitBuildingHandler">Maybe_Game_MainExitBuildingHandler</a>
;============================================================================
</div><span class="l"><a name="Maybe_Game_ExitBuildingHandler" href="#Maybe_Game_ExitBuildingHandler" class="la">Maybe_Game_ExitBuildingHandler:</a><span class="ce">; [$dabe]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_ExitBuilding">Game_ExitBuilding</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__dacd
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ChangeArea">Area_ChangeArea</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__dacd" href="#FUN_PRG15_MIRROR__dacd" class="la">FUN_PRG15_MIRROR__dacd:</a><span class="ce">; [$dacd]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_SetupAndLoadArea
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Debug_ChooseArea">Debug_ChooseArea</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;============================================================================
</div><span class="l"><a name="Game_SetupAndLoadArea" href="#Game_SetupAndLoadArea" class="la">Game_SetupAndLoadArea:</a><span class="ce">; [$dadc]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$dafe,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Dead code that would assign the area based on transitioning from another.
;============================================================================
</div><span class="l"><span><span class="i">hex</span> <span class="o">ae 35 04 bd fe da 85 24</span></span><span class="ce">; [$daf6] undefined</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;
</div><span class="l"><a name="MAYBE_OUTSIDE_REGION_INDEXES" href="#MAYBE_OUTSIDE_REGION_INDEXES" class="la">MAYBE_OUTSIDE_REGION_INDEXES:</a><span class="ce">; [$dafe]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_EOLIS</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">; [1]: Trunk</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">; [2]: Mist</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">; [3]: Branch</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_DAYBREAK</span></span><span class="ce">; [4]: Dartmoor</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_EVIL_FORTRESS</span></span><span class="ce">; [5]: Evil Fortress</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Place the player in the King's room and move toward the King.
;
; This is part of the end-game sequence, and takes place
; immediately after the final boss is killed and the screen
; fades out.
;
; The player will be placed back in the King's room, and will
; then begin moving automatically toward the King.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#EndGame_MoveToKingsRoom">EndGame_MoveToKingsRoom</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;
; XREFS:
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;============================================================================
</div><span class="l"><a name="EndGame_BeginKingsRoomSequence" href="#EndGame_BeginKingsRoomSequence" class="la">EndGame_BeginKingsRoomSequence:</a><span class="ce">; [$db04]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#EndGame_MoveToKingsRoom">EndGame_MoveToKingsRoom</a></span></span><span class="ce">; Place the player in the King's room.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#EndGame_MainLoop">EndGame_MainLoop</a></span></span><span class="ce">; Move the player toward the King.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Spawn the player.
;
; This will set the player's HP and MP to max, reset
; quest state and timed items, and place the player in
; the latest temple.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The completed quests.
;
; OUTPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The updated completed quests.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The filled player HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The filled player MP.
;
; CALLS:
;     <a href="#Game_ClearTimedItems">Game_ClearTimedItems</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;
; XREFS:
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;============================================================================
</div><span class="l"><a name="Player_Spawn" href="#Player_Spawn" class="la">Player_Spawn:</a><span class="ce">; [$db0a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$50</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Set the initial player HP to 80.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Set the initial player MP to 80.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the completed quests.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$ef</span></span><span class="ce">; Disable the Mattock barrier to Mascon quest.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_ClearTimedItems">Game_ClearTimedItems</a></span></span><span class="ce">; Cleared all timed items.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_SpawnInTemple">Game_SpawnInTemple</a></span></span><span class="ce">; Spawn in the temple.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a></span></span><span class="ce">; Change the state to be inside a building.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span><span class="ce">; Start the mainloop.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Start the game.
;
; This runs after the intro animation finishes, placing
; the player at the gates of Eolis with no MP and no
; experience.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         Set to 0.
;
;     <a href="RAM.html#Experience">Experience</a>:
;         Set to 0.
;
;     See Fallthrough.
;
; CALLS:
;     <a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a>
;     <a href="#Game_ClearTimedItems">Game_ClearTimedItems</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; FALLTHROUGH:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;
; XREFS:
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;============================================================================
</div><span class="l"><a name="Game_Start" href="#Game_Start" class="la">Game_Start:</a><span class="ce">; [$db26]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_ClearTimedItems">Game_ClearTimedItems</a></span></span><span class="ce">; Clear all timed items.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until everything is drawn to the screen.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a></span></span><span class="ce">; Load the first level.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the player's MP.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Clear the player's experience.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Prepare state for the first screen of Eolis, including the
; intro trigger sprite entity.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load images for the current sprite entities (which will be the intro trigger).</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_MainLoop
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a name="Game_MainLoop" href="#Game_MainLoop" class="la">Game_MainLoop:</a><span class="ce">; [$db45]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">TXS</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b982</span></span><span class="ce">; Draw the player's shield sprite.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the player's body sprite.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7d6</span></span><span class="ce">; Draw the player's weapon sprite.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$ba5b</span></span><span class="ce">; Check and handle casting magic.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a></span></span><span class="ce">; Active selected item?</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Update all sprites.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_AnimateFog">GameLoop_AnimateFog</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_playerIsNotDead">@_playerIsNotDead</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_HandleDeath">Player_HandleDeath</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_playerIsNotDead" href="#@_playerIsNotDead" class="lla">@_playerIsNotDead:</a><span class="ce">; [$db7f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Maybe_GameScreenStart">Maybe_GameScreenStart</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__db91">@LAB_PRG15_MIRROR__db91</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__dbaf">@LAB_PRG15_MIRROR__dbaf</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__db91" href="#@LAB_PRG15_MIRROR__db91" class="lla">@LAB_PRG15_MIRROR__db91:</a><span class="ce">; [$db91]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__dd0f">FUN_PRG15_MIRROR__dd0f</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__cb17">FUN_PRG15_MIRROR__cb17</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__dbaf" href="#@LAB_PRG15_MIRROR__dbaf" class="lla">@LAB_PRG15_MIRROR__dbaf:</a><span class="ce">; [$dbaf]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b982</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7d6</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_scrolling" href="#@_scrolling" class="lla">@_scrolling:</a><span class="ce">; [$dbca]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_UpdatePlayerOnScroll">Game_UpdatePlayerOnScroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b982</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7d6</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Screen_Scroll">Maybe_Screen_Scroll</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_scrolling">@_scrolling</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Mainloop for the end of the game.
;
; This will act as a normal mainloop, except the button
; inputs will be simulated to approach the King and trigger
; the dialogue.
;
; The actual ending-game sequence happens after interacting
; with the King, which uses an IScript action to initiate
; the end-game outro sequence.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#EndGame_MovePlayerTowardKing">EndGame_MovePlayerTowardKing</a>
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;     <a href="#GameLoop_AnimateFog">GameLoop_AnimateFog</a>
;     <a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a>
;     <a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a>
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;     <a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a>
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;     <a href="PRG14.html#Player_DrawShield">Player_DrawShield</a>
;     <a href="PRG14.html#Player_DrawWeapon">Player_DrawWeapon</a>
;     Sprites_UpdateAll
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;============================================================================
</div><span class="l"><a name="EndGame_MainLoop" href="#EndGame_MainLoop" class="la">EndGame_MainLoop:</a><span class="ce">; [$dbef]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF (unused -- noop)</span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Set bank to 14 (Logic).</span></span>
<span class="l"></span>
<div class="c">;
; Wait for a frame and prepare for renders.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_Maybe_SetupDrawState">GameLoop_Maybe_SetupDrawState</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Move the player a step/jump toward the King, or begin
; interaction, depending on position.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#EndGame_MovePlayerTowardKing">EndGame_MovePlayerTowardKing</a></span></span><span class="ce">; Simulate the player's button press.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a></span></span><span class="ce">; Update the player's position/state.</span></span>
<span class="l"></span>
<div class="c">;
; Perform all the standard mainloop operations.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o">#$b982</span></span><span class="ce">; Draw the shield.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the armor.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7d6</span></span><span class="ce">; Draw the weapon.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$ba5b</span></span><span class="ce">; No-op</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Update sprites.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_AnimateFog">GameLoop_AnimateFog</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#EndGame_MainLoop">EndGame_MainLoop</a></span></span><span class="ce">; Loop.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Move the player toward the King in the end-game.
;
; This will move the player by simulating holding down the
; Left joypad button, pressing the A button when at the stairs,
; and pressing Up when at the King.
;
; This is all done by factoring in the current player position:
;
; 1. Press Left until at X=79.
;
; 2. At X=79, keep pressing Jump and left.
;
; 3. At X=68, release and press Up.
;
; INPUTS:
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The current player X position.
;
; OUTPUTS:
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The simulated button presses.
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;============================================================================
</div><span class="l"><a name="EndGame_MovePlayerTowardKing" href="#EndGame_MovePlayerTowardKing" class="la">EndGame_MovePlayerTowardKing:</a><span class="ce">; [$dc23]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; A = player X.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$61</span></span><span class="ce">; Is it &gt;= 97?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_setButtonsLeft">@_setButtonsLeft</a></span></span><span class="ce">; If so, jump to just press Left.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it &gt;= 80?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_setJumpLeft">@_setJumpLeft</a></span></span><span class="ce">; If so, jump to press Left+A.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$44</span></span><span class="ce">; Is it &gt;= 68?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_setButtonsLeft">@_setButtonsLeft</a></span></span><span class="ce">; If so, jump to press Left.</span></span>
<span class="l"></span>
<div class="c">;
; Simulate pressing Up to engage with the King.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Up button bitmask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set as the current button mask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Set as the changed button mask.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; Simulate pressing Left.
;
</div><span class="l"><a name="@_setButtonsLeft" href="#@_setButtonsLeft" class="lla">@_setButtonsLeft:</a><span class="ce">; [$dc38]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span><span class="ce">; 0x02 == Left button bitmask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set as the current button mask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Set as the changed button mask.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; Simulate pressing Left+A to jump left.
;
</div><span class="l"><a name="@_setJumpLeft" href="#@_setJumpLeft" class="lla">@_setJumpLeft:</a><span class="ce">; [$dc3f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$82</span></span><span class="ce">; 0x82 == Left + A button bitmask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set as the current button mask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Set as the changed button mask.</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;
</div><span class="l"><a name="RETURN_DC45" href="#RETURN_DC45" class="la">RETURN_DC45:</a><span class="ce">; [$dc45]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw the player and sprites in a frozen state.
;
; This is used when needing to draw sprites without anything
; moving around or interacting with each other.
;
; It's invoked when writing messages, filling HP/MP, or in
; the end-game sequence.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a>:
;         The loaded state for the sprites.
;
;         If 0xFF, this function will immediately return.
;
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The player's current status flag.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;     <a href="PRG14.html#Player_DrawShield">Player_DrawShield</a>
;     <a href="PRG14.html#Player_DrawWeapon">Player_DrawWeapon</a>
;     <a href="PRG14.html#Sprites_UpdateAll">Sprites_UpdateAll</a>
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a name="Game_DrawScreenInFrozenState" href="#Game_DrawScreenInFrozenState" class="la">Game_DrawScreenInFrozenState:</a><span class="ce">; [$dc46]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a></span></span><span class="ce">; Load the loaded state.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_DC45">RETURN_DC45</a></span></span><span class="ce">; If so, then return.</span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 14.</span></span>
<span class="l"></span>
<div class="c">;
; Temporarily clear Wing Boots state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flag.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push to the stack so it can be restored later.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Keep all but the Wing Boots flag.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Draw the player.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o">#$b982</span></span><span class="ce">; Draw the shield.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the armor.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b7d6</span></span><span class="ce">; Draw the weapon.</span></span>
<span class="l"></span>
<div class="c">;
; Restore the player's status flags.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the status flag.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Draw all the sprites, but with sprites paused.
;
; This flag will will disable all behavioral updates for
; sprites.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; A = 1</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Sprites_UpdatesPaused">Sprites_UpdatesPaused</a></span></span><span class="ce">; Set as the paused state for sprites.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$8070</span></span><span class="ce">; Update all sprites.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Sprites_UpdatesPaused">Sprites_UpdatesPaused</a></span></span><span class="ce">; Clear the paused state.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore the previous bank.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_LoadAreaTable
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a name="Game_LoadAreaTable" href="#Game_LoadAreaTable" class="la">Game_LoadAreaTable:</a><span class="ce">; [$dc78]</span></span>
<div class="c">;
; XXX Set the address for the area in the areas table.
;
</div><span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a>,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$8001,Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_ScreenBlocksOffset.U">Area_ScreenBlocksOffset.U</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Save the current ROM bank and switch to bank 3, where the
; areas table lives.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the start of the area's pointer table in
; 0x{@address 007C}.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8001</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_TableAddr.U">CurrentArea_TableAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Store the addresses of the block attributes and 4 groups of
; block data in addresses {@address 007E}.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__dcbf" href="#@LAB_PRG15_MIRROR__dcbf" class="lla">@LAB_PRG15_MIRROR__dcbf:</a><span class="ce">; [$dcbf]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__dcbf">@LAB_PRG15_MIRROR__dcbf</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$02</span></span></span>
<span class="l"></span>
<div class="c">;
; Load the block properties, scrolling data, door locations,
; and door destinations addresses.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockPropertiesAddr.U">CurrentArea_BlockPropertiesAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ScrollingDataAddr">CurrentArea_ScrollingDataAddr</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollingData_U">ScrollingData_U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr">CurrentArea_DoorLocationsAddr</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr.U">CurrentArea_DoorLocationsAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorDestinationsAddr.U">CurrentArea_DoorDestinationsAddr.U</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Switch back to the previous bank.
;
</div><span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__dd0f
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__dd0f" href="#FUN_PRG15_MIRROR__dd0f" class="la">FUN_PRG15_MIRROR__dd0f:</a><span class="ce">; [$dd0f]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Something_SetupNewScreen
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Screen_Load">Screen_Load</a>
;============================================================================
</div><span class="l"><a name="Something_SetupNewScreen" href="#Something_SetupNewScreen" class="la">Something_SetupNewScreen:</a><span class="ce">; [$dd13]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__ce80">FUN_PRG15_MIRROR__ce80</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_Maybe_ShowRoomTransition">Area_Maybe_ShowRoomTransition</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LoadPalette2">LoadPalette2</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load the current screen.
;
; This will set up the palette, reset sprites, load
; metadata for the screen (sprites, values, and special
; events), and prepare for rendering.
;
; INPUTS:
;     <a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a>:
;         The current loaded state.
;
; OUTPUTS:
;     <a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a>:
;         The new loaded state (0).
;
; CALLS:
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;     <a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a>
;     <a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a>
;     <a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a>
;     <a href="#PPUBuffer_Append0">PPUBuffer_Append0</a>
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a>
;============================================================================
</div><span class="l"><a name="Screen_Load" href="#Screen_Load" class="la">Screen_Load:</a><span class="ce">; [$dd46]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_SetupNewScreen">Something_SetupNewScreen</a></span></span><span class="ce">; Draw the HUD and prepare setup for the screen.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span><span class="ce">; Load the palette.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Screen_SetupSprites
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;============================================================================
</div><span class="l"><a name="Screen_SetupSprites" href="#Screen_SetupSprites" class="la">Screen_SetupSprites:</a><span class="ce">; [$dd4e]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_ClearSprites">GameLoop_ClearSprites</a></span></span><span class="ce">; Clear current sprite data.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a></span></span><span class="ce">; Get the loaded state.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Is it 1?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__dd5a">@LAB_PRG15_MIRROR__dd5a</a></span></span><span class="ce">; If not, finish up.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a></span></span><span class="ce">; Load information for the screen.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__dd5a" href="#@LAB_PRG15_MIRROR__dd5a" class="lla">@LAB_PRG15_MIRROR__dd5a:</a><span class="ce">; [$dd5a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a></span></span><span class="ce">; Set loaded state to 0.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span><span class="ce">; Append a 0 to the PPU buffer.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Spawn the player in a temple.
;
; This is called when starting up a new life for the player.
; The player will be spawned in a temple, placed in the
; specified area and screen, using the correct palette and
; player positions.
;
; INPUTS:
;     <a href="RAM.html#TempleSpawnPoint">TempleSpawnPoint</a>:
;         The index of the template in which the player will
;         be spawned.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The starting screen outside the template.
;
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The area in which the player will be placed outside
;         the template.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The X position the player will be in outside the
;         temple.
;
;     <a href="RAM.html#PlayerPosY">PlayerPosY</a>:
;         The Y position the player will be in outside the
;         temple.
;
;     <a href="RAM.html#Something_Maybe_NewCurrentScreen">Something_Maybe_NewCurrentScreen</a>:
;         TODO
;
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         TODO
;
;     <a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a>:
;         TODO: The index of the palette outside the temple?
;
;     <a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a>:
;         The music to play outside the temple.
;
;     CurrentPalette:
;         The palette inside the temple.
;
;     <a href="RAM.html#Something_Maybe_NewTilesIndex">Something_Maybe_NewTilesIndex</a>:
;         TODO
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The start position inside the temple.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The music to play inside the temple.
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         TODO
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The new player flags (set to face left inside
;         the temple).
;
; XREFS:
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a name="Game_SpawnInTemple" href="#Game_SpawnInTemple" class="la">Game_SpawnInTemple:</a><span class="ce">; [$dd61]</span></span>
<div class="c">;
; Set the starting area/screen/position information outside the
; temple.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#TempleSpawnPoint">TempleSpawnPoint</a></span></span><span class="ce">; X = index of the temple spawn point.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ddd5,X</span></span><span class="ce">; Set the current screen for outside the temple.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ddcd,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ddb5,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ddbd,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ddc5,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewCurrentScreen">Something_Maybe_NewCurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$ddad,X</span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df4c,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df5c,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$12</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewTilesIndex">Something_Maybe_NewTilesIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$9e</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0e</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the player to face left inside the temple.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$bf</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of Temple spawn positions to areas.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="CURRENT_REGION_FOR_TEMPLE_SPAWN" href="#CURRENT_REGION_FOR_TEMPLE_SPAWN" class="la">CURRENT_REGION_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddad]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of Temple spawn positions to outside X positions.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN" href="#START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN" class="la">START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddb5]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of Temple spawn positions to outside Y positions.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN" href="#MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN" class="la">MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddbd]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$80</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: A mapping of Temple spawn positions to &lt;TODO&gt;.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="MAYBE_START_BYTE_03DA_FOR_TEMPLE_SPAWN" href="#MAYBE_START_BYTE_03DA_FOR_TEMPLE_SPAWN" class="la">MAYBE_START_BYTE_03DA_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddc5]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1e</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$23</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$2b</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3c</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of Temple spawn positions to next areas.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN" href="#START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN" class="la">START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddcd]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of Temple spawn positions to start screens.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="START_SCREEN_FOR_TEMPLE_SPAWN" href="#START_SCREEN_FOR_TEMPLE_SPAWN" class="la">START_SCREEN_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddd5]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [7]: Final town</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Move the player to the King's Room for the end-game.
;
; This sets the state to load the King's Room and places
; the player in the correct place. The Temple music will
; be played while in the room.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's flags.
;
; OUTPUTS:
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The music to play for the area (Temple music).
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;     <a href="RAM.html#Something_Maybe_NewCurrentScreen">Something_Maybe_NewCurrentScreen</a>:
;         The screen to load (68).
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The new loading screen index.
;
;     <a href="RAM.html#Screen_Palette">Screen_Palette</a>:
;         The palette for the room.
;
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The updated region (Eolis).
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The starting X/Y position (X=13, Y=9).
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated player's flags.
;
;     <a href="RAM.html#Something_Maybe_NewTilesIndex">Something_Maybe_NewTilesIndex</a>:
;         The tiles for the room.
;
; CALLS:
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;
; XREFS:
;     <a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a>
;============================================================================
</div><span class="l"><a name="EndGame_MoveToKingsRoom" href="#EndGame_MoveToKingsRoom" class="la">EndGame_MoveToKingsRoom:</a><span class="ce">; [$dddd]</span></span>
<div class="c">;
; Move the player back to Eolis.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; Set the screen index to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Set the region to Eolis.</span></span>
<span class="l"></span>
<div class="c">;
; Play the Temple music.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$0d</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Play the Temple music.</span></span>
<span class="l"></span>
<div class="c">;
; Move the player to the right of the room.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$9d</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span><span class="ce">; Set the start position to X=13, Y=9.</span></span>
<span class="l"></span>
<div class="c">;
; Load the palette for the King's room.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$11</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span><span class="ce">; Set the Palette for the King's room.</span></span>
<span class="l"></span>
<div class="c">;
; Set the King's Room screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$44</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Set the screen to 68.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewCurrentScreen">Something_Maybe_NewCurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewTilesIndex">Something_Maybe_NewTilesIndex</a></span></span><span class="ce">; Set the tiles to 6.</span></span>
<span class="l"></span>
<div class="c">;
; Face the player to the left.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$bf</span></span><span class="ce">; Set to facing left.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a></span></span><span class="ce">; Trigger the Enter Building logic.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_EnterBuilding
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a>
;============================================================================
</div><span class="l"><a name="Game_EnterBuilding" href="#Game_EnterBuilding" class="la">Game_EnterBuilding:</a><span class="ce">; [$de06]</span></span>
<div class="c">;
; Unset the player's current weapon. Players can't attack in
; buildings.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_PrevRegion">Area_PrevRegion</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Maybe_PrevScreen">Maybe_PrevScreen</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Prev_Palette">Prev_Palette</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Prev_PlayerPosXY">Prev_PlayerPosXY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#Prev_PlayerPosXY">Prev_PlayerPosXY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Prev_PlayerPosXY">Prev_PlayerPosXY</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df34,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df3c,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewTilesIndex">Something_Maybe_NewTilesIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_SetupNewScreen">Something_SetupNewScreen</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewCurrentScreen">Something_Maybe_NewCurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Screen_SetupSprites">Screen_SetupSprites</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_ExitBuilding
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Game_ExitBuildingHandler">Maybe_Game_ExitBuildingHandler</a>
;============================================================================
</div><span class="l"><a name="Game_ExitBuilding" href="#Game_ExitBuilding" class="la">Game_ExitBuilding:</a><span class="ce">; [$de66]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Area_PrevRegion">Area_PrevRegion</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df34,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df3c,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df44,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Maybe_PrevScreen">Maybe_PrevScreen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Prev_Palette">Prev_Palette</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Prev_PlayerPosXY">Prev_PlayerPosXY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load the very first level.
;
; This will load the gates to Eolis, loading in all the
; area data, screen, tile data, and music.
;
; It also takes care of setting the player's initial HP.
;
; INPUTS:
;     <a href="#MAYBE_AREA_TO_PRG_ROM_BANKS">MAYBE_AREA_TO_PRG_ROM_BANKS</a>:
;         Mapping of areas to PRG ROM banks.
;
;     <a href="#MAYBE_AREA_BANK_TO_SPRITE_BANKS">MAYBE_AREA_BANK_TO_SPRITE_BANKS</a>:
;         Mapping of areas to sprite banks.
;
;     <a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>:
;         Mapping of areas to tile indexes.
;
;     <a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>:
;         Mapping of areas to music.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area (Eolis).
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen.
;
;     <a href="RAM.html#Screen_Palette">Screen_Palette</a>:
;         The palette for the area.
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The current screen index.
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The starting X/Y position.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the area.
;
;     CurrentROMBank:
;         The starting ROM bank.
;
;     <a href="RAM.html#CurrentMusic">CurrentMusic</a>:
;         The current music to play.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's starting HP (16).
;
;     <a href="RAM.html#TilesIndex">TilesIndex</a>:
;         The tiles index for the area.
;
; CALLS:
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;     <a href="#Screen_Load">Screen_Load</a>
;     <a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a>
;     <a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a>
;     <a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a>
;     <a href="#Player_SetInitialState">Player_SetInitialState</a>
;
; XREFS:
;     <a href="#Game_Start">Game_Start</a>
;============================================================================
</div><span class="l"><a name="Game_LoadFirstLevel" href="#Game_LoadFirstLevel" class="la">Game_LoadFirstLevel:</a><span class="ce">; [$dea7]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"></span>
<div class="c">;
; Set this as the current town.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Set the current area to 0 (Eolis).</span></span>
<span class="l"></span>
<div class="c">;
; Set the initial state of the player, and hard-code their
; health to the starting amount of 16HP.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetInitialState">Player_SetInitialState</a></span></span><span class="ce">; Set the initial player state.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Set the HP to 16.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = Current area</span></span>
<span class="l"></span>
<div class="c">;
; Load the block properties for this area.
;
; The bank containing the properties for the area will
; be loaded temporarily while fetching the block properties.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$df34,X</span></span><span class="ce">; A = PRG bank for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; Store as the current bank.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; X = current bank.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a></span></span><span class="ce">; Push the current bank and update to this area's bank.</span></span>
<span class="l"></span>
<div class="c">;
; Load the area information.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$df3c,X</span></span><span class="ce">; A = sprite bank for the area.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span><span class="ce">; Load the area information.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a></span></span><span class="ce">; Restore the previous bank.</span></span>
<span class="l"></span>
<div class="c">;
; Start on the current screen.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Current screen = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; Screen index = 0</span></span>
<span class="l"></span>
<div class="c">;
; Load the tiles and images for the area.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df44,X</span></span><span class="ce">; A = tiles index.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span><span class="ce">; Store that.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a></span></span><span class="ce">; Load the tileset pages for that index.</span></span>
<span class="l"></span>
<div class="c">;
; Load the palette for the area.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span><span class="ce">; Load the palette for that index.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df4c,X</span></span><span class="ce">; Load the palette.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span><span class="ce">; And store it as the current one for the area.</span></span>
<span class="l"></span>
<div class="c">;
; Load the music for this area.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$df5c,X</span></span><span class="ce">; Load the music for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; And store it as the current music.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; And as the default for the area.</span></span>
<span class="l"></span>
<div class="c">;
; Set the start X/Y position for the player as X=1, Y=9.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$91</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span><span class="ce">; Set start position.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span><span class="ce">; Load this screen.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load the information on the current area.
;
; This will load the area data, tile data, palette, and
; music.
;
; INPUTS:
;     <a href="#MAYBE_AREA_TO_PRG_ROM_BANKS">MAYBE_AREA_TO_PRG_ROM_BANKS</a>:
;         Mapping of areas to PRG ROM banks.
;
;     <a href="#MAYBE_AREA_BANK_TO_SPRITE_BANKS">MAYBE_AREA_BANK_TO_SPRITE_BANKS</a>:
;         Mapping of areas to sprite banks.
;
;     <a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>:
;         Mapping of areas to tile indexes.
;
;     <a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>:
;         Mapping of areas to music.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen.
;
;     <a href="RAM.html#Screen_Palette">Screen_Palette</a>:
;         The palette for the area.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the area.
;
;     CurrentROMBank:
;         The starting ROM bank.
;
;     <a href="RAM.html#CurrentMusic">CurrentMusic</a>:
;         The current music to play.
;
;     <a href="RAM.html#TilesIndex">TilesIndex</a>:
;         The tiles index for the area.
;
; CALLS:
;     <a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a>
;     <a href="#Screen_Load">Screen_Load</a>
;     <a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a>
;     <a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a>
;     <a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a>
;     <a href="#Player_SetInitialState">Player_SetInitialState</a>
;
; XREFS:
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;============================================================================
</div><span class="l"><a name="Game_LoadCurrentArea" href="#Game_LoadCurrentArea" class="la">Game_LoadCurrentArea:</a><span class="ce">; [$def5]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetInitialState">Player_SetInitialState</a></span></span><span class="ce">; Set the initial player state.</span></span>
<span class="l"></span>
<div class="c">;
; Load the bank for this area.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df34,X</span></span><span class="ce">; Load the ROM bank for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; Store that as the current bank.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; X = current bank.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a></span></span><span class="ce">; Save the current bank and switch to it.</span></span>
<span class="l"></span>
<div class="c">;
; Load the bank for the sprites for this area.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df3c,X</span></span><span class="ce">; A = bank for the sprites.</span></span>
<span class="l"></span>
<div class="c">;
; Load information on the area.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span><span class="ce">; Load the table of information on this area.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a></span></span><span class="ce">; Restore to the previous bank.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; A = current screen index.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Store as the current screen.</span></span>
<span class="l"></span>
<div class="c">;
; Load the tiles for the area.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df44,X</span></span><span class="ce">; A = tiles index for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span><span class="ce">; Store as the current tiles index.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a></span></span><span class="ce">; Load all tileset images for that index.</span></span>
<span class="l"></span>
<div class="c">;
; Load the palette for the area.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span><span class="ce">; Load palette 0.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df4c,X</span></span><span class="ce">; Load the palette for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span><span class="ce">; Store as the current palette.</span></span>
<span class="l"></span>
<div class="c">;
; Load the music for the area.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$df5c,X</span></span><span class="ce">; Load the music for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Store as the default.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span><span class="ce">; Load this screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of areas to the ROM banks containing PRG data.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;
</div><span class="l"><a name="MAYBE_AREA_TO_PRG_ROM_BANKS" href="#MAYBE_AREA_TO_PRG_ROM_BANKS" class="la">MAYBE_AREA_TO_PRG_ROM_BANKS:</a><span class="ce">; [$df34]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_0</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_1_SPRITES</span></span><span class="ce">; [1]: Between first town and Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_0</span></span><span class="ce">; [2]: Fog</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_0</span></span><span class="ce">; [3]: Town</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;
</div><span class="l"><a name="MAYBE_AREA_TO_PRG_ROM_BANKS_4_" href="#MAYBE_AREA_TO_PRG_ROM_BANKS_4_" class="la">MAYBE_AREA_TO_PRG_ROM_BANKS_4_:</a><span class="ce">; [$df38]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_2_SPRITES</span></span><span class="ce">; [4]: Building</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_1_SPRITES</span></span><span class="ce">; [5]: Tree world</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_2_SPRITES</span></span><span class="ce">; [6]: Last world</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_2_SPRITES</span></span><span class="ce">; [7]: Final maze</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;
</div><span class="l"><a name="MAYBE_AREA_BANK_TO_SPRITE_BANKS" href="#MAYBE_AREA_BANK_TO_SPRITE_BANKS" class="la">MAYBE_AREA_BANK_TO_SPRITE_BANKS:</a><span class="ce">; [$df3c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_0</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_1_SPRITES</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_2_SPRITES</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;
</div><span class="l"><a name="MAYBE_AREA_BANK_TO_SPRITE_BANKS_4_" href="#MAYBE_AREA_BANK_TO_SPRITE_BANKS_4_" class="la">MAYBE_AREA_BANK_TO_SPRITE_BANKS_4_:</a><span class="ce">; [$df40]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_1_SPRITES</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_1_SPRITES</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_0</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_2_SPRITES</span></span><span class="ce">; [7]:</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Pointers into 0xCF07 addressed by chunk ID
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;
</div><span class="l"><a name="CURRENT_AREA_TO_TILES_INDEX_TABLE" href="#CURRENT_AREA_TO_TILES_INDEX_TABLE" class="la">CURRENT_AREA_TO_TILES_INDEX_TABLE:</a><span class="ce">; [$df44]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Outside first town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]: First town</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [7]: Final boss room</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="PALETTES" href="#PALETTES" class="la">PALETTES:</a><span class="ce">; [$df4c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_EOLIS</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_DARTMOOR</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_EVIL_FORTRESS</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">00 00 00 00 00 00 00 00</span></span><span class="ce">; [$df54] undefined</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__df64">FUN_PRG15_MIRROR__df64</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a name="AREA_TO_MUSIC_TABLE" href="#AREA_TO_MUSIC_TABLE" class="la">AREA_TO_MUSIC_TABLE:</a><span class="ce">; [$df5c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_EOLIS</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_BETWEEN_FIRST_TOWN_FOG</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_FOG</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWN_BUILDING</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWN_BUILDING</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TREE_WORLD</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_LAST_WORLD</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_FINAL_MAZE</span></span><span class="ce">; [7]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__df64
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__dacd">FUN_PRG15_MIRROR__dacd</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__df64" href="#FUN_PRG15_MIRROR__df64" class="la">FUN_PRG15_MIRROR__df64:</a><span class="ce">; [$df64]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df34,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_SavePRGBankAndUpdateTo">MMC1_SavePRGBankAndUpdateTo</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df3c,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevPRGBank">MMC1_RestorePrevPRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df5c,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$df44,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TilesIndex">TilesIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#CHR_LoadTilesetPages">CHR_LoadTilesetPages</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Debug code to switch the current area region.
;
; This allows the player to control which part of the game
; they're in.
;
; By pressing Up on the second controller, the player will
; be moved up a region.
;
; By pressing Down, they player will be moved down a region.
;
; This isn't activated by default, but can be swapped in
; through the following Game Genie codes (overriding the
; ability to pause):
;
;     OPYISU
;     NIYIVU
;
; INPUTS:
;     <a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a>:
;         The second controller's button mask.
;
; OUTPUTS:
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The updated region.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         Set to 0.
;
; CALLS:
;     <a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a>
;============================================================================
</div><span class="l"><a name="Debug_ChooseArea" href="#Debug_ChooseArea" class="la">Debug_ChooseArea:</a><span class="ce">; [$df99]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a></span></span><span class="ce">; Load the player 2 controller buttons.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0c</span></span><span class="ce">; Is Up or Down pressed?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_DFDD">RETURN_DFDD</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Figure out which region to switch to based on button press.
;
</div><span class="l"><span><span class="i">AND</span> <span class="o">#$04</span></span><span class="ce">; Is Down pressed?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_nextArea">@_nextArea</a></span></span><span class="ce">; If so, switch to the next area.</span></span>
<span class="l"></span>
<div class="c">;
; Up was pressed. Go forward a region.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Increment the region.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; A = incremented region.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is it in bounds?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_switchArea">@_switchArea</a></span></span><span class="ce">; If so, switch to the area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Else...</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Set the region to (Eolis).</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_switchArea">@_switchArea</a></span></span><span class="ce">; And switch to it.</span></span>
<span class="l"></span>
<div class="c">;
; Down was pressed. Go back a region.
;
</div><span class="l"><a name="@_nextArea" href="#@_nextArea" class="lla">@_nextArea:</a><span class="ce">; [$dfb4]</span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Decrement the region.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_switchArea">@_switchArea</a></span></span><span class="ce">; If it's in bounds, switch to the previous area.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$05</span></span><span class="ce">; Else, set the region to the final fortress.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Store as the new region.</span></span>
<span class="l"></span>
<div class="c">;
; Set the current screen to 0 and load it.
;
</div><span class="l"><a name="@_switchArea" href="#@_switchArea" class="lla">@_switchArea:</a><span class="ce">; [$dfbe]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Set current screen to 0.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a></span></span><span class="ce">; Load the area.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document GameLoop_AnimateFog
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_AnimateFog" href="#GameLoop_AnimateFog" class="la">GameLoop_AnimateFog:</a><span class="ce">; [$dfc5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_PaletteIndex">Something_Maybe_PaletteIndex</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Fog_Index">Fog_Index</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#Game_AnimateFog_UpdatePPU">Game_AnimateFog_UpdatePPU</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Fog_Index">Fog_Index</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Debug_ChooseArea">Debug_ChooseArea</a>
;
</div><span class="l"><a name="RETURN_DFDD" href="#RETURN_DFDD" class="la">RETURN_DFDD:</a><span class="ce">; [$dfdd]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_AnimateFog_UpdatePPU
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_AnimateFog">GameLoop_AnimateFog</a>
;============================================================================
</div><span class="l"><a name="Game_AnimateFog_UpdatePPU" href="#Game_AnimateFog_UpdatePPU" class="la">Game_AnimateFog_UpdatePPU:</a><span class="ce">; [$dfde]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fc</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$18</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Fog_Index">Fog_Index</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Fog_Index">Fog_Index</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e012,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#FogGenerator">FogGenerator</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_AnimateFog">GameLoop_AnimateFog</a>
;     <a href="#Game_AnimateFog_UpdatePPU">Game_AnimateFog_UpdatePPU</a>
;
</div><span class="l"><a name="RETURN_E011" href="#RETURN_E011" class="la">RETURN_E011:</a><span class="ce">; [$e011]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_AnimateFog_UpdatePPU">Game_AnimateFog_UpdatePPU</a>
;
</div><span class="l"><a name="FOG_VALUES" href="#FOG_VALUES" class="la">FOG_VALUES:</a><span class="ce">; [$e012]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Check whether the Player Menu can and should be shown.
;
; The menu can be shown anywhere other than the first
; screen of the first town (where the game begins).
;
; If the menu can be shown, then it will be shown if
; the Select button has been pressed.
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen of the current area.
;
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The bitmask of newly-pressed buttons.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_CheckShowPlayerMenu" href="#GameLoop_CheckShowPlayerMenu" class="la">GameLoop_CheckShowPlayerMenu:</a><span class="ce">; [$e016]</span></span>
<div class="c">;
; Check to make sure we're not outside the walls of Eolis.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; A = current area.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_allowInventory">@_allowInventory</a></span></span><span class="ce">; If it's &gt; Eolis, the player can open the inventory. Jump.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; A = current screen.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_E02A">RETURN_E02A</a></span></span><span class="ce">; If it's 0, then we're outside the walls. No inventory allowed. Return.</span></span>
<span class="l"></span>
<span class="l"><a name="@_allowInventory" href="#@_allowInventory" class="lla">@_allowInventory:</a><span class="ce">; [$e01e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; A = controller 1 button mask.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Is Select pressed?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_E02A">RETURN_E02A</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Open the inventory via jump to <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Open the Player Menu.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a>
;     <a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a>
;
</div><span class="l"><a name="RETURN_E02A" href="#RETURN_E02A" class="la">RETURN_E02A:</a><span class="ce">; [$e02a]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Check whether the player has paused.
;
; If they have, then stay paused until the player
; unpauses.
;
; This function won't return until the player unpaused.
; While paused, <a href="RAM.html#PauseFlag">PauseFlag</a> will be set.
;
; INPUTS:
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The changed button mask to check.
;
; OUTPUTS:
;     <a href="RAM.html#PauseFlag">PauseFlag</a>:
;         1 while paused. 0 on return.
;
; CALLS:
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Wait3969Cycles">Wait3969Cycles</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_CheckPauseGame" href="#GameLoop_CheckPauseGame" class="la">GameLoop_CheckPauseGame:</a><span class="ce">; [$e02b]</span></span>
<div class="c">;
; Check if the player pressed Start.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Load the button state.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Check if the Pause button is pressed.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_E02A">RETURN_E02A</a></span></span><span class="ce">; If paused...</span></span>
<span class="l"></span>
<div class="c">;
; The player paused. Set the flag and wait until unpaused.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PauseFlag">PauseFlag</a></span></span><span class="ce">; Set the Paused flag.</span></span>
<span class="l"></span>
<span class="l"><a name="@_waitForUnpause" href="#@_waitForUnpause" class="lla">@_waitForUnpause:</a><span class="ce">; [$e036]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait...</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Wait3969Cycles">Wait3969Cycles</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if the player unpaused.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Check if the Pause button was pressed again.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_waitForUnpause">@_waitForUnpause</a></span></span><span class="ce">; Until pause is pressed again, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Unpause the game.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Clear the Paused flag.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PauseFlag">PauseFlag</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Update player state during a screen scroll.
;
; This will preserve the controller buttons that were
; pressed at the beginning of the screen scroll, regardless
; of any changes made to those buttons since.
;
; It will then position the player based off of a scroll
; transition counter, and increment that counter. This
; counter helps coordinate at which points the player's
; sprite appears to move and where it ends up.
;
; INPUTS:
;     <a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a>:
;         The controller 1 buttons pressed at the beginning
;         of the screen scroll.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The counter used to control player position during
;         scroll.
;
; OUTPUTS:
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The restored button mask.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The updated counter.
;
; CALLS:
;     <a href="#@_Game_MovePlayerOnScroll">@_Game_MovePlayerOnScroll</a>
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__d2ce">FUN_PRG15_MIRROR__d2ce</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="Game_UpdatePlayerOnScroll" href="#Game_UpdatePlayerOnScroll" class="la">Game_UpdatePlayerOnScroll:</a><span class="ce">; [$e048]</span></span>
<div class="c">;
; Preserve the previous pressed buttons while scrolling.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a></span></span><span class="ce">; Load the previous button mask.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set it as the current button mask.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#@_Game_MovePlayerOnScroll">@_Game_MovePlayerOnScroll</a></span></span><span class="ce">; Update the player position.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Increment the screen scroll transition counter.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The screen is scrolling to the screen to the left.
;
; If we're in the first 4 frames of the screen transition,
; move the player left 4px per frame until it wraps the
; screen.
;
</div><span class="l"><a name="@_scrollLeft" href="#@_scrollLeft" class="lla">@_scrollLeft:</a><span class="ce">; [$e052]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &gt;= 4?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_finishScrollLeft">@_finishScrollLeft</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$04</span></span><span class="ce">; Subtract 4.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Load our screen scroll counter.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$00</span></span><span class="ce">; Subtract carry.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Update <a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a> based on the
; player's X position.
;
</div><span class="l"><a name="@_finishScrollLeft" href="#@_finishScrollLeft" class="lla">@_finishScrollLeft:</a><span class="ce">; [$e065]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Move the player while the screen is scrolling.
;
; This will position the player on the screen based on the
; state of the screen scroll.
;
; When scrolling horizontally, it will inch the player
; toward the nearest screen boundary until it wraps.
;
; When scrolling vertically, nothing useful happens.
;
; NOTE: The function is full of useless code that's not
;       needed. Conditionals and variable settings that
;       never get used by anything else.
;
;       Y scrolling effects aren't in Faxanadu, and the
;       code managing that doesn't end up doing anything
;       useful.
;
;       For X scrolling, we set some variables that also
;       either don't get used or don't have any true
;       impact on the logic in which they're used.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a>:
;         The direction in which the screen is scrolling.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The transition counter used during screen scroll
;         to help position the player.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The player's current X position.
;
; OUTPUTS:
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The updated player position.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         An updated X value used during screen scroll.
;         This is set in the first 4 frames of scrolling
;         left or right, but is thought to ultimately be
;         useless.
;
;     <a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a>:
;     <a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a>
;         Ultimately unused values. Remnants of dead code.
;
; XREFS:
;     <a href="#Game_UpdatePlayerOnScroll">Game_UpdatePlayerOnScroll</a>
;============================================================================
</div><span class="l"><a name="@_Game_MovePlayerOnScroll" href="#@_Game_MovePlayerOnScroll" class="lla">@_Game_MovePlayerOnScroll:</a><span class="ce">; [$e06a]</span></span>
<div class="c">;
; Check which direction the screen is scrolling.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span><span class="ce">; Load the screen scroll direction.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_scrollLeft">@_scrollLeft</a></span></span><span class="ce">; If 0, jump to handle scrolling left.</span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_scrollRight">@_scrollRight</a></span></span><span class="ce">; If 1, jump to handle scrolling right.</span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_scrollUp">@_scrollUp</a></span></span><span class="ce">; If 2, jump to handle scrolling up.</span></span>
<span class="l"></span>
<div class="c">;
; The screen is scrolling to the screen below.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &lt; 8?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return1">@_return1</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return1" href="#@_return1" class="lla">@_return1:</a><span class="ce">; [$e082]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The screen is scrolling to the screen above.
;
</div><span class="l"><a name="@_scrollUp" href="#@_scrollUp" class="lla">@_scrollUp:</a><span class="ce">; [$e083]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &lt; 8?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return2">@_return2</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span><span class="ce">; Load the player Y position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return2" href="#@_return2" class="lla">@_return2:</a><span class="ce">; [$e091]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The screen is scrolling to the screen to the right.
;
; If we're in the first 4 frames of the screen transition,
; move the player right 4px per frame until it wraps the
; screen.
;
</div><span class="l"><a name="@_scrollRight" href="#@_scrollRight" class="lla">@_scrollRight:</a><span class="ce">; [$e092]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &gt;= 4?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_finishScrollRight">@_finishScrollRight</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Load our screen scroll counter.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Update <a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a> based on the
; player's X position.
;
</div><span class="l"><a name="@_finishScrollRight" href="#@_finishScrollRight" class="lla">@_finishScrollRight:</a><span class="ce">; [$e0a5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the initial state for a player on level load.
;
; This will face the player right, set their movement
; speed, status, disable invincibility, and other state.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         TODO
;
;     <a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a>:
;         TODO
;
;     <a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a>:
;         TODO
;
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;         The initial player movement speed (0 in
;         lower byte).
;
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The player's status (0).
;
;     <a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a>:
;         The invincibility phase (0).
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player will be facing right.
;
;     <a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a>:
;         TODO (set to 0xFF).
;
;     <a href="RAM.html#Maybe_Player_DAT_00ab">Maybe_Player_DAT_00ab</a>:
;         TODO (set to 2).
;
; XREFS:
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a name="Player_SetInitialState" href="#Player_SetInitialState" class="la">Player_SetInitialState:</a><span class="ce">; [$e0aa]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the starting speed, status, and iframes.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Set the player speed to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Set the player status to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Set the invincibility phase to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Face the player to the right.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$40</span></span><span class="ce">; 0x04 = Face player right bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Set that on the player's flags.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00ab">Maybe_Player_DAT_00ab</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;
</div><span class="l"><a name="RETURN_E0C9" href="#RETURN_E0C9" class="la">RETURN_E0C9:</a><span class="ce">; [$e0c9]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Check and update state for the player.
;
; This is run on every game tick to check what the
; player is doing and to update its state.
;
; This checks for attacking, climbing, jumping, iframes,
; entering doors, falling to the ground, pushing blocks,
; and moving between screens.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a>:
;         The current screen scroll direction.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a>
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;     <a href="#Player_HandleIFrames">Player_HandleIFrames</a>
;     Player_CheckHandleEnterDoor
;     <a href="#Player_FallToGround">Player_FallToGround</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_UpdatePlayer" href="#GameLoop_UpdatePlayer" class="la">GameLoop_UpdatePlayer:</a><span class="ce">; [$e0ca]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a></span></span><span class="ce">; Check if the player has attacked and handle it.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleJump">Player_CheckHandleJump</a></span></span><span class="ce">; Check if the player has jumped and handle it.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_HandleIFrames">Player_HandleIFrames</a></span></span><span class="ce">; Handle any pending iframes.</span></span>
<span class="l"></span>
<div class="c">;
; Check if screen scrolling is occurring.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span><span class="ce">; A = scrolling activity.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is the screen scrolling in either direction?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#RETURN_E0C9">RETURN_E0C9</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<div class="c">;
; The screen is not scrolling.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a></span></span><span class="ce">; Check if the player is entering a door.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_FallToGround">Player_FallToGround</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a></span></span><span class="ce">; Check if the player is pushing the block to open a path to Mascon.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a></span></span><span class="ce">; Check the block the player is on and handle it.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle any invincibility frames that may be set.
;
; Invincibility frames start at 0x3C.
;
; If the player has invincibility frames, the frame counter
; will be reduced by 1.
;
; The user's knockback will be reset when the counter hits
; 0x38, at which point the player can safely move.
;
; The user is invincible until the counter hits 0.
;
; INPUTS:
;     <a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a>:
;         The current invincibility phase, from 0x3C to 0.
;
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The player's current status flag.
;
; OUTPUTS:
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The new status flag with knockback removed, when
;         hitting 0x39 or lower.
;
; CALLS:
;     <a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a>
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_HandleIFrames" href="#Player_HandleIFrames" class="la">Player_HandleIFrames:</a><span class="ce">; [$e0e8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Check the current invincibility phase.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_removeIFrames">@_removeIFrames</a></span></span><span class="ce">; If the phase is now 1, remove iframe status.</span></span>
<span class="l"></span>
<div class="c">;
; Invincibility is active. Reduce it by 1.
;
</div><span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Reduce our invincibility phase by 1.</span></span>
<span class="l"></span>
<div class="c">;
; Check where we are in the phase. It starts at 0x3C, and
; until it hits 0x39, it will be in knockback phase.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Check the invincibility phase.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$39</span></span><span class="ce">; Is it 0x39?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_resetSpeed">@_resetSpeed</a></span></span><span class="ce">; If so, reset the speed but don't change the player status.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_removeIFrames">@_removeIFrames</a></span></span><span class="ce">; If not over, update the player status.</span></span>
<span class="l"></span>
<div class="c">;
; Set the knockback speed and return, leaving the knockback
; state intact.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the knockback speed, but then clear the knockback.
;
</div><span class="l"><a name="@_resetSpeed" href="#@_resetSpeed" class="lla">@_resetSpeed:</a><span class="ce">; [$e0f9]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Reset the player speed.</span></span>
<span class="l"></span>
<div class="c">;
; Clear knockback from the player flags.
;
</div><span class="l"><a name="@_removeIFrames" href="#@_removeIFrames" class="lla">@_removeIFrames:</a><span class="ce">; [$e0fc]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fd</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleAttack
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleAttack" href="#Player_CheckHandleAttack" class="la">Player_CheckHandleAttack:</a><span class="ce">; [$e103]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e132">@LAB_PRG15_MIRROR__e132</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_IsClimbing">Player_IsClimbing</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e119">@LAB_PRG15_MIRROR__e119</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e119">@LAB_PRG15_MIRROR__e119</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e120">@LAB_PRG15_MIRROR__e120</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e119" href="#@LAB_PRG15_MIRROR__e119" class="lla">@LAB_PRG15_MIRROR__e119:</a><span class="ce">; [$e119]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fe</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e120" href="#@LAB_PRG15_MIRROR__e120" class="lla">@LAB_PRG15_MIRROR__e120:</a><span class="ce">; [$e120]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e132" href="#@LAB_PRG15_MIRROR__e132" class="lla">@LAB_PRG15_MIRROR__e132:</a><span class="ce">; [$e132]</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$e150,X</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e149">@LAB_PRG15_MIRROR__e149</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$e148]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e149" href="#@LAB_PRG15_MIRROR__e149" class="lla">@LAB_PRG15_MIRROR__e149:</a><span class="ce">; [$e149]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;
</div><span class="l"><a name="RETURN_E14F" href="#RETURN_E14F" class="la">RETURN_E14F:</a><span class="ce">; [$e14f]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__e150" href="#BYTE_ARRAY_PRG15_MIRROR__e150" class="la">BYTE_ARRAY_PRG15_MIRROR__e150:</a><span class="ce">; [$e150]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle knockback when getting hit.
;
; This will knock the player back in the direction opposite
; where the player was facing.
;
; It will temporarily flip the facing bit and then move in
; that direction. The original bit will then be restored.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's flags.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated flags, with any new state applied
;         from the move but the flipped bit retained.
;
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a>
;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;============================================================================
</div><span class="l"><a name="Player_HandleKnockback" href="#Player_HandleKnockback" class="la">Player_HandleKnockback:</a><span class="ce">; [$e153]</span></span>
<div class="c">;
; Temporarily store the player's current flags.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Take only the facing bit.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Flip the facing bit and knock back in the flipped direction.
;
</div><span class="l"><span><span class="i">EOR</span> <span class="o">#$40</span></span><span class="ce">; Flip the facing bit temporarily for the purpose of knockback.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store as the new flags.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a></span></span><span class="ce">; Move based on the facing bit.</span></span>
<span class="l"></span>
<div class="c">;
; Restore the original flags, merging with any updated bits
; from the move.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the original flags.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the flags set above.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$bf</span></span><span class="ce">; Clear the facing bit.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; OR with the original facing bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Move the player left or right due to knockback.
;
; The player will be knocked back based on the direction
; they're facing.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;
; XREFS:
;     <a href="#Player_HandleKnockback">Player_HandleKnockback</a>
;============================================================================
</div><span class="l"><a name="Player_KnockbackHoriz" href="#Player_KnockbackHoriz" class="la">Player_KnockbackHoriz:</a><span class="ce">; [$e16b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is the player facing right?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Player_TryMoveRight">Player_TryMoveRight</a></span></span><span class="ce">; If so, move right.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleJump
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleJump" href="#Player_CheckHandleJump" class="la">Player_CheckHandleJump:</a><span class="ce">; [$e174]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#RETURN_E14F">RETURN_E14F</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Player_HandleKnockback">Player_HandleKnockback</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_playerCanFly">@_playerCanFly</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_playerCanFly">@_playerCanFly</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_playerNotMoving">@_playerNotMoving</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Player_TryMoveRight">Player_TryMoveRight</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_playerCanFly" href="#@_playerCanFly" class="lla">@_playerCanFly:</a><span class="ce">; [$e197]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1be">@LAB_PRG15_MIRROR__e1be</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_playerNotMoving">@_playerNotMoving</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_TryMoveRight">Player_TryMoveRight</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_playerNotMoving">@_playerNotMoving</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_playerNotMoving" href="#@_playerNotMoving" class="lla">@_playerNotMoving:</a><span class="ce">; [$e1ac]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0c</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1be">@LAB_PRG15_MIRROR__e1be</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1be">@LAB_PRG15_MIRROR__e1be</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1c5">@LAB_PRG15_MIRROR__e1c5</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e1be" href="#@LAB_PRG15_MIRROR__e1be" class="lla">@LAB_PRG15_MIRROR__e1be:</a><span class="ce">; [$e1be]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$df</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e1c5" href="#@LAB_PRG15_MIRROR__e1c5" class="lla">@LAB_PRG15_MIRROR__e1c5:</a><span class="ce">; [$e1c5]</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Try moving the player right.
;
; This is used when handling knockback or jumping. It will
; move based on any existing acceleration, or the default
; if the player wasn't previously moving, and then try to
; position the player. That may position up againt a block,
; at the edge of the screen, or onto the next screen.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;     <a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a>:
;         The player's current X position.
;
;     <a href="RAM.html#Area_ScreenToTheRight">Area_ScreenToTheRight</a>:
;         The ID of the screen to the right.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The counter used for scrolling.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated flags.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;     <a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a>:
;         The updated player X position.
;
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;         The updated move acceleration.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The new screen, if switching screens.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The updated counter used for scrolling.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The transition counter for the player movement,
;         if scrolling screens.
;
; CALLS:
;     <a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a>
;     <a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a>
;     <a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a>
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;     <a href="#Player_SetPosAtRightEdge">Player_SetPosAtRightEdge</a>
;     <a href="#Screen_IsEdge">Screen_IsEdge</a>
;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;     <a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a>
;============================================================================
</div><span class="l"><a name="Player_TryMoveRight" href="#Player_TryMoveRight" class="la">Player_TryMoveRight:</a><span class="ce">; [$e1cf]</span></span>
<div class="c">;
; Check whether the player is moving.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Check the moving bit.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_setMoving">@_setMoving</a></span></span><span class="ce">; If set, jump to handle movement.</span></span>
<span class="l"></span>
<div class="c">;
; The player is not moving. Reset the movement speed.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Start with the standard acceleration.</span></span>
<span class="l"></span>
<div class="c">;
; Calculate movement speed and set the player to move to
; the right.
;
</div><span class="l"><a name="@_setMoving" href="#@_setMoving" class="lla">@_setMoving:</a><span class="ce">; [$e1d8]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a></span></span><span class="ce">; Calculate the new walking speed.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$60</span></span><span class="ce">; Set moving and to the right.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store as the new flags.</span></span>
<span class="l"></span>
<div class="c">;
; Update the player's X position to factor in acceleration.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a></span></span><span class="ce">; Load the fractional X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Add the move acceleration.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a></span></span><span class="ce">; Store as the new fractional position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the full X position.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span><span class="ce">; Add the move acceleration.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the block there is passable.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span><span class="ce">; Is the block to the right passable?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_checkAtRightEdge">@_checkAtRightEdge</a></span></span><span class="ce">; If not, jump to check for an edge or transition boundary.</span></span>
<span class="l"></span>
<div class="c">;
; The block is not passable. Cap the position.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Cap it.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if the player is far enough to the right for
; any screen transition logic.
;
</div><span class="l"><a name="@_checkAtRightEdge" href="#@_checkAtRightEdge" class="lla">@_checkAtRightEdge:</a><span class="ce">; [$e1fe]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; X = Player X position.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f1</span></span><span class="ce">; Is it too far left to perform a screen transition?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the player is at the edge and can scroll.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span><span class="ce">; Check if the screen is the right-most edge.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_SetPosAtRightEdge">Player_SetPosAtRightEdge</a></span></span><span class="ce">; If so, jump to set the position there.</span></span>
<span class="l"></span>
<div class="c">;
; There's a screen to the right. Transition there.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheRight">Area_ScreenToTheRight</a></span></span><span class="ce">; A = Neighboring screen to the right.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Store as the new current screen.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a></span></span><span class="ce">; Begin scrolling to the right.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Increment the scroll counter.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Clear the transition counter.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$e21a]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Position the player at the right edge of the screen.
;
; The player will be positioned at 0xF0.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The updated X position.
;
; XREFS:
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a name="Player_SetPosAtRightEdge" href="#Player_SetPosAtRightEdge" class="la">Player_SetPosAtRightEdge:</a><span class="ce">; [$e21b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Set the X position to 0xF0.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Try moving the player left.
;
; This is used when handling knockback or jumping. It will
; move based on any existing acceleration, or the default
; if the player wasn't previously moving, and then try to
; position the player. That may position up againt a block,
; at the edge of the screen, or onto the next screen.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;     <a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a>:
;         The player's current X position.
;
;     <a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a>:
;         The ID of the screen to the left.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The counter used for scrolling.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated flags.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;     <a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a>:
;         The updated player X position.
;
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;         The updated move acceleration.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The new screen, if switching screens.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The updated counter used for scrolling.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The transition counter for the player movement,
;         if scrolling screens.
;
; CALLS:
;     <a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a>
;     <a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a>
;     <a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a>
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;     <a href="#Player_SetPosAtRightEdge">Player_SetPosAtRightEdge</a>
;     <a href="#Screen_IsEdge">Screen_IsEdge</a>
;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;     <a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a>
;============================================================================
</div><span class="l"><a name="Player_TryMoveLeft" href="#Player_TryMoveLeft" class="la">Player_TryMoveLeft:</a><span class="ce">; [$e220]</span></span>
<div class="c">;
; Check whether the player is moving.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Check the moving bit.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_setMoving">@_setMoving</a></span></span><span class="ce">; If set, jump to handle movement.</span></span>
<span class="l"></span>
<div class="c">;
; The player is not moving. Reset the movement speed.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Start with the standard acceleration.</span></span>
<span class="l"></span>
<div class="c">;
; Calculate movement speed and set the player to move to
; the left.
;
</div><span class="l"><a name="@_setMoving" href="#@_setMoving" class="lla">@_setMoving:</a><span class="ce">; [$e229]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a></span></span><span class="ce">; Calculate the new walking speed.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$bf</span></span><span class="ce">; Set the player to face left.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$20</span></span><span class="ce">; Set the player to moving.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store as the new flags.</span></span>
<span class="l"></span>
<div class="c">;
; Update the player's X position to factor in acceleration.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a></span></span><span class="ce">; Load the fractional X position.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Subtract the move acceleration.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Frac">PlayerPosX_Frac</a></span></span><span class="ce">; Store as the new fractional position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the full X position.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span><span class="ce">; Subtract the move acceleration.</span></span>
<span class="l"><span><span class="i">PHP</span></span><span class="ce">; Push all flags.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_saveFlags">@_saveFlags</a></span></span><span class="ce">; If &gt;= 0, jump.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Else, cap at 0, so it doesn't wrap.</span></span>
<span class="l"></span>
<span class="l"><a name="@_saveFlags" href="#@_saveFlags" class="lla">@_saveFlags:</a><span class="ce">; [$e244]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Store the new X position.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the block there is passable.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span><span class="ce">; Is the block to the left passable?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_checkAtLeftEdge">@_checkAtLeftEdge</a></span></span><span class="ce">; If not, jump to check for an edge or transition boundary.</span></span>
<span class="l"></span>
<div class="c">;
; The block is not passable. Cap the position.
;
</div><span class="l"><span><span class="i">PLP</span></span><span class="ce">; Pop the flags from the acceleration calculation.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Is this in the first 16 pixels?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return1">@_return1</a></span></span><span class="ce">; If so, we're done.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Keep all but pixels 0-16.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Add 16 pixels.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Store as the new position.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return1" href="#@_return1" class="lla">@_return1:</a><span class="ce">; [$e25d]</span></span>
<span class="l"><span><span class="i">RTS</span></span><span class="ce">; And we're done.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the player is far enough to the left for
; any screen transition logic.
;
</div><span class="l"><a name="@_checkAtLeftEdge" href="#@_checkAtLeftEdge" class="lla">@_checkAtLeftEdge:</a><span class="ce">; [$e25e]</span></span>
<span class="l"><span><span class="i">PLP</span></span><span class="ce">; Pop the flags from the acceleration calculation.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return2">@_return2</a></span></span><span class="ce">; If it didn't overflow off the left, return.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the player is at the edge and can scroll.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span><span class="ce">; Check if the screen is the left-most edge.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_setAtLeftEdge">@_setAtLeftEdge</a></span></span><span class="ce">; If at the edge, jump to cap the position.</span></span>
<span class="l"></span>
<div class="c">;
; There's a screen to the left. Transition there.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a></span></span><span class="ce">; A = Neighboring screen to the left.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Store as the new current screen.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a></span></span><span class="ce">; Begin scrolling to the left.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Set the X position to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Clear the transition counter.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return2" href="#@_return2" class="lla">@_return2:</a><span class="ce">; [$e277]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The player is at the left-most edge, but didn't pass it.
;
</div><span class="l"><a name="@_setAtLeftEdge" href="#@_setAtLeftEdge" class="lla">@_setAtLeftEdge:</a><span class="ce">; [$e278]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Set the X position to 0.</span></span>
<span class="l"><span><span class="i">RTS</span></span><span class="ce">; And return.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the standard player acceleration.
;
; This will set to the default aceleration of 0xC0.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;     #$aa:
;         The default acceleration (0xC0).
;
; XREFS:
;     <a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a>
;     <a href="#Player_HandleIFrames">Player_HandleIFrames</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a name="Player_SetStandardAcceleration" href="#Player_SetStandardAcceleration" class="la">Player_SetStandardAcceleration:</a><span class="ce">; [$e27f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Set the lower byte of movement acceleation to 0xC0.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span><span class="ce">; Set the upper byte to 0.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Update the player's position based on knockback.
;
; This will accelerate the player by 8 pixels when its
; position is next updated.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;     #$aa:
;         The updated acceleration.
;
; XREFS:
;     <a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a>
;============================================================================
</div><span class="l"><a name="Player_UpdatePosFromKnockback" href="#Player_UpdatePosFromKnockback" class="la">Player_UpdatePosFromKnockback:</a><span class="ce">; [$e288]</span></span>
<div class="c">;
; The player's in knockback state. Bump the player
; back a bunch.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Set lower acceleration byte to 0.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span><span class="ce">; Set upper to 8.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_CalcSpeed
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_CalcSpeed" href="#Maybe_Player_CalcSpeed" class="la">Maybe_Player_CalcSpeed:</a><span class="ce">; [$e291]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Player_UpdatePosFromKnockback">Player_UpdatePosFromKnockback</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0c</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2a3">@LAB_PRG15_MIRROR__e2a3</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e2a3" href="#@LAB_PRG15_MIRROR__e2a3" class="lla">@LAB_PRG15_MIRROR__e2a3:</a><span class="ce">; [$e2a3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$e2c4,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration.U">Player_MoveAcceleration.U</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$e2c3]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Player_CalcSpeed">Maybe_Player_CalcSpeed</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__e2c4" href="#BYTE_ARRAY_PRG15_MIRROR__e2c4" class="la">BYTE_ARRAY_PRG15_MIRROR__e2c4:</a><span class="ce">; [$e2c4]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [3]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimb
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleClimb" href="#Player_CheckHandleClimb" class="la">Player_CheckHandleClimb:</a><span class="ce">; [$e2c8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; A = Player status flags.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2d6">@LAB_PRG15_MIRROR__e2d6</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2d6">@LAB_PRG15_MIRROR__e2d6</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2f4">@LAB_PRG15_MIRROR__e2f4</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e2d6" href="#@LAB_PRG15_MIRROR__e2d6" class="lla">@LAB_PRG15_MIRROR__e2d6:</a><span class="ce">; [$e2d6]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2fe">@LAB_PRG15_MIRROR__e2fe</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0c</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2fe">@LAB_PRG15_MIRROR__e2fe</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2f4">@LAB_PRG15_MIRROR__e2f4</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e2f4" href="#@LAB_PRG15_MIRROR__e2f4" class="lla">@LAB_PRG15_MIRROR__e2f4:</a><span class="ce">; [$e2f4]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e2fe" href="#@LAB_PRG15_MIRROR__e2fe" class="lla">@LAB_PRG15_MIRROR__e2fe:</a><span class="ce">; [$e2fe]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimbUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleClimbUp" href="#Player_CheckHandleClimbUp" class="la">Player_CheckHandleClimbUp:</a><span class="ce">; [$e301]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$da</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e343">@LAB_PRG15_MIRROR__e343</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e31e">@LAB_PRG15_MIRROR__e31e</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e32b">@LAB_PRG15_MIRROR__e32b</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e31e" href="#@LAB_PRG15_MIRROR__e31e" class="lla">@LAB_PRG15_MIRROR__e31e:</a><span class="ce">; [$e31e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$a0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e32b" href="#@LAB_PRG15_MIRROR__e32b" class="lla">@LAB_PRG15_MIRROR__e32b:</a><span class="ce">; [$e32b]</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e343">@LAB_PRG15_MIRROR__e343</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e344">@LAB_PRG15_MIRROR__e344</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenAbove">Area_ScreenAbove</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e343" href="#@LAB_PRG15_MIRROR__e343" class="lla">@LAB_PRG15_MIRROR__e343:</a><span class="ce">; [$e343]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e344" href="#@LAB_PRG15_MIRROR__e344" class="lla">@LAB_PRG15_MIRROR__e344:</a><span class="ce">; [$e344]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimbDown
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleClimbDown" href="#Player_CheckHandleClimbDown" class="la">Player_CheckHandleClimbDown:</a><span class="ce">; [$e349]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$da</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_E393">RETURN_E393</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e36c">@LAB_PRG15_MIRROR__e36c</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_MoveDownScreen">Player_MoveDownScreen</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e36c" href="#@LAB_PRG15_MIRROR__e36c" class="lla">@LAB_PRG15_MIRROR__e36c:</a><span class="ce">; [$e36c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_MoveDownScreen
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a>
;============================================================================
</div><span class="l"><a name="Player_MoveDownScreen" href="#Player_MoveDownScreen" class="la">Player_MoveDownScreen:</a><span class="ce">; [$e379]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$c1</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#RETURN_E393">RETURN_E393</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_SetPosAtBottomEdge">Player_SetPosAtBottomEdge</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenBelow">Area_ScreenBelow</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a>
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;
</div><span class="l"><a name="RETURN_E393" href="#RETURN_E393" class="la">RETURN_E393:</a><span class="ce">; [$e393]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the player at the bottom-most position of the screen.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#PlayerPosY">PlayerPosY</a>:
;         The updated player position (set to 0xC0).
;
; XREFS:
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;============================================================================
</div><span class="l"><a name="Player_SetPosAtBottomEdge" href="#Player_SetPosAtBottomEdge" class="la">Player_SetPosAtBottomEdge:</a><span class="ce">; [$e394]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span><span class="ce">; Set player Y position to 0xC0 (192).</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimbMaybeSide
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleClimbMaybeSide" href="#Player_CheckHandleClimbMaybeSide" class="la">Player_CheckHandleClimbMaybeSide:</a><span class="ce">; [$e399]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3a5">@LAB_PRG15_MIRROR__e3a5</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Clear the player's Jumping state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fe</span></span><span class="ce">; Clear the Jumping bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Save it back.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3a5" href="#@LAB_PRG15_MIRROR__e3a5" class="lla">@LAB_PRG15_MIRROR__e3a5:</a><span class="ce">; [$e3a5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3ad">@LAB_PRG15_MIRROR__e3ad</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_StayOnLadderAndContinue">Player_StayOnLadderAndContinue</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3ad" href="#@LAB_PRG15_MIRROR__e3ad" class="lla">@LAB_PRG15_MIRROR__e3ad:</a><span class="ce">; [$e3ad]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3b7">@LAB_PRG15_MIRROR__e3b7</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_StayOnLadderAndContinue">Player_StayOnLadderAndContinue</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3b7" href="#@LAB_PRG15_MIRROR__e3b7" class="lla">@LAB_PRG15_MIRROR__e3b7:</a><span class="ce">; [$e3b7]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3cd">@LAB_PRG15_MIRROR__e3cd</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3c9">@LAB_PRG15_MIRROR__e3c9</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3c9" href="#@LAB_PRG15_MIRROR__e3c9" class="lla">@LAB_PRG15_MIRROR__e3c9:</a><span class="ce">; [$e3c9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3cd" href="#@LAB_PRG15_MIRROR__e3cd" class="lla">@LAB_PRG15_MIRROR__e3cd:</a><span class="ce">; [$e3cd]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3d1">@LAB_PRG15_MIRROR__e3d1</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3d1" href="#@LAB_PRG15_MIRROR__e3d1" class="lla">@LAB_PRG15_MIRROR__e3d1:</a><span class="ce">; [$e3d1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Player_StayOnLadderAndContinue">Player_StayOnLadderAndContinue</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3f5">@LAB_PRG15_MIRROR__e3f5</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3f5">@LAB_PRG15_MIRROR__e3f5</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_MoveDownOneScreen">Maybe_MoveDownOneScreen</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e3f5" href="#@LAB_PRG15_MIRROR__e3f5" class="lla">@LAB_PRG15_MIRROR__e3f5:</a><span class="ce">; [$e3f5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_MoveDownOneScreen
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a name="Maybe_MoveDownOneScreen" href="#Maybe_MoveDownOneScreen" class="la">Maybe_MoveDownOneScreen:</a><span class="ce">; [$e3fc]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$c1</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e41e">@LAB_PRG15_MIRROR__e41e</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e40e">@LAB_PRG15_MIRROR__e40e</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e42c">@LAB_PRG15_MIRROR__e42c</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e40e" href="#@LAB_PRG15_MIRROR__e40e" class="lla">@LAB_PRG15_MIRROR__e40e:</a><span class="ce">; [$e40e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenBelow">Area_ScreenBelow</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e41e" href="#@LAB_PRG15_MIRROR__e41e" class="lla">@LAB_PRG15_MIRROR__e41e:</a><span class="ce">; [$e41e]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e42b">@LAB_PRG15_MIRROR__e42b</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e42b" href="#@LAB_PRG15_MIRROR__e42b" class="lla">@LAB_PRG15_MIRROR__e42b:</a><span class="ce">; [$e42b]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e42c" href="#@LAB_PRG15_MIRROR__e42c" class="lla">@LAB_PRG15_MIRROR__e42c:</a><span class="ce">; [$e42c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_ClearJumpingAndHoldingToClimb
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;============================================================================
</div><span class="l"><a name="Player_ClearJumpingAndHoldingToClimb" href="#Player_ClearJumpingAndHoldingToClimb" class="la">Player_ClearJumpingAndHoldingToClimb:</a><span class="ce">; [$e433]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fc</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a name="RETURN_E439" href="#RETURN_E439" class="la">RETURN_E439:</a><span class="ce">; [$e439]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_StayOnLadderAndContinue
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a name="Player_StayOnLadderAndContinue" href="#Player_StayOnLadderAndContinue" class="la">Player_StayOnLadderAndContinue:</a><span class="ce">; [$e43a]</span></span>
<div class="c">;
; Clear the Falling Off state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fb</span></span><span class="ce">; Clear the Falling Off flag.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Save it back.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_ContinueHandleClimbOrJump
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a name="Player_ContinueHandleClimbOrJump" href="#Player_ContinueHandleClimbOrJump" class="la">Player_ContinueHandleClimbOrJump:</a><span class="ce">; [$e444]</span></span>
<div class="c">;
; Check if the player is jumping.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the Jump flag into Carry.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_isJumping">@_isJumping</a></span></span><span class="ce">; If set (player is jumping), then jump (branch).</span></span>
<span class="l"></span>
<div class="c">;
; The player is not jumping.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; X = Controller 1 changed button mask.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#Player_ClearJumpingAndHoldingToClimb">Player_ClearJumpingAndHoldingToClimb</a></span></span><span class="ce">; If the player is holding down A, then check grabbing for a ladder and return.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_IsClimbing">Player_IsClimbing</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#RETURN_E439">RETURN_E439</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_E4B6">RETURN_E4B6</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_isJumping" href="#@_isJumping" class="lla">@_isJumping:</a><span class="ce">; [$e463]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e46b">@LAB_PRG15_MIRROR__e46b</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e4a2">@LAB_PRG15_MIRROR__e4a2</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e46b" href="#@LAB_PRG15_MIRROR__e46b" class="lla">@LAB_PRG15_MIRROR__e46b:</a><span class="ce">; [$e46b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$e4d6,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e481">@LAB_PRG15_MIRROR__e481</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#Area_ScrollScreenUp">Area_ScrollScreenUp</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e49a">@LAB_PRG15_MIRROR__e49a</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e481" href="#@LAB_PRG15_MIRROR__e481" class="lla">@LAB_PRG15_MIRROR__e481:</a><span class="ce">; [$e481]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Area_Something_IncDAT00a6">Area_Something_IncDAT00a6</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e49a">@LAB_PRG15_MIRROR__e49a</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e49a" href="#@LAB_PRG15_MIRROR__e49a" class="lla">@LAB_PRG15_MIRROR__e49a:</a><span class="ce">; [$e49a]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Area_Something_IncDAT00a6">Area_Something_IncDAT00a6</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e4a2" href="#@LAB_PRG15_MIRROR__e4a2" class="lla">@LAB_PRG15_MIRROR__e4a2:</a><span class="ce">; [$e4a2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$e4d6,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#FUN_PRG15_MIRROR__e4c9">FUN_PRG15_MIRROR__e4c9</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a name="Area_Something_IncDAT00a6" href="#Area_Something_IncDAT00a6" class="la">Area_Something_IncDAT00a6:</a><span class="ce">; [$e4b1]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a name="RETURN_E4B6" href="#RETURN_E4B6" class="la">RETURN_E4B6:</a><span class="ce">; [$e4b6]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_ScrollScreenUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;============================================================================
</div><span class="l"><a name="Area_ScrollScreenUp" href="#Area_ScrollScreenUp" class="la">Area_ScrollScreenUp:</a><span class="ce">; [$e4b7]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenAbove">Area_ScreenAbove</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_BeginScrollToNextRoom">Area_BeginScrollToNextRoom</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__e4c9">FUN_PRG15_MIRROR__e4c9</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__e4c9
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ScrollScreenUp">Area_ScrollScreenUp</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__e4c9" href="#FUN_PRG15_MIRROR__e4c9" class="la">FUN_PRG15_MIRROR__e4c9:</a><span class="ce">; [$e4c9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$fe</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__e4d6" href="#BYTE_ARRAY_PRG15_MIRROR__e4d6" class="la">BYTE_ARRAY_PRG15_MIRROR__e4d6:</a><span class="ce">; [$e4d6]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [12]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [15]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [16]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [17]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [18]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [20]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [21]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [22]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [23]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [24]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [25]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [26]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [27]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [28]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [29]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [30]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [31]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CheckCanClimbAdjacent
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a name="Area_CheckCanClimbAdjacent" href="#Area_CheckCanClimbAdjacent" class="la">Area_CheckCanClimbAdjacent:</a><span class="ce">; [$e4f6]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e51f">@LAB_PRG15_MIRROR__e51f</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e503">@LAB_PRG15_MIRROR__e503</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e503" href="#@LAB_PRG15_MIRROR__e503" class="lla">@LAB_PRG15_MIRROR__e503:</a><span class="ce">; [$e503]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$e524,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e51f">@LAB_PRG15_MIRROR__e51f</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e51f" href="#@LAB_PRG15_MIRROR__e51f" class="lla">@LAB_PRG15_MIRROR__e51f:</a><span class="ce">; [$e51f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;
</div><span class="l"><a name="DAT_PRG15_MIRROR__e524" href="#DAT_PRG15_MIRROR__e524" class="la">DAT_PRG15_MIRROR__e524:</a><span class="ce">; [$e524]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [$e524] undefined1</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;
</div><span class="l"><a name="DAT_PRG15_MIRROR__e525" href="#DAT_PRG15_MIRROR__e525" class="la">DAT_PRG15_MIRROR__e525:</a><span class="ce">; [$e525]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [$e525] undefined1</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckHandleEnterDoor
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_CheckHandleEnterDoor" href="#Player_CheckHandleEnterDoor" class="la">Player_CheckHandleEnterDoor:</a><span class="ce">; [$e526]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a></span></span><span class="ce">; Set the new state based on the other end of the door.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Check the result of that.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$fe</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The player is going inside.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_CheckDoorRequirement">Game_CheckDoorRequirement</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The door is not locked.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$06</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_paletteCheckLoop" href="#@_paletteCheckLoop" class="lla">@_paletteCheckLoop:</a><span class="ce">; [$e54c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$e569,X</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_setupArea">@_setupArea</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_paletteCheckLoop">@_paletteCheckLoop</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_enterScreen">@_enterScreen</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_setupArea" href="#@_setupArea" class="lla">@_setupArea:</a><span class="ce">; [$e558]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e570,X</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_enterScreen">@_enterScreen</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_enterScreen" href="#@_enterScreen" class="lla">@_enterScreen:</a><span class="ce">; [$e565]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$e568]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__e569_5_" href="#BYTE_ARRAY_PRG15_MIRROR__e569_5_" class="la">BYTE_ARRAY_PRG15_MIRROR__e569_5_:</a><span class="ce">; [$e56e]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [5]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__e569_6_" href="#BYTE_ARRAY_PRG15_MIRROR__e569_6_" class="la">BYTE_ARRAY_PRG15_MIRROR__e569_6_:</a><span class="ce">; [$e56f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_BETWEEN_FIRST_TOWN_FOG</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_FOG</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_LAST_WORLD</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a name="Music_ARRAY_PRG15_MIRROR__e570_5_" href="#Music_ARRAY_PRG15_MIRROR__e570_5_" class="la">Music_ARRAY_PRG15_MIRROR__e570_5_:</a><span class="ce">; [$e575]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [5]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a name="Music_ARRAY_PRG15_MIRROR__e570_6_" href="#Music_ARRAY_PRG15_MIRROR__e570_6_" class="la">Music_ARRAY_PRG15_MIRROR__e570_6_:</a><span class="ce">; [$e576]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [6]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_EnterDoorToInside
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a name="Player_EnterDoorToInside" href="#Player_EnterDoorToInside" class="la">Player_EnterDoorToInside:</a><span class="ce">; [$e577]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewCurrentScreen">Something_Maybe_NewCurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e609,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e613,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_Maybe_NewTilesIndex">Something_Maybe_NewTilesIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e61d,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e5ff,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Where does this door take the player?
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e5a6">@LAB_PRG15_MIRROR__e5a6</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Game_MainExitBuildingHandler">Maybe_Game_MainExitBuildingHandler</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e5a6" href="#@LAB_PRG15_MIRROR__e5a6" class="lla">@LAB_PRG15_MIRROR__e5a6:</a><span class="ce">; [$e5a6]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$bf</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Game_EnterBuildingHandler">Maybe_Game_EnterBuildingHandler</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_EnterDoorToOutside
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a name="Player_EnterDoorToOutside" href="#Player_EnterDoorToOutside" class="la">Player_EnterDoorToOutside:</a><span class="ce">; [$e5b2]</span></span>
<div class="c">;
; The player opened a door back to the outside.
;
</div><span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"></span>
<div class="c">;
; Check if the door is locked.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$e5db,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_CheckDoorRequirement">Game_CheckDoorRequirement</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#SUB_RETURN_E5DA">SUB_RETURN_E5DA</a></span></span></span>
<span class="l"></span>
<div class="c">;
; This door is not locked.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$e5e7,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e5f3,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_SetupAndLoadArea">Game_SetupAndLoadArea</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a name="SUB_RETURN_E5DA" href="#SUB_RETURN_E5DA" class="la">SUB_RETURN_E5DA:</a><span class="ce">; [$e5da]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a name="DOOR_LOOKUP_REQUIREMENTS" href="#DOOR_LOOKUP_REQUIREMENTS" class="la">DOOR_LOOKUP_REQUIREMENTS:</a><span class="ce">; [$e5db]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: No key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]: "J" key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]: No key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [3]: "Q" key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [4]: No key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [5]: "A" key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [6]: No key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [7]: Ring of Dworf required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [8]: No key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [9]: Demon's Ring required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [10]: No key required</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]: No key required</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a name="MAYBE_REGION_TRANSITION_MAP" href="#MAYBE_REGION_TRANSITION_MAP" class="la">MAYBE_REGION_TRANSITION_MAP:</a><span class="ce">; [$e5e7]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_TRUNK</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_TRUNK</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_DARTMOOR</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_EVIL_FORTRESS</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_DARTMOOR</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">REGION_EVIL_FORTRESS</span></span><span class="ce">; [11]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a name="MAYBE_SCREEN_TRANSITION_MAP" href="#MAYBE_SCREEN_TRANSITION_MAP" class="la">MAYBE_SCREEN_TRANSITION_MAP:</a><span class="ce">; [$e5f3]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1f</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$27</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [11]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a name="AREA_TO_MUSIC" href="#AREA_TO_MUSIC" class="la">AREA_TO_MUSIC:</a><span class="ce">; [$e5ff]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [9]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a name="Maybe_RoomTransitionTable" href="#Maybe_RoomTransitionTable" class="la">Maybe_RoomTransitionTable:</a><span class="ce">; [$e609]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">13 14 15 16 17 18 19 1a</span></span><span class="ce">; [$e60b] undefined</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a name="AREA_MAYBE_TILES_INDEXES" href="#AREA_MAYBE_TILES_INDEXES" class="la">AREA_MAYBE_TILES_INDEXES:</a><span class="ce">; [$e613]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [9]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a name="AREA_START_POSITIONS" href="#AREA_START_POSITIONS" class="la">AREA_START_POSITIONS:</a><span class="ce">; [$e61d]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$8e</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$8e</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$8e</span></span><span class="ce">; [9]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether the screen is the edge in a given direction.
;
; INPUTS:
;     Y:
;         The direction to check relative to the screen.
;
;         0 = Screen left
;         1 = Screen right
;         2 = Screen above
;         3 = Screen below
;
; OUTPUTS:
;     C:
;         1 if this screen is the edge.
;         0 if it has a neighboring screen.
;
; XREFS:
;     <a href="#Maybe_MoveDownOneScreen">Maybe_MoveDownOneScreen</a>
;     <a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a>
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a name="Screen_IsEdge" href="#Screen_IsEdge" class="la">Screen_IsEdge:</a><span class="ce">; [$e627]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a>,Y</span></span><span class="ce">; Load the screen ID at the given neighbor.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; If 0xFF, C = 1. Else, C = 0</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CanMoveUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_CanPlayerMoveRight">Area_CanPlayerMoveRight</a>
;============================================================================
</div><span class="l"><a name="Area_CanMoveUp" href="#Area_CanMoveUp" class="la">Area_CanMoveUp:</a><span class="ce">; [$e62d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e658">@LAB_PRG15_MIRROR__e658</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e658" href="#@LAB_PRG15_MIRROR__e658" class="lla">@LAB_PRG15_MIRROR__e658:</a><span class="ce">; [$e658]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveRight
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;============================================================================
</div><span class="l"><a name="Area_CanPlayerMoveRight" href="#Area_CanPlayerMoveRight" class="la">Area_CanPlayerMoveRight:</a><span class="ce">; [$e65b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Area_CanMoveUp">Area_CanMoveUp</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveAtY
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_CanPlayerMoveLeft">Area_CanPlayerMoveLeft</a>
;============================================================================
</div><span class="l"><a name="Area_CanPlayerMoveAtY" href="#Area_CanPlayerMoveAtY" class="la">Area_CanPlayerMoveAtY:</a><span class="ce">; [$e664]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_returnResult" href="#@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e68e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveLeft
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;============================================================================
</div><span class="l"><a name="Area_CanPlayerMoveLeft" href="#Area_CanPlayerMoveLeft" class="la">Area_CanPlayerMoveLeft:</a><span class="ce">; [$e691]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#Area_CanPlayerMoveAtY">Area_CanPlayerMoveAtY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e6c5">@LAB_PRG15_MIRROR__e6c5</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e6c5" href="#@LAB_PRG15_MIRROR__e6c5" class="lla">@LAB_PRG15_MIRROR__e6c5:</a><span class="ce">; [$e6c5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_Maybe_MoveIfPassable
;
; INPUTS:
;     X
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Maybe_MoveDownOneScreen">Maybe_MoveDownOneScreen</a>
;     <a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a>
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;     <a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a>
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a name="Player_Maybe_MoveIfPassable" href="#Player_Maybe_MoveIfPassable" class="la">Player_Maybe_MoveIfPassable:</a><span class="ce">; [$e6c8]</span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Area_CanPlayerMoveLeft">Area_CanPlayerMoveLeft</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Area_CanPlayerMoveRight">Area_CanPlayerMoveRight</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Area_CanPlayerMoveUp">Area_CanPlayerMoveUp</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$d0</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstRowBelowScreen">FirstRowBelowScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstRowBelowScreen">FirstRowBelowScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_returnResult" href="#@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e6fc]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CanMoveImmediatelyRight
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_CanPlayerMoveUp">Area_CanPlayerMoveUp</a>
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;============================================================================
</div><span class="l"><a name="Area_CanMoveImmediatelyRight" href="#Area_CanMoveImmediatelyRight" class="la">Area_CanMoveImmediatelyRight:</a><span class="ce">; [$e6ff]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_returnResult" href="#@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e721]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;============================================================================
</div><span class="l"><a name="Area_CanPlayerMoveUp" href="#Area_CanPlayerMoveUp" class="la">Area_CanPlayerMoveUp:</a><span class="ce">; [$e724]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastRowAboveScreen">LastRowAboveScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastRowAboveScreen">LastRowAboveScreen</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_returnResult" href="#@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e74f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckIfOnLadder
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a name="Player_CheckIfOnLadder" href="#Player_CheckIfOnLadder" class="la">Player_CheckIfOnLadder:</a><span class="ce">; [$e752]</span></span>
<div class="c">;
; Build the target block pixel position to look up.
;
; This will offset the X by +7, which helps grab onto the block
; if just to the left of it.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; A = player X position</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$07</span></span><span class="ce">; Add 7.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store the player's new X pixel position</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span><span class="ce">; Load the player's Y position</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store the player's Y pixel position</span></span>
<span class="l"></span>
<div class="c">;
; Check if the block at this position is climbable.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert to a block position.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block at that position.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property for that block.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span><span class="ce">; Check if it's climbable.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The block is not climbable. Check if the player is
; overlapping a block to the right, and check that.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; A = player X position.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkBlockBelow">@_checkBlockBelow</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_checkBlockBelow" href="#@_checkBlockBelow" class="lla">@_checkBlockBelow:</a><span class="ce">; [$e783]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$1f</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Reset the can-climb bit.
;
</div><span class="l"><a name="@_resetCanClimb" href="#@_resetCanClimb" class="lla">@_resetCanClimb:</a><span class="ce">; [$e7b2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f7</span></span><span class="ce">; Clear the can-climb bit.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span><span class="ce">; Is the current block climbable?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_clearBit5AndReturn">@_clearBit5AndReturn</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; Set the can-climb bit.
;
</div><span class="l"><span><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; Else, set the can-climbable bit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Set the ladder flag bit</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_clearBit5AndReturn" href="#@_clearBit5AndReturn" class="lla">@_clearBit5AndReturn:</a><span class="ce">; [$e7c0]</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$ef</span></span><span class="ce">; Clear bit 5.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set state from the area at the other end of the door.
;
; This checks if the player is in front of a door (being
; careful to check any overlapping blocks) and then looks up
; the area at the other end of the door.
;
; If a matching door is found (one that maps to the current
; screen and block position), then a new screen index, start
; position, palette, and door key requirement for the
; current screen will be set. This prepares for switching to
; the new area.
;
; INPUTS:
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The X position of the player.
;
;     <a href="RAM.html#PlayerPosY">PlayerPosY</a>:
;         The Y position of the player.
;
; OUTPUTS:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         1 if a door could be entered.
;         0 if one could not.
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The start position when switching to the new area.
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The new screen when switching to the new area.
;
;     <a href="RAM.html#Screen_Palette">Screen_Palette</a>:
;         The new palette when switching to the new area.
;
;     <a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a>:
;         The key requirement for the matching doro when
;         switching to the new area.
;
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a>
;         Clobbered.
;
; CALLS:
;     <a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a>
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a name="Area_SetStateFromDoorDestination" href="#Area_SetStateFromDoorDestination" class="la">Area_SetStateFromDoorDestination:</a><span class="ce">; [$e7c5]</span></span>
<div class="c">;
; Convert the player position to a normalized block position.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player's full X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$07</span></span><span class="ce">; Add 7.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the X pixel position argument.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span><span class="ce">; Load the player's full Y position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store as the Y pixel position argument.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Conver to block positions.</span></span>
<span class="l"></span>
<div class="c">;
; Load the block at this position from the screen and
; check what it is.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block from the screen buffer.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Get the block property.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Is it a door?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsDoor">@_blockIsDoor</a></span></span></span>
<span class="l"></span>
<div class="c">;
; It's not a door. The player may still be near a door.
; Let's round to the nearest block to the right and check
; again.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player's full X position.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Check the lower nibble.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it on a full block boundary?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_blockIsNotDoor">@_blockIsNotDoor</a></span></span><span class="ce">; _blockIsAir</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Increment the block position.</span></span>
<span class="l"></span>
<div class="c">;
; We normalized to the next overlapped block. Now check
; to see if it's a door.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block at that position.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Is it a door?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsDoor">@_blockIsDoor</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"></span>
<div class="c">;
; The player was not standing in front of a door.
; Consider this block passable.
;
</div><span class="l"><a name="@_blockIsNotDoor" href="#@_blockIsNotDoor" class="lla">@_blockIsNotDoor:</a><span class="ce">; [$e7f0]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set the resulting block property as air.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The player is standing in front of a door.
;
; Check to see where they are.
;
</div><span class="l"><a name="@_blockIsDoor" href="#@_blockIsDoor" class="lla">@_blockIsDoor:</a><span class="ce">; [$e7f5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current region.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this the area around Victim(?) ?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e7fe">@LAB_PRG15_MIRROR__e7fe</a></span></span><span class="ce">; If not, jump and continue on.</span></span>
<span class="l"></span>
<div class="c">;
; We won't be handling anything in this area. We're done here.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#SUB_RETURN_E5DA">SUB_RETURN_E5DA</a></span></span><span class="ce">; Else, we're done.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e7fe" href="#@LAB_PRG15_MIRROR__e7fe" class="lla">@LAB_PRG15_MIRROR__e7fe:</a><span class="ce">; [$e7fe]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Mark the resulting block as solid by default.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_BlockPos">Temp_BlockPos</a></span></span><span class="ce">; Store our block X position temporarily.</span></span>
<span class="l"></span>
<div class="c">;
; Get the location of the doors for this area and store
; the address for access below.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr">CurrentArea_DoorLocationsAddr</a></span></span><span class="ce">; Load the lower byte of the doors address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr.U">CurrentArea_DoorLocationsAddr.U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"></span>
<div class="c">;
; Switch to Bank 3 (level data).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Load bank 3.</span></span>
<span class="l"></span>
<div class="c">;
; Check the byte stored in address stored starting at
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> to see if it's an air block or the screen
; index.
;
</div><span class="l"><a name="@_doorCheckLoop" href="#@_doorCheckLoop" class="lla">@_doorCheckLoop:</a><span class="ce">; [$e815]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the first byte from the referenced address.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_returnAirBlock">@_returnAirBlock</a></span></span><span class="ce">; If so, consider this air and return.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Is it the current screen index?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e852">@LAB_PRG15_MIRROR__e852</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; That was a match.
;
; Next, check the next byte in the address referenced by
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> to see if it's the stored block position
; from above (<a href="RAM.html#Temp_BlockPos">Temp_BlockPos</a>).
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the next byte from the referenced address.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_BlockPos">Temp_BlockPos</a></span></span><span class="ce">; Is it the block position we stored?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e852">@LAB_PRG15_MIRROR__e852</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; That was a match too.
;
; Load the next byte referenced in <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> and store
; that
; as a block position in <a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a>.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the next byte from the referenced address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span><span class="ce">; Store that byte as a temporary block position.</span></span>
<span class="l"></span>
<div class="c">;
; Load the next byte from the address referenced in
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> and store as the area's start X/Y
; location (<a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>).
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the next byte from the referenced address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span><span class="ce">; Store as the area's starting X/Y position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span><span class="ce">; A = Byte we had just stored up above.</span></span>
<span class="l"></span>
<div class="c">;
; Check the current area. If it's around Mascon somewhere,
; we'll need to reduce the value by 32.
;
; TODO: Check why this is.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Y = current area</span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$03</span></span><span class="ce">; Is the current area 3?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e83d">@LAB_PRG15_MIRROR__e83d</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; We'll need to normalize the block position.
;
</div><span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$20</span></span><span class="ce">; Reduce it by 32.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e83d" href="#@LAB_PRG15_MIRROR__e83d" class="lla">@LAB_PRG15_MIRROR__e83d:</a><span class="ce">; [$e83d]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply the block position by 4.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"></span>
<div class="c">;
; Load state from the door destination at this block.
;
; We'll load the screen index, palette, and the key
; requirement.
;
</div><span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A (block position)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a>),Y</span></span><span class="ce">; Load the screen index from the door destination.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; Store it as the new screen index.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a>),Y</span></span><span class="ce">; Load the palette from the door destination.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span><span class="ce">; Store it as the new palette.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a>),Y</span></span><span class="ce">; Load the key requirement.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; We're done. Restore our bank and set our results.</span></span>
<span class="l"></span>
<div class="c">;
; Skip the 4 bytes of information of the area at the other end
; of the door destination. We'll set up to process the next one.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__e852" href="#@LAB_PRG15_MIRROR__e852" class="lla">@LAB_PRG15_MIRROR__e852:</a><span class="ce">; [$e852]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Load the lower byte of the door destination address we stored.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4 (skip the information found on the other side of that door).</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it back out.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Load the upper byte of the address.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry flag, if the lower byte overflowed.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_doorCheckLoop">@_doorCheckLoop</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Consider this air.
;
</div><span class="l"><a name="@_returnAirBlock" href="#@_returnAirBlock" class="lla">@_returnAirBlock:</a><span class="ce">; [$e862]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set the resulting block property to 0 (air).</span></span>
<span class="l"></span>
<div class="c">;
; Restore the previous ROM bank and return.
;
</div><span class="l"><a name="@_restoreBankAndReturn" href="#@_restoreBankAndReturn" class="lla">@_restoreBankAndReturn:</a><span class="ce">; [$e866]</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the previous bank from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A (bank)</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Update to the bank.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Convert a screen position from pixels to blocks.
;
; This will operate off of the stored PixelPosX and PixelPosY.
;
; INPUTS:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;         The X pixel position to convert.
;
;     <a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a>:
;         The Y pixel position to convert.
;
; Outputs:
;     X:
;         The new block position.
;
; XREFS:
;     <a href="PRG14.html#CastMagic_Maybe_CheckImpassableY">CastMagic_Maybe_CheckImpassableY</a>
;     <a href="PRG14.html#CurrentSprite_CalculateVisibility">CurrentSprite_CalculateVisibility</a>
;     <a href="PRG14.html#CurrentSprite_CalculateVisibility_MaybeWithArg">CurrentSprite_CalculateVisibility_MaybeWithArg</a>
;     <a href="PRG14.html#CurrentSprite_CanMoveInDirection">CurrentSprite_CanMoveInDirection</a>
;     <a href="PRG14.html#FUN_PRG14__854c">FUN_PRG14__854c</a>
;     <a href="PRG14.html#FUN_PRG14__86c6">FUN_PRG14__86c6</a>
;     <a href="PRG14.html#SpriteBehavior_MaybeFlyingSomething">SpriteBehavior_MaybeFlyingSomething</a>
;     <a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a>
;     <a href="#Area_CanPlayerMoveAtY">Area_CanPlayerMoveAtY</a>
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a>
;     <a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;     <a href="#Player_FallToGround">Player_FallToGround</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;============================================================================
</div><span class="l"><a name="Area_ConvertPixelsToBlockPos" href="#Area_ConvertPixelsToBlockPos" class="la">Area_ConvertPixelsToBlockPos:</a><span class="ce">; [$e86c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Load the stored Y coordinate for comparison</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Clear out the lower nibble</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Load the stored X coordinate for comparison</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Convert X to block positions</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Include the Y block position</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; Store in X and return</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether a block at a given screen buffer index is impassable.
;
; INPUTS:
;     Y:
;         The index into the blocks table.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         A map of impassable blocks.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable.
;         0 if it is passable.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="PRG14.html#CastMagic_Maybe_CheckImpassableY">CastMagic_Maybe_CheckImpassableY</a>
;     <a href="PRG14.html#CurrentSprite_CanMoveInDirection">CurrentSprite_CanMoveInDirection</a>
;     <a href="PRG14.html#FUN_PRG14__86c6">FUN_PRG14__86c6</a>
;     <a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a>
;     <a href="#Area_CanPlayerMoveAtY">Area_CanPlayerMoveAtY</a>
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;============================================================================
</div><span class="l"><a name="ScreenBuffer_IsBlockImpassable" href="#ScreenBuffer_IsBlockImpassable" class="la">ScreenBuffer_IsBlockImpassable:</a><span class="ce">; [$e87c]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether a block at a given block property index is impassable.
;
; INPUTS:
;     Y:
;         The index into the blocks table.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         A map of impassable blocks.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable.
;         0 if it is passable.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="#Area_CanMoveUp">Area_CanMoveUp</a>
;     <a href="#Area_CanPlayerMoveLeft">Area_CanPlayerMoveLeft</a>
;     <a href="#Area_CanPlayerMoveUp">Area_CanPlayerMoveUp</a>
;     <a href="#Player_Maybe_MoveIfPassable">Player_Maybe_MoveIfPassable</a>
;============================================================================
</div><span class="l"><a name="Area_IsBlockImpassable" href="#Area_IsBlockImpassable" class="la">Area_IsBlockImpassable:</a><span class="ce">; [$e87f]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_GetFromImpassableMap
;
; INPUTS:
;     A
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_IsBlockImpassableOrLadder">Area_IsBlockImpassableOrLadder</a>
;============================================================================
</div><span class="l"><a name="Area_GetFromImpassableMap" href="#Area_GetFromImpassableMap" class="la">Area_GetFromImpassableMap:</a><span class="ce">; [$e882]</span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$e8d9,Y</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether a block at the given screen buffer index is impassable or a
; ladder.
;
; INPUTS:
;     X:
;         The index within the screen buffer, for
;         getting the block property index.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         A map of impassable block types.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable or a ladder.
;         0 if it is passable.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="PRG14.html#FUN_PRG14__854c">FUN_PRG14__854c</a>
;============================================================================
</div><span class="l"><a name="Area_IsBlockImpassableOrLadder" href="#Area_IsBlockImpassableOrLadder" class="la">Area_IsBlockImpassableOrLadder:</a><span class="ce">; [$e887]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block property offset from the screen buffer at X.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it a ladder?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Area_GetFromImpassableMap">Area_GetFromImpassableMap</a></span></span><span class="ce">; If not a ladder, look up from the passable map.</span></span>
<span class="l"></span>
<div class="c">;
; This is a ladder.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; Return true.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set whether a block is truly air.
;
; This loads the specified block property and then
; determines if it's actually air. This will be stored in
; <a href="RAM.html#Blocks_Result">Blocks_Result</a>.
;
; INPUTS:
;     X:
;         The index into the screen buffer.
;
; OUTPUTS:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         The result of the check.
;
;         1 for solid-like.
;         0 for air-like.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;============================================================================
</div><span class="l"><a name="Area_StoreBlockIsAir" href="#Area_StoreBlockIsAir" class="la">Area_StoreBlockIsAir:</a><span class="ce">; [$e894]</span></span>
<div class="c">;
; Load the block property at this screen buffer offset.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Y = block property at screen buffer X</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store that in a temporary variable.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is a solid block.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Is it solid?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsSolid">@_blockIsSolid</a></span></span><span class="ce">; If so, then jump.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is a ladder.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it a ladder?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsSolid">@_blockIsSolid</a></span></span><span class="ce">; If so, then jump.</span></span>
<span class="l"></span>
<div class="c">;
; Check if this is a second ladder-like (??? TODO)
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; TODO: Is it... another climbable block?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsSolid">@_blockIsSolid</a></span></span><span class="ce">; If so, then jump.</span></span>
<span class="l"></span>
<div class="c">;
; It's not solid. Store a result of 0 (air).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set result = 0.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; It is solid. Store a result of 1 (solid).
;
</div><span class="l"><a name="@_blockIsSolid" href="#@_blockIsSolid" class="lla">@_blockIsSolid:</a><span class="ce">; [$e8ad]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set result = 1.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Determine if the current block is climbable.
;
; This will check the provided block property (stored in
; a temp variable) and check if it can be climbed.
;
; INPUTS:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         The block property to check.
;
; OUTPUTS:
;     C:
;         1 if it's climbable.
;         0 if it is not.
;
; XREFS:
;     <a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a>
;============================================================================
</div><span class="l"><a name="Area_IsBlockClimbable" href="#Area_IsBlockClimbable" class="la">Area_IsBlockClimbable:</a><span class="ce">; [$e8b2]</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Load the block property provided in the temp variable.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it a ladder?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_isLadder">@_isLadder</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; TODO: Is it... something else ladder-like?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_isNotLadder">@_isNotLadder</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; This is a ladder.
;
</div><span class="l"><a name="@_isLadder" href="#@_isLadder" class="lla">@_isLadder:</a><span class="ce">; [$e8bd]</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A.</span></span>
<span class="l"><span><span class="i">SEC</span></span><span class="ce">; Set carry to 1 as a truthy result.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_isNotLadder" href="#@_isNotLadder" class="lla">@_isNotLadder:</a><span class="ce">; [$e8c0]</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A.</span></span>
<span class="l"><span><span class="i">CLC</span></span><span class="ce">; Set carry to 0 as a falsy result.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return the block property referenced at the given screen buffer index.
;
; This will load the block property referenced in the screen
; buffer and then fall through to
; <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>.
;
; Block properties are stored with upper and lower nibbles
; representing different blocks. This will look up the
; appropriate block property based on whether the provided
; index is even or odd, and return a value with just a lower
; nibble set based on the properties.
;
; INPUTS:
;     X:
;         The index into the screen buffer.
;
;     <a href="RAM.html#BlockProperties">BlockProperties</a>:
;         The block properties to load from.
;
; OUTPUTS:
;     A:
;         A byte containing the property.
;
; XREFS:
;     <a href="PRG14.html#CurrentSprite_CalculateVisibility">CurrentSprite_CalculateVisibility</a>
;     <a href="PRG14.html#CurrentSprite_CalculateVisibility_MaybeWithArg">CurrentSprite_CalculateVisibility_MaybeWithArg</a>
;     <a href="PRG14.html#SpriteBehavior_MaybeFlyingSomething">SpriteBehavior_MaybeFlyingSomething</a>
;     <a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a>
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;============================================================================
</div><span class="l"><a name="ScreenBuffer_LoadBlockProperty" href="#ScreenBuffer_LoadBlockProperty" class="la">ScreenBuffer_LoadBlockProperty:</a><span class="ce">; [$e8c3]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block property index from the screen buffer.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return the block property at the given index.
;
; Block properties are stored with upper and lower nibbles
; representing different blocks. This will look up the
; appropriate block property based on whether the provided
; index is even or odd, and return a value with just a lower
; nibble set based on the properties.
;
; INPUTS:
;     Y:
;         The index into the block properties.
;
;     BlockProperties:
;         The block properties to load from.
;
; OUTPUTS:
;     A:
;         A byte containing the property.
;
; XREFS:
;     <a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a>
;     <a href="#Area_IsBlockImpassableOrLadder">Area_IsBlockImpassableOrLadder</a>
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#Area_StoreBlockIsAir">Area_StoreBlockIsAir</a>
;     <a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_FallToGround">Player_FallToGround</a>
;============================================================================
</div><span class="l"><a name="Area_GetBlockProperty" href="#Area_GetBlockProperty" class="la">Area_GetBlockProperty:</a><span class="ce">; [$e8c6]</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Y = even block offset based on the index.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_isEven">@_isEven</a></span></span><span class="ce">; Check whether this is even or odd.</span></span>
<span class="l"></span>
<div class="c">;
; Load the block property at the index, moving the data in
; the upper nibble to the lower nibble.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockProperties">BlockProperties</a>,Y</span></span><span class="ce">; Load the block property at the index.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift to the lower nibble.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; Load the block property, masking out the upper nibble.
;
</div><span class="l"><a name="@_isEven" href="#@_isEven" class="lla">@_isEven:</a><span class="ce">; [$e8d3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockProperties">BlockProperties</a>,Y</span></span><span class="ce">; Load the block property at the index.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Mask out the upper nibble, giving just the lower.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Map of block property IDs to impassibility flags.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_GetFromImpassableMap">Area_GetFromImpassableMap</a>
;
</div><span class="l"><a name="BLOCK_PROPERTY_IMPASSABLE_MAP" href="#BLOCK_PROPERTY_IMPASSABLE_MAP" class="la">BLOCK_PROPERTY_IMPASSABLE_MAP:</a><span class="ce">; [$e8d9]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Air</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Solid</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]: Ladder</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]: Door</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [12]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [15]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_BeginScrollToNextRoom
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ScrollScreenUp">Area_ScrollScreenUp</a>
;     <a href="#Maybe_MoveDownOneScreen">Maybe_MoveDownOneScreen</a>
;     <a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a>
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a name="Area_BeginScrollToNextRoom" href="#Area_BeginScrollToNextRoom" class="la">Area_BeginScrollToNextRoom:</a><span class="ce">; [$e8e9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e8f7">@LAB_PRG15_MIRROR__e8f7</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e8f7" href="#@LAB_PRG15_MIRROR__e8f7" class="lla">@LAB_PRG15_MIRROR__e8f7:</a><span class="ce">; [$e8f7]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Area_ScrollToNextRoom">Area_ScrollToNextRoom</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_FallToGround
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_FallToGround" href="#Player_FallToGround" class="la">Player_FallToGround:</a><span class="ce">; [$e905]</span></span>
<div class="c">;
; Only check for falling periodically.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Are we ready to check for falling?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<div class="c">;
; Begin checking against a block 32 pixels down.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span><span class="ce">; A = Player's Y position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$20</span></span><span class="ce">; A += 32</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store as the Y argument for block checks.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f0</span></span><span class="ce">; Is it &gt;= 0xEF? (one block below the screen)</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, stop falling.</span></span>
<span class="l"></span>
<div class="c">;
; The player may be permitted to fall. Check the block
; it's on.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Keep only the facing bit.</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span><span class="ce">; Shift this into bit 0.</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Mask out everything else.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Check the first block the player is overlapping.
;
</div><span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = facing value.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; A = Player X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$e95b,X</span></span><span class="ce">; Load a block offset to round to the nearest overlapping blocks.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the X position to check.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert it to a block position.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block value from the screen.</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store as the block result.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; And get its corresponding property.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$05</span></span><span class="ce">; Is it 5?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkNextBlock">@_checkNextBlock</a></span></span><span class="ce">; If not, check the next overlapping block.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the facing bit from the stack.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d6ce">FUN_PRG15_MIRROR__d6ce</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check the second block the player is overlapping.
;
</div><span class="l"><a name="@_checkNextBlock" href="#@_checkNextBlock" class="lla">@_checkNextBlock:</a><span class="ce">; [$e93c]</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the facing bit from the stack.</span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o">#$01</span></span><span class="ce">; XOR the facing bit to check the other direction.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; A = Player X position.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$e95b,X</span></span><span class="ce">; Load a block offset to round to the next overlapping blocks.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the X position to check.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert it to a block position.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block value from the screen.</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store as the block result.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$05</span></span><span class="ce">; Is it 5?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__d6ce">FUN_PRG15_MIRROR__d6ce</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$e95a]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_PLAYER_FALL_TO_GROUND_X_OFFSETS" href="#@_PLAYER_FALL_TO_GROUND_X_OFFSETS" class="lla">@_PLAYER_FALL_TO_GROUND_X_OFFSETS:</a><span class="ce">; [$e95b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [0]: Facing left</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [1]: Facing right</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckPushingBlock
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_CheckPushingBlock" href="#Player_CheckPushingBlock" class="la">Player_CheckPushingBlock:</a><span class="ce">; [$e95d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$e9be,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Fetch the block property at this position.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check if the block is pushable. If so, we'll handle it.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"></span>
<div class="c">;
; This is pushable. Increase the push counter.
;
; We'll play a sound when we hit 0x3F, and finish pushing
; after 0x60.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$3f</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9a3">@LAB_PRG15_MIRROR__e9a3</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e9a3" href="#@LAB_PRG15_MIRROR__e9a3" class="lla">@LAB_PRG15_MIRROR__e9a3:</a><span class="ce">; [$e9a3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$60</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$e9b8]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__e9b9" href="#@LAB_PRG15_MIRROR__e9b9" class="lla">@LAB_PRG15_MIRROR__e9b9:</a><span class="ce">; [$e9b9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__e9be" href="#BYTE_ARRAY_PRG15_MIRROR__e9be" class="la">BYTE_ARRAY_PRG15_MIRROR__e9be:</a><span class="ce">; [$e9be]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_CheckSwitchScreen
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a name="Player_CheckSwitchScreen" href="#Player_CheckSwitchScreen" class="la">Player_CheckSwitchScreen:</a><span class="ce">; [$e9c0]</span></span>
<div class="c">;
; Check the current block the player is on.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$09</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9de">@LAB_PRG15_MIRROR__e9de</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9de">@LAB_PRG15_MIRROR__e9de</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0d</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9de">@LAB_PRG15_MIRROR__e9de</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0c</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_EA36">RETURN_EA36</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Check the next block.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__e9de" href="#@LAB_PRG15_MIRROR__e9de" class="lla">@LAB_PRG15_MIRROR__e9de:</a><span class="ce">; [$e9de]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$09</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9fb">@LAB_PRG15_MIRROR__e9fb</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9fb">@LAB_PRG15_MIRROR__e9fb</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0d</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9fb">@LAB_PRG15_MIRROR__e9fb</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0c</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#RETURN_EA36">RETURN_EA36</a></span></span></span>
<span class="l"></span>
<div class="c">;
; TODO:
;
; Two blocks in a row have this property (or the player is firmly
; on one block, not overlapping two?).
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__e9fb" href="#@LAB_PRG15_MIRROR__e9fb" class="lla">@LAB_PRG15_MIRROR__e9fb:</a><span class="ce">; [$e9fb]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0c</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Area_ChangeArea">Area_ChangeArea</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0d</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Area_ChangeArea">Area_ChangeArea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ea37,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ea38,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="SUB_EA13" href="#SUB_EA13" class="la">SUB_EA13:</a><span class="ce">; [$ea13]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#RETURN_EA36">RETURN_EA36</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea2f">@LAB_PRG15_MIRROR__ea2f</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Game_EnterScreenHandler">Maybe_Game_EnterScreenHandler</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ea2f" href="#@LAB_PRG15_MIRROR__ea2f" class="lla">@LAB_PRG15_MIRROR__ea2f:</a><span class="ce">; [$ea2f]</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#SUB_EA13">SUB_EA13</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;
</div><span class="l"><a name="RETURN_EA36" href="#RETURN_EA36" class="la">RETURN_EA36:</a><span class="ce">; [$ea36]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;
</div><span class="l"><a name="USHORT_PRG15_MIRROR__ea37" href="#USHORT_PRG15_MIRROR__ea37" class="la">USHORT_PRG15_MIRROR__ea37:</a><span class="ce">; [$ea37]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Eolis</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea47</span></span><span class="ce">; Apolune</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Forepaw</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Mascon</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Victim</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Conflate</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Daybreak</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$ea4f</span></span><span class="ce">; Evil Fortress</span></span>
<span class="l"></span>
<span class="l"><a name="DAT_PRG15_MIRROR__ea47" href="#DAT_PRG15_MIRROR__ea47" class="la">DAT_PRG15_MIRROR__ea47:</a><span class="ce">; [$ea47]</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">0c 16 b3 06 16 0c 2d 06</span></span><span class="ce">; [$ea47] undefined</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#USHORT_PRG15_MIRROR__ea37">USHORT_PRG15_MIRROR__ea37</a>
;     [$PRG15_MIRROR::ea37]
;
</div><span class="l"><a name="DAT_PRG15_MIRROR__ea4f" href="#DAT_PRG15_MIRROR__ea4f" class="la">DAT_PRG15_MIRROR__ea4f:</a><span class="ce">; [$ea4f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$ea4f] undefined</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Game_MainExitBuildingHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ChangeArea">Area_ChangeArea</a>
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;============================================================================
</div><span class="l"><a name="Maybe_Game_MainExitBuildingHandler" href="#Maybe_Game_MainExitBuildingHandler" class="la">Maybe_Game_MainExitBuildingHandler:</a><span class="ce">; [$ea50]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Game_ExitBuildingHandler">Maybe_Game_ExitBuildingHandler</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Area_ChangeArea
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;============================================================================
</div><span class="l"><a name="Area_ChangeArea" href="#Area_ChangeArea" class="la">Area_ChangeArea:</a><span class="ce">; [$ea5f]</span></span>
<div class="c">;
; Check if the player is in the area of Victim.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Maybe_Game_MainExitBuildingHandler">Maybe_Game_MainExitBuildingHandler</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ea9c,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ea9d,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ea73" href="#@LAB_PRG15_MIRROR__ea73" class="lla">@LAB_PRG15_MIRROR__ea73:</a><span class="ce">; [$ea73]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea9b">@LAB_PRG15_MIRROR__ea9b</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea94">@LAB_PRG15_MIRROR__ea94</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Palette">Screen_Palette</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__dacd">FUN_PRG15_MIRROR__dacd</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ea94" href="#@LAB_PRG15_MIRROR__ea94" class="lla">@LAB_PRG15_MIRROR__ea94:</a><span class="ce">; [$ea94]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea73">@LAB_PRG15_MIRROR__ea73</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ea9b" href="#@LAB_PRG15_MIRROR__ea9b" class="lla">@LAB_PRG15_MIRROR__ea9b:</a><span class="ce">; [$ea9b]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_ChangeArea">Area_ChangeArea</a>
;
</div><span class="l"><a name="AREA_TOWN_TRANSITIONS_DATA" href="#AREA_TOWN_TRANSITIONS_DATA" class="la">AREA_TOWN_TRANSITIONS_DATA:</a><span class="ce">; [$ea9c]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eb2e</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eaac</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eb03</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eac6</span></span><span class="ce">; [3]: Mascon</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eb2e</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eb18</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eb28</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$eb2e</span></span><span class="ce">; [7]: Evil Fortress</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::ea9e]
;
</div><span class="l"><a name="TOWN_TRANSITIONS_TRUNK" href="#TOWN_TRANSITIONS_TRUNK" class="la">TOWN_TRANSITIONS_TRUNK:</a><span class="ce">; [$eaac]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [$eaac] byte</span></span>
<span class="l"></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02,$92</span></span><span class="ce">; [$eaae] byte</span></span>
<span class="l"></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; Entering Apolune from Trunk (screen 7)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">;   |-&gt; Screen index 0</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position Y=9, X=2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [$eab6] byte</span></span>
<span class="l"></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01,$9e</span></span><span class="ce">; [$eab8] byte</span></span>
<span class="l"></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; Entering Forepaw from Trunk (screen 26)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">;   |-&gt; Screen index 2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position X=2, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1d</span></span><span class="ce">; [$eac0] byte</span></span>
<span class="l"></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03,$9e</span></span><span class="ce">; [$eac2] byte</span></span>
<span class="l"></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eac5] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa2]
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__eac6" href="#BYTE_PRG15_MIRROR__eac6" class="la">BYTE_PRG15_MIRROR__eac6:</a><span class="ce">; [$eac6]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; Exiting left from Apolune screen 0</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">;   |-&gt; Screen index 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position Y=7, X=14</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   '-&gt; Palette 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; Exit right from Apolune screen 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">;   |-&gt; Screen index 8</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$71</span></span><span class="ce">;   |-&gt; Start position Y=7, X=1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   '-&gt; Palette 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; Exiting left from Forepaw to Trunk (screen 2)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 1</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">;   |-&gt; Screen index 26</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   '-&gt; Palette 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; Exiting right from Forepaw to Branch (screen 3)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1d</span></span><span class="ce">;   |-&gt; Screen index 29</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$71</span></span><span class="ce">;   |-&gt; Start position X=1, Y=7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   |-&gt; Palette 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; Exiting left from Mascon to Mist (screen 4)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">;   |-&gt; Screen index 9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; Exiting right from Mascon to Mist (screen 5)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">;   |-&gt; Screen index 12</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; Exit left from Victim to Mist from screen 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 2</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$22</span></span><span class="ce">;   |-&gt; Screen index 34</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; Exit right from Victim to Mist on screen 7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$25</span></span><span class="ce">;   |-&gt; Screen index = 37</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; Exit left from Conflate to Branch</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">;   |-&gt; Switch to area 5</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">;   |-&gt; Screen index 13</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">;   '-&gt; Palette 8</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; Exit left from Daybreak to Branch</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">;   |-&gt; Switch to area 5</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$23</span></span><span class="ce">;   |-&gt; Screen index 35</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">;   '-&gt; Palette 8</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; Exit right from Daybreak to Branch</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">;   |-&gt; Switch to area 5</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$24</span></span><span class="ce">;   |-&gt; Screen index 36</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$71</span></span><span class="ce">;   |-&gt; Start position X=1, Y=7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">;   '-&gt; Palette 8</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; Exit left from Dartmoor to Branch (screen 12)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_DAYBREAK</span></span><span class="ce">;   |-&gt; Switch to area 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">;   |-&gt; Screen index 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_DARTMOOR</span></span><span class="ce">;   '-&gt; Palette 12</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb02] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa0]
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__eb03" href="#BYTE_PRG15_MIRROR__eb03" class="la">BYTE_PRG15_MIRROR__eb03:</a><span class="ce">; [$eb03]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; Entering Mascon from Mist (screen 9)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">;   |-&gt; Screen index 4</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; Entering left to Mascon from Mist</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$05</span></span><span class="ce">;   |-&gt; Screen index 5</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$22</span></span><span class="ce">; Enering right to Victim from Mist (screen 34)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">;   |-&gt; Screen index 6</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$25</span></span><span class="ce">; Entering left to Victim from Mist (screen 37)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">;   |-&gt; Screen index 7</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb17] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa6]
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__eb18" href="#BYTE_PRG15_MIRROR__eb18" class="la">BYTE_PRG15_MIRROR__eb18:</a><span class="ce">; [$eb18]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; Entering right to Conflate from Branch (screen 13)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">;   |-&gt; Screen index 8</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$23</span></span><span class="ce">; Entering Daybreak from Branch (screen 35)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">;   |-&gt; Screen index 10</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position X=2, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$24</span></span><span class="ce">; Entering Daybreak from Branch (screen 36)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">;   |-&gt; Screen index 11</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb27] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa8]
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__eb28" href="#BYTE_PRG15_MIRROR__eb28" class="la">BYTE_PRG15_MIRROR__eb28:</a><span class="ce">; [$eb28]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; Entering right to Dartmoor from Branch (screen 3)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">;   |-&gt; Screen index 12</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position X=2, Y=9</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb2d] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::ea9c]
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa4]
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaaa]
;
</div><span class="l"><a name="TOWN_TRANSITIONS_EMPTY" href="#TOWN_TRANSITIONS_EMPTY" class="la">TOWN_TRANSITIONS_EMPTY:</a><span class="ce">; [$eb2e]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb2e] byte</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_CheckDoorRequirement
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;============================================================================
</div><span class="l"><a name="Game_CheckDoorRequirement" href="#Game_CheckDoorRequirement" class="la">Game_CheckDoorRequirement:</a><span class="ce">; [$eb2f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$eb40,Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$eb3f,Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$eb3e]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; A mapping of door requirement lookup function addresses.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_CheckDoorRequirement">Game_CheckDoorRequirement</a>
;
</div><span class="l"><a name="DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS" href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS" class="la">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS:</a><span class="ce">; [$eb3f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3d</span></span><span class="ce">; [0]: No key, return</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_CheckDoorRequirement">Game_CheckDoorRequirement</a>
;
</div><span class="l"><a name="DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS_0__1" href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS_0__1" class="la">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS_0__1:</a><span class="ce">; [$eb40]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [1]: "A" Key</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [2]: "K" Key</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$70</span></span><span class="ce">; [3]: "Q" Key</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$80</span></span><span class="ce">; [4]: "J" Key</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [5]: "Jo" Key</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a0</span></span><span class="ce">; [6]: Ring of Elf</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b0</span></span><span class="ce">; [7]: Ring of Dworf</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [8]: Demon's Ring</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [8]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the "A" Key.
;
; This will check if the player has the "A" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb41]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithAKey" href="#Game_OpenDoorWithAKey" class="la">Game_OpenDoorWithAKey:</a><span class="ce">; [$eb51]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this the "A" Key?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7D (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7d</span></span><span class="ce">; 0x7D == "A" Key required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb60]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the "K" Key.
;
; This will check if the player has the "K" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb43]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithKKey" href="#Game_OpenDoorWithKKey" class="la">Game_OpenDoorWithKKey:</a><span class="ce">; [$eb61]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$05</span></span><span class="ce">; Is this the "K" Key?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7C (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7c</span></span><span class="ce">; 0x7C == "K" Key required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb70]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the "Q" Key.
;
; This will check if the player has the "Q" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb45]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithQKey" href="#Game_OpenDoorWithQKey" class="la">Game_OpenDoorWithQKey:</a><span class="ce">; [$eb71]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is this the "Q" Key?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7B (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7b</span></span><span class="ce">; 0x7B == "Q" Key required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb80]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the "J" Key.
;
; This will check if the player has the "J" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb47]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithJKey" href="#Game_OpenDoorWithJKey" class="la">Game_OpenDoorWithJKey:</a><span class="ce">; [$eb81]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Is this the "J" Key?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7 (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span><span class="ce">; 0x02 == "J" Key required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb90]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the "Jo" Key.
;
; This will check if the player has the "Jo" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb49]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithJoKey" href="#Game_OpenDoorWithJoKey" class="la">Game_OpenDoorWithJoKey:</a><span class="ce">; [$eb91]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is this the "Jo" Key?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7E (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7e</span></span><span class="ce">; 0x7E == "Jo" Key required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eba0]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the Ring of Elf.
;
; This will check if the player has the Ring of Elf, and
; if they do, the door will be unlocked and entered.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb4b]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithRingOfElf" href="#Game_OpenDoorWithRingOfElf" class="la">Game_OpenDoorWithRingOfElf:</a><span class="ce">; [$eba1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$80</span></span><span class="ce">; Does the player have the Ring of Elf?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Game_UnlockDoor">Game_UnlockDoor</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7F (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == Ring required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebb0]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the Ring of Dworf.
;
; This will check if the player has the Ring of Dworf, and
; if they do, the door will be unlocked and entered.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb4d]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithRingOfDworf" href="#Game_OpenDoorWithRingOfDworf" class="la">Game_OpenDoorWithRingOfDworf:</a><span class="ce">; [$ebb1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Does the player have the Ring of Dworf?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Game_UnlockDoor">Game_UnlockDoor</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7F (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == Ring required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebc0]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Attempt to open a door marked with the Demon's Ring.
;
; This will check if the player has the Demon's Ring, and
; if they do, the door will be unlocked and entered.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb4f]
;============================================================================
</div><span class="l"><a name="Game_OpenDoorWithDemonsRing" href="#Game_OpenDoorWithDemonsRing" class="la">Game_OpenDoorWithDemonsRing:</a><span class="ce">; [$ebc1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Does the player have the Demon's Ring?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#Game_UnlockDoor">Game_UnlockDoor</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7F (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == Ring required IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebd0]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_UnlockDoorWithUsableItem
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_OpenDoorWithAKey">Game_OpenDoorWithAKey</a>
;     <a href="#Game_OpenDoorWithJKey">Game_OpenDoorWithJKey</a>
;     <a href="#Game_OpenDoorWithJoKey">Game_OpenDoorWithJoKey</a>
;     <a href="#Game_OpenDoorWithKKey">Game_OpenDoorWithKKey</a>
;     <a href="#Game_OpenDoorWithQKey">Game_OpenDoorWithQKey</a>
;============================================================================
</div><span class="l"><a name="Game_UnlockDoorWithUsableItem" href="#Game_UnlockDoorWithUsableItem" class="la">Game_UnlockDoorWithUsableItem:</a><span class="ce">; [$ebd1]</span></span>
<div class="c">;
; Run IScript 0x84 (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$84</span></span><span class="ce">; 0x84 == Used key IScript.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebd9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Game_UnlockDoor
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_OpenDoorWithDemonsRing">Game_OpenDoorWithDemonsRing</a>
;     <a href="#Game_OpenDoorWithRingOfDworf">Game_OpenDoorWithRingOfDworf</a>
;     <a href="#Game_OpenDoorWithRingOfElf">Game_OpenDoorWithRingOfElf</a>
;============================================================================
</div><span class="l"><a name="Game_UnlockDoor" href="#Game_UnlockDoor" class="la">Game_UnlockDoor:</a><span class="ce">; [$ebe1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$84</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_DrawBody
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;============================================================================
</div><span class="l"><a name="Player_DrawBody" href="#Player_DrawBody" class="la">Player_DrawBody:</a><span class="ce">; [$ebee]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ebf4">@LAB_PRG15_MIRROR__ebf4</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; Check the loaded state for the screen to determine
; the arguments to use.
;
; NOTE: This seems to be old code. Nothing sets
; <a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a> to anything but 0x00 or 0xFF.
; It appears that at some point they simplified this, which
; makes all of this dead code.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__ebf4" href="#@LAB_PRG15_MIRROR__ebf4" class="lla">@LAB_PRG15_MIRROR__ebf4:</a><span class="ce">; [$ebf4]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec11">@LAB_PRG15_MIRROR__ec11</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec11">@LAB_PRG15_MIRROR__ec11</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Ths code path should always be hit when this function is
; called.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec21">@LAB_PRG15_MIRROR__ec21</a></span></span></span>
<span class="l"></span>
<div class="c">;
; This whole section seems unreachable.
; <a href="RAM.html#Maybe_ScreenReadyState">Maybe_ScreenReadyState</a>
; should never reach these values. This may be dead code.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__ec11" href="#@LAB_PRG15_MIRROR__ec11" class="lla">@LAB_PRG15_MIRROR__ec11:</a><span class="ce">; [$ec11]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollX">Something_Player_ScrollX</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ScrollY">Something_Player_ScrollY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ec21" href="#@LAB_PRG15_MIRROR__ec21" class="lla">@LAB_PRG15_MIRROR__ec21:</a><span class="ce">; [$ec21]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b9ed</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_SetFacingLeft">Player_SetFacingLeft</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$ec49,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f039">FUN_PRG15_MIRROR__f039</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__ec49" href="#BYTE_ARRAY_PRG15_MIRROR__ec49" class="la">BYTE_ARRAY_PRG15_MIRROR__ec49:</a><span class="ce">; [$ec49]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$38</span></span><span class="ce">; [7]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_SetFacingLeft
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a name="Player_SetFacingLeft" href="#Player_SetFacingLeft" class="la">Player_SetFacingLeft:</a><span class="ce">; [$ec51]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__ec58
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__ec58" href="#FUN_PRG15_MIRROR__ec58" class="la">FUN_PRG15_MIRROR__ec58:</a><span class="ce">; [$ec58]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec6b">@LAB_PRG15_MIRROR__ec6b</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ec6b" href="#@LAB_PRG15_MIRROR__ec6b" class="lla">@LAB_PRG15_MIRROR__ec6b:</a><span class="ce">; [$ec6b]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$eca2,Y</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b880</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosY">PlayerPosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o">#$b9ed</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec97">@LAB_PRG15_MIRROR__ec97</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ec97" href="#@LAB_PRG15_MIRROR__ec97" class="lla">@LAB_PRG15_MIRROR__ec97:</a><span class="ce">; [$ec97]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$eca4,Y</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f039">FUN_PRG15_MIRROR__f039</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$eca1]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__eca2" href="#BYTE_ARRAY_PRG15_MIRROR__eca2" class="la">BYTE_ARRAY_PRG15_MIRROR__eca2:</a><span class="ce">; [$eca2]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$f8</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__eca2_1_" href="#BYTE_ARRAY_PRG15_MIRROR__eca2_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__eca2_1_:</a><span class="ce">; [$eca3]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__eca4" href="#BYTE_ARRAY_PRG15_MIRROR__eca4" class="la">BYTE_ARRAY_PRG15_MIRROR__eca4:</a><span class="ce">; [$eca4]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$63</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$67</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$64</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$68</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$65</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$69</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$66</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$6a</span></span><span class="ce">; [7]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_GetBodySpriteFrameOffset
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a name="Player_GetBodySpriteFrameOffset" href="#Player_GetBodySpriteFrameOffset" class="la">Player_GetBodySpriteFrameOffset:</a><span class="ce">; [$ecac]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecb8">@LAB_PRG15_MIRROR__ecb8</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__eccc">@LAB_PRG15_MIRROR__eccc</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ecb8" href="#@LAB_PRG15_MIRROR__ecb8" class="lla">@LAB_PRG15_MIRROR__ecb8:</a><span class="ce">; [$ecb8]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_IsClimbing">Player_IsClimbing</a></span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecc8">@LAB_PRG15_MIRROR__ecc8</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ecc8" href="#@LAB_PRG15_MIRROR__ecc8" class="lla">@LAB_PRG15_MIRROR__ecc8:</a><span class="ce">; [$ecc8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecd2">@LAB_PRG15_MIRROR__ecd2</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__eccc" href="#@LAB_PRG15_MIRROR__eccc" class="lla">@LAB_PRG15_MIRROR__eccc:</a><span class="ce">; [$eccc]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ecf3,X</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ecd2" href="#@LAB_PRG15_MIRROR__ecd2" class="lla">@LAB_PRG15_MIRROR__ecd2:</a><span class="ce">; [$ecd2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecdd">@LAB_PRG15_MIRROR__ecdd</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecdd">@LAB_PRG15_MIRROR__ecdd</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ecdd" href="#@LAB_PRG15_MIRROR__ecdd" class="lla">@LAB_PRG15_MIRROR__ecdd:</a><span class="ce">; [$ecdd]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecea">@LAB_PRG15_MIRROR__ecea</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ecea" href="#@LAB_PRG15_MIRROR__ecea" class="lla">@LAB_PRG15_MIRROR__ecea:</a><span class="ce">; [$ecea]</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ecef,X</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__ecef" href="#BYTE_ARRAY_PRG15_MIRROR__ecef" class="la">BYTE_ARRAY_PRG15_MIRROR__ecef:</a><span class="ce">; [$ecef]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__ecf3" href="#BYTE_ARRAY_PRG15_MIRROR__ecf3" class="la">BYTE_ARRAY_PRG15_MIRROR__ecf3:</a><span class="ce">; [$ecf3]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether the player is climbing a ladder.
;
; This will depend on the following conditions:
;
; 1. Whether the player is in front of a ladder.
;
; 2. Whether the player is either:
;
;    1. Directly on a ladder block, or
;
;    2. Not falling off the ladder.
;
; 3. Whether the climbing bit is set.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a>:
;         The full X position of the player.
;
; OUTPUTS:
;     C:
;         1 if the player is climbing.
;         0 if the player is not.
;
; XREFS:
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;     <a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a>
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;     <a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a>
;============================================================================
</div><span class="l"><a name="Player_IsClimbing" href="#Player_IsClimbing" class="la">Player_IsClimbing:</a><span class="ce">; [$ecf6]</span></span>
<div class="c">;
; Check if the player can currently climb an available ladder.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$08</span></span><span class="ce">; Can the player currently climb?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If not, return false.</span></span>
<span class="l"></span>
<div class="c">;
; A ladder is available to climb.
;
; Check if the player's X position is on an even block boundary.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerPosX_Full">PlayerPosX_Full</a></span></span><span class="ce">; Load the player's X position.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Is it on a block boundary?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_checkClimbing">@_checkClimbing</a></span></span><span class="ce">; If not, then jump to check if the player is climbing.</span></span>
<span class="l"></span>
<div class="c">;
; The player's X position is on an even byte boundary.
;
; Check if the player is currently falling off a ledge or
; ladder.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$04</span></span><span class="ce">; Is the player currently falling?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If so, return false.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the player is currently climbing.
;
</div><span class="l"><a name="@_checkClimbing" href="#@_checkClimbing" class="lla">@_checkClimbing:</a><span class="ce">; [$ed08]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Is the player climbing?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If not, return false.</span></span>
<span class="l"><span><span class="i">SEC</span></span><span class="ce">; Set C = 1 to return true.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_returnFalse" href="#@_returnFalse" class="lla">@_returnFalse:</a><span class="ce">; [$ed10]</span></span>
<span class="l"><span><span class="i">CLC</span></span><span class="ce">; Set C = 0 to return false.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_DrawSprite
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_DrawSprite" href="#Maybe_Player_DrawSprite" class="la">Maybe_Player_DrawSprite:</a><span class="ce">; [$ed12]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateArmorSprite">Maybe_Player_UpdateArmorSprite</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed15" href="#@LAB_PRG15_MIRROR__ed15" class="lla">@LAB_PRG15_MIRROR__ed15:</a><span class="ce">; [$ed15]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__eea9">FUN_PRG15_MIRROR__eea9</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed15">@LAB_PRG15_MIRROR__ed15</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateWeaponSprite">Maybe_Player_UpdateWeaponSprite</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed34">@LAB_PRG15_MIRROR__ed34</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed28" href="#@LAB_PRG15_MIRROR__ed28" class="lla">@LAB_PRG15_MIRROR__ed28:</a><span class="ce">; [$ed28]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__eebf">FUN_PRG15_MIRROR__eebf</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed28">@LAB_PRG15_MIRROR__ed28</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed34" href="#@LAB_PRG15_MIRROR__ed34" class="lla">@LAB_PRG15_MIRROR__ed34:</a><span class="ce">; [$ed34]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Something_ShieldState">Player_Something_ShieldState</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed3b" href="#@LAB_PRG15_MIRROR__ed3b" class="lla">@LAB_PRG15_MIRROR__ed3b:</a><span class="ce">; [$ed3b]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__ee93">FUN_PRG15_MIRROR__ee93</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed3b">@LAB_PRG15_MIRROR__ed3b</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$ed44]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_UpdateVisibleItemStates
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_SetArmor">Player_SetArmor</a>
;     <a href="#Player_SetShield">Player_SetShield</a>
;     <a href="#Player_SetWeapon">Player_SetWeapon</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_UpdateVisibleItemStates" href="#Maybe_Player_UpdateVisibleItemStates" class="la">Maybe_Player_UpdateVisibleItemStates:</a><span class="ce">; [$ed45]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateArmorSprite">Maybe_Player_UpdateArmorSprite</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed48" href="#@LAB_PRG15_MIRROR__ed48" class="lla">@LAB_PRG15_MIRROR__ed48:</a><span class="ce">; [$ed48]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__eea9">FUN_PRG15_MIRROR__eea9</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed48">@LAB_PRG15_MIRROR__ed48</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateWeaponSprite">Maybe_Player_UpdateWeaponSprite</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed61">@LAB_PRG15_MIRROR__ed61</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed58" href="#@LAB_PRG15_MIRROR__ed58" class="lla">@LAB_PRG15_MIRROR__ed58:</a><span class="ce">; [$ed58]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__eebf">FUN_PRG15_MIRROR__eebf</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed58">@LAB_PRG15_MIRROR__ed58</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed61" href="#@LAB_PRG15_MIRROR__ed61" class="lla">@LAB_PRG15_MIRROR__ed61:</a><span class="ce">; [$ed61]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_Something_ShieldState">Player_Something_ShieldState</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed68" href="#@LAB_PRG15_MIRROR__ed68" class="lla">@LAB_PRG15_MIRROR__ed68:</a><span class="ce">; [$ed68]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__ee93">FUN_PRG15_MIRROR__ee93</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed68">@LAB_PRG15_MIRROR__ed68</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$ed71]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_UpdateArmorSprite
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_UpdateArmorSprite" href="#Maybe_Player_UpdateArmorSprite" class="la">Maybe_Player_UpdateArmorSprite:</a><span class="ce">; [$ed72]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_U">Maybe_Player_AccessorySpriteAddr_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_L">Maybe_Player_AccessorySpriteAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ed87">@LAB_PRG15_MIRROR__ed87</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$01</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ed87" href="#@LAB_PRG15_MIRROR__ed87" class="lla">@LAB_PRG15_MIRROR__ed87:</a><span class="ce">; [$ed87]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_NormArmorState">Maybe_Player_NormArmorState</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ed95,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Player_LoadArmorSprite">Maybe_Player_LoadArmorSprite</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Player_UpdateArmorSprite">Maybe_Player_UpdateArmorSprite</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__ed95" href="#BYTE_ARRAY_PRG15_MIRROR__ed95" class="la">BYTE_ARRAY_PRG15_MIRROR__ed95:</a><span class="ce">; [$ed95]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [0]: Leather armor</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$27</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [2]: Studded Mail</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$27</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$34</span></span><span class="ce">; [4]: Full Plate</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$32</span></span><span class="ce">; [6]: Battle Helmet</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$32</span></span><span class="ce">; [7]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_UpdateWeaponSprite
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_UpdateWeaponSprite" href="#Maybe_Player_UpdateWeaponSprite" class="la">Maybe_Player_UpdateWeaponSprite:</a><span class="ce">; [$ed9d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__edab">@LAB_PRG15_MIRROR__edab</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__edab" href="#@LAB_PRG15_MIRROR__edab" class="lla">@LAB_PRG15_MIRROR__edab:</a><span class="ce">; [$edab]</span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$edc1,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$edc5,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_U">Maybe_Player_AccessorySpriteAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$edc6,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_L">Maybe_Player_AccessorySpriteAddr_L</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Player_LoadWeaponSprite">Maybe_Player_LoadWeaponSprite</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Player_UpdateWeaponSprite">Maybe_Player_UpdateWeaponSprite</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__edc1" href="#BYTE_ARRAY_PRG15_MIRROR__edc1" class="la">BYTE_ARRAY_PRG15_MIRROR__edc1:</a><span class="ce">; [$edc1]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Player_UpdateWeaponSprite">Maybe_Player_UpdateWeaponSprite</a>
;
</div><span class="l"><a name="MAYBE_WEAPON_SPRITE_ADDRS_U" href="#MAYBE_WEAPON_SPRITE_ADDRS_U" class="la">MAYBE_WEAPON_SPRITE_ADDRS_U:</a><span class="ce">; [$edc5]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$80</span></span><span class="ce">; [$edc5] undefined</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_Player_UpdateWeaponSprite">Maybe_Player_UpdateWeaponSprite</a>
;
</div><span class="l"><a name="MAYBE_WEAPON_SPRITE_ADDRS_L" href="#MAYBE_WEAPON_SPRITE_ADDRS_L" class="la">MAYBE_WEAPON_SPRITE_ADDRS_L:</a><span class="ce">; [$edc6]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03,$80,$03,$80,$03,$40,$03</span></span><span class="ce">; [$edc6] undefined</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_Something_ShieldState
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;============================================================================
</div><span class="l"><a name="Player_Something_ShieldState" href="#Player_Something_ShieldState" class="la">Player_Something_ShieldState:</a><span class="ce">; [$edcd]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__eddb">@LAB_PRG15_MIRROR__eddb</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__eddb" href="#@LAB_PRG15_MIRROR__eddb" class="lla">@LAB_PRG15_MIRROR__eddb:</a><span class="ce">; [$eddb]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_U">Maybe_Player_AccessorySpriteAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_L">Maybe_Player_AccessorySpriteAddr_L</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Maybe_Player_LoadShieldSprite">Maybe_Player_LoadShieldSprite</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the player's current weapon.
;
; INPUTS:
;     A:
;         The weapon to set:
;
;         0 = Hand Dagger
;         1 = Long Sword
;         2 = Giant Blade
;         3 = Dragon Slayer
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a name="Player_SetWeapon" href="#Player_SetWeapon" class="la">Player_SetWeapon:</a><span class="ce">; [$edec]</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"></span>
<div class="c">;
; Check that the player is not in a building.
;
; A weapon cannot be set while in a building.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Set A = current area.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this the building?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_setInInventory">@_setInInventory</a></span></span><span class="ce">; If so, branch.</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Set as the current weapon in the inventory.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_setInInventory" href="#@_setInInventory" class="lla">@_setInInventory:</a><span class="ce">; [$edff]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the player's current armor.
;
; INPUTS:
;     A:
;         0 = Leather
;         1 = Studded Mail
;         2 = Full Plate
;         3 = Battle Suit
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a name="Player_SetArmor" href="#Player_SetArmor" class="la">Player_SetArmor:</a><span class="ce">; [$ee05]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the player's current shield.
;
; INPUTS:
;     A:
;         The shield to set:
;
;         0 = Small
;         1 = Large
;         2 = Magic
;         3 = Battle Helmet
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a name="Player_SetShield" href="#Player_SetShield" class="la">Player_SetShield:</a><span class="ce">; [$ee0d]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_LoadArmorSprite
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_UpdateArmorSprite">Maybe_Player_UpdateArmorSprite</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_LoadArmorSprite" href="#Maybe_Player_LoadArmorSprite" class="la">Maybe_Player_LoadArmorSprite:</a><span class="ce">; [$ee15]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8001</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_U">PlayerSprite_ReadAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_U">PlayerSprite_ReadAddr_U</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_LoadWeaponSprite
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_UpdateWeaponSprite">Maybe_Player_UpdateWeaponSprite</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_LoadWeaponSprite" href="#Maybe_Player_LoadWeaponSprite" class="la">Maybe_Player_LoadWeaponSprite:</a><span class="ce">; [$ee3f]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8002</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8003</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_U">PlayerSprite_ReadAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_U">PlayerSprite_ReadAddr_U</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Player_LoadShieldSprite
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_Something_ShieldState">Player_Something_ShieldState</a>
;============================================================================
</div><span class="l"><a name="Maybe_Player_LoadShieldSprite" href="#Maybe_Player_LoadShieldSprite" class="la">Maybe_Player_LoadShieldSprite:</a><span class="ce">; [$ee69]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800c</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800d</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_U">PlayerSprite_ReadAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_U">PlayerSprite_ReadAddr_U</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__ee93
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__ee93" href="#FUN_PRG15_MIRROR__ee93" class="la">FUN_PRG15_MIRROR__ee93:</a><span class="ce">; [$ee93]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800a</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800b</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#LABEL_EED2">LABEL_EED2</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__eea9
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__eea9" href="#FUN_PRG15_MIRROR__eea9" class="la">FUN_PRG15_MIRROR__eea9:</a><span class="ce">; [$eea9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8004</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8005</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#LABEL_EED2">LABEL_EED2</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__eebf
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Player_DrawSprite">Maybe_Player_DrawSprite</a>
;     <a href="#Maybe_Player_UpdateVisibleItemStates">Maybe_Player_UpdateVisibleItemStates</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__eebf" href="#FUN_PRG15_MIRROR__eebf" class="la">FUN_PRG15_MIRROR__eebf:</a><span class="ce">; [$eebf]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8006</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8007</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ee93">FUN_PRG15_MIRROR__ee93</a>
;     <a href="#FUN_PRG15_MIRROR__eea9">FUN_PRG15_MIRROR__eea9</a>
;
</div><span class="l"><a name="LABEL_EED2" href="#LABEL_EED2" class="la">LABEL_EED2:</a><span class="ce">; [$eed2]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Maybe_Player_DAT_00a8">Maybe_Player_DAT_00a8</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#PlayerSprite_ReadAddr_L">PlayerSprite_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_L">Maybe_Player_AccessorySpriteAddr_L</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_U">Maybe_Player_AccessorySpriteAddr_U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ef25" href="#@LAB_PRG15_MIRROR__ef25" class="lla">@LAB_PRG15_MIRROR__ef25:</a><span class="ce">; [$ef25]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_04">Temp_04</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef25">@LAB_PRG15_MIRROR__ef25</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_U">Maybe_Player_AccessorySpriteAddr_U</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_U">Maybe_Player_AccessorySpriteAddr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_L">Maybe_Player_AccessorySpriteAddr_L</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Player_AccessorySpriteAddr_L">Maybe_Player_AccessorySpriteAddr_L</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; DEAD CODE: Unset the special event ID.
;
; This is not used in the game.
;============================================================================
</div><span class="l"><a name="DEAD_FUN_PRG15_MIRROR__ef45" href="#DEAD_FUN_PRG15_MIRROR__ef45" class="la">DEAD_FUN_PRG15_MIRROR__ef45:</a><span class="ce">; [$ef45]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Run special event handlers for the current screen.
;
; This will run code specific to some screens in the game,
; as indicated by the special event ID stored in a screen's
; metadata.
;
; See <a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a>.
;
; If a handler is found, it will be run directly following
; this function.
;
; INPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The loaded special event ID for the current
;         screen.
;
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>:
;         Table mapping special event IDs to handler
;         functions.
;
; OUTPUTS:
;     Stack (A):
;         The address of the handler to run, if any.
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a name="GameLoop_RunScreenEventHandlers" href="#GameLoop_RunScreenEventHandlers" class="la">GameLoop_RunScreenEventHandlers:</a><span class="ce">; [$ef4b]</span></span>
<div class="c">;
; Check if this screen has a special event ID.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Load the screen's special event ID.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, nothing to run. Return.</span></span>
<span class="l"></span>
<div class="c">;
; Check if there's an entry in the table.
;
</div><span class="l"><span><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Take the lower 7 bits.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary for the lookup table.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is it &gt;= 6 (out of bounds)?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<div class="c">;
; Load the address of the handler and push as the new address
; to run.
;
</div><span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ef64,Y</span></span><span class="ce">; Load the lower byte of the handler address.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ef63,Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$ef62]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Special screen events lookup table.
;
; Each maps a special event ID to a handler that will run
; on each tick while on the screen.
;
; MOD NOTES:
;     By moving this table later into the bank and updating
;     both the address in
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;     and the table length in that function (6), you could
;     likely add new special handlers for screens
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;
</div><span class="l"><a name="SPECIAL_SCREEN_EVENT_LOOKUP_TABLE" href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE" class="la">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE:</a><span class="ce">; [$ef63]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$68</span></span><span class="ce">; [0]: Handle pushable block on path to Mascon.</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;
</div><span class="l"><a name="SPECIAL_SCREEN_EVENT_LOOKUP_TABLE_0__1" href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE_0__1" class="la">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE_0__1:</a><span class="ce">; [$ef64]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$9d</span></span><span class="ce">; [1]: Handle a standard boss battle.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d3</span></span><span class="ce">; [2]: Handle end-game sequence after killing the final boss.</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [2]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle checking the path to Mascon at the final fountain.
;
; This is a special screen event handler that checks whether
; the player has completed the quests to reach Mascon.
;
; This is only executed on the first tick for the screen,
; and disabled immediately after. If the fountains were
; completed, this will remove the block obscuring the
; ladder to Mascon and then drop down the ladder.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The quests completed.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The unset special event ID, to prevent this from
;         running more than once.
;
;     <a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a>:
;         Set to the block position to clear.
;
;     <a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a>:
;         Set to 1.
;
; CALLS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
; XREFS:
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>
;     [$PRG15_MIRROR::ef63]
;============================================================================
</div><span class="l"><a name="ScreenEvents_HandlePathToMasconEvent" href="#ScreenEvents_HandlePathToMasconEvent" class="la">ScreenEvents_HandlePathToMasconEvent:</a><span class="ce">; [$ef69]</span></span>
<div class="c">;
; Check if the path to Mascon has been opened.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the list of completed quests.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Is the Mascon path completed?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_notCompleted">@_notCompleted</a></span></span><span class="ce">; If not, jump to return.</span></span>
<span class="l"></span>
<div class="c">;
; The quest has been completed. Turn off this handler (clear
; the event ID) and manage the transition for the path to
; Mascon.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Unset the special event ID.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a></span></span><span class="ce">; Set the path to Mascon as opened.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$56</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; Set the pushable block to X=6, Y=5.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a></span></span><span class="ce">; Drop the ladder down to reach Mascon.</span></span>
<span class="l"></span>
<div class="c">;
; The criteria for the path wasn't set. Clear out this event
; ID so it won't be run until the next time the player is
; on the screen.
;
</div><span class="l"><a name="@_notCompleted" href="#@_notCompleted" class="lla">@_notCompleted:</a><span class="ce">; [$ef82]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Unset the special event ID.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; DEAD CODE: Check if there are sprites not of a given entity.
;
; This does not appear to be used anywhere. It only
; references itself.
;============================================================================
</div><span class="l"><a name="Sprites_HasSpritesNotOfType" href="#Sprites_HasSpritesNotOfType" class="la">Sprites_HasSpritesNotOfType:</a><span class="ce">; [$ef88]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ef8c" href="#@LAB_PRG15_MIRROR__ef8c" class="lla">@LAB_PRG15_MIRROR__ef8c:</a><span class="ce">; [$ef8c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef99">@LAB_PRG15_MIRROR__ef99</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef99">@LAB_PRG15_MIRROR__ef99</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__ef99" href="#@LAB_PRG15_MIRROR__ef99" class="lla">@LAB_PRG15_MIRROR__ef99:</a><span class="ce">; [$ef99]</span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef8c">@LAB_PRG15_MIRROR__ef8c</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle checking for a boss on the screen.
;
; This is a special event handler used for boss rooms.
; It will default the music to boss battle music, and then
; check for the presence of a boss on every game tick.
;
; Once a boss has been defeated, the music will be set back
; to the default for the area and the handler will be shut
; down.
;
; INPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The special event ID for the screen, used to
;         determine which bits of logic should run.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the area.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentMusic">CurrentMusic</a>:
;         The current music being played.
;
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The updated special event ID.
;
; CALLS:
;     <a href="#Sprites_HasBoss">Sprites_HasBoss</a>
;
; XREFS:
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>
;     [$PRG15_MIRROR::ef65]
;============================================================================
</div><span class="l"><a name="ScreenEvents_HandleBoss" href="#ScreenEvents_HandleBoss" class="la">ScreenEvents_HandleBoss:</a><span class="ce">; [$ef9e]</span></span>
<div class="c">;
; Check if bit 7 is set. If not, prepare the boss battle music
; and initial state. This would only be done once on the screen.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_checkForBoss">@_checkForBoss</a></span></span></span>
<span class="l"></span>
<div class="c">;
; This is the first tick on a boss battle screen. Take the
; opportunity to cap any item durations, and default the music
; to the boss battle music.
;
</div><span class="l"><span><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Set bit 7 to only run this conditional on the first game tick.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#LimitItemDurations">LimitItemDurations</a></span></span><span class="ce">; Cap item durations within bounds.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Set the music to the boss battle music.</span></span>
<span class="l"></span>
<div class="c">;
; Check if there's a boss on screen.
;
</div><span class="l"><a name="@_checkForBoss" href="#@_checkForBoss" class="lla">@_checkForBoss:</a><span class="ce">; [$efaf]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_HasBoss">Sprites_HasBoss</a></span></span><span class="ce">; Check for a boss.</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If there is one, we're done. Return.</span></span>
<span class="l"></span>
<div class="c">;
; The boss has been defeated. Restore the game state.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Load the default music for the area.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Set it as the current music.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Clear the special event ID so this doesn't run again.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$efbe]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Ensure Ointment and Hour Glass durations don't go below 0.
;
; If either goes below 0, it will be set to 0.
;
; INPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The Ointment duration.
;
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The Hour Glass duration.
;
; OUTPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The updated Ointment duration.
;
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The updated Hour Glass duration.
;
; XREFS:
;     <a href="#ScreenEvents_HandleBoss">ScreenEvents_HandleBoss</a>
;============================================================================
</div><span class="l"><a name="LimitItemDurations" href="#LimitItemDurations" class="la">LimitItemDurations:</a><span class="ce">; [$efbf]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Load the Ointment duration.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_checkHourGlass">@_checkHourGlass</a></span></span><span class="ce">; If &gt;= 0, move on to the Hour Glass.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Set the Ointment duration to 0.</span></span>
<span class="l"></span>
<span class="l"><a name="@_checkHourGlass" href="#@_checkHourGlass" class="lla">@_checkHourGlass:</a><span class="ce">; [$efc9]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Load the Hour Glass duration.</span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If &gt;= 0, we're done.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Set the Hour Glass duration to 0.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$efd3]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Handle checking for the death of the final boss.
;
; This is a special event handler used for the final boss
; room.
;
; If the boss dies (rather, if all sprite entities are
; cleared from the screen), this will switch back to the
; opening music and area, placing the player back in the
; King's room for the end game outro.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentMusic">CurrentMusic</a>:
;         Set to the Eolis music.
;
; CALLS:
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Sprites_HasCurrentSprites">Sprites_HasCurrentSprites</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;
; XREFS:
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>
;     [$PRG15_MIRROR::ef67]
;============================================================================
</div><span class="l"><a name="ScreenEvents_HandleFinalBossKilled" href="#ScreenEvents_HandleFinalBossKilled" class="la">ScreenEvents_HandleFinalBossKilled:</a><span class="ce">; [$efd4]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprites_HasCurrentSprites">Sprites_HasCurrentSprites</a></span></span><span class="ce">; Are there sprites on screen?</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<div class="c">;
; The final boss is dead. Transition toward the end game
; sequence.
;
; Start by switching the music to the Eolis music.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span><span class="ce">; 0x07 == Eolis music</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"></span>
<div class="c">;
; Play the "Player got hit" sound.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; 0x04 == Player hit sound effect.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#EndGame_Begin">EndGame_Begin</a></span></span><span class="ce">; Begin the end-game sequence.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$efe5]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether the given sprite entity is *not* on the screen.
;
; This will loop through the sprites on screen and check if any
; match the entity type provided.
;
; INPUTS:
;     A:
;         The sprite entity to check for.
;
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The list of current sprite entities on screen.
;
; OUTPUTS:
;     C:
;         0 = Sprite entity is on screen.
;         1 = Sprite entity is not on screen.
;
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; XREFS:
;     <a href="PRG14.html#SpriteBehavior__a354">SpriteBehavior__a354</a>
;     <a href="PRG14.html#SpriteBehavior__a384">SpriteBehavior__a384</a>
;     <a href="PRG14.html#SpriteBehavior__a3bf">SpriteBehavior__a3bf</a>
;     <a href="PRG14.html#SpriteBehavior__a3ef">SpriteBehavior__a3ef</a>
;     <a href="PRG14.html#SpriteBehavior__a413">SpriteBehavior__a413</a>
;     <a href="PRG14.html#SpriteBehavior__a437">SpriteBehavior__a437</a>
;     <a href="PRG14.html#SpriteBehavior__a45b">SpriteBehavior__a45b</a>
;============================================================================
</div><span class="l"><a name="Maybe_IsSpriteEntityNotOnScreen" href="#Maybe_IsSpriteEntityNotOnScreen" class="la">Maybe_IsSpriteEntityNotOnScreen:</a><span class="ce">; [$efe6]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; <a href="RAM.html#Temp_00">Temp_00</a> = Sprite type for comparison.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$07</span></span><span class="ce">; Y = 7</span></span>
<span class="l"></span>
<div class="c">;
; Check the entity for this index in the current sprites list.
;
</div><span class="l"><a name="@_spriteLoop" href="#@_spriteLoop" class="lla">@_spriteLoop:</a><span class="ce">; [$efea]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,Y</span></span><span class="ce">; Load the entity of the sprite at loop index.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Is it the entity the caller is checking for?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextLoopIter">@_prepareNextLoopIter</a></span></span><span class="ce">; If not, prepare for the next loop iteration.</span></span>
<span class="l"></span>
<div class="c">;
; The sprite entity is on the screen. Clear carry as the result.
;
</div><span class="l"><span><span class="i">CLC</span></span><span class="ce">; Return false.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_prepareNextLoopIter" href="#@_prepareNextLoopIter" class="lla">@_prepareNextLoopIter:</a><span class="ce">; [$eff3]</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_spriteLoop">@_spriteLoop</a></span></span><span class="ce">; If Y &gt;= 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; The sprite entity is not on the screen. Set carry as the
; result.
;
</div><span class="l"><span><span class="i">SEC</span></span><span class="ce">; Return true.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether there's a boss on screen.
;
; This loops through all the sprite entities on the screen,
; looks up the category for each, and checks if that
; category is a boss.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The list of current sprite entities on screen.
;
;     <a href="PRG14.html#SPRITE_CATEGORIES_BY_ENTITY">SPRITE_CATEGORIES_BY_ENTITY</a>:
;         Lookup table of entities to categories.
;
; OUTPUTS:
;     C:
;         0 if there is no boss on screen.
;         1 if there is a boss on screen.
;
; XREFS:
;     <a href="#ScreenEvents_HandleBoss">ScreenEvents_HandleBoss</a>
;============================================================================
</div><span class="l"><a name="Sprites_HasBoss" href="#Sprites_HasBoss" class="la">Sprites_HasBoss:</a><span class="ce">; [$eff8]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; X = 7 (loop counter).</span></span>
<span class="l"></span>
<div class="c">;
; Check if this sprite is a boss.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$effa]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Load the sprite entity at that index.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$b544,Y</span></span><span class="ce">; Load the category for the entity.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Is it 7 (boss)?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_notBoss">@_notBoss</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; There is a boss on screen. Return true.
;
</div><span class="l"><span><span class="i">SEC</span></span><span class="ce">; Return true.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_notBoss" href="#@_notBoss" class="lla">@_notBoss:</a><span class="ce">; [$f006]</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X &gt;= 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; There is no boss on screen. Return false.
;
</div><span class="l"><span><span class="i">CLC</span></span><span class="ce">; Return false.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return whether any sprites are currently on screen.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The types of sprites currently on the screen.
;
; OUTPUTS:
;     C:
;         1 if there are sprites on the screen.
;         0 if there are no sprites.
;
; XREFS:
;     <a href="#ScreenEvents_HandleFinalBossKilled">ScreenEvents_HandleFinalBossKilled</a>
;============================================================================
</div><span class="l"><a name="Sprites_HasCurrentSprites" href="#Sprites_HasCurrentSprites" class="la">Sprites_HasCurrentSprites:</a><span class="ce">; [$f00b]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$07</span></span><span class="ce">; Y = 7 (loop counter).</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$f00d]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,Y</span></span><span class="ce">; Load the sprite entity at that index.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it unset?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_prepareNextLoopIter">@_prepareNextLoopIter</a></span></span><span class="ce">; If yes, jump to prepare for the next loop iteration.</span></span>
<span class="l"></span>
<div class="c">;
; A sprite entity was found. Return true.
;
</div><span class="l"><span><span class="i">SEC</span></span><span class="ce">; Return true.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_prepareNextLoopIter" href="#@_prepareNextLoopIter" class="lla">@_prepareNextLoopIter:</a><span class="ce">; [$f016]</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If Y &gt;= 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; A sprite entity was not found. Return false.
;
</div><span class="l"><span><span class="i">CLC</span></span><span class="ce">; Return false.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__f01b
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__f01b" href="#FUN_PRG15_MIRROR__f01b" class="la">FUN_PRG15_MIRROR__f01b:</a><span class="ce">; [$f01b]</span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">PHP</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800a</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800b</span></span></span>
<span class="l"><span><span class="i">PLP</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__f039
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#Player_DrawShield">Player_DrawShield</a>
;     <a href="PRG14.html#Player_DrawWeapon">Player_DrawWeapon</a>
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__f039" href="#FUN_PRG15_MIRROR__f039" class="la">FUN_PRG15_MIRROR__f039:</a><span class="ce">; [$f039]</span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">PHP</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8008</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8009</span></span></span>
<span class="l"><span><span class="i">PLP</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Sprite_Maybe_SetAppearanceAddrFromOffset
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#Sprite_EnterNextAppearancePhase">Sprite_EnterNextAppearancePhase</a>
;     <a href="#CastMagic_Maybe_SetAppearance">CastMagic_Maybe_SetAppearance</a>
;     <a href="#Something_SetXYAndAnimOffset">Something_SetXYAndAnimOffset</a>
;============================================================================
</div><span class="l"><a name="Sprite_Maybe_SetAppearanceAddrFromOffset" href="#Sprite_Maybe_SetAppearanceAddrFromOffset" class="la">Sprite_Maybe_SetAppearanceAddrFromOffset:</a><span class="ce">; [$f057]</span></span>
<div class="c">;
; Switch to ROM bank 7 (PRG).
;
</div><span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A (offset)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 7 (PRG).</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y (restore offset)</span></span>
<span class="l"></span>
<div class="c">;
; Load the address to load sprite images from.
;
; With the addresses stored in PRG7::8006 and
; PRG7::8007, this should put us at a starting
; point of {@address PRG7::9036}, or {@address PRG7::9136} if offset
; overflowed.
;
</div><span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply offset by 2, to get word boundaries in the lookup table.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A (updated offset)</span></span>
<span class="l"><span><span class="i">PHP</span></span><span class="ce">; Push flags and stack pointer.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8006</span></span><span class="ce">; Load the lower byte of the address to read from.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it for processing.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$8007</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">PLP</span></span><span class="ce">; Pop the flags and stack pointer.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 + carry to the upper byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Sprite_Maybe_SetAppearanceAddr
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__f01b">FUN_PRG15_MIRROR__f01b</a>
;     <a href="#FUN_PRG15_MIRROR__f039">FUN_PRG15_MIRROR__f039</a>
;============================================================================
</div><span class="l"><a name="Sprite_Maybe_SetAppearanceAddr" href="#Sprite_Maybe_SetAppearanceAddr" class="la">Sprite_Maybe_SetAppearanceAddr:</a><span class="ce">; [$f072]</span></span>
<div class="c">;
; Load the offset within our starting address stored in
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the offset for the lower byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++ (offset)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 + carry to it.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp_Sprite_U">Maybe_Temp_Sprite_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Load a byte from that offset. The upper nibble will be
; stored at <a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a> and the lower nibble
; will be in
; <a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a>.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span><span class="ce">; Load the value at that address.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Discard the upper nibble.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span><span class="ce">; Load it again.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Move upper nibble to lower.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Initialize <a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a> and
; <a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a> to 0.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span><span class="ce">; Set to 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span><span class="ce">; Set to 0.</span></span>
<span class="l"></span>
<div class="c">;
; Load a byte from the next offset.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span><span class="ce">; Load the byte at the next offset.</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f09a">@LAB_PRG15_MIRROR__f09a</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span><span class="ce">; Set to 0xFF.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f09a" href="#@LAB_PRG15_MIRROR__f09a" class="lla">@LAB_PRG15_MIRROR__f09a:</a><span class="ce">; [$f09a]</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span><span class="ce">; Add the loaded value to <a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a>.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Calculate the new value for <a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span><span class="ce">; Add our stored value.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span><span class="ce">; Store it back out.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#ScrollHelp_Pixel">ScrollHelp_Pixel</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load a byte from the next offset.
;
</div><span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f0b3">@LAB_PRG15_MIRROR__f0b3</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span><span class="ce">; Set to 0xFF</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f0b3" href="#@LAB_PRG15_MIRROR__f0b3" class="lla">@LAB_PRG15_MIRROR__f0b3:</a><span class="ce">; [$f0b3]</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Calculate the new value for <a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a>.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set a new start address for the next sprite based on the
; next byte in the series.
;
</div><span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span><span class="ce">; Load the next byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">;  and store that as the new start offset.</span></span>
<span class="l"></span>
<div class="c">;
; Advance our start read address for this sprite to skip the 4
; bytes we just read.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Advance by 4.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a></span></span><span class="ce">; Set as the new lower byte of the address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Temp_Sprite_U">Maybe_Temp_Sprite_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry, if lower overflowed.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp_Sprite_U">Maybe_Temp_Sprite_U</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<div class="c">;
; We'll continue on based on whether the sprite is flipped.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f0ec">@LAB_PRG15_MIRROR__f0ec</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f181">@LAB_PRG15_MIRROR__f181</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The sprite is not flipped.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__f0ec" href="#@LAB_PRG15_MIRROR__f0ec" class="lla">@LAB_PRG15_MIRROR__f0ec:</a><span class="ce">; [$f0ec]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span><span class="ce">; Store it as our tiles Y offset.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<span class="l"><a name="@_spriteDataIsSet" href="#@_spriteDataIsSet" class="lla">@_spriteDataIsSet:</a><span class="ce">; [$f0f1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Load the number of tile columns remaining.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span><span class="ce">; Store as the start tiles X offset.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the current sprite data value is not 0xFF.
;
</div><span class="l"><a name="@_innerLop" href="#@_innerLop" class="lla">@_innerLop:</a><span class="ce">; [$f0f8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span><span class="ce">; Load the value at the sprite data read address.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_prepareNextX">@_prepareNextX</a></span></span><span class="ce">; If so, skip this.</span></span>
<span class="l"></span>
<div class="c">;
; It's not 0xFF.
;
; Begin checking if we can add to the screen buffer.
;
; First we'll check if we can add sprites this frame.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Sprites_ResetAtFrame">Something_Sprites_ResetAtFrame</a></span></span><span class="ce">; Can we add sprites this frame?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_finishLoopIter">@_finishLoopIter</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<div class="c">;
; We can add sprites.
;
; Check if this sprite would fit on screen.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span><span class="ce">; X = tile X offset</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; A = normalized X position</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$f23d,X</span></span><span class="ce">; A += the offset from the lookup table at X.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span><span class="ce">; Load the default X position.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry (from overflow), if set.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_finishLoopIter">@_finishLoopIter</a></span></span><span class="ce">; If it doesn't fit on screen, jump.</span></span>
<span class="l"></span>
<div class="c">;
; X could fit on screen. Check Y.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span><span class="ce">; X = tile Y offset</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span><span class="ce">; A = normalized Y position</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$f23d,X</span></span><span class="ce">; A += the offset from the lookup table at X</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span><span class="ce">; Load the default Y position.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry (from overflow), if set.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_finishLoopIter">@_finishLoopIter</a></span></span><span class="ce">; If it doesn't fit on screen, jump.</span></span>
<span class="l"></span>
<div class="c">;
; The sprite fits on screen.
;
; We'll begin adding to the screen buffer.
;
</div><span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push our loop counter to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o"><a href="RAM.html#Maybe_FrameAltToggleFlags">Maybe_FrameAltToggleFlags</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Store the result in the screen buffer at X.
;
</div><span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f224,Y</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f151">@LAB_PRG15_MIRROR__f151</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Store the result in the screen buffer at X.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__f151" href="#@LAB_PRG15_MIRROR__f151" class="lla">@LAB_PRG15_MIRROR__f151:</a><span class="ce">; [$f151]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Load the first to store.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span><span class="ce">; Store it in the screen buffer at X.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Load the second to store.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span><span class="ce">; Store it in the screen buffer at X.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprite_Something_ChangeBitsAndMaybeInc">Sprite_Something_ChangeBitsAndMaybeInc</a></span></span><span class="ce">; Finish up with this sprite's state.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A (loop counter) from stack.</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<span class="l"><a name="@_finishLoopIter" href="#@_finishLoopIter" class="lla">@_finishLoopIter:</a><span class="ce">; [$f161]</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_prepareNextX" href="#@_prepareNextX" class="lla">@_prepareNextX:</a><span class="ce">; [$f162]</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_innerLop">@_innerLop</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f175">@LAB_PRG15_MIRROR__f175</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@_spriteDataIsSet">@_spriteDataIsSet</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f175" href="#@LAB_PRG15_MIRROR__f175" class="lla">@LAB_PRG15_MIRROR__f175:</a><span class="ce">; [$f175]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; The sprite is flipped.
;
</div><span class="l"><a name="@LAB_PRG15_MIRROR__f181" href="#@LAB_PRG15_MIRROR__f181" class="lla">@LAB_PRG15_MIRROR__f181:</a><span class="ce">; [$f181]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f198">@LAB_PRG15_MIRROR__f198</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f198" href="#@LAB_PRG15_MIRROR__f198" class="lla">@LAB_PRG15_MIRROR__f198:</a><span class="ce">; [$f198]</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f1a8" href="#@LAB_PRG15_MIRROR__f1a8" class="lla">@LAB_PRG15_MIRROR__f1a8:</a><span class="ce">; [$f1a8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f1ac" href="#@LAB_PRG15_MIRROR__f1ac" class="lla">@LAB_PRG15_MIRROR__f1ac:</a><span class="ce">; [$f1ac]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f216">@LAB_PRG15_MIRROR__f216</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Sprites_ResetAtFrame">Something_Sprites_ResetAtFrame</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f215">@LAB_PRG15_MIRROR__f215</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$f23d,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_SpriteData_X">Something_SpriteData_X</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f215">@LAB_PRG15_MIRROR__f215</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$f23d,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_SpriteData_Y">Something_SpriteData_Y</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f215">@LAB_PRG15_MIRROR__f215</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o"><a href="RAM.html#Maybe_FrameAltToggleFlags">Maybe_FrameAltToggleFlags</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Maybe_Temp_Sprite_L">Maybe_Temp_Sprite_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f226,Y</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f205">@LAB_PRG15_MIRROR__f205</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f205" href="#@LAB_PRG15_MIRROR__f205" class="lla">@LAB_PRG15_MIRROR__f205:</a><span class="ce">; [$f205]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">#$0700,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sprite_Something_ChangeBitsAndMaybeInc">Sprite_Something_ChangeBitsAndMaybeInc</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f215" href="#@LAB_PRG15_MIRROR__f215" class="lla">@LAB_PRG15_MIRROR__f215:</a><span class="ce">; [$f215]</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f216" href="#@LAB_PRG15_MIRROR__f216" class="lla">@LAB_PRG15_MIRROR__f216:</a><span class="ce">; [$f216]</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f1ac">@LAB_PRG15_MIRROR__f1ac</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f1a8">@LAB_PRG15_MIRROR__f1a8</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f175">@LAB_PRG15_MIRROR__f175</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__f224" href="#BYTE_ARRAY_PRG15_MIRROR__f224" class="la">BYTE_ARRAY_PRG15_MIRROR__f224:</a><span class="ce">; [$f224]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__f226" href="#BYTE_ARRAY_PRG15_MIRROR__f226" class="la">BYTE_ARRAY_PRG15_MIRROR__f226:</a><span class="ce">; [$f226]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Sprite_Something_ChangeBitsAndMaybeInc
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a>
;============================================================================
</div><span class="l"><a name="Sprite_Something_ChangeBitsAndMaybeInc" href="#Sprite_Something_ChangeBitsAndMaybeInc" class="la">Sprite_Something_ChangeBitsAndMaybeInc:</a><span class="ce">; [$f228]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">EOR</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_0025">BYTE_0025</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Something_Sprites_ResetAtFrame">Something_Sprites_ResetAtFrame</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$f23c]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Sprite_Maybe_SetAppearanceAddr">Sprite_Maybe_SetAppearanceAddr</a>
;
</div><span class="l"><a name="SPRITE_TILE_OFFSETS" href="#SPRITE_TILE_OFFSETS" class="la">SPRITE_TILE_OFFSETS:</a><span class="ce">; [$f23d]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$38</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$40</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$48</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$58</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [12]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$68</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$70</span></span><span class="ce">; [14]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$78</span></span><span class="ce">; [15]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__f24d
;
; INPUTS:
;     A
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__f24d" href="#FUN_PRG15_MIRROR__f24d" class="la">FUN_PRG15_MIRROR__f24d:</a><span class="ce">; [$f24d]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f27d">@LAB_PRG15_MIRROR__f27d</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f2e3">FUN_PRG15_MIRROR__f2e3</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Palette_CurrentIndex">Palette_CurrentIndex</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$09</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f271" href="#@LAB_PRG15_MIRROR__f271" class="lla">@LAB_PRG15_MIRROR__f271:</a><span class="ce">; [$f271]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f316">FUN_PRG15_MIRROR__f316</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f27e">@LAB_PRG15_MIRROR__f27e</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f271">@LAB_PRG15_MIRROR__f271</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f27d" href="#@LAB_PRG15_MIRROR__f27d" class="lla">@LAB_PRG15_MIRROR__f27d:</a><span class="ce">; [$f27d]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f27e" href="#@LAB_PRG15_MIRROR__f27e" class="lla">@LAB_PRG15_MIRROR__f27e:</a><span class="ce">; [$f27e]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear the portrait from the textbox.
;
; INPUTS:
;     <a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a>:
;         The palette index to restore.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_03C7">Temp_03C7</a>:
;         Set to 0xFF.
;
; CALLS:
;     <a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a>
;     <a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a>
;     <a href="#PPUBuffer_Append0">PPUBuffer_Append0</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_EndScript">IScriptAction_EndScript</a>
;============================================================================
</div><span class="l"><a name="IScripts_ClearPortrait" href="#IScripts_ClearPortrait" class="la">IScripts_ClearPortrait:</a><span class="ce">; [$f281]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Palette_LoadFromIndex">Palette_LoadFromIndex</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Append0">PPUBuffer_Append0</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14 and run
; <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
; (from bank 15).
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_14_LOGIC</span></span><span class="ce">; Bank = 14
Address = <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>-1</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterFarJump" href="#@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$f298]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;
</div><span class="l"><a name="POP_RETURN_F299" href="#POP_RETURN_F299" class="la">POP_RETURN_F299:</a><span class="ce">; [$f299]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document IScripts_DrawPortraitAnimationFrame
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;============================================================================
</div><span class="l"><a name="IScripts_DrawPortraitAnimationFrame" href="#IScripts_DrawPortraitAnimationFrame" class="la">IScripts_DrawPortraitAnimationFrame:</a><span class="ce">; [$f29b]</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">BMI</span> <span class="o"><a href="#POP_RETURN_F299">POP_RETURN_F299</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Update the general portrait image.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$90</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_Temp03C7Times5">Something_Temp03C7Times5</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f01b">FUN_PRG15_MIRROR__f01b</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Update the eye animation.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$90</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_Temp03C7Times5">Something_Temp03C7Times5</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$f2df,X</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f01b">FUN_PRG15_MIRROR__f01b</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Update the mouth animation.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$90</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_CurrentSprite_PPUOffset">Maybe_CurrentSprite_PPUOffset</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_Temp03C7Times5">Something_Temp03C7Times5</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$f2e1,X</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__f01b">FUN_PRG15_MIRROR__f01b</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Something_Temp03C7Times5
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;============================================================================
</div><span class="l"><a name="Something_Temp03C7Times5" href="#Something_Temp03C7Times5" class="la">Something_Temp03C7Times5:</a><span class="ce">; [$f2d5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__f2df" href="#BYTE_ARRAY_PRG15_MIRROR__f2df" class="la">BYTE_ARRAY_PRG15_MIRROR__f2df:</a><span class="ce">; [$f2df]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__f2e1" href="#BYTE_ARRAY_PRG15_MIRROR__f2e1" class="la">BYTE_ARRAY_PRG15_MIRROR__f2e1:</a><span class="ce">; [$f2e1]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__f2e3
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__f24d">FUN_PRG15_MIRROR__f24d</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__f2e3" href="#FUN_PRG15_MIRROR__f2e3" class="la">FUN_PRG15_MIRROR__f2e3:</a><span class="ce">; [$f2e3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp_03C7">Temp_03C7</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800e</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:#$800f</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__f316">FUN_PRG15_MIRROR__f316</a>
;
</div><span class="l"><a name="LABEL_F30F" href="#LABEL_F30F" class="la">LABEL_F30F:</a><span class="ce">; [$f30f]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__f316
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     C
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__f24d">FUN_PRG15_MIRROR__f24d</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__f316" href="#FUN_PRG15_MIRROR__f316" class="la">FUN_PRG15_MIRROR__f316:</a><span class="ce">; [$f316]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#LABEL_F30F">LABEL_F30F</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:#$8010</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:#$8011</span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f34e" href="#@LAB_PRG15_MIRROR__f34e" class="lla">@LAB_PRG15_MIRROR__f34e:</a><span class="ce">; [$f34e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_04">Temp_04</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f34e">@LAB_PRG15_MIRROR__f34e</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Play a sound effect.
;
; This may set the sound effect as the current one or
; it may set it as the next one, depending on the
; priority level of the sound effect.
;
; A lower number in <a href="#SOUND_PRIORITIES">SOUND_PRIORITIES</a> is a higher
; priority.
;
; INPUTS:
;     A:
;         The ID of the sound effect to set.
;
;     <a href="RAM.html#CurrentSoundIndex">CurrentSoundIndex</a>:
;         The currently-played sound effect.
;
;     <a href="#SOUND_PRIORITIES">SOUND_PRIORITIES</a>:
;         The table of sound effect priorities.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSoundIndex">CurrentSoundIndex</a>:
;         The new value for the current sound ID, if set.
;
;     <a href="RAM.html#NextSoundEffect">NextSoundEffect</a>:
;         The new value for the next sound effect, if set.
;
; XREFS:
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;============================================================================
</div><span class="l"><a name="PlaySoundInner" href="#PlaySoundInner" class="la">PlaySoundInner:</a><span class="ce">; [$f36f]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$1d</span></span><span class="ce">; Length of sound IDs array</span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; Is this under the length?</span></span>
<span class="l"></span>
<div class="c">;
; XXX Check if we're playing a sound effect in this
; table, or playing something else?
;
</div><span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = new sound ID</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#CurrentSoundIndex">CurrentSoundIndex</a></span></span><span class="ce">; Y = current sound ID</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f388,Y</span></span><span class="ce">; A = Sound type for current sound from map</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f388,X</span></span><span class="ce">; Is this already the current sound?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_queueNext">@_queueNext</a></span></span><span class="ce">; If yes, then jump</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_queueNext">@_queueNext</a></span></span><span class="ce">; If less than, then jump.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentSoundIndex">CurrentSoundIndex</a></span></span><span class="ce">; Set as the current sound.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_queueNext" href="#@_queueNext" class="lla">@_queueNext:</a><span class="ce">; [$f385]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#NextSoundEffect">NextSoundEffect</a></span></span><span class="ce">; Queue this up as the next effect.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$f387]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Table of sound effect priorities, indexed by sound ID.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#PlaySoundInner">PlaySoundInner</a>
;
</div><span class="l"><a name="SOUND_PRIORITIES" href="#SOUND_PRIORITIES" class="la">SOUND_PRIORITIES:</a><span class="ce">; [$f388]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$15</span></span><span class="ce">; [2]: Hit enemy with weapon</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [3]: Enemy is dead</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [4]: Player hit</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$19</span></span><span class="ce">; [5]: Magic</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [6]: Open door</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [8]: Item picked up</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [9]: Touched coin</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$17</span></span><span class="ce">; [10]: Cast magic hit an obstacle</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [11]: Cursor moved</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [12]: Text input</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [14]: Password character entered</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [15]: Block pushed</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [16]: Coin dropped</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [17]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [18]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [19]: Filling HP or MP</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [20]: Tilte magic cast</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [21]: Player taking step</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [22]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [23]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [24]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [25]: Gold changed</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [26]: Item used</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [27]: Touched meat</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [28]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load glyph data for all strings into the PPU tile map.
;
; Glyph data is located in Bank 13 at $8000.
;
; INPUTS:
;     CurrentROMBank:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         Updated with the write position.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;     <a href="#PPU_WriteGlyphTile">PPU_WriteGlyphTile</a>
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;============================================================================
</div><span class="l"><a name="PPU_LoadGlyphsForStrings" href="#PPU_LoadGlyphsForStrings" class="la">PPU_LoadGlyphsForStrings:</a><span class="ce">; [$f3a5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0d</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$80</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$12</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$60</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f3c2" href="#@LAB_PRG15_MIRROR__f3c2" class="lla">@LAB_PRG15_MIRROR__f3c2:</a><span class="ce">; [$f3c2]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WriteGlyphTile">PPU_WriteGlyphTile</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WriteGlyphTile">PPU_WriteGlyphTile</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f3d1">@LAB_PRG15_MIRROR__f3d1</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f3d1" href="#@LAB_PRG15_MIRROR__f3d1" class="lla">@LAB_PRG15_MIRROR__f3d1:</a><span class="ce">; [$f3d1]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f3c2">@LAB_PRG15_MIRROR__f3c2</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Update the ROM bank in register A pushed to the stack.
;
; INPUTS:
;     Stack (A):
;         The stack to pop A from, containing the bank.
;
; OUTPUTS:
;     Stack (A):
;         The stack will be popped.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__f2e3">FUN_PRG15_MIRROR__f2e3</a>
;     <a href="#FUN_PRG15_MIRROR__fbaf">FUN_PRG15_MIRROR__fbaf</a>
;     <a href="#GameLoop_LoadSpriteInfo">GameLoop_LoadSpriteInfo</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;     <a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a>
;     <a href="#TextBox_Maybe_ShowNextCharFromBank">TextBox_Maybe_ShowNextCharFromBank</a>
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;     <a href="#TextBox_ShowNextChar">TextBox_ShowNextChar</a>
;============================================================================
</div><span class="l"><a name="MMC1_UpdatePRGBankToStackA" href="#MMC1_UpdatePRGBankToStackA" class="la">MMC1_UpdatePRGBankToStackA:</a><span class="ce">; [$f3d6]</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop the bank from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a glyph to the list of tiles in the PPU.
;
; This is used by <a href="#PPU_LoadGlyphsForStrings">PPU_LoadGlyphsForStrings</a> to
; write a glyph tile for later use.
;
; INPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The temporary address to read bytes from.
;
; OUTPUTS:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         Data will be written to the PPU.
;
; XREFS:
;     <a href="#PPU_LoadGlyphsForStrings">PPU_LoadGlyphsForStrings</a>
;============================================================================
</div><span class="l"><a name="PPU_WriteGlyphTile" href="#PPU_WriteGlyphTile" class="la">PPU_WriteGlyphTile:</a><span class="ce">; [$f3dc]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$f3de]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; Load the byte from the temp string address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$08</span></span><span class="ce">; Have we written 8 bytes?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load the specified message and progressively show it.
;
; Each character in the message will be shown one-by-one.
;
; INPUTS:
;     A:
;         The message ID to show.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#Messages_Load">Messages_Load</a>
;     <a href="#TextBox_Maybe_ShowNextCharFromBank">TextBox_Maybe_ShowNextCharFromBank</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_ShowBuySellMenu">IScriptAction_ShowBuySellMenu</a>
;============================================================================
</div><span class="l"><a name="Maybe_Menu_ShowMessageID" href="#Maybe_Menu_ShowMessageID" class="la">Maybe_Menu_ShowMessageID:</a><span class="ce">; [$f3e9]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Messages_Load">Messages_Load</a></span></span><span class="ce">; Load the message.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$f3ec]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_Maybe_ShowNextCharFromBank">TextBox_Maybe_ShowNextCharFromBank</a></span></span><span class="ce">; Show the next character from the message.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; Is it 0xFF (end of message)?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Load a message from the message list.
;
; This will switch to Bank 13 and load a message from
; there at the specified message index.
;
; This works by scanning strings. It starts at the first
; message ($8300) and walks up to the messag index (or,
; technically, down from the message index - 1 to 0),
; scanning every character until the message terminator
; (0xFF) is hit.
;
; When we both hit the last message and hit the last
; terminator, we're done. We'll have the address of
; the message and the length.
;
; After loading, this will restore the bank and then
; fall through to <a href="#TextBox_ClearShopSize">TextBox_ClearShopSize</a>.
;
; INPUTS:
;     A:
;         The 1-based index of the message to load.
;
;     <a href="PRG13.html#MESSAGE_STRINGS">MESSAGE_STRINGS</a>:
;         The list of messages to scan.
;
; OUTPUTS:
;     <a href="RAM.html#Maybe_MessageLength">Maybe_MessageLength</a>:
;         The length of the message string.
;
;     <a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a>:
;         The starting message character position (0).
;
;     #$0219:
;     <a href="RAM.html#LoadedMessageAddr">LoadedMessageAddr</a>:
;         The address of the start of the message string.
;
;     #$e9:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Set to address $1400.
;
;     <a href="RAM.html#TextBox_MessageEnded">TextBox_MessageEnded</a>:
;     <a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a>:
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;     <a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a>:
;         All set to 0.
;
;     <a href="RAM.html#MaybeUnused_Arg_TextBox_Height">MaybeUnused_Arg_TextBox_Height</a>:
;         Set to 4.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_22">IScriptAction_22</a>
;     <a href="PRG12.html#IScriptAction_OpenShop">IScriptAction_OpenShop</a>
;     <a href="PRG12.html#IScriptAction_ShowMessage">IScriptAction_ShowMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowQuestionMessage">IScriptAction_ShowQuestionMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowSellMenu">IScriptAction_ShowSellMenu</a>
;     <a href="PRG12.html#IScriptAction_ShowUnskippableMessage">IScriptAction_ShowUnskippableMessage</a>
;     <a href="PRG12.html#Shop_ShowMessage">Shop_ShowMessage</a>
;     <a href="#Maybe_Menu_ShowMessageID">Maybe_Menu_ShowMessageID</a>
;============================================================================
</div><span class="l"><a name="Messages_Load" href="#Messages_Load" class="la">Messages_Load:</a><span class="ce">; [$f3f5]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Save our current bank.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; A = Our current bank</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Switch to Bank 13 for the strings.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$0d</span></span><span class="ce">; Update to Bank 13.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the start of the messages string (<a href="PRG13.html#MESSAGE_STRINGS">MESSAGE_STRINGS</a>).
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; Set the lower byte of the address for the strings.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$83</span></span><span class="ce">; Set the upper byte of the address for the strings.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the start of our message length for the
; string scan.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (start of our lookup offset)</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a></span></span><span class="ce">; Set start character pos to 0</span></span>
<span class="l"></span>
<div class="c">;
; Prepare to loop through the message characters, starting
; at Message ID - 1 and going through 0.
;
; This will effectively from message ID 0 to the end of the
; provided message ID. We'll be doing a full string scan of
; every string along the way (there's no lookup table).
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; X = MessageID</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_afterLoops">@_afterLoops</a></span></span><span class="ce">; If 0, don't do the message string index loop.</span></span>
<span class="l"></span>
<div class="c">;
; Loop through characters in the current message string.
;
; We'll loop until we hit the end of a string.
;
</div><span class="l"><a name="@_messageLoop" href="#@_messageLoop" class="lla">@_messageLoop:</a><span class="ce">; [$f414]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Character at Y from the current string.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<div class="c">;
; If Y == 0, increment our upper byte position. This
; will happen when Y wraps around from 0xFF to 0.
;
</div><span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_checkChar">@_checkChar</a></span></span><span class="ce">; If Y != 0, jump.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Y is 0. Increment upper byte position.</span></span>
<span class="l"></span>
<div class="c">;
; Check if we hit a string terminator (0xFF). If so,
; decrement the local message ID index.
;
</div><span class="l"><a name="@_checkChar" href="#@_checkChar" class="lla">@_checkChar:</a><span class="ce">; [$f41b]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is A (the character) 0xFF?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_messageLoop">@_messageLoop</a></span></span><span class="ce">; If not 0xFF, loop.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; A is 0xFF. X-- to the previous message ID.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_messageLoop">@_messageLoop</a></span></span><span class="ce">; If X != 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We found the start position of our string (or were there
; already). We're done. Begin storing state.
;
</div><span class="l"><a name="@_afterLoops" href="#@_afterLoops" class="lla">@_afterLoops:</a><span class="ce">; [$f422]</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#Maybe_MessageLength">Maybe_MessageLength</a></span></span><span class="ce">; Message length = Y</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Load the new lower byte of the string position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr">LoadedMessageAddr</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Load the new upper byte of the string position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr.U">LoadedMessageAddr.U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; Restore our previous bank.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A (our previous bank) off the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch bank to the bank.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO
;
; This falls through to
; <a href="#TextBox_ClearShopSizeAtOffset">TextBox_ClearShopSizeAtOffset</a>.
;
; INPUTS:
;     X:
;         The offset into the PPU to fill.
;
; OUTPUTS:
;     #$e9:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Set to address $1400.
;
;     <a href="RAM.html#TextBox_MessageEnded">TextBox_MessageEnded</a>:
;     <a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a>:
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;     <a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a>:
;         All set to 0.
;
;     <a href="RAM.html#MaybeUnused_Arg_TextBox_Height">MaybeUnused_Arg_TextBox_Height</a>:
;         Set to 4.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_ShowPassword">IScriptAction_ShowPassword</a>
;============================================================================
</div><span class="l"><a name="TextBox_ClearShopSize" href="#TextBox_ClearShopSize" class="la">TextBox_ClearShopSize:</a><span class="ce">; [$f434]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_MessageEnded">TextBox_MessageEnded</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$04</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#MaybeUnused_Arg_TextBox_Height">MaybeUnused_Arg_TextBox_Height</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ClearShopSizeAtOffset
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#IScripts_Something_9910">IScripts_Something_9910</a>
;============================================================================
</div><span class="l"><a name="TextBox_ClearShopSizeAtOffset" href="#TextBox_ClearShopSizeAtOffset" class="la">TextBox_ClearShopSizeAtOffset:</a><span class="ce">; [$f44a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$14</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$20</span></span></span>
<span class="l"></span>
<span class="l"><a name="@_writeLoop" href="#@_writeLoop" class="lla">@_writeLoop:</a><span class="ce">; [$f454]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">DEY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_writeLoop">@_writeLoop</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Maybe_TextBox_ShowCurrentMessageID">Maybe_TextBox_ShowCurrentMessageID</a>
;
</div><span class="l"><a name="TextBox_ClearShopSizeAtOffset_return" href="#TextBox_ClearShopSizeAtOffset_return" class="la">TextBox_ClearShopSizeAtOffset_return:</a><span class="ce">; [$f465]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Show the next character in a textbox.
;
; This will temporarily switch to bank 13 (strings),
; increment the position to show, and show it.
;
; INPUTS:
;     CurrentROMBank:
;         The current ROM bank.
;
;     <a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a>:
;         The current message character position.
;
; OUTPUTS:
;     <a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a>:
;         The incremented position.
;
;     <a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a>:
;         Set to 1.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;     <a href="#Maybe_TextBox_ShowCurrentMessageID">Maybe_TextBox_ShowCurrentMessageID</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_22">IScriptAction_22</a>
;     <a href="PRG12.html#IScriptAction_OpenShop">IScriptAction_OpenShop</a>
;     <a href="PRG12.html#IScriptAction_ShowMessage">IScriptAction_ShowMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowQuestionMessage">IScriptAction_ShowQuestionMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowSellMenu">IScriptAction_ShowSellMenu</a>
;     <a href="PRG12.html#IScriptAction_ShowUnskippableMessage">IScriptAction_ShowUnskippableMessage</a>
;     <a href="PRG12.html#Shop_ShowMessage">Shop_ShowMessage</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowNextChar" href="#TextBox_ShowNextChar" class="la">TextBox_ShowNextChar:</a><span class="ce">; [$f466]</span></span>
<div class="c">;
; Save the current bank and switch to bank 13 (strings).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; A = current bank</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0d</span></span><span class="ce">; X = 13 (bank)</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to bank 13.</span></span>
<span class="l"></span>
<div class="c">;
; Show the next character.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a></span></span><span class="ce">; Increment the next character position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; A = 1</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Maybe_TextBox_ShowCurrentMessageID">Maybe_TextBox_ShowCurrentMessageID</a></span></span><span class="ce">; Show this character in the message.</span></span>
<span class="l"></span>
<div class="c">;
; Restore the bank and return.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore the pushed bank.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_Maybe_ShowNextCharFromBank
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Maybe_Menu_ShowMessageID">Maybe_Menu_ShowMessageID</a>
;============================================================================
</div><span class="l"><a name="TextBox_Maybe_ShowNextCharFromBank" href="#TextBox_Maybe_ShowNextCharFromBank" class="la">TextBox_Maybe_ShowNextCharFromBank:</a><span class="ce">; [$f47d]</span></span>
<div class="c">;
; Save the current ROM.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"></span>
<div class="c">;
; Switch to Bank 13, where the strings are.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$0d</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_Something_ShowMessage_f4a2">TextBox_Something_ShowMessage_f4a2</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_TextBox_ShowCurrentMessageID
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowNextChar">TextBox_ShowNextChar</a>
;============================================================================
</div><span class="l"><a name="Maybe_TextBox_ShowCurrentMessageID" href="#Maybe_TextBox_ShowCurrentMessageID" class="la">Maybe_TextBox_ShowCurrentMessageID:</a><span class="ce">; [$f491]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; Load the message ID to show.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ClearShopSizeAtOffset_return">TextBox_ClearShopSizeAtOffset_return</a></span></span><span class="ce">; If unset, return.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_MessageEnded">TextBox_MessageEnded</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#TextBox_ClearShopSizeAtOffset_return">TextBox_ClearShopSizeAtOffset_return</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a></span></span><span class="ce">; Load the character position to display.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Check the first 2 bits.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#TextBox_ClearShopSizeAtOffset_return">TextBox_ClearShopSizeAtOffset_return</a></span></span><span class="ce">; If neither bit is set, return.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_Something_ShowMessage_f4a2
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_Maybe_ShowNextCharFromBank">TextBox_Maybe_ShowNextCharFromBank</a>
;============================================================================
</div><span class="l"><a name="TextBox_Something_ShowMessage_f4a2" href="#TextBox_Something_ShowMessage_f4a2" class="la">TextBox_Something_ShowMessage_f4a2:</a><span class="ce">; [$f4a2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$90</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f4c3">@LAB_PRG15_MIRROR__f4c3</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Convert the player's title to an index in the string list.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span><span class="ce">; Load the player's title.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left 4, converting to an index.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f649,X</span></span><span class="ce">; Look up the string.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f4c3" href="#@LAB_PRG15_MIRROR__f4c3" class="lla">@LAB_PRG15_MIRROR__f4c3:</a><span class="ce">; [$f4c3]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_LoadMessage
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Newline">TextBox_ShowMessage_Newline</a>
;     <a href="#TextBox_Something_ShowMessage_f4a2">TextBox_Something_ShowMessage_f4a2</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_LoadMessage" href="#TextBox_ShowMessage_LoadMessage" class="la">TextBox_ShowMessage_LoadMessage:</a><span class="ce">; [$f4c8]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr">LoadedMessageAddr</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr.U">LoadedMessageAddr.U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Maybe_MessageLength">Maybe_MessageLength</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Maybe_MessageLength">Maybe_MessageLength</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f4dd">@LAB_PRG15_MIRROR__f4dd</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr.U">LoadedMessageAddr.U</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f4dd" href="#@LAB_PRG15_MIRROR__f4dd" class="lla">@LAB_PRG15_MIRROR__f4dd:</a><span class="ce">; [$f4dd]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_EndOfMessage">TextBox_ShowMessage_EndOfMessage</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$fe</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Newline">TextBox_ShowMessage_Newline</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$fd</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Space">TextBox_ShowMessage_Space</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$fb</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_ShowPlayerTitle">TextBox_ShowMessage_ShowPlayerTitle</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$fc</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Pause">TextBox_ShowMessage_Pause</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessageWithSound
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_ShowPlayerTitle">TextBox_ShowMessage_ShowPlayerTitle</a>
;     <a href="#TextBox_Something_ShowMessage_f4a2">TextBox_Something_ShowMessage_f4a2</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessageWithSound" href="#TextBox_ShowMessageWithSound" class="la">TextBox_ShowMessageWithSound:</a><span class="ce">; [$f4f3]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage">TextBox_ShowMessage</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Play the message sound effect.
;
</div><span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; 0x01 == Message sound effect.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_ShowNextChar">PasswordScreen_ShowNextChar</a>
;     <a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage" href="#TextBox_ShowMessage" class="la">TextBox_ShowMessage:</a><span class="ce">; [$f4ff]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Space
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_Space" href="#TextBox_ShowMessage_Space" class="la">TextBox_ShowMessage_Space:</a><span class="ce">; [$f502]</span></span>
<div class="c">;
; If it's 0xFD, it's a space.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#TextBox_ShowMessage_Return">TextBox_ShowMessage_Return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Load the next character in the message string.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr">LoadedMessageAddr</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr.U">LoadedMessageAddr.U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Maybe_MessageLength">Maybe_MessageLength</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"></span>
<div class="c">;
; If it's 0xFF, the message ends.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_EndOfMessage">TextBox_ShowMessage_EndOfMessage</a></span></span></span>
<span class="l"></span>
<div class="c">;
; If it's 0xFC, finish this part of the message.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$fc</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Return">TextBox_ShowMessage_Return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Newline
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_Newline" href="#TextBox_ShowMessage_Newline" class="la">TextBox_ShowMessage_Newline:</a><span class="ce">; [$f523]</span></span>
<div class="c">;
; If it's 0xFE, it's a newline.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_IncLineAndReset
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Prepare4Lines">TextBox_ShowMessage_Prepare4Lines</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_IncLineAndReset" href="#TextBox_ShowMessage_IncLineAndReset" class="la">TextBox_ShowMessage_IncLineAndReset:</a><span class="ce">; [$f528]</span></span>
<div class="c">;
; Increment the line and reset the character position.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; Set as the character position.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; Y = line number</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<div class="c">;
; Check if we've reached the end of the textbox.
; If so, prepare the state for the next 4 lines.
;
</div><span class="l"><span><span class="i">CPY</span> <span class="o">#$04</span></span><span class="ce">; Is the line number 4?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"></span>
<div class="c">;
; We're not at the end of the textbox. Increment and return.
;
</div><span class="l"><span><span class="i">STY</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; Els, set as the number of drawn lines.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Prepare a 4-line textbox for writing.
;
; This will set the initial draw position and data for
; a textbox covering 4 lines. It will then fill it with
; placeholder data and then clear it.
;
; This ensures state is set up to write text, and that
; the buffer is prepared.
;
; INPUTS:
;     <a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a>:
;         The 1-based starting character position.
;
;         If 0, this will just return.
;
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;         The last drawn line number.
;
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;         The line scroll offset of the tex tbox.
;
;     <a href="RAM.html#TextBox_X">TextBox_X</a>:
;         The X position of the text box.
;
;     <a href="RAM.html#TextBox_Y">TextBox_Y</a>:
;         The Y position of the text box.
;
; OUTPUTS:
;     <a href="RAM.html#TextBox_TextX">TextBox_TextX</a>:
;         The X position to begin writing to.
;
;     <a href="RAM.html#TextBox_TextY">TextBox_TextY</a>:
;         The Y position to begin writing to.
;
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;         The scroll offset of the line.
;
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;         The drawn line number.
;
; CALLS:
;     <a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a>
;     <a href="#PPU_SetAddrForTextPos">PPU_SetAddrForTextPos</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;     <a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a>
;
; XREFS:
;     <a href="PRG12.html#Shops_Something_9949">Shops_Something_9949</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_Prepare4Lines" href="#TextBox_ShowMessage_Prepare4Lines" class="la">TextBox_ShowMessage_Prepare4Lines:</a><span class="ce">; [$f539]</span></span>
<div class="c">;
; Check if anything's ready to be written for this line.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; Load the character position (1-based; 0 for not ready).</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#TextBox_ShowMessage_IncLineAndReset">TextBox_ShowMessage_IncLineAndReset</a></span></span><span class="ce">; If &gt; 0, the line can be drawn.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Pause
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_Pause" href="#TextBox_ShowMessage_Pause" class="la">TextBox_ShowMessage_Pause:</a><span class="ce">; [$f53f]</span></span>
<div class="c">;
; If it's 0xFC, it's a pause in the message the player
; must acknowledge.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr">LoadedMessageAddr</a></span></span><span class="ce">; Load the lower byte of the message string address.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store it for length calculation.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#LoadedMessageAddr.U">LoadedMessageAddr.U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Maybe_MessageLength">Maybe_MessageLength</a></span></span><span class="ce">; Load the message length.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; Load the next byte of the message.</span></span>
<span class="l"></span>
<div class="c">;
; If it's 0xFF, the message ends.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (end of message)?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_EndOfMessage">TextBox_ShowMessage_EndOfMessage</a></span></span><span class="ce">; If true, then end message.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_MessageEnded">TextBox_MessageEnded</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#TextBox_ShowMessage_Space">TextBox_ShowMessage_Space</a>
;
</div><span class="l"><a name="TextBox_ShowMessage_Return" href="#TextBox_ShowMessage_Return" class="la">TextBox_ShowMessage_Return:</a><span class="ce">; [$f557]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; This is the end of the message.
;
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;     <a href="#TextBox_ShowMessage_Pause">TextBox_ShowMessage_Pause</a>
;     <a href="#TextBox_ShowMessage_Space">TextBox_ShowMessage_Space</a>
;
</div><span class="l"><a name="TextBox_ShowMessage_EndOfMessage" href="#TextBox_ShowMessage_EndOfMessage" class="la">TextBox_ShowMessage_EndOfMessage:</a><span class="ce">; [$f558]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; Store as the message ID (terminating message).</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_ShowPlayerTitle
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_ShowPlayerTitle" href="#TextBox_ShowMessage_ShowPlayerTitle" class="la">TextBox_ShowMessage_ShowPlayerTitle:</a><span class="ce">; [$f55e]</span></span>
<div class="c">;
; If it's 0xFB, the title rank will be inserted.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$81</span></span><span class="ce">; A = 0x81</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span><span class="ce">; Load the player's title.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to an index in the Player Titles table.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f649,X</span></span><span class="ce">; Load the title string at X.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a></span></span><span class="ce">; Show this title in the textbox.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Fill4Lines
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_IncLineAndReset">TextBox_ShowMessage_IncLineAndReset</a>
;============================================================================
</div><span class="l"><a name="TextBox_ShowMessage_Fill4Lines" href="#TextBox_ShowMessage_Fill4Lines" class="la">TextBox_ShowMessage_Fill4Lines:</a><span class="ce">; [$f571]</span></span>
<div class="c">;
; Set the start position where text will be drawn.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_X">TextBox_X</a></span></span><span class="ce">; X = textbox tile X coordinate.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; X += 2</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TextBox_TextX">TextBox_TextX</a></span></span><span class="ce">; Store as the text X start position.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_Y">TextBox_Y</a></span></span><span class="ce">; Y = textbox tile Y coordinate.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; Y += 2</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span><span class="ce">; Store as the text Y start position.</span></span>
<span class="l"></span>
<div class="c">;
; Write 3 lines.
;
; This will be the available text characters, filling
; up the buffer. It will contain:
;
;     @ABCDEFGHIJKLMNO
;     PQRSTUVWXYZ[\]^_
;     `abcdefghijklmno
;     pqrstuvwxyz{}|~.
;
; This will effectively reserve space in the buffer.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextPos">PPU_SetAddrForTextPos</a></span></span><span class="ce">; Set the PPU address for the text position.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; X = scroll line offset</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a></span></span><span class="ce">; Write a line and advance.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a></span></span><span class="ce">; Write a line and advance.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a></span></span><span class="ce">; Write a line and advance.</span></span>
<span class="l"></span>
<div class="c">;
; Clear the final line.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (start offset)</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16 (line length)</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a></span></span><span class="ce">; Write '0' 16 times, clearing the line.</span></span>
<span class="l"></span>
<div class="c">;
; Set the starting text position to the beginning text char/pos
; of the text box we just wrote to.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store A as the lower byte of the PPU target address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; A = scroll-aware line offset.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$14</span></span><span class="ce">; A += 20</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Store as the upper byte of the PPU target addres.</span></span>
<span class="l"></span>
<div class="c">;
; Clear out each of the lines that were just written.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$10</span></span><span class="ce">; X = 16</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f5a5" href="#@LAB_PRG15_MIRROR__f5a5" class="lla">@LAB_PRG15_MIRROR__f5a5:</a><span class="ce">; [$f5a5]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a></span></span><span class="ce">; Write '0' 16 times, clearing the line.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a></span></span><span class="ce">; Increment the offset by 16.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A from the 
stack (now 16).</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f5a5">@LAB_PRG15_MIRROR__f5a5</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; Increase the Y position to draw to by 3, after these lines.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span><span class="ce">; <a href="RAM.html#TextBox_TextY">TextBox_TextY</a> += 3</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Draw a line of text to fill the address.
;
; This will be:
;
;     PQRSTUVWXYZ[\]^_
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextPos">PPU_SetAddrForTextPos</a></span></span><span class="ce">; Set the text draw position back.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; A = line scroll offset.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLine">TextBox_FillPlaceholderTextForLine</a></span></span><span class="ce">; Write a line of text.</span></span>
<span class="l"></span>
<div class="c">;
; Store the new line number offset.
;
</div><span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Cap the line number from 0..4.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a line of arbitrary text, taking into account textbox scrolling.
;
; The text will be placeholder text, intended to be
; cleared later.
;
; This is used when a maximum of 4 lines will be shown.
; The provided line number will be capped to a value
; between 0 and 4 and written to the textbox draw address.
;
; INPUTS:
;     X:
;         The line number to write to.
;
;         This will be capped to a displayed line number.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The new upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a name="TextBox_FillPlaceholderTextForLineCapped" href="#TextBox_FillPlaceholderTextForLineCapped" class="la">TextBox_FillPlaceholderTextForLineCapped:</a><span class="ce">; [$f5cd]</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; lineNum++</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"></span>
<div class="c">;
; Cap the linenum to lines 0-4.
;
</div><span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a line of arbitrary text.
;
; The text will be placeholder text, intended to be
; cleared later.
;
; INPUTS:
;     A:
;         The line number to write to.
;
;         This will be a 0-based index into the textbox.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The new upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a name="TextBox_FillPlaceholderTextForLine" href="#TextBox_FillPlaceholderTextForLine" class="la">TextBox_FillPlaceholderTextForLine:</a><span class="ce">; [$f5d1]</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<div class="c">;
; Calculate a character offset for the line number.
; Lines are 16 characters per line.
;
</div><span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 16.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"></span>
<div class="c">;
; Add 64, giving us a value of "A".
;
</div><span class="l"><span><span class="i">ADC</span> <span class="o">#$40</span></span><span class="ce">; Add 64 (character code of "A").</span></span>
<span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a line of arbitrary text, starting with a character.
;
; The text will be placeholder text, intended to be
; cleared later.
;
; INPUTS:
;     A:
;         The line number to write to.
;
;         This will be a 0-based index into the textbox.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The new upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_Something_9910">IScripts_Something_9910</a>
;============================================================================
</div><span class="l"><a name="TextBox_FillPlaceholderTextAtLineWithStartChar" href="#TextBox_FillPlaceholderTextAtLineWithStartChar" class="la">TextBox_FillPlaceholderTextAtLineWithStartChar:</a><span class="ce">; [$f5d9]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X (offset)</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<div class="c">;
; Set the write length to 16 characters (max for a line).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue this as the write length.</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"></span>
<div class="c">;
; Begin the write loop.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$f5e3]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span><span class="ce">; Write the value to the buffer.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$01</span></span><span class="ce">; A++ (next character value)</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If Y &gt; 0, loop.</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Store the new offset as the PPU upper bounds.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A from the stack.</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a></span></span><span class="ce">; Increment the PPU address by 32.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write an ASCII value to the textbox at the next position.
;
; INPUTS:
;     A:
;         The ASCII value to write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a>:
;         The new upper bounds of the PPU buffer.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The PPU target address to write to.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     #$ed:
;         Clobbered.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;     <a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage">TextBox_ShowMessage</a>
;============================================================================
</div><span class="l"><a name="TextBox_Maybe_WriteLineOfChars" href="#TextBox_Maybe_WriteLineOfChars" class="la">TextBox_Maybe_WriteLineOfChars:</a><span class="ce">; [$f5f3]</span></span>
<div class="c">;
; Normalize the ASCII value into an index in the characters
; table.
;
</div><span class="l"><span><span class="i">SEC</span></span><span class="ce">; C = 1</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$20</span></span><span class="ce">; A -= 32 (normalize the value to a character lookup table)</span></span>
<span class="l"></span>
<div class="c">;
; Set the address of the string address.
;
; Each glyph is 8 bytes, so this will normalize the character
; index to the proper byte offset.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Set middle byte of string address to 0.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A = A * 8 (each glyph is 8 bytes)</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Rotate upper byte left and add carry.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Make the address relative to $8000.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Load the upper byte of of the address.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"></span>
<div class="c">;
; Compute the PPU target address.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Store as the starting upper byte of the PPU target address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; A = character position.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a 16 byte address boundary.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store as the lower byte of the PPU target address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; A = drawn line number.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; A += line scroll offset</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Cap to a 0..4 line number.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$14</span></span><span class="ce">; A += 20</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Set as the new upper byte of the PPU target address.</span></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and switch to bank 13 (strings).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; A = current bank</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0d</span></span><span class="ce">; A = bank 13</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Switch to it.</span></span>
<span class="l"></span>
<div class="c">;
; Queue up the drawn line.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16 (line length)</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue as the line length.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a></span></span><span class="ce">; Write the first half of the line.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a></span></span><span class="ce">; Write the second half.</span></span>
<span class="l"></span>
<div class="c">;
; Finish up and restore the bank.
;
</div><span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Store the new upper bounds for the PPU buffer.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore to the previous bank.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write values from temp to the PPU buffer.
;
; This will write all values from <a href="RAM.html#Temp_Int24">Temp_Int24</a>
; until a value 128-255 are hit.
;
; INPUTS:
;     X:
;         The destination index into the buffer to write to.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#PPUBuffer_WriteFromTemp">PPUBuffer_WriteFromTemp</a>
;
; XREFS:
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;============================================================================
</div><span class="l"><a name="TextBox_Write8BytesFromTemp" href="#TextBox_Write8BytesFromTemp" class="la">TextBox_Write8BytesFromTemp:</a><span class="ce">; [$f63e]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$f640]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteFromTemp">PPUBuffer_WriteFromTemp</a></span></span><span class="ce">; Write a value from temp.</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Consider values 0-127.</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#TextBox_ShowMessage_ShowPlayerTitle">TextBox_ShowMessage_ShowPlayerTitle</a>
;     <a href="#TextBox_Something_ShowMessage_f4a2">TextBox_Something_ShowMessage_f4a2</a>
;
</div><span class="l"><a name="PLAYER_TITLE_STRINGS" href="#PLAYER_TITLE_STRINGS" class="la">PLAYER_TITLE_STRINGS:</a><span class="ce">; [$f649]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Novice          "</span></span><span class="ce">; [$f649] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Aspirant        "</span></span><span class="ce">; [$f659] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Battler         "</span></span><span class="ce">; [$f669] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Fighter         "</span></span><span class="ce">; [$f679] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Adept           "</span></span><span class="ce">; [$f689] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Chevalier       "</span></span><span class="ce">; [$f699] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Veteran         "</span></span><span class="ce">; [$f6a9] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Warrior         "</span></span><span class="ce">; [$f6b9] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Swordman        "</span></span><span class="ce">; [$f6c9] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Hero            "</span></span><span class="ce">; [$f6d9] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Soldier         "</span></span><span class="ce">; [$f6e9] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Myrmidon        "</span></span><span class="ce">; [$f6f9] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Champion        "</span></span><span class="ce">; [$f709] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Superhero       "</span></span><span class="ce">; [$f719] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Paladin         "</span></span><span class="ce">; [$f729] char</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">"Lord            "</span></span><span class="ce">; [$f739] char</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Experience requirements for each title.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;     <a href="#Player_CheckReachedNextTitle">Player_CheckReachedNextTitle</a>
;
</div><span class="l"><a name="PLAYER_TITLE_EXP_NEEDED" href="#PLAYER_TITLE_EXP_NEEDED" class="la">PLAYER_TITLE_EXP_NEEDED:</a><span class="ce">; [$f749]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$03e8</span></span><span class="ce">; [0]: Aspirant (1,000 exp)</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;
</div><span class="l"><a name="PLAYER_TITLE_EXP_NEEDED_1_" href="#PLAYER_TITLE_EXP_NEEDED_1_" class="la">PLAYER_TITLE_EXP_NEEDED_1_:</a><span class="ce">; [$f74b]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0898</span></span><span class="ce">; [1]: Battler (2,200 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0dac</span></span><span class="ce">; [2]: Fighter (3,500 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$12c0</span></span><span class="ce">; [3]: Adept (4,800 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$1838</span></span><span class="ce">; [4]: Chevalier (6,200 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$1f40</span></span><span class="ce">; [5]: Veteran (8,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$2710</span></span><span class="ce">; [6]: Warrior (10,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$30d4</span></span><span class="ce">; [7]: Swordman (12,500 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$3a98</span></span><span class="ce">; [8]: Hero (15,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$4650</span></span><span class="ce">; [9]: Soldier (18,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$55f0</span></span><span class="ce">; [10]: Myrmidon (22,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$6590</span></span><span class="ce">; [11]: Champion (26,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$7530</span></span><span class="ce">; [12]: Superhero (30,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$88b8</span></span><span class="ce">; [13]: Paladin (35,000 exp)</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$afc8</span></span><span class="ce">; [14]: Lord (45,000 exp)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Starting gold at each player title.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;
</div><span class="l"><a name="PLAYER_TITLE_GOLD" href="#PLAYER_TITLE_GOLD" class="la">PLAYER_TITLE_GOLD:</a><span class="ce">; [$f767]</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$01f4</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0320</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$04b0</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0640</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0834</span></span><span class="ce">; [4]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0af0</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$0dac</span></span><span class="ce">; [6]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$10cc</span></span><span class="ce">; [7]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$1450</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$1838</span></span><span class="ce">; [9]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$1d4c</span></span><span class="ce">; [10]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$2328</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$2904</span></span><span class="ce">; [12]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$32c8</span></span><span class="ce">; [13]:</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o">$3a98</span></span><span class="ce">; [14]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return the inventory for the given item.
;
; This takes an item with inventory bits and returns the
; inventory it resides in as a number between 1-5.
;
; INPUTS:
;     A:
;         The inventory item with inventory bits set.
;
; OUTPUTS:
;     A:
;         The index of the inventory:
;
;         0 = Weapons
;         1 = Armor
;         2 = Shields
;         3 = Magic
;         4 = Special
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_OpenShop">IScriptAction_OpenShop</a>
;     <a href="PRG12.html#Maybe_DrawItemTitle">Maybe_DrawItemTitle</a>
;     <a href="PRG12.html#Player_AddToInventory">Player_AddToInventory</a>
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;     <a href="PRG12.html#Player_LacksItem">Player_LacksItem</a>
;     <a href="PRG12.html#Player_RemoveItem">Player_RemoveItem</a>
;     <a href="PRG12.html#Something_ShopCursorInventory">Something_ShopCursorInventory</a>
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;============================================================================
</div><span class="l"><a name="GetInventoryIndexForItem" href="#GetInventoryIndexForItem" class="la">GetInventoryIndexForItem:</a><span class="ce">; [$f785]</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift right 5, turning inventory bits into an index.</span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Convert an inventory index to a bit for an item.
;
; This takes an inventory index and shifts it left 5,
; which turns it into an inventory bitmask that can be
; OR'd with an item ID.
;
; INPUTS:
;     A:
;         The inventory index.
;
;         0 = Weapons
;         1 = Armor
;         2 = Shields
;         3 = Magic
;         4 = Special
;
; OUTPUTS:
;     A:
;         The inventory bitmask.
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__8bce">FUN_PRG12__8bce</a>
;     <a href="PRG12.html#FUN_PRG12__8c04">FUN_PRG12__8c04</a>
;     <a href="PRG12.html#IScriptAction_ShowSellMenu">IScriptAction_ShowSellMenu</a>
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;============================================================================
</div><span class="l"><a name="BitShiftLeft5" href="#BitShiftLeft5" class="la">BitShiftLeft5:</a><span class="ce">; [$f78b]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left 5 (here and the next 4 after falling through).</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Math_MultiplyBy8
;
; INPUTS:
;     A
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__9075">FUN_PRG12__9075</a>
;     <a href="PRG12.html#Maybe_DrawItemTitle">Maybe_DrawItemTitle</a>
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;     <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>
;     <a href="#TextBox_Maybe_GetPaletteBehindTextbox">TextBox_Maybe_GetPaletteBehindTextbox</a>
;============================================================================
</div><span class="l"><a name="Math_MultiplyBy8" href="#Math_MultiplyBy8" class="la">Math_MultiplyBy8:</a><span class="ce">; [$f78c]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left 4.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_Maybe_GetPaletteBehindTextbox
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG12.html#TextBox_Maybe_GetPalette">TextBox_Maybe_GetPalette</a>
;============================================================================
</div><span class="l"><a name="TextBox_Maybe_GetPaletteBehindTextbox" href="#TextBox_Maybe_GetPaletteBehindTextbox" class="la">TextBox_Maybe_GetPaletteBehindTextbox:</a><span class="ce">; [$f791]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Math_MultiplyBy8">Math_MultiplyBy8</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#TextBox_TextX">TextBox_TextX</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#SUB_PRG15_MIRROR__f7f6">SUB_PRG15_MIRROR__f7f6</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__f7b7
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG12.html#Maybe_Draw_Textbox">Maybe_Draw_Textbox</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__f7b7" href="#FUN_PRG15_MIRROR__f7b7" class="la">FUN_PRG15_MIRROR__f7b7:</a><span class="ce">; [$f7b7]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_TextX">TextBox_TextX</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_TextX">TextBox_TextX</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$81,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#TextBox_Maybe_GetPaletteBehindTextbox">TextBox_Maybe_GetPaletteBehindTextbox</a>
;
</div><span class="l"><a name="SUB_PRG15_MIRROR__f7f6" href="#SUB_PRG15_MIRROR__f7f6" class="la">SUB_PRG15_MIRROR__f7f6:</a><span class="ce">; [$f7f6]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the PPU address for drawing text.
;
; INPUTS:
;     <a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a>:
;         The screen being drawn into.
;
;     <a href="RAM.html#TextBox_TextX">TextBox_TextX</a>:
;         The X position to draw text into.
;
;     <a href="RAM.html#TextBox_TextY">TextBox_TextY</a>:
;         The Y position to draw text into.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The target address to draw to.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddItem_Something8EC1">IScriptAction_AddItem_Something8EC1</a>
;     <a href="PRG12.html#IScripts_Something_9910">IScripts_Something_9910</a>
;     <a href="PRG12.html#Maybe_DrawItemName">Maybe_DrawItemName</a>
;     <a href="PRG12.html#Maybe_DrawItemTitle">Maybe_DrawItemTitle</a>
;     <a href="PRG12.html#Maybe_Draw_Textbox">Maybe_Draw_Textbox</a>
;     <a href="PRG12.html#Shop_DrawItemStrings">Shop_DrawItemStrings</a>
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;     <a href="PRG12.html#TextBox_Maybe_Draw">TextBox_Maybe_Draw</a>
;     <a href="PRG12.html#UI_ShowPlayerMenu">UI_ShowPlayerMenu</a>
;     <a href="#Maybe_Shop_DrawPrices">Maybe_Shop_DrawPrices</a>
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;     <a href="#UI_DrawDigitsNoLeadingZeroes">UI_DrawDigitsNoLeadingZeroes</a>
;============================================================================
</div><span class="l"><a name="PPU_SetAddrForTextPos" href="#PPU_SetAddrForTextPos" class="la">PPU_SetAddrForTextPos:</a><span class="ce">; [$f804]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScrollHelp_Screen">ScrollHelp_Screen</a></span></span><span class="ce">; A = Scroll screen used for drawing.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Convert to 0/1 (even/odd).</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; A += 8</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Store as the PPU target address.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_TextY">TextBox_TextY</a></span></span><span class="ce">; Load the text Y position.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A = A * 16</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Rotate the upper byte of the target address left.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A &lt;&lt; 1</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Rotate the upper byte of the target address left.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#TextBox_TextX">TextBox_TextX</a></span></span><span class="ce">; OR it with the X position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store as the lower byte of the target address.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Increment the PPU target address by 16.
;
; INPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The updated PPU target address.
;
; XREFS:
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a name="PPU_IncrementAddrBy16" href="#PPU_IncrementAddrBy16" class="la">PPU_IncrementAddrBy16:</a><span class="ce">; [$f81e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a></span></span><span class="ce">; Unconditionally jump to <a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a>.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Increment the PPU target address by 8.
;
; INPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The updated PPU target address.
;
; XREFS:
;     <a href="PRG12.html#Maybe_Draw_Textbox_Something8F51">Maybe_Draw_Textbox_Something8F51</a>
;============================================================================
</div><span class="l"><a name="PPU_IncrementAddrBy8" href="#PPU_IncrementAddrBy8" class="la">PPU_IncrementAddrBy8:</a><span class="ce">; [$f822]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; A = 8</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a></span></span><span class="ce">; Unconditionally jump to <a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a>.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Increment the PPU target address by 32.
;
; INPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The updated PPU target address.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddItem_Something8EC1">IScriptAction_AddItem_Something8EC1</a>
;     <a href="PRG12.html#Maybe_DrawItemName">Maybe_DrawItemName</a>
;     <a href="PRG12.html#Maybe_Draw_Textbox">Maybe_Draw_Textbox</a>
;     <a href="PRG12.html#TextBox_Maybe_Draw">TextBox_Maybe_Draw</a>
;     <a href="#TextBox_ClearShopSizeAtOffset">TextBox_ClearShopSizeAtOffset</a>
;     <a href="#TextBox_FillPlaceholderTextAtLineWithStartChar">TextBox_FillPlaceholderTextAtLineWithStartChar</a>
;============================================================================
</div><span class="l"><a name="PPU_IncrementAddrBy32" href="#PPU_IncrementAddrBy32" class="la">PPU_IncrementAddrBy32:</a><span class="ce">; [$f826]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span><span class="ce">; Set the offset to 32.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Increment the PPU target address by a specified amount.
;
; INPUTS:
;     A:
;         The amount to increment by.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         The updated PPU target address.
;
; XREFS:
;     <a href="PRG12.html#Shop_DrawItemStrings">Shop_DrawItemStrings</a>
;     <a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a>
;     <a href="#PPU_IncrementAddrBy8">PPU_IncrementAddrBy8</a>
;============================================================================
</div><span class="l"><a name="PPU_IncrementAddrBy" href="#PPU_IncrementAddrBy" class="la">PPU_IncrementAddrBy:</a><span class="ce">; [$f828]</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; A += PPU_TargetAddr</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_storeAndReturn">@_storeAndReturn</a></span></span><span class="ce">; If it overflowed, jump. No need to increment the upper byte.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Else, increment the upper byte by 1.</span></span>
<span class="l"></span>
<span class="l"><a name="@_storeAndReturn" href="#@_storeAndReturn" class="lla">@_storeAndReturn:</a><span class="ce">; [$f82f]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set the new target address.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_QueueRightCoordInPPUBuffer
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#TextBox_Maybe_Draw">TextBox_Maybe_Draw</a>
;============================================================================
</div><span class="l"><a name="TextBox_QueueRightCoordInPPUBuffer" href="#TextBox_QueueRightCoordInPPUBuffer" class="la">TextBox_QueueRightCoordInPPUBuffer:</a><span class="ce">; [$f832]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_Width">TextBox_Width</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document TextBox_SomethingPPUBuffer_Set
;
; INPUTS:
;     A
;     X
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddItem_Something8EC1">IScriptAction_AddItem_Something8EC1</a>
;     <a href="PRG12.html#TextBox_Maybe_Draw">TextBox_Maybe_Draw</a>
;     <a href="#TextBox_SomethingPPUBuffer_Set">TextBox_SomethingPPUBuffer_Set</a>
;============================================================================
</div><span class="l"><a name="TextBox_SomethingPPUBuffer_Set" href="#TextBox_SomethingPPUBuffer_Set" class="la">TextBox_SomethingPPUBuffer_Set:</a><span class="ce">; [$f839]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">DEY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$02</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#TextBox_SomethingPPUBuffer_Set">TextBox_SomethingPPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a value from a temp location to the PPU buffer.
;
; This will load a byte from <a href="RAM.html#Temp_Int24">Temp_Int24</a> and write
; it to the PPU buffer. The source offset will be
; advanced by 1.
;
; INPUTS:
;     X:
;         The destination index within the PPU buffer.
;
;     Y:
;         The offset from the address to load from.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The location of the address to load from.
;
; OUTPUTS:
;     X:
;         The new offset to write to (X + 1).
;
; XREFS:
;     <a href="PRG12.html#PasswrodScreen_DrawMessage">PasswrodScreen_DrawMessage</a>
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;     <a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_WriteFromTemp" href="#PPUBuffer_WriteFromTemp" class="la">PPUBuffer_WriteFromTemp:</a><span class="ce">; [$f842]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; Load the value from <a href="RAM.html#Temp_Int24">Temp_Int24</a> at offset Y.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a value to the PPU buffer.
;
; This will write the value and then increment the offset.
;
; INPUTS:
;     A:
;         The value to write.
;
;     X:
;         The offset at which to write the buffer.
;
; OUTPUTS:
;     X:
;         The new offset to write to (X + 1).
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__9041">FUN_PRG12__9041</a>
;     <a href="PRG12.html#FUN_PRG12__92ed">FUN_PRG12__92ed</a>
;     <a href="PRG12.html#Maybe_DrawItemName">Maybe_DrawItemName</a>
;     <a href="PRG12.html#Maybe_Draw_Textbox">Maybe_Draw_Textbox</a>
;     <a href="PRG12.html#Maybe_Draw_Textbox_Something8F51">Maybe_Draw_Textbox_Something8F51</a>
;     <a href="PRG12.html#Strings_Draw">Strings_Draw</a>
;     <a href="PRG12.html#TextBox_Maybe_Draw">TextBox_Maybe_Draw</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;     <a href="#TextBox_FillPlaceholderTextAtLineWithStartChar">TextBox_FillPlaceholderTextAtLineWithStartChar</a>
;     <a href="#TextBox_SomethingPPUBuffer_Set">TextBox_SomethingPPUBuffer_Set</a>
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_Set" href="#PPUBuffer_Set" class="la">PPUBuffer_Set:</a><span class="ce">; [$f845]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store A in the PPU buffer at X.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Write a value many types to the PPU buffer.
;
; This will write the provided value the specified number
; of times, starting at a given offset.
;
; The first byte written will be the length, and the
; remaining bytes will be the provided value repeated.
;
; INPUTS:
;     A:
;         The value to write.
;
;     X:
;         The starting offset in the buffer to write to.
;
;     Y:
;         The number of times to write the value.
;
; OUTPUTS:
;     X:
;         The new offset in the buffer after these values.
;
; XREFS:
;     <a href="#TextBox_ClearShopSizeAtOffset">TextBox_ClearShopSizeAtOffset</a>
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a name="PPUBuffer_WriteValueMany" href="#PPUBuffer_WriteValueMany" class="la">PPUBuffer_WriteValueMany:</a><span class="ce">; [$f84a]</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to the stack</span></span>
<span class="l"><span><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Write the length to the buffer.</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A from the stack</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$f850]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span><span class="ce">; Set the value in the PPU buffer.</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If Y &gt; 0, loop</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span><span class="ce">; Set the upper bounds to write.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Performs a "Far JSR" to a code in another PRG bank.
;
; This takes in a bank in a the address within the bank (as
; an upper byte and a lower byte) from the next three bytes
; following this call. Specifically, it:
;
; 1. Steals the JSR return address off the stack to locate
;    the inline data.
;
; 2. Rewrites the return address so RTS will skip past the
;    3 data bytes.
;
; 3. Reads the inline bytes via (<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y to
;    get the bank/target.
;
; 4. Switches to the bank.
;
; 5. Pushes a trampoline address ($C5F8) and the target
;    address so that RTS returns into the trampoline, which
;    then JSRs to the target and later restores the original
;    bank before returning to the caller.
;
; This is notably used for invoking IScripts.
;
; INPUTS:
;     A:
;         The bank, upper address byte, and lower address
;         byte in stack order.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG14.html#Player_CheckHandlePressUpOnNPC">Player_CheckHandlePressUpOnNPC</a>
;     <a href="PRG14.html#Player_HandleTouchNPC">Player_HandleTouchNPC</a>
;     <a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a>
;     <a href="#Game_DecGloveDuration">Game_DecGloveDuration</a>
;     <a href="#Game_DecHourGlassDuration">Game_DecHourGlassDuration</a>
;     <a href="#Game_DecOintmentDuration">Game_DecOintmentDuration</a>
;     <a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a>
;     <a href="#Game_OpenDoorWithAKey">Game_OpenDoorWithAKey</a>
;     <a href="#Game_OpenDoorWithDemonsRing">Game_OpenDoorWithDemonsRing</a>
;     <a href="#Game_OpenDoorWithJKey">Game_OpenDoorWithJKey</a>
;     <a href="#Game_OpenDoorWithJoKey">Game_OpenDoorWithJoKey</a>
;     <a href="#Game_OpenDoorWithKKey">Game_OpenDoorWithKKey</a>
;     <a href="#Game_OpenDoorWithQKey">Game_OpenDoorWithQKey</a>
;     <a href="#Game_OpenDoorWithRingOfDworf">Game_OpenDoorWithRingOfDworf</a>
;     <a href="#Game_OpenDoorWithRingOfElf">Game_OpenDoorWithRingOfElf</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#IScripts_ClearPortrait">IScripts_ClearPortrait</a>
;     <a href="#Maybe_Player_PickUpGlove">Maybe_Player_PickUpGlove</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_PickUpBattleHelmet">Player_PickUpBattleHelmet</a>
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a>
;     <a href="#Player_PickUpBlackOnyx">Player_PickUpBlackOnyx</a>
;     <a href="#Player_PickUpDragonSlayer">Player_PickUpDragonSlayer</a>
;     <a href="#Player_PickUpElixir">Player_PickUpElixir</a>
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMagicalRod">Player_PickUpMagicalRod</a>
;     <a href="#Player_PickUpMattock">Player_PickUpMattock</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;     <a href="#Player_PickUpPendant">Player_PickUpPendant</a>
;     <a href="#Player_PickUpPoison">Player_PickUpPoison</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;     <a href="#Player_UseElixir">Player_UseElixir</a>
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;============================================================================
</div><span class="l"><a name="MMC1_LoadBankAndJump" href="#MMC1_LoadBankAndJump" class="la">MMC1_LoadBankAndJump:</a><span class="ce">; [$f859]</span></span>
<div class="c">;
; Save out the X, Y, and Z values to temporary variables.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a></span></span><span class="ce">; Set <a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a> = A</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a></span></span><span class="ce">; Set <a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a> = X</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a></span></span><span class="ce">; Set <a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a> = Y</span></span>
<span class="l"></span>
<div class="c">;
; Pop two bytes of A from the stack and transfer to the lower
; and middle bytes (in order) of <a href="RAM.html#Temp_Int24">Temp_Int24</a>.
;
</div><span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pop A from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Lower byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"><span><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Middle byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"></span>
<div class="c">;
; Save A to X. We'll increment this below if we overflow
; the add.
;
</div><span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<div class="c">;
; Compute a new return low = <a href="RAM.html#Temp_Int24">Temp_Int24</a>.L + 3.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; A = lower byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a>.</span></span>
<span class="l"><span><span class="i">CLC</span></span><span class="ce">; C = 0</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$03</span></span><span class="ce">; A = A + 3</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; Upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"></span>
<div class="c">;
; If the upper byte overflowed, increment X.
;
</div><span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_storeCurrentAddress">@_storeCurrentAddress</a></span></span><span class="ce">; If carry is cleared, jump.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"></span>
<div class="c">;
; Preserve the target address and ROM bank on the stack.
;
</div><span class="l"><a name="@_storeCurrentAddress" href="#@_storeCurrentAddress" class="lla">@_storeCurrentAddress:</a><span class="ce">; [$f870]</span></span>
<span class="l"><span><span class="i">TXA</span></span><span class="ce">; A = X (our adjusted offset)</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; A = upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span><span class="ce">; A = <a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"></span>
<div class="c">;
; Store the loaded address and bank to jump to.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$03</span></span><span class="ce">; Y = 3</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Upper byte of the address to jump to.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span><span class="ce">; <a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a> = A</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y-- (2)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Lower byte of the address to jump to.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; Upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y-- (1)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Bank to load</span></span>
<span class="l"><span><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span><span class="ce">; Update the ROM bank to X.</span></span>
<span class="l"></span>
<div class="c">;
; Push the trampoline address $C5F8.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$f8</span></span><span class="ce">; A = 0xF8</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c5</span></span><span class="ce">; A = 0xC5</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"></span>
<div class="c">;
; Push the target address for the trampoline.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span><span class="ce">; A = <a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; A = upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a>.</span></span>
<span class="l"><span><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"></span>
<div class="c">;
; Restore the original values for A, X, and Y.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a></span></span><span class="ce">; A = <a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a></span></span><span class="ce">; X = <a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a></span></span><span class="ce">; Y = <a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document PPU_WriteTilesFromCHRRAM
;
; INPUTS:
;     X
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#SplashAnimation_DrawScenery">SplashAnimation_DrawScenery</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;============================================================================
</div><span class="l"><a name="PPU_WriteTilesFromCHRRAM" href="#PPU_WriteTilesFromCHRRAM" class="la">PPU_WriteTilesFromCHRRAM:</a><span class="ce">; [$f89e]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f8b3" href="#@LAB_PRG15_MIRROR__f8b3" class="lla">@LAB_PRG15_MIRROR__f8b3:</a><span class="ce">; [$f8b3]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$10</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f8b5" href="#@LAB_PRG15_MIRROR__f8b5" class="lla">@LAB_PRG15_MIRROR__f8b5:</a><span class="ce">; [$f8b5]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#IScriptOrCHRAddr">IScriptOrCHRAddr</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f8bf">@LAB_PRG15_MIRROR__f8bf</a></span></span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#IScriptOrCHRAddr.U">IScriptOrCHRAddr.U</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f8bf" href="#@LAB_PRG15_MIRROR__f8bf" class="lla">@LAB_PRG15_MIRROR__f8bf:</a><span class="ce">; [$f8bf]</span></span>
<span class="l"><span><span class="i">DEX</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f8b5">@LAB_PRG15_MIRROR__f8b5</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f8b3">@LAB_PRG15_MIRROR__f8b3</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; PPU address locations where statuc symbols are positioned.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;
</div><span class="l"><a name="UI_STATUS_SYMBOL_PPU_ADDR_L" href="#UI_STATUS_SYMBOL_PPU_ADDR_L" class="la">UI_STATUS_SYMBOL_PPU_ADDR_L:</a><span class="ce">; [$f8cb]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$41</span></span><span class="ce">; [0]: 0x2041 -- "M" (Magic)</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;
</div><span class="l"><a name="UI_STATUS_SYMBOL_PPU_ADDR_L_1_" href="#UI_STATUS_SYMBOL_PPU_ADDR_L_1_" class="la">UI_STATUS_SYMBOL_PPU_ADDR_L_1_:</a><span class="ce">; [$f8cc]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$61</span></span><span class="ce">; [1]: 0x2061 -- "P" (Power)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$6e</span></span><span class="ce">; [2]: 0x206E -- "G" (Gold)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$4e</span></span><span class="ce">; [3]: 0x204E -- "E" (Experience)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$56</span></span><span class="ce">; [4]: 0x2056 -- "T" (Time)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$5b</span></span><span class="ce">; [5]: 0x205B -- Top-left of "[" (Selected item)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$7b</span></span><span class="ce">; [6]: 0x207B -- Bottom-left of "[" (Selected item)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Tile indexes to display in the status area.
;
; Each of these will be placed horizontally at a start
; location (by <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>).
;
; A 0x00 means to end the run.
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;
</div><span class="l"><a name="UI_STATUS_TILES" href="#UI_STATUS_TILES" class="la">UI_STATUS_TILES:</a><span class="ce">; [$f8d2]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1c</span></span><span class="ce">; [0]: "M" (Magic)</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;
</div><span class="l"><a name="UI_STATUS_TILES_1_" href="#UI_STATUS_TILES_1_" class="la">UI_STATUS_TILES_1_:</a><span class="ce">; [$f8d3]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [1]: ":"</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;
</div><span class="l"><a name="UI_STATUS_TILES_2_" href="#UI_STATUS_TILES_2_" class="la">UI_STATUS_TILES_2_:</a><span class="ce">; [$f8d4]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$1f</span></span><span class="ce">; [3]: "P" (Power)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [4]: ":"</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [5]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; [6]: "G" (Gold)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3a</span></span><span class="ce">; [7]: ":"</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [8]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [9]: "E" (Experience)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3a</span></span><span class="ce">; [10]: ":"</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$23</span></span><span class="ce">; [12]: "T" (Time)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3a</span></span><span class="ce">; [13]: ":"</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$2c</span></span><span class="ce">; [15]: Top of "[" (current item)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3c</span></span><span class="ce">; [16]: &lt;blank space&gt;</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3d</span></span><span class="ce">; [17]: &lt;blank space&gt;</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$2e</span></span><span class="ce">; [18]: Top of "]" (current item)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$2d</span></span><span class="ce">; [20]: Bottom of "[" (current item)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3e</span></span><span class="ce">; [21]: &lt;blank space&gt;</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$3f</span></span><span class="ce">; [22]: &lt;blank space&gt;</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$2f</span></span><span class="ce">; [23]: Bottom of "]" (current item)</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [24]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw the status symbols on the screen.
;
; This will draw the following:
;
;     "P" (Power)
;     "M" (Magic)
;     "E" (Experience)
;     "G" (Gold)
;     "T" (Time)
;     Parts of "[ ]" for item selection
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#Something_SetupNewScreen">Something_SetupNewScreen</a>
;============================================================================
</div><span class="l"><a name="UI_DrawStatusSymbols" href="#UI_DrawStatusSymbols" class="la">UI_DrawStatusSymbols:</a><span class="ce">; [$f8eb]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Something_ManaOrHPBar">Something_ManaOrHPBar</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Fill the entire status area with 0 (blank).
; This is 4 rows of tiles.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span><span class="ce">; Set the upper byte for the draw position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Set the lower byte for the draw position.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$80</span></span><span class="ce">; Set Y = 128 (number of tiles to draw)</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Set the value to draw (blank tile).</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span><span class="ce">; Clear all 128 tiles.</span></span>
<span class="l"></span>
<div class="c">;
; Prepare to draw the symbols.
;
; This will loop through all positions, and then all tiles
; for that position. These are done as two separate lookup
; tables:
;
; 1. <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>: The lower
; addresses
;    of the PPU draw positions for placing each set of tiles.
;
;    This is incremented by 1 every time we finish placing tiles
;    for that area.
;
; 2. <a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>: The tiles to draw at the
; current
;
;    Each run of tiles terminates with a 0x00. The next index would
;    then match the next position. This is incremented by 1 every
;    time we place a tile.
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; Set X = 0 (start index in <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Set Y = 0 (start index at <a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>.</span></span>
<span class="l"></span>
<div class="c">;
; Set the PPUADDR to $20XX, where XX comes from the
; <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a> lookup table.
;
; Each of these will be the location of a static symbol
; to show in the status area.
;
</div><span class="l"><a name="@_goToNextPosition" href="#@_goToNextPosition" class="lla">@_goToNextPosition:</a><span class="ce">; [$f905]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store the upper draw position byte as 0x20.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f8cb,X</span></span><span class="ce">; Load the lower byte from the lookup table based on the index.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store it as the lower byte.</span></span>
<span class="l"></span>
<div class="c">;
; Lay out tiles for UI elements starting at the current symbol
; address.
;
; This will write data from the <a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>
; table
; until it hits an end market (0x00).
;
; This is generally 2-4 tiles per address.
;
</div><span class="l"><a name="@_drawTiles" href="#@_drawTiles" class="lla">@_drawTiles:</a><span class="ce">; [$f910]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$f8d2,Y</span></span><span class="ce">; Load the tile to draw at the current tile index.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_advanceIndexes">@_advanceIndexes</a></span></span><span class="ce">; If this is 0x00, we've reached the end of the run. Advance indexes.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Else, write the tile.</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; tileIndex++</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_drawTiles">@_drawTiles</a></span></span><span class="ce">; Loop.</span></span>
<span class="l"></span>
<div class="c">;
; Advance to the next set of tiles and the next lower address
; (draw position) in the lookup tables.
;
</div><span class="l"><a name="@_advanceIndexes" href="#@_advanceIndexes" class="lla">@_advanceIndexes:</a><span class="ce">; [$f91b]</span></span>
<span class="l"><span><span class="i">INY</span></span><span class="ce">; tileIndex++</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; position++</span></span>
<span class="l"></span>
<div class="c">;
; Check if we've completed the lookup table.
;
; There's only 7 addresses/positions to work with.
;
</div><span class="l"><span><span class="i">CPX</span> <span class="o">#$07</span></span><span class="ce">; Have we reached the end (draw position 7)?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_goToNextPosition">@_goToNextPosition</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"></span>
<div class="c">;
; We've finished drawing the status UI.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__fbaf">FUN_PRG15_MIRROR__fbaf</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#IScriptOrCHRAddr">IScriptOrCHRAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$81</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#IScriptOrCHRAddr.U">IScriptOrCHRAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$3c</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_WriteTilesFromCHRRAM">PPU_WriteTilesFromCHRRAM</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Check if the player reached the next title.
;
; If the player's experience passed the necessary threshold,
; the title will be increased by 1. It will never go up more
; than 1.
;
; INPUTS:
;     <a href="RAM.html#Experience_U">Experience_U</a>:
;         The upper byte of the experience to check.
;
;     <a href="RAM.html#Experience">Experience</a>:
;         The lower byte of the experience to check.
;
;     <a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a>:
;         The current player title is checked.
;
; OUTPUTS:
;     <a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a>:
;         The player title is updated as needed.
;
; XREFS:
;     <a href="#Player_UpdateExperience">Player_UpdateExperience</a>
;============================================================================
</div><span class="l"><a name="Player_CheckReachedNextTitle" href="#Player_CheckReachedNextTitle" class="la">Player_CheckReachedNextTitle:</a><span class="ce">; [$f93c]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a></span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$0f</span></span><span class="ce">; Have we hit the max title? (There are 15)</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If yes, exit.</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to an index in the lookup table.</span></span>
<span class="l"></span>
<div class="c">;
; Load the 16-bit experience level for the title.
;
</div><span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Load the lower byte from the lookup table.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$f749,X</span></span><span class="ce">; Compare it.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Load the upper byte from the lookup table.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$f74a,X</span></span><span class="ce">; Compare it.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If we're under, exit.</span></span>
<span class="l"></span>
<div class="c">;
; The player has met the next title's requirements.
;
</div><span class="l"><span><span class="i">INC</span> <span class="o">a:<a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a></span></span><span class="ce">; We have enough. Increase the player's next title.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$f956]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Update experience for the player.
;
; This will update from upper and lower values in RAM.
;
; INPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of experience to add.
;
;     #$ed:
;         The upper byte of experience to add.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG14.html#Player_AddExperienceFromSprite">Player_AddExperienceFromSprite</a>
;     <a href="#Player_Add100XP">Player_Add100XP</a>
;============================================================================
</div><span class="l"><a name="Player_UpdateExperience" href="#Player_UpdateExperience" class="la">Player_UpdateExperience:</a><span class="ce">; [$f957]</span></span>
<div class="c">;
; Update the lower byte of experience.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Load the current lower byte of experience.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Set the new lower byte of experience.</span></span>
<span class="l"></span>
<div class="c">;
; Update the upper byte of experience.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Load the current upper byte of experience.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Set the new upper byte of experience.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f972">@LAB_PRG15_MIRROR__f972</a></span></span><span class="ce">; Can we add to the experience, or did we hit a max?</span></span>
<span class="l"></span>
<div class="c">;
; We hit the maximum amount of experience. Make sure
; this is capped.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Set lower byte of experience to max.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Set upper byte of experience to max.</span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__f972" href="#@LAB_PRG15_MIRROR__f972" class="lla">@LAB_PRG15_MIRROR__f972:</a><span class="ce">; [$f972]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Player_CheckReachedNextTitle">Player_CheckReachedNextTitle</a></span></span><span class="ce">; Check if the next title has been hit.</span></span>
<span class="l"></span>
<div class="c">;
; Fall through to the next function.
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Render the player experience.
;
; This will set the draw position to 0x2050 (the location of
; the first digit of the experience), store out the experience
; to render, and then trigger the render.
;
; INPUTS:
;     <a href="RAM.html#Experience_U">Experience_U</a>:
;         The upper byte of the experience.
;
;     <a href="RAM.html#Experience">Experience</a>:
;         The lower byte of the experience.
;
; OUTPUTS:
;     #$e9:
;         The upper byte of the location to render to.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         The lower byte of the location to render to.
;
;     #$ee:
;         TODO: Currently unknown.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;
; XREFS:
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a name="UI_DrawPlayerExperience" href="#UI_DrawPlayerExperience" class="la">UI_DrawPlayerExperience:</a><span class="ce">; [$f975]</span></span>
<div class="c">;
; Set the address of the first digit of the experience to write
; (0x2050).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Store 0x20 as the upper byte.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$50</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store 0x50 as the upper byte.</span></span>
<span class="l"></span>
<div class="c">;
; Store the new experience back out to <a href="RAM.html#Temp_Int24">Temp_Int24</a> and
; #$ed.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Load the lower byte of the experience.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Save to <a href="RAM.html#Temp_Int24">Temp_Int24</a>.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Load the upper byte of the experience.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Save to #$ed.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$05</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a></span></span><span class="ce">; Trigger the render.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw the number of seconds remaining for an item.
;
; This is used for items like the Wingboots and Glove.
;
; Only the lower byte of the 24-bit value is ever needed.
;
; INPUTS:
;     A:
;         The number of seconds to draw.
;
; OUTPUTS:
;     None
;
; SIDE EFFECTS:
;     #$ee:
;     #$ed:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     #$e9:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;
; XREFS:
;     <a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a name="UI_DrawTimeValue" href="#UI_DrawTimeValue" class="la">UI_DrawTimeValue:</a><span class="ce">; [$f990]</span></span>
<div class="c">;
; Set the number of seconds remaining as a 24-bit integer.
;
; Only the lower byte is used. The rest are 0'd out.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Set number of seconds as the lower byte.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Set middle byte = 0.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; Set upper byte = 0.</span></span>
<span class="l"></span>
<div class="c">;
; Set the draw position (first digit of time remaining).
; This is 0x2058.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Set high byte of position as 0x20.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$58</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set high byte of position as 0x58.</span></span>
<span class="l"></span>
<div class="c">;
; Draw the digits with zero-padding.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$02</span></span><span class="ce">; Set the number of digits to draw.</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a></span></span><span class="ce">; Draw the digits with zero-padding.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Subtract gold from the player.
;
; This takes in gold as the 24-bit #$ee:#$ed:<a href="RAM.html#Temp_Int24">Temp_Int24</a>
; and reduces those values from the player's gold.
;
; After subtracting, this will be drawn to the screen.
;
; INPUTS:
;     #$ee:
;         The upper byte of the 24-bit gold value to subtract.
;
;     #$ed:
;         The middle byte of the 24-bit gold value to
;         subtract.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit gold value to
;         subtract.
;
; OUTPUTS:
;     <a href="RAM.html#Gold_U">Gold_U</a>:
;         The new upper byte of the current gold value.
;
;     <a href="RAM.html#Gold_M">Gold_M</a>:
;         The new middle byte of the current gold value.
;
;     <a href="RAM.html#Gold">Gold</a>:
;         The new lower byte of the current gold value.
;
; CALLS:
;     <a href="#UI_DrawGoldValue">UI_DrawGoldValue</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_ProgressivelySubtractGold">IScripts_ProgressivelySubtractGold</a>
;============================================================================
</div><span class="l"><a name="Player_SubtractGold" href="#Player_SubtractGold" class="la">Player_SubtractGold:</a><span class="ce">; [$f9a5]</span></span>
<div class="c">;
; Subtract from the lower byte.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Load the lower byte of the current amount.</span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Subtract the provided value.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Store as the new lower byte.</span></span>
<span class="l"></span>
<div class="c">;
; Subtract from the middle byte.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Load the middle byte of the current amount.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Subtract the provided value and the carry.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Store as the new middle byte.</span></span>
<span class="l"></span>
<div class="c">;
; Subtract from the upper byte.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Load the upper byte of the current amount.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$00</span></span><span class="ce">; Subtract the carry.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"></span>
<div class="c">;
; Draw the new amount.
;
</div><span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawGoldValue">UI_DrawGoldValue</a></span></span><span class="ce">; Draw the new amount of gold.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Add gold to the player.
;
; This takes in gold as the 24-bit #$ee:#$ed:<a href="RAM.html#Temp_Int24">Temp_Int24</a>
; and adds those values from the player's gold.
;
; After adding, this will be drawn to the screen.
;
; INPUTS:
;     #$ee:
;         The upper byte of the 24-bit gold value to add.
;
;     #$ed:
;         The middle byte of the 24-bit gold value to add.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit gold value to add.
;
; OUTPUTS:
;     <a href="RAM.html#Gold_U">Gold_U</a>:
;         The new upper byte of the current gold value.
;
;     <a href="RAM.html#Gold_M">Gold_M</a>:
;         The new middle byte of the current gold value.
;
;     <a href="RAM.html#Gold">Gold</a>:
;         The new lower byte of the current gold value.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_ProgressivelyAddGold">IScripts_ProgressivelyAddGold</a>
;============================================================================
</div><span class="l"><a name="Player_AddGold" href="#Player_AddGold" class="la">Player_AddGold:</a><span class="ce">; [$f9c1]</span></span>
<div class="c">;
; Add to the lower byte.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Load the lower byte of the current amount.</span></span>
<span class="l"><span><span class="i">CLC</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Add the new amount.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Store as the new lower byte.</span></span>
<span class="l"></span>
<div class="c">;
; Add to the middle byte.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Load the middle byte of the current amount.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Add the new amount + carry.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Store as the new middle byte.</span></span>
<span class="l"></span>
<div class="c">;
; Add to the upper byte.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Load the upper byte of the current amount.</span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"></span>
<div class="c">;
; If there's no carry, draw the value. Otherwise, we've
; maxed out the gold, so set that explicitly and then draw.
;
</div><span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#UI_DrawGoldValue">UI_DrawGoldValue</a></span></span><span class="ce">; If no carry, draw the current amount.</span></span>
<span class="l"></span>
<div class="c">;
; Carry was set. We're maxed. Make it official.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Set lower to max.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Set middle to max.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Set upper to max.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Draw the current gold display in the status UI.
;
; The gold will be rendered at the start position of
; 0x2070 (first digit of the gold amount).
;
; This is rendered zero-padded.
;
; INPUTS:
;     <a href="RAM.html#Gold_U">Gold_U</a>:
;         Upper byte of the 24-bit gold value.
;
;     <a href="RAM.html#Gold_M">Gold_M</a>:
;         Middle byte of the 24-bit gold value.
;
;     <a href="RAM.html#Gold">Gold</a>:
;         Lower byte of the 24-bit gold value.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     #$ed:
;     #$ee:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     #$e9:
;         Clobbered.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>;;
;
; XREFS:
;     <a href="PRG14.html#Player_HandleTouchCoin">Player_HandleTouchCoin</a>
;     <a href="#Player_AddGold">Player_AddGold</a>
;     <a href="#Player_SubtractGold">Player_SubtractGold</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a name="UI_DrawGoldValue" href="#UI_DrawGoldValue" class="la">UI_DrawGoldValue:</a><span class="ce">; [$f9e7]</span></span>
<div class="c">;
; Set the draw position for the first digit of gold.
; This is 0x2070.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span><span class="ce">; Set the upper byte to 0x20.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$70</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set the lower byte to 0x70.</span></span>
<span class="l"></span>
<div class="c">;
; Load the gold into the 24-bit temporary integer used for
; drawing digits.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Load the lower byte of the gold value.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Set a the lower byte for the digits to draw.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Load the middle byte of the gold value.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Set a the middle byte for the digits to draw.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Load the upper byte of the gold value.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; Set a the upper byte for the digits to draw.</span></span>
<span class="l"></span>
<div class="c">;
; Draw the new amount as 7 digits, zero-padded.
;
</div><span class="l"><span><span class="i">LDY</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a></span></span><span class="ce">; Draw 7 digits of gold.</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Maybe_Shop_DrawPrices
;
; INPUTS:
;     X
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#Shop_Something__8d5a">Shop_Something__8d5a</a>
;============================================================================
</div><span class="l"><a name="Maybe_Shop_DrawPrices" href="#Maybe_Shop_DrawPrices" class="la">Maybe_Shop_DrawPrices:</a><span class="ce">; [$fa03]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextPos">PPU_SetAddrForTextPos</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document UI_DrawDigitsZeroPadded
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#UI_DrawGoldValue">UI_DrawGoldValue</a>
;     <a href="#UI_DrawPlayerExperience">UI_DrawPlayerExperience</a>
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;============================================================================
</div><span class="l"><a name="UI_DrawDigitsZeroPadded" href="#UI_DrawDigitsZeroPadded" class="la">UI_DrawDigitsZeroPadded:</a><span class="ce">; [$fa06]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_PopulateDigits">UI_PopulateDigits</a></span></span><span class="ce">; Populate the ASCII digits to render.</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawDigitsNoLeadingZeroes">UI_DrawDigitsNoLeadingZeroes</a>
;
</div><span class="l"><a name="UI_DrawDigitsZeroPadded_Populated" href="#UI_DrawDigitsZeroPadded_Populated" class="la">UI_DrawDigitsZeroPadded_Populated:</a><span class="ce">; [$fa0b]</span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">SEC</span></span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fa18" href="#@LAB_PRG15_MIRROR__fa18" class="lla">@LAB_PRG15_MIRROR__fa18:</a><span class="ce">; [$fa18]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,Y</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fa18">@LAB_PRG15_MIRROR__fa18</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document UI_DrawDigitsNoLeadingZeroes
;
; INPUTS:
;     X
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#Shop_Draw">Shop_Draw</a>
;============================================================================
</div><span class="l"><a name="UI_DrawDigitsNoLeadingZeroes" href="#UI_DrawDigitsNoLeadingZeroes" class="la">UI_DrawDigitsNoLeadingZeroes:</a><span class="ce">; [$fa26]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextPos">PPU_SetAddrForTextPos</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_PopulateDigitsNoLeadingZeroes">UI_PopulateDigitsNoLeadingZeroes</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded_Populated">UI_DrawDigitsZeroPadded_Populated</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Populate digits but with leading "0"s empty.
;
; This will populate the digits and then loop through them
; (up to 6 digits), NULing out all leading "0" digits so
; they don't display.
;
; INPUTS:
;     X:
;         The starting index into the digits.
;
; OUTPUTS:
;     <a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>:
;         The updated digits.
;
; CALLS:
;     <a href="#UI_PopulateDigits">UI_PopulateDigits</a>
;
; XREFS:
;     <a href="#UI_DrawDigitsNoLeadingZeroes">UI_DrawDigitsNoLeadingZeroes</a>
;============================================================================
</div><span class="l"><a name="UI_PopulateDigitsNoLeadingZeroes" href="#UI_PopulateDigitsNoLeadingZeroes" class="la">UI_PopulateDigitsNoLeadingZeroes:</a><span class="ce">; [$fa31]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_PopulateDigits">UI_PopulateDigits</a></span></span><span class="ce">; Populate the ASCII digits.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; Start at the provided index + 1.</span></span>
<span class="l"></span>
<div class="c">;
; Check if the digit displays "0". If not, we're done.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$fa35]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,X</span></span><span class="ce">; Load the current ASCII digit.</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">#$30</span></span><span class="ce">; Is it an ASCII "0"?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, we're done.</span></span>
<span class="l"></span>
<div class="c">;
; Clear out the digit entirely.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; NUL out this digit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,X</span></span><span class="ce">; Store that as the new digit value.</span></span>
<span class="l"><span><span class="i">INX</span></span><span class="ce">; i++</span></span>
<span class="l"><span><span class="i">CPX</span> <span class="o">#$06</span></span><span class="ce">; Are we at the end of the loop?</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop again.</span></span>
<span class="l"></span>
<span class="l"><a name="@_return" href="#@_return" class="lla">@_return:</a><span class="ce">; [$fa46]</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Populate RAM with the digits to set based in the status UI.
;
; This will take the 24-bit value stored in
; #$ee:#$ed:<a href="RAM.html#Temp_Int24">Temp_Int24</a>.
;
; It will loop through every digit, convert to ASCII, and
; store in <a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a> for render.
;
; INPUTS:
;     #$ee:
;         The upper byte of the 24-bit value.
;
;     #$ed:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     <a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>:
;         The resulting digits in ASCII form.
;
; CALLS:
;     <a href="#UI_GetValueForDigit">UI_GetValueForDigit</a>
;
; XREFS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;     <a href="#UI_PopulateDigitsNoLeadingZeroes">UI_PopulateDigitsNoLeadingZeroes</a>
;============================================================================
</div><span class="l"><a name="UI_PopulateDigits" href="#UI_PopulateDigits" class="la">UI_PopulateDigits:</a><span class="ce">; [$fa47]</span></span>
<div class="c">;
; Prepare to loop 7 times (the max number of digits).
;
</div><span class="l"><span><span class="i">LDX</span> <span class="o">#$06</span></span><span class="ce">; Set the upper bound for the loop. We'll count down.</span></span>
<span class="l"></span>
<div class="c">;
; Get the value for the next digit and convert to ASCII.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$fa49]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#UI_GetValueForDigit">UI_GetValueForDigit</a></span></span><span class="ce">; Get the value for this digit.</span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$30</span></span><span class="ce">; Normalize the value to an ASCII digit.</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,X</span></span><span class="ce">; Store in the target position in RAM.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; i--</span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; Loop if we're not done.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Return a numeric value for status line UI display.
;
; This takes a 24-bit value (representing the gold or
; experience, in practice) and converts it to a numeric
; value between 0 and 9.
;
; It does this by considering the unsigned integer value
; (stored as #$ee:#$ed:<a href="RAM.html#Temp_Int24">Temp_Int24</a>).
;
; It loops for each of the 24 bits, left-shifting and
; rotating the most-significant bit into A (the resulting
; value). If A &gt;= 10, it will subtract 10 and set the
; quotient bit incrementing @{symbol Temp3_L}. Rinse and
; repeat.
;
; After 24 iterations, the the remainder will be in A, and
; this will be a value between 0 and 9.
;
; The upper, middle, and lower values will be modified to
; divide by 10, which allows this to be called repeatedly
; to get every digit.
;
; INPUTS:
;     #$ee:
;         The upper byte of the 24-bit value.
;
;     #$ed:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     A:
;         The resulting digit (between 0 and 9).
;
;     #$ee:
;         Upper byte of the floor of the value / 10.
;
;     #$ed:
;         Middle byte of the floor of the value / 10.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         Lower byte of the floor of the value / 10.
;
; XREFS:
;     <a href="#UI_PopulateDigits">UI_PopulateDigits</a>
;============================================================================
</div><span class="l"><a name="UI_GetValueForDigit" href="#UI_GetValueForDigit" class="la">UI_GetValueForDigit:</a><span class="ce">; [$fa55]</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$18</span></span><span class="ce">; Prepare to loop over the 24 bits.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Set A (our value) = 0.</span></span>
<span class="l"></span>
<span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$fa59]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Shift the low byte &lt;&lt; 1;
Set C as the out going bit.</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span><span class="ce">; Set mid byte = (mid &lt;&lt; 1) | C</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span><span class="ce">; Set high byte = (high &lt;&lt; 1) | C</span></span>
<span class="l"><span><span class="i">ROL</span> <span class="o">A</span></span><span class="ce">; Set A = (A &lt;&lt; 1) | outgoing bit of high byte</span></span>
<span class="l"></span>
<div class="c">;
; If the remainder (A) &gt;= 10, subtract 10 and set the
; quotient bit (by incrementing <a href="RAM.html#Temp_Int24">Temp_Int24</a>).
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; Is A &gt;= 10?</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_finishLoopIter">@_finishLoopIter</a></span></span><span class="ce">; Branch if not.</span></span>
<span class="l"><span><span class="i">SBC</span> <span class="o">#$0a</span></span><span class="ce">; A &gt;= 10, so subtract 10.</span></span>
<span class="l"><span><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Set quotient bit to 1.</span></span>
<span class="l"></span>
<span class="l"><a name="@_finishLoopIter" href="#@_finishLoopIter" class="lla">@_finishLoopIter:</a><span class="ce">; [$fa68]</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; i-- (process next bit)</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; Loop until we hit 0.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="STATUS_BAR_PPU_ADDR_L" href="#STATUS_BAR_PPU_ADDR_L" class="la">STATUS_BAR_PPU_ADDR_L:</a><span class="ce">; [$fa6c]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$63</span></span><span class="ce">; [0]: Power bar</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;
</div><span class="l"><a name="STATUS_BAR_PPU_ADDR_L_1_" href="#STATUS_BAR_PPU_ADDR_L_1_" class="la">STATUS_BAR_PPU_ADDR_L_1_:</a><span class="ce">; [$fa6d]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$43</span></span><span class="ce">; [1]: Mana bar</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]: Power bar</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__fa6e_1_" href="#BYTE_ARRAY_PRG15_MIRROR__fa6e_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__fa6e_1_:</a><span class="ce">; [$fa6f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [1]: Manab ar</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [0]: Power bar</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;
</div><span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__fa70_1_" href="#BYTE_ARRAY_PRG15_MIRROR__fa70_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__fa70_1_:</a><span class="ce">; [$fa71]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [1]: Mana bar</span></span>
<span class="l"></span>
<span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__fa72" href="#BYTE_ARRAY_PRG15_MIRROR__fa72" class="la">BYTE_ARRAY_PRG15_MIRROR__fa72:</a><span class="ce">; [$fa72]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<span class="l"><a name="BYTE_ARRAY_PRG15_MIRROR__fa72_1_" href="#BYTE_ARRAY_PRG15_MIRROR__fa72_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__fa72_1_:</a><span class="ce">; [$fa73]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [2]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document UI_DrawPlayerHPValue
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddHP">IScriptAction_AddHP</a>
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a>
;============================================================================
</div><span class="l"><a name="UI_DrawPlayerHPValue" href="#UI_DrawPlayerHPValue" class="la">UI_DrawPlayerHPValue:</a><span class="ce">; [$fa75]</span></span>
<div class="c">;
; Cap the amount of HP to 80, if over.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$51</span></span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fa7b">@LAB_PRG15_MIRROR__fa7b</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$50</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fa7b" href="#@LAB_PRG15_MIRROR__fa7b" class="lla">@LAB_PRG15_MIRROR__fa7b:</a><span class="ce">; [$fa7b]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_AddedHPValue">Temp_AddedHPValue</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Set the number of mana points for the player.
;
; Once set, the mana bar will be drawn to reflect the new amount.
;
; INPUT:
;     A:
;         The mana points to set.
;
; OUTPUT:
;     None
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddMP">IScriptAction_AddMP</a>
;     <a href="#Player_AddMP">Player_AddMP</a>
;     <a href="#Player_ReduceMP">Player_ReduceMP</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a name="Player_SetMP" href="#Player_SetMP" class="la">Player_SetMP:</a><span class="ce">; [$fa85]</span></span>
<div class="c">;
; Cap the number of mana points to 80, if over.
;
</div><span class="l"><span><span class="i">CMP</span> <span class="o">#$51</span></span><span class="ce">; Check if over 80 mana points.</span></span>
<span class="l"><span><span class="i">BCC</span> <span class="o"><a href="#@_storePoints">@_storePoints</a></span></span><span class="ce">; If not over, we'll store what was passed in.</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$50</span></span><span class="ce">; Cap to 80 mana points.</span></span>
<span class="l"></span>
<span class="l"><a name="@_storePoints" href="#@_storePoints" class="lla">@_storePoints:</a><span class="ce">; [$fa8b]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Set the player's current mana points.</span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document UI_DrawManaOrHPBar
;
; INPUTS:
;     A
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a>
;============================================================================
</div><span class="l"><a name="UI_DrawManaOrHPBar" href="#UI_DrawManaOrHPBar" class="la">UI_DrawManaOrHPBar:</a><span class="ce">; [$fa90]</span></span>
<div class="c">;
; Set the upper byte of the 24-bit integer of the value to draw.
;
</div><span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_ManaOrHPBar">Something_ManaOrHPBar</a></span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"><span><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fa9e">@LAB_PRG15_MIRROR__fa9e</a></span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fa9e" href="#@LAB_PRG15_MIRROR__fa9e" class="lla">@LAB_PRG15_MIRROR__fa9e:</a><span class="ce">; [$fa9e]</span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Set the draw position for the bar to update.
; This will be based on the lower address from the
; <a href="#STATUS_BAR_PPU_ADDR_L">STATUS_BAR_PPU_ADDR_L</a> lookup table.
;
; Bar 0 is the Mana bar.
; Bar 1 is the Power bar.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fa6c,Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Something_ManaOrHPBar">Something_ManaOrHPBar</a></span></span></span>
<span class="l"><span><span class="i">INX</span></span></span>
<span class="l"><span><span class="i">TXA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fac6">@LAB_PRG15_MIRROR__fac6</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fa6e,Y</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fabe" href="#@LAB_PRG15_MIRROR__fabe" class="lla">@LAB_PRG15_MIRROR__fabe:</a><span class="ce">; [$fabe]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fabe">@LAB_PRG15_MIRROR__fabe</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fac6" href="#@LAB_PRG15_MIRROR__fac6" class="lla">@LAB_PRG15_MIRROR__fac6:</a><span class="ce">; [$fac6]</span></span>
<span class="l"><span><span class="i">CMP</span> <span class="o">a:<a href="RAM.html#Something_ManaOrHPBar">Something_ManaOrHPBar</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fae2">@LAB_PRG15_MIRROR__fae2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fa70,Y</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fad6" href="#@LAB_PRG15_MIRROR__fad6" class="lla">@LAB_PRG15_MIRROR__fad6:</a><span class="ce">; [$fad6]</span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">a:<a href="RAM.html#Something_ManaOrHPBar">Something_ManaOrHPBar</a></span></span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fae2">@LAB_PRG15_MIRROR__fae2</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fad6">@LAB_PRG15_MIRROR__fad6</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fae2" href="#@LAB_PRG15_MIRROR__fae2" class="lla">@LAB_PRG15_MIRROR__fae2:</a><span class="ce">; [$fae2]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$0b</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Math_MultiplyBy8">Math_MultiplyBy8</a></span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fa72,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb14">@LAB_PRG15_MIRROR__fb14</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fb05" href="#@LAB_PRG15_MIRROR__fb05" class="lla">@LAB_PRG15_MIRROR__fb05:</a><span class="ce">; [$fb05]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fb2f,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb05">@LAB_PRG15_MIRROR__fb05</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fb14" href="#@LAB_PRG15_MIRROR__fb14" class="lla">@LAB_PRG15_MIRROR__fb14:</a><span class="ce">; [$fb14]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fb37,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb14">@LAB_PRG15_MIRROR__fb14</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fb20" href="#@LAB_PRG15_MIRROR__fb20" class="lla">@LAB_PRG15_MIRROR__fb20:</a><span class="ce">; [$fb20]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fb27,Y</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fb27" href="#@LAB_PRG15_MIRROR__fb27" class="lla">@LAB_PRG15_MIRROR__fb27:</a><span class="ce">; [$fb27]</span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb20">@LAB_PRG15_MIRROR__fb20</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#LAB_PRG15_MIRROR__fb05">LAB_PRG15_MIRROR__fb05</a> [$PRG15_MIRROR::fb05]
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__fb2f" href="#BYTE_PRG15_MIRROR__fb2f" class="la">BYTE_PRG15_MIRROR__fb2f:</a><span class="ce">; [$fb2f]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00</span></span><span class="ce">; [$fb2f] byte</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#LAB_PRG15_MIRROR__fb14">LAB_PRG15_MIRROR__fb14</a> [$PRG15_MIRROR::fb14]
;
</div><span class="l"><a name="BYTE_PRG15_MIRROR__fb37" href="#BYTE_PRG15_MIRROR__fb37" class="la">BYTE_PRG15_MIRROR__fb37:</a><span class="ce">; [$fb37]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$80,$80,$80,$80,$ff,$00</span></span><span class="ce">; [$fb37] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$c0,$c0,$c0,$c0,$ff,$00</span></span><span class="ce">; [$fb47] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$e0,$e0,$e0,$e0,$ff,$00</span></span><span class="ce">; [$fb57] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$f0,$f0,$f0,$f0,$ff,$00</span></span><span class="ce">; [$fb67] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$f8,$f8,$f8,$f8,$ff,$00</span></span><span class="ce">; [$fb77] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$fc,$fc,$fc,$fc,$ff,$00</span></span><span class="ce">; [$fb87] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$fe,$fe,$fe,$fe,$ff,$00</span></span><span class="ce">; [$fb97] byte</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00</span></span><span class="ce">; [$fba7] byte</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__fbaf
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__fbaf" href="#FUN_PRG15_MIRROR__fbaf" class="la">FUN_PRG15_MIRROR__fbaf:</a><span class="ce">; [$fbaf]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$13</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span></span>
<span class="l"><span><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fbc5">@LAB_PRG15_MIRROR__fbc5</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$40</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fbc5" href="#@LAB_PRG15_MIRROR__fbc5" class="lla">@LAB_PRG15_MIRROR__fbc5:</a><span class="ce">; [$fbc5]</span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fbd1" href="#@LAB_PRG15_MIRROR__fbd1" class="lla">@LAB_PRG15_MIRROR__fbd1:</a><span class="ce">; [$fbd1]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$b4e4,Y</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__fbf0">FUN_PRG15_MIRROR__fbf0</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fbdb" href="#@LAB_PRG15_MIRROR__fbdb" class="lla">@LAB_PRG15_MIRROR__fbdb:</a><span class="ce">; [$fbdb]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fbdb">@LAB_PRG15_MIRROR__fbdb</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fbd1">@LAB_PRG15_MIRROR__fbd1</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__fbf0
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__fbaf">FUN_PRG15_MIRROR__fbaf</a>
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;============================================================================
</div><span class="l"><a name="FUN_PRG15_MIRROR__fbf0" href="#FUN_PRG15_MIRROR__fbf0" class="la">FUN_PRG15_MIRROR__fbf0:</a><span class="ce">; [$fbf0]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">ADC</span> <span class="o">#$85</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.M">Temp_Int24.M</a></span></span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_SetItem
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a name="Player_SetItem" href="#Player_SetItem" class="la">Player_SetItem:</a><span class="ce">; [$fc0b]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$13</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPU_TargetAddr.U">PPU_TargetAddr.U</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$c0</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><span><span class="i">ORA</span> <span class="o">#$80</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Player_DrawItemInternal
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#Maybe_DrawItemName">Maybe_DrawItemName</a>
;============================================================================
</div><span class="l"><a name="Player_DrawItemInternal" href="#Player_DrawItemInternal" class="la">Player_DrawItemInternal:</a><span class="ce">; [$fc18]</span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#GetInventoryIndexForItem">GetInventoryIndexForItem</a></span></span></span>
<span class="l"><span><span class="i">TAX</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fc5b,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24.U">Temp_Int24.U</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$fc60,X</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$1f</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank2">CurrentROMBank2</a></span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$0a</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdatePRGBank">MMC1_UpdatePRGBank</a></span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fc36" href="#@LAB_PRG15_MIRROR__fc36" class="lla">@LAB_PRG15_MIRROR__fc36:</a><span class="ce">; [$fc36]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">(#$ee),Y</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#FUN_PRG15_MIRROR__fbf0">FUN_PRG15_MIRROR__fbf0</a></span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">PHA</span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><span><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<span class="l"><a name="@LAB_PRG15_MIRROR__fc44" href="#@LAB_PRG15_MIRROR__fc44" class="lla">@LAB_PRG15_MIRROR__fc44:</a><span class="ce">; [$fc44]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteFromTemp">PPUBuffer_WriteFromTemp</a></span></span></span>
<span class="l"><span><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fc44">@LAB_PRG15_MIRROR__fc44</a></span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_UpperBounds">PPUBuffer_UpperBounds</a></span></span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a></span></span></span>
<span class="l"><span><span class="i">PLA</span></span></span>
<span class="l"><span><span class="i">TAY</span></span></span>
<span class="l"><span><span class="i">INY</span></span></span>
<span class="l"><span><span class="i">TYA</span></span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fc36">@LAB_PRG15_MIRROR__fc36</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;
</div><span class="l"><a name="FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE" href="#FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE" class="la">FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE:</a><span class="ce">; [$fc5b]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$a0</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$d0</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$e4</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_DrawItemInternal">Player_DrawItemInternal</a>
;
</div><span class="l"><a name="FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE" href="#FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE" class="la">FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE:</a><span class="ce">; [$fc60]</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [0]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [1]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [2]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [3]:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [4]:</span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Show the start screen and handle game start or password selection.
;
; This is shown just after the game boots. The screen will
; be drawn and will wait on input from the player, allowing
; them to start the game or enter the password screen.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;     <a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;     <a href="#Something_FrameAltToggleWithPausePPU">Something_FrameAltToggleWithPausePPU</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a>
;============================================================================
</div><span class="l"><a name="Game_ShowStartScreen" href="#Game_ShowStartScreen" class="la">Game_ShowStartScreen:</a><span class="ce">; [$fc65]</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><span><span class="i">TXS</span></span><span class="ce">; Store X in memory.</span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a></span></span>
<span class="l"></span>
<div class="c">;
; Wait for a choice at the game's start screen.
;
</div><span class="l"><a name="@_waitForInput" href="#@_waitForInput" class="lla">@_waitForInput:</a><span class="ce">; [$fc6e]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#Something_FrameAltToggleWithPausePPU">Something_FrameAltToggleWithPausePPU</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterCheckHandleInputFarJump" href="#@_afterCheckHandleInputFarJump" class="lla">@_afterCheckHandleInputFarJump:</a><span class="ce">; [$fc7a]</span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Check the changed controller 1 button mask.</span></span>
<span class="l"><span><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Was the Start button pressed?</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_waitForInput">@_waitForInput</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"></span>
<div class="c">;
; The player pressed Start. Check what they chose.
;
; But first, play the titlescreen music.
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$08</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentMusic">CurrentMusic</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ScreenBuffer_135_">ScreenBuffer_135_</a></span></span><span class="ce">; Check the chosen option.</span></span>
<span class="l"><span><span class="i">BEQ</span> <span class="o"><a href="#@_startGame">@_startGame</a></span></span><span class="ce">; If 0, they chose to start the game.
Else, fall through.</span></span>
<span class="l"></span>
<div class="c">;
; The player chose to enter the Password screen.
;
; Switch to bank 12 and run <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>.
;
</div><span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a></span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>.
;
</div><span class="l"><a name="@_afterPasswordScreenShow" href="#@_afterPasswordScreenShow" class="lla">@_afterPasswordScreenShow:</a><span class="ce">; [$fc8f]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a></span></span>
<span class="l"></span>
<span class="l"><a name="@_afterSetExpGoldFarJump" href="#@_afterSetExpGoldFarJump" class="lla">@_afterSetExpGoldFarJump:</a><span class="ce">; [$fc95]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Player_Spawn">Player_Spawn</a></span></span></span>
<span class="l"></span>
<div class="c">;
; The player chose to start the game.
;
; Switch to bank 12 and run <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>.
;
</div><span class="l"><a name="@_startGame" href="#@_startGame" class="lla">@_startGame:</a><span class="ce">; [$fc98]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a></span></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a>.
;
</div><span class="l"><a name="@_afterRunIntroFarJump" href="#@_afterRunIntroFarJump" class="lla">@_afterRunIntroFarJump:</a><span class="ce">; [$fc9e]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><span><span class="i">dw</span> <span class="o"><a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a></span></span>
<span class="l"></span>
<div class="c">;
; Begin the game.
;
</div><span class="l"><a name="@_afterSetStartGameStateFarJump" href="#@_afterSetStartGameStateFarJump" class="lla">@_afterSetStartGameStateFarJump:</a><span class="ce">; [$fca4]</span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Game_Start">Game_Start</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; TODO: Document Something_SetXYAndAnimOffset
;
; INPUTS:
;     A
;     X
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#FUN_PRG12__9075">FUN_PRG12__9075</a>
;     <a href="PRG12.html#IScripts_Something_99DB">IScripts_Something_99DB</a>
;     <a href="PRG12.html#IScripts_Something_SetXYAndOffset_99a1">IScripts_Something_SetXYAndOffset_99a1</a>
;     <a href="PRG12.html#IScripts_Something_SetXYAndOffset_99be">IScripts_Something_SetXYAndOffset_99be</a>
;     <a href="PRG12.html#Menu_Something_954F">Menu_Something_954F</a>
;     <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>
;============================================================================
</div><span class="l"><a name="Something_SetXYAndAnimOffset" href="#Something_SetXYAndAnimOffset" class="la">Something_SetXYAndAnimOffset:</a><span class="ce">; [$fca7]</span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosX">Maybe_Arg_CurrentSprite_PosX</a></span></span></span>
<span class="l"><span><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Arg_CurrentSprite_PosY">Maybe_Arg_CurrentSprite_PosY</a></span></span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STX</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><span><span class="i">JMP</span> <span class="o"><a href="#Sprite_Maybe_SetAppearanceAddrFromOffset">Sprite_Maybe_SetAppearanceAddrFromOffset</a></span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Fill the PPU with a single byte repeated `count` times.
;
; This will always write the value at least once and then
; decrement. If a count of 0 is passed, it will decrement
; to 0xFF, and then loop back down to 0.
;
; INPUTS:
;     A:
;         The value to write.
;
;     Y:
;         The number of times to write the value.
;
;         If 0, this will write 256 times.
;
; OUTPUTS:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         This will be filled with values.
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="#FUN_PRG15_MIRROR__fbaf">FUN_PRG15_MIRROR__fbaf</a>
;     <a href="#PPU_ClearAllTilemaps">PPU_ClearAllTilemaps</a>
;     <a href="#PPU_FillData">PPU_FillData</a>
;     <a href="#UI_DrawStatusSymbols">UI_DrawStatusSymbols</a>
;============================================================================
</div><span class="l"><a name="PPU_FillData" href="#PPU_FillData" class="la">PPU_FillData:</a><span class="ce">; [$fcb2]</span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Store the value in PPUDATA.</span></span>
<span class="l"><span><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
</pre><pre><span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Clear all tiles across all nametables.
;
; This will fill every tile with 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The updated address.
;
; CALLS:
;     <a href="#PPU_FillData">PPU_FillData</a>
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;============================================================================
</div><span class="l"><a name="PPU_ClearAllTilemaps" href="#PPU_ClearAllTilemaps" class="la">PPU_ClearAllTilemaps:</a><span class="ce">; [$fcb9]</span></span>
<div class="c">;
; Set the start position to the top-left ($2000).
;
</div><span class="l"><span><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><span><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><span><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"></span>
<div class="c">;
; Prepare the value and loop counter.
;
</div><span class="l"><span><span class="i">TAY</span></span><span class="ce">; Y = 0 (value to write)</span></span>
<span class="l"><span><span class="i">LDX</span> <span class="o">#$04</span></span><span class="ce">; X = 4 (loop counter)</span></span>
<span class="l"></span>
<div class="c">;
; Begin the loop.
;
</div><span class="l"><a name="@_loop" href="#@_loop" class="lla">@_loop:</a><span class="ce">; [$fcc6]</span></span>
<span class="l"><span><span class="i">JSR</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span><span class="ce">; Fill 256 bytes of data.</span></span>
<span class="l"><span><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><span><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><span><span class="i">RTS</span></span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">bd ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fccd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fcdd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fced] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fcfd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd0d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd1d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd2d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd3d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd4d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd5d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd6d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd7d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd8d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd9d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdad] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdbd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdcd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fddd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fded] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdfd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe0d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe1d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe2d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe3d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe4d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe5d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe6d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe7d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe8d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe9d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fead] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$febd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fecd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fedd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$feed] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fefd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff0d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff1d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff2d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff3d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff4d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff5d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff6d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff7d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff8d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff9d] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ffad] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ffbd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ffcd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">ff ff ff 20 20 20 20 20 20 20 20 46 41 58 41 4e</span></span><span class="ce">; [$ffdd] undefined</span></span>
<span class="l"><span><span class="i">hex</span> <span class="o">41 44 55 27 42 00 00 48 04 01 07 18 94 99 c9 13</span></span><span class="ce">; [$ffed] undefined</span></span>
<span class="l"><span><span class="i">db</span> <span class="o">$c9,$d5,$c9</span></span><span class="ce">; [$fffd] undefined</span></span>
</pre>
 </body>
</html>
