<!DOCTYPE html>

<html>
 <head>
  <title>PRG15_MIRROR - Faxanadu (U).nes</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <style>

 @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');

body {
  background: #1c212d;
  color: white;
  padding: 0.5em;
  line-height: 1.5;
}

body, * {
  font-family: "Roboto Mono", monospace;
  font-size: 9.5pt;
  font-style: normal;
}

a:link,
a:visited {
  color: #9bdeff;
}

pre {
  display: grid;
  grid-template-columns: minmax(6ch, min-content)
                         minmax(70ch, max-content)
                         1fr;
  gap: 0 3em;
  margin: 0;
  padding: 0;
}

.anc {
  grid-area: addr;
  grid-column: 1;
  grid-row: 1;
}

.anc:link,
.anc:visited {
  color: #666677;
  text-decoration: none;
}

.anc:link:hover {
  color: #9bdeff;
}

.equs {
  display: grid;
  grid-template-columns: minmax(50ch, max-content) min-content auto;
  gap: 0 1em;
}

.l {
  display: grid;
  grid-template-columns: subgrid;
  grid-column: 1 / -1;
  min-height: 1lh;
}

.c,
.cp,
.equs {
  grid-column: 2;
}

.cp {
  color: #6fafb5;
}

.c {
  margin-left: 4em;
}

.c, .ce {
  color: #8aa9ac;
}

.cd {
  grid-column: 2 / 3;
}

.ce {
  grid-column: -1;
  text-wrap: wrap;
  text-indent: 2ch hanging;
}

.lla {
  margin-left: 2em;
}

.la,
.lla {
  font-weight: bold;
  grid-column: 2 / 3;
}

.la,
.la:link,
.la:visited {
  color: #e8e801;
}

.lla,
.lla:link,
.lla:visited {
  color: #caca00;
}

.i {
  color: #f26969;
  margin-left: 4em;
  min-width: 3em;
}

.o {
  color: #e3e3e3;
  margin-left: 1ch;
}

  </style>
 </head>
 <body>
  <pre>
<div class="cp">;============================================================================
; Faxanadu (U).nes
;
; PRG15_MIRROR ($c000 - $ffff)
;============================================================================
</div><span class="l"></span>
<span class="l"><span class="cd"><span class="i">BASE $c000</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_SetHUDPPUAttributes"></a><div class="cp">;============================================================================
; Write attribute data for the HUD to the PPU.
;
; The attribute data will be written from
; <a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a> based on the
; <a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a> set when loading the
; screen.
;
; INPUTS:
;     <a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a>:
;         The index into the lookup table for the current
;         screen.
;
;     <a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a>:
;         The lookup table of attribute data to write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The updated PPU address.
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The written data.
;
; CALLS:
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;
; XREFS:
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;============================================================================
</div><span class="l"><a class="anc" name="c000" href="#c000">[c000]</a><a href="#UI_SetHUDPPUAttributes" class="la">UI_SetHUDPPUAttributes:</a><span class="ce">; [$c000]</span></span>
<div class="c">;
; Set the PPUADDR to 0x23C0, the top row where the status
; bar resides.
;
</div><span class="l"><a class="anc" name="c000" href="#c000">[c000]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$23</span></span></span>
<span class="l"><a class="anc" name="c002" href="#c002">[c002]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper PPUADDR as 0x23.</span></span>
<span class="l"><a class="anc" name="c005" href="#c005">[c005]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="c007" href="#c007">[c007]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper PPUADDR as 0xC0.</span></span>
<span class="l"><a class="anc" name="c00a" href="#c00a">[c00a]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a></span></span><span class="ce">; X = HUD attribute data index, computed when setting up the screen.</span></span>
<span class="l"><a class="anc" name="c00d" href="#c00d">[c00d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a>,X</span></span><span class="ce">; Load the value for the attribute data.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write 8 bytes based on data from the lookup table
; <a href="#HUD_ATTRIBUTE_DATA_BY_INDEX">HUD_ATTRIBUTE_DATA_BY_INDEX</a> at index
; <a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a>.
;
</div><span class="l"><a class="anc" name="c010" href="#c010">[c010]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; X = 8 (loop counter).</span></span>
<span class="l"></span>
<a name=":c012:@_writeLoop"></a><span class="l"><a class="anc" name="c012" href="#c012">[c012]</a><a href="#:c012:@_writeLoop" class="lla">@_writeLoop:</a><span class="ce">; [$c012]</span></span>
<span class="l"><a class="anc" name="c012" href="#c012">[c012]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU.</span></span>
<span class="l"><a class="anc" name="c015" href="#c015">[c015]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="c016" href="#c016">[c016]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_writeLoop">@_writeLoop</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the HUD.
;
</div><span class="l"><a class="anc" name="c018" href="#c018">[c018]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawHUD">UI_DrawHUD</a></span></span><span class="ce">; Jump to draw the HUD.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="HUD_ATTRIBUTE_DATA_BY_INDEX"></a><div class="cp">;============================================================================
; Attribute data used for the HUD.
;
; These are indexed by values from lookup table
; <a href="PRG11.html#PALETTE_INDEX_TO_UI_BG_ATTRIBUTE_INDEX">PALETTE_INDEX_TO_UI_BG_ATTRIBUTE_INDEX</a> (stored in
; <a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a>.
;
; Only values 0, 1, 2, and 3 are used.
;
; The rest seem to be unused, but many end up styled to
; better match regions of the game.
;
; XREFS:
;     <a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a>
;
</div><span class="l"><a class="anc" name="c01b" href="#c01b">[c01b]</a><a href="#HUD_ATTRIBUTE_DATA_BY_INDEX" class="la">HUD_ATTRIBUTE_DATA_BY_INDEX:</a><span class="ce">; [$c01b]</span></span>
<span class="l"><a class="anc" name="c01b" href="#c01b">[c01b]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Dartmoor, Castle of Fraternal, King Grieve's Room</span></span>
<span class="l"><a class="anc" name="c01c" href="#c01c">[c01c]</a><span class="cd"><span class="i">db</span> <span class="o">$55</span></span><span class="ce">; [1]: Start Screen</span></span>
<span class="l"><a class="anc" name="c01d" href="#c01d">[c01d]</a><span class="cd"><span class="i">db</span> <span class="o">$aa</span></span><span class="ce">; [2]: Most exterior areas.</span></span>
<span class="l"><a class="anc" name="c01e" href="#c01e">[c01e]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [3]: Most interior areas.</span></span>
<span class="l"><a class="anc" name="c01f" href="#c01f">[c01f]</a><span class="cd"><span class="i">db</span> <span class="o">$41</span></span><span class="ce">; [4]: Here and below are unused.</span></span>
<span class="l"><a class="anc" name="c020" href="#c020">[c020]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="c021" href="#c021">[c021]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="c022" href="#c022">[c022]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="c023" href="#c023">[c023]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="c024" href="#c024">[c024]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="c025" href="#c025">[c025]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="c026" href="#c026">[c026]</a><span class="cd"><span class="i">db</span> <span class="o">$61</span></span><span class="ce">; [11]:</span></span>
<span class="l"><a class="anc" name="c027" href="#c027">[c027]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [12]:</span></span>
<span class="l"><a class="anc" name="c028" href="#c028">[c028]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [13]:</span></span>
<span class="l"><a class="anc" name="c029" href="#c029">[c029]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [14]:</span></span>
<span class="l"><a class="anc" name="c02a" href="#c02a">[c02a]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [15]:</span></span>
<span class="l"><a class="anc" name="c02b" href="#c02b">[c02b]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [16]:</span></span>
<span class="l"><a class="anc" name="c02c" href="#c02c">[c02c]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [17]:</span></span>
<span class="l"><a class="anc" name="c02d" href="#c02d">[c02d]</a><span class="cd"><span class="i">db</span> <span class="o">$56</span></span><span class="ce">; [18]:</span></span>
<span class="l"><a class="anc" name="c02e" href="#c02e">[c02e]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [19]:</span></span>
<span class="l"><a class="anc" name="c02f" href="#c02f">[c02f]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [20]:</span></span>
<span class="l"><a class="anc" name="c030" href="#c030">[c030]</a><span class="cd"><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [21]:</span></span>
<span class="l"><a class="anc" name="c031" href="#c031">[c031]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [22]:</span></span>
<span class="l"><a class="anc" name="c032" href="#c032">[c032]</a><span class="cd"><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [23]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="DEADCODE_FUN_PRG15_MIRROR__c033"></a><div class="cp">;============================================================================
; DEADCODE
;============================================================================
</div><span class="l"><a class="anc" name="c033" href="#c033">[c033]</a><a href="#DEADCODE_FUN_PRG15_MIRROR__c033" class="la">DEADCODE_FUN_PRG15_MIRROR__c033:</a><span class="ce">; [$c033]</span></span>
<span class="l"><a class="anc" name="c033" href="#c033">[c033]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c035" href="#c035">[c035]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="c037" href="#c037">[c037]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="c039" href="#c039">[c039]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="c03a" href="#c03a">[c03a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="c03c" href="#c03c">[c03c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="c03e" href="#c03e">[c03e]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="c03f" href="#c03f">[c03f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="c041" href="#c041">[c041]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="c042" href="#c042">[c042]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><a class="anc" name="c045" href="#c045">[c045]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="c046" href="#c046">[c046]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c048" href="#c048">[c048]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<a name=":c04a:@LAB_PRG15_MIRROR__c04a"></a><span class="l"><a class="anc" name="c04a" href="#c04a">[c04a]</a><a href="#:c04a:@LAB_PRG15_MIRROR__c04a" class="lla">@LAB_PRG15_MIRROR__c04a:</a><span class="ce">; [$c04a]</span></span>
<span class="l"><a class="anc" name="c04a" href="#c04a">[c04a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="c04c" href="#c04c">[c04c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="c04f" href="#c04f">[c04f]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="c050" href="#c050">[c050]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="c051" href="#c051">[c051]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c053" href="#c053">[c053]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c04a">@LAB_PRG15_MIRROR__c04a</a></span></span></span>
<span class="l"><a class="anc" name="c055" href="#c055">[c055]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="c057" href="#c057">[c057]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawHUD"></a><div class="cp">;============================================================================
; Draw the player's state on the HUD UI.
;
; INPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's current MP.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;     <a href="#UI_DrawGoldValue">UI_DrawGoldValue</a>
;     <a href="#UI_DrawPlayerExperience">UI_DrawPlayerExperience</a>
;     <a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a>
;     <a href="#Player_SetMP">Player_SetMP</a>
;     <a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a>
;
; XREFS:
;     <a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a>
;============================================================================
</div><span class="l"><a class="anc" name="c058" href="#c058">[c058]</a><a href="#UI_DrawHUD" class="la">UI_DrawHUD:</a><span class="ce">; [$c058]</span></span>
<span class="l"><a class="anc" name="c058" href="#c058">[c058]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c05a" href="#c05a">[c05a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawTimeValue">UI_DrawTimeValue</a></span></span><span class="ce">; Draw the time value.</span></span>
<span class="l"><a class="anc" name="c05d" href="#c05d">[c05d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawGoldValue">UI_DrawGoldValue</a></span></span><span class="ce">; Draw the gold value.</span></span>
<span class="l"><a class="anc" name="c060" href="#c060">[c060]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><a class="anc" name="c063" href="#c063">[c063]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerExperience">UI_DrawPlayerExperience</a></span></span><span class="ce">; Draw the player experience value.</span></span>
<span class="l"><a class="anc" name="c066" href="#c066">[c066]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><a class="anc" name="c069" href="#c069">[c069]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><a class="anc" name="c06c" href="#c06c">[c06c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw the player's HP bar.</span></span>
<span class="l"><a class="anc" name="c06f" href="#c06f">[c06f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"><a class="anc" name="c072" href="#c072">[c072]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Load the player's MP.</span></span>
<span class="l"><a class="anc" name="c075" href="#c075">[c075]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetMP">Player_SetMP</a></span></span><span class="ce">; Set it and draw.</span></span>
<span class="l"><a class="anc" name="c078" href="#c078">[c078]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; Flush to the PPU.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_AddHP"></a><div class="cp">;============================================================================
; Increase the player's HP.
;
; This will be capped to 80HP.
;
; INPUTS:
;     A:
;         The number of health points to add.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The upper byte of player health to add to.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The new upper byte of player health.
;
; CALLS:
;     <a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a>
;
; XREFS:
;     <a href="PRG14.html#Player_HandleTouchBread">Player_HandleTouchBread</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a class="anc" name="c07b" href="#c07b">[c07b]</a><a href="#Player_AddHP" class="la">Player_AddHP:</a><span class="ce">; [$c07b]</span></span>
<div class="c">;
; Update the player's HP with the provided value.
;
</div><span class="l"><a class="anc" name="c07b" href="#c07b">[c07b]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear carry so it's not added.</span></span>
<span class="l"><a class="anc" name="c07c" href="#c07c">[c07c]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Add the provided HP to the player's health.</span></span>
<span class="l"><a class="anc" name="c07f" href="#c07f">[c07f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Store as the new health.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check against the cap.
;
</div><span class="l"><a class="anc" name="c082" href="#c082">[c082]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Cap at 80 HP.</span></span>
<span class="l"><a class="anc" name="c084" href="#c084">[c084]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_drawHP">@_drawHP</a></span></span><span class="ce">; Jump if it's under.</span></span>
<span class="l"><a class="anc" name="c086" href="#c086">[c086]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$50</span></span><span class="ce">; Else, cap it to 80HP.</span></span>
<span class="l"><a class="anc" name="c088" href="#c088">[c088]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Store as the new health.</span></span>
<span class="l"></span>
<a name=":c08b:@_drawHP"></a><span class="l"><a class="anc" name="c08b" href="#c08b">[c08b]</a><a href="#:c08b:@_drawHP" class="lla">@_drawHP:</a><span class="ce">; [$c08b]</span></span>
<span class="l"><a class="anc" name="c08b" href="#c08b">[c08b]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_ReduceHP"></a><div class="cp">;============================================================================
; Decrease the player's HP.
;
; If the HP hits &lt;= 0, and an elixir is in the inventory, it will be used.
; If it hits &lt;= 0 and there's no elixir, the player will die.
;
; INPUTS
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The player's current health.
;
;     <a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a>:
;     <a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a>:
;         The health to add.
;
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's current special items.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The new player health.
;
;     <a href="RAM.html#PlayerIsDead">PlayerIsDead</a>:
;         Set to 1 if the player dies.
;
; CALLS:
;     <a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a>
;     <a href="#Player_UseElixir">Player_UseElixir</a>
;
; XREFS:
;     <a href="PRG14.html#Player_ApplyDamage">Player_ApplyDamage</a>
;     <a href="PRG14.html#Player_HandleHitByMagic">Player_HandleHitByMagic</a>
;     <a href="PRG14.html#SpriteBehavior_FlashScreenHitPlayer">SpriteBehavior_FlashScreenHitPlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="c08e" href="#c08e">[c08e]</a><a href="#Player_ReduceHP" class="la">Player_ReduceHP:</a><span class="ce">; [$c08e]</span></span>
<div class="c">;
; Reduce the lower byte of player health.
;
</div><span class="l"><a class="anc" name="c08e" href="#c08e">[c08e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_L">Player_HP_L</a></span></span><span class="ce">; Load the lower byte of the player's health.</span></span>
<span class="l"><a class="anc" name="c091" href="#c091">[c091]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="c092" href="#c092">[c092]</a><span class="cd"><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span><span class="ce">; Subtract the specified lower byte of health.</span></span>
<span class="l"><a class="anc" name="c095" href="#c095">[c095]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_L">Player_HP_L</a></span></span><span class="ce">; Store it as the new player health.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reduce the upper byte of player health.
;
</div><span class="l"><a class="anc" name="c098" href="#c098">[c098]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the upper byte of the player's health.</span></span>
<span class="l"><a class="anc" name="c09b" href="#c09b">[c09b]</a><span class="cd"><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span><span class="ce">; Subtract the specified upper byte of health.</span></span>
<span class="l"><a class="anc" name="c09e" href="#c09e">[c09e]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Store it as the new player health.</span></span>
<span class="l"><a class="anc" name="c0a1" href="#c0a1">[c0a1]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_isStillAlive">@_isStillAlive</a></span></span><span class="ce">; If there's still health left, the player is still alive.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is out of health. They may die.
;
</div><span class="l"><a class="anc" name="c0a3" href="#c0a3">[c0a3]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c0a5" href="#c0a5">[c0a5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Set the player's upper byte of health to 0.</span></span>
<span class="l"><a class="anc" name="c0a8" href="#c0a8">[c0a8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw the health.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the player has an elixir before killing them.
;
</div><span class="l"><a class="anc" name="c0ab" href="#c0ab">[c0ab]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the player's special items.</span></span>
<span class="l"><a class="anc" name="c0ae" href="#c0ae">[c0ae]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span><span class="ce">; Check if the player has an elixir.</span></span>
<span class="l"><a class="anc" name="c0b0" href="#c0b0">[c0b0]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_killPlayer">@_killPlayer</a></span></span><span class="ce">; If not, kill the player.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player has an elixir. Fill up their health instead
; of killing the player.
;
</div><span class="l"><a class="anc" name="c0b2" href="#c0b2">[c0b2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_UseElixir">Player_UseElixir</a></span></span><span class="ce">; Use the Elixir.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c0b5:@_killPlayer"></a><div class="c">;
; Mark the player as dead.
;
</div><span class="l"><a class="anc" name="c0b5" href="#c0b5">[c0b5]</a><a href="#:c0b5:@_killPlayer" class="lla">@_killPlayer:</a><span class="ce">; [$c0b5]</span></span>
<span class="l"><a class="anc" name="c0b5" href="#c0b5">[c0b5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; Mark the player as dead.</span></span>
<span class="l"><a class="anc" name="c0b7" href="#c0b7">[c0b7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span><span class="ce">; Store that.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c0ba:@_isStillAlive"></a><div class="c">;
; Draw the player's health.
;
</div><span class="l"><a class="anc" name="c0ba" href="#c0ba">[c0ba]</a><a href="#:c0ba:@_isStillAlive" class="lla">@_isStillAlive:</a><span class="ce">; [$c0ba]</span></span>
<span class="l"><a class="anc" name="c0ba" href="#c0ba">[c0ba]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw player health.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawPlayerHP"></a><div class="cp">;============================================================================
; Draw the player's health.
;
; INPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The full value of the player's health.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a>
;
; XREFS:
;     <a href="#Player_ReduceHP">Player_ReduceHP</a>
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a class="anc" name="c0bd" href="#c0bd">[c0bd]</a><a href="#UI_DrawPlayerHP" class="la">UI_DrawPlayerHP:</a><span class="ce">; [$c0bd]</span></span>
<span class="l"><a class="anc" name="c0bd" href="#c0bd">[c0bd]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the player's current health.</span></span>
<span class="l"><a class="anc" name="c0c0" href="#c0c0">[c0c0]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a></span></span><span class="ce">; Draw it.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_ReduceMP"></a><div class="cp">;============================================================================
; Decrement the MP for a spell.
;
; This will look at the selected magic type and deduct the
; cost from the player's total MP if there's enough to cast.
;
; INPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's current MP.
;
;     <a href="RAM.html#SelectedMagic">SelectedMagic</a>:
;         The selected magic.
;
;     <a href="PRG14.html#MAGIC_COSTS">MAGIC_COSTS</a>:
;         The table of magic costs per spell.
;
; OUTPUTS:
;     C:
;         0 = Cost deducted for the spell.
;         1 = Not enough MP for the spell.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The new MP amount.
;
; CALLS:
;     <a href="#Player_SetMP">Player_SetMP</a>
;
; XREFS:
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;============================================================================
</div><span class="l"><a class="anc" name="c0c3" href="#c0c3">[c0c3]</a><a href="#Player_ReduceMP" class="la">Player_ReduceMP:</a><span class="ce">; [$c0c3]</span></span>
<span class="l"><a class="anc" name="c0c3" href="#c0c3">[c0c3]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#SelectedMagic">SelectedMagic</a></span></span><span class="ce">; Load the selected magic spell.</span></span>
<span class="l"><a class="anc" name="c0c6" href="#c0c6">[c0c6]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Load the player's total MP.</span></span>
<span class="l"><a class="anc" name="c0c9" href="#c0c9">[c0c9]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="c0ca" href="#c0ca">[c0ca]</a><span class="cd"><span class="i">SBC</span> <span class="o">$b7a9,X</span></span><span class="ce">; Look up the cost of this spell.</span></span>
<span class="l"><a class="anc" name="c0cd" href="#c0cd">[c0cd]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_notEnoughMP">@_notEnoughMP</a></span></span><span class="ce">; If there's not enough MP for the spell, then jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player has enough MP for the spell.
;
</div><span class="l"><a class="anc" name="c0cf" href="#c0cf">[c0cf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Else, store the reduced MP.</span></span>
<span class="l"><a class="anc" name="c0d2" href="#c0d2">[c0d2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetMP">Player_SetMP</a></span></span><span class="ce">; Set that on the player and draw.</span></span>
<span class="l"><a class="anc" name="c0d5" href="#c0d5">[c0d5]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear the carry flag to indicate a success.</span></span>
<span class="l"><a class="anc" name="c0d6" href="#c0d6">[c0d6]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c0d7:@_notEnoughMP"></a><div class="c">;
; The player does not have enough mana.
;
</div><span class="l"><a class="anc" name="c0d7" href="#c0d7">[c0d7]</a><a href="#:c0d7:@_notEnoughMP" class="lla">@_notEnoughMP:</a><span class="ce">; [$c0d7]</span></span>
<span class="l"><a class="anc" name="c0d7" href="#c0d7">[c0d7]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Set the carry flag to 1 to indicate not enough MP.</span></span>
<span class="l"><a class="anc" name="c0d8" href="#c0d8">[c0d8]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_AddMP"></a><div class="cp">;============================================================================
; Add points to the player's MP.
;
; This will be capped to 80 points.
;
; INPUTS:
;     A:
;         The MP to add.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's current MP.
;
; OUTPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The new MP.
;
; CALLS:
;     <a href="#Player_SetMP">Player_SetMP</a>
;
; XREFS:
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;============================================================================
</div><span class="l"><a class="anc" name="c0d9" href="#c0d9">[c0d9]</a><a href="#Player_AddMP" class="la">Player_AddMP:</a><span class="ce">; [$c0d9]</span></span>
<div class="c">;
; Add the provided MP to the player's MP.
;
</div><span class="l"><a class="anc" name="c0d9" href="#c0d9">[c0d9]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear carry so it's not added.</span></span>
<span class="l"><a class="anc" name="c0da" href="#c0da">[c0da]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Add to the player's  MP.</span></span>
<span class="l"><a class="anc" name="c0dd" href="#c0dd">[c0dd]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="c0e0" href="#c0e0">[c0e0]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Check if it's &gt; 80 points.</span></span>
<span class="l"><a class="anc" name="c0e2" href="#c0e2">[c0e2]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_drawMP">@_drawMP</a></span></span><span class="ce">; If we're under the cap, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Cap the MP to the total allowed amount.
;
</div><span class="l"><a class="anc" name="c0e4" href="#c0e4">[c0e4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$50</span></span><span class="ce">; Cap to 80 points.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store it.
;
</div><span class="l"><a class="anc" name="c0e6" href="#c0e6">[c0e6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span></span>
<span class="l"></span>
<a name=":c0e9:@_drawMP"></a><span class="l"><a class="anc" name="c0e9" href="#c0e9">[c0e9]</a><a href="#:c0e9:@_drawMP" class="lla">@_drawMP:</a><span class="ce">; [$c0e9]</span></span>
<span class="l"><a class="anc" name="c0e9" href="#c0e9">[c0e9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_SetMP">Player_SetMP</a></span></span><span class="ce">; Set the player's mana points and draw.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_Something_ChangeHP"></a><div class="cp">;============================================================================
; NOTE: This is used exclusively by the Unknown 29 sprite behavior.
;
; XREFS:
;     <a href="PRG14.html#SpriteBehavior_Unknown_29_SomeSetup">SpriteBehavior_Unknown_29_SomeSetup</a>
;============================================================================
</div><span class="l"><a class="anc" name="c0ec" href="#c0ec">[c0ec]</a><a href="#Player_Something_ChangeHP" class="la">Player_Something_ChangeHP:</a><span class="ce">; [$c0ec]</span></span>
<span class="l"><a class="anc" name="c0ec" href="#c0ec">[c0ec]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="c0ed" href="#c0ed">[c0ed]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="c0ee" href="#c0ee">[c0ee]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c0f0" href="#c0f0">[c0f0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c0f3" href="#c0f3">[c0f3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c0f6" href="#c0f6">[c0f6]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="c0f8" href="#c0f8">[c0f8]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span></span>
<span class="l"><a class="anc" name="c0fb" href="#c0fb">[c0fb]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span></span>
<span class="l"></span>
<a name=":c0fe:@LAB_PRG15_MIRROR__c0fe"></a><span class="l"><a class="anc" name="c0fe" href="#c0fe">[c0fe]</a><a href="#:c0fe:@LAB_PRG15_MIRROR__c0fe" class="lla">@LAB_PRG15_MIRROR__c0fe:</a><span class="ce">; [$c0fe]</span></span>
<span class="l"><a class="anc" name="c0fe" href="#c0fe">[c0fe]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c101" href="#c101">[c101]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c104" href="#c104">[c104]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c107" href="#c107">[c107]</a><span class="cd"><span class="i">CMP</span> <span class="o">a:<a href="RAM.html#SpriteBehaviorUnknown20_SomethingXOrY">SpriteBehaviorUnknown20_SomethingXOrY</a></span></span></span>
<span class="l"><a class="anc" name="c10a" href="#c10a">[c10a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c10d" href="#c10d">[c10d]</a><span class="cd"><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#BYTE_04bf">BYTE_04bf</a></span></span></span>
<span class="l"><a class="anc" name="c110" href="#c110">[c110]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c124">@LAB_PRG15_MIRROR__c124</a></span></span></span>
<span class="l"><a class="anc" name="c112" href="#c112">[c112]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c115" href="#c115">[c115]</a><span class="cd"><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#SpriteBehaviorUnknown20_SomethingXOrY">SpriteBehaviorUnknown20_SomethingXOrY</a></span></span></span>
<span class="l"><a class="anc" name="c118" href="#c118">[c118]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp1_SomethingChangedHP">Temp1_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c11b" href="#c11b">[c11b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"><a class="anc" name="c11e" href="#c11e">[c11e]</a><span class="cd"><span class="i">SBC</span> <span class="o">a:<a href="RAM.html#BYTE_04bf">BYTE_04bf</a></span></span></span>
<span class="l"><a class="anc" name="c121" href="#c121">[c121]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp2_SomethingChangedHP">Temp2_SomethingChangedHP</a></span></span></span>
<span class="l"></span>
<a name=":c124:@LAB_PRG15_MIRROR__c124"></a><span class="l"><a class="anc" name="c124" href="#c124">[c124]</a><a href="#:c124:@LAB_PRG15_MIRROR__c124" class="lla">@LAB_PRG15_MIRROR__c124:</a><span class="ce">; [$c124]</span></span>
<span class="l"><a class="anc" name="c124" href="#c124">[c124]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span></span>
<span class="l"><a class="anc" name="c127" href="#c127">[c127]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span></span>
<span class="l"><a class="anc" name="c12a" href="#c12a">[c12a]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="c12b" href="#c12b">[c12b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c0fe">@LAB_PRG15_MIRROR__c0fe</a></span></span></span>
<span class="l"><a class="anc" name="c12d" href="#c12d">[c12d]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="c12e" href="#c12e">[c12e]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="c12f" href="#c12f">[c12f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_ClearSprites"></a><div class="cp">;============================================================================
; Clear sprite state.
;
; This will clear out all the current sprites and the
; selected weapon, and reset the screen color mode.
;
; INPUTS:
;     <a href="RAM.html#PPU_Mask">PPU_Mask</a>:
;         The current screen color mode.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The cleared sprite entities.
;
;     <a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>:
;         The cleared sprite HPs.
;
;     <a href="RAM.html#CurrentSprites_HitCounter">CurrentSprites_HitCounter</a>:
;         The cleared sprite hit counters.
;
;     <a href="RAM.html#CurrentSprites_Behaviors">CurrentSprites_Behaviors</a>:
;         The cleared sprite subtypes.
;
;     <a href="RAM.html#PPU_Mask">PPU_Mask</a>:
;         The new color mode with greyscale removed.
;
;     <a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a>:
;         Set to 0xFF.
;
; CALLS:
;     <a href="#CurrentSprite_ResetPPUTileOffset">CurrentSprite_ResetPPUTileOffset</a>
;
; XREFS:
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_SetupSprites">Screen_SetupSprites</a>
;============================================================================
</div><span class="l"><a class="anc" name="c130" href="#c130">[c130]</a><a href="#Screen_ClearSprites" class="la">Screen_ClearSprites:</a><span class="ce">; [$c130]</span></span>
<span class="l"><a class="anc" name="c130" href="#c130">[c130]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; X = 7 (loop counter -- looping 8 times)</span></span>
<span class="l"></span>
<a name=":c132:@_clearSpritesLoop"></a><span class="l"><a class="anc" name="c132" href="#c132">[c132]</a><a href="#:c132:@_clearSpritesLoop" class="lla">@_clearSpritesLoop:</a><span class="ce">; [$c132]</span></span>
<span class="l"><a class="anc" name="c132" href="#c132">[c132]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="c134" href="#c134">[c134]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Set sprite to 0xFF (cleared).</span></span>
<span class="l"><a class="anc" name="c137" href="#c137">[c137]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c139" href="#c139">[c139]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>,X</span></span><span class="ce">; Set sprite hit points to 0.</span></span>
<span class="l"><a class="anc" name="c13c" href="#c13c">[c13c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HitCounter">CurrentSprites_HitCounter</a>,X</span></span><span class="ce">; Set sprite hit counter to 0.</span></span>
<span class="l"><a class="anc" name="c13f" href="#c13f">[c13f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Behaviors">CurrentSprites_Behaviors</a>,X</span></span><span class="ce">; Set sprite subtype to 0.</span></span>
<span class="l"><a class="anc" name="c142" href="#c142">[c142]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="c143" href="#c143">[c143]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_clearSpritesLoop">@_clearSpritesLoop</a></span></span><span class="ce">; If we're not done, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're out of the loop. Reset the PPU draw offset and restore
; screen state.
;
</div><span class="l"><a class="anc" name="c145" href="#c145">[c145]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CurrentSprite_ResetPPUTileOffset">CurrentSprite_ResetPPUTileOffset</a></span></span><span class="ce">; Reset the PPU offset.</span></span>
<span class="l"><a class="anc" name="c148" href="#c148">[c148]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="c14a" href="#c14a">[c14a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; Clear any portrait shown on screen.</span></span>
<span class="l"><a class="anc" name="c14d" href="#c14d">[c14d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_Mask">PPU_Mask</a></span></span><span class="ce">; Load the current screen color mode.</span></span>
<span class="l"><a class="anc" name="c14f" href="#c14f">[c14f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fe</span></span><span class="ce">; Set to color mode (clear bit 1)</span></span>
<span class="l"><a class="anc" name="c151" href="#c151">[c151]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_Mask">PPU_Mask</a></span></span><span class="ce">; Store the new color mode.</span></span>
<span class="l"><a class="anc" name="c153" href="#c153">[c153]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadAllScreenInfo"></a><div class="cp">;============================================================================
; Load extra information about the contents of the screen.
;
; This may include data such as sprite values, NPC IScript
; entrypoints, and special screen events (such as boss kill
; triggers).
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The area being loaded.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The screen being loaded within the area.
;
;     <a href="PRG11.html#AREA_SPRITE_ADDRESSES">AREA_SPRITE_ADDRESSES</a>:
;         The table of areas to screen lists.
;
; OUTPUTS:
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>:
;         The starting read address for the screen info.
;
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The screen's loaded special event ID (0xFF if
;         there is none).
;
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;         Used internally and clobbered.
;
; CALLS:
;     <a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a>
;
; XREFS:
;     <a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a>
;============================================================================
</div><span class="l"><a class="anc" name="c154" href="#c154">[c154]</a><a href="#Screen_LoadAllScreenInfo" class="la">Screen_LoadAllScreenInfo:</a><span class="ce">; [$c154]</span></span>
<div class="c">;
; Set the address of the sprites-for-screen lookup table
; for the area.
;
</div><span class="l"><a class="anc" name="c154" href="#c154">[c154]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; A = Current area index.</span></span>
<span class="l"><a class="anc" name="c156" href="#c156">[c156]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word offset for the lookup table.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the starting address of the screen data.
;
</div><span class="l"><a class="anc" name="c157" href="#c157">[c157]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="c158" href="#c158">[c158]</a><span class="cd"><span class="i">LDA</span> <span class="o">$8210,Y</span></span><span class="ce">; Load the upper byte of the address.</span></span>
<span class="l"><a class="anc" name="c15b" href="#c15b">[c15b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store for reading.</span></span>
<span class="l"><a class="anc" name="c15d" href="#c15d">[c15d]</a><span class="cd"><span class="i">LDA</span> <span class="o">$8211,Y</span></span><span class="ce">; Load the lower byte of thea ddress.</span></span>
<span class="l"><a class="anc" name="c160" href="#c160">[c160]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check the first byte of the address. If 0xFF,
; nothing will be loaded.
;
</div><span class="l"><a class="anc" name="c162" href="#c162">[c162]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$01</span></span><span class="ce">; Y = 1</span></span>
<span class="l"><a class="anc" name="c164" href="#c164">[c164]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the address for the screens list.</span></span>
<span class="l"><a class="anc" name="c166" href="#c166">[c166]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="c168" href="#c168">[c168]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_C1B3">RETURN_C1B3</a></span></span><span class="ce">; If so, there's nothing to load. Return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the start address for a screen's sprite and metadata
; information.
;
</div><span class="l"><a class="anc" name="c16a" href="#c16a">[c16a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; A = Current screen index.</span></span>
<span class="l"><a class="anc" name="c16c" href="#c16c">[c16c]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word offset for the lookup table.</span></span>
<span class="l"><a class="anc" name="c16d" href="#c16d">[c16d]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the address for the screen information.
;
</div><span class="l"><a class="anc" name="c16e" href="#c16e">[c16e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the lower byte of the screen address.</span></span>
<span class="l"><a class="anc" name="c170" href="#c170">[c170]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; Store it as the lower byte of the of the sprites read address.</span></span>
<span class="l"><a class="anc" name="c172" href="#c172">[c172]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c173" href="#c173">[c173]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="c175" href="#c175">[c175]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr_U">Sprites_ReadInfoAddr_U</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Find the end of the sprites list for the screen.
;
; Sprites are in 2-byte pairs of (Entity ID, Sprite Value).
; This will skip those bytes until the end of the list is
; hit.
;
</div><span class="l"><a class="anc" name="c177" href="#c177">[c177]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<a name=":c179:@_readLoop"></a><span class="l"><a class="anc" name="c179" href="#c179">[c179]</a><a href="#:c179:@_readLoop" class="lla">@_readLoop:</a><span class="ce">; [$c179]</span></span>
<span class="l"><a class="anc" name="c179" href="#c179">[c179]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte from the screen data.</span></span>
<span class="l"><a class="anc" name="c17b" href="#c17b">[c17b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="c17d" href="#c17d">[c17d]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextLoopIter">@_prepareNextLoopIter</a></span></span><span class="ce">; If not, jump to prepare for the next loop</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The sprite information is 0xFF, so we're done looping.
; Read the screen information.
;
</div><span class="l"><a class="anc" name="c17f" href="#c17f">[c17f]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c180" href="#c180">[c180]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="c181" href="#c181">[c181]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c182" href="#c182">[c182]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; Increment the read address by 2 bytes.</span></span>
<span class="l"><a class="anc" name="c184" href="#c184">[c184]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a></span></span></span>
<span class="l"><a class="anc" name="c186" href="#c186">[c186]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr_U">Sprites_ReadInfoAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="c188" href="#c188">[c188]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry, if lower byte overflowed.</span></span>
<span class="l"><a class="anc" name="c18a" href="#c18a">[c18a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr_U">Screen_ExtraInfoAddr_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"><a class="anc" name="c18c" href="#c18c">[c18c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a></span></span><span class="ce">; Read the extra screen information.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c18f:@_prepareNextLoopIter"></a><div class="c">;
; Increment by 2 (the sprite entity and value).
;
</div><span class="l"><a class="anc" name="c18f" href="#c18f">[c18f]</a><a href="#:c18f:@_prepareNextLoopIter" class="lla">@_prepareNextLoopIter:</a><span class="ce">; [$c18f]</span></span>
<span class="l"><a class="anc" name="c18f" href="#c18f">[c18f]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c190" href="#c190">[c190]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c191" href="#c191">[c191]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_readLoop">@_readLoop</a></span></span><span class="ce">; If Y &gt; 0, loop.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_SetNoSpecialEventID"></a><div class="cp">;============================================================================
; Clear the special event ID for the current screen.
;
; This disables any custom logic specific to certain screens.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         Set to 0xFF (unset).
;
; XREFS:
;     <a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a>
;============================================================================
</div><span class="l"><a class="anc" name="c193" href="#c193">[c193]</a><a href="#Screen_SetNoSpecialEventID" class="la">Screen_SetNoSpecialEventID:</a><span class="ce">; [$c193]</span></span>
<div class="c">;
; No special event information was found for the screen.
; Clear that state (set to 0xFF).
;
</div><span class="l"><a class="anc" name="c193" href="#c193">[c193]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="c195" href="#c195">[c195]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Clear the special event ID (0xFF).</span></span>
<span class="l"><a class="anc" name="c198" href="#c198">[c198]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadSpecialEventID"></a><div class="cp">;============================================================================
; Load extra information about the current screen.
;
; Screens may contain a special event ID, which adds custom
; logic to perform on each tick on a screen. This is used
; for three things:
;
; 1. Managing the pushable block status on the path to
;    Mascon.
; 2. Boss battle logic.
; 3. Final boss logic.
;
; INPUTS:
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>+1:
;         The address containing the extra screen
;         information.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The special event ID loaded from the screen info,
;         or 0xFF (unset) if not found.
;
; XREFS:
;     <a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a>
;============================================================================
</div><span class="l"><a class="anc" name="c199" href="#c199">[c199]</a><a href="#Screen_LoadSpecialEventID" class="la">Screen_LoadSpecialEventID:</a><span class="ce">; [$c199]</span></span>
<div class="c">;
; Begin scanning for a 0xFF in the screen information. This
; will indicate the start of extra information for the screen
; (special screen event states, IScripts entrypoint references).
;
</div><span class="l"><a class="anc" name="c199" href="#c199">[c199]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (loop counter)</span></span>
<span class="l"></span>
<a name=":c19b:@_scanLoop"></a><span class="l"><a class="anc" name="c19b" href="#c19b">[c19b]</a><a href="#:c19b:@_scanLoop" class="lla">@_scanLoop:</a><span class="ce">; [$c19b]</span></span>
<span class="l"><a class="anc" name="c19b" href="#c19b">[c19b]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte in the screen info data.</span></span>
<span class="l"><a class="anc" name="c19d" href="#c19d">[c19d]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="c19f" href="#c19f">[c19f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_noFFMarker">@_noFFMarker</a></span></span><span class="ce">; If so, we found the start of the extra data to load. Jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We found the start of the extra info for the screen. We're
; looking for 0x80, which indicates special event code will
; run on this screen every tick. The type of event will be
; indicated in the following byte.
;
; An example of this would be running code when a boss is
; defeated, producing an item.
;
</div><span class="l"><a class="anc" name="c1a1" href="#c1a1">[c1a1]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c1a2" href="#c1a2">[c1a2]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte to see what we're working with.</span></span>
<span class="l"><a class="anc" name="c1a4" href="#c1a4">[c1a4]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$80</span></span><span class="ce">; Is it 0x80?</span></span>
<span class="l"><a class="anc" name="c1a6" href="#c1a6">[c1a6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Screen_SetNoSpecialEventID">Screen_SetNoSpecialEventID</a></span></span><span class="ce">; If not, then we won't be running special event code on this screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This screen runs special event code. Load it.
;
</div><span class="l"><a class="anc" name="c1a8" href="#c1a8">[c1a8]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c1a9" href="#c1a9">[c1a9]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte containing the special event ID.</span></span>
<span class="l"><a class="anc" name="c1ab" href="#c1ab">[c1ab]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Store it while on the screen.</span></span>
<span class="l"><a class="anc" name="c1ae" href="#c1ae">[c1ae]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":c1af:@_noFFMarker"></a><span class="l"><a class="anc" name="c1af" href="#c1af">[c1af]</a><a href="#:c1af:@_noFFMarker" class="lla">@_noFFMarker:</a><span class="ce">; [$c1af]</span></span>
<span class="l"><a class="anc" name="c1af" href="#c1af">[c1af]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If we hit 256 loops, we're done.
;
</div><span class="l"><a class="anc" name="c1b0" href="#c1b0">[c1b0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_scanLoop">@_scanLoop</a></span></span><span class="ce">; If we haven't wrapped, then loop.</span></span>
<span class="l"><a class="anc" name="c1b2" href="#c1b2">[c1b2]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, we're done.</span></span>
<span class="l"></span>
<a name="RETURN_C1B3"></a><div class="c">;
; XREFS:
;     <a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a>
;
</div><span class="l"><a class="anc" name="c1b3" href="#c1b3">[c1b3]</a><a href="#RETURN_C1B3" class="la">RETURN_C1B3:</a><span class="ce">; [$c1b3]</span></span>
<span class="l"><a class="anc" name="c1b3" href="#c1b3">[c1b3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadSpriteInfo"></a><div class="cp">;============================================================================
; Load information on a sprite from the screens list.
;
; This will read the next sprite entity ID in the screen
; information, followed by the block X/Y position where
; the sprite should be placed.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>:
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>+1:
;         The address in the screens table to read from.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The loaded sprite entity ID.
;
;     <a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a>:
;         The loaded block X position of the sprite.
;
;     <a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a>:
;         The loaded block Y position of the sprite.
;
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>:
;     <a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>+1:
;         The updated address in the screens table to read
;         from.
;
; CALLS:
;     <a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a>
;     <a href="#Sprites_PopulateNextAvailableSprite">Sprites_PopulateNextAvailableSprite</a>
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Screen_SetupSprites">Screen_SetupSprites</a>
;============================================================================
</div><span class="l"><a class="anc" name="c1b4" href="#c1b4">[c1b4]</a><a href="#Screen_LoadSpriteInfo" class="la">Screen_LoadSpriteInfo:</a><span class="ce">; [$c1b4]</span></span>
<div class="c">;
; Switch to ROM bank 11, where sprite information lives.
;
</div><span class="l"><a class="anc" name="c1b4" href="#c1b4">[c1b4]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="c1b7" href="#c1b7">[c1b7]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="c1b8" href="#c1b8">[c1b8]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><a class="anc" name="c1ba" href="#c1ba">[c1ba]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load all the sprites for this screen.
;
</div><span class="l"><a class="anc" name="c1bd" href="#c1bd">[c1bd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadAllScreenInfo">Screen_LoadAllScreenInfo</a></span></span><span class="ce">; Load the sprite information for the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch bank to our previous bank.
;
</div><span class="l"><a class="anc" name="c1c0" href="#c1c0">[c1c0]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A (our saved bank).</span></span>
<span class="l"><a class="anc" name="c1c1" href="#c1c1">[c1c1]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="c1c2" href="#c1c2">[c1c2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c1c5:@_readSpriteLoop"></a><div class="c">;
; Begin our loop for reading all sprites for the screen.
;
</div><span class="l"><a class="anc" name="c1c5" href="#c1c5">[c1c5]</a><a href="#:c1c5:@_readSpriteLoop" class="lla">@_readSpriteLoop:</a><span class="ce">; [$c1c5]</span></span>
<span class="l"><a class="anc" name="c1c5" href="#c1c5">[c1c5]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y =  0 (info read offset)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to ROM bank 11 (sprite info).
;
</div><span class="l"><a class="anc" name="c1c7" href="#c1c7">[c1c7]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = current ROM bank</span></span>
<span class="l"><a class="anc" name="c1ca" href="#c1ca">[c1ca]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c1cb" href="#c1cb">[c1cb]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><a class="anc" name="c1cd" href="#c1cd">[c1cd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read information on the next sprite on the screen.
;
</div><span class="l"><a class="anc" name="c1d0" href="#c1d0">[c1d0]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Read the current byte of the screen information.</span></span>
<span class="l"><a class="anc" name="c1d2" href="#c1d2">[c1d2]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (our end-of-sprites list)?</span></span>
<span class="l"><a class="anc" name="c1d4" href="#c1d4">[c1d4]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; If it is, we're done. Restore our bank and return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store the sprite's entity ID.
;
</div><span class="l"><a class="anc" name="c1d6" href="#c1d6">[c1d6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store this byte as the sprite entity ID.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the sprite's Y block position.
;
; This will be the upper nibble of the byte following the
; sprite entity ID.
;
</div><span class="l"><a class="anc" name="c1d9" href="#c1d9">[c1d9]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c1da" href="#c1da">[c1da]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Load the next byte.</span></span>
<span class="l"><a class="anc" name="c1dc" href="#c1dc">[c1dc]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Take only the upper nibble.</span></span>
<span class="l"><a class="anc" name="c1de" href="#c1de">[c1de]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a></span></span><span class="ce">; Store it as the sprite's starting Y position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the sprite's X block position.
;
; This will be the lower nibble, which will then be placed
; in the upper nibble.
;
</div><span class="l"><a class="anc" name="c1e1" href="#c1e1">[c1e1]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a>),Y</span></span><span class="ce">; Load the same byte.</span></span>
<span class="l"><a class="anc" name="c1e3" href="#c1e3">[c1e3]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift the X coordinate from the lower nibble to the upper nibble.</span></span>
<span class="l"><a class="anc" name="c1e4" href="#c1e4">[c1e4]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c1e5" href="#c1e5">[c1e5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c1e6" href="#c1e6">[c1e6]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c1e7" href="#c1e7">[c1e7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a></span></span><span class="ce">; Store as the sprite's X position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore our bank.
;
</div><span class="l"><a class="anc" name="c1ea" href="#c1ea">[c1ea]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A (the saved bank) from the stack.</span></span>
<span class="l"><a class="anc" name="c1eb" href="#c1eb">[c1eb]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="c1ec" href="#c1ec">[c1ec]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Finish processing this sprite. We'll add to the next
; available slot and fill in any information needed based
; on what we loaded.
;
</div><span class="l"><a class="anc" name="c1ef" href="#c1ef">[c1ef]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_PopulateNextAvailableSprite">Sprites_PopulateNextAvailableSprite</a></span></span><span class="ce">; Add this sprite to the next available slot.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increment the read address for the next sprite in the
; screen data.
;
</div><span class="l"><a class="anc" name="c1f2" href="#c1f2">[c1f2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; A = lower byte of the screen information address</span></span>
<span class="l"><a class="anc" name="c1f4" href="#c1f4">[c1f4]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c1f5" href="#c1f5">[c1f5]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; Increment by 2 (sprite entity ID and position).</span></span>
<span class="l"><a class="anc" name="c1f7" href="#c1f7">[c1f7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr">Sprites_ReadInfoAddr</a></span></span><span class="ce">; Store as the new lower byte of the address.</span></span>
<span class="l"><a class="anc" name="c1f9" href="#c1f9">[c1f9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr_U">Sprites_ReadInfoAddr_U</a></span></span><span class="ce">; A = upper byte of the screen information address</span></span>
<span class="l"><a class="anc" name="c1fb" href="#c1fb">[c1fb]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry if the lower byte overflowed.</span></span>
<span class="l"><a class="anc" name="c1fd" href="#c1fd">[c1fd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_ReadInfoAddr_U">Sprites_ReadInfoAddr_U</a></span></span><span class="ce">; Store it as the new upper byte of the address.</span></span>
<span class="l"><a class="anc" name="c1ff" href="#c1ff">[c1ff]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_readSpriteLoop">@_readSpriteLoop</a></span></span><span class="ce">; Loop to read the next sprite.</span></span>
<span class="l"></span>
<a name=":c202:@_restoreBankAndReturn"></a><span class="l"><a class="anc" name="c202" href="#c202">[c202]</a><a href="#:c202:@_restoreBankAndReturn" class="lla">@_restoreBankAndReturn:</a><span class="ce">; [$c202]</span></span>
<span class="l"><a class="anc" name="c202" href="#c202">[c202]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_PopulateNextAvailableSprite"></a><div class="cp">;============================================================================
; Populate the loaded sprite in the next available slot.
;
; This will set the default state of the sprite, the
; sprite's HP, hitbox type, subtype, and behavior
; addresses.
;
; If the sprite can't fit on the screen, it will not be
; loaded.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The loaded sprite entity ID.
;
;     <a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a>:
;         The loaded block X position.
;
;     <a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a>:
;         The loaded block Y position.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The updated sprite entities.
;
;     <a href="RAM.html#CurrentSprites_Flags">CurrentSprites_Flags</a>:
;         The updated sprite flags.
;
;     <a href="RAM.html#CurrentSprites_Phases">CurrentSprites_Phases</a>:
;         The updated sprite phases.
;
;     <a href="RAM.html#CurrentSprites_HitByMagicBehavior">CurrentSprites_HitByMagicBehavior</a>:
;         The updated behaviors when hit by magic.
;
;     <a href="RAM.html#CurrentSprites_XPos_Full">CurrentSprites_XPos_Full</a>:
;         The updated sprite X positions.
;
;     <a href="RAM.html#CurrentSprites_YPos">CurrentSprites_YPos</a>:
;         The updated sprite Y positions.
;
;     <a href="RAM.html#CurrentSprites_HitBoxTypes">CurrentSprites_HitBoxTypes</a>:
;         The updated sprite hit box types.
;
;     <a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>:
;         The updated sprite HPs.
;
;     <a href="RAM.html#CurrentSprites_BehaviorAddrs_L">CurrentSprites_BehaviorAddrs_L</a>:
;         The updated sprite behavior address lower bytes.
;
;     <a href="RAM.html#CurrentSprites_BehaviorAddrs_U">CurrentSprites_BehaviorAddrs_U</a>:
;         The updated sprite behavior address upper bytes.
;
;     <a href="RAM.html#CurrentSprites_Behaviors">CurrentSprites_Behaviors</a>:
;         The updated sprite subtypes.
;
; CALLS:
;     <a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a>
;
; XREFS:
;     <a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a>
;============================================================================
</div><span class="l"><a class="anc" name="c205" href="#c205">[c205]</a><a href="#Sprites_PopulateNextAvailableSprite" class="la">Sprites_PopulateNextAvailableSprite:</a><span class="ce">; [$c205]</span></span>
<div class="c">;
; Prepare the sprite loop.
;
</div><span class="l"><a class="anc" name="c205" href="#c205">[c205]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; 7 = loop counter</span></span>
<span class="l"></span>
<a name=":c207:@_loop"></a><span class="l"><a class="anc" name="c207" href="#c207">[c207]</a><a href="#:c207:@_loop" class="lla">@_loop:</a><span class="ce">; [$c207]</span></span>
<span class="l"><a class="anc" name="c207" href="#c207">[c207]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; Set it</span></span>
<span class="l"><a class="anc" name="c20a" href="#c20a">[c20a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Load the sprite entity at this index.</span></span>
<span class="l"><a class="anc" name="c20d" href="#c20d">[c20d]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (unset)?</span></span>
<span class="l"><a class="anc" name="c20f" href="#c20f">[c20f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextIter">@_prepareNextIter</a></span></span><span class="ce">; If not, jump to prepare for next loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This sprite index is unset. Populate it.
;
</div><span class="l"><a class="anc" name="c211" href="#c211">[c211]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; 0 = unset</span></span>
<span class="l"><a class="anc" name="c213" href="#c213">[c213]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Phases">CurrentSprites_Phases</a>,X</span></span><span class="ce">; Clear the sprite phase.</span></span>
<span class="l"><a class="anc" name="c216" href="#c216">[c216]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Flags">CurrentSprites_Flags</a>,X</span></span><span class="ce">; Clear the sprite flags.</span></span>
<span class="l"><a class="anc" name="c219" href="#c219">[c219]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; 0xFF = unset</span></span>
<span class="l"><a class="anc" name="c21b" href="#c21b">[c21b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HitByMagicBehavior">CurrentSprites_HitByMagicBehavior</a>,X</span></span><span class="ce">; Clear the hit by magic behavior.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the sprite's starting X/Y position.
;
</div><span class="l"><a class="anc" name="c21e" href="#c21e">[c21e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_XPos">CurrentSprite_XPos</a></span></span><span class="ce">; Load the current sprite X position to set.</span></span>
<span class="l"><a class="anc" name="c221" href="#c221">[c221]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_XPos_Full">CurrentSprites_XPos_Full</a>,X</span></span><span class="ce">; Set for the sprite index.</span></span>
<span class="l"><a class="anc" name="c223" href="#c223">[c223]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_YPos">CurrentSprite_YPos</a></span></span><span class="ce">; Load the Y position.</span></span>
<span class="l"><a class="anc" name="c226" href="#c226">[c226]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_YPos">CurrentSprites_YPos</a>,X</span></span><span class="ce">; Set for the sprite index.</span></span>
<span class="l"><a class="anc" name="c228" href="#c228">[c228]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the sprite entity.</span></span>
<span class="l"><a class="anc" name="c22b" href="#c22b">[c22b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="c22e" href="#c22e">[c22e]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (entity)</span></span>
<span class="l"><a class="anc" name="c22f" href="#c22f">[c22f]</a><span class="cd"><span class="i">LDA</span> <span class="o">$b4df,Y</span></span><span class="ce">; Load the hitbox type for the entity.</span></span>
<span class="l"><a class="anc" name="c232" href="#c232">[c232]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HitBoxTypes">CurrentSprites_HitBoxTypes</a>,X</span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="c235" href="#c235">[c235]</a><span class="cd"><span class="i">LDA</span> <span class="o">$b5a9,Y</span></span><span class="ce">; Load the HP for the entity.</span></span>
<span class="l"><a class="anc" name="c238" href="#c238">[c238]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_HP">CurrentSprites_HP</a>,X</span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare the behavior scripts for the entity.
;
</div><span class="l"><a class="anc" name="c23b" href="#c23b">[c23b]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (entity)</span></span>
<span class="l"><a class="anc" name="c23c" href="#c23c">[c23c]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary.</span></span>
<span class="l"><a class="anc" name="c23d" href="#c23d">[c23d]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="c23e" href="#c23e">[c23e]</a><span class="cd"><span class="i">LDA</span> <span class="o">$ad2d,Y</span></span><span class="ce">; Load the lower byte of the behavior script for the entity.</span></span>
<span class="l"><a class="anc" name="c241" href="#c241">[c241]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_BehaviorAddrs_L">CurrentSprites_BehaviorAddrs_L</a>,X</span></span><span class="ce">; Set the lower byte of the address.</span></span>
<span class="l"><a class="anc" name="c244" href="#c244">[c244]</a><span class="cd"><span class="i">LDA</span> <span class="o">$ad2e,Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="c247" href="#c247">[c247]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_BehaviorAddrs_U">CurrentSprites_BehaviorAddrs_U</a>,X</span></span><span class="ce">; Set the upper byte.</span></span>
<span class="l"><a class="anc" name="c24a" href="#c24a">[c24a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; A = 0xFF (unset)</span></span>
<span class="l"><a class="anc" name="c24c" href="#c24c">[c24c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Behaviors">CurrentSprites_Behaviors</a>,X</span></span><span class="ce">; Clear the current behavior state.</span></span>
<span class="l"><a class="anc" name="c24f" href="#c24f">[c24f]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a></span></span><span class="ce">; Load the value for the sprite and return.</span></span>
<span class="l"></span>
<a name=":c252:@_prepareNextIter"></a><span class="l"><a class="anc" name="c252" href="#c252">[c252]</a><a href="#:c252:@_prepareNextIter" class="lla">@_prepareNextIter:</a><span class="ce">; [$c252]</span></span>
<span class="l"><a class="anc" name="c252" href="#c252">[c252]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index.</span></span>
<span class="l"><a class="anc" name="c255" href="#c255">[c255]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="c256" href="#c256">[c256]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"><a class="anc" name="c258" href="#c258">[c258]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SPRITE_IMAGE_BANKS"></a><div class="cp">;============================================================================
; Banks storing the images for a range of sprites.
;
; XREFS:
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;
</div><span class="l"><a class="anc" name="c259" href="#c259">[c259]</a><a href="#SPRITE_IMAGE_BANKS" class="la">SPRITE_IMAGE_BANKS:</a><span class="ce">; [$c259]</span></span>
<span class="l"><a class="anc" name="c259" href="#c259">[c259]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [0]: Bank for sprites 0-54</span></span>
<span class="l"></span>
<a name="SPRITE_IMAGE_BANKS_1_"></a><div class="c">;
; XREFS:
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;
</div><span class="l"><a class="anc" name="c25a" href="#c25a">[c25a]</a><a href="#SPRITE_IMAGE_BANKS_1_" class="la">SPRITE_IMAGE_BANKS_1_:</a><span class="ce">; [$c25a]</span></span>
<span class="l"><a class="anc" name="c25a" href="#c25a">[c25a]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [1]: Bank for sprites 55-100</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_LoadSpriteValue"></a><div class="cp">;============================================================================
; Load the value for a sprite from the screen's sprite info table.
;
; This loads the value information associated with a sprite
; on the screen. This may represent a message ID or some
; other value, depending on the sprite and situation.
;
; INPUTS:
;     X:
;         The sprite index to load the value for,
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The currently-loaded ROM bank.
;
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>+1:
;         The current address for the extra sprite values
;         on the screen.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Values">CurrentSprites_Values</a>:
;         The updated sprite values.
;
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>:
;     <a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>+1:
;         The incremented address for the extra sprite
;         values on the screen.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;
; XREFS:
;     <a href="#Sprites_PopulateNextAvailableSprite">Sprites_PopulateNextAvailableSprite</a>
;============================================================================
</div><span class="l"><a class="anc" name="c25b" href="#c25b">[c25b]</a><a href="#Sprites_LoadSpriteValue" class="la">Sprites_LoadSpriteValue:</a><span class="ce">; [$c25b]</span></span>
<span class="l"><a class="anc" name="c25b" href="#c25b">[c25b]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X (sprite index)</span></span>
<span class="l"><a class="anc" name="c25c" href="#c25c">[c25c]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current ROM bank and switch to bank 11.
;
</div><span class="l"><a class="anc" name="c25d" href="#c25d">[c25d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Get the current ROM bank.</span></span>
<span class="l"><a class="anc" name="c260" href="#c260">[c260]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c261" href="#c261">[c261]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0b</span></span><span class="ce">; X = 11 (bank)</span></span>
<span class="l"><a class="anc" name="c263" href="#c263">[c263]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore our sprite index to X so it's not clobbered
; when this returns.
;
</div><span class="l"><a class="anc" name="c266" href="#c266">[c266]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="c267" href="#c267">[c267]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the extra information for this sprite and store it
; in the sprite list.
;
</div><span class="l"><a class="anc" name="c268" href="#c268">[c268]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="c26a" href="#c26a">[c26a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a>),Y</span></span><span class="ce">; A = Extra information for the sprite.</span></span>
<span class="l"><a class="anc" name="c26c" href="#c26c">[c26c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Values">CurrentSprites_Values</a>,X</span></span><span class="ce">; Store in <a href="RAM.html#CurrentSprites_Values">CurrentSprites_Values</a>.</span></span>
<span class="l"><a class="anc" name="c26f" href="#c26f">[c26f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (unset)?</span></span>
<span class="l"><a class="anc" name="c271" href="#c271">[c271]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; If so, we're done. Jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increment the position in the info data.
;
</div><span class="l"><a class="anc" name="c273" href="#c273">[c273]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr">Screen_ExtraInfoAddr</a></span></span><span class="ce">; Increment the lower byte of the offset in the extra info data.</span></span>
<span class="l"><a class="anc" name="c275" href="#c275">[c275]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; If this didn't wrap to 0, we're done. Jump.</span></span>
<span class="l"><a class="anc" name="c277" href="#c277">[c277]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ExtraInfoAddr_U">Screen_ExtraInfoAddr_U</a></span></span><span class="ce">; Else, increment the upper byte as well.</span></span>
<span class="l"></span>
<a name=":c279:@_restoreBankAndReturn"></a><span class="l"><a class="anc" name="c279" href="#c279">[c279]</a><a href="#:c279:@_restoreBankAndReturn" class="lla">@_restoreBankAndReturn:</a><span class="ce">; [$c279]</span></span>
<span class="l"><a class="anc" name="c279" href="#c279">[c279]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore the bank saved to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_StoreBankForCurrentSprite"></a><div class="cp">;============================================================================
; Determine and store the bank for images for the current sprite.
;
; This will determine which bank would store images for the
; currently-processed sprite.
;
; If the sprite entity ID is 0-54, this will be bank 6.
;
; If the sprite entity ID is 55-100, this will be bank 7.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The entity ID for the currently-processed sprite.
;
;     <a href="#SPRITE_IMAGE_BANKS">SPRITE_IMAGE_BANKS</a>:
;         The lookup table for sprite entity IDs to banks.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_TilesBank">CurrentSprite_TilesBank</a>:
;         The bank for the images for this sprite.
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;============================================================================
</div><span class="l"><a class="anc" name="c27c" href="#c27c">[c27c]</a><a href="#Sprites_StoreBankForCurrentSprite" class="la">Sprites_StoreBankForCurrentSprite:</a><span class="ce">; [$c27c]</span></span>
<span class="l"><a class="anc" name="c27c" href="#c27c">[c27c]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="c27e" href="#c27e">[c27e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; A = current sprite entity</span></span>
<span class="l"><a class="anc" name="c281" href="#c281">[c281]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$37</span></span><span class="ce">; Is it &lt; sprite 55 (Unused Child sprite)?</span></span>
<span class="l"><a class="anc" name="c283" href="#c283">[c283]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loadBank">@_loadBank</a></span></span><span class="ce">; If yes, then load bank from table at index 0.</span></span>
<span class="l"><a class="anc" name="c285" href="#c285">[c285]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Else, load bank from table at index 1.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c286:@_loadBank"></a><div class="c">;
; Load the image for the bank.
;
</div><span class="l"><a class="anc" name="c286" href="#c286">[c286]</a><a href="#:c286:@_loadBank" class="lla">@_loadBank:</a><span class="ce">; [$c286]</span></span>
<span class="l"><a class="anc" name="c286" href="#c286">[c286]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SPRITE_IMAGE_BANKS">SPRITE_IMAGE_BANKS</a>,Y</span></span><span class="ce">; Load the address for the sprite entity.</span></span>
<span class="l"><a class="anc" name="c289" href="#c289">[c289]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_TilesBank">CurrentSprite_TilesBank</a></span></span><span class="ce">; Store as the bank for this sprite.</span></span>
<span class="l"></span>
<a name=":c28c:@_return"></a><span class="l"><a class="anc" name="c28c" href="#c28c">[c28c]</a><a href="#:c28c:@_return" class="lla">@_return:</a><span class="ce">; [$c28c]</span></span>
<span class="l"><a class="anc" name="c28c" href="#c28c">[c28c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_LoadSpriteImages"></a><div class="cp">;============================================================================
; Load images for all sprites on the scren.
;
; This will loop through each sprite and load the images,
; drawing them in the PPU buffer.
;
; If any sprites become off-screen (vertically), they'll be
; removed.
;
; As a special case, if the sprite is the boss Pakukame, a
; Lilith will be spawned.
;
; INPUTS:
;     <a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a>:
;         The current sprite index at the start of this
;         call.
;
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The list of sprite entities for all sprites on
;         screen.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         Updated if sprites are removed or added.
;
;     <a href="RAM.html#CurrentSprites_PPUOffsets">CurrentSprites_PPUOffsets</a>:
;         PPU tile offsets for sprite data.
;
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#CurrentSprite_ResetPPUTileOffset">CurrentSprite_ResetPPUTileOffset</a>
;     <a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a>
;     <a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a>
;     <a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;     <a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a>
;     <a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a>
;     <a href="#Game_SetupNewArea">Game_SetupNewArea</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#IScripts_ClearPortraitImage">IScripts_ClearPortraitImage</a>
;============================================================================
</div><span class="l"><a class="anc" name="c28d" href="#c28d">[c28d]</a><a href="#GameLoop_LoadSpriteImages" class="la">GameLoop_LoadSpriteImages:</a><span class="ce">; [$c28d]</span></span>
<div class="c">;
; Save state and prepare for image loading.
;
</div><span class="l"><a class="anc" name="c28d" href="#c28d">[c28d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; A = current sprite index</span></span>
<span class="l"><a class="anc" name="c290" href="#c290">[c290]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="c291" href="#c291">[c291]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CurrentSprite_ResetPPUTileOffset">CurrentSprite_ResetPPUTileOffset</a></span></span><span class="ce">; Reset the PPU drawing coordinates.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin our loop for all 7 sprite slots.
;
</div><span class="l"><a class="anc" name="c294" href="#c294">[c294]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; X = 7 (sprite index counter)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c296:@_loop"></a><div class="c">;
; Set this as the currently-processed sprite, and update
; the entity.
;
; We'll only process if the entity is not unset.
;
</div><span class="l"><a class="anc" name="c296" href="#c296">[c296]</a><a href="#:c296:@_loop" class="lla">@_loop:</a><span class="ce">; [$c296]</span></span>
<span class="l"><a class="anc" name="c296" href="#c296">[c296]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; Store it as the currently-processed sprite index.</span></span>
<span class="l"><a class="anc" name="c299" href="#c299">[c299]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Load the associated sprite entity ID.</span></span>
<span class="l"><a class="anc" name="c29c" href="#c29c">[c29c]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (unset)?</span></span>
<span class="l"><a class="anc" name="c29e" href="#c29e">[c29e]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_nextLoop">@_nextLoop</a></span></span><span class="ce">; If so, jump and prepare for the next loop.</span></span>
<span class="l"><a class="anc" name="c2a0" href="#c2a0">[c2a0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store this as the entity at this index.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the image for this sprite.
;
</div><span class="l"><a class="anc" name="c2a3" href="#c2a3">[c2a3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a></span></span><span class="ce">; Store the image bank for the current sprite.</span></span>
<span class="l"><a class="anc" name="c2a6" href="#c2a6">[c2a6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a></span></span><span class="ce">; Load the sprite's image from the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Special-case the Pakukame boss. If that was placed, then
; replace it with a Lilith instead. They spawn Liliths.
;
</div><span class="l"><a class="anc" name="c2a9" href="#c2a9">[c2a9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the current entity.</span></span>
<span class="l"><a class="anc" name="c2ac" href="#c2ac">[c2ac]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$30</span></span><span class="ce">; Is it the Pakukame boss?</span></span>
<span class="l"><a class="anc" name="c2ae" href="#c2ae">[c2ae]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadSpriteInfo">@_loadSpriteInfo</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This is the Pakukame. Swap in a Lilith and load the image.
;
; This will then restore the entity back to Pakukame.
; Effectively, each Lilith on screen seems to be backed by
; a Pakukame.
;
</div><span class="l"><a class="anc" name="c2b0" href="#c2b0">[c2b0]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the Pakukame entity ID</span></span>
<span class="l"><a class="anc" name="c2b3" href="#c2b3">[c2b3]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c2b4" href="#c2b4">[c2b4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_StartPPUTileOffset">CurrentSprite_StartPPUTileOffset</a></span></span><span class="ce">; Load the sprite's starting PPU tile offset.</span></span>
<span class="l"><a class="anc" name="c2b6" href="#c2b6">[c2b6]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="c2b7" href="#c2b7">[c2b7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$09</span></span><span class="ce">; A = 9 (Lilith)</span></span>
<span class="l"><a class="anc" name="c2b9" href="#c2b9">[c2b9]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store as the new entity.</span></span>
<span class="l"><a class="anc" name="c2bc" href="#c2bc">[c2bc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_StoreBankForCurrentSprite">Sprites_StoreBankForCurrentSprite</a></span></span><span class="ce">; Store the bank for Lilith.</span></span>
<span class="l"><a class="anc" name="c2bf" href="#c2bf">[c2bf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a></span></span><span class="ce">; Load Lilth's image from the bank.</span></span>
<span class="l"><a class="anc" name="c2c2" href="#c2c2">[c2c2]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the PPU offset row.</span></span>
<span class="l"><a class="anc" name="c2c3" href="#c2c3">[c2c3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_StartPPUTileOffset">CurrentSprite_StartPPUTileOffset</a></span></span><span class="ce">; Store it again.</span></span>
<span class="l"><a class="anc" name="c2c5" href="#c2c5">[c2c5]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the current sprite entity.</span></span>
<span class="l"><a class="anc" name="c2c6" href="#c2c6">[c2c6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Store it again.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c2c9:@_loadSpriteInfo"></a><div class="c">;
; Store the starting PPU tile offset for the sprite.
;
; This will be stored in this sprite's slot in the current
; sprites information.
;
</div><span class="l"><a class="anc" name="c2c9" href="#c2c9">[c2c9]</a><a href="#:c2c9:@_loadSpriteInfo" class="lla">@_loadSpriteInfo:</a><span class="ce">; [$c2c9]</span></span>
<span class="l"><a class="anc" name="c2c9" href="#c2c9">[c2c9]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index</span></span>
<span class="l"><a class="anc" name="c2cc" href="#c2cc">[c2cc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_StartPPUTileOffset">CurrentSprite_StartPPUTileOffset</a></span></span><span class="ce">; A = Start PPU tile offset</span></span>
<span class="l"><a class="anc" name="c2ce" href="#c2ce">[c2ce]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_PPUOffsets">CurrentSprites_PPUOffsets</a>,X</span></span><span class="ce">; Set this in the PPU tile offsets for this sprite.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the sprite is on-screen or off-screen.
;
; If the Y position is off the screen (row 30 or higher),
; then the sprite will be unset.
;
</div><span class="l"><a class="anc" name="c2d1" href="#c2d1">[c2d1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_YPos">CurrentSprites_YPos</a>,X</span></span><span class="ce">; Load the Y position for this sprite.</span></span>
<span class="l"><a class="anc" name="c2d3" href="#c2d3">[c2d3]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$f0</span></span><span class="ce">; Is it less than 0xF0?</span></span>
<span class="l"><a class="anc" name="c2d5" href="#c2d5">[c2d5]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_nextLoop">@_nextLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; It's off-screen. Unset it.
;
</div><span class="l"><a class="anc" name="c2d7" href="#c2d7">[c2d7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; Else, it's off the screen.</span></span>
<span class="l"><a class="anc" name="c2d9" href="#c2d9">[c2d9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Unset the entity.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c2dc:@_nextLoop"></a><div class="c">;
; Done with any loading required for the sprite. Prepare for
; the next loop, if needed.
;
</div><span class="l"><a class="anc" name="c2dc" href="#c2dc">[c2dc]</a><a href="#:c2dc:@_nextLoop" class="lla">@_nextLoop:</a><span class="ce">; [$c2dc]</span></span>
<span class="l"><a class="anc" name="c2dc" href="#c2dc">[c2dc]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index (loop counter).</span></span>
<span class="l"><a class="anc" name="c2df" href="#c2df">[c2df]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="c2e0" href="#c2e0">[c2e0]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're done. Restore the original current sprite index and
; wait until everything's drawn to the screen.
;
</div><span class="l"><a class="anc" name="c2e2" href="#c2e2">[c2e2]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A (current sprite index) from the stack.</span></span>
<span class="l"><a class="anc" name="c2e3" href="#c2e3">[c2e3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; Store that back as the current sprite index.</span></span>
<span class="l"><a class="anc" name="c2e6" href="#c2e6">[c2e6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a></span></span><span class="ce">; Wait until everything's drawn to the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_RunUpdateSpellHandler"></a><div class="cp">;============================================================================
; Update a magic spell and run a magic-dependent handler.
;
; This is called for every tick of a magic spell. It's put
; on the stack by <a href="PRG14.html#CastMagic_RunSpellHandler">CastMagic_RunSpellHandler</a>.
;
; This will update the visibility of the magic, set
; X/Y positions factoring in the screen scroll, and
; then set some state that ultimately is not used by
; the production build of Faxanadu.
;
; It will then call a magic-dependent update handler.
;
; INPUTS:
;     <a href="RAM.html#CastMagic_Type">CastMagic_Type</a>:
;         The magic type that was cast.
;
;     <a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a>:
;         The X position of the magic.
;
;     <a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a>:
;         The Y position of the magic.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;     <a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a>:
;         Referenced but ultimately unused.
;
; OUTPUTS:
;     <a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a>:
;     <a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a>:
;         X and Y coordinates for the magic, used
;         for appearance management.
;
;     <a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a>:
;     <a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a>:
;         Set but unused.
;
; CALLS:
;     <a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a>
;============================================================================
</div><span class="l"><a class="anc" name="c2e9" href="#c2e9">[c2e9]</a><a href="#CastMagic_RunUpdateSpellHandler" class="la">CastMagic_RunUpdateSpellHandler:</a><span class="ce">; [$c2e9]</span></span>
<div class="c">;
; These two lines are deadcode. It might be the developers
; attempting to hard-code Deluge and Thunder during testing?
; Each gets overriden immediately.
;
</div><span class="l"><a class="anc" name="c2e9" href="#c2e9">[c2e9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (deadcode)</span></span>
<span class="l"><a class="anc" name="c2eb" href="#c2eb">[c2eb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; A = 1 (deadcode)</span></span>
<span class="l"><a class="anc" name="c2ed" href="#c2ed">[c2ed]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span><span class="ce">; A = Cast magic type</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If 0xFF, return.
;
</div><span class="l"><a class="anc" name="c2f0" href="#c2f0">[c2f0]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This was an active, cast magic spell. Set state.
;
</div><span class="l"><a class="anc" name="c2f2" href="#c2f2">[c2f2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a></span></span><span class="ce">; Calculate visibility for the magic spell based on foreground elements.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Manage the X position of the spell.
;
</div><span class="l"><a class="anc" name="c2f5" href="#c2f5">[c2f5]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a></span></span><span class="ce">; Load the magic's X position.</span></span>
<span class="l"><a class="anc" name="c2f8" href="#c2f8">[c2f8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span><span class="ce">; Set as an argument for future appearance updates.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set some unused state not used in the finished game.
;
</div><span class="l"><a class="anc" name="c2fa" href="#c2fa">[c2fa]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><a class="anc" name="c2fc" href="#c2fc">[c2fc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Manage the Y position of the spell.
;
</div><span class="l"><a class="anc" name="c2fe" href="#c2fe">[c2fe]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span></span>
<span class="l"><a class="anc" name="c301" href="#c301">[c301]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span><span class="ce">; Set as an argument for future appearance updates.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set more unused state not used in the finished game.
;
</div><span class="l"><a class="anc" name="c303" href="#c303">[c303]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="c305" href="#c305">[c305]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the finish handler for this type as the next function
; to run.
;
</div><span class="l"><a class="anc" name="c307" href="#c307">[c307]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span><span class="ce">; Load the magic type.</span></span>
<span class="l"><a class="anc" name="c30a" href="#c30a">[c30a]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary for the lookup table.</span></span>
<span class="l"><a class="anc" name="c30b" href="#c30b">[c30b]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="c30c" href="#c30c">[c30c]</a><span class="cd"><span class="i">LDA</span> <span class="o">$bb28,Y</span></span><span class="ce">; Load the lower byte of the finish handler.</span></span>
<span class="l"><a class="anc" name="c30f" href="#c30f">[c30f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c310" href="#c310">[c310]</a><span class="cd"><span class="i">LDA</span> <span class="o">$bb27,Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="c313" href="#c313">[c313]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push.</span></span>
<span class="l"></span>
<a name=":c314:@_return"></a><span class="l"><a class="anc" name="c314" href="#c314">[c314]</a><a href="#:c314:@_return" class="lla">@_return:</a><span class="ce">; [$c314]</span></span>
<span class="l"><a class="anc" name="c314" href="#c314">[c314]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Return and then call the function.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_CalculateVisibility"></a><div class="cp">;============================================================================
; Calculate the visibility of the cast magic.
;
; This will check the cast magic against any foreground
; blocks, checking if it's fully visible, partially
; obscured, or fully obscured.
;
; INPUTS:
;     <a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a>:
;         The X pixel position of the magic.
;
;     <a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a>:
;         The Y pixel position of the magic.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a>:
;         The visibility state of the cast magic.
;
;     <a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a>:
;         The visibility state of the cast magic.
;
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a>
;     <a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a>
;
; XREFS:
;     <a href="#CastMagic_RunUpdateSpellHandler">CastMagic_RunUpdateSpellHandler</a>
;============================================================================
</div><span class="l"><a class="anc" name="c315" href="#c315">[c315]</a><a href="#CastMagic_CalculateVisibility" class="la">CastMagic_CalculateVisibility:</a><span class="ce">; [$c315]</span></span>
<div class="c">;
; Set the default to visible.
;
</div><span class="l"><a class="anc" name="c315" href="#c315">[c315]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c317" href="#c317">[c317]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Set the default visibility to visible.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Convert the cast magic's position to block positions.
;
</div><span class="l"><a class="anc" name="c319" href="#c319">[c319]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span><span class="ce">; Load the magic's Y position.</span></span>
<span class="l"><a class="anc" name="c31c" href="#c31c">[c31c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Set it as an argument for getting the block property.</span></span>
<span class="l"><a class="anc" name="c31e" href="#c31e">[c31e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a></span></span><span class="ce">; Load the magic's X position.</span></span>
<span class="l"><a class="anc" name="c321" href="#c321">[c321]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c322" href="#c322">[c322]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4 to that to better check block alignment.</span></span>
<span class="l"><a class="anc" name="c324" href="#c324">[c324]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Set it as an argument.</span></span>
<span class="l"><a class="anc" name="c326" href="#c326">[c326]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert to a block position.</span></span>
<span class="l"><a class="anc" name="c329" href="#c329">[c329]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span><span class="ce">; Get the block property for this position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if a block overlaps the left.
;
</div><span class="l"><a class="anc" name="c32c" href="#c32c">[c32c]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this block type 4?</span></span>
<span class="l"><a class="anc" name="c32e" href="#c32e">[c32e]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_leftIsObscured">@_leftIsObscured</a></span></span><span class="ce">; If so, the left is obscured.</span></span>
<span class="l"><a class="anc" name="c330" href="#c330">[c330]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0d</span></span><span class="ce">; Else, is this block type 13?</span></span>
<span class="l"><a class="anc" name="c332" href="#c332">[c332]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_leftIsObscured">@_leftIsObscured</a></span></span><span class="ce">; If so, the left is obscured.</span></span>
<span class="l"><a class="anc" name="c334" href="#c334">[c334]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$09</span></span><span class="ce">; Else, is this block type 9?</span></span>
<span class="l"><a class="anc" name="c336" href="#c336">[c336]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkRightObscured">@_checkRightObscured</a></span></span><span class="ce">; If not, the left is not obscured. Start checking the right.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c338:@_leftIsObscured"></a><div class="c">;
; This is a foreground layer block. The trailing part
; is obscured.
;
</div><span class="l"><a class="anc" name="c338" href="#c338">[c338]</a><a href="#:c338:@_leftIsObscured" class="lla">@_leftIsObscured:</a><span class="ce">; [$c338]</span></span>
<span class="l"><a class="anc" name="c338" href="#c338">[c338]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Load the cast magic's visibility state.</span></span>
<span class="l"><a class="anc" name="c33a" href="#c33a">[c33a]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$01</span></span><span class="ce">; Mark the left-hand side as obscured.</span></span>
<span class="l"><a class="anc" name="c33c" href="#c33c">[c33c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c33e:@_checkRightObscured"></a><div class="c">;
; Now check the right-hand side of the magic.
;
</div><span class="l"><a class="anc" name="c33e" href="#c33e">[c33e]</a><a href="#:c33e:@_checkRightObscured" class="lla">@_checkRightObscured:</a><span class="ce">; [$c33e]</span></span>
<span class="l"><a class="anc" name="c33e" href="#c33e">[c33e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Load the pixel X position.</span></span>
<span class="l"><a class="anc" name="c340" href="#c340">[c340]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c341" href="#c341">[c341]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$08</span></span><span class="ce">; Add 8 to it, to better check the right side.</span></span>
<span class="l"><a class="anc" name="c343" href="#c343">[c343]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the new pixel argument.</span></span>
<span class="l"><a class="anc" name="c345" href="#c345">[c345]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert to a block position.</span></span>
<span class="l"><a class="anc" name="c348" href="#c348">[c348]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if a block overlaps the right.
;
</div><span class="l"><a class="anc" name="c34b" href="#c34b">[c34b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this block 4?</span></span>
<span class="l"><a class="anc" name="c34d" href="#c34d">[c34d]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkNeedToFlipBits">@_checkNeedToFlipBits</a></span></span><span class="ce">; If not, it's not obscured.</span></span>
<span class="l"><a class="anc" name="c34f" href="#c34f">[c34f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Again, is this block 4?</span></span>
<span class="l"><a class="anc" name="c351" href="#c351">[c351]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_rightIsObscured">@_rightIsObscured</a></span></span><span class="ce">; If so, the right is obscured.</span></span>
<span class="l"><a class="anc" name="c353" href="#c353">[c353]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0d</span></span><span class="ce">; Else, is this block 13?</span></span>
<span class="l"><a class="anc" name="c355" href="#c355">[c355]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_rightIsObscured">@_rightIsObscured</a></span></span><span class="ce">; If so, the right is obscured.</span></span>
<span class="l"><a class="anc" name="c357" href="#c357">[c357]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$09</span></span><span class="ce">; Else, is this block 9?</span></span>
<span class="l"><a class="anc" name="c359" href="#c359">[c359]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkNeedToFlipBits">@_checkNeedToFlipBits</a></span></span><span class="ce">; If not, it's not obscured. Move to the next step.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c35b:@_rightIsObscured"></a><div class="c">;
; The trailing side of the magic is obscured.
;
</div><span class="l"><a class="anc" name="c35b" href="#c35b">[c35b]</a><a href="#:c35b:@_rightIsObscured" class="lla">@_rightIsObscured:</a><span class="ce">; [$c35b]</span></span>
<span class="l"><a class="anc" name="c35b" href="#c35b">[c35b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Load the cast magic's visibility state.</span></span>
<span class="l"><a class="anc" name="c35d" href="#c35d">[c35d]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$02</span></span><span class="ce">; Mark the right-hand side as obscured.</span></span>
<span class="l"><a class="anc" name="c35f" href="#c35f">[c35f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c361:@_checkNeedToFlipBits"></a><div class="c">;
; Check if the magic is partially-obscured (just left or
; right). If so, make sure the flips are flipped for the
; facing direction.
;
</div><span class="l"><a class="anc" name="c361" href="#c361">[c361]</a><a href="#:c361:@_checkNeedToFlipBits" class="lla">@_checkNeedToFlipBits:</a><span class="ce">; [$c361]</span></span>
<span class="l"><a class="anc" name="c361" href="#c361">[c361]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index.</span></span>
<span class="l"><a class="anc" name="c364" href="#c364">[c364]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Flags">CastMagic_Flags</a></span></span><span class="ce">; A = cast magic flags.</span></span>
<span class="l"><a class="anc" name="c367" href="#c367">[c367]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is it facing right?</span></span>
<span class="l"><a class="anc" name="c369" href="#c369">[c369]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_facingRight">@_facingRight</a></span></span><span class="ce">; If so, there's nothing to do. We're done.</span></span>
<span class="l"><a class="anc" name="c36b" href="#c36b">[c36b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; A = cast magic visibility</span></span>
<span class="l"><a class="anc" name="c36d" href="#c36d">[c36d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_storeVisibility">@_storeVisibility</a></span></span><span class="ce">; If the block is fully visible, jump.</span></span>
<span class="l"><a class="anc" name="c36f" href="#c36f">[c36f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Else, is it full obscured?</span></span>
<span class="l"><a class="anc" name="c371" href="#c371">[c371]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_storeVisibility">@_storeVisibility</a></span></span><span class="ce">; If yes, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Swap the bits to face the other direction.
;
</div><span class="l"><a class="anc" name="c373" href="#c373">[c373]</a><span class="cd"><span class="i">EOR</span> <span class="o">#$03</span></span><span class="ce">; Swap the visibility of leading and trailing flags.</span></span>
<span class="l"><a class="anc" name="c375" href="#c375">[c375]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_storeVisibility">@_storeVisibility</a></span></span><span class="ce">; Jump to store.</span></span>
<span class="l"></span>
<a name=":c378:@_facingRight"></a><span class="l"><a class="anc" name="c378" href="#c378">[c378]</a><a href="#:c378:@_facingRight" class="lla">@_facingRight:</a><span class="ce">; [$c378]</span></span>
<span class="l"><a class="anc" name="c378" href="#c378">[c378]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_MovingSpriteVisibility">Temp_MovingSpriteVisibility</a></span></span><span class="ce">; Load the previously-calculated visibility from above.</span></span>
<span class="l"></span>
<a name=":c37a:@_storeVisibility"></a><span class="l"><a class="anc" name="c37a" href="#c37a">[c37a]</a><a href="#:c37a:@_storeVisibility" class="lla">@_storeVisibility:</a><span class="ce">; [$c37a]</span></span>
<span class="l"><a class="anc" name="c37a" href="#c37a">[c37a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span><span class="ce">; Store the new visibility state.</span></span>
<span class="l"><a class="anc" name="c37c" href="#c37c">[c37c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_SetAppearance"></a><div class="cp">;============================================================================
; Set the appearance of the magic sprite.
;
; This will take in an offset into the magic's list of
; frames and set that as the new appearance.
;
; INPUTS:
;     A:
;         The offset into the list of frames.
;
;     <a href="RAM.html#CastMagic_Type">CastMagic_Type</a>:
;         The type of cast magic.
;
;     <a href="#SPRITE_MAGIC_IMAGE_ADDRS_U">SPRITE_MAGIC_IMAGE_ADDRS_U</a>:
;         The lookup table of upper addresses of magic
;         sprite images.
;
; CALLS:
;     <a href="#Sprite_SetAppearanceAddrFromOffset">Sprite_SetAppearanceAddrFromOffset</a>
;
; XREFS:
;     <a href="#CastMagic_FinishHandler_Death">CastMagic_FinishHandler_Death</a>
;     <a href="#CastMagic_FinishHandler_Deluge">CastMagic_FinishHandler_Deluge</a>
;     <a href="#CastMagic_FinishHandler_DelugeOrDeathAfterHit">CastMagic_FinishHandler_DelugeOrDeathAfterHit</a>
;     <a href="#CastMagic_FinishHandler_Fire">CastMagic_FinishHandler_Fire</a>
;     <a href="#CastMagic_FinishHandler_HitWallEffect">CastMagic_FinishHandler_HitWallEffect</a>
;     <a href="#CastMagic_FinishHandler_Thunder">CastMagic_FinishHandler_Thunder</a>
;     <a href="#CastMagic_FinishHandler_Tilte">CastMagic_FinishHandler_Tilte</a>
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;============================================================================
</div><span class="l"><a class="anc" name="c37d" href="#c37d">[c37d]</a><a href="#CastMagic_SetAppearance" class="la">CastMagic_SetAppearance:</a><span class="ce">; [$c37d]</span></span>
<span class="l"><a class="anc" name="c37d" href="#c37d">[c37d]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span><span class="ce">; Y = cast magic type</span></span>
<span class="l"><a class="anc" name="c380" href="#c380">[c380]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c381" href="#c381">[c381]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#SPRITE_MAGIC_IMAGE_ADDRS_U">SPRITE_MAGIC_IMAGE_ADDRS_U</a>,Y</span></span><span class="ce">; Add the value from the lookup table.</span></span>
<span class="l"><a class="anc" name="c384" href="#c384">[c384]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_SetAppearanceAddrFromOffset">Sprite_SetAppearanceAddrFromOffset</a></span></span><span class="ce">; Set the sprite appearance.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SPRITE_MAGIC_IMAGE_ADDRS_U"></a><div class="cp">;============================================================================
; Table of upper address bytes for magic sprite images.
;
; XREFS:
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
</div><span class="l"><a class="anc" name="c387" href="#c387">[c387]</a><a href="#SPRITE_MAGIC_IMAGE_ADDRS_U" class="la">SPRITE_MAGIC_IMAGE_ADDRS_U:</a><span class="ce">; [$c387]</span></span>
<span class="l"><a class="anc" name="c387" href="#c387">[c387]</a><span class="cd"><span class="i">db</span> <span class="o">$95</span></span><span class="ce">; [0]: Deluge</span></span>
<span class="l"><a class="anc" name="c388" href="#c388">[c388]</a><span class="cd"><span class="i">db</span> <span class="o">$99</span></span><span class="ce">; [1]: Thunder</span></span>
<span class="l"><a class="anc" name="c389" href="#c389">[c389]</a><span class="cd"><span class="i">db</span> <span class="o">$9b</span></span><span class="ce">; [2]: Fire</span></span>
<span class="l"><a class="anc" name="c38a" href="#c38a">[c38a]</a><span class="cd"><span class="i">db</span> <span class="o">$9d</span></span><span class="ce">; [3]: Death</span></span>
<span class="l"><a class="anc" name="c38b" href="#c38b">[c38b]</a><span class="cd"><span class="i">db</span> <span class="o">$a1</span></span><span class="ce">; [4]: Tilte</span></span>
<span class="l"><a class="anc" name="c38c" href="#c38c">[c38c]</a><span class="cd"><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [5]: UNUSED: Deluge after first hit</span></span>
<span class="l"><a class="anc" name="c38d" href="#c38d">[c38d]</a><span class="cd"><span class="i">db</span> <span class="o">$99</span></span><span class="ce">; [6]: Thunder after first hit</span></span>
<span class="l"><a class="anc" name="c38e" href="#c38e">[c38e]</a><span class="cd"><span class="i">db</span> <span class="o">$9b</span></span><span class="ce">; [7]: Fire after first hit</span></span>
<span class="l"><a class="anc" name="c38f" href="#c38f">[c38f]</a><span class="cd"><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [8]: UNUSED: Death after first hit</span></span>
<span class="l"><a class="anc" name="c390" href="#c390">[c390]</a><span class="cd"><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [9]: UNUSED</span></span>
<span class="l"><a class="anc" name="c391" href="#c391">[c391]</a><span class="cd"><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [10]: UNUSED: Hit wall effect</span></span>
<span class="l"><a class="anc" name="c392" href="#c392">[c392]</a><span class="cd"><span class="i">db</span> <span class="o">$a5</span></span><span class="ce">; [11]: Tilte after first hit</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_UpdateSpriteDirection"></a><div class="cp">;============================================================================
; Set whether a cast magic's sprite is flipped based on the cast direction.
;
; INPUTS:
;     <a href="RAM.html#CastMagic_Flags">CastMagic_Flags</a>:
;         The cast magic's flags.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a>:
;         The sprite's flip state.
;
; XREFS:
;     <a href="#CastMagic_FinishHandler_Death">CastMagic_FinishHandler_Death</a>
;     <a href="#CastMagic_FinishHandler_Deluge">CastMagic_FinishHandler_Deluge</a>
;     <a href="#CastMagic_FinishHandler_DelugeOrDeathAfterHit">CastMagic_FinishHandler_DelugeOrDeathAfterHit</a>
;     <a href="#CastMagic_FinishHandler_Fire">CastMagic_FinishHandler_Fire</a>
;     <a href="#CastMagic_FinishHandler_Thunder">CastMagic_FinishHandler_Thunder</a>
;     <a href="#CastMagic_FinishHandler_Tilte">CastMagic_FinishHandler_Tilte</a>
;============================================================================
</div><span class="l"><a class="anc" name="c393" href="#c393">[c393]</a><a href="#CastMagic_UpdateSpriteDirection" class="la">CastMagic_UpdateSpriteDirection:</a><span class="ce">; [$c393]</span></span>
<span class="l"><a class="anc" name="c393" href="#c393">[c393]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Flags">CastMagic_Flags</a></span></span><span class="ce">; Load the cast magic's flags.</span></span>
<span class="l"><a class="anc" name="c396" href="#c396">[c396]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Take only the facing direction bit.</span></span>
<span class="l"><a class="anc" name="c398" href="#c398">[c398]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Set as the sprite's flip mask.</span></span>
<span class="l"><a class="anc" name="c39a" href="#c39a">[c39a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_Deluge"></a><div class="cp">;============================================================================
; Finish updating the Deluge spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb27]
;============================================================================
</div><span class="l"><a class="anc" name="c39b" href="#c39b">[c39b]</a><a href="#CastMagic_FinishHandler_Deluge" class="la">CastMagic_FinishHandler_Deluge:</a><span class="ce">; [$c39b]</span></span>
<span class="l"><a class="anc" name="c39b" href="#c39b">[c39b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Set the sprite's direction.</span></span>
<span class="l"><a class="anc" name="c39e" href="#c39e">[c39e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c3a0" href="#c3a0">[c3a0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate an appearance index.</span></span>
<span class="l"><a class="anc" name="c3a1" href="#c3a1">[c3a1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c3a2" href="#c3a2">[c3a2]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Keep the 2 right-most bits (effectively, bits 3 and 4 of the interrupt counter).</span></span>
<span class="l"><a class="anc" name="c3a4" href="#c3a4">[c3a4]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_Thunder"></a><div class="cp">;============================================================================
; Finish updating the Thunder spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; It will update the appearance for 2 frames at a time,
; and wait 2 frames in-between.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb29]
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb33]
;============================================================================
</div><span class="l"><a class="anc" name="c3a7" href="#c3a7">[c3a7]</a><a href="#CastMagic_FinishHandler_Thunder" class="la">CastMagic_FinishHandler_Thunder:</a><span class="ce">; [$c3a7]</span></span>
<span class="l"><a class="anc" name="c3a7" href="#c3a7">[c3a7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Set the sprite's direction.</span></span>
<span class="l"><a class="anc" name="c3aa" href="#c3aa">[c3aa]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c3ac" href="#c3ac">[c3ac]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate a value to check against.</span></span>
<span class="l"><a class="anc" name="c3ad" href="#c3ad">[c3ad]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c3ae" href="#c3ae">[c3ae]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If this should not update the appearance, return.</span></span>
<span class="l"><a class="anc" name="c3b0" href="#c3b0">[c3b0]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the right-most bit (effectively, bit 2 of the interrupt counter).</span></span>
<span class="l"><a class="anc" name="c3b2" href="#c3b2">[c3b2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
<span class="l"></span>
<a name=":c3b5:@_return"></a><span class="l"><a class="anc" name="c3b5" href="#c3b5">[c3b5]</a><a href="#:c3b5:@_return" class="lla">@_return:</a><span class="ce">; [$c3b5]</span></span>
<span class="l"><a class="anc" name="c3b5" href="#c3b5">[c3b5]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_Fire"></a><div class="cp">;============================================================================
; Finish updating the Fire spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; It will run for 2 frames, skip 2 frames, run for 2 frames,
; etc.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb2b]
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb35]
;============================================================================
</div><span class="l"><a class="anc" name="c3b6" href="#c3b6">[c3b6]</a><a href="#CastMagic_FinishHandler_Fire" class="la">CastMagic_FinishHandler_Fire:</a><span class="ce">; [$c3b6]</span></span>
<span class="l"><a class="anc" name="c3b6" href="#c3b6">[c3b6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c3b8" href="#c3b8">[c3b8]</a><span class="cd"><span class="i">AND</span> <span class="o">#$02</span></span><span class="ce">; Is bit 1 set?</span></span>
<span class="l"><a class="anc" name="c3ba" href="#c3ba">[c3ba]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_updateFire">@_updateFire</a></span></span><span class="ce">; If so, jump to update.</span></span>
<span class="l"><a class="anc" name="c3bc" href="#c3bc">[c3bc]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":c3bd:@_updateFire"></a><span class="l"><a class="anc" name="c3bd" href="#c3bd">[c3bd]</a><a href="#:c3bd:@_updateFire" class="lla">@_updateFire:</a><span class="ce">; [$c3bd]</span></span>
<span class="l"><a class="anc" name="c3bd" href="#c3bd">[c3bd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Set the sprite's direction.</span></span>
<span class="l"><a class="anc" name="c3c0" href="#c3c0">[c3c0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c3c2" href="#c3c2">[c3c2]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate an appearance index.</span></span>
<span class="l"><a class="anc" name="c3c3" href="#c3c3">[c3c3]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c3c4" href="#c3c4">[c3c4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the right-most bit (effectively, bit 2 of the interrupt counter).</span></span>
<span class="l"><a class="anc" name="c3c6" href="#c3c6">[c3c6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_Death"></a><div class="cp">;============================================================================
; Finish updating the Death spell.
;
; This will maintain the sprite's direction and update
; the appearance.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb2d]
;============================================================================
</div><span class="l"><a class="anc" name="c3c9" href="#c3c9">[c3c9]</a><a href="#CastMagic_FinishHandler_Death" class="la">CastMagic_FinishHandler_Death:</a><span class="ce">; [$c3c9]</span></span>
<span class="l"><a class="anc" name="c3c9" href="#c3c9">[c3c9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Update the sprite's direction.</span></span>
<span class="l"><a class="anc" name="c3cc" href="#c3cc">[c3cc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c3ce" href="#c3ce">[c3ce]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the interrupt counter to generate an appearance index.</span></span>
<span class="l"><a class="anc" name="c3cf" href="#c3cf">[c3cf]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c3d0" href="#c3d0">[c3d0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c3d1" href="#c3d1">[c3d1]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Keep the 2 right-most bits (effectively, bits 3 and 4 of the interrupt counter).</span></span>
<span class="l"><a class="anc" name="c3d3" href="#c3d3">[c3d3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set that as the appearance index.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_Tilte"></a><div class="cp">;============================================================================
; Finish updating the Tilte spell.
;
; This will set the appearance to 0, 1, 2, or 3,
; based on the current phase of the magic spell and
; the interrupt counter.
;
; The appearance will be:
;
; * 0: Magic phase is even;
;      Interrupt counter has bit 3 set.
;
; * 1: Magic phase is even;
;      Interrupt counter does not have bit 3 set.
;
; * 2: Magic phase is odd;
;      Interrupt counter has bit 1 and 2 unset.
;
; * 3: Magic phase is odd;
;      Interrupt counter has bit 1 unset and 2 set.
;
; INPUTS:
;     <a href="RAM.html#CastMagic_Phase">CastMagic_Phase</a>:
;         The phase of the magic spell.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb2f]
;============================================================================
</div><span class="l"><a class="anc" name="c3d6" href="#c3d6">[c3d6]</a><a href="#CastMagic_FinishHandler_Tilte" class="la">CastMagic_FinishHandler_Tilte:</a><span class="ce">; [$c3d6]</span></span>
<span class="l"><a class="anc" name="c3d6" href="#c3d6">[c3d6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Update the sprite's direction.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the first bit of the magic's phase is 0 or 1.
;
</div><span class="l"><a class="anc" name="c3d9" href="#c3d9">[c3d9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Phase">CastMagic_Phase</a></span></span><span class="ce">; Load the magic's phase.</span></span>
<span class="l"><a class="anc" name="c3dc" href="#c3dc">[c3dc]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift bit 0 into Carry.</span></span>
<span class="l"><a class="anc" name="c3dd" href="#c3dd">[c3dd]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_phaseIs1">@_phaseIs1</a></span></span><span class="ce">; If it's set, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The magic phase is 0. Update the appearance.
;
; The appearance value will be 1 if the interrupt counter
; does not have bit 3 set.
;
</div><span class="l"><a class="anc" name="c3df" href="#c3df">[c3df]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="c3e1" href="#c3e1">[c3e1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; A = interrupt counter</span></span>
<span class="l"><a class="anc" name="c3e3" href="#c3e3">[c3e3]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span><span class="ce">; Keep bit 3.</span></span>
<span class="l"><a class="anc" name="c3e5" href="#c3e5">[c3e5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_setAppearance1">@_setAppearance1</a></span></span><span class="ce">; If 0, jump to use 0 as the appearance value.</span></span>
<span class="l"><a class="anc" name="c3e7" href="#c3e7">[c3e7]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (appearance value == 1)</span></span>
<span class="l"></span>
<a name=":c3e8:@_setAppearance1"></a><span class="l"><a class="anc" name="c3e8" href="#c3e8">[c3e8]</a><a href="#:c3e8:@_setAppearance1" class="lla">@_setAppearance1:</a><span class="ce">; [$c3e8]</span></span>
<span class="l"><a class="anc" name="c3e8" href="#c3e8">[c3e8]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = 0 or 1 (appearance value)</span></span>
<span class="l"><a class="anc" name="c3e9" href="#c3e9">[c3e9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set the appearance of the magic.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c3ec:@_phaseIs1"></a><div class="c">;
; The magic phase is 1. Update the appearance if the
; interrupt counter has bit 1 unset.
;
</div><span class="l"><a class="anc" name="c3ec" href="#c3ec">[c3ec]</a><a href="#:c3ec:@_phaseIs1" class="lla">@_phaseIs1:</a><span class="ce">; [$c3ec]</span></span>
<span class="l"><a class="anc" name="c3ec" href="#c3ec">[c3ec]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c3ee" href="#c3ee">[c3ee]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Divide by 2.</span></span>
<span class="l"><a class="anc" name="c3ef" href="#c3ef">[c3ef]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; And place in Carry.</span></span>
<span class="l"><a class="anc" name="c3f0" href="#c3f0">[c3f0]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_setAppearance2">@_setAppearance2</a></span></span><span class="ce">; If 0, jump to update appearance.</span></span>
<span class="l"><a class="anc" name="c3f2" href="#c3f2">[c3f2]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c3f3:@_setAppearance2"></a><div class="c">;
; The appearance will be updated based on the interrupt
; counter. It will be 3 if bit 2 is unset, or 4 if set.
;
</div><span class="l"><a class="anc" name="c3f3" href="#c3f3">[c3f3]</a><a href="#:c3f3:@_setAppearance2" class="lla">@_setAppearance2:</a><span class="ce">; [$c3f3]</span></span>
<span class="l"><a class="anc" name="c3f3" href="#c3f3">[c3f3]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep bit 0.</span></span>
<span class="l"><a class="anc" name="c3f5" href="#c3f5">[c3f5]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c3f6" href="#c3f6">[c3f6]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; Add 2.</span></span>
<span class="l"><a class="anc" name="c3f8" href="#c3f8">[c3f8]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set the appearance of the magic.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_DelugeOrDeathAfterHit"></a><div class="cp">;============================================================================
; UNUSED: Finish handling updates to Deluge and Death spells that have
; collided at least once.
;
; This would maintain the sprite's direction and appearance.
;
; It's never actually run, due to both these spells clearing
; immediately when colliding.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;     <a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb31]
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb37]
;============================================================================
</div><span class="l"><a class="anc" name="c3fb" href="#c3fb">[c3fb]</a><a href="#CastMagic_FinishHandler_DelugeOrDeathAfterHit" class="la">CastMagic_FinishHandler_DelugeOrDeathAfterHit:</a><span class="ce">; [$c3fb]</span></span>
<span class="l"><a class="anc" name="c3fb" href="#c3fb">[c3fb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_UpdateSpriteDirection">CastMagic_UpdateSpriteDirection</a></span></span><span class="ce">; Update the sprite direction.</span></span>
<span class="l"><a class="anc" name="c3fe" href="#c3fe">[c3fe]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c400" href="#c400">[c400]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Set the appearance to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_HitWallEffect"></a><div class="cp">;============================================================================
; UNUSED: Add a Magic Hit Wall effect.
;
; This was meant to be used by the Deluge and Fire magic.
; Upon hitting a wall, it would briefly spawn two explosion
; sprites (using the diagonal Tilte sprite) up against the
; collided block, before disappearing.
;
; This may have been wired off because there appears to be
; a race condition in the Fire spell, where it may not
; always show.
;
; This can be reactivated using the following Game Genie
; codes:
;
; ZAVLOUNN
; ZEUUSUNN
;
; INPUTS:
;     <a href="RAM.html#CastMagic_Unused_HitWallDeltaPosY">CastMagic_Unused_HitWallDeltaPosY</a>:
;         The delta Y position for the hit wall sprite.
;
;     <a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a>:
;         The Y position of the magic sprite.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a>:
;         Set to 0.
;
;     <a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a>:
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb3b]
;============================================================================
</div><span class="l"><a class="anc" name="c403" href="#c403">[c403]</a><a href="#CastMagic_FinishHandler_HitWallEffect" class="la">CastMagic_FinishHandler_HitWallEffect:</a><span class="ce">; [$c403]</span></span>
<div class="c">;
; Set the default flip mask of the sprite to 0 (face right).
;
</div><span class="l"><a class="anc" name="c403" href="#c403">[c403]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c405" href="#c405">[c405]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Set flip mask to face right.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate a multiplier used to position the explosion
; sprites.
;
; This will be the delta Y position * 2.
;
</div><span class="l"><a class="anc" name="c407" href="#c407">[c407]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Unused_HitWallDeltaPosY">CastMagic_Unused_HitWallDeltaPosY</a></span></span><span class="ce">; A = Delta Y position.</span></span>
<span class="l"><a class="anc" name="c40a" href="#c40a">[c40a]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A *= 2</span></span>
<span class="l"><a class="anc" name="c40b" href="#c40b">[c40b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Save it temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Position and draw the top explosion sprite.
;
; This will be MagicY - (DeltaY * 2).
;
</div><span class="l"><a class="anc" name="c40d" href="#c40d">[c40d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span><span class="ce">; A = Magic Y position.</span></span>
<span class="l"><a class="anc" name="c410" href="#c410">[c410]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="c411" href="#c411">[c411]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; A -= Effect delta Y position.</span></span>
<span class="l"><a class="anc" name="c413" href="#c413">[c413]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span><span class="ce">; Set as the new sprite's Y position.</span></span>
<span class="l"><a class="anc" name="c415" href="#c415">[c415]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="c417" href="#c417">[c417]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Draw the top explosion sprite at that position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Position and draw the bottom explosion sprite.
;
; This will be MagicY + 16 + (DeltaY * 2).
;
</div><span class="l"><a class="anc" name="c41a" href="#c41a">[c41a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Unused_HitWallDeltaPosY">CastMagic_Unused_HitWallDeltaPosY</a></span></span><span class="ce">; A = Delta Y position.</span></span>
<span class="l"><a class="anc" name="c41d" href="#c41d">[c41d]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A *= 2</span></span>
<span class="l"><a class="anc" name="c41e" href="#c41e">[c41e]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c41f" href="#c41f">[c41f]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16</span></span>
<span class="l"><a class="anc" name="c421" href="#c421">[c421]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c422" href="#c422">[c422]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span><span class="ce">; A += Magic Y position.</span></span>
<span class="l"><a class="anc" name="c425" href="#c425">[c425]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span><span class="ce">; Save it as the new sprite's Y position.</span></span>
<span class="l"><a class="anc" name="c427" href="#c427">[c427]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="c429" href="#c429">[c429]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span><span class="ce">; Draw the bottom explosion sprite at that position.</span></span>
<span class="l"></span>
</pre><pre><a name="CastMagic_FinishHandler_TilteAfterFirstHit"></a><div class="cp">;============================================================================
; TODO: Document CastMagic_FinishHandler_TilteAfterFirstHit
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#CAST_MAGIC_UPDATE_FINISH_HANDLERS">CAST_MAGIC_UPDATE_FINISH_HANDLERS</a> [$PRG14::bb3d]
;============================================================================
</div><span class="l"><a class="anc" name="c42c" href="#c42c">[c42c]</a><a href="#CastMagic_FinishHandler_TilteAfterFirstHit" class="la">CastMagic_FinishHandler_TilteAfterFirstHit:</a><span class="ce">; [$c42c]</span></span>
<span class="l"><a class="anc" name="c42c" href="#c42c">[c42c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c42e" href="#c42e">[c42e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><a class="anc" name="c430" href="#c430">[c430]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<a name=":c432:@_loop"></a><span class="l"><a class="anc" name="c432" href="#c432">[c432]</a><a href="#:c432:@_loop" class="lla">@_loop:</a><span class="ce">; [$c432]</span></span>
<span class="l"><a class="anc" name="c432" href="#c432">[c432]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_Counter">CastMagic_Counter</a></span></span></span>
<span class="l"><a class="anc" name="c435" href="#c435">[c435]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c436" href="#c436">[c436]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="c437" href="#c437">[c437]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c439" href="#c439">[c439]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="#MAGICHITHANDLER_c42c_ARRAY1">MAGICHITHANDLER_c42c_ARRAY1</a>,X</span></span></span>
<span class="l"><a class="anc" name="c43c" href="#c43c">[c43c]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c442">@LAB_PRG15_MIRROR__c442</a></span></span></span>
<span class="l"><a class="anc" name="c43e" href="#c43e">[c43e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c440" href="#c440">[c440]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"></span>
<a name=":c442:@LAB_PRG15_MIRROR__c442"></a><span class="l"><a class="anc" name="c442" href="#c442">[c442]</a><a href="#:c442:@LAB_PRG15_MIRROR__c442" class="lla">@LAB_PRG15_MIRROR__c442:</a><span class="ce">; [$c442]</span></span>
<span class="l"><a class="anc" name="c442" href="#c442">[c442]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_XPos_Full">CastMagic_XPos_Full</a></span></span></span>
<span class="l"><a class="anc" name="c445" href="#c445">[c445]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c446" href="#c446">[c446]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c448" href="#c448">[c448]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span></span>
<span class="l"><a class="anc" name="c44a" href="#c44a">[c44a]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="c44b" href="#c44b">[c44b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c44d" href="#c44d">[c44d]</a><span class="cd"><span class="i">EOR</span> <span class="o">$c470,X</span></span></span>
<span class="l"><a class="anc" name="c450" href="#c450">[c450]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c456">@LAB_PRG15_MIRROR__c456</a></span></span></span>
<span class="l"><a class="anc" name="c452" href="#c452">[c452]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c454" href="#c454">[c454]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"></span>
<a name=":c456:@LAB_PRG15_MIRROR__c456"></a><span class="l"><a class="anc" name="c456" href="#c456">[c456]</a><a href="#:c456:@LAB_PRG15_MIRROR__c456" class="lla">@LAB_PRG15_MIRROR__c456:</a><span class="ce">; [$c456]</span></span>
<span class="l"><a class="anc" name="c456" href="#c456">[c456]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CastMagic_YPos_Full">CastMagic_YPos_Full</a></span></span></span>
<span class="l"><a class="anc" name="c459" href="#c459">[c459]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c45a" href="#c45a">[c45a]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="c45c" href="#c45c">[c45c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span></span>
<span class="l"><a class="anc" name="c45e" href="#c45e">[c45e]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="c45f" href="#c45f">[c45f]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="c460" href="#c460">[c460]</a><span class="cd"><span class="i">LDA</span> <span class="o">$c474,X</span></span></span>
<span class="l"><a class="anc" name="c463" href="#c463">[c463]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a></span></span></span>
<span class="l"><a class="anc" name="c466" href="#c466">[c466]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="c467" href="#c467">[c467]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="c468" href="#c468">[c468]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="c469" href="#c469">[c469]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="c46b" href="#c46b">[c46b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="MAGICHITHANDLER_c42c_ARRAY1"></a><span class="l"><a class="anc" name="c46c" href="#c46c">[c46c]</a><a href="#MAGICHITHANDLER_c42c_ARRAY1" class="la">MAGICHITHANDLER_c42c_ARRAY1:</a><span class="ce">; [$c46c]</span></span>
<span class="l"><a class="anc" name="c46c" href="#c46c">[c46c]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="c46d" href="#c46d">[c46d]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<a name="MAGICHITHANDLER_c42c_ARRAY1_2_"></a><div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a class="anc" name="c46e" href="#c46e">[c46e]</a><a href="#MAGICHITHANDLER_c42c_ARRAY1_2_" class="la">MAGICHITHANDLER_c42c_ARRAY1_2_:</a><span class="ce">; [$c46e]</span></span>
<span class="l"><a class="anc" name="c46e" href="#c46e">[c46e]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<a name="MAGICHITHANDLER_c42c_ARRAY1_3_"></a><div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a class="anc" name="c46f" href="#c46f">[c46f]</a><a href="#MAGICHITHANDLER_c42c_ARRAY1_3_" class="la">MAGICHITHANDLER_c42c_ARRAY1_3_:</a><span class="ce">; [$c46f]</span></span>
<span class="l"><a class="anc" name="c46f" href="#c46f">[c46f]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="c470" href="#c470">[c470]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="c471" href="#c471">[c471]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="c472" href="#c472">[c472]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__c470_3_"></a><div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a class="anc" name="c473" href="#c473">[c473]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__c470_3_" class="la">BYTE_ARRAY_PRG15_MIRROR__c470_3_:</a><span class="ce">; [$c473]</span></span>
<span class="l"><a class="anc" name="c473" href="#c473">[c473]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="c474" href="#c474">[c474]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="c475" href="#c475">[c475]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="c476" href="#c476">[c476]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__c474_3_"></a><div class="c">;
; XREFS:
;     <a href="#CastMagic_FinishHandler_TilteAfterFirstHit">CastMagic_FinishHandler_TilteAfterFirstHit</a>
;
</div><span class="l"><a class="anc" name="c477" href="#c477">[c477]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__c474_3_" class="la">BYTE_ARRAY_PRG15_MIRROR__c474_3_:</a><span class="ce">; [$c477]</span></span>
<span class="l"><a class="anc" name="c477" href="#c477">[c477]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_CheckUseCurrentItem"></a><div class="cp">;============================================================================
; Check whether the user wants to use the selected item.
;
; This will check if the player has both initiated an action
; to use the item and is in a position to use one.
;
; If these conditions are met, the action handler for the
; item will be invoked.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The currently-held buttons.
;
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The newly-pressed buttons.
;
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="c478" href="#c478">[c478]</a><a href="#GameLoop_CheckUseCurrentItem" class="la">GameLoop_CheckUseCurrentItem:</a><span class="ce">; [$c478]</span></span>
<span class="l"><a class="anc" name="c478" href="#c478">[c478]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the player is in a state where they'd be allowed
; to use an item.
;
</div><span class="l"><a class="anc" name="c47a" href="#c47a">[c47a]</a><span class="cd"><span class="i">AND</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="c47c" href="#c47c">[c47c]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#GameLoop_UseItem_Return">GameLoop_UseItem_Return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the Down button has been pressed. If not, return.
;
</div><span class="l"><a class="anc" name="c47e" href="#c47e">[c47e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Load the button mask.</span></span>
<span class="l"><a class="anc" name="c480" href="#c480">[c480]</a><span class="cd"><span class="i">AND</span> <span class="o">#$04</span></span><span class="ce">; Check if the Down button is pressed.</span></span>
<span class="l"><a class="anc" name="c482" href="#c482">[c482]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#GameLoop_UseItem_Return">GameLoop_UseItem_Return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the B button has been pressed. If not, return.
;
</div><span class="l"><a class="anc" name="c484" href="#c484">[c484]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Load the changed button mask.</span></span>
<span class="l"><a class="anc" name="c487" href="#c487">[c487]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Check if the B button is pressed.</span></span>
<span class="l"><a class="anc" name="c489" href="#c489">[c489]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#GameLoop_UseItem_Return">GameLoop_UseItem_Return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Down-B was pressed. The item can be used, if a valid one is
; selected. Figure out if there's a valid one first...
;
</div><span class="l"><a class="anc" name="c48b" href="#c48b">[c48b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="c48e" href="#c48e">[c48e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 2 to get a word boundary for address lookup.</span></span>
<span class="l"><a class="anc" name="c48f" href="#c48f">[c48f]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="c490" href="#c490">[c490]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$22</span></span><span class="ce">; Is it a valid item?</span></span>
<span class="l"><a class="anc" name="c492" href="#c492">[c492]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#GameLoop_UseItem_Return">GameLoop_UseItem_Return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Look up this item in the jump table and run it.
;
</div><span class="l"><a class="anc" name="c494" href="#c494">[c494]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a>+1,Y</span></span><span class="ce">; Load the lower byte of the item handler address.</span></span>
<span class="l"><a class="anc" name="c497" href="#c497">[c497]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it.</span></span>
<span class="l"><a class="anc" name="c498" href="#c498">[c498]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a>,Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="c49b" href="#c49b">[c49b]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it.</span></span>
<span class="l"></span>
<a name="GameLoop_UseItem_Return"></a><div class="c">;
; XREFS:
;     <a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a>
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c49d]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c49f]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4a1]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4a3]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4a5]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4a7]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4a9]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4ab]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4ad]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4b1]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4b3]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4b5]
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4b9]
;
</div><span class="l"><a class="anc" name="c49c" href="#c49c">[c49c]</a><a href="#GameLoop_UseItem_Return" class="la">GameLoop_UseItem_Return:</a><span class="ce">; [$c49c]</span></span>
<span class="l"><a class="anc" name="c49c" href="#c49c">[c49c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="USE_ITEM_JUMP_TABLE"></a><div class="cp">;============================================================================
; Handler functions for using specific items.
;
; XREFS:
;     <a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a>
;
</div><span class="l"><a class="anc" name="c49d" href="#c49d">[c49d]</a><a href="#USE_ITEM_JUMP_TABLE" class="la">USE_ITEM_JUMP_TABLE:</a><span class="ce">; [$c49d]</span></span>
<span class="l"><a class="anc" name="c49d" href="#c49d">[c49d]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [0]: Ring of Elf</span></span>
<span class="l"><a class="anc" name="c49f" href="#c49f">[c49f]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [1]: Ring of Ruby</span></span>
<span class="l"><a class="anc" name="c4a1" href="#c4a1">[c4a1]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [2]: Ring of Dworf</span></span>
<span class="l"><a class="anc" name="c4a3" href="#c4a3">[c4a3]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [3]: Demon's Ring</span></span>
<span class="l"><a class="anc" name="c4a5" href="#c4a5">[c4a5]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [4]: "A" Key</span></span>
<span class="l"><a class="anc" name="c4a7" href="#c4a7">[c4a7]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [5]: "K" Key</span></span>
<span class="l"><a class="anc" name="c4a9" href="#c4a9">[c4a9]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [6]: "Q" Key</span></span>
<span class="l"><a class="anc" name="c4ab" href="#c4ab">[c4ab]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [7]: "J" Key</span></span>
<span class="l"><a class="anc" name="c4ad" href="#c4ad">[c4ad]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [8]: "Jo" Key</span></span>
<span class="l"><a class="anc" name="c4af" href="#c4af">[c4af]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#Player_UseMattock">Player_UseMattock</a>-1</span></span><span class="ce">; [9]: Mattock</span></span>
<span class="l"><a class="anc" name="c4b1" href="#c4b1">[c4b1]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [10]: Magical Rod</span></span>
<span class="l"><a class="anc" name="c4b3" href="#c4b3">[c4b3]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [11]: Crystal</span></span>
<span class="l"><a class="anc" name="c4b5" href="#c4b5">[c4b5]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [12]: Lamp</span></span>
<span class="l"><a class="anc" name="c4b7" href="#c4b7">[c4b7]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#Player_UseHourGlass">Player_UseHourGlass</a>-1</span></span><span class="ce">; [13]: Hour Glass</span></span>
<span class="l"><a class="anc" name="c4b9" href="#c4b9">[c4b9]</a><span class="cd"><span class="i">dw</span> <span class="o">$c49b</span></span><span class="ce">; [14]: Book</span></span>
<span class="l"><a class="anc" name="c4bb" href="#c4bb">[c4bb]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#Player_UseWingBoots">Player_UseWingBoots</a>-1</span></span><span class="ce">; [15]: Wing Boots</span></span>
<span class="l"><a class="anc" name="c4bd" href="#c4bd">[c4bd]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#Player_UseRedPotion">Player_UseRedPotion</a>-1</span></span><span class="ce">; [16]: Red Potion</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_ClearSelectedItem"></a><div class="cp">;============================================================================
; Clear the selected item.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The cleared item selection.
;
; CALLS:
;     <a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a>
;
; XREFS:
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;============================================================================
</div><span class="l"><a class="anc" name="c4bf" href="#c4bf">[c4bf]</a><a href="#Player_ClearSelectedItem" class="la">Player_ClearSelectedItem:</a><span class="ce">; [$c4bf]</span></span>
<span class="l"><a class="anc" name="c4bf" href="#c4bf">[c4bf]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><a class="anc" name="c4c0" href="#c4c0">[c4c0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="c4c2" href="#c4c2">[c4c2]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Set selected item to 0xFF (unset).</span></span>
<span class="l"><a class="anc" name="c4c5" href="#c4c5">[c4c5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a></span></span><span class="ce">; Update the UI for the cleared image.</span></span>
<span class="l"><a class="anc" name="c4c8" href="#c4c8">[c4c8]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A from the stack.</span></span>
<span class="l"><a class="anc" name="c4c9" href="#c4c9">[c4c9]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UseElixir"></a><div class="cp">;============================================================================
; Use the player's Elixir.
;
; This will remove the Elixir from the inventory and update the player's
; health.
;
; This then falls through to <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The special items bitmask to update.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's MP.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The new special items bitmask with the
;         Elixir removed.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's updated HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's updated MP.
;
; CALLS:
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#Player_AddMP">Player_AddMP</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Sprites_FlipRanges">Sprites_FlipRanges</a>
;
; XREFS:
;     <a href="#Player_ReduceHP">Player_ReduceHP</a>
;============================================================================
</div><span class="l"><a class="anc" name="c4ca" href="#c4ca">[c4ca]</a><a href="#Player_UseElixir" class="la">Player_UseElixir:</a><span class="ce">; [$c4ca]</span></span>
<span class="l"><a class="anc" name="c4ca" href="#c4ca">[c4ca]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><a class="anc" name="c4cd" href="#c4cd">[c4cd]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f7</span></span><span class="ce">; Clear the elixir bit.</span></span>
<span class="l"><a class="anc" name="c4cf" href="#c4cf">[c4cf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run the "Use Elixir" IScript.
;
; IScript 0x85 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c4d2" href="#c4d2">[c4d2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$85</span></span><span class="ce">; 0x85 == Use Elixir.</span></span>
<span class="l"><a class="anc" name="c4d4" href="#c4d4">[c4d4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c4d7" href="#c4d7">[c4d7]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c4d8" href="#c4d8">[c4d8]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_FillHPAndMP"></a><div class="cp">;============================================================================
; Progressively fill the player's HP and MP.
;
; This will add 4HP and 4MP at a time, playing a sound
; effect for each segment. This appears to the player as
; the HP and MP bars filling up.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The special items bitmask to update.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's MP.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The new special items bitmask with the
;         Elixir removed.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's updated HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The player's updated MP.
;
; CALLS:
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#Player_AddMP">Player_AddMP</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Sprites_FlipRanges">Sprites_FlipRanges</a>
;
; XREFS:
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;============================================================================
</div><span class="l"><a class="anc" name="c4da" href="#c4da">[c4da]</a><a href="#Player_FillHPAndMP" class="la">Player_FillHPAndMP:</a><span class="ce">; [$c4da]</span></span>
<div class="c">;
; Progressively fill the HP, 4 units at a time.
;
; Start by playing the sound.
;
</div><span class="l"><a class="anc" name="c4da" href="#c4da">[c4da]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; Set sound 0x13 (fill HP/MP bar).</span></span>
<span class="l"><a class="anc" name="c4dc" href="#c4dc">[c4dc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the HP.
;
</div><span class="l"><a class="anc" name="c4df" href="#c4df">[c4df]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; Set the HP to 4 units.</span></span>
<span class="l"><a class="anc" name="c4e1" href="#c4e1">[c4e1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_AddHP">Player_AddHP</a></span></span><span class="ce">; Add it to the player.</span></span>
<span class="l"><a class="anc" name="c4e4" href="#c4e4">[c4e4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span><span class="ce">; Draw the screen, and prevent updating until done.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait 4 frames of updates before filling up the next units
; of HP, to help animate the bar.
;
</div><span class="l"><a class="anc" name="c4e7" href="#c4e7">[c4e7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait a bit.</span></span>
<span class="l"><a class="anc" name="c4ea" href="#c4ea">[c4ea]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c4ed" href="#c4ed">[c4ed]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c4f0" href="#c4f0">[c4f0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c4f3" href="#c4f3">[c4f3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c4f6" href="#c4f6">[c4f6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c4f9" href="#c4f9">[c4f9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c4fc" href="#c4fc">[c4fc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if we're done filling up HP.
;
</div><span class="l"><a class="anc" name="c4ff" href="#c4ff">[c4ff]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the player's HP.</span></span>
<span class="l"><a class="anc" name="c502" href="#c502">[c502]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it below the cap of 80HP?</span></span>
<span class="l"><a class="anc" name="c504" href="#c504">[c504]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#Player_FillHPAndMP">Player_FillHPAndMP</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c506:@_fillMPLoop"></a><div class="c">;
; Progressively fill the MP, 4 units at a time.
;
; Start by playing the sound.
;
</div><span class="l"><a class="anc" name="c506" href="#c506">[c506]</a><a href="#:c506:@_fillMPLoop" class="lla">@_fillMPLoop:</a><span class="ce">; [$c506]</span></span>
<span class="l"><a class="anc" name="c506" href="#c506">[c506]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; Set sound 0x13 (fill HP/MP bar).</span></span>
<span class="l"><a class="anc" name="c508" href="#c508">[c508]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the MP.
;
</div><span class="l"><a class="anc" name="c50b" href="#c50b">[c50b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; Set the MP to 4 units.</span></span>
<span class="l"><a class="anc" name="c50d" href="#c50d">[c50d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_AddMP">Player_AddMP</a></span></span><span class="ce">; Add it to the player.</span></span>
<span class="l"><a class="anc" name="c510" href="#c510">[c510]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span><span class="ce">; Draw the screen but keep all sprites frozen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait 4 frames of updates before filling up the next units
; of MP, to help animate the bar.
;
</div><span class="l"><a class="anc" name="c513" href="#c513">[c513]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait a bit.</span></span>
<span class="l"><a class="anc" name="c516" href="#c516">[c516]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c519" href="#c519">[c519]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c51c" href="#c51c">[c51c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c51f" href="#c51f">[c51f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c522" href="#c522">[c522]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c525" href="#c525">[c525]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c528" href="#c528">[c528]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if we're done filling up MP.
;
</div><span class="l"><a class="anc" name="c52b" href="#c52b">[c52b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Load the player's MP.</span></span>
<span class="l"><a class="anc" name="c52e" href="#c52e">[c52e]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it below the cap of 80MP?</span></span>
<span class="l"><a class="anc" name="c530" href="#c530">[c530]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_fillMPLoop">@_fillMPLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"><a class="anc" name="c532" href="#c532">[c532]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UseRedPotion"></a><div class="cp">;============================================================================
; Use the Red Potion item.
;
; This will play the Red Potion message and a sound
; effect, and remove the item from the inventory.
;
; Health will be progressively filled.
;
; INPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's HP.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's updated HP.
;
; CALLS:
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Sprites_FlipRanges">Sprites_FlipRanges</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4bd]
;============================================================================
</div><span class="l"><a class="anc" name="c533" href="#c533">[c533]</a><a href="#Player_UseRedPotion" class="la">Player_UseRedPotion:</a><span class="ce">; [$c533]</span></span>
<div class="c">;
; Run the "Used Red Potion" IScript.
;
; IScript 0x80 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c533" href="#c533">[c533]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$80</span></span><span class="ce">; 0x80 == Use Red Potion IScript.</span></span>
<span class="l"><a class="anc" name="c535" href="#c535">[c535]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c538" href="#c538">[c538]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c539" href="#c539">[c539]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":c53b:@_afterFarJump"></a><span class="l"><a class="anc" name="c53b" href="#c53b">[c53b]</a><a href="#:c53b:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c53b]</span></span>
<span class="l"><a class="anc" name="c53b" href="#c53b">[c53b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the initial sound effect.
;
</div><span class="l"><a class="anc" name="c53e" href="#c53e">[c53e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; 0x1A == Initial item used sound effect.</span></span>
<span class="l"><a class="anc" name="c540" href="#c540">[c540]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set up the HP fill loop. This will fill up to 80.
;
</div><span class="l"><a class="anc" name="c543" href="#c543">[c543]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$50</span></span><span class="ce">; X = Maximum HP / our loop counter.</span></span>
<span class="l"></span>
<a name=":c545:@_loop"></a><span class="l"><a class="anc" name="c545" href="#c545">[c545]</a><a href="#:c545:@_loop" class="lla">@_loop:</a><span class="ce">; [$c545]</span></span>
<span class="l"><a class="anc" name="c545" href="#c545">[c545]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="c546" href="#c546">[c546]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the unit fill sound effect.
;
</div><span class="l"><a class="anc" name="c547" href="#c547">[c547]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; 0x13 = Unit of HP fill sound effect.</span></span>
<span class="l"><a class="anc" name="c549" href="#c549">[c549]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add 2HP.
;
</div><span class="l"><a class="anc" name="c54c" href="#c54c">[c54c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="c54e" href="#c54e">[c54e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_AddHP">Player_AddHP</a></span></span><span class="ce">; Add the 2HP to the player.</span></span>
<span class="l"><a class="anc" name="c551" href="#c551">[c551]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait 4 frames worth of updates before filling the next 2HP.
;
</div><span class="l"><a class="anc" name="c554" href="#c554">[c554]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c557" href="#c557">[c557]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c55a" href="#c55a">[c55a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c55d" href="#c55d">[c55d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c560" href="#c560">[c560]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c563" href="#c563">[c563]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"><a class="anc" name="c566" href="#c566">[c566]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c569" href="#c569">[c569]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if we're done.
;
</div><span class="l"><a class="anc" name="c56c" href="#c56c">[c56c]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the max HP.</span></span>
<span class="l"><a class="anc" name="c56d" href="#c56d">[c56d]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="c56e" href="#c56e">[c56e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Load the player's current HP.</span></span>
<span class="l"><a class="anc" name="c571" href="#c571">[c571]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is the player at max HP?</span></span>
<span class="l"><a class="anc" name="c573" href="#c573">[c573]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><a class="anc" name="c575" href="#c575">[c575]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="c576" href="#c576">[c576]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<a name=":c578:@_return"></a><span class="l"><a class="anc" name="c578" href="#c578">[c578]</a><a href="#:c578:@_return" class="lla">@_return:</a><span class="ce">; [$c578]</span></span>
<span class="l"><a class="anc" name="c578" href="#c578">[c578]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UseWingBoots"></a><div class="cp">;============================================================================
; Use the Wing Boots item.
;
; This will play the Wing Boots message and a sound
; effect, and remove the item from the inventory.
;
; The duration of the Wing Boots will depend on the
; player's title:
;
; * 40 seconds: Novice, Aspirant, Battler, Fighter
; * 30 seconds: Adept, Chevalier, Veteran, Warrior
; * 20 seconds: Swordman, Hero, Soldier, Myrmidon
; * 10 seconds: Champion, Superhero, Paladin, Lor
;
; INPUTS:
;     <a href="RAM.html#PlayerTitle">PlayerTitle</a>:
;         The player's current title.
;
;     <a href="#TITLE_TO_WINGBOOTS_DURATION">TITLE_TO_WINGBOOTS_DURATION</a>:
;         The table of player titles to Wingboots duration.
;
; OUTPUTS:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         The starting number of seconds remaining for the
;         Wing Boots.
;
; CALLS:
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>:
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4bb]
;============================================================================
</div><span class="l"><a class="anc" name="c579" href="#c579">[c579]</a><a href="#Player_UseWingBoots" class="la">Player_UseWingBoots:</a><span class="ce">; [$c579]</span></span>
<div class="c">;
; Run the "Wing Boots Used" IScript.
;
; IScript 0x83 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c579" href="#c579">[c579]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$83</span></span><span class="ce">; 0x83 == Wing Boots used IScript.</span></span>
<span class="l"><a class="anc" name="c57b" href="#c57b">[c57b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c57e" href="#c57e">[c57e]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c57f" href="#c57f">[c57f]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c581:@_afterFarJump"></a><div class="c">;
; Remove the item.
;
</div><span class="l"><a class="anc" name="c581" href="#c581">[c581]</a><a href="#:c581:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c581]</span></span>
<span class="l"><a class="anc" name="c581" href="#c581">[c581]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play a sound effect for the item usage.
;
</div><span class="l"><a class="anc" name="c584" href="#c584">[c584]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; Set the sound to play to 0x1A (special item sound).</span></span>
<span class="l"><a class="anc" name="c586" href="#c586">[c586]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate the index into the duration table based on
; the player's title.
;
</div><span class="l"><a class="anc" name="c589" href="#c589">[c589]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span><span class="ce">; Load the player's title.</span></span>
<span class="l"><a class="anc" name="c58c" href="#c58c">[c58c]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Divide by 4.</span></span>
<span class="l"><a class="anc" name="c58d" href="#c58d">[c58d]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c58e" href="#c58e">[c58e]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (index)</span></span>
<span class="l"><a class="anc" name="c58f" href="#c58f">[c58f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#TITLE_TO_WINGBOOTS_DURATION">TITLE_TO_WINGBOOTS_DURATION</a>,X</span></span><span class="ce">; Look up in the duration table.</span></span>
<span class="l"><a class="anc" name="c592" href="#c592">[c592]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Set that as the starting duration.</span></span>
<span class="l"><a class="anc" name="c595" href="#c595">[c595]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawTimeValue">UI_DrawTimeValue</a></span></span><span class="ce">; Draw the time on the HUD.</span></span>
<span class="l"><a class="anc" name="c598" href="#c598">[c598]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="TITLE_TO_WINGBOOTS_DURATION"></a><div class="cp">;============================================================================
; Wing Boots durations by player title.
;
; The duration decreases every 4 player titles.
;
; XREFS:
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;
</div><span class="l"><a class="anc" name="c599" href="#c599">[c599]</a><a href="#TITLE_TO_WINGBOOTS_DURATION" class="la">TITLE_TO_WINGBOOTS_DURATION:</a><span class="ce">; [$c599]</span></span>
<span class="l"><a class="anc" name="c599" href="#c599">[c599]</a><span class="cd"><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [0]: 40 seconds: Novice, Aspirant, Battler, Fighter</span></span>
<span class="l"><a class="anc" name="c59a" href="#c59a">[c59a]</a><span class="cd"><span class="i">db</span> <span class="o">$1e</span></span><span class="ce">; [1]: 30 seconds: Adept, Chevalier, Veteran, Warrior</span></span>
<span class="l"><a class="anc" name="c59b" href="#c59b">[c59b]</a><span class="cd"><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [2]: 20 seconds: Swordman, Hero, Soldier, Myrmidon</span></span>
<span class="l"><a class="anc" name="c59c" href="#c59c">[c59c]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [3]: 10 seconds: Champion, Superhero, Paladin, Lord</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_DecWingBootsDuration"></a><div class="cp">;============================================================================
; Decrement the Wing Boot's duration.
;
; This will decrement and then draw the time in the HUD.
;
; INPUTS:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         The remaining duration for the Wing Boots.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         The new duration for the Wing Boots.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a class="anc" name="c59d" href="#c59d">[c59d]</a><a href="#Game_DecWingBootsDuration" class="la">Game_DecWingBootsDuration:</a><span class="ce">; [$c59d]</span></span>
<div class="c">;
; Check if there's any time remaining on the Wing Boots.
;
</div><span class="l"><a class="anc" name="c59d" href="#c59d">[c59d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Load the remaining time on the Wing Boots.</span></span>
<span class="l"><a class="anc" name="c5a0" href="#c5a0">[c5a0]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If the counter is unset (0xFF), return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the player's status to mark Wing Boots as on.
;
</div><span class="l"><a class="anc" name="c5a2" href="#c5a2">[c5a2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><a class="anc" name="c5a4" href="#c5a4">[c5a4]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Enable the Wing Boots bit.</span></span>
<span class="l"><a class="anc" name="c5a6" href="#c5a6">[c5a6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update at most once every second.
;
</div><span class="l"><a class="anc" name="c5a8" href="#c5a8">[c5a8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c5aa" href="#c5aa">[c5aa]</a><span class="cd"><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if we're at the 1 second mark.</span></span>
<span class="l"><a class="anc" name="c5ac" href="#c5ac">[c5ac]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reduce time on the Wing Boots by a second.
;
</div><span class="l"><a class="anc" name="c5ae" href="#c5ae">[c5ae]</a><span class="cd"><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Decrement the remaining time for the Wing Boots.</span></span>
<span class="l"><a class="anc" name="c5b1" href="#c5b1">[c5b1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Load that duration</span></span>
<span class="l"><a class="anc" name="c5b4" href="#c5b4">[c5b4]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_wingBootsDone">@_wingBootsDone</a></span></span><span class="ce">; If it wrapped from 0 to 0xFF, it's used up. Jump.</span></span>
<span class="l"><a class="anc" name="c5b6" href="#c5b6">[c5b6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawTimeValue">UI_DrawTimeValue</a></span></span><span class="ce">; Else, draw the time remaining.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c5b9:@_wingBootsDone"></a><div class="c">;
; The Wing Boots ran out. Remove the flag from the player's
; status.
;
</div><span class="l"><a class="anc" name="c5b9" href="#c5b9">[c5b9]</a><a href="#:c5b9:@_wingBootsDone" class="lla">@_wingBootsDone:</a><span class="ce">; [$c5b9]</span></span>
<span class="l"><a class="anc" name="c5b9" href="#c5b9">[c5b9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><a class="anc" name="c5bb" href="#c5bb">[c5bb]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Clear the Wing Boots flag.</span></span>
<span class="l"><a class="anc" name="c5bd" href="#c5bd">[c5bd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run "Wing Boots are gone" IScript.
;
; IScript 0x96 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c5bf" href="#c5bf">[c5bf]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$96</span></span><span class="ce">; 0x96 == Wing Boots are gone IScript.</span></span>
<span class="l"><a class="anc" name="c5c1" href="#c5c1">[c5c1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="c5c4" href="#c5c4">[c5c4]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c5c5" href="#c5c5">[c5c5]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c5c7:@_return"></a><div class="c">;
; It will resume here.
;
</div><span class="l"><a class="anc" name="c5c7" href="#c5c7">[c5c7]</a><a href="#:c5c7:@_return" class="lla">@_return:</a><span class="ce">; [$c5c7]</span></span>
<span class="l"><a class="anc" name="c5c7" href="#c5c7">[c5c7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UseHourGlass"></a><div class="cp">;============================================================================
; Use the Hour Glass.
;
; This will invoke the IScript for the Hour Glass's
; message, play a sound, and begin the Hour Glass
; effect.
;
; The player's health will be reduced by half in the
; process.
;
; INPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The player's current health.
;
; OUTPUTS:
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;     <a href="RAM.html#Player_HP_L">Player_HP_L</a>:
;         The player's new health, reduced by half.
;
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The duration of the Hour Glass.
;
;     <a href="RAM.html#Music_Current">Music_Current</a>:
;         The music to play while the Hour Glass is
;         active.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     UI_DrawPlayerHP
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4b7]
;============================================================================
</div><span class="l"><a class="anc" name="c5c8" href="#c5c8">[c5c8]</a><a href="#Player_UseHourGlass" class="la">Player_UseHourGlass:</a><span class="ce">; [$c5c8]</span></span>
<div class="c">;
; Run the "Hour Glass Used" IScript.
;
; IScript 0x82 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c5c8" href="#c5c8">[c5c8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$82</span></span><span class="ce">; Set the IScript to run to 0x82.</span></span>
<span class="l"><a class="anc" name="c5ca" href="#c5ca">[c5ca]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c5cd" href="#c5cd">[c5cd]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c5ce" href="#c5ce">[c5ce]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c5d0:@_afterFarJump"></a><div class="c">;
; Remove the item.
;
</div><span class="l"><a class="anc" name="c5d0" href="#c5d0">[c5d0]</a><a href="#:c5d0:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c5d0]</span></span>
<span class="l"><a class="anc" name="c5d0" href="#c5d0">[c5d0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play a sound effect for the item usage.
;
</div><span class="l"><a class="anc" name="c5d3" href="#c5d3">[c5d3]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; Set the sound to play to 0x1A (special item sound).</span></span>
<span class="l"><a class="anc" name="c5d5" href="#c5d5">[c5d5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reduce the player's health by half. This is the cost of
; the Hour Glass.
;
</div><span class="l"><a class="anc" name="c5d8" href="#c5d8">[c5d8]</a><span class="cd"><span class="i">LSR</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Divide the upper value of the player's HP by half.</span></span>
<span class="l"><a class="anc" name="c5db" href="#c5db">[c5db]</a><span class="cd"><span class="i">ROR</span> <span class="o">a:<a href="RAM.html#Player_HP_L">Player_HP_L</a></span></span><span class="ce">; Divide the lower byte of the player's HP by half, and add carry from the upper.</span></span>
<span class="l"><a class="anc" name="c5de" href="#c5de">[c5de]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a></span></span><span class="ce">; Draw the new HP.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the duration of the Hour Glass to 15 seconds.
;
</div><span class="l"><a class="anc" name="c5e1" href="#c5e1">[c5e1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0f</span></span><span class="ce">; Set the duration to 15 seconds.</span></span>
<span class="l"><a class="anc" name="c5e3" href="#c5e3">[c5e3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Change the music.
;
</div><span class="l"><a class="anc" name="c5e6" href="#c5e6">[c5e6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0b</span></span><span class="ce">; Set the new music to play.</span></span>
<span class="l"><a class="anc" name="c5e8" href="#c5e8">[c5e8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; And play it.</span></span>
<span class="l"><a class="anc" name="c5ea" href="#c5ea">[c5ea]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_DecHourGlassDuration"></a><div class="cp">;============================================================================
; Decrement the Hour Glass's duration.
;
; INPUTS:
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The remaining duration for the Hour Glass.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The new duration for the Hour Glass..
;
;     <a href="RAM.html#Music_Current">Music_Current</a>:
;         The restored music for the area.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a class="anc" name="c5eb" href="#c5eb">[c5eb]</a><a href="#Game_DecHourGlassDuration" class="la">Game_DecHourGlassDuration:</a><span class="ce">; [$c5eb]</span></span>
<div class="c">;
; Check if there's any time remaining on the Hour Glass.
;
</div><span class="l"><a class="anc" name="c5eb" href="#c5eb">[c5eb]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Load the remaining time on the Hour Glass.</span></span>
<span class="l"><a class="anc" name="c5ee" href="#c5ee">[c5ee]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If the counter is unset (0xFF), return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update at most once every second.
;
</div><span class="l"><a class="anc" name="c5f0" href="#c5f0">[c5f0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c5f2" href="#c5f2">[c5f2]</a><span class="cd"><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if we're at the 1 second mark.</span></span>
<span class="l"><a class="anc" name="c5f4" href="#c5f4">[c5f4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reduce time on the Hour Glass by a second.
;
</div><span class="l"><a class="anc" name="c5f6" href="#c5f6">[c5f6]</a><span class="cd"><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Decrement the remaining time for the Hour Glass.</span></span>
<span class="l"><a class="anc" name="c5f9" href="#c5f9">[c5f9]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it wrapped from 0 to 0xFF, it's used up. Jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run "Hour Glass is gone" IScript.
;
; IScript 0x97 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c5fb" href="#c5fb">[c5fb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$97</span></span><span class="ce">; 0x97 == Hour Glass is gone IScript.</span></span>
<span class="l"><a class="anc" name="c5fd" href="#c5fd">[c5fd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="c600" href="#c600">[c600]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c601" href="#c601">[c601]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c603:@_afterFarJump"></a><div class="c">;
; Load the area's default music.
;
</div><span class="l"><a class="anc" name="c603" href="#c603">[c603]</a><a href="#:c603:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c603]</span></span>
<span class="l"><a class="anc" name="c603" href="#c603">[c603]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Load the music for the area.</span></span>
<span class="l"><a class="anc" name="c606" href="#c606">[c606]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<a name=":c608:@_return"></a><span class="l"><a class="anc" name="c608" href="#c608">[c608]</a><a href="#:c608:@_return" class="lla">@_return:</a><span class="ce">; [$c608]</span></span>
<span class="l"><a class="anc" name="c608" href="#c608">[c608]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_Add100XP"></a><div class="cp">;============================================================================
; Add 100XP to the player's experience.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_UpdateExperience">Player_UpdateExperience</a>
;
; XREFS:
;     <a href="#Player_PickUpGlove">Player_PickUpGlove</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;============================================================================
</div><span class="l"><a class="anc" name="c609" href="#c609">[c609]</a><a href="#Player_Add100XP" class="la">Player_Add100XP:</a><span class="ce">; [$c609]</span></span>
<span class="l"><a class="anc" name="c609" href="#c609">[c609]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$64</span></span><span class="ce">; A = 100 (lower byte of XP)</span></span>
<span class="l"><a class="anc" name="c60b" href="#c60b">[c60b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store it as an argument.</span></span>
<span class="l"><a class="anc" name="c60e" href="#c60e">[c60e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (upper byte of XP).</span></span>
<span class="l"><a class="anc" name="c610" href="#c610">[c610]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Store it as an argument.</span></span>
<span class="l"><a class="anc" name="c613" href="#c613">[c613]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_UpdateExperience">Player_UpdateExperience</a></span></span><span class="ce">; Update the player's experience using those values.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UseMattock"></a><div class="cp">;============================================================================
; Use the Mattock.
;
; This will check if the Mattock can be used at the current
; player position. If so, it will invoke the IScript for the
; Mattock's message, play a sound, and update the level state.
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The player's current X position.
;
;     <a href="RAM.html#Player_PosY">Player_PosY</a>:
;         The player's current Y position.
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's flags.
;
;     <a href="#USE_MATTOCK_BLOCK_DISTANCES">USE_MATTOCK_BLOCK_DISTANCES</a>:
;         TODO
;
; OUTPUTS:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;
; XREFS:
;     <a href="#USE_ITEM_JUMP_TABLE">USE_ITEM_JUMP_TABLE</a> [$PRG15_MIRROR::c4af]
;============================================================================
</div><span class="l"><a class="anc" name="c616" href="#c616">[c616]</a><a href="#Player_UseMattock" class="la">Player_UseMattock:</a><span class="ce">; [$c616]</span></span>
<div class="c">;
; Check if the block check position will be in bounds.
;
; The offset will be dependent on the facing direction.
;
; If facing left, this will check the block immediately
; to the left (0xFF -- wrapping around the screen).
;
; If facing right, this will check block + 16 (within or
; at the end of the blocks to clear).
;
</div><span class="l"><a class="anc" name="c616" href="#c616">[c616]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Lookup table index = 0 (default)</span></span>
<span class="l"><a class="anc" name="c618" href="#c618">[c618]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="c61a" href="#c61a">[c61a]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is the player facing right?</span></span>
<span class="l"><a class="anc" name="c61c" href="#c61c">[c61c]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__c61f">@LAB_PRG15_MIRROR__c61f</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is facing right. Set our offset into the block
; distances table to 1.
;
</div><span class="l"><a class="anc" name="c61e" href="#c61e">[c61e]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Lookup table index = 1</span></span>
<span class="l"></span>
<a name=":c61f:@LAB_PRG15_MIRROR__c61f"></a><span class="l"><a class="anc" name="c61f" href="#c61f">[c61f]</a><a href="#:c61f:@LAB_PRG15_MIRROR__c61f" class="lla">@LAB_PRG15_MIRROR__c61f:</a><span class="ce">; [$c61f]</span></span>
<span class="l"><a class="anc" name="c61f" href="#c61f">[c61f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Get the player's X position.</span></span>
<span class="l"><a class="anc" name="c621" href="#c621">[c621]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c622" href="#c622">[c622]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#USE_MATTOCK_BLOCK_DISTANCES">USE_MATTOCK_BLOCK_DISTANCES</a>,Y</span></span><span class="ce">; Add the block distance for the facing direction.</span></span>
<span class="l"><a class="anc" name="c625" href="#c625">[c625]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$f0</span></span><span class="ce">; Is the player too near to the right edge of the screen?</span></span>
<span class="l"><a class="anc" name="c627" href="#c627">[c627]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin fetching the block at this offset.
;
; Same logic as above for block calculation.
;
</div><span class="l"><a class="anc" name="c629" href="#c629">[c629]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store the calculated position as the X argument.</span></span>
<span class="l"><a class="anc" name="c62b" href="#c62b">[c62b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span><span class="ce">; Load the player's current Y position.</span></span>
<span class="l"><a class="anc" name="c62d" href="#c62d">[c62d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store that as the Y argument.</span></span>
<span class="l"><a class="anc" name="c62f" href="#c62f">[c62f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert those pixel positions to block positions.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the screen buffer contains the blocks to clear.
; If not, there's nothing to do.
;
; Each block is composed of 4 tiles, which are represented
; in the lookup table. This only needs to check for the
; presence of one of those blocks.
;
</div><span class="l"><a class="anc" name="c632" href="#c632">[c632]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current area.</span></span>
<span class="l"><a class="anc" name="c634" href="#c634">[c634]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a 4 byte index.</span></span>
<span class="l"><a class="anc" name="c635" href="#c635">[c635]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="c636" href="#c636">[c636]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = index</span></span>
<span class="l"><a class="anc" name="c637" href="#c637">[c637]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the value from the screen buffer.</span></span>
<span class="l"><a class="anc" name="c63a" href="#c63a">[c63a]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="#USE_MATTOCK_BLOCK_TRANSITIONS">USE_MATTOCK_BLOCK_TRANSITIONS</a>,Y</span></span><span class="ce">; Is this block already cleared by the Mattock?</span></span>
<span class="l"><a class="anc" name="c63d" href="#c63d">[c63d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_useMattock">@_useMattock</a></span></span><span class="ce">; If not, use the Mattock to clear them.</span></span>
<span class="l"><a class="anc" name="c63f" href="#c63f">[c63f]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c640:@_useMattock"></a><div class="c">;
; The Mattock will be used. Store the offsets into the
; screen buffer and array on the stack for later.
;
</div><span class="l"><a class="anc" name="c640" href="#c640">[c640]</a><a href="#:c640:@_useMattock" class="lla">@_useMattock:</a><span class="ce">; [$c640]</span></span>
<span class="l"><a class="anc" name="c640" href="#c640">[c640]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="c641" href="#c641">[c641]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c642" href="#c642">[c642]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="c643" href="#c643">[c643]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run the "Used Mattock" IScript.
;
; IScript 0x81 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c644" href="#c644">[c644]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$81</span></span></span>
<span class="l"><a class="anc" name="c646" href="#c646">[c646]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c649" href="#c649">[c649]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c64a" href="#c64a">[c64a]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c64c:@_afterFarJump"></a><div class="c">;
; Remove the Mattock.
;
</div><span class="l"><a class="anc" name="c64c" href="#c64c">[c64c]</a><a href="#:c64c:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c64c]</span></span>
<span class="l"><a class="anc" name="c64c" href="#c64c">[c64c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a></span></span><span class="ce">; Clear the selected item.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the sound effect for the Mattock usage.
;
</div><span class="l"><a class="anc" name="c64f" href="#c64f">[c64f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$1a</span></span><span class="ce">; 0x1A == Special item sound effect.</span></span>
<span class="l"><a class="anc" name="c651" href="#c651">[c651]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare for the loop.
;
; This loop will handle animating the destruction/crumbling
; of blocks. This uses 4 frames of animation, all defined in
; <a href="#USE_MATTOCK_BLOCK_TRANSITIONS">USE_MATTOCK_BLOCK_TRANSITIONS</a>.
;
</div><span class="l"><a class="anc" name="c654" href="#c654">[c654]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="c655" href="#c655">[c655]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="c656" href="#c656">[c656]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="c657" href="#c657">[c657]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c658:@_loop"></a><div class="c">;
; Only update every 4 frames, to get a quick animation effect.
;
</div><span class="l"><a class="anc" name="c658" href="#c658">[c658]</a><a href="#:c658:@_loop" class="lla">@_loop:</a><span class="ce">; [$c658]</span></span>
<span class="l"><a class="anc" name="c658" href="#c658">[c658]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for 4 frames.</span></span>
<span class="l"><a class="anc" name="c65b" href="#c65b">[c65b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c65e" href="#c65e">[c65e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="c661" href="#c661">[c661]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the screen to place the next block in the sequence.
;
</div><span class="l"><a class="anc" name="c664" href="#c664">[c664]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="c665" href="#c665">[c665]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c666" href="#c666">[c666]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="c667" href="#c667">[c667]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="c668" href="#c668">[c668]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#USE_MATTOCK_BLOCK_TRANSITIONS">USE_MATTOCK_BLOCK_TRANSITIONS</a>,Y</span></span><span class="ce">; Load the block for this position.</span></span>
<span class="l"><a class="anc" name="c66b" href="#c66b">[c66b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; And store it in the screen buffer.</span></span>
<span class="l"><a class="anc" name="c66e" href="#c66e">[c66e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the level data.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update to the next block.
;
</div><span class="l"><a class="anc" name="c671" href="#c671">[c671]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="c672" href="#c672">[c672]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c673" href="#c673">[c673]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 32</span></span>
<span class="l"><a class="anc" name="c675" href="#c675">[c675]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="c676" href="#c676">[c676]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a></span></span><span class="ce">; Load a value.</span></span>
<span class="l"><a class="anc" name="c679" href="#c679">[c679]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; And write it to the screen buffer.</span></span>
<span class="l"><a class="anc" name="c67c" href="#c67c">[c67c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Upate the level data.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare for the next loop iteration.
;
</div><span class="l"><a class="anc" name="c67f" href="#c67f">[c67f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="c680" href="#c680">[c680]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="c681" href="#c681">[c681]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="c682" href="#c682">[c682]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="c683" href="#c683">[c683]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="c684" href="#c684">[c684]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="c685" href="#c685">[c685]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Have we finished updating the blocks?</span></span>
<span class="l"><a class="anc" name="c687" href="#c687">[c687]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><a class="anc" name="c689" href="#c689">[c689]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; Else, loop.</span></span>
<span class="l"></span>
<a name=":c68c:@_return"></a><span class="l"><a class="anc" name="c68c" href="#c68c">[c68c]</a><a href="#:c68c:@_return" class="lla">@_return:</a><span class="ce">; [$c68c]</span></span>
<span class="l"><a class="anc" name="c68c" href="#c68c">[c68c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="USE_MATTOCK_BLOCK_DISTANCES"></a><div class="cp">;============================================================================
; Block distances for checking if a player is on-screen.
;
; This is used when using the Mattock.
;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;
</div><span class="l"><a class="anc" name="c68d" href="#c68d">[c68d]</a><a href="#USE_MATTOCK_BLOCK_DISTANCES" class="la">USE_MATTOCK_BLOCK_DISTANCES:</a><span class="ce">; [$c68d]</span></span>
<span class="l"><a class="anc" name="c68d" href="#c68d">[c68d]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<a name="USE_MATTOCK_BLOCK_DISTANCES_1_"></a><div class="c">;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;
</div><span class="l"><a class="anc" name="c68e" href="#c68e">[c68e]</a><a href="#USE_MATTOCK_BLOCK_DISTANCES_1_" class="la">USE_MATTOCK_BLOCK_DISTANCES_1_:</a><span class="ce">; [$c68e]</span></span>
<span class="l"><a class="anc" name="c68e" href="#c68e">[c68e]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="USE_MATTOCK_BLOCK_TRANSITIONS"></a><div class="cp">;============================================================================
; New block IDs to place when clearing blocks.
;
; This is divided into regions, each with 4 blocks.
; Those 4 blocks are an animation transition between
; the placed blocks (index 0 within a group) and
; cleared blocks (index 3).
;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;
</div><span class="l"><a class="anc" name="c68f" href="#c68f">[c68f]</a><a href="#USE_MATTOCK_BLOCK_TRANSITIONS" class="la">USE_MATTOCK_BLOCK_TRANSITIONS:</a><span class="ce">; [$c68f]</span></span>
<span class="l"><a class="anc" name="c68f" href="#c68f">[c68f]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="c690" href="#c690">[c690]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="c691" href="#c691">[c691]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="c692" href="#c692">[c692]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="c693" href="#c693">[c693]</a><span class="cd"><span class="i">db</span> <span class="o">$63</span></span><span class="ce">; [4]: Apolune</span></span>
<span class="l"><a class="anc" name="c694" href="#c694">[c694]</a><span class="cd"><span class="i">db</span> <span class="o">$85</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="c695" href="#c695">[c695]</a><span class="cd"><span class="i">db</span> <span class="o">$86</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="c696" href="#c696">[c696]</a><span class="cd"><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="c697" href="#c697">[c697]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [8]: Forepaw</span></span>
<span class="l"><a class="anc" name="c698" href="#c698">[c698]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="c699" href="#c699">[c699]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="c69a" href="#c69a">[c69a]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]:</span></span>
<span class="l"><a class="anc" name="c69b" href="#c69b">[c69b]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [12]: Mascon</span></span>
<span class="l"><a class="anc" name="c69c" href="#c69c">[c69c]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [13]:</span></span>
<span class="l"><a class="anc" name="c69d" href="#c69d">[c69d]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><a class="anc" name="c69e" href="#c69e">[c69e]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [15]:</span></span>
<span class="l"><a class="anc" name="c69f" href="#c69f">[c69f]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [16]: Victim</span></span>
<span class="l"><a class="anc" name="c6a0" href="#c6a0">[c6a0]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [17]:</span></span>
<span class="l"><a class="anc" name="c6a1" href="#c6a1">[c6a1]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [18]:</span></span>
<span class="l"><a class="anc" name="c6a2" href="#c6a2">[c6a2]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]:</span></span>
<span class="l"><a class="anc" name="c6a3" href="#c6a3">[c6a3]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [20]: Conflate</span></span>
<span class="l"><a class="anc" name="c6a4" href="#c6a4">[c6a4]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [21]:</span></span>
<span class="l"><a class="anc" name="c6a5" href="#c6a5">[c6a5]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [22]:</span></span>
<span class="l"><a class="anc" name="c6a6" href="#c6a6">[c6a6]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [23]:</span></span>
<span class="l"><a class="anc" name="c6a7" href="#c6a7">[c6a7]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [24]: Daybreak</span></span>
<span class="l"><a class="anc" name="c6a8" href="#c6a8">[c6a8]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [25]:</span></span>
<span class="l"><a class="anc" name="c6a9" href="#c6a9">[c6a9]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [26]:</span></span>
<span class="l"><a class="anc" name="c6aa" href="#c6aa">[c6aa]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [27]:</span></span>
<span class="l"><a class="anc" name="c6ab" href="#c6ab">[c6ab]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [28]: Evil Fortress</span></span>
<span class="l"><a class="anc" name="c6ac" href="#c6ac">[c6ac]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [29]:</span></span>
<span class="l"><a class="anc" name="c6ad" href="#c6ad">[c6ad]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [30]:</span></span>
<span class="l"><a class="anc" name="c6ae" href="#c6ae">[c6ae]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [31]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_ClearTimedItems"></a><div class="cp">;============================================================================
; Clear timers on all temporary status items.
;
; This applies to the Glove, Ointment, Wing Boots, and
; Hour Glass.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#DurationGlove">DurationGlove</a>:
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;     <a href="RAM.html#DurationWingBoots">DurationWingBoots</a>:
;         All set to 0xFF (not active).
;
; XREFS:
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a class="anc" name="c6af" href="#c6af">[c6af]</a><a href="#Game_ClearTimedItems" class="la">Game_ClearTimedItems:</a><span class="ce">; [$c6af]</span></span>
<span class="l"><a class="anc" name="c6af" href="#c6af">[c6af]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="c6b1" href="#c6b1">[c6b1]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Clear the Glove duration.</span></span>
<span class="l"><a class="anc" name="c6b4" href="#c6b4">[c6b4]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Clear the Ointment duration.</span></span>
<span class="l"><a class="anc" name="c6b7" href="#c6b7">[c6b7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationWingBoots">DurationWingBoots</a></span></span><span class="ce">; Clear the Wing Boots duration.</span></span>
<span class="l"><a class="anc" name="c6ba" href="#c6ba">[c6ba]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Clear the Hour Glass duration.</span></span>
<span class="l"><a class="anc" name="c6bd" href="#c6bd">[c6bd]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpHourGlass"></a><div class="cp">;============================================================================
; Handle picking up the Hour Glass.
;
; This will invoke the IScript, play the sound, and add
; the Hour Glass to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c6be" href="#c6be">[c6be]</a><a href="#Player_PickUpHourGlass" class="la">Player_PickUpHourGlass:</a><span class="ce">; [$c6be]</span></span>
<div class="c">;
; Run the "Got Hour Glass" IScript.
;
; IScript 0x8A via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c6be" href="#c6be">[c6be]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$8a</span></span><span class="ce">; 0x8A == Hour Glass picked up IScript.</span></span>
<span class="l"><a class="anc" name="c6c0" href="#c6c0">[c6c0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c6c3" href="#c6c3">[c6c3]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c6c4" href="#c6c4">[c6c4]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c6c6:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c6c6" href="#c6c6">[c6c6]</a><a href="#:c6c6:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c6c6]</span></span>
<span class="l"><a class="anc" name="c6c6" href="#c6c6">[c6c6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c6c8" href="#c6c8">[c6c8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Pick up the item.
;
</div><span class="l"><a class="anc" name="c6cb" href="#c6cb">[c6cb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0d</span></span><span class="ce">; 0xD == Hour Glass.</span></span>
<span class="l"><a class="anc" name="c6cd" href="#c6cd">[c6cd]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpWingBootsWithQuest"></a><div class="cp">;============================================================================
; Handle picking up the Wing Boots for the quest.
;
; This will invoke the IScript, play the sound, and add
; the Wing Boots to the inventory.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The player's current completed quests.
;
; OUTPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The updated set of completed quests.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c6d0" href="#c6d0">[c6d0]</a><a href="#Player_PickUpWingBootsWithQuest" class="la">Player_PickUpWingBootsWithQuest:</a><span class="ce">; [$c6d0]</span></span>
<span class="l"><a class="anc" name="c6d0" href="#c6d0">[c6d0]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the completed quests.</span></span>
<span class="l"><a class="anc" name="c6d3" href="#c6d3">[c6d3]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; Mark this quest as completed.</span></span>
<span class="l"><a class="anc" name="c6d5" href="#c6d5">[c6d5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Store it back out.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpWingBoots"></a><div class="cp">;============================================================================
; Handle picking up the Wing Boots.
;
; This will invoke the IScript, play the sound, and add
; the Wing Boots to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c6d8" href="#c6d8">[c6d8]</a><a href="#Player_PickUpWingBoots" class="la">Player_PickUpWingBoots:</a><span class="ce">; [$c6d8]</span></span>
<div class="c">;
; Run the "Got Wing Boots" IScript.
;
; IScript 0x89 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c6d8" href="#c6d8">[c6d8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$89</span></span><span class="ce">; 0x89 == Wing boots picked up IScript.</span></span>
<span class="l"><a class="anc" name="c6da" href="#c6da">[c6da]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c6dd" href="#c6dd">[c6dd]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c6de" href="#c6de">[c6de]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c6e0:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c6e0" href="#c6e0">[c6e0]</a><a href="#:c6e0:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c6e0]</span></span>
<span class="l"><a class="anc" name="c6e0" href="#c6e0">[c6e0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x8 == Item pick-up sound.</span></span>
<span class="l"><a class="anc" name="c6e2" href="#c6e2">[c6e2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Pick up the item.
;
</div><span class="l"><a class="anc" name="c6e5" href="#c6e5">[c6e5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0f</span></span><span class="ce">; 0xF == Wing Boots.</span></span>
<span class="l"><a class="anc" name="c6e7" href="#c6e7">[c6e7]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpBattleSuit"></a><div class="cp">;============================================================================
; Pick up the Battle Suit and add to the inventory.
;
; This will invoke the IScript, play the sound, and then
; attempt to cap the armor insert position and add the item
; there.
;
; BUGS:
;     This has a bug where it checks the caps against the
;     WEAPON slots, not the ARMOR slots!
;
;     Player_PickUpDragonSlayer has the inverse
;     bug.
;
; INPUTS:
;     <a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a>:
;         The number of weapons the player is carrying.
;
; OUTPUTS:
;     <a href="RAM.html#ArmorInventory">ArmorInventory</a>:
;         The updated armor inventory.
;
;     <a href="RAM.html#NumberOfArmors">NumberOfArmors</a>:
;         The number of armors in the inventory.
;
;     See CALLS.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c6ea" href="#c6ea">[c6ea]</a><a href="#Player_PickUpBattleSuit" class="la">Player_PickUpBattleSuit:</a><span class="ce">; [$c6ea]</span></span>
<div class="c">;
; Run the "Got Battle Suit" IScript.
;
; IScript 0x8B via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c6ea" href="#c6ea">[c6ea]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$8b</span></span><span class="ce">; 0x8B == Battle Suit picked up IScript.</span></span>
<span class="l"><a class="anc" name="c6ec" href="#c6ec">[c6ec]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c6ef" href="#c6ef">[c6ef]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c6f0" href="#c6f0">[c6f0]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c6f2:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c6f2" href="#c6f2">[c6f2]</a><a href="#:c6f2:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c6f2]</span></span>
<span class="l"><a class="anc" name="c6f2" href="#c6f2">[c6f2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c6f4" href="#c6f4">[c6f4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Cap the number of WEAPONS in the inventory.
;
; Yes, weapons. This *should* be armor. This code is swapped
; with the code that equips the Dragon Slayer.
;
</div><span class="l"><a class="anc" name="c6f7" href="#c6f7">[c6f7]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a></span></span><span class="ce">; X = Number of weapons.</span></span>
<span class="l"><a class="anc" name="c6fa" href="#c6fa">[c6fa]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$04</span></span><span class="ce">; If &lt; 4</span></span>
<span class="l"><a class="anc" name="c6fc" href="#c6fc">[c6fc]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_addItem">@_addItem</a></span></span><span class="ce">; Then, add it to the latest slot.</span></span>
<span class="l"><a class="anc" name="c6fe" href="#c6fe">[c6fe]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; Else, cap X to 3.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c700:@_addItem"></a><div class="c">;
; Add the Battle Suit to the inventory.
;
</div><span class="l"><a class="anc" name="c700" href="#c700">[c700]</a><a href="#:c700:@_addItem" class="lla">@_addItem:</a><span class="ce">; [$c700]</span></span>
<span class="l"><a class="anc" name="c700" href="#c700">[c700]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span><span class="ce">; 0x03 == Battle Suit</span></span>
<span class="l"><a class="anc" name="c702" href="#c702">[c702]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ArmorInventory">ArmorInventory</a>,X</span></span><span class="ce">; Set in the inventory slot</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increase the number of armors collected.
;
</div><span class="l"><a class="anc" name="c705" href="#c705">[c705]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="c706" href="#c706">[c706]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfArmors">NumberOfArmors</a></span></span><span class="ce">; Store as the number of armors.</span></span>
<span class="l"><a class="anc" name="c709" href="#c709">[c709]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpBattleHelmet"></a><div class="cp">;============================================================================
; Pick up the Battle Helmet and add to the inventory.
;
; This will invoke the IScript, play the sound, and then
; cap the shield insertion point and add the item there.
;
; Keep in mind, the Battle Helmet is considered a shield in
; this game.
;
; INPUTS:
;     <a href="RAM.html#NumberOfShields">NumberOfShields</a>:
;         The number of shields the player is carrying.
;
; OUTPUTS:
;     <a href="RAM.html#ShieldInventory">ShieldInventory</a>:
;         The updated armor inventory.
;
;     <a href="RAM.html#NumberOfShields">NumberOfShields</a>:
;         The number of armors in the inventory.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c70a" href="#c70a">[c70a]</a><a href="#Player_PickUpBattleHelmet" class="la">Player_PickUpBattleHelmet:</a><span class="ce">; [$c70a]</span></span>
<div class="c">;
; Run the "Got Battle Helmet" IScript.
;
; IScript 0x8C via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c70a" href="#c70a">[c70a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$8c</span></span><span class="ce">; 0x8C == Battle Helmet picked up IScript.</span></span>
<span class="l"><a class="anc" name="c70c" href="#c70c">[c70c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run it.</span></span>
<span class="l"><a class="anc" name="c70f" href="#c70f">[c70f]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c710" href="#c710">[c710]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c712:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c712" href="#c712">[c712]</a><a href="#:c712:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c712]</span></span>
<span class="l"><a class="anc" name="c712" href="#c712">[c712]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c714" href="#c714">[c714]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Cap the number of shields in the inventory.
;
</div><span class="l"><a class="anc" name="c717" href="#c717">[c717]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfShields">NumberOfShields</a></span></span><span class="ce">; X = Number of shields.</span></span>
<span class="l"><a class="anc" name="c71a" href="#c71a">[c71a]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$04</span></span><span class="ce">; If X &lt; 4:</span></span>
<span class="l"><a class="anc" name="c71c" href="#c71c">[c71c]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_addItem">@_addItem</a></span></span><span class="ce">; Then, add to the latest slot.</span></span>
<span class="l"><a class="anc" name="c71e" href="#c71e">[c71e]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; Else, cap X to 3.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c720:@_addItem"></a><div class="c">;
; Add the Battle Helmet to the inventory.
;
</div><span class="l"><a class="anc" name="c720" href="#c720">[c720]</a><a href="#:c720:@_addItem" class="lla">@_addItem:</a><span class="ce">; [$c720]</span></span>
<span class="l"><a class="anc" name="c720" href="#c720">[c720]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span><span class="ce">; 0x03 == Battle Helmet.</span></span>
<span class="l"><a class="anc" name="c722" href="#c722">[c722]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ShieldInventory">ShieldInventory</a>,X</span></span><span class="ce">; Set in the inventory slot.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increase the number of shields collected.
;
</div><span class="l"><a class="anc" name="c725" href="#c725">[c725]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="c726" href="#c726">[c726]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfShields">NumberOfShields</a></span></span><span class="ce">; Store as the number of shields.</span></span>
<span class="l"><a class="anc" name="c729" href="#c729">[c729]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpDragonSlayer"></a><div class="cp">;============================================================================
; Pick up the Dragon Slayer and add to the inventory.
;
; This will invoke the IScript, play the sound, and then
; attempt to cap the armor insert position and add the item
; there.
;
; BUGS:
;     This has a bug where it checks the caps against the
;     ARMOR slots, not the WEAPON slots!
;
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a> has the inverse
;     bug.
;
; INPUTS:
;     <a href="RAM.html#NumberOfArmors">NumberOfArmors</a>:
;         The number of armors the player is carrying.
;
; OUTPUTS:
;     <a href="RAM.html#WeaponInventory">WeaponInventory</a>:
;         The updated weapon inventory.
;
;     <a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a>:
;         The number of weapons in the inventory.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c72a" href="#c72a">[c72a]</a><a href="#Player_PickUpDragonSlayer" class="la">Player_PickUpDragonSlayer:</a><span class="ce">; [$c72a]</span></span>
<div class="c">;
; Run the "Got Dragon Slayer" IScript.
;
; IScript 0x8D via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c72a" href="#c72a">[c72a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$8d</span></span><span class="ce">; 0x8D == Dragon Slayer picked up IScript.</span></span>
<span class="l"><a class="anc" name="c72c" href="#c72c">[c72c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run it.</span></span>
<span class="l"><a class="anc" name="c72f" href="#c72f">[c72f]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c730" href="#c730">[c730]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c732:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c732" href="#c732">[c732]</a><a href="#:c732:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c732]</span></span>
<span class="l"><a class="anc" name="c732" href="#c732">[c732]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c734" href="#c734">[c734]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Cap the number of ARMORS in the inventory.
;
; Yes, armors. This *should* be weapons. This code is swapped
; with the code that equips the Battle Suit.
;
</div><span class="l"><a class="anc" name="c737" href="#c737">[c737]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfArmors">NumberOfArmors</a></span></span><span class="ce">; X = number of armors.</span></span>
<span class="l"><a class="anc" name="c73a" href="#c73a">[c73a]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$04</span></span><span class="ce">; If &lt; 4</span></span>
<span class="l"><a class="anc" name="c73c" href="#c73c">[c73c]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_addItem">@_addItem</a></span></span><span class="ce">; Then, add it to the latest slot.</span></span>
<span class="l"><a class="anc" name="c73e" href="#c73e">[c73e]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; Else, cap X to 3.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c740:@_addItem"></a><div class="c">;
; Add the Dragon Slayer to the inventory.
;
</div><span class="l"><a class="anc" name="c740" href="#c740">[c740]</a><a href="#:c740:@_addItem" class="lla">@_addItem:</a><span class="ce">; [$c740]</span></span>
<span class="l"><a class="anc" name="c740" href="#c740">[c740]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span><span class="ce">; 0x03 == Dragon Slayer</span></span>
<span class="l"><a class="anc" name="c742" href="#c742">[c742]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#WeaponInventory">WeaponInventory</a>,X</span></span><span class="ce">; Set in the inventory slot.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increase the number of weapons collected.
;
</div><span class="l"><a class="anc" name="c745" href="#c745">[c745]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="c746" href="#c746">[c746]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfWeapons">NumberOfWeapons</a></span></span><span class="ce">; Store as the number of weapons.</span></span>
<span class="l"><a class="anc" name="c749" href="#c749">[c749]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpMattockWithQuest"></a><div class="cp">;============================================================================
; Handle picking up the Mattock for the quest.
;
; This will invoke the IScript, play the sound, and set
; the Mattock bit in the quests and in the inventory.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The current completed quests.
;
; OUTPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The updated completed quests.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c74a" href="#c74a">[c74a]</a><a href="#Player_PickUpMattockWithQuest" class="la">Player_PickUpMattockWithQuest:</a><span class="ce">; [$c74a]</span></span>
<span class="l"><a class="anc" name="c74a" href="#c74a">[c74a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the quests bitmask.</span></span>
<span class="l"><a class="anc" name="c74d" href="#c74d">[c74d]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$10</span></span><span class="ce">; Bit 0x10 == Mattock</span></span>
<span class="l"><a class="anc" name="c74f" href="#c74f">[c74f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through to the next function. --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpMattock"></a><div class="cp">;============================================================================
; Handle picking up the Mattock.
;
; This will invoke the IScript, play the sound, and add
; the Mattock to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c752" href="#c752">[c752]</a><a href="#Player_PickUpMattock" class="la">Player_PickUpMattock:</a><span class="ce">; [$c752]</span></span>
<div class="c">;
; Run the "Got Mattock" IScript.
;
; IScript 0x88 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c752" href="#c752">[c752]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$88</span></span><span class="ce">; 0x88 == Mattock picked up IScript.</span></span>
<span class="l"><a class="anc" name="c754" href="#c754">[c754]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c757" href="#c757">[c757]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c758" href="#c758">[c758]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c75a:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c75a" href="#c75a">[c75a]</a><a href="#:c75a:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c75a]</span></span>
<span class="l"><a class="anc" name="c75a" href="#c75a">[c75a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c75c" href="#c75c">[c75c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the Mattock into the inventory.
;
</div><span class="l"><a class="anc" name="c75f" href="#c75f">[c75f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$09</span></span><span class="ce">; 0x09 == Mattock</span></span>
<span class="l"><a class="anc" name="c761" href="#c761">[c761]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick up the Mattock.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUp"></a><div class="cp">;============================================================================
; Handle picking up an item.
;
; INPUTS:
;     A:
;         The sprite entity that was interacted with.
;
;         This will determine the proper handler for the
;         item pick-up.
;
; OUTPUTS:
;     See CALLS.
;
; CALLS:
;     Player_PickUpBattleHelmet
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a>
;     Player_PickUpBlackOnyx
;     Player_PickUpDragonSlayer
;     <a href="#Player_PickUpElixir">Player_PickUpElixir</a>
;     PRG15::87cf
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMagicalRod">Player_PickUpMagicalRod</a>
;     Player_PickUpMattock
;     <a href="#Player_PickUpMattockWithQuest">Player_PickUpMattockWithQuest</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;     Player_PickUpPendant
;     <a href="#Player_PickUpPoison">Player_PickUpPoison</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;     <a href="#Player_PickUpWingBootsWithQuest">Player_PickUpWingBootsWithQuest</a>
;
; XREFS:
;     <a href="PRG14.html#Player_HandleTouchItem">Player_HandleTouchItem</a>
;============================================================================
</div><span class="l"><a class="anc" name="c764" href="#c764">[c764]</a><a href="#Player_PickUp" class="la">Player_PickUp:</a><span class="ce">; [$c764]</span></span>
<div class="c">;
; Check if this is the Mattock.
;
</div><span class="l"><a class="anc" name="c764" href="#c764">[c764]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; 0x50 == Mattock</span></span>
<span class="l"><a class="anc" name="c766" href="#c766">[c766]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpMattock">Player_PickUpMattock</a></span></span><span class="ce">; If 0x50, this is the Mattock. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Magical Rod.
;
</div><span class="l"><a class="anc" name="c768" href="#c768">[c768]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$57</span></span><span class="ce">; 0x57 == Magical Rod</span></span>
<span class="l"><a class="anc" name="c76a" href="#c76a">[c76a]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkBattleSuit">@_checkBattleSuit</a></span></span></span>
<span class="l"><a class="anc" name="c76c" href="#c76c">[c76c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpMagicalRod">Player_PickUpMagicalRod</a></span></span><span class="ce">; This is the Magical Rod. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c76f:@_checkBattleSuit"></a><div class="c">;
; Check if this is the battle suit.
;
</div><span class="l"><a class="anc" name="c76f" href="#c76f">[c76f]</a><a href="#:c76f:@_checkBattleSuit" class="lla">@_checkBattleSuit:</a><span class="ce">; [$c76f]</span></span>
<span class="l"><a class="anc" name="c76f" href="#c76f">[c76f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$58</span></span><span class="ce">; 0x58 == Battle Suit</span></span>
<span class="l"><a class="anc" name="c771" href="#c771">[c771]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkBattleHelmet">@_checkBattleHelmet</a></span></span></span>
<span class="l"><a class="anc" name="c773" href="#c773">[c773]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a></span></span><span class="ce">; This is the Battle Suit. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c776:@_checkBattleHelmet"></a><div class="c">;
; Check if this is the battle helmet.
;
</div><span class="l"><a class="anc" name="c776" href="#c776">[c776]</a><a href="#:c776:@_checkBattleHelmet" class="lla">@_checkBattleHelmet:</a><span class="ce">; [$c776]</span></span>
<span class="l"><a class="anc" name="c776" href="#c776">[c776]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$59</span></span><span class="ce">; 0x59 == Battle Helmet</span></span>
<span class="l"><a class="anc" name="c778" href="#c778">[c778]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpBattleHelmet">Player_PickUpBattleHelmet</a></span></span><span class="ce">; This is the Battle Helmet. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Dragon Slayer.
;
</div><span class="l"><a class="anc" name="c77a" href="#c77a">[c77a]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$5a</span></span><span class="ce">; 0x5A == Dragon Slayer</span></span>
<span class="l"><a class="anc" name="c77c" href="#c77c">[c77c]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpDragonSlayer">Player_PickUpDragonSlayer</a></span></span><span class="ce">; This is the Dragon Slayer. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Mattock.
;
</div><span class="l"><a class="anc" name="c77e" href="#c77e">[c77e]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$5b</span></span><span class="ce">; 0x5B == Mattock</span></span>
<span class="l"><a class="anc" name="c780" href="#c780">[c780]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpMattockWithQuest">Player_PickUpMattockWithQuest</a></span></span><span class="ce">; This is the Mattock. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Wing Boots.
;
</div><span class="l"><a class="anc" name="c782" href="#c782">[c782]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$55</span></span><span class="ce">; 0x55 == Wing Boots</span></span>
<span class="l"><a class="anc" name="c784" href="#c784">[c784]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkWingBootsQuest8">@_checkWingBootsQuest8</a></span></span></span>
<span class="l"><a class="anc" name="c786" href="#c786">[c786]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a></span></span><span class="ce">; This is the Wing Boots. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c789:@_checkWingBootsQuest8"></a><div class="c">;
; Check if this is the Wing Boots (with Quest 0x08).
;
</div><span class="l"><a class="anc" name="c789" href="#c789">[c789]</a><a href="#:c789:@_checkWingBootsQuest8" class="lla">@_checkWingBootsQuest8:</a><span class="ce">; [$c789]</span></span>
<span class="l"><a class="anc" name="c789" href="#c789">[c789]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$5c</span></span><span class="ce">; 0x5C == Wing Boots for Quest 8</span></span>
<span class="l"><a class="anc" name="c78b" href="#c78b">[c78b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkHourGlass">@_checkHourGlass</a></span></span></span>
<span class="l"><a class="anc" name="c78d" href="#c78d">[c78d]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpWingBootsWithQuest">Player_PickUpWingBootsWithQuest</a></span></span><span class="ce">; This is the Wing Boots for Quest 8. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c790:@_checkHourGlass"></a><div class="c">;
; Check if this is the Hour Glass.
;
</div><span class="l"><a class="anc" name="c790" href="#c790">[c790]</a><a href="#:c790:@_checkHourGlass" class="lla">@_checkHourGlass:</a><span class="ce">; [$c790]</span></span>
<span class="l"><a class="anc" name="c790" href="#c790">[c790]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$56</span></span><span class="ce">; 0x56 == Hour Glass</span></span>
<span class="l"><a class="anc" name="c792" href="#c792">[c792]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkRedPotion">@_checkRedPotion</a></span></span></span>
<span class="l"><a class="anc" name="c794" href="#c794">[c794]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a></span></span><span class="ce">; This is the Hour Glass.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c797:@_checkRedPotion"></a><div class="c">;
; Check if this is the Red Potion.
;
</div><span class="l"><a class="anc" name="c797" href="#c797">[c797]</a><a href="#:c797:@_checkRedPotion" class="lla">@_checkRedPotion:</a><span class="ce">; [$c797]</span></span>
<span class="l"><a class="anc" name="c797" href="#c797">[c797]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$5d</span></span><span class="ce">; 0x5D == Red Potion (1)</span></span>
<span class="l"><a class="anc" name="c799" href="#c799">[c799]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkPoison">@_checkPoison</a></span></span></span>
<span class="l"><a class="anc" name="c79b" href="#c79b">[c79b]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a></span></span><span class="ce">; This is the Red Potion (1).  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c79e:@_checkPoison"></a><div class="c">;
; Check if this is the Poison.
;
</div><span class="l"><a class="anc" name="c79e" href="#c79e">[c79e]</a><a href="#:c79e:@_checkPoison" class="lla">@_checkPoison:</a><span class="ce">; [$c79e]</span></span>
<span class="l"><a class="anc" name="c79e" href="#c79e">[c79e]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$5e</span></span><span class="ce">; 0x5E == Poison</span></span>
<span class="l"><a class="anc" name="c7a0" href="#c7a0">[c7a0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkGlove1">@_checkGlove1</a></span></span></span>
<span class="l"><a class="anc" name="c7a2" href="#c7a2">[c7a2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpPoison">Player_PickUpPoison</a></span></span><span class="ce">; This is the Poison.  Pick it up.</span></span>
<span class="l"></span>
<a name=":c7a5:@_checkGlove1"></a><span class="l"><a class="anc" name="c7a5" href="#c7a5">[c7a5]</a><a href="#:c7a5:@_checkGlove1" class="lla">@_checkGlove1:</a><span class="ce">; [$c7a5]</span></span>
<span class="l"><a class="anc" name="c7a5" href="#c7a5">[c7a5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$5f</span></span><span class="ce">; 0x5F == Glove</span></span>
<span class="l"><a class="anc" name="c7a7" href="#c7a7">[c7a7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpGlove">Player_PickUpGlove</a></span></span><span class="ce">; This is the Glove.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Ointment.
;
</div><span class="l"><a class="anc" name="c7a9" href="#c7a9">[c7a9]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$60</span></span><span class="ce">; 0x60 == Ointment</span></span>
<span class="l"><a class="anc" name="c7ab" href="#c7ab">[c7ab]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkGlove2">@_checkGlove2</a></span></span></span>
<span class="l"><a class="anc" name="c7ad" href="#c7ad">[c7ad]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpOintment">Player_PickUpOintment</a></span></span><span class="ce">; This is the Ointment.  Pick it up.</span></span>
<span class="l"></span>
<a name=":c7b0:@_checkGlove2"></a><span class="l"><a class="anc" name="c7b0" href="#c7b0">[c7b0]</a><a href="#:c7b0:@_checkGlove2" class="lla">@_checkGlove2:</a><span class="ce">; [$c7b0]</span></span>
<span class="l"><a class="anc" name="c7b0" href="#c7b0">[c7b0]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="c7b1" href="#c7b1">[c7b1]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$48</span></span></span>
<span class="l"><a class="anc" name="c7b3" href="#c7b3">[c7b3]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="c7b4" href="#c7b4">[c7b4]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpGlove">Player_PickUpGlove</a></span></span><span class="ce">; This is the Glove. Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Black Onyx.
;
</div><span class="l"><a class="anc" name="c7b6" href="#c7b6">[c7b6]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; 0x49 == Black Onyx</span></span>
<span class="l"><a class="anc" name="c7b7" href="#c7b7">[c7b7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpBlackOnyx">Player_PickUpBlackOnyx</a></span></span><span class="ce">; If 0x49, this is the Black Onyx.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Pendant.
;
</div><span class="l"><a class="anc" name="c7b9" href="#c7b9">[c7b9]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; 0x4A == Pendant</span></span>
<span class="l"><a class="anc" name="c7ba" href="#c7ba">[c7ba]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpPendant">Player_PickUpPendant</a></span></span><span class="ce">; If 0x4A, this is the pendant.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Red Potion (another variant).
;
</div><span class="l"><a class="anc" name="c7bc" href="#c7bc">[c7bc]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; 0x4B == Red Potion (2)</span></span>
<span class="l"><a class="anc" name="c7bd" href="#c7bd">[c7bd]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a></span></span><span class="ce">; If 0x4B, this is the Red Potion (2).  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Poison.
;
</div><span class="l"><a class="anc" name="c7bf" href="#c7bf">[c7bf]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; 0x4C == Poison</span></span>
<span class="l"><a class="anc" name="c7c0" href="#c7c0">[c7c0]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_PickUpPoison">Player_PickUpPoison</a></span></span><span class="ce">; If 0x4C, this is the Poison.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is the Elixir.
;
</div><span class="l"><a class="anc" name="c7c2" href="#c7c2">[c7c2]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; 0x4D == Elixir</span></span>
<span class="l"><a class="anc" name="c7c3" href="#c7c3">[c7c3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkOintment">@_checkOintment</a></span></span></span>
<span class="l"><a class="anc" name="c7c5" href="#c7c5">[c7c5]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpElixir">Player_PickUpElixir</a></span></span><span class="ce">; This is the Elixir.  Pick it up.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c7c8:@_checkOintment"></a><div class="c">;
; Check if this is the Ointment.
;
</div><span class="l"><a class="anc" name="c7c8" href="#c7c8">[c7c8]</a><a href="#:c7c8:@_checkOintment" class="lla">@_checkOintment:</a><span class="ce">; [$c7c8]</span></span>
<span class="l"><a class="anc" name="c7c8" href="#c7c8">[c7c8]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; 0x4E == Ointment</span></span>
<span class="l"><a class="anc" name="c7c9" href="#c7c9">[c7c9]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_exit">@_exit</a></span></span></span>
<span class="l"><a class="anc" name="c7cb" href="#c7cb">[c7cb]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_PickUpOintment">Player_PickUpOintment</a></span></span><span class="ce">; This is the Ointment.  Pick it up.</span></span>
<span class="l"></span>
<a name=":c7ce:@_exit"></a><span class="l"><a class="anc" name="c7ce" href="#c7ce">[c7ce]</a><a href="#:c7ce:@_exit" class="lla">@_exit:</a><span class="ce">; [$c7ce]</span></span>
<span class="l"><a class="anc" name="c7ce" href="#c7ce">[c7ce]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpGlove"></a><div class="cp">;============================================================================
; Handle picking up the Glove.
;
; This will invoke the IScript, play the sound, and enable
; the Glove state.
;
; Picking up the glove awards 100XP.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_Add100XP">Player_Add100XP</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c7cf" href="#c7cf">[c7cf]</a><a href="#Player_PickUpGlove" class="la">Player_PickUpGlove:</a><span class="ce">; [$c7cf]</span></span>
<div class="c">;
; Run the "Got Glove" IScript.
;
; IScript 0x92 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c7cf" href="#c7cf">[c7cf]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$92</span></span><span class="ce">; 0x92 == Glove picked up IScript.</span></span>
<span class="l"><a class="anc" name="c7d1" href="#c7d1">[c7d1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c7d4" href="#c7d4">[c7d4]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c7d5" href="#c7d5">[c7d5]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c7d7:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c7d7" href="#c7d7">[c7d7]</a><a href="#:c7d7:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c7d7]</span></span>
<span class="l"><a class="anc" name="c7d7" href="#c7d7">[c7d7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c7d9" href="#c7d9">[c7d9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Activate the Glove by setting its duration, and then
; add 100XP to the player.
;
</div><span class="l"><a class="anc" name="c7dc" href="#c7dc">[c7dc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$14</span></span><span class="ce">; A = 20 seconds.</span></span>
<span class="l"><a class="anc" name="c7de" href="#c7de">[c7de]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Set as the Glove duration.</span></span>
<span class="l"><a class="anc" name="c7e1" href="#c7e1">[c7e1]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_Add100XP">Player_Add100XP</a></span></span><span class="ce">; Give the player 100XP.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpBlackOnyx"></a><div class="cp">;============================================================================
; Handle picking up the Black Onyx.
;
; This will invoke the IScript, play the sound, and add
; the Black Onyx to the special items inventory.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's special items.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The updated special items.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c7e4" href="#c7e4">[c7e4]</a><a href="#Player_PickUpBlackOnyx" class="la">Player_PickUpBlackOnyx:</a><span class="ce">; [$c7e4]</span></span>
<div class="c">;
; Run the "Got Black Onyx" IScript.
;
; IScript 0x8E via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c7e4" href="#c7e4">[c7e4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$8e</span></span><span class="ce">; 0x8E == Black Onyx picked up IScript.</span></span>
<span class="l"><a class="anc" name="c7e6" href="#c7e6">[c7e6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c7e9" href="#c7e9">[c7e9]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c7ea" href="#c7ea">[c7ea]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c7ec:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c7ec" href="#c7ec">[c7ec]</a><a href="#:c7ec:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c7ec]</span></span>
<span class="l"><a class="anc" name="c7ec" href="#c7ec">[c7ec]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c7ee" href="#c7ee">[c7ee]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the item to the player's special items list.
;
</div><span class="l"><a class="anc" name="c7f1" href="#c7f1">[c7f1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the current special items bitmask.</span></span>
<span class="l"><a class="anc" name="c7f4" href="#c7f4">[c7f4]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$01</span></span><span class="ce">; Bit 0x01 == Black Onyx.</span></span>
<span class="l"><a class="anc" name="c7f6" href="#c7f6">[c7f6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Save it back out.</span></span>
<span class="l"><a class="anc" name="c7f9" href="#c7f9">[c7f9]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpPendant"></a><div class="cp">;============================================================================
; Handle picking up the Pendant.
;
; This will invoke the IScript, play the sound, and add
; the Pendant to the special items inventory.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's special items.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The updated special items.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c7fa" href="#c7fa">[c7fa]</a><a href="#Player_PickUpPendant" class="la">Player_PickUpPendant:</a><span class="ce">; [$c7fa]</span></span>
<div class="c">;
; Run the "Got Glove" IScript.
;
; IScript 0x8F via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c7fa" href="#c7fa">[c7fa]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$8f</span></span><span class="ce">; 0x8F = Pendant picked up IScript.</span></span>
<span class="l"><a class="anc" name="c7fc" href="#c7fc">[c7fc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c7ff" href="#c7ff">[c7ff]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c800" href="#c800">[c800]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c802:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c802" href="#c802">[c802]</a><a href="#:c802:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c802]</span></span>
<span class="l"><a class="anc" name="c802" href="#c802">[c802]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 = Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c804" href="#c804">[c804]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the item to the player's special items list.
;
</div><span class="l"><a class="anc" name="c807" href="#c807">[c807]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the curent special items bitmask.</span></span>
<span class="l"><a class="anc" name="c80a" href="#c80a">[c80a]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$02</span></span><span class="ce">; Bit 0x02 == Pendant.</span></span>
<span class="l"><a class="anc" name="c80c" href="#c80c">[c80c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Save it back out.</span></span>
<span class="l"><a class="anc" name="c80f" href="#c80f">[c80f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpMagicalRod"></a><div class="cp">;============================================================================
; Handle picking up the Magical Rod.
;
; This will invoke the IScript, play the sound, and add
; the Magical Rod to the special items inventory.
;
; INPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The player's special items.
;
; OUTPUTS:
;     <a href="RAM.html#SpecialItems">SpecialItems</a>:
;         The updated special items.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c810" href="#c810">[c810]</a><a href="#Player_PickUpMagicalRod" class="la">Player_PickUpMagicalRod:</a><span class="ce">; [$c810]</span></span>
<div class="c">;
; Run the "Got Magical Rod" IScript.
;
; IScript 0x90 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c810" href="#c810">[c810]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$90</span></span><span class="ce">; 0x90 == Magical Rod picked up IScript.</span></span>
<span class="l"><a class="anc" name="c812" href="#c812">[c812]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c815" href="#c815">[c815]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c816" href="#c816">[c816]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c818:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c818" href="#c818">[c818]</a><a href="#:c818:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c818]</span></span>
<span class="l"><a class="anc" name="c818" href="#c818">[c818]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c81a" href="#c81a">[c81a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the Magical Rod to the inventory.
;
</div><span class="l"><a class="anc" name="c81d" href="#c81d">[c81d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the current special items bitmask.</span></span>
<span class="l"><a class="anc" name="c820" href="#c820">[c820]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$04</span></span><span class="ce">; Bit 0x04 == Magical Rod.</span></span>
<span class="l"><a class="anc" name="c822" href="#c822">[c822]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="c825" href="#c825">[c825]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpRedPotion"></a><div class="cp">;============================================================================
; Handle picking up the Red Potion.
;
; This will invoke the IScript, play the sound, and add
; the Red Potion to the inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     X:
;         Set to the current sprite index.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_PickUpItem">Player_PickUpItem</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c826" href="#c826">[c826]</a><a href="#Player_PickUpRedPotion" class="la">Player_PickUpRedPotion:</a><span class="ce">; [$c826]</span></span>
<div class="c">;
; Run the "Got Red Potion" IScript.
;
; IScript 0x87 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c826" href="#c826">[c826]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$87</span></span><span class="ce">; 0x87 == Red Potion picked up IScript.</span></span>
<span class="l"><a class="anc" name="c828" href="#c828">[c828]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c82b" href="#c82b">[c82b]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c82c" href="#c82c">[c82c]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c82e:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c82e" href="#c82e">[c82e]</a><a href="#:c82e:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c82e]</span></span>
<span class="l"><a class="anc" name="c82e" href="#c82e">[c82e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c830" href="#c830">[c830]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the Red Potion to the inventory.
;
</div><span class="l"><a class="anc" name="c833" href="#c833">[c833]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; 0x10 == Red Potion.</span></span>
<span class="l"><a class="anc" name="c835" href="#c835">[c835]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_PickUpItem">Player_PickUpItem</a></span></span><span class="ce">; Pick up the item.</span></span>
<span class="l"><a class="anc" name="c838" href="#c838">[c838]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index (restored?)</span></span>
<span class="l"><a class="anc" name="c83b" href="#c83b">[c83b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpPoison"></a><div class="cp">;============================================================================
; Handle picking up the Poison.
;
; This will invoke the IScript, play the sound, and decrease
; the player health.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     X:
;         Set to the current sprite index.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_ReduceHP">Player_ReduceHP</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c83c" href="#c83c">[c83c]</a><a href="#Player_PickUpPoison" class="la">Player_PickUpPoison:</a><span class="ce">; [$c83c]</span></span>
<div class="c">;
; Run the "Got Poison" IScript.
;
; IScript 0x91 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c83c" href="#c83c">[c83c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$91</span></span><span class="ce">; 0x91 = Poison picked up IScript.</span></span>
<span class="l"><a class="anc" name="c83e" href="#c83e">[c83e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c841" href="#c841">[c841]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c842" href="#c842">[c842]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c844:@_afterFarJump"></a><div class="c">;
; Play the sound effect for the player taking damage.
;
</div><span class="l"><a class="anc" name="c844" href="#c844">[c844]</a><a href="#:c844:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c844]</span></span>
<span class="l"><a class="anc" name="c844" href="#c844">[c844]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; 0x084 = Player took damage sound.</span></span>
<span class="l"><a class="anc" name="c846" href="#c846">[c846]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set temporary invincibility frames for the player.
;
</div><span class="l"><a class="anc" name="c849" href="#c849">[c849]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$3c</span></span><span class="ce">; A = 60 iframes</span></span>
<span class="l"><a class="anc" name="c84b" href="#c84b">[c84b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Set it as the starting invincibility phase.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Mark the player as hit.
;
</div><span class="l"><a class="anc" name="c84d" href="#c84d">[c84d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><a class="anc" name="c84f" href="#c84f">[c84f]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$02</span></span><span class="ce">; Bit 0x02 == Player was hit.</span></span>
<span class="l"><a class="anc" name="c851" href="#c851">[c851]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Remove 16 points from the player's health.
;
</div><span class="l"><a class="anc" name="c853" href="#c853">[c853]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="c855" href="#c855">[c855]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_L">Arg_PlayerHealthDelta_L</a></span></span><span class="ce">; Store as the lower byte of HP to remove.</span></span>
<span class="l"><a class="anc" name="c858" href="#c858">[c858]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><a class="anc" name="c85a" href="#c85a">[c85a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Arg_PlayerHealthDelta_U">Arg_PlayerHealthDelta_U</a></span></span><span class="ce">; Store as the upper byte of HP to remove.</span></span>
<span class="l"><a class="anc" name="c85d" href="#c85d">[c85d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_ReduceHP">Player_ReduceHP</a></span></span><span class="ce">; Reduce the HP by that amount.</span></span>
<span class="l"><a class="anc" name="c860" href="#c860">[c860]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSpriteIndex">CurrentSpriteIndex</a></span></span><span class="ce">; X = current sprite index (restored?)</span></span>
<span class="l"><a class="anc" name="c863" href="#c863">[c863]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpElixir"></a><div class="cp">;============================================================================
; Handle picking up the Elixir.
;
; This will invoke the IScript, play the sound, and add
; the Elixir to the special items inventory.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     X:
;         Set to the current sprite index.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c864" href="#c864">[c864]</a><a href="#Player_PickUpElixir" class="la">Player_PickUpElixir:</a><span class="ce">; [$c864]</span></span>
<div class="c">;
; Run the "Got Elixir" IScript.
;
; IScript 0x86 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c864" href="#c864">[c864]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$86</span></span><span class="ce">; 0x86 == Elixir picked up IScript.</span></span>
<span class="l"><a class="anc" name="c866" href="#c866">[c866]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c869" href="#c869">[c869]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c86a" href="#c86a">[c86a]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c86c:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c86c" href="#c86c">[c86c]</a><a href="#:c86c:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c86c]</span></span>
<span class="l"><a class="anc" name="c86c" href="#c86c">[c86c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c86e" href="#c86e">[c86e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the Elixir to the inventory.
;
</div><span class="l"><a class="anc" name="c871" href="#c871">[c871]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the current special items bitmask.</span></span>
<span class="l"><a class="anc" name="c874" href="#c874">[c874]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; Bit 0x08 == Elixir.</span></span>
<span class="l"><a class="anc" name="c876" href="#c876">[c876]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Save it back out.</span></span>
<span class="l"><a class="anc" name="c879" href="#c879">[c879]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpOintment"></a><div class="cp">;============================================================================
; Handle picking up the Ointment.
;
; This will invoke the IScript, play the sound, and set
; the Ointment state.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Player_Add100XP">Player_Add100XP</a>
;
; XREFS:
;     <a href="#Player_PickUp">Player_PickUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="c87a" href="#c87a">[c87a]</a><a href="#Player_PickUpOintment" class="la">Player_PickUpOintment:</a><span class="ce">; [$c87a]</span></span>
<div class="c">;
; Run "Got Ointment" IScript.
;
; IScript 0x94 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c87a" href="#c87a">[c87a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$94</span></span><span class="ce">; 0x94 == Ointment picked up IScript.</span></span>
<span class="l"><a class="anc" name="c87c" href="#c87c">[c87c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run IScript:</span></span>
<span class="l"><a class="anc" name="c87f" href="#c87f">[c87f]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c880" href="#c880">[c880]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c882:@_afterFarJump"></a><div class="c">;
; Play the sound effect for picking up an item.
;
</div><span class="l"><a class="anc" name="c882" href="#c882">[c882]</a><a href="#:c882:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$c882]</span></span>
<span class="l"><a class="anc" name="c882" href="#c882">[c882]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Item picked up sound.</span></span>
<span class="l"><a class="anc" name="c884" href="#c884">[c884]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Activate the Ointment by setting its duration, and then
; add 100XP to the player.
;
; Duration is initially set to a base of 30, but will be
; modified by level separately.
;
</div><span class="l"><a class="anc" name="c887" href="#c887">[c887]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$1e</span></span><span class="ce">; A = 30 seconds.</span></span>
<span class="l"><a class="anc" name="c889" href="#c889">[c889]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Set as the Ointment duration.</span></span>
<span class="l"><a class="anc" name="c88c" href="#c88c">[c88c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_Add100XP">Player_Add100XP</a></span></span><span class="ce">; Give the player 100XP.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_CountdownItems"></a><div class="cp">;============================================================================
; Count down all the player's special items.
;
; This will count down the Hour Glass, Wing Boots,
; Glove, and Ointment durations.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#Game_DecHourGlassDuration">Game_DecHourGlassDuration</a>
;     <a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a>
;     <a href="#Game_DecGloveDuration">Game_DecGloveDuration</a>
;     <a href="#Game_DecOintmentDuration">Game_DecOintmentDuration</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="c88f" href="#c88f">[c88f]</a><a href="#GameLoop_CountdownItems" class="la">GameLoop_CountdownItems:</a><span class="ce">; [$c88f]</span></span>
<span class="l"><a class="anc" name="c88f" href="#c88f">[c88f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DecHourGlassDuration">Game_DecHourGlassDuration</a></span></span></span>
<span class="l"><a class="anc" name="c892" href="#c892">[c892]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a></span></span></span>
<span class="l"><a class="anc" name="c895" href="#c895">[c895]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DecGloveDuration">Game_DecGloveDuration</a></span></span></span>
<span class="l"><a class="anc" name="c898" href="#c898">[c898]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_DecOintmentDuration">Game_DecOintmentDuration</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_DecGloveDuration"></a><div class="cp">;============================================================================
; Decrement the Glove's duration.
;
; INPUTS:
;     <a href="RAM.html#DurationGlove">DurationGlove</a>:
;         The remaining duration for the glove.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationGlove">DurationGlove</a>:
;         The new duration for the glove.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a class="anc" name="c89b" href="#c89b">[c89b]</a><a href="#Game_DecGloveDuration" class="la">Game_DecGloveDuration:</a><span class="ce">; [$c89b]</span></span>
<div class="c">;
; Check if the Glove is active.
;
</div><span class="l"><a class="anc" name="c89b" href="#c89b">[c89b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Load the Glove's duration.</span></span>
<span class="l"><a class="anc" name="c89e" href="#c89e">[c89e]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's 0xFF (not activated), return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if a second has passed.
;
</div><span class="l"><a class="anc" name="c8a0" href="#c8a0">[c8a0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c8a2" href="#c8a2">[c8a2]</a><span class="cd"><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if it's an even second boundary.</span></span>
<span class="l"><a class="anc" name="c8a4" href="#c8a4">[c8a4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Decrement and check if the Glove is still active.
;
</div><span class="l"><a class="anc" name="c8a6" href="#c8a6">[c8a6]</a><span class="cd"><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationGlove">DurationGlove</a></span></span><span class="ce">; Decrement the Glove's duration by 1 second.</span></span>
<span class="l"><a class="anc" name="c8a9" href="#c8a9">[c8a9]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's &gt;= 0, it's still active. Return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Countdown finished.
;
; Run "Glove is gone" IScript.
;
; IScript 0x93 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c8ab" href="#c8ab">[c8ab]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$93</span></span><span class="ce">; 0x93 == Glove is gone IScript.</span></span>
<span class="l"><a class="anc" name="c8ad" href="#c8ad">[c8ad]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="c8b0" href="#c8b0">[c8b0]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c8b1" href="#c8b1">[c8b1]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":c8b3:@_return"></a><span class="l"><a class="anc" name="c8b3" href="#c8b3">[c8b3]</a><a href="#:c8b3:@_return" class="lla">@_return:</a><span class="ce">; [$c8b3]</span></span>
<span class="l"><a class="anc" name="c8b3" href="#c8b3">[c8b3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_DecOintmentDuration"></a><div class="cp">;============================================================================
; Decrement the Ointment's duration.
;
; INPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The remaining duration for the Ointment.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The new duration for the Ointment.
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;============================================================================
</div><span class="l"><a class="anc" name="c8b4" href="#c8b4">[c8b4]</a><a href="#Game_DecOintmentDuration" class="la">Game_DecOintmentDuration:</a><span class="ce">; [$c8b4]</span></span>
<div class="c">;
; Check if the Ointment is active.
;
</div><span class="l"><a class="anc" name="c8b4" href="#c8b4">[c8b4]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Load the Ointment's duration.</span></span>
<span class="l"><a class="anc" name="c8b7" href="#c8b7">[c8b7]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's 0xFF (not activated), return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if a second has passed.
;
</div><span class="l"><a class="anc" name="c8b9" href="#c8b9">[c8b9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c8bb" href="#c8bb">[c8bb]</a><span class="cd"><span class="i">AND</span> <span class="o">#$3f</span></span><span class="ce">; Check if it's an even second boundary.</span></span>
<span class="l"><a class="anc" name="c8bd" href="#c8bd">[c8bd]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Decrement and check if the Ointment is still active.
;
</div><span class="l"><a class="anc" name="c8bf" href="#c8bf">[c8bf]</a><span class="cd"><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Decrement the Ointment's duration by 1 second.</span></span>
<span class="l"><a class="anc" name="c8c2" href="#c8c2">[c8c2]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If it's &gt;= 0, it's still active. Return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Countdown finished.
;
; Run "Ointment is gone" IScript.
;
; IScript 0x95 via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="c8c4" href="#c8c4">[c8c4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$95</span></span><span class="ce">; 0x95 == Ointment is gone IScript.</span></span>
<span class="l"><a class="anc" name="c8c6" href="#c8c6">[c8c6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="c8c9" href="#c8c9">[c8c9]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="c8ca" href="#c8ca">[c8ca]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":c8cc:@_return"></a><span class="l"><a class="anc" name="c8cc" href="#c8cc">[c8cc]</a><a href="#:c8cc:@_return" class="lla">@_return:</a><span class="ce">; [$c8cc]</span></span>
<span class="l"><a class="anc" name="c8cc" href="#c8cc">[c8cc]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_PickUpItem"></a><div class="cp">;============================================================================
; Pick up a standard item and place it in the inventory.
;
; This will be placed in the last available inventory slot.
; If the inventory is full, this does nothing.
;
; INPUTS:
;     A:
;         The ID of the item to place in the inventory.
;
;     <a href="RAM.html#NumberOfItems">NumberOfItems</a>:
;         The number of items the player has.
;
; OUTPUTS:
;     <a href="RAM.html#ItemInventory">ItemInventory</a>:
;         The updated item inventory.
;
;     <a href="RAM.html#NumberOfItems">NumberOfItems</a>:
;         The new number of items the player has.
;
; XREFS:
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMattock">Player_PickUpMattock</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;============================================================================
</div><span class="l"><a class="anc" name="c8cd" href="#c8cd">[c8cd]</a><a href="#Player_PickUpItem" class="la">Player_PickUpItem:</a><span class="ce">; [$c8cd]</span></span>
<div class="c">;
; Check first if the inventory is full.
;
</div><span class="l"><a class="anc" name="c8cd" href="#c8cd">[c8cd]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#NumberOfItems">NumberOfItems</a></span></span><span class="ce">; Load the number of items in the inventory.</span></span>
<span class="l"><a class="anc" name="c8d0" href="#c8d0">[c8d0]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$08</span></span><span class="ce">; Is there room?</span></span>
<span class="l"><a class="anc" name="c8d2" href="#c8d2">[c8d2]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If full, exit.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There's room. Set the item in the inventory and increment
; the item counter.
;
</div><span class="l"><a class="anc" name="c8d4" href="#c8d4">[c8d4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ItemInventory">ItemInventory</a>,X</span></span><span class="ce">; Store the item in the next available slot.</span></span>
<span class="l"><a class="anc" name="c8d7" href="#c8d7">[c8d7]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Set the next available slot.</span></span>
<span class="l"><a class="anc" name="c8d8" href="#c8d8">[c8d8]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#NumberOfItems">NumberOfItems</a></span></span></span>
<span class="l"></span>
<a name=":c8db:@_return"></a><span class="l"><a class="anc" name="c8db" href="#c8db">[c8db]</a><a href="#:c8db:@_return" class="lla">@_return:</a><span class="ce">; [$c8db]</span></span>
<span class="l"><a class="anc" name="c8db" href="#c8db">[c8db]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_ClearSelectedItemPic"></a><div class="cp">;============================================================================
; Clear the selected item picture from the HUD.
;
; This will loop through the 4 tiles of the selected item
; attribute area in the HUD, setting all to 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         New upper bounds of the PPU buffer.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#Player_ClearSelectedItem">Player_ClearSelectedItem</a>
;============================================================================
</div><span class="l"><a class="anc" name="c8dc" href="#c8dc">[c8dc]</a><a href="#UI_ClearSelectedItemPic" class="la">UI_ClearSelectedItemPic:</a><span class="ce">; [$c8dc]</span></span>
<div class="c">;
; Set the draw position to 0x13C0 (top-left of selected
; item tiles).
;
</div><span class="l"><a class="anc" name="c8dc" href="#c8dc">[c8dc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$13</span></span><span class="ce">; A = 0x13</span></span>
<span class="l"><a class="anc" name="c8de" href="#c8de">[c8de]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Set as upper byte.</span></span>
<span class="l"><a class="anc" name="c8e1" href="#c8e1">[c8e1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span><span class="ce">; A = 0xC0</span></span>
<span class="l"><a class="anc" name="c8e3" href="#c8e3">[c8e3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set as lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin the draw loop. This will draw 4 tiles of the sprite.
; All 4 tiles making up the sprite are adjacent within this
; tile attribute.
;
</div><span class="l"><a class="anc" name="c8e6" href="#c8e6">[c8e6]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$04</span></span><span class="ce">; X = 4 (counter).</span></span>
<span class="l"></span>
<a name=":c8e8:@_vertLoop"></a><span class="l"><a class="anc" name="c8e8" href="#c8e8">[c8e8]</a><a href="#:c8e8:@_vertLoop" class="lla">@_vertLoop:</a><span class="ce">; [$c8e8]</span></span>
<span class="l"><a class="anc" name="c8e8" href="#c8e8">[c8e8]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="c8e9" href="#c8e9">[c8e9]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the draw length as 16 bytes (this tile).
;
</div><span class="l"><a class="anc" name="c8ea" href="#c8ea">[c8ea]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><a class="anc" name="c8ec" href="#c8ec">[c8ec]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Write as the length.</span></span>
<span class="l"><a class="anc" name="c8ef" href="#c8ef">[c8ef]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16</span></span>
<span class="l"><a class="anc" name="c8f1" href="#c8f1">[c8f1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"></span>
<a name=":c8f3:@_horizLoop"></a><span class="l"><a class="anc" name="c8f3" href="#c8f3">[c8f3]</a><a href="#:c8f3:@_horizLoop" class="lla">@_horizLoop:</a><span class="ce">; [$c8f3]</span></span>
<span class="l"><a class="anc" name="c8f3" href="#c8f3">[c8f3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write a 0 to the PPU buffer.</span></span>
<span class="l"><a class="anc" name="c8f6" href="#c8f6">[c8f6]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="c8f7" href="#c8f7">[c8f7]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="c8f8" href="#c8f8">[c8f8]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_horizLoop">@_horizLoop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This row is finished. Prepare to draw the next (if any).
;
</div><span class="l"><a class="anc" name="c8fa" href="#c8fa">[c8fa]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store X as the new upper bounds.</span></span>
<span class="l"><a class="anc" name="c8fc" href="#c8fc">[c8fc]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; A = target address to draw to.</span></span>
<span class="l"><a class="anc" name="c8ff" href="#c8ff">[c8ff]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="c900" href="#c900">[c900]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Increment by 16 (next tile).</span></span>
<span class="l"><a class="anc" name="c902" href="#c902">[c902]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store as the new lower byte of the target address.</span></span>
<span class="l"><a class="anc" name="c905" href="#c905">[c905]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="c908" href="#c908">[c908]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry flag, if any.</span></span>
<span class="l"><a class="anc" name="c90a" href="#c90a">[c90a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; And save it.</span></span>
<span class="l"><a class="anc" name="c90d" href="#c90d">[c90d]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack (full 0..4 loop counter).</span></span>
<span class="l"><a class="anc" name="c90e" href="#c90e">[c90e]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="c90f" href="#c90f">[c90f]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="c910" href="#c910">[c910]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_vertLoop">@_vertLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"><a class="anc" name="c912" href="#c912">[c912]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_Init"></a><div class="cp">;============================================================================
; Main entry point for the game.
;
; This sets up the PPU, clears out the PPU buffer,
; initializes the MMC1 chip, the screen, the music,
; and then sets up the start splash screen.
;
; INPUTS:
;     {@symbl PPUSTATUS}:
;         Read to ensure writes occur in the right order.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_0200">Temp_0200</a>:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;     <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>:
;     <a href="RAM.html#CurrentSprites_InternalBehaviorStates">CurrentSprites_InternalBehaviorStates</a>:
;     <a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>:
;         Cleared.
;
;     <a href="RAM.html#PPUMASK">PPUMASK</a>:
;         Cleared.
;
;     <a href="RAM.html#PPUCTRL">PPUCTRL</a>:
;         Set to the initial flags for writing.
;
; CALLS:
;     <a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a>
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;     <a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_FinishGame">IScriptAction_FinishGame</a>
;============================================================================
</div><span class="l"><a class="anc" name="c913" href="#c913">[c913]</a><a href="#Game_Init" class="la">Game_Init:</a><span class="ce">; [$c913]</span></span>
<span class="l"><a class="anc" name="c913" href="#c913">[c913]</a><span class="cd"><span class="i">SEI</span></span></span>
<span class="l"><a class="anc" name="c914" href="#c914">[c914]</a><span class="cd"><span class="i">CLD</span></span></span>
<span class="l"><a class="anc" name="c915" href="#c915">[c915]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><a class="anc" name="c917" href="#c917">[c917]</a><span class="cd"><span class="i">TXS</span></span><span class="ce">; Push to stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the PPU settings.
;
; For PPUMASK:
;
; * Color
; * Show background and sprites in leftmost 8 pixels
;
;
; For PPUCTRL:
;
; * Base nametable address = 0x2000
; * VRAM address increment per CPU read/write: add 1, going across
; * Sprite pattern table address for 8x8 sprites: 0x1000
; * Background pattern table address: 0x1000
; * Sprite size: 8x8 pixels
; * PPU master/slave select: Read backdrop from EXT pins
; * Vblank NMI disabled
;
</div><span class="l"><a class="anc" name="c918" href="#c918">[c918]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="c91a" href="#c91a">[c91a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span><span class="ce">; Set as the PPU mask.</span></span>
<span class="l"><a class="anc" name="c91d" href="#c91d">[c91d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$18</span></span><span class="ce">; A = 0x18</span></span>
<span class="l"><a class="anc" name="c91f" href="#c91f">[c91f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Set as the PPU control.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the PPUSTATUS register several times before writing.
;
; NESdev says this is common to ensure writes occur in the
; correct order.
;
</div><span class="l"><a class="anc" name="c922" href="#c922">[c922]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span><span class="ce">; Read PPU status.</span></span>
<span class="l"></span>
<a name=":c925:@_readPPUStatus1"></a><span class="l"><a class="anc" name="c925" href="#c925">[c925]</a><a href="#:c925:@_readPPUStatus1" class="lla">@_readPPUStatus1:</a><span class="ce">; [$c925]</span></span>
<span class="l"><a class="anc" name="c925" href="#c925">[c925]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span><span class="ce">; Read PPU status.</span></span>
<span class="l"><a class="anc" name="c928" href="#c928">[c928]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_readPPUStatus1">@_readPPUStatus1</a></span></span><span class="ce">; If &gt; -1, loop.</span></span>
<span class="l"></span>
<a name=":c92a:@_readPPUStatus2"></a><span class="l"><a class="anc" name="c92a" href="#c92a">[c92a]</a><a href="#:c92a:@_readPPUStatus2" class="lla">@_readPPUStatus2:</a><span class="ce">; [$c92a]</span></span>
<span class="l"><a class="anc" name="c92a" href="#c92a">[c92a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span><span class="ce">; Read PPU status.</span></span>
<span class="l"><a class="anc" name="c92d" href="#c92d">[c92d]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_readPPUStatus2">@_readPPUStatus2</a></span></span><span class="ce">; If &gt; -1, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set PPUMASK to 0 to allow transferring large amounts of
; Data to VRAM.
;
</div><span class="l"><a class="anc" name="c92f" href="#c92f">[c92f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="c931" href="#c931">[c931]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span><span class="ce">; Set as the PPU mask.</span></span>
<span class="l"><a class="anc" name="c934" href="#c934">[c934]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><a class="anc" name="c936" href="#c936">[c936]</a><span class="cd"><span class="i">TXS</span></span><span class="ce">; Transfer to stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear RAM, setting all ranges of bytes used for state to 0.
;
</div><span class="l"><a class="anc" name="c937" href="#c937">[c937]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (loop counter)</span></span>
<span class="l"></span>
<a name=":c939:@_loop"></a><span class="l"><a class="anc" name="c939" href="#c939">[c939]</a><a href="#:c939:@_loop" class="lla">@_loop:</a><span class="ce">; [$c939]</span></span>
<span class="l"><a class="anc" name="c939" href="#c939">[c939]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$fc</span></span><span class="ce">; Is X &gt;= 252?</span></span>
<span class="l"><a class="anc" name="c93b" href="#c93b">[c93b]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_clearState">@_clearState</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><a class="anc" name="c93d" href="#c93d">[c93d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a>,X</span></span><span class="ce">; Clear memory at address X.</span></span>
<span class="l"></span>
<a name=":c93f:@_clearState"></a><span class="l"><a class="anc" name="c93f" href="#c93f">[c93f]</a><a href="#:c93f:@_clearState" class="lla">@_clearState:</a><span class="ce">; [$c93f]</span></span>
<span class="l"><a class="anc" name="c93f" href="#c93f">[c93f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_0200">Temp_0200</a>,X</span></span><span class="ce">; Clear memory at $0200 + X</span></span>
<span class="l"><a class="anc" name="c942" href="#c942">[c942]</a><span class="cd"><span class="i">STA</span> <span class="o">$0300,X</span></span><span class="ce">; Clear memory at $0300 + X</span></span>
<span class="l"><a class="anc" name="c945" href="#c945">[c945]</a><span class="cd"><span class="i">STA</span> <span class="o">$0400,X</span></span><span class="ce">; Clear memory at $0400 + X</span></span>
<span class="l"><a class="anc" name="c948" href="#c948">[c948]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Clear memory at $0500 + X</span></span>
<span class="l"><a class="anc" name="c94b" href="#c94b">[c94b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Clear memory at $0600 + X</span></span>
<span class="l"><a class="anc" name="c94e" href="#c94e">[c94e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Clear memory at $0700 + X</span></span>
<span class="l"><a class="anc" name="c951" href="#c951">[c951]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="c952" href="#c952">[c952]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X != 0, loop.</span></span>
<span class="l"><a class="anc" name="c954" href="#c954">[c954]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a></span></span><span class="ce">; Initialize the MMC1 chip and bank.</span></span>
<span class="l"><a class="anc" name="c957" href="#c957">[c957]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a></span></span><span class="ce">; Initialize the screen and music.</span></span>
<span class="l"><a class="anc" name="c95a" href="#c95a">[c95a]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a></span></span><span class="ce">; Initialize the start screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="OnInterrupt__updatePPUOAMAndAudio"></a><div class="c">;
; Check whether the OAM needs to be reset.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a class="anc" name="c95d" href="#c95d">[c95d]</a><a href="#OnInterrupt__updatePPUOAMAndAudio" class="la">OnInterrupt__updatePPUOAMAndAudio:</a><span class="ce">; [$c95d]</span></span>
<span class="l"><a class="anc" name="c95d" href="#c95d">[c95d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span><span class="ce">; Check the reset flag.</span></span>
<span class="l"><a class="anc" name="c95f" href="#c95f">[c95f]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#OnInterrupt__updatePPUAndAudio">OnInterrupt__updatePPUAndAudio</a></span></span><span class="ce">; If 0, don't reset. Jump to PPU/audio management.</span></span>
<span class="l"><a class="anc" name="c961" href="#c961">[c961]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c963" href="#c963">[c963]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMADDR">OAMADDR</a></span></span><span class="ce">; Reset OAMADDR to 0.</span></span>
<span class="l"><a class="anc" name="c966" href="#c966">[c966]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span><span class="ce">; Clear the reset flag.</span></span>
<span class="l"><a class="anc" name="c968" href="#c968">[c968]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="c96a" href="#c96a">[c96a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMDMA">OAMDMA</a></span></span><span class="ce">; Initialize the OAM, writing from $0700.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="OnInterrupt__updatePPUAndAudio"></a><div class="c">;
; Update the PPU.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a class="anc" name="c96d" href="#c96d">[c96d]</a><a href="#OnInterrupt__updatePPUAndAudio" class="la">OnInterrupt__updatePPUAndAudio:</a><span class="ce">; [$c96d]</span></span>
<span class="l"><a class="anc" name="c96d" href="#c96d">[c96d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a></span></span><span class="ce">; Run PPU on-interrupt handlers.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="OnInterrupt__updateAudio"></a><div class="c">;
; Update the audio so music keeps playing.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a class="anc" name="c970" href="#c970">[c970]</a><a href="#OnInterrupt__updateAudio" class="la">OnInterrupt__updateAudio:</a><span class="ce">; [$c970]</span></span>
<span class="l"><a class="anc" name="c970" href="#c970">[c970]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Increment the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c972" href="#c972">[c972]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="c975" href="#c975">[c975]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="c976" href="#c976">[c976]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="c978" href="#c978">[c978]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch to bank 5.</span></span>
<span class="l"><a class="anc" name="c97b" href="#c97b">[c97b]</a><span class="cd"><span class="i">JSR</span> <span class="o">$8009</span></span><span class="ce">; Run audio interrupt handlers.</span></span>
<span class="l"><a class="anc" name="c97e" href="#c97e">[c97e]</a><span class="cd"><span class="i">JSR</span> <span class="o">$8003</span></span><span class="ce">; Run sound playback interrupt handlers.</span></span>
<span class="l"><a class="anc" name="c981" href="#c981">[c981]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the bank from the stack.</span></span>
<span class="l"><a class="anc" name="c982" href="#c982">[c982]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="c983" href="#c983">[c983]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch back to the bank.</span></span>
<span class="l"><a class="anc" name="c986" href="#c986">[c986]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#OnInterrupt__popAndReturn">OnInterrupt__popAndReturn</a></span></span><span class="ce">; Prepare to exit the interrupt handler.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="OnInterrupt__noProcessInterrupts"></a><div class="c">;
; Main interrupt handling code won't be run. Update the
; paused interrupt counter state and clear the PPU mask
; to enable transfering large amounts of data to VRAM.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a class="anc" name="c989" href="#c989">[c989]</a><a href="#OnInterrupt__noProcessInterrupts" class="la">OnInterrupt__noProcessInterrupts:</a><span class="ce">; [$c989]</span></span>
<span class="l"><a class="anc" name="c989" href="#c989">[c989]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="c98b" href="#c98b">[c98b]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$02</span></span><span class="ce">; Is it &lt; 2?</span></span>
<span class="l"><a class="anc" name="c98d" href="#c98d">[c98d]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_clearPPUMask">@_clearPPUMask</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><a class="anc" name="c98f" href="#c98f">[c98f]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Increment the counter.</span></span>
<span class="l"></span>
<a name=":c991:@_clearPPUMask"></a><span class="l"><a class="anc" name="c991" href="#c991">[c991]</a><a href="#:c991:@_clearPPUMask" class="lla">@_clearPPUMask:</a><span class="ce">; [$c991]</span></span>
<span class="l"><a class="anc" name="c991" href="#c991">[c991]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c993" href="#c993">[c993]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span><span class="ce">; Clear PPUMASK.</span></span>
<span class="l"><a class="anc" name="c996" href="#c996">[c996]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#OnInterrupt__updateAudio">OnInterrupt__updateAudio</a></span></span><span class="ce">; Update the audio.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="OnInterrupt"></a><div class="cp">;============================================================================
; Main interrupt handler for the game.
;
; This controls PPU interactions, audio playback, and
; controller input. Normally, these will run every
; two frames.
;
; Processing of these can be enabled or disabled
; by other code as needed by other code by setting
; <a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a> and
; <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>.
;
; Even if main input handlers are disabled, this will
; generally write to the PPU and play audio (so music
; doesn't skip).
;
; INPUTS:
;     <a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a>:
;         Whether to run game state interrupt handlers.
;
;     <a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a>:
;         A counter indicating if interrupt handlers have
;         been paused (range 0..2).
;
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         The current frame toggle. Game state interrupt
;         handlers will only be run if 0.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter to increment.
;
;     <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>:
;         If &gt; 0, OAM will be reset.
;
; OUTPUTS:
;     <a href="RAM.html#PPUMASK">PPUMASK</a>:
;         May be cleared.
;
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         May be set to 1 to skip the next frame.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The updated interrupt counter.
;
;     <a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a>:
;         Incremented if interrupt handlers are paused
;         (capped to 2).
;
;     <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>:
;     <a href="RAM.html#OAMADDR">OAMADDR</a>
;         May be set to 0.
;
;     <a href="RAM.html#OAMDMA">OAMDMA</a>:
;         May be set to 7.
;
; CALLS:
;     <a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a>
;     <a href="PRG5.html#Music_HandleOnInterrupt">Music_HandleOnInterrupt</a>
;     <a href="#Input_HandleOnInterrupt">Input_HandleOnInterrupt</a>
;     <a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a>
;     <a href="PRG5.html#SoundEffects_HandleOnInterrupt">SoundEffects_HandleOnInterrupt</a>
;============================================================================
</div><span class="l"><a class="anc" name="c999" href="#c999">[c999]</a><a href="#OnInterrupt" class="la">OnInterrupt:</a><span class="ce">; [$c999]</span></span>
<div class="c">;
; Push all registers to the stack.
;
</div><span class="l"><a class="anc" name="c999" href="#c999">[c999]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><a class="anc" name="c99a" href="#c99a">[c99a]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; Set A = X.</span></span>
<span class="l"><a class="anc" name="c99b" href="#c99b">[c99b]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A (X) to the stack.</span></span>
<span class="l"><a class="anc" name="c99c" href="#c99c">[c99c]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; Set A = Y.</span></span>
<span class="l"><a class="anc" name="c99d" href="#c99d">[c99d]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A (Y) to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check what will be handled this interrupt.
;
</div><span class="l"><a class="anc" name="c99e" href="#c99e">[c99e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a></span></span><span class="ce">; Check whether interrupt handling code should be run.</span></span>
<span class="l"><a class="anc" name="c9a0" href="#c9a0">[c9a0]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#OnInterrupt__noProcessInterrupts">OnInterrupt__noProcessInterrupts</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Interrupts may be run. See if it's time to run them.
;
</div><span class="l"><a class="anc" name="c9a2" href="#c9a2">[c9a2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Check if we're on a frame where we should run interrupts.</span></span>
<span class="l"><a class="anc" name="c9a4" href="#c9a4">[c9a4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#OnInterrupt__updatePPUOAMAndAudio">OnInterrupt__updatePPUOAMAndAudio</a></span></span><span class="ce">; Jump to update the PPU, OAM, and Audio.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Ready to handle routine operations.
;
</div><span class="l"><a class="anc" name="c9a6" href="#c9a6">[c9a6]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Flip the toggle.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reset the OAM.
;
; This will write $00 to OAMADDR and then use OAMDMA.
;
</div><span class="l"><a class="anc" name="c9a8" href="#c9a8">[c9a8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c9aa" href="#c9aa">[c9aa]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMADDR">OAMADDR</a></span></span><span class="ce">; Clear OAMADDR.</span></span>
<span class="l"><a class="anc" name="c9ad" href="#c9ad">[c9ad]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span><span class="ce">; Turn off the reset flag.</span></span>
<span class="l"><a class="anc" name="c9af" href="#c9af">[c9af]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="c9b1" href="#c9b1">[c9b1]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#OAMDMA">OAMDMA</a></span></span><span class="ce">; Initialize the OAM, writing from <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a> ($0700).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the PPU state.
;
</div><span class="l"><a class="anc" name="c9b4" href="#c9b4">[c9b4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 5 (audio logic) and run audio updates.
;
</div><span class="l"><a class="anc" name="c9b7" href="#c9b7">[c9b7]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current bank.</span></span>
<span class="l"><a class="anc" name="c9ba" href="#c9ba">[c9ba]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="c9bb" href="#c9bb">[c9bb]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="c9bd" href="#c9bd">[c9bd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch to bank 5.</span></span>
<span class="l"><a class="anc" name="c9c0" href="#c9c0">[c9c0]</a><span class="cd"><span class="i">JSR</span> <span class="o">$8009</span></span><span class="ce">; Run audio interrupt handling code.</span></span>
<span class="l"><a class="anc" name="c9c3" href="#c9c3">[c9c3]</a><span class="cd"><span class="i">JSR</span> <span class="o">$8003</span></span><span class="ce">; Run sound playback interrupt handling code.</span></span>
<span class="l"><a class="anc" name="c9c6" href="#c9c6">[c9c6]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank from the stack.</span></span>
<span class="l"><a class="anc" name="c9c7" href="#c9c7">[c9c7]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="c9c8" href="#c9c8">[c9c8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_EnsurePRG">MMC1_EnsurePRG</a></span></span><span class="ce">; Switch back to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Handle input management and final state.
;
</div><span class="l"><a class="anc" name="c9cb" href="#c9cb">[c9cb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Input_HandleOnInterrupt">Input_HandleOnInterrupt</a></span></span><span class="ce">; Run input interrupt handlers.</span></span>
<span class="l"><a class="anc" name="c9ce" href="#c9ce">[c9ce]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Increment the interrupt counter.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="OnInterrupt__popAndReturn"></a><div class="c">;
; Restore all registers from the stack.
;
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;
</div><span class="l"><a class="anc" name="c9d0" href="#c9d0">[c9d0]</a><a href="#OnInterrupt__popAndReturn" class="la">OnInterrupt__popAndReturn:</a><span class="ce">; [$c9d0]</span></span>
<span class="l"><a class="anc" name="c9d0" href="#c9d0">[c9d0]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="c9d1" href="#c9d1">[c9d1]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Set Y = A</span></span>
<span class="l"><a class="anc" name="c9d2" href="#c9d2">[c9d2]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="c9d3" href="#c9d3">[c9d3]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set X = A</span></span>
<span class="l"><a class="anc" name="c9d4" href="#c9d4">[c9d4]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the satck</span></span>
<span class="l"></span>
<a name="OnHardwareInterrupt"></a><span class="l"><a class="anc" name="c9d5" href="#c9d5">[c9d5]</a><a href="#OnHardwareInterrupt" class="la">OnHardwareInterrupt:</a><span class="ce">; [$c9d5]</span></span>
<span class="l"><a class="anc" name="c9d5" href="#c9d5">[c9d5]</a><span class="cd"><span class="i">RTI</span></span><span class="ce">; Return from interrupt</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_HandleOnInterrupt"></a><div class="cp">;============================================================================
; Update the PPU on interrupt.
;
; This will run any screen scroll handlers, ensure the right
; PPU flags pertaining to scroll, and then set the new scroll
; screen and offsets.
;
; INPUTS:
;     <a href="RAM.html#PPU_Mask">PPU_Mask</a>:
;         The screen mask to set.
;
;     <a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a>:
;         The saved PPU control flags.
;
;     <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a>:
;         The current sprite 0 placement mode for the
;         screen, dictating the flags to set.
;
;     <a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a>:
;         The scroll screen to set.
;
;     <a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a>:
;         The horizontal scroll offset to set.
;
; OUTPUTS:
;     <a href="RAM.html#PPUCTRL">PPUCTRL</a>:
;     <a href="RAM.html#PPUMASK">PPUMASK</a>:
;     <a href="RAM.html#PPUSCROLL">PPUSCROLL</a>:
;         The updated PPU state.
;
; CALLS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;     <a href="#Screen_RunWriteScrollDataHandler">Screen_RunWriteScrollDataHandler</a>
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;============================================================================
</div><span class="l"><a class="anc" name="c9d6" href="#c9d6">[c9d6]</a><a href="#PPU_HandleOnInterrupt" class="la">PPU_HandleOnInterrupt:</a><span class="ce">; [$c9d6]</span></span>
<div class="c">;
; Handle any scrolling-related screen updates and flush
; the PPU buffer to the screen.
;
</div><span class="l"><a class="anc" name="c9d6" href="#c9d6">[c9d6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_RunWriteScrollDataHandler">Screen_RunWriteScrollDataHandler</a></span></span><span class="ce">; Run the handler for any screen scrolling.</span></span>
<span class="l"><a class="anc" name="c9d9" href="#c9d9">[c9d9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span><span class="ce">; Flush the PPU buffer to the screen.</span></span>
<span class="l"><a class="anc" name="c9dc" href="#c9dc">[c9dc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_Mask">PPU_Mask</a></span></span><span class="ce">; Load the stored PPU mask.</span></span>
<span class="l"><a class="anc" name="c9de" href="#c9de">[c9de]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUMASK">PPUMASK</a></span></span><span class="ce">; And set it on the PPU.</span></span>
<span class="l"><a class="anc" name="c9e1" href="#c9e1">[c9e1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a></span></span><span class="ce">; Load the sprite 0 mode.</span></span>
<span class="l"><a class="anc" name="c9e3" href="#c9e3">[c9e3]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_setScroll">@_setScroll</a></span></span><span class="ce">; If 0xFF (no sprite 0), jump.</span></span>
<span class="l"><a class="anc" name="c9e5" href="#c9e5">[c9e5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span><span class="ce">; Load the Force Lower Pattern Tables setting.</span></span>
<span class="l"><a class="anc" name="c9e7" href="#c9e7">[c9e7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_clearNametable2400">@_clearNametable2400</a></span></span><span class="ce">; If not forcing, then jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the following flags:
;
; * Nametable 2400
; * Sprite pattern 1000
; * BGTable Addr 1000
;
</div><span class="l"><a class="anc" name="c9e9" href="#c9e9">[c9e9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; Load the saved PPU control flags.</span></span>
<span class="l"><a class="anc" name="c9eb" href="#c9eb">[c9eb]</a><span class="cd"><span class="i">AND</span> <span class="o">#$e6</span></span><span class="ce">; Clear flags.</span></span>
<span class="l"><a class="anc" name="c9ed" href="#c9ed">[c9ed]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Set it on the PPU.</span></span>
<span class="l"><a class="anc" name="c9f0" href="#c9f0">[c9f0]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_resetScroll">@_resetScroll</a></span></span><span class="ce">; Jump to update scroll positions.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c9f3:@_clearNametable2400"></a><div class="c">;
; Clear the Nametable 2400 flag.
;
</div><span class="l"><a class="anc" name="c9f3" href="#c9f3">[c9f3]</a><a href="#:c9f3:@_clearNametable2400" class="lla">@_clearNametable2400:</a><span class="ce">; [$c9f3]</span></span>
<span class="l"><a class="anc" name="c9f3" href="#c9f3">[c9f3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span></span>
<span class="l"><a class="anc" name="c9f5" href="#c9f5">[c9f5]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fe</span></span></span>
<span class="l"><a class="anc" name="c9f7" href="#c9f7">[c9f7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":c9fa:@_resetScroll"></a><div class="c">;
; Reset the screen scroll.
;
</div><span class="l"><a class="anc" name="c9fa" href="#c9fa">[c9fa]</a><a href="#:c9fa:@_resetScroll" class="lla">@_resetScroll:</a><span class="ce">; [$c9fa]</span></span>
<span class="l"><a class="anc" name="c9fa" href="#c9fa">[c9fa]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="c9fc" href="#c9fc">[c9fc]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span><span class="ce">; Clear horizontal screen scroll.</span></span>
<span class="l"><a class="anc" name="c9ff" href="#c9ff">[c9ff]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span><span class="ce">; Clear vertical screen scroll.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ca02:@_waitSprite0NotHitLoop"></a><div class="c">;
; Wait until sprite 0 isn't hit in the sprite update.
;
</div><span class="l"><a class="anc" name="ca02" href="#ca02">[ca02]</a><a href="#:ca02:@_waitSprite0NotHitLoop" class="lla">@_waitSprite0NotHitLoop:</a><span class="ce">; [$ca02]</span></span>
<span class="l"><a class="anc" name="ca02" href="#ca02">[ca02]</a><span class="cd"><span class="i">BIT</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span><span class="ce">; Test the Sprite 0 Hit flag.</span></span>
<span class="l"><a class="anc" name="ca05" href="#ca05">[ca05]</a><span class="cd"><span class="i">BVS</span> <span class="o"><a href="#@_waitSprite0NotHitLoop">@_waitSprite0NotHitLoop</a></span></span><span class="ce">; If set, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ca07:@_waitSprite0Hit"></a><div class="c">;
; Now wait until it is hit.
;
</div><span class="l"><a class="anc" name="ca07" href="#ca07">[ca07]</a><a href="#:ca07:@_waitSprite0Hit" class="lla">@_waitSprite0Hit:</a><span class="ce">; [$ca07]</span></span>
<span class="l"><a class="anc" name="ca07" href="#ca07">[ca07]</a><span class="cd"><span class="i">BIT</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span><span class="ce">; Test the Sprite 0 Hit flag.</span></span>
<span class="l"><a class="anc" name="ca0a" href="#ca0a">[ca0a]</a><span class="cd"><span class="i">BVC</span> <span class="o"><a href="#@_waitSprite0Hit">@_waitSprite0Hit</a></span></span><span class="ce">; if not set, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Loop 160 times, giving the screen time to update.
;
</div><span class="l"><a class="anc" name="ca0c" href="#ca0c">[ca0c]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$a0</span></span><span class="ce">; X = 160 (loop counter).</span></span>
<span class="l"></span>
<a name=":ca0e:@_loop160Times"></a><span class="l"><a class="anc" name="ca0e" href="#ca0e">[ca0e]</a><a href="#:ca0e:@_loop160Times" class="lla">@_loop160Times:</a><span class="ce">; [$ca0e]</span></span>
<span class="l"><a class="anc" name="ca0e" href="#ca0e">[ca0e]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="ca0f" href="#ca0f">[ca0f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop160Times">@_loop160Times</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ca11:@_setScroll"></a><div class="c">;
; Set the scroll state for the PPU.
;
; This will set the nametable for the scroll screen and
; set the horizontal scroll offset. Vertical will stay 0.
;
</div><span class="l"><a class="anc" name="ca11" href="#ca11">[ca11]</a><a href="#:ca11:@_setScroll" class="lla">@_setScroll:</a><span class="ce">; [$ca11]</span></span>
<span class="l"><a class="anc" name="ca11" href="#ca11">[ca11]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span><span class="ce">; Load the current scroll screen.</span></span>
<span class="l"><a class="anc" name="ca13" href="#ca13">[ca13]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Convert to an even/odd value (0 or 1) to select the nametable.</span></span>
<span class="l"><a class="anc" name="ca15" href="#ca15">[ca15]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; OR with the PPU controls.</span></span>
<span class="l"><a class="anc" name="ca17" href="#ca17">[ca17]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Store as the new PPU control flags.</span></span>
<span class="l"><a class="anc" name="ca1a" href="#ca1a">[ca1a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span><span class="ce">; Load the calculated scroll X.</span></span>
<span class="l"><a class="anc" name="ca1c" href="#ca1c">[ca1c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span><span class="ce">; Write as the horizontal scroll offset.</span></span>
<span class="l"><a class="anc" name="ca1f" href="#ca1f">[ca1f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Hard-code scroll Y as 0.</span></span>
<span class="l"><a class="anc" name="ca21" href="#ca21">[ca21]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUSCROLL">PPUSCROLL</a></span></span><span class="ce">; Write as the vertical scroll offset.</span></span>
<span class="l"><a class="anc" name="ca24" href="#ca24">[ca24]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="WaitForNextFrame"></a><div class="cp">;============================================================================
; Wait for the next frame.
;
; This will wait for the next frame, looping until
; the frame change occurs.
;
; INPUTS:
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         The frame toggle flag.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;     <a href="PRG12.html#PasswordScreen_HandleWrongPasswordAndWaitForInput">PasswordScreen_HandleWrongPasswordAndWaitForInput</a>
;     <a href="PRG12.html#PasswordScreen_WaitForInput">PasswordScreen_WaitForInput</a>
;     <a href="PRG12.html#PlayerMenu_HandleInventoryMenuInput">PlayerMenu_HandleInventoryMenuInput</a>
;     <a href="PRG12.html#PlayerMenu_Show">PlayerMenu_Show</a>
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;     <a href="PRG12.html#PlayerMenu_ShowSubmenu">PlayerMenu_ShowSubmenu</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#SplashAnimation_RunOutro">SplashAnimation_RunOutro</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;     <a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a>
;     <a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a>
;     <a href="#Game_SetupNewArea">Game_SetupNewArea</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a class="anc" name="ca25" href="#ca25">[ca25]</a><a href="#WaitForNextFrame" class="la">WaitForNextFrame:</a><span class="ce">; [$ca25]</span></span>
<span class="l"><a class="anc" name="ca25" href="#ca25">[ca25]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="ca27" href="#ca27">[ca27]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Set as the frame toggle state.</span></span>
<span class="l"></span>
<a name=":ca29:@_loop"></a><span class="l"><a class="anc" name="ca29" href="#ca29">[ca29]</a><a href="#:ca29:@_loop" class="lla">@_loop:</a><span class="ce">; [$ca29]</span></span>
<span class="l"><a class="anc" name="ca29" href="#ca29">[ca29]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Load the frame toggle state from the interrupt handler.</span></span>
<span class="l"><a class="anc" name="ca2b" href="#ca2b">[ca2b]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If it's 0, loop.</span></span>
<span class="l"><a class="anc" name="ca2d" href="#ca2d">[ca2d]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="WaitForInterrupt"></a><div class="cp">;============================================================================
; Wait for the next interrupt.
;
; This will loop until the interrupt counter has changed.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The interrupt counter.
;
; OUTTPUTS:
;     None
;
; XREFS:
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;============================================================================
</div><span class="l"><a class="anc" name="ca2e" href="#ca2e">[ca2e]</a><a href="#WaitForInterrupt" class="la">WaitForInterrupt:</a><span class="ce">; [$ca2e]</span></span>
<span class="l"><a class="anc" name="ca2e" href="#ca2e">[ca2e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt count.</span></span>
<span class="l"></span>
<a name=":ca30:@_loop"></a><span class="l"><a class="anc" name="ca30" href="#ca30">[ca30]</a><a href="#:ca30:@_loop" class="lla">@_loop:</a><span class="ce">; [$ca30]</span></span>
<span class="l"><a class="anc" name="ca30" href="#ca30">[ca30]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Has the interrupt counter changed?</span></span>
<span class="l"><a class="anc" name="ca32" href="#ca32">[ca32]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="ca34" href="#ca34">[ca34]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Input_HandleOnInterrupt"></a><div class="cp">;============================================================================
; Handle input management on interrupt.
;
; This will read from the controller ports, storing
; the current button bitmasks and determining which buttons
; have been held down and which have changed since the last
; time the interrupt handler was run.
;
; Controller 2 is read for the purpose of the debug level
; switch code at <a href="#Debug_ChooseArea">Debug_ChooseArea</a>.
;
; INPUTS:
;     <a href="RAM.html#JOY1">JOY1</a>:
;     <a href="RAM.html#JOY2">JOY2</a>:
;         The controller inputs.
;
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The previous controller 1 button mask.
;
; OUTPUTS:
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The new controller 1 button mask.
;
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The buttons that changed since the last interrupt.
;
;     <a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a>:
;         The buttons held down since last interrupt.
;
;     <a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a>:
;         The new controller 2 button mask.
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;============================================================================
</div><span class="l"><a class="anc" name="ca35" href="#ca35">[ca35]</a><a href="#Input_HandleOnInterrupt" class="la">Input_HandleOnInterrupt:</a><span class="ce">; [$ca35]</span></span>
<div class="c">;
; Store the current button mask as the new previous button mask.
;
</div><span class="l"><a class="anc" name="ca35" href="#ca35">[ca35]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; A = Stored controller 1 button mask</span></span>
<span class="l"><a class="anc" name="ca37" href="#ca37">[ca37]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a></span></span><span class="ce">; Store as the previous button mask.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare to read the controller state.
;
</div><span class="l"><a class="anc" name="ca39" href="#ca39">[ca39]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; A = 1</span></span>
<span class="l"><a class="anc" name="ca3b" href="#ca3b">[ca3b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#JOY1">JOY1</a></span></span><span class="ce">; Trigger loading controller 1 bits.</span></span>
<span class="l"><a class="anc" name="ca3e" href="#ca3e">[ca3e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ca40" href="#ca40">[ca40]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#JOY1">JOY1</a></span></span><span class="ce">; Prepare for read.</span></span>
<span class="l"><a class="anc" name="ca43" href="#ca43">[ca43]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Reset controller 1 button mask to 0.</span></span>
<span class="l"><a class="anc" name="ca45" href="#ca45">[ca45]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a></span></span><span class="ce">; Reset controller 2 button mask to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the controller 1 state into the button mask.
;
</div><span class="l"><a class="anc" name="ca47" href="#ca47">[ca47]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; X = 8 (loop counter)</span></span>
<span class="l"></span>
<a name=":ca49:@_loop1"></a><span class="l"><a class="anc" name="ca49" href="#ca49">[ca49]</a><a href="#:ca49:@_loop1" class="lla">@_loop1:</a><span class="ce">; [$ca49]</span></span>
<span class="l"><a class="anc" name="ca49" href="#ca49">[ca49]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#JOY1">JOY1</a></span></span><span class="ce">; A = Current controller 1 state.</span></span>
<span class="l"><a class="anc" name="ca4c" href="#ca4c">[ca4c]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Take the first two bits.</span></span>
<span class="l"><a class="anc" name="ca4e" href="#ca4e">[ca4e]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift right 1. Bit 0 goes into Carry.</span></span>
<span class="l"><a class="anc" name="ca4f" href="#ca4f">[ca4f]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Rotate the target bitmask left, moving Carry into bit 0.</span></span>
<span class="l"><a class="anc" name="ca51" href="#ca51">[ca51]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; OR to the generated bitmask.</span></span>
<span class="l"><a class="anc" name="ca53" href="#ca53">[ca53]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Store as the new button mask.</span></span>
<span class="l"><a class="anc" name="ca55" href="#ca55">[ca55]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="ca56" href="#ca56">[ca56]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop1">@_loop1</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the controller 2 state into the button mask.
;
; This is only used for the debug level skip code.
;
</div><span class="l"><a class="anc" name="ca58" href="#ca58">[ca58]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; X = 8 (loop counter).</span></span>
<span class="l"></span>
<a name=":ca5a:@_loop2"></a><span class="l"><a class="anc" name="ca5a" href="#ca5a">[ca5a]</a><a href="#:ca5a:@_loop2" class="lla">@_loop2:</a><span class="ce">; [$ca5a]</span></span>
<span class="l"><a class="anc" name="ca5a" href="#ca5a">[ca5a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#JOY2">JOY2</a></span></span><span class="ce">; A = Current controller 2 state.</span></span>
<span class="l"><a class="anc" name="ca5d" href="#ca5d">[ca5d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Take the first bit.</span></span>
<span class="l"><a class="anc" name="ca5f" href="#ca5f">[ca5f]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift right 1. Bit 0 goes into Carry.</span></span>
<span class="l"><a class="anc" name="ca60" href="#ca60">[ca60]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a></span></span><span class="ce">; Rotate the target bitmask left, moving Carry into bit 0.</span></span>
<span class="l"><a class="anc" name="ca62" href="#ca62">[ca62]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="ca63" href="#ca63">[ca63]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop2">@_loop2</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the changed button mask between the last read and now.
;
</div><span class="l"><a class="anc" name="ca65" href="#ca65">[ca65]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Load the controller 1 button mask.</span></span>
<span class="l"><a class="anc" name="ca67" href="#ca67">[ca67]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a></span></span><span class="ce">; XOR with the previously-changed, yielding the button differences.</span></span>
<span class="l"><a class="anc" name="ca69" href="#ca69">[ca69]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; AND with the new button mask.</span></span>
<span class="l"><a class="anc" name="ca6b" href="#ca6b">[ca6b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; And store as the changed button mask.</span></span>
<span class="l"><a class="anc" name="ca6d" href="#ca6d">[ca6d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GetRandom"></a><div class="cp">;============================================================================
; Return a pseudo-random value.
;
; Every time this is called, a new pseudo-random value will
; be returned.
;
; The set of random values is the first 256 bytes of bank
; 14. If any buttons are pressed, the button bitmask will
; affect the random value (the result value and button
; bitmask is XOR'd).
;
; INPUTS:
;     <a href="RAM.html#Random_Offset">Random_Offset</a>:
;         The current offset into the bank.
;
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The controller 1 button mask.
;
; OUTPUTS:
;     A:
;         The pseudo-random value.
;
;     <a href="RAM.html#Random_Offset">Random_Offset</a>:
;         The incremented offset (which will wrap from 0xFF
;         to 0x00).
;
; XREFS:
;     <a href="PRG14.html#BScript_Action_RandomlyFlipXDirection">BScript_Action_RandomlyFlipXDirection</a>
;     <a href="PRG14.html#BScript_Action_RandomlyFlipYDirection">BScript_Action_RandomlyFlipYDirection</a>
;============================================================================
</div><span class="l"><a class="anc" name="ca6e" href="#ca6e">[ca6e]</a><a href="#GetRandom" class="la">GetRandom:</a><span class="ce">; [$ca6e]</span></span>
<span class="l"><a class="anc" name="ca6e" href="#ca6e">[ca6e]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Random_Offset">Random_Offset</a></span></span><span class="ce">; Load the current offset into the bank.</span></span>
<span class="l"><a class="anc" name="ca70" href="#ca70">[ca70]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a>,X</span></span><span class="ce">; Load the byte value at that offset.</span></span>
<span class="l"><a class="anc" name="ca73" href="#ca73">[ca73]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; XOR with the controler 1 button mask.</span></span>
<span class="l"><a class="anc" name="ca75" href="#ca75">[ca75]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Random_Offset">Random_Offset</a></span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><a class="anc" name="ca77" href="#ca77">[ca77]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_InitScreenAndMusic"></a><div class="cp">;============================================================================
; Initialize all the game state.
;
; This is called early at startup to set initial state
; for the game, including the PPU, scroll positions,
; PPU attribute tables, sound, sound effects, pause flag,
; and more.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a>:
;         The updated PPU control flags.
;
;     <a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a>:
;         The scroll X position (set to 0).
;
;     <a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a>:
;         The scroll Y position (set to 0).
;
;     <a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a>:
;         The new scroll screen (set to 0).
;
;     <a href="RAM.html#PPU_Mask">PPU_Mask</a>:
;         The new screen color mode.
;
;     <a href="RAM.html#Game_PausedState">Game_PausedState</a>:
;         Set to 0 (false).
;
;     <a href="RAM.html#Maybe_Game_Ready">Maybe_Game_Ready</a>:
;         Set to 0 (false).
;
;     <a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a>:
;         Set to 0 (false).
;
;     <a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a>:
;         Set to 0 (false).
;
;     <a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a>:
;         Set to 0 (false).
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a>
;     <a href="#PPU_InitVBlank">PPU_InitVBlank</a>
;     <a href="#Screen_ResetSpritesForNonGame">Screen_ResetSpritesForNonGame</a>
;     <a href="PRG5.html#thunk_SoundEffects_Init">thunk_SoundEffects_Init</a>
;     <a href="PRG5.html#thunk_Audio_InitPlayingState">thunk_Audio_InitPlayingState</a>
;
; XREFS:
;     <a href="#Game_Init">Game_Init</a>
;============================================================================
</div><span class="l"><a class="anc" name="ca78" href="#ca78">[ca78]</a><a href="#Game_InitScreenAndMusic" class="la">Game_InitScreenAndMusic:</a><span class="ce">; [$ca78]</span></span>
<div class="c">;
; Initialize PPU settings.
;
</div><span class="l"><a class="anc" name="ca78" href="#ca78">[ca78]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="ca7a" href="#ca7a">[ca7a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; Set PPU control flags to BGTable and Address $1000.</span></span>
<span class="l"><a class="anc" name="ca7c" href="#ca7c">[ca7c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ca7e" href="#ca7e">[ca7e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span><span class="ce">; Clear scroll X.</span></span>
<span class="l"><a class="anc" name="ca80" href="#ca80">[ca80]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span><span class="ce">; Clear scroll screen.</span></span>
<span class="l"><a class="anc" name="ca82" href="#ca82">[ca82]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span><span class="ce">; Clear scroll Y.</span></span>
<span class="l"><a class="anc" name="ca84" href="#ca84">[ca84]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$1e</span></span></span>
<span class="l"><a class="anc" name="ca86" href="#ca86">[ca86]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_Mask">PPU_Mask</a></span></span><span class="ce">; Set screen color mode to enable sprites, BG, and showing left-most 8 pixels.</span></span>
<span class="l"><a class="anc" name="ca88" href="#ca88">[ca88]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForNonGame">Screen_ResetSpritesForNonGame</a></span></span><span class="ce">; Reset sprites for a non-game screen.</span></span>
<span class="l"><a class="anc" name="ca8b" href="#ca8b">[ca8b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a></span></span><span class="ce">; Initialize attributes and nametables.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Stop any interrupt handling for the game.
;
</div><span class="l"><a class="anc" name="ca8e" href="#ca8e">[ca8e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ca90" href="#ca90">[ca90]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a></span></span><span class="ce">; Disable interrupt handlers.</span></span>
<span class="l"><a class="anc" name="ca92" href="#ca92">[ca92]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Maybe_Game_Ready">Maybe_Game_Ready</a></span></span><span class="ce">; Disable the game ready state.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 5 and set up sound.
;
</div><span class="l"><a class="anc" name="ca95" href="#ca95">[ca95]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="ca98" href="#ca98">[ca98]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ca99" href="#ca99">[ca99]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$05</span></span><span class="ce">; Bank 5 = Sound.</span></span>
<span class="l"><a class="anc" name="ca9b" href="#ca9b">[ca9b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to it.</span></span>
<span class="l"><a class="anc" name="ca9e" href="#ca9e">[ca9e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="RAM.html#EOLIS_BLOCKS">EOLIS_BLOCKS</a></span></span><span class="ce">; Initialize the sound play state.</span></span>
<span class="l"><a class="anc" name="caa1" href="#caa1">[caa1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Initialize sound.</span></span>
<span class="l"><a class="anc" name="caa4" href="#caa4">[caa4]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank from the stack.</span></span>
<span class="l"><a class="anc" name="caa5" href="#caa5">[caa5]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = previous bank.</span></span>
<span class="l"><a class="anc" name="caa6" href="#caa6">[caa6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Re-enable the game.
;
</div><span class="l"><a class="anc" name="caa9" href="#caa9">[caa9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="caab" href="#caab">[caab]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptsHandledLatch">Game_InterruptsHandledLatch</a></span></span><span class="ce">; Disable the interrupt handlers latch.</span></span>
<span class="l"><a class="anc" name="caad" href="#caad">[caad]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Game_PausedState">Game_PausedState</a></span></span><span class="ce">; Disable the pause state.</span></span>
<span class="l"><a class="anc" name="cab0" href="#cab0">[cab0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span><span class="ce">; Disable forcing lower pattern tables.</span></span>
<span class="l"><a class="anc" name="cab2" href="#cab2">[cab2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPU_InitVBlank">PPU_InitVBlank</a></span></span><span class="ce">; Initialize VBlank.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_SetAddr"></a><div class="cp">;============================================================================
; Set the PPU address to the specified value.
;
; INPUTS:
;     A:
;         The upper byte of the address.
;
;     X:
;         The lower byte of the address.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The updated address.
;
; XREFS:
;     <a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a>
;============================================================================
</div><span class="l"><a class="anc" name="cab5" href="#cab5">[cab5]</a><a href="#PPU_SetAddr" class="la">PPU_SetAddr:</a><span class="ce">; [$cab5]</span></span>
<span class="l"><a class="anc" name="cab5" href="#cab5">[cab5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set the upper byte.</span></span>
<span class="l"><a class="anc" name="cab8" href="#cab8">[cab8]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set the lower byte.</span></span>
<span class="l"><a class="anc" name="cabb" href="#cabb">[cabb]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="PPU_InitAttributeAndNameTables"></a><div class="cp">;============================================================================
; TODO: Document PPU_InitAttributeAndNameTables
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;============================================================================
</div><span class="l"><a class="anc" name="cabc" href="#cabc">[cabc]</a><a href="#PPU_InitAttributeAndNameTables" class="la">PPU_InitAttributeAndNameTables:</a><span class="ce">; [$cabc]</span></span>
<span class="l"><a class="anc" name="cabc" href="#cabc">[cabc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="cabe" href="#cabe">[cabe]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_PPU_NameTableValue">Temp_PPU_NameTableValue</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set address 0x2000: Name table 0.
;
; Write 32 to 8 bytes.
;
</div><span class="l"><a class="anc" name="cac0" href="#cac0">[cac0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="cac2" href="#cac2">[cac2]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cac4" href="#cac4">[cac4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddr">PPU_SetAddr</a></span></span></span>
<span class="l"><a class="anc" name="cac7" href="#cac7">[cac7]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="cac9" href="#cac9">[cac9]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cacb" href="#cacb">[cacb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_PPU_NameTableValue">Temp_PPU_NameTableValue</a></span></span></span>
<span class="l"><a class="anc" name="cacd" href="#cacd">[cacd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set address 0x23C0: Attribute table 0.
;
; Write 64 entries of byte 0x55 to the table. This is color bit 01
; for each quadrant of each sprite.
;
</div><span class="l"><a class="anc" name="cad0" href="#cad0">[cad0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$23</span></span></span>
<span class="l"><a class="anc" name="cad2" href="#cad2">[cad2]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="cad4" href="#cad4">[cad4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddr">PPU_SetAddr</a></span></span></span>
<span class="l"><a class="anc" name="cad7" href="#cad7">[cad7]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="cad9" href="#cad9">[cad9]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cadb" href="#cadb">[cadb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$55</span></span></span>
<span class="l"><a class="anc" name="cadd" href="#cadd">[cadd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set address 0x27C0: Attribute table 1.
;
; Write 64 entries here with the same information.
;
</div><span class="l"><a class="anc" name="cae0" href="#cae0">[cae0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$27</span></span></span>
<span class="l"><a class="anc" name="cae2" href="#cae2">[cae2]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="cae4" href="#cae4">[cae4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddr">PPU_SetAddr</a></span></span></span>
<span class="l"><a class="anc" name="cae7" href="#cae7">[cae7]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="cae9" href="#cae9">[cae9]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="caeb" href="#caeb">[caeb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$55</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_FillGrid"></a><div class="cp">;============================================================================
; Fills a grid in the PPU with a value.
;
; This writes a value to the PPU up to X times, and then
; again 256 * Y times.
;
; This seems a bit strange, but in practice it's never
; really used this way. Always 256 columns for every row,
; or only ever one row.
;
; INPUTS:
;     A:
;         The value to write.
;
;     X:
;         Initial number of columns for the first row
;         (256 columns per row after).
;
;     Y:
;         The number of rows.
;
; OUTPUTS:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         Updated with the new written data.
;
; XREFS:
;     <a href="#PPU_FillGrid">PPU_FillGrid</a>
;     <a href="#PPU_InitAttributeAndNameTables">PPU_InitAttributeAndNameTables</a>
;============================================================================
</div><span class="l"><a class="anc" name="caed" href="#caed">[caed]</a><a href="#PPU_FillGrid" class="la">PPU_FillGrid:</a><span class="ce">; [$caed]</span></span>
<span class="l"><a class="anc" name="caed" href="#caed">[caed]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write the value to PPUDATA.</span></span>
<span class="l"><a class="anc" name="caf0" href="#caf0">[caf0]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="caf1" href="#caf1">[caf1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; An inner loop was finished. Decrement and begin again.
;
; It appears it should write 256 more times on this iteration.
;
</div><span class="l"><a class="anc" name="caf3" href="#caf3">[caf3]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="caf4" href="#caf4">[caf4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPU_FillGrid">PPU_FillGrid</a></span></span><span class="ce">; If Y &gt; 0, loop</span></span>
<span class="l"><a class="anc" name="caf6" href="#caf6">[caf6]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_WaitUntilFlushed"></a><div class="cp">;============================================================================
; Wait until all buffered data to the PPU is flushed.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds of the PPU buffer to write.
;
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The current offset within the PPU buffer to write.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_DrawScenery">SplashAnimation_DrawScenery</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;     <a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a>
;     <a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a>
;     <a href="#Game_SetupNewArea">Game_SetupNewArea</a>
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;============================================================================
</div><span class="l"><a class="anc" name="caf7" href="#caf7">[caf7]</a><a href="#PPU_WaitUntilFlushed" class="la">PPU_WaitUntilFlushed:</a><span class="ce">; [$caf7]</span></span>
<div class="c">;
; Wait until the PPU buffer has been emptied (flushed to the
; PPU).
;
</div><span class="l"><a class="anc" name="caf7" href="#caf7">[caf7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Load the upper bounds of the PPU buffer.</span></span>
<span class="l"><a class="anc" name="caf9" href="#caf9">[caf9]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Has the read offset hit the upper bounds?</span></span>
<span class="l"><a class="anc" name="cafb" href="#cafb">[cafb]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; If not, loop until it's cleared.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Pause interrupt handling for 2 interrupts.
;
</div><span class="l"><a class="anc" name="cafd" href="#cafd">[cafd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="caff" href="#caff">[caff]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Reset the paused interrupt counter.</span></span>
<span class="l"><a class="anc" name="cb01" href="#cb01">[cb01]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a></span></span><span class="ce">; Disable processing of interrupts.</span></span>
<span class="l"><a class="anc" name="cb03" href="#cb03">[cb03]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cb05:@_waitForInterruptLoop"></a><div class="c">;
; Wait for 2 interrupts (at least).
;
</div><span class="l"><a class="anc" name="cb05" href="#cb05">[cb05]</a><a href="#:cb05:@_waitForInterruptLoop" class="lla">@_waitForInterruptLoop:</a><span class="ce">; [$cb05]</span></span>
<span class="l"><a class="anc" name="cb05" href="#cb05">[cb05]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PauseInterruptCounter">PauseInterruptCounter</a></span></span><span class="ce">; Load the paused interrupt counter.</span></span>
<span class="l"><a class="anc" name="cb07" href="#cb07">[cb07]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Has it reached 2 interrupts?</span></span>
<span class="l"><a class="anc" name="cb09" href="#cb09">[cb09]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_waitForInterruptLoop">@_waitForInterruptLoop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="cb0b" href="#cb0b">[cb0b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="DEADCODE_FUN_PRG15_MIRROR__cb0c"></a><div class="cp">;============================================================================
; DEADCODE
;
; XREFS:
;     <a href="#DEADCODE_FUN_PRG15_MIRROR__cb0c">DEADCODE_FUN_PRG15_MIRROR__cb0c</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb0c" href="#cb0c">[cb0c]</a><a href="#DEADCODE_FUN_PRG15_MIRROR__cb0c" class="la">DEADCODE_FUN_PRG15_MIRROR__cb0c:</a><span class="ce">; [$cb0c]</span></span>
<span class="l"><a class="anc" name="cb0c" href="#cb0c">[cb0c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><a class="anc" name="cb0f" href="#cb0f">[cb0f]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#DEADCODE_FUN_PRG15_MIRROR__cb0c">DEADCODE_FUN_PRG15_MIRROR__cb0c</a></span></span></span>
<span class="l"></span>
<a name=":cb11:@LAB_PRG15_MIRROR__cb11"></a><span class="l"><a class="anc" name="cb11" href="#cb11">[cb11]</a><a href="#:cb11:@LAB_PRG15_MIRROR__cb11" class="lla">@LAB_PRG15_MIRROR__cb11:</a><span class="ce">; [$cb11]</span></span>
<span class="l"><a class="anc" name="cb11" href="#cb11">[cb11]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUSTATUS">PPUSTATUS</a></span></span></span>
<span class="l"><a class="anc" name="cb14" href="#cb14">[cb14]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__cb11">@LAB_PRG15_MIRROR__cb11</a></span></span></span>
<span class="l"><a class="anc" name="cb16" href="#cb16">[cb16]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_ResetForGamePlay"></a><div class="cp">;============================================================================
; Reset the screen for game play mode.
;
; This is called to reset the sprites state and enable
; interrupt handlers for game play screens.
;
; This is called when entering/exiting buildings or
; switching areas.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a>:
;         Set to 1 (true).
;
; CALLS:
;     <a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;     <a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a>
;     <a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a>
;     <a href="#Game_SetupNewArea">Game_SetupNewArea</a>
;     <a href="#Game_Start">Game_Start</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb17" href="#cb17">[cb17]</a><a href="#Screen_ResetForGamePlay" class="la">Screen_ResetForGamePlay:</a><span class="ce">; [$cb17]</span></span>
<span class="l"><a class="anc" name="cb17" href="#cb17">[cb17]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span><span class="ce">; Reset the sprites for game play mode.</span></span>
<span class="l"><a class="anc" name="cb1a" href="#cb1a">[cb1a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cb1c" href="#cb1c">[cb1c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a></span></span><span class="ce">; Enable interrupt handlers.</span></span>
<span class="l"><a class="anc" name="cb1e" href="#cb1e">[cb1e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="DEADCODE_FUN_PRG15_MIRROR__cb1f"></a><div class="cp">;============================================================================
; DEADCODE
;============================================================================
</div><span class="l"><a class="anc" name="cb1f" href="#cb1f">[cb1f]</a><a href="#DEADCODE_FUN_PRG15_MIRROR__cb1f" class="la">DEADCODE_FUN_PRG15_MIRROR__cb1f:</a><span class="ce">; [$cb1f]</span></span>
<span class="l"><a class="anc" name="cb1f" href="#cb1f">[cb1f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#DEADCODE_Sprites_ResetForDefaultsMode1">DEADCODE_Sprites_ResetForDefaultsMode1</a></span></span></span>
<span class="l"><a class="anc" name="cb22" href="#cb22">[cb22]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cb24" href="#cb24">[cb24]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a></span></span></span>
<span class="l"><a class="anc" name="cb26" href="#cb26">[cb26]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_ResetForNonGame"></a><div class="cp">;============================================================================
; Reset the screen for non-game mode.
;
; This is called to reset the sprites state and enable
; interrupt handlers for non-game screens. That includes:
;
; * The title screen.
; * The password screen.
; * Intro animation.
; * Outro (end game) animation.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a>:
;         Set to 1 (true).
;
; CALLS:
;     <a href="#Screen_ResetSpritesForNonGame">Screen_ResetSpritesForNonGame</a>
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#SplashAnimation_RunOutro">SplashAnimation_RunOutro</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb27" href="#cb27">[cb27]</a><a href="#Screen_ResetForNonGame" class="la">Screen_ResetForNonGame:</a><span class="ce">; [$cb27]</span></span>
<span class="l"><a class="anc" name="cb27" href="#cb27">[cb27]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForNonGame">Screen_ResetSpritesForNonGame</a></span></span><span class="ce">; Reset the sprites for a non-game mode.</span></span>
<span class="l"><a class="anc" name="cb2a" href="#cb2a">[cb2a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cb2c" href="#cb2c">[cb2c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_InterruptHandlersEnabled">Game_InterruptHandlersEnabled</a></span></span><span class="ce">; Enable interrupt handlers.</span></span>
<span class="l"><a class="anc" name="cb2e" href="#cb2e">[cb2e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_InitVBlank"></a><div class="cp">;============================================================================
; Initialize VBlank for the PPU.
;
; INPUTS:
;     <a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a>:
;         The current PPU control flags.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a>:
;         The updated PPU control flags.
;
; XREFS:
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb2f" href="#cb2f">[cb2f]</a><a href="#PPU_InitVBlank" class="la">PPU_InitVBlank:</a><span class="ce">; [$cb2f]</span></span>
<div class="c">;
; Enable VBlank NMI.
;
</div><span class="l"><a class="anc" name="cb2f" href="#cb2f">[cb2f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; Load the PPU control flags.</span></span>
<span class="l"><a class="anc" name="cb31" href="#cb31">[cb31]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Enable the VBlank bit.</span></span>
<span class="l"><a class="anc" name="cb33" href="#cb33">[cb33]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_savePPUCtrl">@_savePPUCtrl</a></span></span><span class="ce">; If not 0, jump. (DEADCODE: It will never be 0, so always jump).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; DEADCODE: Disable VBlank NMI.
;
; We should never actually end up here, since the
; value we compare against 0 above is always at least
; 0x80.
;
</div><span class="l"><a class="anc" name="cb35" href="#cb35">[cb35]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span></span>
<span class="l"><a class="anc" name="cb37" href="#cb37">[cb37]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cb39:@_savePPUCtrl"></a><div class="c">;
; Write our copy of the bitmask and set on the PPU.
;
</div><span class="l"><a class="anc" name="cb39" href="#cb39">[cb39]</a><a href="#:cb39:@_savePPUCtrl" class="lla">@_savePPUCtrl:</a><span class="ce">; [$cb39]</span></span>
<span class="l"><a class="anc" name="cb39" href="#cb39">[cb39]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; Store the saved PPU control flags.</span></span>
<span class="l"><a class="anc" name="cb3b" href="#cb3b">[cb3b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Store the flags in the PPU.</span></span>
<span class="l"><a class="anc" name="cb3e" href="#cb3e">[cb3e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="DEADCODE_Sprites_ResetForDefaultsMode1"></a><div class="cp">;============================================================================
; DEADCODE
;
; XREFS:
;     <a href="#DEADCODE_FUN_PRG15_MIRROR__cb1f">DEADCODE_FUN_PRG15_MIRROR__cb1f</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb3f" href="#cb3f">[cb3f]</a><a href="#DEADCODE_Sprites_ResetForDefaultsMode1" class="la">DEADCODE_Sprites_ResetForDefaultsMode1:</a><span class="ce">; [$cb3f]</span></span>
<span class="l"><a class="anc" name="cb3f" href="#cb3f">[cb3f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cb41" href="#cb41">[cb41]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a></span></span></span>
<span class="l"><a class="anc" name="cb43" href="#cb43">[cb43]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span></span>
<span class="l"><a class="anc" name="cb45" href="#cb45">[cb45]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Sprites_Reset">Sprites_Reset</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_ResetSpritesForGamePlay"></a><div class="cp">;============================================================================
; Reset sprite content for a gameplay screen.
;
; This will set sprite 0 to X=8, Y=23 (where the "P"
; symbol is placed for health), disable forcing
; lower pattern tables, and then reset the sprites.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a>:
;         Set to mode 0 (X=8, Y=23).
;
;     <a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a>:
;         Set to 0 (false).
;
; CALLS:
;     <a href="#Sprites_Reset">Sprites_Reset</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;     <a href="PRG12.html#PlayerMenu_HandleInventoryMenuInput">PlayerMenu_HandleInventoryMenuInput</a>
;     <a href="PRG12.html#PlayerMenu_Show">PlayerMenu_Show</a>
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;     <a href="PRG12.html#PlayerMenu_ShowSubmenu">PlayerMenu_ShowSubmenu</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb47" href="#cb47">[cb47]</a><a href="#Screen_ResetSpritesForGamePlay" class="la">Screen_ResetSpritesForGamePlay:</a><span class="ce">; [$cb47]</span></span>
<span class="l"><a class="anc" name="cb47" href="#cb47">[cb47]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cb49" href="#cb49">[cb49]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a></span></span><span class="ce">; Set sprite 0 to X=8, Y=23.</span></span>
<span class="l"><a class="anc" name="cb4b" href="#cb4b">[cb4b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ForceLowerPatternTables">PPU_ForceLowerPatternTables</a></span></span><span class="ce">; Disable forcing lower pattern tables.</span></span>
<span class="l"><a class="anc" name="cb4d" href="#cb4d">[cb4d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Sprites_Reset">Sprites_Reset</a></span></span><span class="ce">; Reset sprites. This will always jump.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_ResetSpritesForNonGame"></a><div class="cp">;============================================================================
; Reset sprite content for a non-gameplay screen.
;
; This will remove sprite 0 and clear out the sprite slots.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A:
;         The start of the slot range for new sprites.
;
;     <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a>:
;         Set to 0xFF (no sprite 0).
;
;     <a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a>:
;     <a href="RAM.html#Sprites_Unused_0034">Sprites_Unused_0034</a>:
;     <a href="RAM.html#Sprites_Unused_0035">Sprites_Unused_0035</a>:
;     <a href="RAM.html#Sprites_Unused_0037">Sprites_Unused_0037</a>:
;     <a href="RAM.html#Sprites_Unused_0038">Sprites_Unused_0038</a>:
;     <a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a>:
;         Cleared.
;
;     <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>:
;         The cleared sprite information.
;
;     <a href="RAM.html#Sprites_StartSlotRange">Sprites_StartSlotRange</a>:
;         The start of the slot range for sprites. This will
;         be 0 or 32.
;
; CALLS:
;     <a href="#Sprites_Reset">Sprites_Reset</a>
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_HandleWrongPasswordAndWaitForInput">PasswordScreen_HandleWrongPasswordAndWaitForInput</a>
;     <a href="PRG12.html#PasswordScreen_WaitForInput">PasswordScreen_WaitForInput</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#SplashAnimation_RunOutro">SplashAnimation_RunOutro</a>
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;     <a href="#Screen_ResetForNonGame">Screen_ResetForNonGame</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb4f" href="#cb4f">[cb4f]</a><a href="#Screen_ResetSpritesForNonGame" class="la">Screen_ResetSpritesForNonGame:</a><span class="ce">; [$cb4f]</span></span>
<span class="l"><a class="anc" name="cb4f" href="#cb4f">[cb4f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; A = 0xFF (no sprite 0)</span></span>
<span class="l"><a class="anc" name="cb51" href="#cb51">[cb51]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_Reset"></a><div class="cp">;============================================================================
; Reset the state for the sprites on screen.
;
; This will clear out the sprite slots, fill out all
; available sprite information in the OAM with default
; values, and optionally add a sprite 0.
;
; Sprite 0 will be added if <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a>
; is 0 or 1. This is used for Sprite 0 hits (see
; https://www.nesdev.org/wiki/PPU_OAM#Sprite_0_hits).
;
; In practice, only mode 0 is used. 1 seems to be a
; hold-over from an earlier design.
;
; INPUTS:
;     <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a>:
;         The mode used for sprite 0 defaults.
;
;     <a href="#SPRITES_START_XY">SPRITES_START_XY</a>:
;         The X, Y positions for sprite 0, based on the
;         defaults mode.
;
; OUTPUTS:
;     <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>:
;         The populated sprite information.
;
;     <a href="RAM.html#Sprites_StartSlotRange">Sprites_StartSlotRange</a>:
;         The start of the slot range for sprites. This will
;         be 0 or 32.
;
;     <a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a>:
;     <a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a>:
;     <a href="RAM.html#Sprites_Unused_0034">Sprites_Unused_0034</a>:
;     <a href="RAM.html#Sprites_Unused_0035">Sprites_Unused_0035</a>:
;     <a href="RAM.html#Sprites_Unused_0037">Sprites_Unused_0037</a>:
;     <a href="RAM.html#Sprites_Unused_0038">Sprites_Unused_0038</a>:
;         Cleared to 0.
;
; XREFS:
;     <a href="#DEADCODE_Sprites_ResetForDefaultsMode1">DEADCODE_Sprites_ResetForDefaultsMode1</a>
;     <a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb53" href="#cb53">[cb53]</a><a href="#Sprites_Reset" class="la">Sprites_Reset:</a><span class="ce">; [$cb53]</span></span>
<div class="c">;
; Reset state.
;
; Some of this seem to be remnants from an older design.
;
</div><span class="l"><a class="anc" name="cb53" href="#cb53">[cb53]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="cb55" href="#cb55">[cb55]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span><span class="ce">; <a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a> = 0</span></span>
<span class="l"><a class="anc" name="cb57" href="#cb57">[cb57]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_Unused_0034">Sprites_Unused_0034</a></span></span><span class="ce">; <a href="RAM.html#Sprites_Unused_0034">Sprites_Unused_0034</a> = 0</span></span>
<span class="l"><a class="anc" name="cb59" href="#cb59">[cb59]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_Unused_0035">Sprites_Unused_0035</a></span></span><span class="ce">; <a href="RAM.html#Sprites_Unused_0035">Sprites_Unused_0035</a> = 0</span></span>
<span class="l"><a class="anc" name="cb5b" href="#cb5b">[cb5b]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_Unused_0038">Sprites_Unused_0038</a></span></span><span class="ce">; <a href="RAM.html#Sprites_Unused_0038">Sprites_Unused_0038</a> = 0</span></span>
<span class="l"><a class="anc" name="cb5d" href="#cb5d">[cb5d]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_Unused_0037">Sprites_Unused_0037</a></span></span><span class="ce">; <a href="RAM.html#Sprites_Unused_0037">Sprites_Unused_0037</a> = 0</span></span>
<span class="l"><a class="anc" name="cb5f" href="#cb5f">[cb5f]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a></span></span><span class="ce">; Set sprite slots to not be full.</span></span>
<span class="l"><a class="anc" name="cb61" href="#cb61">[cb61]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Set the starting sprite slot to 0.</span></span>
<span class="l"><a class="anc" name="cb63" href="#cb63">[cb63]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a></span></span><span class="ce">; Load our byte from before.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check whether sprite 0 should be hard-coded.
;
</div><span class="l"><a class="anc" name="cb65" href="#cb65">[cb65]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_beginFillSpriteSlots">@_beginFillSpriteSlots</a></span></span><span class="ce">; If 0xFF, then jump.</span></span>
<span class="l"><a class="anc" name="cb67" href="#cb67">[cb67]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Increment the sprite slot (start new sprites at sprite 1).</span></span>
<span class="l"><a class="anc" name="cb69" href="#cb69">[cb69]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (index)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the sprite 0 to:
;
;     X =  8 if <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> is 0
;          0 if <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> is 1
;     Y = 23 if <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> is 0
;         72 if <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> is 1
;     Tile ID = 127
;     Attributes = Palette 3, background priority
;
; NOTE: <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> is never 1 in the shipped game.
;
; When 0, this will be the location of the "P" symbol for the
; HP bar.
;
</div><span class="l"><a class="anc" name="cb6a" href="#cb6a">[cb6a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SPRITES_START_XY">SPRITES_START_XY</a>,Y</span></span><span class="ce">; Load the Y for the sprite.</span></span>
<span class="l"><a class="anc" name="cb6d" href="#cb6d">[cb6d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a></span></span><span class="ce">; Store for sprite 0's Y.</span></span>
<span class="l"><a class="anc" name="cb70" href="#cb70">[cb70]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == tile ID</span></span>
<span class="l"><a class="anc" name="cb72" href="#cb72">[cb72]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SPRITE0_TILE">SPRITE0_TILE</a></span></span><span class="ce">; Store for sprite 0's tile ID.</span></span>
<span class="l"><a class="anc" name="cb75" href="#cb75">[cb75]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$23</span></span><span class="ce">; 0x23 == Palette index 3, behind background</span></span>
<span class="l"><a class="anc" name="cb77" href="#cb77">[cb77]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SPRITE0_ATTRS">SPRITE0_ATTRS</a></span></span><span class="ce">; Store for sprite 0's attributes.</span></span>
<span class="l"><a class="anc" name="cb7a" href="#cb7a">[cb7a]</a><span class="cd"><span class="i">LDA</span> <span class="o">$cb98,Y</span></span><span class="ce">; Load the X for the sprite.</span></span>
<span class="l"><a class="anc" name="cb7d" href="#cb7d">[cb7d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SPRITE0_X">SPRITE0_X</a></span></span><span class="ce">; Store for sprite 0's X.</span></span>
<span class="l"><a class="anc" name="cb80" href="#cb80">[cb80]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$04</span></span><span class="ce">; Y = 4 (loop counter).</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cb82:@_beginFillSpriteSlots"></a><div class="c">;
; Begin filling all sprite slots with a Y = 240 (off-screen).
;
</div><span class="l"><a class="anc" name="cb82" href="#cb82">[cb82]</a><a href="#:cb82:@_beginFillSpriteSlots" class="lla">@_beginFillSpriteSlots:</a><span class="ce">; [$cb82]</span></span>
<span class="l"><a class="anc" name="cb82" href="#cb82">[cb82]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$f0</span></span><span class="ce">; A = 0xF0 (default Y for unused slots).</span></span>
<span class="l"></span>
<a name=":cb84:@_fillSpriteSlotsLoop"></a><span class="l"><a class="anc" name="cb84" href="#cb84">[cb84]</a><a href="#:cb84:@_fillSpriteSlotsLoop" class="lla">@_fillSpriteSlotsLoop:</a><span class="ce">; [$cb84]</span></span>
<span class="l"><a class="anc" name="cb84" href="#cb84">[cb84]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,Y</span></span><span class="ce">; Set it for this sprite slot's Y.</span></span>
<span class="l"><a class="anc" name="cb87" href="#cb87">[cb87]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Increment slot byte by 4.</span></span>
<span class="l"><a class="anc" name="cb88" href="#cb88">[cb88]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="cb89" href="#cb89">[cb89]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="cb8a" href="#cb8a">[cb8a]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="cb8b" href="#cb8b">[cb8b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_fillSpriteSlotsLoop">@_fillSpriteSlotsLoop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Flip the start of the sprite slot range between 0 and 32.
;
</div><span class="l"><a class="anc" name="cb8d" href="#cb8d">[cb8d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_StartSlotRange">Sprites_StartSlotRange</a></span></span><span class="ce">; Load the frame flags.</span></span>
<span class="l"><a class="anc" name="cb8f" href="#cb8f">[cb8f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$80</span></span><span class="ce">; Cap to 0 or 32.</span></span>
<span class="l"><a class="anc" name="cb91" href="#cb91">[cb91]</a><span class="cd"><span class="i">EOR</span> <span class="o">#$80</span></span><span class="ce">; Flip it between 0 and 32.</span></span>
<span class="l"><a class="anc" name="cb93" href="#cb93">[cb93]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_StartSlotRange">Sprites_StartSlotRange</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="cb95" href="#cb95">[cb95]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SPRITES_START_XY"></a><div class="cp">;============================================================================
; Start X/Y locations for the default sprite 0.
;============================================================================
</div><span class="l"><a class="anc" name="cb96" href="#cb96">[cb96]</a><a href="#SPRITES_START_XY" class="la">SPRITES_START_XY:</a><span class="ce">; [$cb96]</span></span>
<span class="l"><a class="anc" name="cb96" href="#cb96">[cb96]</a><span class="cd"><span class="i">db</span> <span class="o">$17</span></span><span class="ce">; [0]: <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a> when <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> == 0</span></span>
<span class="l"><a class="anc" name="cb97" href="#cb97">[cb97]</a><span class="cd"><span class="i">db</span> <span class="o">$48</span></span><span class="ce">; [1]: <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a> when <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> == 0xFF</span></span>
<span class="l"><a class="anc" name="cb98" href="#cb98">[cb98]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]: <a href="RAM.html#SPRITE0_X">SPRITE0_X</a> when <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> == 0</span></span>
<span class="l"><a class="anc" name="cb99" href="#cb99">[cb99]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]: <a href="RAM.html#SPRITE0_X">SPRITE0_X</a> when <a href="RAM.html#Sprites_Sprite0Mode">Sprites_Sprite0Mode</a> == 0xFF</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_WaitForOAMReset"></a><div class="cp">;============================================================================
; Request a reset of the OAM and wait for the next interrupt.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
; OUTPUTS:
;     <a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a>:
;         Set to 1 to request a reset.
;
; CALLS:
;     <a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a>
;
; XREFS:
;     <a href="#IScripts_ClearPortraitImage">IScripts_ClearPortraitImage</a>
;     <a href="#IScripts_LoadPortraitTiles">IScripts_LoadPortraitTiles</a>
;============================================================================
</div><span class="l"><a class="anc" name="cb9a" href="#cb9a">[cb9a]</a><a href="#Game_WaitForOAMReset" class="la">Game_WaitForOAMReset:</a><span class="ce">; [$cb9a]</span></span>
<span class="l"><a class="anc" name="cb9a" href="#cb9a">[cb9a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span></span>
<span class="l"><a class="anc" name="cb9d" href="#cb9d">[cb9d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cb9f" href="#cb9f">[cb9f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Game_NeedOAMReset">Game_NeedOAMReset</a></span></span></span>
<span class="l"><a class="anc" name="cba1" href="#cba1">[cba1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"></span>
<a name=":cba3:@_waitForInterruptLoop"></a><span class="l"><a class="anc" name="cba3" href="#cba3">[cba3]</a><a href="#:cba3:@_waitForInterruptLoop" class="lla">@_waitForInterruptLoop:</a><span class="ce">; [$cba3]</span></span>
<span class="l"><a class="anc" name="cba3" href="#cba3">[cba3]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span></span>
<span class="l"><a class="anc" name="cba5" href="#cba5">[cba5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_waitForInterruptLoop">@_waitForInterruptLoop</a></span></span></span>
<span class="l"><a class="anc" name="cba7" href="#cba7">[cba7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_FlipRanges"></a><div class="cp">;============================================================================
; Flip sprite data between slot ranges.
;
; This updates the OAM data for the sprites, copying between
; ranges 0-31 and 32-63. Only data in sprites 1 onward are
; copied. Sprite 0 is left alone.
;
; INPUTS:
;     <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>:
;         The start of the sprite data.
;
; OUTPUTS:
;     <a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>:
;         The start of the updated sprite data.
;
; XREFS:
;     <a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a class="anc" name="cba8" href="#cba8">[cba8]</a><a href="#Sprites_FlipRanges" class="la">Sprites_FlipRanges:</a><span class="ce">; [$cba8]</span></span>
<span class="l"><a class="anc" name="cba8" href="#cba8">[cba8]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$04</span></span><span class="ce">; X = 4 (sprite data offset)</span></span>
<span class="l"><a class="anc" name="cbaa" href="#cbaa">[cbaa]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$84</span></span><span class="ce">; Y = 0x84 (start of loop counter)</span></span>
<span class="l"></span>
<a name=":cbac:@_loop"></a><span class="l"><a class="anc" name="cbac" href="#cbac">[cbac]</a><a href="#:cbac:@_loop" class="lla">@_loop:</a><span class="ce">; [$cbac]</span></span>
<span class="l"><a class="anc" name="cbac" href="#cbac">[cbac]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Load the sprite Y from this offset in range 1.</span></span>
<span class="l"><a class="anc" name="cbaf" href="#cbaf">[cbaf]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="cbb0" href="#cbb0">[cbb0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,Y</span></span><span class="ce">; Load the sprite Y from this offset in range 2.</span></span>
<span class="l"><a class="anc" name="cbb3" href="#cbb3">[cbb3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Copy to range 1.</span></span>
<span class="l"><a class="anc" name="cbb6" href="#cbb6">[cbb6]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous Y from the stack.</span></span>
<span class="l"><a class="anc" name="cbb7" href="#cbb7">[cbb7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,Y</span></span><span class="ce">; Copy it to range 2.</span></span>
<span class="l"><a class="anc" name="cbba" href="#cbba">[cbba]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (sprite data offset)</span></span>
<span class="l"><a class="anc" name="cbbb" href="#cbbb">[cbbb]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter)</span></span>
<span class="l"><a class="anc" name="cbbc" href="#cbbc">[cbbc]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not wrapped to 0, loop.</span></span>
<span class="l"><a class="anc" name="cbbe" href="#cbbe">[cbbe]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_InitMMCAndBank"></a><div class="cp">;============================================================================
; Initialize the MMC1 chip and switch to bank 14.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Set to 0.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         Set to bank 14.
;
;     <a href="RAM.html#SavedPRGBank">SavedPRGBank</a>:
;         Set to bank 14.
;
; CALLS:
;     <a href="#MMC1_Init">MMC1_Init</a>
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Game_Init">Game_Init</a>
;============================================================================
</div><span class="l"><a class="anc" name="cbbf" href="#cbbf">[cbbf]</a><a href="#Game_InitMMCAndBank" class="la">Game_InitMMCAndBank:</a><span class="ce">; [$cbbf]</span></span>
<span class="l"><a class="anc" name="cbbf" href="#cbbf">[cbbf]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cbc1" href="#cbc1">[cbc1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><a class="anc" name="cbc3" href="#cbc3">[cbc3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_Init">MMC1_Init</a></span></span><span class="ce">; Initialize the MMC1 chipset.</span></span>
<span class="l"><a class="anc" name="cbc6" href="#cbc6">[cbc6]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><a class="anc" name="cbc8" href="#cbc8">[cbc8]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Set the previous and current ROM banks to 14.</span></span>
<span class="l"><a class="anc" name="cbcb" href="#cbcb">[cbcb]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#SavedPRGBank">SavedPRGBank</a></span></span></span>
<span class="l"><a class="anc" name="cbcd" href="#cbcd">[cbcd]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_Init"></a><div class="cp">;============================================================================
; Initialize the MMC1 chip.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; XREFS:
;     <a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a>
;============================================================================
</div><span class="l"><a class="anc" name="cbd0" href="#cbd0">[cbd0]</a><a href="#MMC1_Init" class="la">MMC1_Init:</a><span class="ce">; [$cbd0]</span></span>
<span class="l"><a class="anc" name="cbd0" href="#cbd0">[cbd0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="cbd2" href="#cbd2">[cbd2]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cbd5" href="#cbd5">[cbd5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0e</span></span><span class="ce">; Horizontal Mirroring
Regular Mirroring
Swap ROM bank at 0x8000
Swap 8K of VROM at PPU 0x0000
Don't reset</span></span>
<span class="l"><a class="anc" name="cbd7" href="#cbd7">[cbd7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cbda" href="#cbda">[cbda]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbdb" href="#cbdb">[cbdb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cbde" href="#cbde">[cbde]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbdf" href="#cbdf">[cbdf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cbe2" href="#cbe2">[cbe2]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbe3" href="#cbe3">[cbe3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cbe6" href="#cbe6">[cbe6]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbe7" href="#cbe7">[cbe7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span><span class="ce">; VROM_SIZE_SELECT</span></span>
<span class="l"><a class="anc" name="cbea" href="#cbea">[cbea]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x0000
Switch 4KB only
Don't reset</span></span>
<span class="l"><a class="anc" name="cbec" href="#cbec">[cbec]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cbef" href="#cbef">[cbef]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbf0" href="#cbf0">[cbf0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cbf3" href="#cbf3">[cbf3]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbf4" href="#cbf4">[cbf4]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cbf7" href="#cbf7">[cbf7]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbf8" href="#cbf8">[cbf8]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cbfb" href="#cbfb">[cbfb]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cbfc" href="#cbfc">[cbfc]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span><span class="ce">; VROM_PAGE_SELECT_1</span></span>
<span class="l"><a class="anc" name="cbff" href="#cbff">[cbff]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x1000
Switch 4KB only
Don't reset</span></span>
<span class="l"><a class="anc" name="cc01" href="#cc01">[cc01]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc04" href="#cc04">[cc04]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc05" href="#cc05">[cc05]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc08" href="#cc08">[cc08]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc09" href="#cc09">[cc09]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc0c" href="#cc0c">[cc0c]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc0d" href="#cc0d">[cc0d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc10" href="#cc10">[cc10]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc11" href="#cc11">[cc11]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc14" href="#cc14">[cc14]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_SaveROMBankAndUpdateTo"></a><div class="cp">;============================================================================
; Save the current ROM bank and switch to a new one.
;
; INPUTS:
;     X:
;         The new bank to switch to.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The new ROM bank.
;
;     <a href="RAM.html#SavedPRGBank">SavedPRGBank</a>:
;         The previously-saved ROM bank.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag used to manage/reinitialize MMC1 state.
;
; XREFS:
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a class="anc" name="cc15" href="#cc15">[cc15]</a><a href="#MMC1_SaveROMBankAndUpdateTo" class="la">MMC1_SaveROMBankAndUpdateTo:</a><span class="ce">; [$cc15]</span></span>
<span class="l"><a class="anc" name="cc15" href="#cc15">[cc15]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Get the currently-loaded ROM bank</span></span>
<span class="l"><a class="anc" name="cc18" href="#cc18">[cc18]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SavedPRGBank">SavedPRGBank</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_UpdateROMBank"></a><div class="cp">;============================================================================
; Switch the active ROM bank.
;
; INPUTS:
;     X:
;         The new bank to switch to.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The new ROM bank.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag used to manage/reinitialize MMC1 state.
;
; XREFS:
;     <a href="#Area_LoadBlockProperties">Area_LoadBlockProperties</a>
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#CurrentSprite_LoadTilesInfo">CurrentSprite_LoadTilesInfo</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Game_InitMMCAndBank">Game_InitMMCAndBank</a>
;     <a href="#Game_InitScreenAndMusic">Game_InitScreenAndMusic</a>
;     <a href="#Game_LoadAreaTable">Game_LoadAreaTable</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#IScripts_DrawPortraitTileToPPU">IScripts_DrawPortraitTileToPPU</a>
;     <a href="#IScripts_LoadPortraitTilesAddress">IScripts_LoadPortraitTilesAddress</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;     <a href="#Messages_Load">Messages_Load</a>
;     <a href="#PPU_LoadGlyphsForStrings">PPU_LoadGlyphsForStrings</a>
;     <a href="#PPU_WriteTilesFromCHRRAM">PPU_WriteTilesFromCHRRAM</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_LoadArmorSpriteTilesAddr">Player_LoadArmorSpriteTilesAddr</a>
;     <a href="#Player_LoadArmorTile">Player_LoadArmorTile</a>
;     <a href="#Player_LoadShieldSpriteTileAddrs">Player_LoadShieldSpriteTileAddrs</a>
;     <a href="#Player_LoadShieldTile">Player_LoadShieldTile</a>
;     <a href="#Player_LoadWeaponSpriteTileAddrs">Player_LoadWeaponSpriteTileAddrs</a>
;     <a href="#Player_LoadWeaponTile">Player_LoadWeaponTile</a>
;     <a href="#Screen_HandleScrollDown">Screen_HandleScrollDown</a>
;     <a href="#Screen_HandleScrollLeft">Screen_HandleScrollLeft</a>
;     <a href="#Screen_HandleScrollRight">Screen_HandleScrollRight</a>
;     <a href="#Screen_HandleScrollUp">Screen_HandleScrollUp</a>
;     <a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a>
;     <a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a>
;     <a href="#Screen_SetFadeOutPalette">Screen_SetFadeOutPalette</a>
;     <a href="#Screen_SetPaletteData">Screen_SetPaletteData</a>
;     <a href="#Sprite_DrawPortraitPartAppearance">Sprite_DrawPortraitPartAppearance</a>
;     <a href="#Sprite_Draw_Finish">Sprite_Draw_Finish</a>
;     <a href="#Sprite_SetAppearanceAddrFromOffset">Sprite_SetAppearanceAddrFromOffset</a>
;     <a href="#Sprite_SetPlayerAppearanceAddr">Sprite_SetPlayerAppearanceAddr</a>
;     <a href="#Sprites_LoadCommon">Sprites_LoadCommon</a>
;     <a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a>
;     <a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a>
;     <a href="#TextBox_GetBackingAttributeData">TextBox_GetBackingAttributeData</a>
;     <a href="#TextBox_LoadAndShowMessage">TextBox_LoadAndShowMessage</a>
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;     <a href="#TextBox_ShowNextChar">TextBox_ShowNextChar</a>
;     <a href="#Textbox_Maybe_GetAreaBehindTextbox">Textbox_Maybe_GetAreaBehindTextbox</a>
;     <a href="#UI_DrawSelectedItem">UI_DrawSelectedItem</a>
;============================================================================
</div><span class="l"><a class="anc" name="cc1a" href="#cc1a">[cc1a]</a><a href="#MMC1_UpdateROMBank" class="la">MMC1_UpdateROMBank:</a><span class="ce">; [$cc1a]</span></span>
<span class="l"><a class="anc" name="cc1a" href="#cc1a">[cc1a]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Set the bank we're switching to.</span></span>
<span class="l"></span>
<a name=":cc1d:@_setupMMC1"></a><span class="l"><a class="anc" name="cc1d" href="#cc1d">[cc1d]</a><a href="#:cc1d:@_setupMMC1" class="lla">@_setupMMC1:</a><span class="ce">; [$cc1d]</span></span>
<span class="l"><a class="anc" name="cc1d" href="#cc1d">[cc1d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cc1f" href="#cc1f">[cc1f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write 5 LSBs of A to $FFFF, one bit per write (MMC1 serial protocol):
;
</div><span class="l"><a class="anc" name="cc21" href="#cc21">[cc21]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; ROM_PAGE_SELECT parameter in X</span></span>
<span class="l"><a class="anc" name="cc22" href="#cc22">[cc22]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cc25" href="#cc25">[cc25]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc26" href="#cc26">[cc26]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cc29" href="#cc29">[cc29]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc2a" href="#cc2a">[cc2a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cc2d" href="#cc2d">[cc2d]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc2e" href="#cc2e">[cc2e]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cc31" href="#cc31">[cc31]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc32" href="#cc32">[cc32]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check the MMC1 synchronization state.
;
; If 0, this will re-initialize the MMC1 and switch banks.
;
; If 1, the interrupt handler is already switching banks.
; This can then return.
;
</div><span class="l"><a class="anc" name="cc35" href="#cc35">[cc35]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><a class="anc" name="cc37" href="#cc37">[cc37]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="cc39" href="#cc39">[cc39]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_finish">@_finish</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Slow path. Re-initialize the MMC1.
;
</div><span class="l"><a class="anc" name="cc3b" href="#cc3b">[cc3b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="cc3d" href="#cc3d">[cc3d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span><span class="ce">; Reset the MMC1 shifter/controler.</span></span>
<span class="l"><a class="anc" name="cc40" href="#cc40">[cc40]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0e</span></span><span class="ce">; Horizontal Mirroring
Regular Mirroring
Swap ROM bank at 0x8000
Swap 8K of VROM at PPU 0x000
Don't reset</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the CHR banking mode.
;
</div><span class="l"><a class="anc" name="cc42" href="#cc42">[cc42]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cc45" href="#cc45">[cc45]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc46" href="#cc46">[cc46]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cc49" href="#cc49">[cc49]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc4a" href="#cc4a">[cc4a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cc4d" href="#cc4d">[cc4d]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc4e" href="#cc4e">[cc4e]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cc51" href="#cc51">[cc51]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc52" href="#cc52">[cc52]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 0 = 0.
;
</div><span class="l"><a class="anc" name="cc55" href="#cc55">[cc55]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x000
Switch 4K only
Don't reset</span></span>
<span class="l"><a class="anc" name="cc57" href="#cc57">[cc57]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cc5a" href="#cc5a">[cc5a]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc5b" href="#cc5b">[cc5b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cc5e" href="#cc5e">[cc5e]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc5f" href="#cc5f">[cc5f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cc62" href="#cc62">[cc62]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc63" href="#cc63">[cc63]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="cc66" href="#cc66">[cc66]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc67" href="#cc67">[cc67]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 1 = 0.
;
</div><span class="l"><a class="anc" name="cc6a" href="#cc6a">[cc6a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Select VROM bank at 0x1000
Switch 4K only
Don't reset</span></span>
<span class="l"><a class="anc" name="cc6c" href="#cc6c">[cc6c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc6f" href="#cc6f">[cc6f]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc70" href="#cc70">[cc70]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc73" href="#cc73">[cc73]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc74" href="#cc74">[cc74]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc77" href="#cc77">[cc77]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc78" href="#cc78">[cc78]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc7b" href="#cc7b">[cc7b]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc7c" href="#cc7c">[cc7c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="cc7f" href="#cc7f">[cc7f]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_setupMMC1">@_setupMMC1</a></span></span></span>
<span class="l"></span>
<a name=":cc82:@_finish"></a><span class="l"><a class="anc" name="cc82" href="#cc82">[cc82]</a><a href="#:cc82:@_finish" class="lla">@_finish:</a><span class="ce">; [$cc82]</span></span>
<span class="l"><a class="anc" name="cc82" href="#cc82">[cc82]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><a class="anc" name="cc84" href="#cc84">[cc84]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_EnsurePRG"></a><div class="cp">;============================================================================
; Watchdog handler to ensure the correct ROM bank is set.
;
; This is called by the interrupt handler to keep the MMC1
; in a known configuration and keep the desired ROM bank
; set.
;
; If other code is in the middle of switching ROM banks,
; this will notice and perform a full MMC1 re-initialization
; before setting the bank.
;
; INPUTS:
;     X:
;         The ROM bank to ensure is set.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag indicating if a ROM bank is currently being
;         set.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The new ROM bank.
;
;     <a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a>:
;         Flag used to manage/reinitialize MMC1 state.
;
; XREFS:
;     <a href="#OnInterrupt">OnInterrupt</a>
;============================================================================
</div><span class="l"><a class="anc" name="cc85" href="#cc85">[cc85]</a><a href="#MMC1_EnsurePRG" class="la">MMC1_EnsurePRG:</a><span class="ce">; [$cc85]</span></span>
<span class="l"><a class="anc" name="cc85" href="#cc85">[cc85]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if any code was in the process of switching banks.
;
; If 0, we can exit.
;
; If 1, <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a> was in the process of
; switching banks.
;
</div><span class="l"><a class="anc" name="cc88" href="#cc88">[cc88]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"><a class="anc" name="cc8a" href="#cc8a">[cc8a]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_fastPath">@_fastPath</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The sync state was set, so something is switching banks.
; Increment the sync state and reset the MMC1 chip.
;
</div><span class="l"><a class="anc" name="cc8c" href="#cc8c">[cc8c]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#MMC1_ShiftSync">MMC1_ShiftSync</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reset MMC1.
;
</div><span class="l"><a class="anc" name="cc8e" href="#cc8e">[cc8e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="cc90" href="#cc90">[cc90]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cc93" href="#cc93">[cc93]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0e</span></span><span class="ce">; Horizontal Mirroring
Regular Mirroring
Swap ROM bank at 0x8000
Swap 8K of VROM at PPU 0x000
Don't reset</span></span>
<span class="l"></span>
<a name=":cc95:@_setMMC1State"></a><span class="l"><a class="anc" name="cc95" href="#cc95">[cc95]</a><a href="#:cc95:@_setMMC1State" class="lla">@_setMMC1State:</a><span class="ce">; [$cc95]</span></span>
<span class="l"><a class="anc" name="cc95" href="#cc95">[cc95]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cc98" href="#cc98">[cc98]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc99" href="#cc99">[cc99]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cc9c" href="#cc9c">[cc9c]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cc9d" href="#cc9d">[cc9d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cca0" href="#cca0">[cca0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cca1" href="#cca1">[cca1]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"><a class="anc" name="cca4" href="#cca4">[cca4]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cca5" href="#cca5">[cca5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$9fff</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 0 = 0
;
</div><span class="l"><a class="anc" name="cca8" href="#cca8">[cca8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ccaa" href="#ccaa">[ccaa]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="ccad" href="#ccad">[ccad]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccae" href="#ccae">[ccae]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="ccb1" href="#ccb1">[ccb1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccb2" href="#ccb2">[ccb2]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="ccb5" href="#ccb5">[ccb5]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccb6" href="#ccb6">[ccb6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"><a class="anc" name="ccb9" href="#ccb9">[ccb9]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccba" href="#ccba">[ccba]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$bfff</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set CHR bank 1 = 0.
;
</div><span class="l"><a class="anc" name="ccbd" href="#ccbd">[ccbd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ccbf" href="#ccbf">[ccbf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="ccc2" href="#ccc2">[ccc2]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccc3" href="#ccc3">[ccc3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="ccc6" href="#ccc6">[ccc6]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccc7" href="#ccc7">[ccc7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="ccca" href="#ccca">[ccca]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cccb" href="#cccb">[cccb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"><a class="anc" name="ccce" href="#ccce">[ccce]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cccf" href="#cccf">[cccf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:$dfff</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ccd2:@_fastPath"></a><div class="c">;
; Set the bank.
;
</div><span class="l"><a class="anc" name="ccd2" href="#ccd2">[ccd2]</a><a href="#:ccd2:@_fastPath" class="lla">@_fastPath:</a><span class="ce">; [$ccd2]</span></span>
<span class="l"><a class="anc" name="ccd2" href="#ccd2">[ccd2]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="ccd3" href="#ccd3">[ccd3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="ccd6" href="#ccd6">[ccd6]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccd7" href="#ccd7">[ccd7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="ccda" href="#ccda">[ccda]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccdb" href="#ccdb">[ccdb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="ccde" href="#ccde">[ccde]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ccdf" href="#ccdf">[ccdf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cce2" href="#cce2">[cce2]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cce3" href="#cce3">[cce3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="#MMC1_SERIAL">MMC1_SERIAL</a></span></span></span>
<span class="l"><a class="anc" name="cce6" href="#cce6">[cce6]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_RestorePrevROMBank"></a><div class="cp">;============================================================================
; Restore the previously-saved ROM bank.
;
; This will switch to the bank stored in
; <a href="RAM.html#SavedPRGBank">SavedPRGBank</a>.
;
; INPUTS:
;     <a href="RAM.html#SavedPRGBank">SavedPRGBank</a>:
;         The saved ROM bank to switch back to.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a class="anc" name="cce7" href="#cce7">[cce7]</a><a href="#MMC1_RestorePrevROMBank" class="la">MMC1_RestorePrevROMBank:</a><span class="ce">; [$cce7]</span></span>
<span class="l"><a class="anc" name="cce7" href="#cce7">[cce7]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#SavedPRGBank">SavedPRGBank</a></span></span></span>
<span class="l"><a class="anc" name="cce9" href="#cce9">[cce9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
</pre><pre><a name="PPUBuffer_DrawCommand_RemoveVerticalLines"></a><div class="cp">;============================================================================
; TODO: Document PPUBuffer_DrawCommand_RemoveVerticalLines
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc8]
;============================================================================
</div><span class="l"><a class="anc" name="ccec" href="#ccec">[ccec]</a><a href="#PPUBuffer_DrawCommand_RemoveVerticalLines" class="la">PPUBuffer_DrawCommand_RemoveVerticalLines:</a><span class="ce">; [$ccec]</span></span>
<div class="c">;
; Read the first byte from the buffer as the phase.
;
</div><span class="l"><a class="anc" name="ccec" href="#ccec">[ccec]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Load our current PPU buffer offset into X.</span></span>
<span class="l"><a class="anc" name="ccee" href="#ccee">[ccee]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the first address byte from the buffer into A.</span></span>
<span class="l"><a class="anc" name="ccf1" href="#ccf1">[ccf1]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment buffer offset (X = X + 1).</span></span>
<span class="l"><a class="anc" name="ccf2" href="#ccf2">[ccf2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store the upper byte (A) into a temporary variable.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the upper address from the buffer and set in PPUADDR.
;
</div><span class="l"><a class="anc" name="ccf4" href="#ccf4">[ccf4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the next byte from the buffer into A.</span></span>
<span class="l"><a class="anc" name="ccf7" href="#ccf7">[ccf7]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment buffer offset.</span></span>
<span class="l"><a class="anc" name="ccf8" href="#ccf8">[ccf8]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = lower byte.</span></span>
<span class="l"><a class="anc" name="ccf9" href="#ccf9">[ccf9]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write the upper byte to PPUADDR.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the lower address from the buffer and set in PPUADDR.
;
</div><span class="l"><a class="anc" name="ccfc" href="#ccfc">[ccfc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="ccff" href="#ccff">[ccff]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="cd00" href="#cd00">[cd00]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Set the new offset.</span></span>
<span class="l"><a class="anc" name="cd02" href="#cd02">[cd02]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="cd03" href="#cd03">[cd03]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write the lower byte to PPUADDR.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin preparing for the loop. There will be 16 iterations.
;
</div><span class="l"><a class="anc" name="cd06" href="#cd06">[cd06]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; Set to 16 iterations in <a href="RAM.html#Temp_06">Temp_06</a>.</span></span>
<span class="l"><a class="anc" name="cd08" href="#cd08">[cd08]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="cd0a" href="#cd0a">[cd0a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Read a byte from PPUDATA.</span></span>
<span class="l"></span>
<a name=":cd0d:@_loop"></a><span class="l"><a class="anc" name="cd0d" href="#cd0d">[cd0d]</a><a href="#:cd0d:@_loop" class="lla">@_loop:</a><span class="ce">; [$cd0d]</span></span>
<span class="l"><a class="anc" name="cd0d" href="#cd0d">[cd0d]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_07">Temp_07</a></span></span><span class="ce">; Store X (offset) into our temp state.</span></span>
<span class="l"><a class="anc" name="cd0f" href="#cd0f">[cd0f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Read the next byte of data.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the address again. The PPUDATA read advanced the offset.
;
</div><span class="l"><a class="anc" name="cd12" href="#cd12">[cd12]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper byte of PPU address to Y.</span></span>
<span class="l"><a class="anc" name="cd15" href="#cd15">[cd15]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set lower byte of PPU address to X.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add the phase byte and loop index together and get the three
; least-significant bits. This will be our index into the lookup
; table.
;
</div><span class="l"><a class="anc" name="cd18" href="#cd18">[cd18]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="cd19" href="#cd19">[cd19]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Load the loop index.</span></span>
<span class="l"><a class="anc" name="cd1b" href="#cd1b">[cd1b]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="cd1c" href="#cd1c">[cd1c]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Add the phase byte to it.</span></span>
<span class="l"><a class="anc" name="cd1e" href="#cd1e">[cd1e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Retain only the 3 least-significant bits.</span></span>
<span class="l"><a class="anc" name="cd20" href="#cd20">[cd20]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Store in X.</span></span>
<span class="l"><a class="anc" name="cd21" href="#cd21">[cd21]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Take the PPU data we loaded before and AND the value in the
; lookup table. This will be the replacement for the data we
; loaded.
;
</div><span class="l"><a class="anc" name="cd22" href="#cd22">[cd22]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="#PPUBUFFER_DRAWCOMMAND_0xFA_MASKS">PPUBUFFER_DRAWCOMMAND_0xFA_MASKS</a>,X</span></span></span>
<span class="l"><a class="anc" name="cd25" href="#cd25">[cd25]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Set as the new PPU data.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the offset into the buffer and increment.
;
</div><span class="l"><a class="anc" name="cd28" href="#cd28">[cd28]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_07">Temp_07</a></span></span><span class="ce">; Load the saved offset.</span></span>
<span class="l"><a class="anc" name="cd2a" href="#cd2a">[cd2a]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment by 1.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare either for the next loop or for termination.
;
</div><span class="l"><a class="anc" name="cd2b" href="#cd2b">[cd2b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Load our next PPU data byte for the next loop.</span></span>
<span class="l"><a class="anc" name="cd2e" href="#cd2e">[cd2e]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Decrement our loop index by 1.</span></span>
<span class="l"><a class="anc" name="cd30" href="#cd30">[cd30]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><a class="anc" name="cd32" href="#cd32">[cd32]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="PPUBUFFER_DRAWCOMMAND_0xFA_MASKS"></a><div class="c">;
; XREFS:
;     <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>
;
</div><span class="l"><a class="anc" name="cd33" href="#cd33">[cd33]</a><a href="#PPUBUFFER_DRAWCOMMAND_0xFA_MASKS" class="la">PPUBUFFER_DRAWCOMMAND_0xFA_MASKS:</a><span class="ce">; [$cd33]</span></span>
<span class="l"><a class="anc" name="cd33" href="#cd33">[cd33]</a><span class="cd"><span class="i">db</span> <span class="o">$fe</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="cd34" href="#cd34">[cd34]</a><span class="cd"><span class="i">db</span> <span class="o">$df</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="cd35" href="#cd35">[cd35]</a><span class="cd"><span class="i">db</span> <span class="o">$f7</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="cd36" href="#cd36">[cd36]</a><span class="cd"><span class="i">db</span> <span class="o">$fd</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="cd37" href="#cd37">[cd37]</a><span class="cd"><span class="i">db</span> <span class="o">$bf</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="cd38" href="#cd38">[cd38]</a><span class="cd"><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="cd39" href="#cd39">[cd39]</a><span class="cd"><span class="i">db</span> <span class="o">$7f</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="cd3a" href="#cd3a">[cd3a]</a><span class="cd"><span class="i">db</span> <span class="o">$fb</span></span><span class="ce">; [7]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_DrawCommand_RotateTilesRight1Pixel"></a><div class="cp">;============================================================================
; Rotate 16 bytes of tiles right by 1 pixel.
;
; This PPUBuffer draw command will read the upper and
; lower bytes of a PPU address and then iterate over the
; next 16 bytes at that address, rotating all data right
; by 1 pixel.
;
; INPUTS:
;     {@sybmol PPUBuffer}:
;         The PPU buffer to read from.
;
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The offset within the PPU buffer to read from.
;
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The PPU address to read and write.
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The PPU data to read and write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The updated offset within the PPU buffer.
;
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The written PPU address.
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The written PPU data.
;
; TEMP VARIABLES:
;     <a href="RAM.html#Temp_06">Temp_06</a>
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc4]
;============================================================================
</div><span class="l"><a class="anc" name="cd3b" href="#cd3b">[cd3b]</a><a href="#PPUBuffer_DrawCommand_RotateTilesRight1Pixel" class="la">PPUBuffer_DrawCommand_RotateTilesRight1Pixel:</a><span class="ce">; [$cd3b]</span></span>
<div class="c">;
; Read the first two bytes from the offset and set as
; the PPUADDR.
;
</div><span class="l"><a class="anc" name="cd3b" href="#cd3b">[cd3b]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Load our current PPU buffer offset.</span></span>
<span class="l"><a class="anc" name="cd3d" href="#cd3d">[cd3d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the first address byte from the buffer.</span></span>
<span class="l"><a class="anc" name="cd40" href="#cd40">[cd40]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="cd41" href="#cd41">[cd41]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = byte 1</span></span>
<span class="l"><a class="anc" name="cd42" href="#cd42">[cd42]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the upper byte of the PPU address.</span></span>
<span class="l"><a class="anc" name="cd45" href="#cd45">[cd45]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the next address byte.</span></span>
<span class="l"><a class="anc" name="cd48" href="#cd48">[cd48]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="cd49" href="#cd49">[cd49]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Update the offset to skip these bytes.</span></span>
<span class="l"><a class="anc" name="cd4b" href="#cd4b">[cd4b]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="cd4c" href="#cd4c">[cd4c]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the lower byte of the PPU address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin preparing for drawing.
;
; We'll draw 16 bytes from the buffer.
;
</div><span class="l"><a class="anc" name="cd4f" href="#cd4f">[cd4f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; Set our loop for 16 bytes.</span></span>
<span class="l"><a class="anc" name="cd51" href="#cd51">[cd51]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="cd53" href="#cd53">[cd53]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Load byte 1 from the PPU.</span></span>
<span class="l"></span>
<a name=":cd56:@_loop"></a><span class="l"><a class="anc" name="cd56" href="#cd56">[cd56]</a><a href="#:cd56:@_loop" class="lla">@_loop:</a><span class="ce">; [$cd56]</span></span>
<span class="l"><a class="anc" name="cd56" href="#cd56">[cd56]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Load a byte from the PPU.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the address again. The PPUDATA read advanced the offset.
;
</div><span class="l"><a class="anc" name="cd59" href="#cd59">[cd59]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper byte of PPU address to Y.</span></span>
<span class="l"><a class="anc" name="cd5c" href="#cd5c">[cd5c]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set lower byte of PPU address to X.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Rotate the tile data from this address right by 1 pixel.
;
</div><span class="l"><a class="anc" name="cd5f" href="#cd5f">[cd5f]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="cd60" href="#cd60">[cd60]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Rotate the pixel data right by 1.</span></span>
<span class="l"><a class="anc" name="cd61" href="#cd61">[cd61]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="cd62" href="#cd62">[cd62]</a><span class="cd"><span class="i">ROR</span> <span class="o">A</span></span><span class="ce">; OR it to the data rotated left by 7.</span></span>
<span class="l"><a class="anc" name="cd63" href="#cd63">[cd63]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Store the rotated data.</span></span>
<span class="l"><a class="anc" name="cd66" href="#cd66">[cd66]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment the lower byte of the PPU address.</span></span>
<span class="l"><a class="anc" name="cd67" href="#cd67">[cd67]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if we're at the end of the loop.
;
; If we've processed 16 entries, we're done.
;
</div><span class="l"><a class="anc" name="cd6a" href="#cd6a">[cd6a]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Decrement our loop counter.</span></span>
<span class="l"><a class="anc" name="cd6c" href="#cd6c">[cd6c]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If it's &gt; 0, loop.</span></span>
<span class="l"><a class="anc" name="cd6e" href="#cd6e">[cd6e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CurrentSprite_ResetPPUTileOffset"></a><div class="cp">;============================================================================
; Reset the PPU tile offset for loading sprite tiles.
;
; This will reset to a value of $0900.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>:
;     <a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>+1:
;         The updated offset ($0900).
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#Screen_ClearSprites">Screen_ClearSprites</a>
;============================================================================
</div><span class="l"><a class="anc" name="cd6f" href="#cd6f">[cd6f]</a><a href="#CurrentSprite_ResetPPUTileOffset" class="la">CurrentSprite_ResetPPUTileOffset:</a><span class="ce">; [$cd6f]</span></span>
<span class="l"><a class="anc" name="cd6f" href="#cd6f">[cd6f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$09</span></span></span>
<span class="l"><a class="anc" name="cd71" href="#cd71">[cd71]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr_U">CurrentSprite_TargetPPUTileAddr_U</a></span></span><span class="ce">; Set upper to 0x09.</span></span>
<span class="l"><a class="anc" name="cd73" href="#cd73">[cd73]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cd75" href="#cd75">[cd75]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a></span></span><span class="ce">; Set lower to 0x00.</span></span>
<span class="l"><a class="anc" name="cd77" href="#cd77">[cd77]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="CurrentSprite_LoadTilesInfo"></a><div class="cp">;============================================================================
; Look up tile information needed to draw a sprite.
;
; This will take the sprite entity ID and look up the starting
; address for tile data and the number of tiles to draw.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank to switch back to after load.
;
;     <a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a>:
;         The current sprite entity being loaded.
;
;     <a href="RAM.html#CurrentSprite_TilesBank">CurrentSprite_TilesBank</a>:
;         The tiles bank for the current sprite.
;
;     <a href="#SPRITES_PPU_TILE_COUNTS">SPRITES_PPU_TILE_COUNTS</a>:
;         The lookup table of entity ID to tile count.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a>+1:
;     <a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a>:
;         The address for the tiles to load.
;
;     <a href="RAM.html#CurrentSprite_LoadTileCount">CurrentSprite_LoadTileCount</a>:
;         The number of tiles to load.
;
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a>
;============================================================================
</div><span class="l"><a class="anc" name="cd78" href="#cd78">[cd78]</a><a href="#CurrentSprite_LoadTilesInfo" class="la">CurrentSprite_LoadTilesInfo:</a><span class="ce">; [$cd78]</span></span>
<div class="c">;
; Save the current ROM bank to the stack.
;
</div><span class="l"><a class="anc" name="cd78" href="#cd78">[cd78]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current bank.</span></span>
<span class="l"><a class="anc" name="cd7b" href="#cd7b">[cd7b]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to the bank for the current sprite's images.
;
</div><span class="l"><a class="anc" name="cd7c" href="#cd7c">[cd7c]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSprite_TilesBank">CurrentSprite_TilesBank</a></span></span><span class="ce">; Load the bank where the images for the current sprite are found</span></span>
<span class="l"><a class="anc" name="cd7f" href="#cd7f">[cd7f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the first byte of the ROM bank and store as the start of
; the lower byte of the sprite images address.
;
</div><span class="l"><a class="anc" name="cd82" href="#cd82">[cd82]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Read byte from $8000.</span></span>
<span class="l"><a class="anc" name="cd85" href="#cd85">[cd85]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte of the address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Read the second byte as the upper address, and add 0x80 to it.
;
</div><span class="l"><a class="anc" name="cd87" href="#cd87">[cd87]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a>+1</span></span><span class="ce">; Read byte from $8001.</span></span>
<span class="l"><a class="anc" name="cd8a" href="#cd8a">[cd8a]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="cd8b" href="#cd8b">[cd8b]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80.</span></span>
<span class="l"><a class="anc" name="cd8d" href="#cd8d">[cd8d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store as the upper byte of the address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the starting index for the sprite based on the
; entity ID.
;
; Entities 0-55 are in the first sprite bank. 56+ are in
; the second.
;
</div><span class="l"><a class="anc" name="cd8f" href="#cd8f">[cd8f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the current sprite ID</span></span>
<span class="l"><a class="anc" name="cd92" href="#cd92">[cd92]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$37</span></span><span class="ce">; Check if we're on the next bank.</span></span>
<span class="l"><a class="anc" name="cd94" href="#cd94">[cd94]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loadImages">@_loadImages</a></span></span></span>
<span class="l"><a class="anc" name="cd96" href="#cd96">[cd96]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$37</span></span><span class="ce">; We are, so subtract 55 for the new sprite index.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cd98:@_loadImages"></a><div class="c">;
; Compute the address for the sprite image.
;
</div><span class="l"><a class="anc" name="cd98" href="#cd98">[cd98]</a><a href="#:cd98:@_loadImages" class="lla">@_loadImages:</a><span class="ce">; [$cd98]</span></span>
<span class="l"><a class="anc" name="cd98" href="#cd98">[cd98]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert the sprite ID to a word boundary.</span></span>
<span class="l"><a class="anc" name="cd99" href="#cd99">[cd99]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="cd9a" href="#cd9a">[cd9a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Get the pointer to the sprite data from the bank address computed above.</span></span>
<span class="l"><a class="anc" name="cd9c" href="#cd9c">[cd9c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a></span></span><span class="ce">; A = Lower byte of the image data address.</span></span>
<span class="l"><a class="anc" name="cd9e" href="#cd9e">[cd9e]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="cd9f" href="#cd9f">[cd9f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; A = Upper byte of the address.</span></span>
<span class="l"><a class="anc" name="cda1" href="#cda1">[cda1]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="cda2" href="#cda2">[cda2]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper address.</span></span>
<span class="l"><a class="anc" name="cda4" href="#cda4">[cda4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileAddr_U">CurrentSprite_LoadTileAddr_U</a></span></span><span class="ce">; Upper byte of pointer to the sprite bitmap</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Get the PPU tile numbers for the sprite entity and store
; it for lookup.
;
</div><span class="l"><a class="anc" name="cda6" href="#cda6">[cda6]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentSprite_Entity">CurrentSprite_Entity</a></span></span><span class="ce">; Load the current sprite ID</span></span>
<span class="l"><a class="anc" name="cda9" href="#cda9">[cda9]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="cdaa" href="#cdaa">[cdaa]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SPRITES_PPU_TILE_COUNTS">SPRITES_PPU_TILE_COUNTS</a>,Y</span></span><span class="ce">; Get the number of tiles needed</span></span>
<span class="l"><a class="anc" name="cdad" href="#cdad">[cdad]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileCount">CurrentSprite_LoadTileCount</a></span></span><span class="ce">; Store that for the render</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><a class="anc" name="cdaf" href="#cdaf">[cdaf]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank.</span></span>
<span class="l"><a class="anc" name="cdb0" href="#cdb0">[cdb0]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Transfer to X.</span></span>
<span class="l"><a class="anc" name="cdb1" href="#cdb1">[cdb1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Update to the bank.</span></span>
<span class="l"><a class="anc" name="cdb4" href="#cdb4">[cdb4]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_LoadImageForCurrentSprite"></a><div class="cp">;============================================================================
; Load all tiles required for a sprite into the PPU.
;
; This will load information on the tiles needed for the
; current sprite entity, and will then iterate through each
; tile, writing it to the PPU buffer.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>+1:
;     <a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>:
;         The target PPU address to begin writing to.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>+1:
;     <a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>:
;         The new target PPU address for the next sprite.
;
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer populated with new tile data.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new PPU buffer write offset.
;
;     <a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a>+1:
;     <a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a>:
;     <a href="RAM.html#CurrentSprite_LoadTileCount">CurrentSprite_LoadTileCount</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#CurrentSprite_LoadTilesInfo">CurrentSprite_LoadTilesInfo</a>
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;============================================================================
</div><span class="l"><a class="anc" name="cdb5" href="#cdb5">[cdb5]</a><a href="#Sprites_LoadImageForCurrentSprite" class="la">Sprites_LoadImageForCurrentSprite:</a><span class="ce">; [$cdb5]</span></span>
<div class="c">;
; Calculate the starting PPU tile offset for this sprite.
;
; This is equivalent to:
;
;     // Lower byte
;     <a href="RAM.html#Temp_00">Temp_00</a> =
;     (byte)(<a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a> &lt;&lt; 4);
;
;     // Upper byte
;     <a href="RAM.html#CurrentSprite_StartPPUTileOffset">CurrentSprite_StartPPUTileOffset</a> = (byte)(
;         (<a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a>+1 &lt;&lt; 4) |
;         (<a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a> &gt;&gt; 4)
;     );
;
</div><span class="l"><a class="anc" name="cdb5" href="#cdb5">[cdb5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a></span></span><span class="ce">; Load the lower byte of the current PPU tile address to read from.</span></span>
<span class="l"><a class="anc" name="cdb7" href="#cdb7">[cdb7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><a class="anc" name="cdb9" href="#cdb9">[cdb9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr_U">CurrentSprite_TargetPPUTileAddr_U</a></span></span><span class="ce">; Load the upper byte of the PPU tile address.</span></span>
<span class="l"><a class="anc" name="cdbb" href="#cdbb">[cdbb]</a><span class="cd"><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Multiply by 16.</span></span>
<span class="l"><a class="anc" name="cdbd" href="#cdbd">[cdbd]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cdbe" href="#cdbe">[cdbe]</a><span class="cd"><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="cdc0" href="#cdc0">[cdc0]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cdc1" href="#cdc1">[cdc1]</a><span class="cd"><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="cdc3" href="#cdc3">[cdc3]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cdc4" href="#cdc4">[cdc4]</a><span class="cd"><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="cdc6" href="#cdc6">[cdc6]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span><span class="ce">; A = Lower byte of the offset.</span></span>
<span class="l"><a class="anc" name="cdc7" href="#cdc7">[cdc7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_StartPPUTileOffset">CurrentSprite_StartPPUTileOffset</a></span></span><span class="ce">; Store the upper byte as the starting offset.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tile information for the sprite, and proceed to
; load into the PPU if the sprite entity has tiles.
;
</div><span class="l"><a class="anc" name="cdc9" href="#cdc9">[cdc9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#CurrentSprite_LoadTilesInfo">CurrentSprite_LoadTilesInfo</a></span></span><span class="ce">; Look up the sprite data pointer for this.</span></span>
<span class="l"><a class="anc" name="cdcc" href="#cdcc">[cdcc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileCount">CurrentSprite_LoadTileCount</a></span></span><span class="ce">; A = Tile count.</span></span>
<span class="l"><a class="anc" name="cdce" href="#cdce">[cdce]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadSpriteToPPUBuffer">@_loadSpriteToPPUBuffer</a></span></span><span class="ce">; If count &gt; 0, jump to load tile data.</span></span>
<span class="l"><a class="anc" name="cdd0" href="#cdd0">[cdd0]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cdd1:@_loadSpriteToPPUBuffer"></a><div class="c">;
; Switch to the bank containing the tiles to load.
;
</div><span class="l"><a class="anc" name="cdd1" href="#cdd1">[cdd1]</a><a href="#:cdd1:@_loadSpriteToPPUBuffer" class="lla">@_loadSpriteToPPUBuffer:</a><span class="ce">; [$cdd1]</span></span>
<span class="l"><a class="anc" name="cdd1" href="#cdd1">[cdd1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="cdd4" href="#cdd4">[cdd4]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="cdd5" href="#cdd5">[cdd5]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#CurrentSprite_TilesBank">CurrentSprite_TilesBank</a></span></span><span class="ce">; X = Bank for the tiles.</span></span>
<span class="l"><a class="anc" name="cdd8" href="#cdd8">[cdd8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to that bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the PPU address to load tiles into.
;
</div><span class="l"><a class="anc" name="cddb" href="#cddb">[cddb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr_U">CurrentSprite_TargetPPUTileAddr_U</a></span></span><span class="ce">; Load the upper byte of the target PPU address.</span></span>
<span class="l"><a class="anc" name="cddd" href="#cddd">[cddd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="cddf" href="#cddf">[cddf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a></span></span><span class="ce">; Load the lower byte.</span></span>
<span class="l"><a class="anc" name="cde1" href="#cde1">[cde1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Queue loading 16 bytes for the current tile.
;
</div><span class="l"><a class="anc" name="cde3" href="#cde3">[cde3]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16 (bytes)</span></span>
<span class="l"><a class="anc" name="cde5" href="#cde5">[cde5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue as the length, and set X as the write index.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Copy the sprite data for this tile to the PPU buffer.
;
</div><span class="l"><a class="anc" name="cde8" href="#cde8">[cde8]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (loop counter)</span></span>
<span class="l"></span>
<a name=":cdea:@_copySpriteImage"></a><span class="l"><a class="anc" name="cdea" href="#cdea">[cdea]</a><a href="#:cdea:@_copySpriteImage" class="lla">@_copySpriteImage:</a><span class="ce">; [$cdea]</span></span>
<span class="l"><a class="anc" name="cdea" href="#cdea">[cdea]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a>),Y</span></span><span class="ce">; Load a byte from the tile.</span></span>
<span class="l"><a class="anc" name="cdec" href="#cdec">[cdec]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write to the PPU buffer at X.</span></span>
<span class="l"><a class="anc" name="cdef" href="#cdef">[cdef]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (write offset)</span></span>
<span class="l"><a class="anc" name="cdf0" href="#cdf0">[cdf0]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter)</span></span>
<span class="l"><a class="anc" name="cdf1" href="#cdf1">[cdf1]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span><span class="ce">; Is X &lt; 16?</span></span>
<span class="l"><a class="anc" name="cdf3" href="#cdf3">[cdf3]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_copySpriteImage">@_copySpriteImage</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; 16 bytes of sprite data was written to the PPU buffer.
; Update the new write position for the buffer.
;
</div><span class="l"><a class="anc" name="cdf5" href="#cdf5">[cdf5]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store the resulting PPU buffer write offset.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><a class="anc" name="cdf7" href="#cdf7">[cdf7]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the previous bank from the stack.</span></span>
<span class="l"><a class="anc" name="cdf8" href="#cdf8">[cdf8]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set to X.</span></span>
<span class="l"><a class="anc" name="cdf9" href="#cdf9">[cdf9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the source tile address to advance to the next tile.
;
</div><span class="l"><a class="anc" name="cdfc" href="#cdfc">[cdfc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a></span></span><span class="ce">; Load the lower byte of the tile address.</span></span>
<span class="l"><a class="anc" name="cdfe" href="#cdfe">[cdfe]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="cdff" href="#cdff">[cdff]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Add 16 (the bytes we just read).</span></span>
<span class="l"><a class="anc" name="ce01" href="#ce01">[ce01]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileAddr">CurrentSprite_LoadTileAddr</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="ce03" href="#ce03">[ce03]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileAddr_U">CurrentSprite_LoadTileAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ce05" href="#ce05">[ce05]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add Carry, if the lower byte wrapped.</span></span>
<span class="l"><a class="anc" name="ce07" href="#ce07">[ce07]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileAddr_U">CurrentSprite_LoadTileAddr_U</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the target PPU tile address to advance to the next
; tile.
;
</div><span class="l"><a class="anc" name="ce09" href="#ce09">[ce09]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a></span></span><span class="ce">; Load the lower byte of the target address.</span></span>
<span class="l"><a class="anc" name="ce0b" href="#ce0b">[ce0b]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ce0c" href="#ce0c">[ce0c]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Add 16.</span></span>
<span class="l"><a class="anc" name="ce0e" href="#ce0e">[ce0e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr">CurrentSprite_TargetPPUTileAddr</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="ce10" href="#ce10">[ce10]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr_U">CurrentSprite_TargetPPUTileAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ce12" href="#ce12">[ce12]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add Carry, if the lower byte wrapped.</span></span>
<span class="l"><a class="anc" name="ce14" href="#ce14">[ce14]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_TargetPPUTileAddr_U">CurrentSprite_TargetPPUTileAddr_U</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Decrement the tile count, and loop if there are tiles
; remaining.
;
</div><span class="l"><a class="anc" name="ce16" href="#ce16">[ce16]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#CurrentSprite_LoadTileCount">CurrentSprite_LoadTileCount</a></span></span><span class="ce">; Decrement the remaining tile count.</span></span>
<span class="l"><a class="anc" name="ce18" href="#ce18">[ce18]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadSpriteToPPUBuffer">@_loadSpriteToPPUBuffer</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"><a class="anc" name="ce1a" href="#ce1a">[ce1a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SPRITES_PPU_TILE_COUNTS"></a><div class="cp">;============================================================================
; The number of PPU tiles each sprite needs.
;
; XREFS:
;     <a href="#CurrentSprite_LoadTilesInfo">CurrentSprite_LoadTilesInfo</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#CurrentSprite_LoadTilesInfo">CurrentSprite_LoadTilesInfo</a>
;
</div><span class="l"><a class="anc" name="ce1b" href="#ce1b">[ce1b]</a><a href="#SPRITES_PPU_TILE_COUNTS" class="la">SPRITES_PPU_TILE_COUNTS:</a><span class="ce">; [$ce1b]</span></span>
<span class="l"><a class="anc" name="ce1b" href="#ce1b">[ce1b]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="ce1c" href="#ce1c">[ce1c]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Dropped: Bread</span></span>
<span class="l"><a class="anc" name="ce1d" href="#ce1d">[ce1d]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [2]: Dropped: Coin</span></span>
<span class="l"><a class="anc" name="ce1e" href="#ce1e">[ce1e]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [3]: Enemy: ?</span></span>
<span class="l"><a class="anc" name="ce1f" href="#ce1f">[ce1f]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [4]: Enemy: Raiden</span></span>
<span class="l"><a class="anc" name="ce20" href="#ce20">[ce20]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [5]: Enemy: Necron Aides</span></span>
<span class="l"><a class="anc" name="ce21" href="#ce21">[ce21]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [6]: Enemy: Zombie</span></span>
<span class="l"><a class="anc" name="ce22" href="#ce22">[ce22]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [7]: Enemy: Hornet</span></span>
<span class="l"><a class="anc" name="ce23" href="#ce23">[ce23]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [8]: Enemy: Bihoruda</span></span>
<span class="l"><a class="anc" name="ce24" href="#ce24">[ce24]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [9]: Enemy: Lilith</span></span>
<span class="l"><a class="anc" name="ce25" href="#ce25">[ce25]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [10]: Magic: ?</span></span>
<span class="l"><a class="anc" name="ce26" href="#ce26">[ce26]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [11]: Enemy: Yuinaru</span></span>
<span class="l"><a class="anc" name="ce27" href="#ce27">[ce27]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [12]: Enemy: Snowman</span></span>
<span class="l"><a class="anc" name="ce28" href="#ce28">[ce28]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [13]: Enemy: Nash</span></span>
<span class="l"><a class="anc" name="ce29" href="#ce29">[ce29]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [14]: Enemy: Fire Giant</span></span>
<span class="l"><a class="anc" name="ce2a" href="#ce2a">[ce2a]</a><span class="cd"><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [15]: Enemy: Ishiisu</span></span>
<span class="l"><a class="anc" name="ce2b" href="#ce2b">[ce2b]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [16]: Enemy: Execution Hood</span></span>
<span class="l"><a class="anc" name="ce2c" href="#ce2c">[ce2c]</a><span class="cd"><span class="i">db</span> <span class="o">$26</span></span><span class="ce">; [17]: Boss: Rokusutahn</span></span>
<span class="l"><a class="anc" name="ce2d" href="#ce2d">[ce2d]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [18]: Boss: unused (round body of snake boss)</span></span>
<span class="l"><a class="anc" name="ce2e" href="#ce2e">[ce2e]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]: Effect: Enemy death</span></span>
<span class="l"><a class="anc" name="ce2f" href="#ce2f">[ce2f]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [20]: Effect: Lightning ball</span></span>
<span class="l"><a class="anc" name="ce30" href="#ce30">[ce30]</a><span class="cd"><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; [21]: Enemy: Charron</span></span>
<span class="l"><a class="anc" name="ce31" href="#ce31">[ce31]</a><span class="cd"><span class="i">db</span> <span class="o">$17</span></span><span class="ce">; [22]: Enemy: ? (Unused)</span></span>
<span class="l"><a class="anc" name="ce32" href="#ce32">[ce32]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [23]: Enemy: Geributa</span></span>
<span class="l"><a class="anc" name="ce33" href="#ce33">[ce33]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [24]: Enemy: Sugata</span></span>
<span class="l"><a class="anc" name="ce34" href="#ce34">[ce34]</a><span class="cd"><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [25]: Enemy: Grimlock</span></span>
<span class="l"><a class="anc" name="ce35" href="#ce35">[ce35]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [26]: Enemy: Giant Bees</span></span>
<span class="l"><a class="anc" name="ce36" href="#ce36">[ce36]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [27]: Enemy: Myconid</span></span>
<span class="l"><a class="anc" name="ce37" href="#ce37">[ce37]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [28]: Enemy: Naga</span></span>
<span class="l"><a class="anc" name="ce38" href="#ce38">[ce38]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [29]: Enemy: Skeleton Knight (unused)</span></span>
<span class="l"><a class="anc" name="ce39" href="#ce39">[ce39]</a><span class="cd"><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [30]: Enemy: Giant Strider</span></span>
<span class="l"><a class="anc" name="ce3a" href="#ce3a">[ce3a]</a><span class="cd"><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [31]: Enemy: Sir Gawaine</span></span>
<span class="l"><a class="anc" name="ce3b" href="#ce3b">[ce3b]</a><span class="cd"><span class="i">db</span> <span class="o">$1f</span></span><span class="ce">; [32]: Enemy: Maskman</span></span>
<span class="l"><a class="anc" name="ce3c" href="#ce3c">[ce3c]</a><span class="cd"><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; [33]: Enemy: Wolfman</span></span>
<span class="l"><a class="anc" name="ce3d" href="#ce3d">[ce3d]</a><span class="cd"><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [34]: Enemy: Yareeka</span></span>
<span class="l"><a class="anc" name="ce3e" href="#ce3e">[ce3e]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [35]: Enemy: Magman</span></span>
<span class="l"><a class="anc" name="ce3f" href="#ce3f">[ce3f]</a><span class="cd"><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [36]: Enemy: Curly-tailed guy with spear (unused)</span></span>
<span class="l"><a class="anc" name="ce40" href="#ce40">[ce40]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [37]: Enemy: ? (unused)</span></span>
<span class="l"><a class="anc" name="ce41" href="#ce41">[ce41]</a><span class="cd"><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [38]: Enemy: Ikeda</span></span>
<span class="l"><a class="anc" name="ce42" href="#ce42">[ce42]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [39]: Enemy: Muppet guy (unused)</span></span>
<span class="l"><a class="anc" name="ce43" href="#ce43">[ce43]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [40]: Enemy: Lamprey</span></span>
<span class="l"><a class="anc" name="ce44" href="#ce44">[ce44]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [41]: Enemy: ? (unused)</span></span>
<span class="l"><a class="anc" name="ce45" href="#ce45">[ce45]</a><span class="cd"><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [42]: Enemy: Monodron</span></span>
<span class="l"><a class="anc" name="ce46" href="#ce46">[ce46]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [43]: Enemy: Winged skeleton (unused)</span></span>
<span class="l"><a class="anc" name="ce47" href="#ce47">[ce47]</a><span class="cd"><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [44]: Enemy: Tamazutsu</span></span>
<span class="l"><a class="anc" name="ce48" href="#ce48">[ce48]</a><span class="cd"><span class="i">db</span> <span class="o">$3e</span></span><span class="ce">; [45]: Boss: Ripasheiku</span></span>
<span class="l"><a class="anc" name="ce49" href="#ce49">[ce49]</a><span class="cd"><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [46]: Boss: Zoradohna</span></span>
<span class="l"><a class="anc" name="ce4a" href="#ce4a">[ce4a]</a><span class="cd"><span class="i">db</span> <span class="o">$1c</span></span><span class="ce">; [47]: Boss: Borabohra</span></span>
<span class="l"><a class="anc" name="ce4b" href="#ce4b">[ce4b]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [48]: Boss: Pakukame</span></span>
<span class="l"><a class="anc" name="ce4c" href="#ce4c">[ce4c]</a><span class="cd"><span class="i">db</span> <span class="o">$25</span></span><span class="ce">; [49]: Boss: Zorugeriru</span></span>
<span class="l"><a class="anc" name="ce4d" href="#ce4d">[ce4d]</a><span class="cd"><span class="i">db</span> <span class="o">$54</span></span><span class="ce">; [50]: Boss: King Grieve</span></span>
<span class="l"><a class="anc" name="ce4e" href="#ce4e">[ce4e]</a><span class="cd"><span class="i">db</span> <span class="o">$69</span></span><span class="ce">; [51]: Boss: Shadow Eura</span></span>
<span class="l"><a class="anc" name="ce4f" href="#ce4f">[ce4f]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [52]: NPC: Walking Man 1</span></span>
<span class="l"><a class="anc" name="ce50" href="#ce50">[ce50]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [53]: NPC: Blue lady (unused)</span></span>
<span class="l"><a class="anc" name="ce51" href="#ce51">[ce51]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [54]: NPC: Child (unused)</span></span>
<span class="l"><a class="anc" name="ce52" href="#ce52">[ce52]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [55]: NPC: Armor Salesman</span></span>
<span class="l"><a class="anc" name="ce53" href="#ce53">[ce53]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [56]: NPC: Martial Artist</span></span>
<span class="l"><a class="anc" name="ce54" href="#ce54">[ce54]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [57]: NPC: Priest</span></span>
<span class="l"><a class="anc" name="ce55" href="#ce55">[ce55]</a><span class="cd"><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [58]: NPC: King</span></span>
<span class="l"><a class="anc" name="ce56" href="#ce56">[ce56]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [59]: NPC: Magic Teacher</span></span>
<span class="l"><a class="anc" name="ce57" href="#ce57">[ce57]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [60]: NPC: Key Salesman</span></span>
<span class="l"><a class="anc" name="ce58" href="#ce58">[ce58]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [61]: NPC: Smoking Man</span></span>
<span class="l"><a class="anc" name="ce59" href="#ce59">[ce59]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [62]: NPC: Man in Chair</span></span>
<span class="l"><a class="anc" name="ce5a" href="#ce5a">[ce5a]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [63]: NPC: Sitting Man</span></span>
<span class="l"><a class="anc" name="ce5b" href="#ce5b">[ce5b]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [64]: NPC: Meat Salesman</span></span>
<span class="l"><a class="anc" name="ce5c" href="#ce5c">[ce5c]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [65]: NPC: Lady in Blue Dress with Cup</span></span>
<span class="l"><a class="anc" name="ce5d" href="#ce5d">[ce5d]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [66]: NPC: Guard</span></span>
<span class="l"><a class="anc" name="ce5e" href="#ce5e">[ce5e]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [67]: NPC: Doctor</span></span>
<span class="l"><a class="anc" name="ce5f" href="#ce5f">[ce5f]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [68]: NPC: Walking Woman 1</span></span>
<span class="l"><a class="anc" name="ce60" href="#ce60">[ce60]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [69]: NPC: Walking Woman 2</span></span>
<span class="l"><a class="anc" name="ce61" href="#ce61">[ce61]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [70]: Enemy: Eyeball (unused)</span></span>
<span class="l"><a class="anc" name="ce62" href="#ce62">[ce62]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [71]: Enemy: Zozura</span></span>
<span class="l"><a class="anc" name="ce63" href="#ce63">[ce63]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [72]: Item: Glove</span></span>
<span class="l"><a class="anc" name="ce64" href="#ce64">[ce64]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [73]: Item: Black Onyx</span></span>
<span class="l"><a class="anc" name="ce65" href="#ce65">[ce65]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [74]: Item: Pendant</span></span>
<span class="l"><a class="anc" name="ce66" href="#ce66">[ce66]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [75]: Item: Red Potion</span></span>
<span class="l"><a class="anc" name="ce67" href="#ce67">[ce67]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [76]: Item: Poison</span></span>
<span class="l"><a class="anc" name="ce68" href="#ce68">[ce68]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [77]: Item: Elixir</span></span>
<span class="l"><a class="anc" name="ce69" href="#ce69">[ce69]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [78]: Item: Ointment</span></span>
<span class="l"><a class="anc" name="ce6a" href="#ce6a">[ce6a]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [79]: Trigger: Intro</span></span>
<span class="l"><a class="anc" name="ce6b" href="#ce6b">[ce6b]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [80]: Item: Mattock</span></span>
<span class="l"><a class="anc" name="ce6c" href="#ce6c">[ce6c]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [81]: Magic: ?</span></span>
<span class="l"><a class="anc" name="ce6d" href="#ce6d">[ce6d]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [82]: Effect: Fountain</span></span>
<span class="l"><a class="anc" name="ce6e" href="#ce6e">[ce6e]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [83]: Magic: ?</span></span>
<span class="l"><a class="anc" name="ce6f" href="#ce6f">[ce6f]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [84]: Magic: Enemy Fireball</span></span>
<span class="l"><a class="anc" name="ce70" href="#ce70">[ce70]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [85]: Item: Wing Boots</span></span>
<span class="l"><a class="anc" name="ce71" href="#ce71">[ce71]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [86]: Item: Hour Glass</span></span>
<span class="l"><a class="anc" name="ce72" href="#ce72">[ce72]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [87]: Item: Magical Rod</span></span>
<span class="l"><a class="anc" name="ce73" href="#ce73">[ce73]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [88]: Item: Battle Suit</span></span>
<span class="l"><a class="anc" name="ce74" href="#ce74">[ce74]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [89]: Item: Battle Helmet</span></span>
<span class="l"><a class="anc" name="ce75" href="#ce75">[ce75]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [90]: Item: Dragon Slayer</span></span>
<span class="l"><a class="anc" name="ce76" href="#ce76">[ce76]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [91]: Item: Mattock</span></span>
<span class="l"><a class="anc" name="ce77" href="#ce77">[ce77]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [92]: Item: Wing Boots (from quest)</span></span>
<span class="l"><a class="anc" name="ce78" href="#ce78">[ce78]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [93]: Item: Red Potion</span></span>
<span class="l"><a class="anc" name="ce79" href="#ce79">[ce79]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [94]: Item: Poison</span></span>
<span class="l"><a class="anc" name="ce7a" href="#ce7a">[ce7a]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [95]: Item: Glove</span></span>
<span class="l"><a class="anc" name="ce7b" href="#ce7b">[ce7b]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [96]: Item: Ointment</span></span>
<span class="l"><a class="anc" name="ce7c" href="#ce7c">[ce7c]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [97]: Effect: Spring of Trunk</span></span>
<span class="l"><a class="anc" name="ce7d" href="#ce7d">[ce7d]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [98]: Effect: Spring of Sky</span></span>
<span class="l"><a class="anc" name="ce7e" href="#ce7e">[ce7e]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [99]: Effect: Spring of Tower</span></span>
<span class="l"><a class="anc" name="ce7f" href="#ce7f">[ce7f]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [100]: Effect: Boss Death</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_LoadCommon"></a><div class="cp">;============================================================================
; Load common sprites from bank 8.
;
; This will load 80 sprites (5 passes of 16 sprites at
; 1,280 bytes total) from bank 8 into the PPU.
;
; The sprites consist of the coins, bread, damage effects,
; magic, HUD and textbox symbols, and the hand cursor.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         Written sprite data.
;
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;============================================================================
</div><span class="l"><a class="anc" name="ce80" href="#ce80">[ce80]</a><a href="#Sprites_LoadCommon" class="la">Sprites_LoadCommon:</a><span class="ce">; [$ce80]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8.
;
</div><span class="l"><a class="anc" name="ce80" href="#ce80">[ce80]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="ce83" href="#ce83">[ce83]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ce84" href="#ce84">[ce84]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; Bank 8 == sprite data.</span></span>
<span class="l"><a class="anc" name="ce86" href="#ce86">[ce86]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the start address for the sprites to load.
;
</div><span class="l"><a class="anc" name="ce89" href="#ce89">[ce89]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$8008</span></span><span class="ce">; Load the lower byte of the address of the first sprite (a coin).</span></span>
<span class="l"><a class="anc" name="ce8c" href="#ce8c">[ce8c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="ce8e" href="#ce8e">[ce8e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$8009</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ce91" href="#ce91">[ce91]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear Carry.</span></span>
<span class="l"><a class="anc" name="ce92" href="#ce92">[ce92]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><a class="anc" name="ce94" href="#ce94">[ce94]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; And store as the upper byte of the address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the sprite tile load count to 5 passes of 256 bytes,
; yielding 80 sprites.
;
</div><span class="l"><a class="anc" name="ce96" href="#ce96">[ce96]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$05</span></span><span class="ce">; 5 = number of passes of 256 bytes of sprite tiles to load.</span></span>
<span class="l"><a class="anc" name="ce98" href="#ce98">[ce98]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it for the loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the PPU address to $0400 (within the loaded PPU tiles).
;
</div><span class="l"><a class="anc" name="ce9a" href="#ce9a">[ce9a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; 0x04 == Upper byte.</span></span>
<span class="l"><a class="anc" name="ce9c" href="#ce9c">[ce9c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write it.</span></span>
<span class="l"><a class="anc" name="ce9f" href="#ce9f">[ce9f]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; 0x00 == Lower byte and loop counter.</span></span>
<span class="l"><a class="anc" name="cea1" href="#cea1">[cea1]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cea4:@_loadLoop"></a><div class="c">;
; Begin loading and writing sprites, 5 passes of 256 bytes.
;
</div><span class="l"><a class="anc" name="cea4" href="#cea4">[cea4]</a><a href="#:cea4:@_loadLoop" class="lla">@_loadLoop:</a><span class="ce">; [$cea4]</span></span>
<span class="l"><a class="anc" name="cea4" href="#cea4">[cea4]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the address of the sprite.</span></span>
<span class="l"><a class="anc" name="cea6" href="#cea6">[cea6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU data.</span></span>
<span class="l"><a class="anc" name="cea9" href="#cea9">[cea9]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter).</span></span>
<span class="l"><a class="anc" name="ceaa" href="#ceaa">[ceaa]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadLoop">@_loadLoop</a></span></span><span class="ce">; If not incremented back up to 0, loop.</span></span>
<span class="l"><a class="anc" name="ceac" href="#ceac">[ceac]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Increment the upper byte of the write address.</span></span>
<span class="l"><a class="anc" name="ceae" href="#ceae">[ceae]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the number of passes remaining.</span></span>
<span class="l"><a class="anc" name="ceb0" href="#ceb0">[ceb0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadLoop">@_loadLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Loading is complete. Restore the previous bank.
;
</div><span class="l"><a class="anc" name="ceb2" href="#ceb2">[ceb2]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank from the stack.</span></span>
<span class="l"><a class="anc" name="ceb3" href="#ceb3">[ceb3]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (bank)</span></span>
<span class="l"><a class="anc" name="ceb4" href="#ceb4">[ceb4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch back to the bank.</span></span>
<span class="l"><a class="anc" name="ceb7" href="#ceb7">[ceb7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_LoadTiles"></a><div class="cp">;============================================================================
; Load the tiles for the area into CHR RAM.
;
; The tiles will be loaded from bank 4.
;
; INPUTS:
;     <a href="RAM.html#Area_TilesReadAddress">Area_TilesReadAddress</a>:
;         The tiles address in the PPU.
;
;     <a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a>:
;         The index of the tileset to load.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="#TILE_INDEX_TO_ADDR">TILE_INDEX_TO_ADDR</a>:
;         Lookup table of addresses in bank 4 containing
;         the tiles.
;
;     <a href="#TILE_INDEX_TO_PPU_ADDR_UPPER">TILE_INDEX_TO_PPU_ADDR_UPPER</a>:
;         Lookup table of upper bytes of the PPU addresses
;         to write to.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The loaded PPU tile data.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPU_SetVRAMIncrementAdd1Across">PPU_SetVRAMIncrementAdd1Across</a>
;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a class="anc" name="ceb8" href="#ceb8">[ceb8]</a><a href="#Area_LoadTiles" class="la">Area_LoadTiles:</a><span class="ce">; [$ceb8]</span></span>
<div class="c">;
; Load the address for the tile data based on the tiles index.
;
</div><span class="l"><a class="anc" name="ceb8" href="#ceb8">[ceb8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span><span class="ce">; Set A = tileset index</span></span>
<span class="l"><a class="anc" name="ceba" href="#ceba">[ceba]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Set A = tileset index * 2 (word offset)</span></span>
<span class="l"><a class="anc" name="cebb" href="#cebb">[cebb]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Set Y = word offset into the pointer table</span></span>
<span class="l"><a class="anc" name="cebc" href="#cebc">[cebc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#TILE_INDEX_TO_ADDR">TILE_INDEX_TO_ADDR</a>,Y</span></span><span class="ce">; Read the low byte from the table</span></span>
<span class="l"><a class="anc" name="cebf" href="#cebf">[cebf]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesReadAddress">Area_TilesReadAddress</a></span></span><span class="ce">; Save low byte to TilesAddress</span></span>
<span class="l"><a class="anc" name="cec1" href="#cec1">[cec1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#TILE_INDEX_TO_ADDR">TILE_INDEX_TO_ADDR</a>+1,Y</span></span><span class="ce">; Read the high byte from the table</span></span>
<span class="l"><a class="anc" name="cec4" href="#cec4">[cec4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesReadAddress">Area_TilesReadAddress</a>+1</span></span><span class="ce">; Set high byte to TilesAddress</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the PPU to increment by +1 after each PPUDATA write.
;
</div><span class="l"><a class="anc" name="cec6" href="#cec6">[cec6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetVRAMIncrementAdd1Across">PPU_SetVRAMIncrementAdd1Across</a></span></span><span class="ce">; Set PPUDATA to increment by 1 per write.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load and set the PPU address for the current set of
; tiles. Set the upper byte from the table and lower
; byte to 0.
;
; Upper byte will be 0x18 or 0x1A.
;
</div><span class="l"><a class="anc" name="cec9" href="#cec9">[cec9]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span><span class="ce">; Load the tiles index.</span></span>
<span class="l"><a class="anc" name="cecb" href="#cecb">[cecb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#TILE_INDEX_TO_PPU_ADDR_UPPER">TILE_INDEX_TO_PPU_ADDR_UPPER</a>,Y</span></span><span class="ce">; Convert to a PPU address via lookup table (0x18 or 0x1A).</span></span>
<span class="l"><a class="anc" name="cece" href="#cece">[cece]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write as the upper byte.</span></span>
<span class="l"><a class="anc" name="ced1" href="#ced1">[ced1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; 0x00 = Lower byte (start of page).</span></span>
<span class="l"><a class="anc" name="ced3" href="#ced3">[ced3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write as the lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the remaining number of tiles.
;
; This is a 16-bit integer composed of:
;
;     <a href="RAM.html#Temp_08">Temp_08</a>: Lower byte
;     <a href="RAM.html#Temp_09">Temp_09</a>: Upper byte
;
</div><span class="l"><a class="anc" name="ced6" href="#ced6">[ced6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Set lower byte of the remaining tile count to 0.</span></span>
<span class="l"><a class="anc" name="ced8" href="#ced8">[ced8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#TILE_INDEX_TO_NUM_CHR_PAGES">TILE_INDEX_TO_NUM_CHR_PAGES</a>,Y</span></span><span class="ce">; Load the number of pages to load.</span></span>
<span class="l"><a class="anc" name="cedb" href="#cedb">[cedb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Set as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and switch to bank 4 (tile data).
;
</div><span class="l"><a class="anc" name="cedd" href="#cedd">[cedd]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = Current ROM bank.</span></span>
<span class="l"><a class="anc" name="cee0" href="#cee0">[cee0]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="cee1" href="#cee1">[cee1]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$04</span></span><span class="ce">; 4 = Tiles</span></span>
<span class="l"><a class="anc" name="cee3" href="#cee3">[cee3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 4 (tile data)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin loading tiles into PPUDATA.
;
</div><span class="l"><a class="anc" name="cee6" href="#cee6">[cee6]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Set Y = 0 (start page of loop)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cee8:@_copyLoop"></a><div class="c">;
; Stream 1 byte from tiles to the PPU.
;
</div><span class="l"><a class="anc" name="cee8" href="#cee8">[cee8]</a><a href="#:cee8:@_copyLoop" class="lla">@_copyLoop:</a><span class="ce">; [$cee8]</span></span>
<span class="l"><a class="anc" name="cee8" href="#cee8">[cee8]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Area_TilesReadAddress">Area_TilesReadAddress</a>),Y</span></span><span class="ce">; Load a byte from the tiles.</span></span>
<span class="l"><a class="anc" name="ceea" href="#ceea">[ceea]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increment our source pointer (Y++).
;
; If it wraps up to 0, we need to increment the upper byte
; of the tiles address it's loading from.
;
</div><span class="l"><a class="anc" name="ceed" href="#ceed">[ceed]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (source pointer).</span></span>
<span class="l"><a class="anc" name="ceee" href="#ceee">[ceee]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_noCarry">@_noCarry</a></span></span><span class="ce">; If wrapped to 0, jump.</span></span>
<span class="l"><a class="anc" name="cef0" href="#cef0">[cef0]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Area_TilesReadAddress">Area_TilesReadAddress</a>+1</span></span><span class="ce">; Increment the upper byte of the tiles address.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cef2:@_noCarry"></a><div class="c">;
; Decrement the 16-bit remaining tile count.
;
</div><span class="l"><a class="anc" name="cef2" href="#cef2">[cef2]</a><a href="#:cef2:@_noCarry" class="lla">@_noCarry:</a><span class="ce">; [$cef2]</span></span>
<span class="l"><a class="anc" name="cef2" href="#cef2">[cef2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Load the lower byte of the remaining count.</span></span>
<span class="l"><a class="anc" name="cef4" href="#cef4">[cef4]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="cef5" href="#cef5">[cef5]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span><span class="ce">; Subtract 1.</span></span>
<span class="l"><a class="anc" name="cef7" href="#cef7">[cef7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; And set it.</span></span>
<span class="l"><a class="anc" name="cef9" href="#cef9">[cef9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Load the upper byte of the remaining count.</span></span>
<span class="l"><a class="anc" name="cefb" href="#cefb">[cefb]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$00</span></span><span class="ce">; Subtract carry, if lower wrapped.</span></span>
<span class="l"><a class="anc" name="cefd" href="#cefd">[cefd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; And set it.</span></span>
<span class="l"><a class="anc" name="ceff" href="#ceff">[ceff]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_copyLoop">@_copyLoop</a></span></span><span class="ce">; If count &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to the previous bank.
;
</div><span class="l"><a class="anc" name="cf01" href="#cf01">[cf01]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank.</span></span>
<span class="l"><a class="anc" name="cf02" href="#cf02">[cf02]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Transfer to X.</span></span>
<span class="l"><a class="anc" name="cf03" href="#cf03">[cf03]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch to it.</span></span>
<span class="l"><a class="anc" name="cf06" href="#cf06">[cf06]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="TILE_INDEX_TO_ADDR"></a><div class="cp">;============================================================================
; Offsets of the tiles in the bank
;
; Index into the table are based on <a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a>.
;
; TODO
;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;
</div><span class="l"><a class="anc" name="cf07" href="#cf07">[cf07]</a><a href="#TILE_INDEX_TO_ADDR" class="la">TILE_INDEX_TO_ADDR:</a><span class="ce">; [$cf07]</span></span>
<span class="l"><a class="anc" name="cf07" href="#cf07">[cf07]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_EOLIS">AREA_TILESETS_EOLIS</a></span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="cf09" href="#cf09">[cf09]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_BRANCHES">AREA_TILESETS_BRANCHES</a></span></span><span class="ce">; [1]: Branches</span></span>
<span class="l"><a class="anc" name="cf0b" href="#cf0b">[cf0b]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_TRUNK">AREA_TILESETS_TRUNK</a></span></span><span class="ce">; [2]: Trunk</span></span>
<span class="l"><a class="anc" name="cf0d" href="#cf0d">[cf0d]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_MIST">AREA_TILESETS_MIST</a></span></span><span class="ce">; [3]: Mist</span></span>
<span class="l"><a class="anc" name="cf0f" href="#cf0f">[cf0f]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_DARTMOOR_EVIL_LAIR">AREA_TILESETS_DARTMOOR_EVIL_LAIR</a></span></span><span class="ce">; [4]: Dartmoor Castle
Evil Lair</span></span>
<span class="l"><a class="anc" name="cf11" href="#cf11">[cf11]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_TOWNS">AREA_TILESETS_TOWNS</a></span></span><span class="ce">; [5]: Towns</span></span>
<span class="l"><a class="anc" name="cf13" href="#cf13">[cf13]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_KINGSROOM_GURU_HOSPITAL">AREA_TILESETS_KINGSROOM_GURU_HOSPITAL</a></span></span><span class="ce">; [6]: King's Room
Guru Room
Hospital</span></span>
<span class="l"><a class="anc" name="cf15" href="#cf15">[cf15]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_SHOPS_HOUSE_TAVERN">AREA_TILESETS_SHOPS_HOUSE_TAVERN</a></span></span><span class="ce">; [7]: Tavern
Tool Shop
Key Shop
House
Meat Shop</span></span>
<span class="l"><a class="anc" name="cf17" href="#cf17">[cf17]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG4.html#AREA_TILESETS_MARTIALARTS_MAGICTRAINER">AREA_TILESETS_MARTIALARTS_MAGICTRAINER</a></span></span><span class="ce">; [8]: Martial Arts
Magic Trainer</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="TILE_INDEX_TO_PPU_ADDR_UPPER"></a><div class="cp">;============================================================================
; Which parts of the PPU tiles are loaded.
;
; Index into the table are based on <a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a>.
;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;
</div><span class="l"><a class="anc" name="cf19" href="#cf19">[cf19]</a><a href="#TILE_INDEX_TO_PPU_ADDR_UPPER" class="la">TILE_INDEX_TO_PPU_ADDR_UPPER:</a><span class="ce">; [$cf19]</span></span>
<span class="l"><a class="anc" name="cf19" href="#cf19">[cf19]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="cf1a" href="#cf1a">[cf1a]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [1]: Branches</span></span>
<span class="l"><a class="anc" name="cf1b" href="#cf1b">[cf1b]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [2]: Trunk</span></span>
<span class="l"><a class="anc" name="cf1c" href="#cf1c">[cf1c]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [3]: Mist</span></span>
<span class="l"><a class="anc" name="cf1d" href="#cf1d">[cf1d]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [4]: Dartmoor Castle
Evil Lair</span></span>
<span class="l"><a class="anc" name="cf1e" href="#cf1e">[cf1e]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [5]: Towns</span></span>
<span class="l"><a class="anc" name="cf1f" href="#cf1f">[cf1f]</a><span class="cd"><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; [6]: King's Room
Guru Room
Hospital</span></span>
<span class="l"><a class="anc" name="cf20" href="#cf20">[cf20]</a><span class="cd"><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; [7]: Tavern
Tool Shop
Key Shop
House
Meat Shop</span></span>
<span class="l"><a class="anc" name="cf21" href="#cf21">[cf21]</a><span class="cd"><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; [8]: Martial Arts
Magic Trainer</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="TILE_INDEX_TO_NUM_CHR_PAGES"></a><div class="cp">;============================================================================
; The number of CHR pages to load for a tiles index.
;
; Index into the table are based on <a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a>.
;
; The results are further translated as:
;
;     8 == 0x80
;     6 == 0x60
;     4 == 0x40
;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;
</div><span class="l"><a class="anc" name="cf22" href="#cf22">[cf22]</a><a href="#TILE_INDEX_TO_NUM_CHR_PAGES" class="la">TILE_INDEX_TO_NUM_CHR_PAGES:</a><span class="ce">; [$cf22]</span></span>
<span class="l"><a class="anc" name="cf22" href="#cf22">[cf22]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="cf23" href="#cf23">[cf23]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]: Branches</span></span>
<span class="l"><a class="anc" name="cf24" href="#cf24">[cf24]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]: Trunk</span></span>
<span class="l"><a class="anc" name="cf25" href="#cf25">[cf25]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [3]: Mist</span></span>
<span class="l"><a class="anc" name="cf26" href="#cf26">[cf26]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [4]: Dartmoor Castle
Evil Lair</span></span>
<span class="l"><a class="anc" name="cf27" href="#cf27">[cf27]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [5]: Towns</span></span>
<span class="l"><a class="anc" name="cf28" href="#cf28">[cf28]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [6]: King's Room
Guru Room
Hospital</span></span>
<span class="l"><a class="anc" name="cf29" href="#cf29">[cf29]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [7]: Tavern
Tool Shop
Key Shop
House
Meat Shop</span></span>
<span class="l"><a class="anc" name="cf2a" href="#cf2a">[cf2a]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [8]: Martial Arts
Magic Trainer</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_SetVRAMIncrementAdd1Across"></a><div class="cp">;============================================================================
; Set the VRAM address increment per CPU read/write of PPUDATA to 0: Add 1,
; going across.
;
; INPUTS:
;     <a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a>:
;         The saved PPU control flags.
;
; OUTPUTS:
;     <a href="RAM.html#PPUCTRL">PPUCTRL</a>:
;     <a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a>:
;         The updated PPU control flags.
;
; XREFS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;============================================================================
</div><span class="l"><a class="anc" name="cf2b" href="#cf2b">[cf2b]</a><a href="#PPU_SetVRAMIncrementAdd1Across" class="la">PPU_SetVRAMIncrementAdd1Across:</a><span class="ce">; [$cf2b]</span></span>
<span class="l"><a class="anc" name="cf2b" href="#cf2b">[cf2b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; Load the PPU control flags.</span></span>
<span class="l"><a class="anc" name="cf2d" href="#cf2d">[cf2d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fb</span></span><span class="ce">; Set VRAM address increment per CPU read/write of PPUDATA to 0: Add 1, going across.</span></span>
<span class="l"><a class="anc" name="cf2f" href="#cf2f">[cf2f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; Set it to SavedPPUCtrl.</span></span>
<span class="l"><a class="anc" name="cf31" href="#cf31">[cf31]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Set it to PPUCTRL.</span></span>
<span class="l"><a class="anc" name="cf34" href="#cf34">[cf34]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_Clear"></a><div class="cp">;============================================================================
; MAYBE DEADCODE: Clear the PPU buffer.
;
; Both the offset and upper bounds will be reset back to 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The offset to clear.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds value to clear.
;============================================================================
</div><span class="l"><a class="anc" name="cf35" href="#cf35">[cf35]</a><a href="#PPUBuffer_Clear" class="la">PPUBuffer_Clear:</a><span class="ce">; [$cf35]</span></span>
<span class="l"><a class="anc" name="cf35" href="#cf35">[cf35]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cf37" href="#cf37">[cf37]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Set offset = 0</span></span>
<span class="l"><a class="anc" name="cf39" href="#cf39">[cf39]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Set upper bounds = 0</span></span>
<span class="l"></span>
<a name="RETURN_CF3B"></a><div class="c">;
; XREFS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
</div><span class="l"><a class="anc" name="cf3b" href="#cf3b">[cf3b]</a><a href="#RETURN_CF3B" class="la">RETURN_CF3B:</a><span class="ce">; [$cf3b]</span></span>
<span class="l"><a class="anc" name="cf3b" href="#cf3b">[cf3b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_Draw"></a><div class="cp">;============================================================================
; Draw from the PPU buffer to the PPU.
;
; This will take the entries in the current buffer and draw
; them to the PPU. Buffer entries may contain a command
; opcode, or it may contain values to write.
;
; Let's look into the two methods for drawing.
;
; 1. Command control
;
;    If the first byte to process in the buffer is a value
;    decreasing from 0x00 to 0xFA, it will be treated as a
;    command, and the entry in
;    <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a> will
;    process the remaining bytes (or just return).
;
;    The following commands are supported:
;
;    0x00: Write palette data
;
;          <a href="#PPUBuffer_DrawCommand_WritePalette">PPUBuffer_DrawCommand_WritePalette</a>
;
;    0xFC: Rotate 16 pixels of tiles right by 1 pixel at
;          a given address (at the next two bytes from
;          the buffer).
;
;          <a href="#PPUBuffer_DrawCommand_RotateTilesRight1Pixel">PPUBuffer_DrawCommand_RotateTilesRight1Pixel</a>
;
;    0xFA: TODO
;    <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>
;
;    Commands 0xFF, 0xFE, 0xFD, and 0xFB just return.
;
;    Once a command is processed, the operation is complete.
;    Further entries in the buffer will be processed in
;    future calls.
;
; 2. Data drawing
;
;    The first byte at the buffer offset will contain a
;    value with a PPUCTRL flag in bit 7 and the number of
;    bytes to write in the remaining bit.
;
;    The second and third contain the upper and lower bytes
;    of PPUADDR (respectively).
;
;    Additional bytes are the &lt;length&gt; bytes to write.
;
;    Drawing finishes after any of the following conditions
;    are met:
;
;    1. The buffer is empty.
;    2. 6 entries from the buffer have been drawn.
;    3. A maximum number of bytes have been written
;       (48 bytes).
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer to process.
;
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The offset within the PPU buffer to process.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds within the PPU buffer to process.
;
; OUTPUTS:
;     <a href="RAM.html#PPUCTRL">PPUCTRL</a>:
;         PPU control flags.
;
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         PPU write address (reset back to 0).
;
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         PPU draw data.
;
; TEMP VARIABLES:
;     <a href="RAM.html#PPUBuffer_Temp_PendingEntryCount">PPUBuffer_Temp_PendingEntryCount</a>:
;         The maximum number of entries remaining to
;         process.
;
;     <a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a>:
;         The total number of bytes processed.
;
; CALLS:
;     <a href="#PPUBuffer_DrawCommand_WritePalette">PPUBuffer_DrawCommand_WritePalette</a>
;     <a href="#PPUBuffer_DrawCommand_RotateTilesRight1Pixel">PPUBuffer_DrawCommand_RotateTilesRight1Pixel</a>
;     <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>
;
; XREFS:
;     <a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a>
;     <a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="cf3c" href="#cf3c">[cf3c]</a><a href="#PPUBuffer_Draw" class="la">PPUBuffer_Draw:</a><span class="ce">; [$cf3c]</span></span>
<div class="c">;
; Check if there's anything in the buffer to write.
; If not, we're done.
;
</div><span class="l"><a class="anc" name="cf3c" href="#cf3c">[cf3c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; A = current buffer offset</span></span>
<span class="l"><a class="anc" name="cf3e" href="#cf3e">[cf3e]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Compare against the upper bound of the PPU buffer.</span></span>
<span class="l"><a class="anc" name="cf40" href="#cf40">[cf40]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_CF3B">RETURN_CF3B</a></span></span><span class="ce">; If they're the same, we have nothing to write. We're done.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check the value in the offset and see if it appears to
; be a command opcode of some sort (an index into
; <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>.
;
</div><span class="l"><a class="anc" name="cf42" href="#cf42">[cf42]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; X = current PPU offset</span></span>
<span class="l"><a class="anc" name="cf44" href="#cf44">[cf44]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Take a value from $00 to $FA (decreasing) and turn it
into an index.

$00 = 0
$FF = 1
$FE = 2
$FD = 3
$FC = 4
$FB = 5
$FA = 6</span></span>
<span class="l"><a class="anc" name="cf46" href="#cf46">[cf46]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="cf47" href="#cf47">[cf47]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Get the value from the buffer at this offset.</span></span>
<span class="l"><a class="anc" name="cf4a" href="#cf4a">[cf4a]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Check if it's a command code.</span></span>
<span class="l"><a class="anc" name="cf4c" href="#cf4c">[cf4c]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_beginDraw">@_beginDraw</a></span></span><span class="ce">; If not, draw normally.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; It is a command code. Increment to the next byte, look up
; the entry for the command in our table, and schedule the
; address following for the execution after this returns.
;
</div><span class="l"><a class="anc" name="cf4e" href="#cf4e">[cf4e]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Consume the byte in the buffer.</span></span>
<span class="l"><a class="anc" name="cf50" href="#cf50">[cf50]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="cf51" href="#cf51">[cf51]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Begin looking up in the table.</span></span>
<span class="l"><a class="anc" name="cf52" href="#cf52">[cf52]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>+1,Y</span></span><span class="ce">; High byte of the command address.</span></span>
<span class="l"><a class="anc" name="cf55" href="#cf55">[cf55]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="cf56" href="#cf56">[cf56]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>,Y</span></span><span class="ce">; Low byte of the command address.</span></span>
<span class="l"><a class="anc" name="cf59" href="#cf59">[cf59]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="cf5a" href="#cf5a">[cf5a]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Return. The next address following will execute.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cf5b:@_beginDraw"></a><div class="c">;
; This is standard data to write to the PPU, not a command.
;
</div><span class="l"><a class="anc" name="cf5b" href="#cf5b">[cf5b]</a><a href="#:cf5b:@_beginDraw" class="lla">@_beginDraw:</a><span class="ce">; [$cf5b]</span></span>
<span class="l"><a class="anc" name="cf5b" href="#cf5b">[cf5b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$d0</span></span><span class="ce">; Total byte length that can be written.</span></span>
<span class="l"><a class="anc" name="cf5d" href="#cf5d">[cf5d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="cf5f" href="#cf5f">[cf5f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$06</span></span><span class="ce">; Max number of entries in the buffer that can be written.</span></span>
<span class="l"><a class="anc" name="cf61" href="#cf61">[cf61]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_PendingEntryCount">PPUBuffer_Temp_PendingEntryCount</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cf63:@_loopBuffer"></a><div class="c">;
; Loop through the buffer until either it's cleared or we've
; processed 6 entries.
;
</div><span class="l"><a class="anc" name="cf63" href="#cf63">[cf63]</a><a href="#:cf63:@_loopBuffer" class="lla">@_loopBuffer:</a><span class="ce">; [$cf63]</span></span>
<span class="l"><a class="anc" name="cf63" href="#cf63">[cf63]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; X = Read offset into the buffer.</span></span>
<span class="l"><a class="anc" name="cf65" href="#cf65">[cf65]</a><span class="cd"><span class="i">CPX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Compare it to the write offset.</span></span>
<span class="l"><a class="anc" name="cf67" href="#cf67">[cf67]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span><span class="ce">; If it's the same, the loop is finished.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the PPUCTRL to set for this series of writes.
;
; If the most-significant bit is set, we'll set it to
; Add32 Down mode. Otherwise, we'll set it to Add1 Across
; mode.
;
</div><span class="l"><a class="anc" name="cf69" href="#cf69">[cf69]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span><span class="ce">; A = PPU control flags.</span></span>
<span class="l"><a class="anc" name="cf6b" href="#cf6b">[cf6b]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fb</span></span><span class="ce">; Set to Add 1 Across.</span></span>
<span class="l"><a class="anc" name="cf6d" href="#cf6d">[cf6d]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = Resulting flags.</span></span>
<span class="l"><a class="anc" name="cf6e" href="#cf6e">[cf6e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the byte from the buffer.</span></span>
<span class="l"><a class="anc" name="cf71" href="#cf71">[cf71]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_processData">@_processData</a></span></span><span class="ce">; If bit 7 is set, jump.</span></span>
<span class="l"><a class="anc" name="cf73" href="#cf73">[cf73]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Else, set VBLank Disable.</span></span>
<span class="l"><a class="anc" name="cf75" href="#cf75">[cf75]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; And Inc Add 32 Down.</span></span>
<span class="l"><a class="anc" name="cf76" href="#cf76">[cf76]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="cf77" href="#cf77">[cf77]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="cf78" href="#cf78">[cf78]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"></span>
<a name=":cf79:@_processData"></a><span class="l"><a class="anc" name="cf79" href="#cf79">[cf79]</a><a href="#:cf79:@_processData" class="lla">@_processData:</a><span class="ce">; [$cf79]</span></span>
<span class="l"><a class="anc" name="cf79" href="#cf79">[cf79]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span><span class="ce">; Store the new control flags.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the first byte from the buffer at our offset.
; Mask out bit 7 (our flag above). This will be our
; data length counter.
;
</div><span class="l"><a class="anc" name="cf7c" href="#cf7c">[cf7c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; A = value from the buffer</span></span>
<span class="l"><a class="anc" name="cf7f" href="#cf7f">[cf7f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Mask out control bit 7.</span></span>
<span class="l"><a class="anc" name="cf81" href="#cf81">[cf81]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (save until we load the address)</span></span>
<span class="l"><a class="anc" name="cf82" href="#cf82">[cf82]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Set to the next byte.</span></span>
<span class="l"><a class="anc" name="cf83" href="#cf83">[cf83]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the upper PPU byte address from the buffer.</span></span>
<span class="l"><a class="anc" name="cf86" href="#cf86">[cf86]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the upper byte in PPUADDR.</span></span>
<span class="l"><a class="anc" name="cf89" href="#cf89">[cf89]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><a class="anc" name="cf8a" href="#cf8a">[cf8a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the lower PPU byte address from the buffer.</span></span>
<span class="l"><a class="anc" name="cf8d" href="#cf8d">[cf8d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set as the lower byte in PPUADDR.</span></span>
<span class="l"><a class="anc" name="cf90" href="#cf90">[cf90]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><a class="anc" name="cf91" href="#cf91">[cf91]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; Y = A (restore from above)</span></span>
<span class="l"><a class="anc" name="cf92" href="#cf92">[cf92]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="cf93" href="#cf93">[cf93]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span><span class="ce">; Add the length to our running total.</span></span>
<span class="l"><a class="anc" name="cf95" href="#cf95">[cf95]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cf97:@_loopData"></a><div class="c">;
; Begin writing &lt;length&gt; bytes from the buffer to the PPU.
;
</div><span class="l"><a class="anc" name="cf97" href="#cf97">[cf97]</a><a href="#:cf97:@_loopData" class="lla">@_loopData:</a><span class="ce">; [$cf97]</span></span>
<span class="l"><a class="anc" name="cf97" href="#cf97">[cf97]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the byte to draw at our current offset.</span></span>
<span class="l"><a class="anc" name="cf9a" href="#cf9a">[cf9a]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><a class="anc" name="cf9b" href="#cf9b">[cf9b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Set the byte in our PPUDATA.</span></span>
<span class="l"><a class="anc" name="cf9e" href="#cf9e">[cf9e]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Decrement the nuber of bytes to write.</span></span>
<span class="l"><a class="anc" name="cf9f" href="#cf9f">[cf9f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loopData">@_loopData</a></span></span><span class="ce">; If we're not done yet, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're done writing the data bytes. We can now update the
; offset and check whether to move on to the next, or if
; we're done with the buffer for now.
;
; We're done with the buffer if we've hit 6 entries, maxed
; out our byte length counter, or hit a new command opcode.
;
</div><span class="l"><a class="anc" name="cfa1" href="#cfa1">[cfa1]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Increment our offset into the buffer to skip the length
and address bytes and all the data bytes.</span></span>
<span class="l"><a class="anc" name="cfa3" href="#cfa3">[cfa3]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_PendingEntryCount">PPUBuffer_Temp_PendingEntryCount</a></span></span><span class="ce">; Decrement our total allowed entries for this operation.</span></span>
<span class="l"><a class="anc" name="cfa5" href="#cfa5">[cfa5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span><span class="ce">; If we can't do any more, we're done.</span></span>
<span class="l"><a class="anc" name="cfa7" href="#cfa7">[cfa7]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the next byte to process from the buffer.</span></span>
<span class="l"><a class="anc" name="cfaa" href="#cfaa">[cfaa]</a><span class="cd"><span class="i">DEY</span></span></span>
<span class="l"><a class="anc" name="cfab" href="#cfab">[cfab]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$f9</span></span><span class="ce">; Check if it's a command byte.</span></span>
<span class="l"><a class="anc" name="cfad" href="#cfad">[cfad]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span><span class="ce">; If it is, we're done. This will be handled next call.</span></span>
<span class="l"><a class="anc" name="cfaf" href="#cfaf">[cfaf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_Temp_TotalByteLength">PPUBuffer_Temp_TotalByteLength</a></span></span><span class="ce">; Check the total byte length.</span></span>
<span class="l"><a class="anc" name="cfb1" href="#cfb1">[cfb1]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_loopBuffer">@_loopBuffer</a></span></span><span class="ce">; If there's room to go, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":cfb3:@_finishLoop"></a><div class="c">;
; We're done with everything. Clear out the PPU addresses and
; return.
;
</div><span class="l"><a class="anc" name="cfb3" href="#cfb3">[cfb3]</a><a href="#:cfb3:@_finishLoop" class="lla">@_finishLoop:</a><span class="ce">; [$cfb3]</span></span>
<span class="l"><a class="anc" name="cfb3" href="#cfb3">[cfb3]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="cfb5" href="#cfb5">[cfb5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set upper PPUADDR to 0.</span></span>
<span class="l"><a class="anc" name="cfb8" href="#cfb8">[cfb8]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Set lower PPUADDR to 0.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_DrawCommand_Noop"></a><div class="cp">;============================================================================
; No-op draw command.
;
; This is just used as a destination for the draw commands
; lookup table below. It's also the end of the function.
; above.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfbe]
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc0]
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc2]
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfc6]
;============================================================================
</div><span class="l"><a class="anc" name="cfbb" href="#cfbb">[cfbb]</a><a href="#PPUBuffer_DrawCommand_Noop" class="la">PPUBuffer_DrawCommand_Noop:</a><span class="ce">; [$cfbb]</span></span>
<span class="l"><a class="anc" name="cfbb" href="#cfbb">[cfbb]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PPUBUFFER_DRAW_COMMANDS"></a><div class="cp">;============================================================================
; Handlers for special PPU buffer draw commands.
;
; XREFS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
</div><span class="l"><a class="anc" name="cfbc" href="#cfbc">[cfbc]</a><a href="#PPUBUFFER_DRAW_COMMANDS" class="la">PPUBUFFER_DRAW_COMMANDS:</a><span class="ce">; [$cfbc]</span></span>
<span class="l"><a class="anc" name="cfbc" href="#cfbc">[cfbc]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_WritePalette">PPUBuffer_DrawCommand_WritePalette</a>-1</span></span><span class="ce">; [0]: Command 0x00: Write Palette to PPU</span></span>
<span class="l"><a class="anc" name="cfbe" href="#cfbe">[cfbe]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [1]: Command 0xFF</span></span>
<span class="l"><a class="anc" name="cfc0" href="#cfc0">[cfc0]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [2]: Command 0xFE</span></span>
<span class="l"><a class="anc" name="cfc2" href="#cfc2">[cfc2]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [3]: Command 0xFD</span></span>
<span class="l"><a class="anc" name="cfc4" href="#cfc4">[cfc4]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_RotateTilesRight1Pixel">PPUBuffer_DrawCommand_RotateTilesRight1Pixel</a>-1</span></span><span class="ce">; [4]: Command 0xFC: Rotate Tiles Right</span></span>
<span class="l"><a class="anc" name="cfc6" href="#cfc6">[cfc6]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_Noop">PPUBuffer_DrawCommand_Noop</a>-1</span></span><span class="ce">; [5]: Command 0xFB</span></span>
<span class="l"><a class="anc" name="cfc8" href="#cfc8">[cfc8]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>-1</span></span><span class="ce">; [6]: Command 0xFA: Remove Vertical Lines</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_WaitForCapacity"></a><div class="cp">;============================================================================
; Wait for capacity in the PPU buffer.
;
; This will block until the PPU buffer has been flushed and
; there's at least 36 bytes remaining.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#PPUBuffer_HasCapacity">PPUBuffer_HasCapacity</a>
;
; XREFS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_WaitForCapacity">PPUBuffer_WaitForCapacity</a>
;============================================================================
</div><span class="l"><a class="anc" name="cfca" href="#cfca">[cfca]</a><a href="#PPUBuffer_WaitForCapacity" class="la">PPUBuffer_WaitForCapacity:</a><span class="ce">; [$cfca]</span></span>
<span class="l"><a class="anc" name="cfca" href="#cfca">[cfca]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_HasCapacity">PPUBuffer_HasCapacity</a></span></span><span class="ce">; Is there capacity?</span></span>
<span class="l"><a class="anc" name="cfcd" href="#cfcd">[cfcd]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#PPUBuffer_WaitForCapacity">PPUBuffer_WaitForCapacity</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="cfcf" href="#cfcf">[cfcf]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_HasCapacity"></a><div class="cp">;============================================================================
; Return whether there's at least 36 bytes of PPU buffer free.
;
; XXX Not right. Re-analyze this.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The current offset into the PPU buffer.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds of the PPU buffer.
;
; OUTPUTS:
;     C:
;         0 = Fewer than 36 bytes available in the buffer.
;         1 = 36 or more bytes available in the buffer.
;
; XREFS:
;     <a href="#PPUBuffer_WaitForCapacity">PPUBuffer_WaitForCapacity</a>
;============================================================================
</div><span class="l"><a class="anc" name="cfd0" href="#cfd0">[cfd0]</a><a href="#PPUBuffer_HasCapacity" class="la">PPUBuffer_HasCapacity:</a><span class="ce">; [$cfd0]</span></span>
<span class="l"><a class="anc" name="cfd0" href="#cfd0">[cfd0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; A = PPU buffer offset.</span></span>
<span class="l"><a class="anc" name="cfd2" href="#cfd2">[cfd2]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="cfd3" href="#cfd3">[cfd3]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; A = offset - upper</span></span>
<span class="l"><a class="anc" name="cfd5" href="#cfd5">[cfd5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If (offset - upper) == 0, jump to return false.</span></span>
<span class="l"><a class="anc" name="cfd7" href="#cfd7">[cfd7]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$24</span></span><span class="ce">; Set whether there's at least 36 bytes difference.</span></span>
<span class="l"></span>
<a name=":cfd9:@_return"></a><span class="l"><a class="anc" name="cfd9" href="#cfd9">[cfd9]</a><a href="#:cfd9:@_return" class="lla">@_return:</a><span class="ce">; [$cfd9]</span></span>
<span class="l"><a class="anc" name="cfd9" href="#cfd9">[cfd9]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"><a class="anc" name="cfda" href="#cfda">[cfda]</a><span class="cd"><span class="i">db</span> <span class="o">$09,$80</span></span><span class="ce">; [$cfda] word</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_QueueCommandOrLength"></a><div class="cp">;============================================================================
; Queue for writing PPU data to the target address.
;
; This will wait for capacity in the PPU buffer and then
; write the given command or length, followed by the target
; PPU address to write to. That's a total of 3 bytes.
;
; Callers can then write additional data to the buffer.
;
; This doesn't update <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>. Callers
; are responsible for that.
;
; INPUTS:
;     A:
;         The command or length to write.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         The PPU target address to write to.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The current upper bounds of the PPU target buffer.
;         This is where the state will be written to.
;
; OUTPUTS:
;     X:
;         The new write offset in the PPU buffer.
;
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The updated PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_WaitForCapacity">PPUBuffer_WaitForCapacity</a>
;
; XREFS:
;     <a href="PRG12.html#DEADCODE_FUN_PRG12__9041">DEADCODE_FUN_PRG12__9041</a>
;     <a href="PRG12.html#IScriptAction_AddInventoryItem_ClearTextBox">IScriptAction_AddInventoryItem_ClearTextBox</a>
;     <a href="PRG12.html#PasswordScreen_DrawMessage">PasswordScreen_DrawMessage</a>
;     <a href="PRG12.html#PasswordScreen_WriteCharTile">PasswordScreen_WriteCharTile</a>
;     <a href="PRG12.html#TextBox_Close">TextBox_Close</a>
;     <a href="PRG12.html#TextBox_DrawItemImage">TextBox_DrawItemImage</a>
;     <a href="PRG12.html#TextBox_FillBackground">TextBox_FillBackground</a>
;     <a href="PRG12.html#UI_DrawString">UI_DrawString</a>
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;     <a href="#Area_SetBlocks_WriteBlockData12">Area_SetBlocks_WriteBlockData12</a>
;     <a href="#Area_SetBlocks_WriteBlockData34">Area_SetBlocks_WriteBlockData34</a>
;     <a href="#DEADCODE_FUN_PRG15_MIRROR__c033">DEADCODE_FUN_PRG15_MIRROR__c033</a>
;     <a href="#IScripts_DrawPortraitTileToPPU">IScripts_DrawPortraitTileToPPU</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;     <a href="#Player_LoadWeaponTile">Player_LoadWeaponTile</a>
;     <a href="#Sprites_LoadImageForCurrentSprite">Sprites_LoadImageForCurrentSprite</a>
;     <a href="#TextBox_FillPlaceholderTextAtLineWithStartChar">TextBox_FillPlaceholderTextAtLineWithStartChar</a>
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;     <a href="#TextBox_QueuePPUBufferTextBoxLength">TextBox_QueuePPUBufferTextBoxLength</a>
;     <a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a>
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;============================================================================
</div><span class="l"><a class="anc" name="cfdc" href="#cfdc">[cfdc]</a><a href="#PPUBuffer_QueueCommandOrLength" class="la">PPUBuffer_QueueCommandOrLength:</a><span class="ce">; [$cfdc]</span></span>
<div class="c">;
; Wait for capacity in the buffer.
;
</div><span class="l"><a class="anc" name="cfdc" href="#cfdc">[cfdc]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the length/command to the stack.</span></span>
<span class="l"><a class="anc" name="cfdd" href="#cfdd">[cfdd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WaitForCapacity">PPUBuffer_WaitForCapacity</a></span></span><span class="ce">; Wait for capacity in the buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There's capacity. Set up to write.
;
; Start with the length or command byte.
;
</div><span class="l"><a class="anc" name="cfe0" href="#cfe0">[cfe0]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="cfe1" href="#cfe1">[cfe1]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Load the upper bounds of the buffer.</span></span>
<span class="l"><a class="anc" name="cfe3" href="#cfe3">[cfe3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store the provided value (A) there.</span></span>
<span class="l"><a class="anc" name="cfe6" href="#cfe6">[cfe6]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="cfe7" href="#cfe7">[cfe7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Load the upper address byte.</span></span>
<span class="l"><a class="anc" name="cfe9" href="#cfe9">[cfe9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write it to the buffer.</span></span>
<span class="l"><a class="anc" name="cfec" href="#cfec">[cfec]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="cfed" href="#cfed">[cfed]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Load the lower address byte.</span></span>
<span class="l"><a class="anc" name="cfef" href="#cfef">[cfef]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write it to the buffer.</span></span>
<span class="l"><a class="anc" name="cff2" href="#cff2">[cff2]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="cff3" href="#cff3">[cff3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_WaitUntilClear"></a><div class="cp">;============================================================================
; Wait until the PPU buffer is clear.
;
; This will continuously loop until the PPU buffer's
; offset and upper bounds match.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The offset to compare.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds to compare.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a>
;============================================================================
</div><span class="l"><a class="anc" name="cff4" href="#cff4">[cff4]</a><a href="#PPUBuffer_WaitUntilClear" class="la">PPUBuffer_WaitUntilClear:</a><span class="ce">; [$cff4]</span></span>
<span class="l"><a class="anc" name="cff4" href="#cff4">[cff4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Load the upper bounds of the buffer.</span></span>
<span class="l"><a class="anc" name="cff6" href="#cff6">[cff6]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Does it == the offset?</span></span>
<span class="l"><a class="anc" name="cff8" href="#cff8">[cff8]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="cffa" href="#cffa">[cffa]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_DrawAll"></a><div class="cp">;============================================================================
; Invoke all draws on the PPU buffer until it's cleared.
;
; This will continuously run <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a> until
; the
; draw buffer has been cleared.
;
; INPUTS:
;     <a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a>:
;         The offset to compare.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds to compare.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
; XREFS:
;     <a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a class="anc" name="cffb" href="#cffb">[cffb]</a><a href="#PPUBuffer_DrawAll" class="la">PPUBuffer_DrawAll:</a><span class="ce">; [$cffb]</span></span>
<span class="l"><a class="anc" name="cffb" href="#cffb">[cffb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span><span class="ce">; Draw from the buffer.</span></span>
<span class="l"><a class="anc" name="cffe" href="#cffe">[cffe]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Load the upper bounds.</span></span>
<span class="l"><a class="anc" name="d000" href="#d000">[d000]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Does it match the offset?</span></span>
<span class="l"><a class="anc" name="d002" href="#d002">[d002]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPUBuffer_DrawAll">PPUBuffer_DrawAll</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="d004" href="#d004">[d004]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4"></a><div class="cp">;============================================================================
; DEADCODE
;
; This would have loaded background palette 4 and queue
; writing it to the PPU.
;
; It's not used in the shipped game.
;============================================================================
</div><span class="l"><a class="anc" name="d005" href="#d005">[d005]</a><a href="#UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4" class="la">UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4:</a><span class="ce">; [$d005]</span></span>
<span class="l"><a class="anc" name="d005" href="#d005">[d005]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="d007" href="#d007">[d007]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a></span></span></span>
<span class="l"><a class="anc" name="d00a" href="#d00a">[d00a]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UNUSED_WriteCurrentBackgroundPalette"></a><div class="cp">;============================================================================
; DEADCODE
;
; This would have loaded the background palette for the
; current screen and queue writing it to the PPU.
;
; It's not used in the shipped game.
;============================================================================
</div><span class="l"><a class="anc" name="d00d" href="#d00d">[d00d]</a><a href="#UNUSED_WriteCurrentBackgroundPalette" class="la">UNUSED_WriteCurrentBackgroundPalette:</a><span class="ce">; [$d00d]</span></span>
<span class="l"><a class="anc" name="d00d" href="#d00d">[d00d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span></span>
<span class="l"><a class="anc" name="d010" href="#d010">[d010]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a></span></span></span>
<span class="l"><a class="anc" name="d013" href="#d013">[d013]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_DrawCommand_WritePalette"></a><div class="cp">;============================================================================
; Draw Command 0x00: Write the screen palette.
;
; This flushes <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a> to the PPU,
; writing both the background and sprite palette.
;
; INPUTS:
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>:
;         The screen palette to write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         The written PPU data.
;
; XREFS:
;     <a href="#PPUBUFFER_DRAW_COMMANDS">PPUBUFFER_DRAW_COMMANDS</a>
;     [$PRG15_MIRROR::cfbc]
;============================================================================
</div><span class="l"><a class="anc" name="d016" href="#d016">[d016]</a><a href="#PPUBuffer_DrawCommand_WritePalette" class="la">PPUBuffer_DrawCommand_WritePalette:</a><span class="ce">; [$d016]</span></span>
<div class="c">;
; Write all 32 palettes to 0x3F00.
;
</div><span class="l"><a class="anc" name="d016" href="#d016">[d016]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$3f</span></span><span class="ce">; 0x3F == Upper byte.</span></span>
<span class="l"><a class="anc" name="d018" href="#d018">[d018]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write as the upper PPU address.</span></span>
<span class="l"><a class="anc" name="d01b" href="#d01b">[d01b]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; 0x00 == Lower byte.</span></span>
<span class="l"><a class="anc" name="d01d" href="#d01d">[d01d]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write as the lower PPU address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Loop through 32 bytes of palette data and write to the PPU.
;
</div><span class="l"><a class="anc" name="d020" href="#d020">[d020]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$20</span></span><span class="ce">; Y = 32 (loop counter).</span></span>
<span class="l"></span>
<a name=":d022:@_paletteLoop"></a><span class="l"><a class="anc" name="d022" href="#d022">[d022]</a><a href="#:d022:@_paletteLoop" class="lla">@_paletteLoop:</a><span class="ce">; [$d022]</span></span>
<span class="l"><a class="anc" name="d022" href="#d022">[d022]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>,X</span></span><span class="ce">; A = Palette byte at the index.</span></span>
<span class="l"><a class="anc" name="d025" href="#d025">[d025]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU.</span></span>
<span class="l"><a class="anc" name="d028" href="#d028">[d028]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment the PPU address.</span></span>
<span class="l"><a class="anc" name="d029" href="#d029">[d029]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y-- (loop counter).</span></span>
<span class="l"><a class="anc" name="d02a" href="#d02a">[d02a]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_paletteLoop">@_paletteLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Avoid palette corruption by setting to address 0x3F00,
; and then zeroing out (0x0000).
;
; See https://www.nesdev.org/wiki/PPU_registers#Palette_corruption
;
</div><span class="l"><a class="anc" name="d02c" href="#d02c">[d02c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$3f</span></span><span class="ce">; 0x3F == Upper byte.</span></span>
<span class="l"><a class="anc" name="d02e" href="#d02e">[d02e]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Write as the upper PPU address.</span></span>
<span class="l"><a class="anc" name="d031" href="#d031">[d031]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Zero out the lower byte.</span></span>
<span class="l"><a class="anc" name="d034" href="#d034">[d034]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Now zero out the upper byte.</span></span>
<span class="l"><a class="anc" name="d037" href="#d037">[d037]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; And the lower again.</span></span>
<span class="l"><a class="anc" name="d03a" href="#d03a">[d03a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadUIPalette"></a><div class="cp">;============================================================================
; Populate the palette data for HUD/textbox elements.
;
; This will load the palette data for the background of
; the HUD and textbox data stored in bank 11 at the
; address stored in <a href="RAM.html#Temp_08">Temp_08</a> and populate
; <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>.
;
; INPUTS:
;     Y:
;         The palette destination index to load into.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;         The address to load data from in bank 11.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>:
;         The resulting palette data.
;
;     <a href="RAM.html#Palette_SpritePaletteIndex">Palette_SpritePaletteIndex</a>:
;         The index of the loaded palette.
;
;     <a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a>:
;         The index of the background color used for
;         textboxes and the HUD.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         Clobbered
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a>
;
; XREFS:
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;     <a href="#UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4">UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4</a>
;     <a href="#UNUSED_WriteCurrentBackgroundPalette">UNUSED_WriteCurrentBackgroundPalette</a>
;============================================================================
</div><span class="l"><a class="anc" name="d03b" href="#d03b">[d03b]</a><a href="#Screen_LoadUIPalette" class="la">Screen_LoadUIPalette:</a><span class="ce">; [$d03b]</span></span>
<span class="l"><a class="anc" name="d03b" href="#d03b">[d03b]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (palette index).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and load bank 11 (palette data).
;
</div><span class="l"><a class="anc" name="d03c" href="#d03c">[d03c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="d03f" href="#d03f">[d03f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="d040" href="#d040">[d040]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><a class="anc" name="d042" href="#d042">[d042]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the attribute data index for the HUD.
;
</div><span class="l"><a class="anc" name="d045" href="#d045">[d045]</a><span class="cd"><span class="i">LDA</span> <span class="o">$81f0,Y</span></span><span class="ce">; Load the HUD attribute data for this index.</span></span>
<span class="l"><a class="anc" name="d048" href="#d048">[d048]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#UI_AttributeDataIndex">UI_AttributeDataIndex</a></span></span><span class="ce">; Set it for the HUD/textboxes.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore our current bank.
;
</div><span class="l"><a class="anc" name="d04b" href="#d04b">[d04b]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A (previous bank) from the stack.</span></span>
<span class="l"><a class="anc" name="d04c" href="#d04c">[d04c]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d04d" href="#d04d">[d04d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch back to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Get the offset into the bank.
;
</div><span class="l"><a class="anc" name="d050" href="#d050">[d050]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (palette index).</span></span>
<span class="l"><a class="anc" name="d051" href="#d051">[d051]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a></span></span><span class="ce">; Convert to a relative offset into the bank.</span></span>
<span class="l"><a class="anc" name="d054" href="#d054">[d054]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add 0 + C (also 0) to the lower byte.</span></span>
<span class="l"><a class="anc" name="d056" href="#d056">[d056]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="d058" href="#d058">[d058]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Load the computed upper byte.</span></span>
<span class="l"><a class="anc" name="d05a" href="#d05a">[d05a]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80.</span></span>
<span class="l"><a class="anc" name="d05c" href="#d05c">[d05c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write that palette into the sprite palette.
;
</div><span class="l"><a class="anc" name="d05e" href="#d05e">[d05e]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$0f</span></span><span class="ce">; Start writing into index 16 (sprite palette).</span></span>
<span class="l"><a class="anc" name="d060" href="#d060">[d060]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Screen_SetPaletteData">Screen_SetPaletteData</a></span></span><span class="ce">; Load it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadSpritePalette"></a><div class="cp">;============================================================================
; Populate the sprite palette data for the screen.
;
; This will load the palette data for sprites from the
; data stored in bank 11 at the address stored in
; <a href="RAM.html#Temp_08">Temp_08</a> and populate
; <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>.
;
; INPUTS:
;     Y:
;         The palette destination index to load into.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;         The address to load data from in bank 11.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>:
;         The resulting palette data.
;
;     <a href="RAM.html#Palette_SpritePaletteIndex">Palette_SpritePaletteIndex</a>:
;         The index of the loaded palette.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         Clobbered
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a>
;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#IScripts_ClearPortraitImage">IScripts_ClearPortraitImage</a>
;     <a href="#IScripts_LoadPortraitTiles">IScripts_LoadPortraitTiles</a>
;     <a href="#Screen_Load">Screen_Load</a>
;============================================================================
</div><span class="l"><a class="anc" name="d062" href="#d062">[d062]</a><a href="#Screen_LoadSpritePalette" class="la">Screen_LoadSpritePalette:</a><span class="ce">; [$d062]</span></span>
<span class="l"><a class="anc" name="d062" href="#d062">[d062]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Palette_SpritePaletteIndex">Palette_SpritePaletteIndex</a></span></span><span class="ce">; Set the palette index based on the provided A.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the ROM address for this palette.
;
; This should be 0x81C0 + palette offset.
;
</div><span class="l"><a class="anc" name="d065" href="#d065">[d065]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a></span></span><span class="ce">; Convert the relative address for the palette.</span></span>
<span class="l"><a class="anc" name="d068" href="#d068">[d068]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$c0</span></span><span class="ce">; Add 0xC0 to the lower byte.</span></span>
<span class="l"><a class="anc" name="d06a" href="#d06a">[d06a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="d06c" href="#d06c">[d06c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Load the computed upper byte.</span></span>
<span class="l"><a class="anc" name="d06e" href="#d06e">[d06e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$81</span></span><span class="ce">; Add 0x81 to it.</span></span>
<span class="l"><a class="anc" name="d070" href="#d070">[d070]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the previous bank and switch to bank 11 (palette data).
;
</div><span class="l"><a class="anc" name="d072" href="#d072">[d072]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$1f</span></span><span class="ce">; Y = Destination for the palette (31).</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_SetPaletteData"></a><div class="cp">;============================================================================
; Populate palette data for the screen.
;
; This will load the palette data from the data stored
; in bank 11 at the address stored in <a href="RAM.html#Temp_08">Temp_08</a> and
; populate <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>.
;
; This is common to both <a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a>
; and <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>.
;
; INPUTS:
;     Y:
;         The palette destination index to load into.
;
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;         The address to load data from in bank 11.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>:
;         The resulting palette data.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a>
;============================================================================
</div><span class="l"><a class="anc" name="d074" href="#d074">[d074]</a><a href="#Screen_SetPaletteData" class="la">Screen_SetPaletteData:</a><span class="ce">; [$d074]</span></span>
<div class="c">;
; Save the current bank.
;
</div><span class="l"><a class="anc" name="d074" href="#d074">[d074]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="d077" href="#d077">[d077]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="d078" href="#d078">[d078]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0b</span></span></span>
<span class="l"><a class="anc" name="d07a" href="#d07a">[d07a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 11.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Copy 16 bytes of palette into ROM.
;
</div><span class="l"><a class="anc" name="d07d" href="#d07d">[d07d]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (palette data index)</span></span>
<span class="l"><a class="anc" name="d07e" href="#d07e">[d07e]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d07f" href="#d07f">[d07f]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$0f</span></span><span class="ce">; Y = 15 (loop counter)</span></span>
<span class="l"></span>
<a name=":d081:@_loadPaletteLoop"></a><span class="l"><a class="anc" name="d081" href="#d081">[d081]</a><a href="#:d081:@_loadPaletteLoop" class="lla">@_loadPaletteLoop:</a><span class="ce">; [$d081]</span></span>
<span class="l"><a class="anc" name="d081" href="#d081">[d081]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Load the byte to copy.</span></span>
<span class="l"><a class="anc" name="d083" href="#d083">[d083]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>,X</span></span><span class="ce">; Store as the palette data at the index.</span></span>
<span class="l"><a class="anc" name="d086" href="#d086">[d086]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X-- (destination index)</span></span>
<span class="l"><a class="anc" name="d087" href="#d087">[d087]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y-- (loop counter)</span></span>
<span class="l"><a class="anc" name="d088" href="#d088">[d088]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loadPaletteLoop">@_loadPaletteLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch bank to the previous bank.
;
</div><span class="l"><a class="anc" name="d08a" href="#d08a">[d08a]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank.</span></span>
<span class="l"><a class="anc" name="d08b" href="#d08b">[d08b]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d08c" href="#d08c">[d08c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"><a class="anc" name="d08f" href="#d08f">[d08f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_WritePalette"></a><div class="cp">;============================================================================
; Queue writing the palette to the PPU.
;
; This will write Draw Command 0 to the PPU buffer,
; responsible for writing the palette.
;
; INPUTS:
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>:
;         The palette data to write.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds of the buffer.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer to append to.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new size of the buffer.
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#SplashAnimation_DrawScenery">SplashAnimation_DrawScenery</a>
;     <a href="PRG12.html#SplashAnimation_Intro_SomethingA708">SplashAnimation_Intro_SomethingA708</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#IScripts_ClearPortraitImage">IScripts_ClearPortraitImage</a>
;     <a href="#IScripts_LoadPortraitTiles">IScripts_LoadPortraitTiles</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_SetFadeOutPalette">Screen_SetFadeOutPalette</a>
;     <a href="#Screen_SetupSprites">Screen_SetupSprites</a>
;     <a href="#UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4">UNUSED_PPUBuffer_DrawCommand_WriteBackgroundPalette4</a>
;     <a href="#UNUSED_WriteCurrentBackgroundPalette">UNUSED_WriteCurrentBackgroundPalette</a>
;============================================================================
</div><span class="l"><a class="anc" name="d090" href="#d090">[d090]</a><a href="#PPUBuffer_WritePalette" class="la">PPUBuffer_WritePalette:</a><span class="ce">; [$d090]</span></span>
<span class="l"><a class="anc" name="d090" href="#d090">[d090]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="d092" href="#d092">[d092]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; X = upper bounds of the buffer</span></span>
<span class="l"><a class="anc" name="d094" href="#d094">[d094]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store the 0 in the buffer at the upper bounds.</span></span>
<span class="l"><a class="anc" name="d097" href="#d097">[d097]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment the upper bounds.</span></span>
<span class="l"><a class="anc" name="d098" href="#d098">[d098]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="d09a" href="#d09a">[d09a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Palette_IndexToROMOffset16"></a><div class="cp">;============================================================================
; Return a 16-bit offset for a value.
;
; This multiplies the provided index by 16 and splits the
; 16-bit result into a low byte (A) and a high byte
; (<a href="RAM.html#Temp_09">Temp_09</a>).
;
; Carry is cleared on exit so the caller can 16-bit add a
; base address with ADC (low) / ADC (high) cleanly.
;
; This is used by palette code to build a ROM pointer in
; the form of:
;
;     PaletteAddr = Base + (index * 16)
;
; INPUTS:
;     A:
;         The index to convert to a 16-byte offset.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         The high byte (index * 16)
;
;     A:
;         The low byte (index * 16)
;
;     C (Carry):
;         Cleared (0) for subsequent 16-bit ADC adds.
;
;     Y:
;         Set to 0 (clobbered).
;
; XREFS:
;     <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>
;     <a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a>
;     <a href="#Screen_SetFadeOutPalette">Screen_SetFadeOutPalette</a>
;============================================================================
</div><span class="l"><a class="anc" name="d09b" href="#d09b">[d09b]</a><a href="#Palette_IndexToROMOffset16" class="la">Palette_IndexToROMOffset16:</a><span class="ce">; [$d09b]</span></span>
<span class="l"><a class="anc" name="d09b" href="#d09b">[d09b]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="d09d" href="#d09d">[d09d]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><a class="anc" name="d09f" href="#d09f">[d09f]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left, upper bit into Carry.</span></span>
<span class="l"><a class="anc" name="d0a0" href="#d0a0">[d0a0]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Rotate left, carry into bit 0, bit 7 into carry.</span></span>
<span class="l"><a class="anc" name="d0a2" href="#d0a2">[d0a2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Repeat 3 more times, moving lower nibble into A, upper nibble into <a href="RAM.html#Temp_09">Temp_09</a>.</span></span>
<span class="l"><a class="anc" name="d0a3" href="#d0a3">[d0a3]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d0a5" href="#d0a5">[d0a5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d0a6" href="#d0a6">[d0a6]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d0a8" href="#d0a8">[d0a8]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d0a9" href="#d0a9">[d0a9]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d0ab" href="#d0ab">[d0ab]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear carry.</span></span>
<span class="l"><a class="anc" name="d0ac" href="#d0ac">[d0ac]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Return A and <a href="RAM.html#Temp_09">Temp_09</a>.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_SetFadeOutPalette"></a><div class="cp">;============================================================================
; Update the current palette for the fade-out stage.
;
; This will iterate through the background palette,
; subtracting a value from each byte depending on the stage
; (increasing along with the stage's value). It works out
; as:
;
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>[i] =
;     <a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a> * 0x10
;
; INPUTS:
;     A:
;         The index of the palette to use as a source.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a>:
;         The current stage of fade-out, between 0 and 3.
;
;     <a href="#FADE_OUT_DELTA_TABLE">FADE_OUT_DELTA_TABLE</a>:
;         The table of palette values to subtract, based on
;         the stage.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>:
;         The modified background palette data.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a>
;     <a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a>.
;
; XREFS:
;     <a href="#Screen_NextTransitionState">Screen_NextTransitionState</a>
;============================================================================
</div><span class="l"><a class="anc" name="d0ad" href="#d0ad">[d0ad]</a><a href="#Screen_SetFadeOutPalette" class="la">Screen_SetFadeOutPalette:</a><span class="ce">; [$d0ad]</span></span>
<div class="c">;
; Get an address for the provided palette in bank 11.
;
</div><span class="l"><a class="anc" name="d0ad" href="#d0ad">[d0ad]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Palette_IndexToROMOffset16">Palette_IndexToROMOffset16</a></span></span><span class="ce">; Convert the palette to a 16-bit integer.</span></span>
<span class="l"><a class="anc" name="d0b0" href="#d0b0">[d0b0]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add 0 and carry (which is also 0) to the lower byte.</span></span>
<span class="l"><a class="anc" name="d0b2" href="#d0b2">[d0b2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store temporarily as the lower byte.</span></span>
<span class="l"><a class="anc" name="d0b4" href="#d0b4">[d0b4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Load it back into A.</span></span>
<span class="l"><a class="anc" name="d0b6" href="#d0b6">[d0b6]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80.</span></span>
<span class="l"><a class="anc" name="d0b8" href="#d0b8">[d0b8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and switch to bank 11.
;
</div><span class="l"><a class="anc" name="d0ba" href="#d0ba">[d0ba]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current bank.</span></span>
<span class="l"><a class="anc" name="d0bd" href="#d0bd">[d0bd]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="d0be" href="#d0be">[d0be]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0b</span></span><span class="ce">; 11 = Sprite info/palettes bank.</span></span>
<span class="l"><a class="anc" name="d0c0" href="#d0c0">[d0c0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to that bank.</span></span>
<span class="l"><a class="anc" name="d0c3" href="#d0c3">[d0c3]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Beginning looping through the 16 bytes of palette.
;
; This will load the palette for the current screen and
; then subtract a value from a fade-out table
; (<a href="#FADE_OUT_DELTA_TABLE">FADE_OUT_DELTA_TABLE</a>) based on the fade-out
; cycle (<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a>).
;
</div><span class="l"><a class="anc" name="d0c6" href="#d0c6">[d0c6]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$0f</span></span><span class="ce">; Y = 15 (loop counter).</span></span>
<span class="l"></span>
<a name=":d0c8:@_loop"></a><span class="l"><a class="anc" name="d0c8" href="#d0c8">[d0c8]</a><a href="#:d0c8:@_loop" class="lla">@_loop:</a><span class="ce">; [$d0c8]</span></span>
<span class="l"><a class="anc" name="d0c8" href="#d0c8">[d0c8]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Load the palette data at Y.</span></span>
<span class="l"><a class="anc" name="d0ca" href="#d0ca">[d0ca]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Set C = 1 so SBC won't subtract C.</span></span>
<span class="l"><a class="anc" name="d0cb" href="#d0cb">[d0cb]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="#FADE_OUT_DELTA_TABLE">FADE_OUT_DELTA_TABLE</a>,X</span></span><span class="ce">; Subtract the value form the lookup table at the transition index.</span></span>
<span class="l"><a class="anc" name="d0ce" href="#d0ce">[d0ce]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_setPaletteData">@_setPaletteData</a></span></span><span class="ce">; If &gt; 0, jump to use this value as the palette.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The subtraction yielded a palette value &lt;= 0, so
; hard-code to 15.
;
</div><span class="l"><a class="anc" name="d0d0" href="#d0d0">[d0d0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0f</span></span><span class="ce">; Set palette = 15.</span></span>
<span class="l"></span>
<a name=":d0d2:@_setPaletteData"></a><span class="l"><a class="anc" name="d0d2" href="#d0d2">[d0d2]</a><a href="#:d0d2:@_setPaletteData" class="lla">@_setPaletteData:</a><span class="ce">; [$d0d2]</span></span>
<span class="l"><a class="anc" name="d0d2" href="#d0d2">[d0d2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_PaletteData">Screen_PaletteData</a>,Y</span></span><span class="ce">; Set the palette data to A at index Y.</span></span>
<span class="l"><a class="anc" name="d0d5" href="#d0d5">[d0d5]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="d0d6" href="#d0d6">[d0d6]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><a class="anc" name="d0d8" href="#d0d8">[d0d8]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the previous bank from the stack.</span></span>
<span class="l"><a class="anc" name="d0d9" href="#d0d9">[d0d9]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set in X.</span></span>
<span class="l"><a class="anc" name="d0da" href="#d0da">[d0da]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch to that bank.</span></span>
<span class="l"><a class="anc" name="d0dd" href="#d0dd">[d0dd]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span><span class="ce">; Append to the PPU buffer to trigger a screen update.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="FADE_OUT_DELTA_TABLE"></a><div class="cp">;============================================================================
; Table of values to subtract from a palette to fade-out the current screen.
;
; XREFS:
;     <a href="#Screen_SetFadeOutPalette">Screen_SetFadeOutPalette</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Screen_SetFadeOutPalette">Screen_SetFadeOutPalette</a>
;
</div><span class="l"><a class="anc" name="d0e0" href="#d0e0">[d0e0]</a><a href="#FADE_OUT_DELTA_TABLE" class="la">FADE_OUT_DELTA_TABLE:</a><span class="ce">; [$d0e0]</span></span>
<span class="l"><a class="anc" name="d0e0" href="#d0e0">[d0e0]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d0e1" href="#d0e1">[d0e1]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d0e2" href="#d0e2">[d0e2]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d0e3" href="#d0e3">[d0e3]</a><span class="cd"><span class="i">db</span> <span class="o">$40</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sound_PlayEffect"></a><div class="cp">;============================================================================
; Play a sound effect.
;
; INPUTS:
;     A:
;         The sound ID to play.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_SoundIDToPlay">Temp_SoundIDToPlay</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#SoundEffect_SetCurrent">SoundEffect_SetCurrent</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_PlayFillingSound">IScripts_PlayFillingSound</a>
;     <a href="PRG12.html#IScripts_PlayGoldChangeSound">IScripts_PlayGoldChangeSound</a>
;     <a href="PRG12.html#Menu_UpdateAndDraw">Menu_UpdateAndDraw</a>
;     <a href="PRG12.html#PasswordScreen_DrawAndHandleInputLoop">PasswordScreen_DrawAndHandleInputLoop</a>
;     <a href="PRG12.html#PlayerMenu_EquipItem">PlayerMenu_EquipItem</a>
;     <a href="PRG12.html#PlayerMenu_HandleInvalidChoice">PlayerMenu_HandleInvalidChoice</a>
;     <a href="PRG12.html#PlayerMenu_HandleInventoryMenuInput">PlayerMenu_HandleInventoryMenuInput</a>
;     <a href="PRG12.html#PlayerMenu_Show">PlayerMenu_Show</a>
;     <a href="PRG12.html#Sound_PlayInputSound">Sound_PlayInputSound</a>
;     <a href="PRG12.html#Sound_PlayMoveCursorSound">Sound_PlayMoveCursorSound</a>
;     <a href="PRG12.html#SplashAnimation_Maybe_AnimPlayerStep">SplashAnimation_Maybe_AnimPlayerStep</a>
;     <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>
;     <a href="PRG14.html#CastMagic_UpdateDeluge">CastMagic_UpdateDeluge</a>
;     <a href="PRG14.html#CastMagic_UpdateFire">CastMagic_UpdateFire</a>
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;     <a href="PRG14.html#Player_HandleShieldHitByMagic">Player_HandleShieldHitByMagic</a>
;     <a href="PRG14.html#Player_HandleTouchBread">Player_HandleTouchBread</a>
;     <a href="PRG14.html#Player_HandleTouchCoin">Player_HandleTouchCoin</a>
;     <a href="PRG14.html#Player_HandleTouchEnemy">Player_HandleTouchEnemy</a>
;     <a href="PRG14.html#Player_HitEnemyWithMagic">Player_HitEnemyWithMagic</a>
;     <a href="PRG14.html#Player_HitSpriteWithWeapon">Player_HitSpriteWithWeapon</a>
;     <a href="PRG14.html#SpriteBehavior_BossDeath">SpriteBehavior_BossDeath</a>
;     <a href="PRG14.html#SpriteBehavior_FlashScreenHitPlayer">SpriteBehavior_FlashScreenHitPlayer</a>
;     <a href="PRG14.html#SpriteBehavior_Garbled3">SpriteBehavior_Garbled3</a>
;     <a href="PRG14.html#SpriteBehavior_Pakukame">SpriteBehavior_Pakukame</a>
;     <a href="PRG14.html#Sprites_ReplaceWithCoinDrop">Sprites_ReplaceWithCoinDrop</a>
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#Game_UnlockDoor">Game_UnlockDoor</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_PickUpBattleHelmet">Player_PickUpBattleHelmet</a>
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a>
;     <a href="#Player_PickUpBlackOnyx">Player_PickUpBlackOnyx</a>
;     <a href="#Player_PickUpDragonSlayer">Player_PickUpDragonSlayer</a>
;     <a href="#Player_PickUpElixir">Player_PickUpElixir</a>
;     <a href="#Player_PickUpGlove">Player_PickUpGlove</a>
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMattock">Player_PickUpMattock</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;     <a href="#ScreenEvents_HandleFinalBossKilled">ScreenEvents_HandleFinalBossKilled</a>
;     <a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a>
;============================================================================
</div><span class="l"><a class="anc" name="d0e4" href="#d0e4">[d0e4]</a><a href="#Sound_PlayEffect" class="la">Sound_PlayEffect:</a><span class="ce">; [$d0e4]</span></span>
<span class="l"><a class="anc" name="d0e4" href="#d0e4">[d0e4]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_SoundIDToPlay">Temp_SoundIDToPlay</a></span></span><span class="ce">; Store the provided sound effect to play.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Push X and Y on the stack. They will be clobbered when
; playing the sound.
;
</div><span class="l"><a class="anc" name="d0e7" href="#d0e7">[d0e7]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; Push X</span></span>
<span class="l"><a class="anc" name="d0e8" href="#d0e8">[d0e8]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d0e9" href="#d0e9">[d0e9]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; Push Y</span></span>
<span class="l"><a class="anc" name="d0ea" href="#d0ea">[d0ea]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d0eb" href="#d0eb">[d0eb]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Temp_SoundIDToPlay">Temp_SoundIDToPlay</a></span></span><span class="ce">; Load the sound ID we stored.</span></span>
<span class="l"><a class="anc" name="d0ee" href="#d0ee">[d0ee]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#SoundEffect_SetCurrent">SoundEffect_SetCurrent</a></span></span><span class="ce">; Play the sound.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Pop X and Y from the stack and restore.
;
</div><span class="l"><a class="anc" name="d0f1" href="#d0f1">[d0f1]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A into Y.</span></span>
<span class="l"><a class="anc" name="d0f2" href="#d0f2">[d0f2]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d0f3" href="#d0f3">[d0f3]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A into X.</span></span>
<span class="l"><a class="anc" name="d0f4" href="#d0f4">[d0f4]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d0f5" href="#d0f5">[d0f5]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_ScrollScreenRight"></a><div class="cp">;============================================================================
; TODO: Document Area_ScrollScreenRight
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;============================================================================
</div><span class="l"><a class="anc" name="d0f6" href="#d0f6">[d0f6]</a><a href="#Area_ScrollScreenRight" class="la">Area_ScrollScreenRight:</a><span class="ce">; [$d0f6]</span></span>
<span class="l"><a class="anc" name="d0f6" href="#d0f6">[d0f6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d0f8" href="#d0f8">[d0f8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollHorizDirection">Screen_Maybe_ScrollHorizDirection</a></span></span></span>
<span class="l"><a class="anc" name="d0fa" href="#d0fa">[d0fa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MaybeUnused_006d">MaybeUnused_006d</a></span></span></span>
<span class="l"><a class="anc" name="d0fc" href="#d0fc">[d0fc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollHorizDirection">Screen_Maybe_ScrollHorizDirection</a></span></span></span>
<span class="l"><a class="anc" name="d0fe" href="#d0fe">[d0fe]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d100" href="#d100">[d100]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d102" href="#d102">[d102]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d104" href="#d104">[d104]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d106" href="#d106">[d106]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_LoadBlocksStage">Screen_LoadBlocksStage</a></span></span></span>
<span class="l"><a class="anc" name="d108" href="#d108">[d108]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_NeighborBlocksLoadedByDirection">Screen_NeighborBlocksLoadedByDirection</a></span></span></span>
<span class="l"><a class="anc" name="d10a" href="#d10a">[d10a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocksLoaded">Screen_ScrollHorizBlocksLoaded</a></span></span></span>
<span class="l"><a class="anc" name="d10c" href="#d10c">[d10c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_MaybeUnused_0075">Screen_MaybeUnused_0075</a></span></span></span>
<span class="l"><a class="anc" name="d10e" href="#d10e">[d10e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizAttrsLoaded">Screen_ScrollHorizAttrsLoaded</a></span></span></span>
<span class="l"><a class="anc" name="d110" href="#d110">[d110]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d112" href="#d112">[d112]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d114" href="#d114">[d114]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d115" href="#d115">[d115]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d117" href="#d117">[d117]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d119" href="#d119">[d119]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a></span></span></span>
<span class="l"></span>
<a name=":d11c:@_loop"></a><span class="l"><a class="anc" name="d11c" href="#d11c">[d11c]</a><a href="#:d11c:@_loop" class="lla">@_loop:</a><span class="ce">; [$d11c]</span></span>
<span class="l"><a class="anc" name="d11c" href="#d11c">[d11c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_HandleScroll">Screen_HandleScroll</a></span></span></span>
<span class="l"><a class="anc" name="d11f" href="#d11f">[d11f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_RunWriteScrollDataHandler">Screen_RunWriteScrollDataHandler</a></span></span></span>
<span class="l"><a class="anc" name="d122" href="#d122">[d122]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="d124" href="#d124">[d124]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="d126" href="#d126">[d126]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_LoadScrollDataRight"></a><div class="cp">;============================================================================
; TODO: Document Area_LoadScrollDataRight
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ScrollScreenRight">Area_ScrollScreenRight</a>
;     <a href="#Area_ScrollTo">Area_ScrollTo</a>
;============================================================================
</div><span class="l"><a class="anc" name="d127" href="#d127">[d127]</a><a href="#Area_LoadScrollDataRight" class="la">Area_LoadScrollDataRight:</a><span class="ce">; [$d127]</span></span>
<span class="l"><a class="anc" name="d127" href="#d127">[d127]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="d129" href="#d129">[d129]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d12b" href="#d12b">[d12b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d12d" href="#d12d">[d12d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d12f" href="#d12f">[d12f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d131" href="#d131">[d131]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d134" href="#d134">[d134]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d135" href="#d135">[d135]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d137" href="#d137">[d137]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d13a" href="#d13a">[d13a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d13c" href="#d13c">[d13c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="d13e" href="#d13e">[d13e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="d140" href="#d140">[d140]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d141" href="#d141">[d141]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="d143" href="#d143">[d143]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d144" href="#d144">[d144]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="d146" href="#d146">[d146]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d147" href="#d147">[d147]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#CurrentArea_ScrollingDataAddr">CurrentArea_ScrollingDataAddr</a></span></span></span>
<span class="l"><a class="anc" name="d149" href="#d149">[d149]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><a class="anc" name="d14b" href="#d14b">[d14b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="d14d" href="#d14d">[d14d]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#ScrollingData_U">ScrollingData_U</a></span></span></span>
<span class="l"><a class="anc" name="d14f" href="#d14f">[d14f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="d151" href="#d151">[d151]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d153:@_loadScrollData"></a><span class="l"><a class="anc" name="d153" href="#d153">[d153]</a><a href="#:d153:@_loadScrollData" class="lla">@_loadScrollData:</a><span class="ce">; [$d153]</span></span>
<span class="l"><a class="anc" name="d153" href="#d153">[d153]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d155" href="#d155">[d155]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d158" href="#d158">[d158]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d159" href="#d159">[d159]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="d15b" href="#d15b">[d15b]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loadScrollData">@_loadScrollData</a></span></span></span>
<span class="l"><a class="anc" name="d15d" href="#d15d">[d15d]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d15e" href="#d15e">[d15e]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d15f" href="#d15f">[d15f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d162" href="#d162">[d162]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d164" href="#d164">[d164]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load blocks to the left of the screen.
;
</div><span class="l"><a class="anc" name="d167" href="#d167">[d167]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a></span></span></span>
<span class="l"><a class="anc" name="d169" href="#d169">[d169]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span></span>
<span class="l"><a class="anc" name="d16c" href="#d16c">[d16c]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="d16e" href="#d16e">[d16e]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d170:@_copyLastColumnLeftScreenLoop"></a><span class="l"><a class="anc" name="d170" href="#d170">[d170]</a><a href="#:d170:@_copyLastColumnLeftScreenLoop" class="lla">@_copyLastColumnLeftScreenLoop:</a><span class="ce">; [$d170]</span></span>
<span class="l"><a class="anc" name="d170" href="#d170">[d170]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="d173" href="#d173">[d173]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d176" href="#d176">[d176]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d177" href="#d177">[d177]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d178" href="#d178">[d178]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d17a" href="#d17a">[d17a]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d17b" href="#d17b">[d17b]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d17c" href="#d17c">[d17c]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d17e" href="#d17e">[d17e]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_copyLastColumnLeftScreenLoop">@_copyLastColumnLeftScreenLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load blocks to the right of the screen.
;
</div><span class="l"><a class="anc" name="d180" href="#d180">[d180]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheRight">Area_ScreenToTheRight</a></span></span></span>
<span class="l"><a class="anc" name="d182" href="#d182">[d182]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span></span>
<span class="l"><a class="anc" name="d185" href="#d185">[d185]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d187" href="#d187">[d187]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d189:@_copyRowScreenAboveLoop"></a><span class="l"><a class="anc" name="d189" href="#d189">[d189]</a><a href="#:d189:@_copyRowScreenAboveLoop" class="lla">@_copyRowScreenAboveLoop:</a><span class="ce">; [$d189]</span></span>
<span class="l"><a class="anc" name="d189" href="#d189">[d189]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="d18c" href="#d18c">[d18c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d18f" href="#d18f">[d18f]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d190" href="#d190">[d190]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d191" href="#d191">[d191]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d193" href="#d193">[d193]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d194" href="#d194">[d194]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d195" href="#d195">[d195]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d197" href="#d197">[d197]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_copyRowScreenAboveLoop">@_copyRowScreenAboveLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load blocks from the screen above.
;
</div><span class="l"><a class="anc" name="d199" href="#d199">[d199]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenAbove">Area_ScreenAbove</a></span></span></span>
<span class="l"><a class="anc" name="d19b" href="#d19b">[d19b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span><span class="ce">; Load blocks from screen above.</span></span>
<span class="l"><a class="anc" name="d19e" href="#d19e">[d19e]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$f0</span></span><span class="ce">; X = 240</span></span>
<span class="l"></span>
<a name=":d1a0:@_copyRowScreenBelowLoop"></a><span class="l"><a class="anc" name="d1a0" href="#d1a0">[d1a0]</a><a href="#:d1a0:@_copyRowScreenBelowLoop" class="lla">@_copyRowScreenBelowLoop:</a><span class="ce">; [$d1a0]</span></span>
<span class="l"><a class="anc" name="d1a0" href="#d1a0">[d1a0]</a><span class="cd"><span class="i">LDA</span> <span class="o">$05d0,X</span></span></span>
<span class="l"><a class="anc" name="d1a3" href="#d1a3">[d1a3]</a><span class="cd"><span class="i">STA</span> <span class="o">$0316,X</span></span></span>
<span class="l"><a class="anc" name="d1a6" href="#d1a6">[d1a6]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="d1a7" href="#d1a7">[d1a7]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_copyRowScreenBelowLoop">@_copyRowScreenBelowLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load blocks from the screen below.
;
</div><span class="l"><a class="anc" name="d1a9" href="#d1a9">[d1a9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenBelow">Area_ScreenBelow</a></span></span></span>
<span class="l"><a class="anc" name="d1ab" href="#d1ab">[d1ab]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span><span class="ce">; Load blocks from screen below.</span></span>
<span class="l"><a class="anc" name="d1ae" href="#d1ae">[d1ae]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$f0</span></span></span>
<span class="l"></span>
<a name=":d1b0:@LAB_PRG15_MIRROR__d1b0"></a><span class="l"><a class="anc" name="d1b0" href="#d1b0">[d1b0]</a><a href="#:d1b0:@LAB_PRG15_MIRROR__d1b0" class="lla">@LAB_PRG15_MIRROR__d1b0:</a><span class="ce">; [$d1b0]</span></span>
<span class="l"><a class="anc" name="d1b0" href="#d1b0">[d1b0]</a><span class="cd"><span class="i">LDA</span> <span class="o">$0510,X</span></span></span>
<span class="l"><a class="anc" name="d1b3" href="#d1b3">[d1b3]</a><span class="cd"><span class="i">STA</span> <span class="o">$0326,X</span></span></span>
<span class="l"><a class="anc" name="d1b6" href="#d1b6">[d1b6]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d1b7" href="#d1b7">[d1b7]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d1b0">@LAB_PRG15_MIRROR__d1b0</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load blocks for the current screen.
;
</div><span class="l"><a class="anc" name="d1b9" href="#d1b9">[d1b9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="d1bb" href="#d1bb">[d1bb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadBlocks">Area_LoadBlocks</a></span></span></span>
<span class="l"><a class="anc" name="d1be" href="#d1be">[d1be]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d1c1" href="#d1c1">[d1c1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="d1c3" href="#d1c3">[d1c3]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="d1c5" href="#d1c5">[d1c5]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_VerticalScroll">@_VerticalScroll</a></span></span></span>
<span class="l"><a class="anc" name="d1c7" href="#d1c7">[d1c7]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d1c8" href="#d1c8">[d1c8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d1ca" href="#d1ca">[d1ca]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span></span>
<span class="l"><a class="anc" name="d1cc" href="#d1cc">[d1cc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="d1ce" href="#d1ce">[d1ce]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="d1d0" href="#d1d0">[d1d0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE">SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE</a>,X</span></span></span>
<span class="l"><a class="anc" name="d1d3" href="#d1d3">[d1d3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="d1d5" href="#d1d5">[d1d5]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":d1d6:@_VerticalScroll"></a><span class="l"><a class="anc" name="d1d6" href="#d1d6">[d1d6]</a><a href="#:d1d6:@_VerticalScroll" class="lla">@_VerticalScroll:</a><span class="ce">; [$d1d6]</span></span>
<span class="l"><a class="anc" name="d1d6" href="#d1d6">[d1d6]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d1d8" href="#d1d8">[d1d8]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d1d9" href="#d1d9">[d1d9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="d1db" href="#d1db">[d1db]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="d1dd" href="#d1dd">[d1dd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d1df" href="#d1df">[d1df]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span></span>
<span class="l"><a class="anc" name="d1e1" href="#d1e1">[d1e1]</a><span class="cd"><span class="i">LDA</span> <span class="o">$d1e9,X</span></span></span>
<span class="l"><a class="anc" name="d1e4" href="#d1e4">[d1e4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="d1e6" href="#d1e6">[d1e6]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE"></a><div class="c">;
; XREFS:
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;
</div><span class="l"><a class="anc" name="d1e7" href="#d1e7">[d1e7]</a><a href="#SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE" class="la">SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE:</a><span class="ce">; [$d1e7]</span></span>
<span class="l"><a class="anc" name="d1e7" href="#d1e7">[d1e7]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d1e8" href="#d1e8">[d1e8]</a><span class="cd"><span class="i">db</span> <span class="o">$f0</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<a name="SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE_2_"></a><div class="c">;
; XREFS:
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;
</div><span class="l"><a class="anc" name="d1e9" href="#d1e9">[d1e9]</a><a href="#SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE_2_" class="la">SCREEN_MAYBE_PLAYERX_FOR_SCROLL_MODE_2_:</a><span class="ce">; [$d1e9]</span></span>
<span class="l"><a class="anc" name="d1e9" href="#d1e9">[d1e9]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d1ea" href="#d1ea">[d1ea]</a><span class="cd"><span class="i">db</span> <span class="o">$d0</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="ScreenBuffer_Clear"></a><div class="cp">;============================================================================
; Fill the screen buffer with 0s.
;
; This will clear 256 bytes of screen data from $0600
; to $06FF.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         256 bytes of screen buffer will be cleared.
;
; XREFS:
;     <a href="#Area_LoadBlocks">Area_LoadBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d1eb" href="#d1eb">[d1eb]</a><a href="#ScreenBuffer_Clear" class="la">ScreenBuffer_Clear:</a><span class="ce">; [$d1eb]</span></span>
<span class="l"><a class="anc" name="d1eb" href="#d1eb">[d1eb]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0</span></span>
<span class="l"><a class="anc" name="d1ed" href="#d1ed">[d1ed]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d1ef:@_loop"></a><div class="c">;
; Begin writing empty blocks.
;
</div><span class="l"><a class="anc" name="d1ef" href="#d1ef">[d1ef]</a><a href="#:d1ef:@_loop" class="lla">@_loop:</a><span class="ce">; [$d1ef]</span></span>
<span class="l"><a class="anc" name="d1ef" href="#d1ef">[d1ef]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Write 0 to the screen buffer.</span></span>
<span class="l"><a class="anc" name="d1f2" href="#d1f2">[d1f2]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><a class="anc" name="d1f3" href="#d1f3">[d1f3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X hasn't wrapped back to 0, loop.</span></span>
<span class="l"><a class="anc" name="d1f5" href="#d1f5">[d1f5]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_LoadBlocks"></a><div class="cp">;============================================================================
; Load blocks for the given screen from the level data.
;
; This will load the compressed block data for a given
; screen. Data is stored in by using a control byte and
; optional data bytes.
;
; Control bytes dictate where the next block comes from.
; The following are supported:
;
; 0x00: Copy the block from one position to the left
;       (or last block on previous row, if at column 0).
;
; 0x01: Copy from the block in the row directly above.
;
; 0x02: Copy from the block directly up and to the left
;       (or last block 2 rows up, if at column 0)
;
; 0x03: Read the next value as the block.
;
; INPUTS:
;     A:
;         The index of the screen to load.
;
;     <a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a>:
;         The offset into the blocks data for the current
;         screen.
;
; OUTPUTS:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         Updated with loaded block data.
;
;     <a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a>:
;     <a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a>:
;     <a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a>:
;     <a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a>:
;     <a href="RAM.html#Temp_08">Temp_08</a>:
;     <a href="RAM.html#Temp_09">Temp_09</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a>
;     <a href="#ScreenBuffer_Clear">ScreenBuffer_Clear</a>
;
; XREFS:
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="d1f6" href="#d1f6">[d1f6]</a><a href="#Area_LoadBlocks" class="la">Area_LoadBlocks:</a><span class="ce">; [$d1f6]</span></span>
<span class="l"><a class="anc" name="d1f6" href="#d1f6">[d1f6]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Check if the screen index is set.</span></span>
<span class="l"><a class="anc" name="d1f8" href="#d1f8">[d1f8]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#ScreenBuffer_Clear">ScreenBuffer_Clear</a></span></span><span class="ce">; If not, then clear the screen buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We'll be loading blocks for this screen. Calculate
; the address we'll be loading from.
;
</div><span class="l"><a class="anc" name="d1fa" href="#d1fa">[d1fa]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply screen index by 2</span></span>
<span class="l"><a class="anc" name="d1fb" href="#d1fb">[d1fb]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = New screen index offset value</span></span>
<span class="l"><a class="anc" name="d1fc" href="#d1fc">[d1fc]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a>),Y</span></span><span class="ce">; Set the lower block data address for this screen index.</span></span>
<span class="l"><a class="anc" name="d1fe" href="#d1fe">[d1fe]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="d200" href="#d200">[d200]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="d201" href="#d201">[d201]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a>),Y</span></span><span class="ce">; Set the upper block data address for this screen index.</span></span>
<span class="l"><a class="anc" name="d203" href="#d203">[d203]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d204" href="#d204">[d204]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><a class="anc" name="d206" href="#d206">[d206]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store this as our total CHR page count.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set our initial state for compressed block loading.
;
</div><span class="l"><a class="anc" name="d208" href="#d208">[d208]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="d20a" href="#d20a">[d20a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a></span></span><span class="ce">; Set byte offset to 0.</span></span>
<span class="l"><a class="anc" name="d20c" href="#d20c">[d20c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; Set count to 0.</span></span>
<span class="l"><a class="anc" name="d20e" href="#d20e">[d20e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Set bit offset to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d210:@_nextBlock"></a><div class="c">;
; Load the control bits for the block. This will dictate
; how loading will proceed.
;
</div><span class="l"><a class="anc" name="d210" href="#d210">[d210]</a><a href="#:d210:@_nextBlock" class="lla">@_nextBlock:</a><span class="ce">; [$d210]</span></span>
<span class="l"><a class="anc" name="d210" href="#d210">[d210]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d212" href="#d212">[d212]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Begin loading this block.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Shift our block value left by 2 and add load the next two
; compressed bits into those spots.
;
</div><span class="l"><a class="anc" name="d214" href="#d214">[d214]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a></span></span><span class="ce">; Load next bit from compressed data.</span></span>
<span class="l"><a class="anc" name="d217" href="#d217">[d217]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Shift our block to the left 1 and add the bit.</span></span>
<span class="l"><a class="anc" name="d219" href="#d219">[d219]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a></span></span><span class="ce">; Load next bit from compressed data.</span></span>
<span class="l"><a class="anc" name="d21c" href="#d21c">[d21c]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Shift our block to the left 1 and add the bit.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check what bits we just loaded.
;
</div><span class="l"><a class="anc" name="d21e" href="#d21e">[d21e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Load the current block value.</span></span>
<span class="l"><a class="anc" name="d220" href="#d220">[d220]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Check the 2 least-significant bits we loaded.</span></span>
<span class="l"><a class="anc" name="d222" href="#d222">[d222]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = Our loaded bits value</span></span>
<span class="l"><a class="anc" name="d223" href="#d223">[d223]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$03</span></span><span class="ce">; Is the value 3?</span></span>
<span class="l"><a class="anc" name="d225" href="#d225">[d225]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_read8BitBlock">@_read8BitBlock</a></span></span><span class="ce">; If so, start a new block.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Control 0x00, 0x01, or 0x02:
;
; Load the block value stored in the screen buffer at
; the current offset + bitValue-specific offset.
;
</div><span class="l"><a class="anc" name="d227" href="#d227">[d227]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; Else, load our blocks count.</span></span>
<span class="l"><a class="anc" name="d229" href="#d229">[d229]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d22a" href="#d22a">[d22a]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#BLOCK_DATA_OFFSETS_FOR_BIT_VALUES">BLOCK_DATA_OFFSETS_FOR_BIT_VALUES</a>,X</span></span><span class="ce">; Add that to the value for this bit in the lookup table.</span></span>
<span class="l"><a class="anc" name="d22d" href="#d22d">[d22d]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set as X</span></span>
<span class="l"><a class="anc" name="d22e" href="#d22e">[d22e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block value from the screen buffer at the offset for this bit value.</span></span>
<span class="l"><a class="anc" name="d231" href="#d231">[d231]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_storeBlock">@_storeBlock</a></span></span><span class="ce">; Proceed to store the block.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d234:@_read8BitBlock"></a><div class="c">;
; Control 0x03: Read an 8-bit block.
;
</div><span class="l"><a class="anc" name="d234" href="#d234">[d234]</a><a href="#:d234:@_read8BitBlock" class="lla">@_read8BitBlock:</a><span class="ce">; [$d234]</span></span>
<span class="l"><a class="anc" name="d234" href="#d234">[d234]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; X = 8 (total bits)</span></span>
<span class="l"><a class="anc" name="d236" href="#d236">[d236]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (new block value)</span></span>
<span class="l"><a class="anc" name="d238" href="#d238">[d238]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Store that value.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d23a:@_load8BitsOfBlockData"></a><div class="c">;
; Load the block data. We'll load 8 bits worth.
;
; This is essentially going to be the same as the byte
; value, except the bits loaded may span multiple bytes.
;
</div><span class="l"><a class="anc" name="d23a" href="#d23a">[d23a]</a><a href="#:d23a:@_load8BitsOfBlockData" class="lla">@_load8BitsOfBlockData:</a><span class="ce">; [$d23a]</span></span>
<span class="l"><a class="anc" name="d23a" href="#d23a">[d23a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadNextCompressedScreenBit">Area_LoadNextCompressedScreenBit</a></span></span><span class="ce">; Load next bit from compressed data.</span></span>
<span class="l"><a class="anc" name="d23d" href="#d23d">[d23d]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Shift our block to the left 1 and add the bit.</span></span>
<span class="l"><a class="anc" name="d23f" href="#d23f">[d23f]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X-- (total bits)</span></span>
<span class="l"><a class="anc" name="d240" href="#d240">[d240]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_load8BitsOfBlockData">@_load8BitsOfBlockData</a></span></span><span class="ce">; If we're not at 0, loop.</span></span>
<span class="l"><a class="anc" name="d242" href="#d242">[d242]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_LoadedBlockValue">Temp_LoadedBlockValue</a></span></span><span class="ce">; Else, load the resulting block value.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d244:@_storeBlock"></a><div class="c">;
; Store the block value in the screen buffer at the
; current offset.
;
</div><span class="l"><a class="anc" name="d244" href="#d244">[d244]</a><a href="#:d244:@_storeBlock" class="lla">@_storeBlock:</a><span class="ce">; [$d244]</span></span>
<span class="l"><a class="anc" name="d244" href="#d244">[d244]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; X = loaded block count, as our new offset</span></span>
<span class="l"><a class="anc" name="d246" href="#d246">[d246]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store the byte in the screen buffer at that offset.</span></span>
<span class="l"><a class="anc" name="d249" href="#d249">[d249]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_LoadedBlocksCount">Temp_LoadedBlocksCount</a></span></span><span class="ce">; Increment our block count.</span></span>
<span class="l"><a class="anc" name="d24b" href="#d24b">[d24b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_nextBlock">@_nextBlock</a></span></span><span class="ce">; If we haven't loaded 256 blocks, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're done loading the blocks. We now need to
; fill in the last row of 16 blocks with zeroes.
;
</div><span class="l"><a class="anc" name="d24d" href="#d24d">[d24d]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$f0</span></span><span class="ce">; X = 0xF0 (offset into the screen buffer to fill)</span></span>
<span class="l"><a class="anc" name="d24f" href="#d24f">[d24f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (value to store)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d251:@_fillLastLine"></a><div class="c">;
; Fill the last line.
;
</div><span class="l"><a class="anc" name="d251" href="#d251">[d251]</a><a href="#:d251:@_fillLastLine" class="lla">@_fillLastLine:</a><span class="ce">; [$d251]</span></span>
<span class="l"><a class="anc" name="d251" href="#d251">[d251]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store in the screen buffer.</span></span>
<span class="l"><a class="anc" name="d254" href="#d254">[d254]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="d255" href="#d255">[d255]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_fillLastLine">@_fillLastLine</a></span></span><span class="ce">; If we haven't hit 16 blocks (value 256 and wrapped around), then loop.</span></span>
<span class="l"><a class="anc" name="d257" href="#d257">[d257]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_LoadNextCompressedScreenBit"></a><div class="cp">;============================================================================
; Load the next bit from compressed data.
;
; This is used when decompressing screen data. It will
; process a bit at a time and make that result available
; to the caller.
;
; INPUTS:
;     <a href="RAM.html#Temp_07">Temp_07</a>+1:
;         The address of the table of bytes to load from,
;         based on the byte offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a>:
;         The current byte offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a>:
;         The current bit offset within the byte offset.
;
; OUTPUTS:
;     <a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a>:
;         The new byte offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a>:
;         The new bit offset.
;
;     <a href="RAM.html#LoadCompressedScreenData_CurByte">LoadCompressedScreenData_CurByte</a>:
;         The new loaded byte.
;
; XREFS:
;     <a href="#Area_LoadBlocks">Area_LoadBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d258" href="#d258">[d258]</a><a href="#Area_LoadNextCompressedScreenBit" class="la">Area_LoadNextCompressedScreenBit:</a><span class="ce">; [$d258]</span></span>
<span class="l"><a class="anc" name="d258" href="#d258">[d258]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Load the current bit.</span></span>
<span class="l"><a class="anc" name="d25a" href="#d25a">[d25a]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_update">@_update</a></span></span><span class="ce">; Is this 0? If so, branch.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're at the first bit. We need to load the byte we'll be
; working with from RAM as an index into <a href="RAM.html#Temp_07">Temp_07</a>+1.
;
</div><span class="l"><a class="anc" name="d25c" href="#d25c">[d25c]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a></span></span><span class="ce">; Get the offset of the byte we'll be processing.</span></span>
<span class="l"><a class="anc" name="d25e" href="#d25e">[d25e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Load the next byte.</span></span>
<span class="l"><a class="anc" name="d260" href="#d260">[d260]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_CurByte">LoadCompressedScreenData_CurByte</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d262:@_update"></a><div class="c">;
; Shift the current byte left by 1 and increment the bit
; offset by 1, for comparison.
;
</div><span class="l"><a class="anc" name="d262" href="#d262">[d262]</a><a href="#:d262:@_update" class="lla">@_update:</a><span class="ce">; [$d262]</span></span>
<span class="l"><a class="anc" name="d262" href="#d262">[d262]</a><span class="cd"><span class="i">ASL</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_CurByte">LoadCompressedScreenData_CurByte</a></span></span><span class="ce">; Shift the current byte we're processing.</span></span>
<span class="l"><a class="anc" name="d264" href="#d264">[d264]</a><span class="cd"><span class="i">PHP</span></span><span class="ce">; Save all flags.</span></span>
<span class="l"><a class="anc" name="d265" href="#d265">[d265]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Increment the next bit in the byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; See if the lower 3 bits are cleared. If so, we need to
; advance the byte offset and reset the bit offset.
;
</div><span class="l"><a class="anc" name="d267" href="#d267">[d267]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Check if we've hit the last bit in the byte.</span></span>
<span class="l"><a class="anc" name="d269" href="#d269">[d269]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="d26b" href="#d26b">[d26b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If we have any data in bits 1-3...</span></span>
<span class="l"><a class="anc" name="d26d" href="#d26d">[d26d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_BitOffset">LoadCompressedScreenData_BitOffset</a></span></span><span class="ce">; Reset the current bit to 0.</span></span>
<span class="l"><a class="anc" name="d26f" href="#d26f">[d26f]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#LoadCompressedScreenData_ByteOffset">LoadCompressedScreenData_ByteOffset</a></span></span><span class="ce">; Increase the byte offset.</span></span>
<span class="l"></span>
<a name=":d271:@_return"></a><span class="l"><a class="anc" name="d271" href="#d271">[d271]</a><a href="#:d271:@_return" class="lla">@_return:</a><span class="ce">; [$d271]</span></span>
<span class="l"><a class="anc" name="d271" href="#d271">[d271]</a><span class="cd"><span class="i">PLP</span></span><span class="ce">; Restore all flags.</span></span>
<span class="l"><a class="anc" name="d272" href="#d272">[d272]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BLOCK_DATA_OFFSETS_FOR_BIT_VALUES"></a><div class="c">;
; XREFS:
;     <a href="#Area_LoadBlocks">Area_LoadBlocks</a>
;
</div><span class="l"><a class="anc" name="d273" href="#d273">[d273]</a><a href="#BLOCK_DATA_OFFSETS_FOR_BIT_VALUES" class="la">BLOCK_DATA_OFFSETS_FOR_BIT_VALUES:</a><span class="ce">; [$d273]</span></span>
<span class="l"><a class="anc" name="d273" href="#d273">[d273]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d274" href="#d274">[d274]</a><span class="cd"><span class="i">db</span> <span class="o">$f0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d275" href="#d275">[d275]</a><span class="cd"><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_LoadBlockProperties"></a><div class="cp">;============================================================================
; Load block properties from Bank 3 into RAM.
;
; This will loop through all block properties for the
; current area, loading it into a table in RAM.
;
; Each pair of bytes in the block properties come
; together as the two nibbles for a new byte. The
; first byte represents the lower nibble, and the
; second byte's value is shifted into the upper nibble.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank to save and restore.
;
;     <a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a>:
;         The address of the current area's block
;         properties data.
;
; OUTPUTS:
;     <a href="RAM.html#BlockProperties">BlockProperties</a>:
;         The block properties in RAM to update.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Screen_StopScrollAndLoadBlockProperties">Screen_StopScrollAndLoadBlockProperties</a>
;============================================================================
</div><span class="l"><a class="anc" name="d276" href="#d276">[d276]</a><a href="#Area_LoadBlockProperties" class="la">Area_LoadBlockProperties:</a><span class="ce">; [$d276]</span></span>
<div class="c">;
; Switch to bank 3, where the level data is stored.
;
</div><span class="l"><a class="anc" name="d276" href="#d276">[d276]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d279" href="#d279">[d279]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d27a" href="#d27a">[d27a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d27c" href="#d27c">[d27c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare for the read loop.
;
</div><span class="l"><a class="anc" name="d27f" href="#d27f">[d27f]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="d281" href="#d281">[d281]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d283:@_nextBlockProperty"></a><div class="c">;
; Load the lower nibble from the block properties.
;
</div><span class="l"><a class="anc" name="d283" href="#d283">[d283]</a><a href="#:d283:@_nextBlockProperty" class="lla">@_nextBlockProperty:</a><span class="ce">; [$d283]</span></span>
<span class="l"><a class="anc" name="d283" href="#d283">[d283]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a>),Y</span></span><span class="ce">; A = block property in the current area at offset Y.</span></span>
<span class="l"><a class="anc" name="d285" href="#d285">[d285]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Retain the lower nibble.</span></span>
<span class="l"><a class="anc" name="d287" href="#d287">[d287]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store that for later lookup.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the next block property as the upper nibble.
;
</div><span class="l"><a class="anc" name="d289" href="#d289">[d289]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Increment the index in the block properties table.;</span></span>
<span class="l"><a class="anc" name="d28a" href="#d28a">[d28a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a>),Y</span></span><span class="ce">; Load it into A.</span></span>
<span class="l"><a class="anc" name="d28c" href="#d28c">[d28c]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Move the lower nibble to the upper nibble.</span></span>
<span class="l"><a class="anc" name="d28d" href="#d28d">[d28d]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d28e" href="#d28e">[d28e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d28f" href="#d28f">[d28f]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Combine the two nibbles for the new value and store it in
; BlockProperties.
;
</div><span class="l"><a class="anc" name="d290" href="#d290">[d290]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; OR it to the lower nibble we saved.</span></span>
<span class="l"><a class="anc" name="d292" href="#d292">[d292]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BlockProperties">BlockProperties</a>,X</span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Keep going while the index is positive.
;
</div><span class="l"><a class="anc" name="d295" href="#d295">[d295]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y = Y + 1</span></span>
<span class="l"><a class="anc" name="d296" href="#d296">[d296]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"><a class="anc" name="d297" href="#d297">[d297]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_nextBlockProperty">@_nextBlockProperty</a></span></span><span class="ce">; If we haven't overflowed, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're done. Switch back to our previous bank.
;
</div><span class="l"><a class="anc" name="d299" href="#d299">[d299]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull our saved bank.</span></span>
<span class="l"><a class="anc" name="d29a" href="#d29a">[d29a]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set to X and...</span></span>
<span class="l"><a class="anc" name="d29b" href="#d29b">[d29b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch banks.</span></span>
<span class="l"><a class="anc" name="d29e" href="#d29e">[d29e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Screen_StopScrollAndLoadBlockProperties"></a><div class="cp">;============================================================================
; TODO: Document Screen_StopScrollAndLoadBlockProperties
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_HandleScrollDown">Screen_HandleScrollDown</a>
;     <a href="#Screen_HandleScrollLeft">Screen_HandleScrollLeft</a>
;     <a href="#Screen_HandleScrollRight">Screen_HandleScrollRight</a>
;     <a href="#Screen_HandleScrollUp">Screen_HandleScrollUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="d29f" href="#d29f">[d29f]</a><a href="#Screen_StopScrollAndLoadBlockProperties" class="la">Screen_StopScrollAndLoadBlockProperties:</a><span class="ce">; [$d29f]</span></span>
<span class="l"><a class="anc" name="d29f" href="#d29f">[d29f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="d2a1" href="#d2a1">[d2a1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="d2a3" href="#d2a3">[d2a3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Area_LoadBlockProperties">Area_LoadBlockProperties</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Screen_HandleScrollUp"></a><div class="cp">;============================================================================
; TODO: Document Screen_HandleScrollUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_HandleScroll">Screen_HandleScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="d2a6" href="#d2a6">[d2a6]</a><a href="#Screen_HandleScrollUp" class="la">Screen_HandleScrollUp:</a><span class="ce">; [$d2a6]</span></span>
<span class="l"><a class="anc" name="d2a6" href="#d2a6">[d2a6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d2a8" href="#d2a8">[d2a8]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d2ac">@LAB_PRG15_MIRROR__d2ac</a></span></span></span>
<span class="l"><a class="anc" name="d2aa" href="#d2aa">[d2aa]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$d0</span></span></span>
<span class="l"></span>
<a name=":d2ac:@LAB_PRG15_MIRROR__d2ac"></a><span class="l"><a class="anc" name="d2ac" href="#d2ac">[d2ac]</a><a href="#:d2ac:@LAB_PRG15_MIRROR__d2ac" class="lla">@LAB_PRG15_MIRROR__d2ac:</a><span class="ce">; [$d2ac]</span></span>
<span class="l"><a class="anc" name="d2ac" href="#d2ac">[d2ac]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="d2ad" href="#d2ad">[d2ad]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d2af" href="#d2af">[d2af]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d2b1" href="#d2b1">[d2b1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d2b8">@LAB_PRG15_MIRROR__d2b8</a></span></span></span>
<span class="l"><a class="anc" name="d2b3" href="#d2b3">[d2b3]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span></span>
<span class="l"><a class="anc" name="d2b5" href="#d2b5">[d2b5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_StopScrollAndLoadBlockProperties">Screen_StopScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<a name=":d2b8:@LAB_PRG15_MIRROR__d2b8"></a><span class="l"><a class="anc" name="d2b8" href="#d2b8">[d2b8]</a><a href="#:d2b8:@LAB_PRG15_MIRROR__d2b8" class="lla">@LAB_PRG15_MIRROR__d2b8:</a><span class="ce">; [$d2b8]</span></span>
<span class="l"><a class="anc" name="d2b8" href="#d2b8">[d2b8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d2ba" href="#d2ba">[d2ba]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d2bc" href="#d2bc">[d2bc]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d2bf" href="#d2bf">[d2bf]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d2c0" href="#d2c0">[d2c0]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d2c2" href="#d2c2">[d2c2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d2c5" href="#d2c5">[d2c5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadDataUp">Screen_LoadDataUp</a></span></span></span>
<span class="l"><a class="anc" name="d2c8" href="#d2c8">[d2c8]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d2c9" href="#d2c9">[d2c9]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d2ca" href="#d2ca">[d2ca]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d2cd" href="#d2cd">[d2cd]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Screen_UpdateForScroll"></a><div class="cp">;============================================================================
; TODO: Document Screen_UpdateForScroll
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_UpdateForScroll">Game_UpdateForScroll</a>
;     <a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="d2ce" href="#d2ce">[d2ce]</a><a href="#Screen_UpdateForScroll" class="la">Screen_UpdateForScroll:</a><span class="ce">; [$d2ce]</span></span>
<span class="l"><a class="anc" name="d2ce" href="#d2ce">[d2ce]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_UpdatePlayerOnScroll">Game_UpdatePlayerOnScroll</a></span></span><span class="ce">; Update the player position during scroll.</span></span>
<span class="l"><a class="anc" name="d2d1" href="#d2d1">[d2d1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_HandleScroll">Screen_HandleScroll</a></span></span><span class="ce">; Update the screen state/tiles on scroll.</span></span>
<span class="l"><a class="anc" name="d2d4" href="#d2d4">[d2d4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_RunWriteScrollDataHandler">Screen_RunWriteScrollDataHandler</a></span></span><span class="ce">; Write data to the PPU based on the scroll direction.</span></span>
<span class="l"><a class="anc" name="d2d7" href="#d2d7">[d2d7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span><span class="ce">; Load the scroll direction.</span></span>
<span class="l"><a class="anc" name="d2d9" href="#d2d9">[d2d9]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it left or right?</span></span>
<span class="l"><a class="anc" name="d2db" href="#d2db">[d2db]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_isLeftOrRight">@_isLeftOrRight</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The screen is scrolling up, down, or not at all.
;
</div><span class="l"><a class="anc" name="d2dd" href="#d2dd">[d2dd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span><span class="ce">; Load the scroll X delta.</span></span>
<span class="l"><a class="anc" name="d2df" href="#d2df">[d2df]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a></span></span><span class="ce">; If it's not 0, loop.</span></span>
<span class="l"><a class="anc" name="d2e1" href="#d2e1">[d2e1]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d2e2:@_isLeftOrRight"></a><div class="c">;
; The screen is scrolling left or right.
;
</div><span class="l"><a class="anc" name="d2e2" href="#d2e2">[d2e2]</a><a href="#:d2e2:@_isLeftOrRight" class="lla">@_isLeftOrRight:</a><span class="ce">; [$d2e2]</span></span>
<span class="l"><a class="anc" name="d2e2" href="#d2e2">[d2e2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span><span class="ce">; Load the scroll Y delta.</span></span>
<span class="l"><a class="anc" name="d2e4" href="#d2e4">[d2e4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a></span></span><span class="ce">; If it's not 0, loop.</span></span>
<span class="l"></span>
<a name="RETURN_D2E6"></a><div class="c">;
; XREFS:
;     <a href="#Screen_HandleScroll">Screen_HandleScroll</a>
;
</div><span class="l"><a class="anc" name="d2e6" href="#d2e6">[d2e6]</a><a href="#RETURN_D2E6" class="la">RETURN_D2E6:</a><span class="ce">; [$d2e6]</span></span>
<span class="l"><a class="anc" name="d2e6" href="#d2e6">[d2e6]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
</pre><pre><a name="Screen_HandleScroll"></a><div class="cp">;============================================================================
; TODO: Document Screen_HandleScroll
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ScrollScreenRight">Area_ScrollScreenRight</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="d2e7" href="#d2e7">[d2e7]</a><a href="#Screen_HandleScroll" class="la">Screen_HandleScroll:</a><span class="ce">; [$d2e7]</span></span>
<span class="l"><a class="anc" name="d2e7" href="#d2e7">[d2e7]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="d2e9" href="#d2e9">[d2e9]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_HandleScrollLeft">Screen_HandleScrollLeft</a></span></span></span>
<span class="l"><a class="anc" name="d2eb" href="#d2eb">[d2eb]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="d2ec" href="#d2ec">[d2ec]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_HandleScrollRight">Screen_HandleScrollRight</a></span></span></span>
<span class="l"><a class="anc" name="d2ee" href="#d2ee">[d2ee]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="d2ef" href="#d2ef">[d2ef]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_HandleScrollUp">Screen_HandleScrollUp</a></span></span></span>
<span class="l"><a class="anc" name="d2f1" href="#d2f1">[d2f1]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="d2f2" href="#d2f2">[d2f2]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_D2E6">RETURN_D2E6</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><a name="Screen_HandleScrollDown"></a><div class="cp">;============================================================================
; TODO: Document Screen_HandleScrollDown
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;============================================================================
</div><span class="l"><a class="anc" name="d2f4" href="#d2f4">[d2f4]</a><a href="#Screen_HandleScrollDown" class="la">Screen_HandleScrollDown:</a><span class="ce">; [$d2f4]</span></span>
<div class="c">;
; The screen is scrolling down.
;
</div><span class="l"><a class="anc" name="d2f4" href="#d2f4">[d2f4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d2f6" href="#d2f6">[d2f6]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d2f7" href="#d2f7">[d2f7]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d2f9" href="#d2f9">[d2f9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d2fb" href="#d2fb">[d2fb]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$d0</span></span></span>
<span class="l"><a class="anc" name="d2fd" href="#d2fd">[d2fd]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d308">@LAB_PRG15_MIRROR__d308</a></span></span></span>
<span class="l"><a class="anc" name="d2ff" href="#d2ff">[d2ff]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d301" href="#d301">[d301]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d303" href="#d303">[d303]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span></span>
<span class="l"><a class="anc" name="d305" href="#d305">[d305]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_StopScrollAndLoadBlockProperties">Screen_StopScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<a name=":d308:@LAB_PRG15_MIRROR__d308"></a><span class="l"><a class="anc" name="d308" href="#d308">[d308]</a><a href="#:d308:@LAB_PRG15_MIRROR__d308" class="lla">@LAB_PRG15_MIRROR__d308:</a><span class="ce">; [$d308]</span></span>
<span class="l"><a class="anc" name="d308" href="#d308">[d308]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollY">PPU_ScrollY</a></span></span></span>
<span class="l"><a class="anc" name="d30a" href="#d30a">[d30a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d30c" href="#d30c">[d30c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d30f" href="#d30f">[d30f]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d310" href="#d310">[d310]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d312" href="#d312">[d312]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d315" href="#d315">[d315]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadBlocksDown">Screen_LoadBlocksDown</a></span></span></span>
<span class="l"><a class="anc" name="d318" href="#d318">[d318]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d319" href="#d319">[d319]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d31a" href="#d31a">[d31a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d31d" href="#d31d">[d31d]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Screen_HandleScrollRight"></a><div class="cp">;============================================================================
; TODO: Document Screen_HandleScrollRight
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_HandleScroll">Screen_HandleScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="d31e" href="#d31e">[d31e]</a><a href="#Screen_HandleScrollRight" class="la">Screen_HandleScrollRight:</a><span class="ce">; [$d31e]</span></span>
<div class="c">;
; The screen is scrolling right.
;
</div><span class="l"><a class="anc" name="d31e" href="#d31e">[d31e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d320" href="#d320">[d320]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d321" href="#d321">[d321]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d323" href="#d323">[d323]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d325" href="#d325">[d325]</a><span class="cd"><span class="i">PHP</span></span></span>
<span class="l"><a class="anc" name="d326" href="#d326">[d326]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d328" href="#d328">[d328]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d32a" href="#d32a">[d32a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d32c" href="#d32c">[d32c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d32e" href="#d32e">[d32e]</a><span class="cd"><span class="i">PLP</span></span></span>
<span class="l"><a class="anc" name="d32f" href="#d32f">[d32f]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d334">@LAB_PRG15_MIRROR__d334</a></span></span></span>
<span class="l"><a class="anc" name="d331" href="#d331">[d331]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_StopScrollAndLoadBlockProperties">Screen_StopScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<a name=":d334:@LAB_PRG15_MIRROR__d334"></a><span class="l"><a class="anc" name="d334" href="#d334">[d334]</a><a href="#:d334:@LAB_PRG15_MIRROR__d334" class="lla">@LAB_PRG15_MIRROR__d334:</a><span class="ce">; [$d334]</span></span>
<span class="l"><a class="anc" name="d334" href="#d334">[d334]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d336" href="#d336">[d336]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d338" href="#d338">[d338]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d33b" href="#d33b">[d33b]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d33c" href="#d33c">[d33c]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d33e" href="#d33e">[d33e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d341" href="#d341">[d341]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadDataRight">Screen_LoadDataRight</a></span></span></span>
<span class="l"><a class="anc" name="d344" href="#d344">[d344]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d345" href="#d345">[d345]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d346" href="#d346">[d346]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d349" href="#d349">[d349]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Screen_HandleScrollLeft"></a><div class="cp">;============================================================================
; TODO: Document Screen_HandleScrollLeft
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_HandleScroll">Screen_HandleScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="d34a" href="#d34a">[d34a]</a><a href="#Screen_HandleScrollLeft" class="la">Screen_HandleScrollLeft:</a><span class="ce">; [$d34a]</span></span>
<div class="c">;
; The screen is scrolling left.
;
</div><span class="l"><a class="anc" name="d34a" href="#d34a">[d34a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d34c" href="#d34c">[d34c]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fc</span></span></span>
<span class="l"><a class="anc" name="d34e" href="#d34e">[d34e]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d364">@LAB_PRG15_MIRROR__d364</a></span></span></span>
<span class="l"><a class="anc" name="d350" href="#d350">[d350]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d352" href="#d352">[d352]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="d353" href="#d353">[d353]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d355" href="#d355">[d355]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d357" href="#d357">[d357]</a><span class="cd"><span class="i">PHP</span></span></span>
<span class="l"><a class="anc" name="d358" href="#d358">[d358]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d35a" href="#d35a">[d35a]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d35c" href="#d35c">[d35c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d35e" href="#d35e">[d35e]</a><span class="cd"><span class="i">PLP</span></span></span>
<span class="l"><a class="anc" name="d35f" href="#d35f">[d35f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d364">@LAB_PRG15_MIRROR__d364</a></span></span></span>
<span class="l"><a class="anc" name="d361" href="#d361">[d361]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_StopScrollAndLoadBlockProperties">Screen_StopScrollAndLoadBlockProperties</a></span></span></span>
<span class="l"></span>
<a name=":d364:@LAB_PRG15_MIRROR__d364"></a><span class="l"><a class="anc" name="d364" href="#d364">[d364]</a><a href="#:d364:@LAB_PRG15_MIRROR__d364" class="lla">@LAB_PRG15_MIRROR__d364:</a><span class="ce">; [$d364]</span></span>
<span class="l"><a class="anc" name="d364" href="#d364">[d364]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d366" href="#d366">[d366]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="d367" href="#d367">[d367]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d369" href="#d369">[d369]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d36b" href="#d36b">[d36b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d36d" href="#d36d">[d36d]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d36f" href="#d36f">[d36f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d371" href="#d371">[d371]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d373" href="#d373">[d373]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_finish">@_finish</a></span></span></span>
<span class="l"><a class="anc" name="d375" href="#d375">[d375]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span></span>
<span class="l"><a class="anc" name="d377" href="#d377">[d377]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="d379" href="#d379">[d379]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_finish">@_finish</a></span></span></span>
<span class="l"><a class="anc" name="d37b" href="#d37b">[d37b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":d37c:@_finish"></a><span class="l"><a class="anc" name="d37c" href="#d37c">[d37c]</a><a href="#:d37c:@_finish" class="lla">@_finish:</a><span class="ce">; [$d37c]</span></span>
<span class="l"><a class="anc" name="d37c" href="#d37c">[d37c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d37f" href="#d37f">[d37f]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d380" href="#d380">[d380]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d382" href="#d382">[d382]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d385" href="#d385">[d385]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadDataLeft">Screen_LoadDataLeft</a></span></span></span>
<span class="l"><a class="anc" name="d388" href="#d388">[d388]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d389" href="#d389">[d389]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d38a" href="#d38a">[d38a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d38d" href="#d38d">[d38d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadAttrsVert"></a><div class="cp">;============================================================================
; Load block attributes when scrolling vertically.
;
; This sets the loading mode to load attributes, and then
; load a round of blocks vertically.
;
; INPUTS:
;     X:
;         0 = Load blocks to the top.
;         1 = Load blocks to the bottom.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a>:
;         The mode set to loading attributes.
;
; CALLS:
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;
; XREFS:
;     <a href="#Screen_LoadBlocksDown">Screen_LoadBlocksDown</a>
;     <a href="#Screen_LoadDataUp">Screen_LoadDataUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="d38e" href="#d38e">[d38e]</a><a href="#Screen_LoadAttrsVert" class="la">Screen_LoadAttrsVert:</a><span class="ce">; [$d38e]</span></span>
<span class="l"><a class="anc" name="d38e" href="#d38e">[d38e]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span><span class="ce">; Set load mode to 1 (load attributes)</span></span>
<span class="l"><a class="anc" name="d390" href="#d390">[d390]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a></span></span><span class="ce">; Load the data.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadDataUp"></a><div class="cp">;============================================================================
; Load screen data for the screen above.
;
; Every 8 counts (7, 15, 23, ...), this will load
; attribute data.
;
; Every 8 counts (3, 11, 19, ...), this will load
; tile data.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a>:
;         The load counter for blocks.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Screen_LoadAttrsVert">Screen_LoadAttrsVert</a>
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;
; XREFS:
;     <a href="#Screen_HandleScrollUp">Screen_HandleScrollUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="d393" href="#d393">[d393]</a><a href="#Screen_LoadDataUp" class="la">Screen_LoadDataUp:</a><span class="ce">; [$d393]</span></span>
<span class="l"><a class="anc" name="d393" href="#d393">[d393]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; 0 = Load Tiles mode</span></span>
<span class="l"><a class="anc" name="d395" href="#d395">[d395]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span><span class="ce">; Set as the default mode.</span></span>
<span class="l"><a class="anc" name="d397" href="#d397">[d397]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span><span class="ce">; A = Vertical blocks counter</span></span>
<span class="l"><a class="anc" name="d399" href="#d399">[d399]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Keep the lower nibble.</span></span>
<span class="l"><a class="anc" name="d39b" href="#d39b">[d39b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Is it 7 (every 8 blocks, starting at 7)?</span></span>
<span class="l"><a class="anc" name="d39d" href="#d39d">[d39d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadAttrsVert">Screen_LoadAttrsVert</a></span></span><span class="ce">; If so, load attributes.</span></span>
<span class="l"><a class="anc" name="d39f" href="#d39f">[d39f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Else, keep the lower 3 bits.</span></span>
<span class="l"><a class="anc" name="d3a1" href="#d3a1">[d3a1]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Is it 3 (every 8 blocks, starting at 3)?</span></span>
<span class="l"><a class="anc" name="d3a3" href="#d3a3">[d3a3]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a></span></span><span class="ce">; If so, load tiles.</span></span>
<span class="l"><a class="anc" name="d3a5" href="#d3a5">[d3a5]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadBlocksDown"></a><div class="cp">;============================================================================
; Load screen data for the screen below.
;
; Every 16 counts (8, 24, 40, ...), this will load
; attribute data.
;
; Every 8 counts (4, 12, 20, ...), this will load
; tile data.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a>:
;         The load counter for blocks.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Screen_LoadAttrsVert">Screen_LoadAttrsVert</a>
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;
; XREFS:
;     <a href="#Screen_HandleScrollDown">Screen_HandleScrollDown</a>
;============================================================================
</div><span class="l"><a class="anc" name="d3a6" href="#d3a6">[d3a6]</a><a href="#Screen_LoadBlocksDown" class="la">Screen_LoadBlocksDown:</a><span class="ce">; [$d3a6]</span></span>
<span class="l"><a class="anc" name="d3a6" href="#d3a6">[d3a6]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; 0 = Load Tiles mode</span></span>
<span class="l"><a class="anc" name="d3a8" href="#d3a8">[d3a8]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span><span class="ce">; Set as the default mode.</span></span>
<span class="l"><a class="anc" name="d3aa" href="#d3aa">[d3aa]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (reuse as "is down" flag, set to 1).</span></span>
<span class="l"><a class="anc" name="d3ab" href="#d3ab">[d3ab]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span><span class="ce">; A = Vertical blocks counter</span></span>
<span class="l"><a class="anc" name="d3ad" href="#d3ad">[d3ad]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Keep the lower nibble.</span></span>
<span class="l"><a class="anc" name="d3af" href="#d3af">[d3af]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it 8 (every 16 blocks, starting at 8)?</span></span>
<span class="l"><a class="anc" name="d3b1" href="#d3b1">[d3b1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadAttrsVert">Screen_LoadAttrsVert</a></span></span><span class="ce">; If so, load attributes.</span></span>
<span class="l"><a class="anc" name="d3b3" href="#d3b3">[d3b3]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Else, keep the lower 3 bits.</span></span>
<span class="l"><a class="anc" name="d3b5" href="#d3b5">[d3b5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it 4 (every 8 blocks, starting at 4)?</span></span>
<span class="l"><a class="anc" name="d3b7" href="#d3b7">[d3b7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a></span></span><span class="ce">; If so, load tiles.</span></span>
<span class="l"><a class="anc" name="d3b9" href="#d3b9">[d3b9]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadBlockDataVert"></a><div class="cp">;============================================================================
; TODO
;
; direction:
;     1 = up
;     0 = down
;
; XREFS:
;     <a href="#Screen_LoadAttrsVert">Screen_LoadAttrsVert</a>
;     <a href="#Screen_LoadBlocksDown">Screen_LoadBlocksDown</a>
;     <a href="#Screen_LoadDataUp">Screen_LoadDataUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="d3ba" href="#d3ba">[d3ba]</a><a href="#Screen_LoadBlockDataVert" class="la">Screen_LoadBlockDataVert:</a><span class="ce">; [$d3ba]</span></span>
<span class="l"><a class="anc" name="d3ba" href="#d3ba">[d3ba]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d3bc" href="#d3bc">[d3bc]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d3bd" href="#d3bd">[d3bd]</a><span class="cd"><span class="i">ADC</span> <span class="o">$d4cb,X</span></span></span>
<span class="l"><a class="anc" name="d3c0" href="#d3c0">[d3c0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d3c2" href="#d3c2">[d3c2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span></span>
<span class="l"><a class="anc" name="d3c4" href="#d3c4">[d3c4]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d3c6" href="#d3c6">[d3c6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Blocks_0049">Unused_Blocks_0049</a></span></span></span>
<span class="l"><a class="anc" name="d3c8" href="#d3c8">[d3c8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="d3ca" href="#d3ca">[d3ca]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MaybeUnused_006d">MaybeUnused_006d</a></span></span></span>
<span class="l"><a class="anc" name="d3cc" href="#d3cc">[d3cc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d3ce" href="#d3ce">[d3ce]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="d3d0" href="#d3d0">[d3d0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Blocks_0048">Temp_Blocks_0048</a></span></span></span>
<span class="l"><a class="anc" name="d3d2" href="#d3d2">[d3d2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d3d4" href="#d3d4">[d3d4]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d3d5" href="#d3d5">[d3d5]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Blocks_0048">Temp_Blocks_0048</a></span></span></span>
<span class="l"><a class="anc" name="d3d7" href="#d3d7">[d3d7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><a class="anc" name="d3d9" href="#d3d9">[d3d9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="d3db" href="#d3db">[d3db]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d3dd" href="#d3dd">[d3dd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d3df" href="#d3df">[d3df]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span></span>
<span class="l"><a class="anc" name="d3e1" href="#d3e1">[d3e1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d3e6">@LAB_PRG15_MIRROR__d3e6</a></span></span></span>
<span class="l"><a class="anc" name="d3e3" href="#d3e3">[d3e3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d445">@LAB_PRG15_MIRROR__d445</a></span></span></span>
<span class="l"></span>
<a name=":d3e6:@LAB_PRG15_MIRROR__d3e6"></a><span class="l"><a class="anc" name="d3e6" href="#d3e6">[d3e6]</a><a href="#:d3e6:@LAB_PRG15_MIRROR__d3e6" class="lla">@LAB_PRG15_MIRROR__d3e6:</a><span class="ce">; [$d3e6]</span></span>
<span class="l"><a class="anc" name="d3e6" href="#d3e6">[d3e6]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d3e8" href="#d3e8">[d3e8]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d3ea:@LAB_PRG15_MIRROR__d3ea"></a><span class="l"><a class="anc" name="d3ea" href="#d3ea">[d3ea]</a><a href="#:d3ea:@LAB_PRG15_MIRROR__d3ea" class="lla">@LAB_PRG15_MIRROR__d3ea:</a><span class="ce">; [$d3ea]</span></span>
<span class="l"><a class="anc" name="d3ea" href="#d3ea">[d3ea]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d3ec" href="#d3ec">[d3ec]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d3ee" href="#d3ee">[d3ee]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d3ef" href="#d3ef">[d3ef]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d3f1" href="#d3f1">[d3f1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d3f3" href="#d3f3">[d3f3]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d3f5" href="#d3f5">[d3f5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d3f7" href="#d3f7">[d3f7]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d3f9" href="#d3f9">[d3f9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData3CurAddr">CurrentArea_BlockData3CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d3fb" href="#d3fb">[d3fb]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d3fd" href="#d3fd">[d3fd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData4CurAddr">CurrentArea_BlockData4CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d3ff" href="#d3ff">[d3ff]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d401" href="#d401">[d401]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="d403" href="#d403">[d403]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d404" href="#d404">[d404]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d405" href="#d405">[d405]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d406" href="#d406">[d406]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d409" href="#d409">[d409]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#DataArray">DataArray</a>,X</span></span></span>
<span class="l"><a class="anc" name="d40c" href="#d40c">[d40c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d40f" href="#d40f">[d40f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#DataArray">DataArray</a>+1,X</span></span></span>
<span class="l"><a class="anc" name="d412" href="#d412">[d412]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d413" href="#d413">[d413]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d414" href="#d414">[d414]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d416" href="#d416">[d416]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d417" href="#d417">[d417]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d419" href="#d419">[d419]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d3ea">@LAB_PRG15_MIRROR__d3ea</a></span></span></span>
<span class="l"><a class="anc" name="d41b" href="#d41b">[d41b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d41d" href="#d41d">[d41d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d41f" href="#d41f">[d41f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d421" href="#d421">[d421]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f8</span></span></span>
<span class="l"><a class="anc" name="d423" href="#d423">[d423]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d424" href="#d424">[d424]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d426" href="#d426">[d426]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d427" href="#d427">[d427]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d429" href="#d429">[d429]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d42a" href="#d42a">[d42a]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="d42c" href="#d42c">[d42c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_L">Screen_ScrollVertBlocks_PPUTileMapAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d42e" href="#d42e">[d42e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d430" href="#d430">[d430]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d432" href="#d432">[d432]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d434" href="#d434">[d434]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d436" href="#d436">[d436]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d438" href="#d438">[d438]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d439" href="#d439">[d439]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d43a" href="#d43a">[d43a]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="d43c" href="#d43c">[d43c]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d43e" href="#d43e">[d43e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d440" href="#d440">[d440]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d442" href="#d442">[d442]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_NeighborBlocksLoadedByDirection">Screen_NeighborBlocksLoadedByDirection</a></span></span></span>
<span class="l"><a class="anc" name="d444" href="#d444">[d444]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":d445:@LAB_PRG15_MIRROR__d445"></a><span class="l"><a class="anc" name="d445" href="#d445">[d445]</a><a href="#:d445:@LAB_PRG15_MIRROR__d445" class="lla">@LAB_PRG15_MIRROR__d445:</a><span class="ce">; [$d445]</span></span>
<span class="l"><a class="anc" name="d445" href="#d445">[d445]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d447" href="#d447">[d447]</a><span class="cd"><span class="i">AND</span> <span class="o">#$16</span></span></span>
<span class="l"><a class="anc" name="d449" href="#d449">[d449]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d44a" href="#d44a">[d44a]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d44b" href="#d44b">[d44b]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d44c" href="#d44c">[d44c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="d44e" href="#d44e">[d44e]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$f8</span></span></span>
<span class="l"><a class="anc" name="d450" href="#d450">[d450]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d452:@LAB_PRG15_MIRROR__d452"></a><span class="l"><a class="anc" name="d452" href="#d452">[d452]</a><a href="#:d452:@LAB_PRG15_MIRROR__d452" class="lla">@LAB_PRG15_MIRROR__d452:</a><span class="ce">; [$d452]</span></span>
<span class="l"><a class="anc" name="d452" href="#d452">[d452]</a><span class="cd"><span class="i">STA</span> <span class="o">$0192,Y</span></span></span>
<span class="l"><a class="anc" name="d455" href="#d455">[d455]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d456" href="#d456">[d456]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d452">@LAB_PRG15_MIRROR__d452</a></span></span></span>
<span class="l"></span>
<a name=":d458:@LAB_PRG15_MIRROR__d458"></a><span class="l"><a class="anc" name="d458" href="#d458">[d458]</a><a href="#:d458:@LAB_PRG15_MIRROR__d458" class="lla">@LAB_PRG15_MIRROR__d458:</a><span class="ce">; [$d458]</span></span>
<span class="l"><a class="anc" name="d458" href="#d458">[d458]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d45a" href="#d45a">[d45a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d45c" href="#d45c">[d45c]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d45d" href="#d45d">[d45d]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d45f" href="#d45f">[d45f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d461" href="#d461">[d461]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d463" href="#d463">[d463]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d465" href="#d465">[d465]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="d467" href="#d467">[d467]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d468" href="#d468">[d468]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d46a" href="#d46a">[d46a]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="#BLOCK_ATTRS_BITMASKS">BLOCK_ATTRS_BITMASKS</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d46d" href="#d46d">[d46d]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d46e" href="#d46e">[d46e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d470" href="#d470">[d470]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d471" href="#d471">[d471]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d472" href="#d472">[d472]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d473" href="#d473">[d473]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertPPUAttrData">Screen_ScrollVertPPUAttrData</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d476" href="#d476">[d476]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertPPUAttrData">Screen_ScrollVertPPUAttrData</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d479" href="#d479">[d479]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d47b" href="#d47b">[d47b]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d47c" href="#d47c">[d47c]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d47e" href="#d47e">[d47e]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d458">@LAB_PRG15_MIRROR__d458</a></span></span></span>
<span class="l"><a class="anc" name="d480" href="#d480">[d480]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="d482" href="#d482">[d482]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d484" href="#d484">[d484]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d486" href="#d486">[d486]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d48a">@LAB_PRG15_MIRROR__d48a</a></span></span></span>
<span class="l"><a class="anc" name="d488" href="#d488">[d488]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0f</span></span></span>
<span class="l"></span>
<a name=":d48a:@LAB_PRG15_MIRROR__d48a"></a><span class="l"><a class="anc" name="d48a" href="#d48a">[d48a]</a><a href="#:d48a:@LAB_PRG15_MIRROR__d48a" class="lla">@LAB_PRG15_MIRROR__d48a:</a><span class="ce">; [$d48a]</span></span>
<span class="l"><a class="anc" name="d48a" href="#d48a">[d48a]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d48c" href="#d48c">[d48c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertLoadCounter">Screen_ScrollVertLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d48e" href="#d48e">[d48e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$e0</span></span></span>
<span class="l"><a class="anc" name="d490" href="#d490">[d490]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d491" href="#d491">[d491]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d492" href="#d492">[d492]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d494" href="#d494">[d494]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d495" href="#d495">[d495]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="d497" href="#d497">[d497]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d498" href="#d498">[d498]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d499" href="#d499">[d499]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="d49b" href="#d49b">[d49b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUAttrAddr_L">Screen_ScrollVertBlocks_PPUAttrAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d49d" href="#d49d">[d49d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d49f" href="#d49f">[d49f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d4a1" href="#d4a1">[d4a1]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d4a2" href="#d4a2">[d4a2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d4a3" href="#d4a3">[d4a3]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d4a4" href="#d4a4">[d4a4]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$23</span></span></span>
<span class="l"><a class="anc" name="d4a6" href="#d4a6">[d4a6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUAttrAddr_U">Screen_ScrollVertBlocks_PPUAttrAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d4a8" href="#d4a8">[d4a8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_TILEMAP_OFFSETS_L">SET_BLOCKS_TILEMAP_OFFSETS_L</a>,X</span></span></span>
<span class="l"><a class="anc" name="d4ab" href="#d4ab">[d4ab]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><a class="anc" name="d4ad" href="#d4ad">[d4ad]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_TILEMAP_OFFSETS_U">SET_BLOCKS_TILEMAP_OFFSETS_U</a>,X</span></span></span>
<span class="l"><a class="anc" name="d4b0" href="#d4b0">[d4b0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d4b2" href="#d4b2">[d4b2]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d4b4:@LAB_PRG15_MIRROR__d4b4"></a><span class="l"><a class="anc" name="d4b4" href="#d4b4">[d4b4]</a><a href="#:d4b4:@LAB_PRG15_MIRROR__d4b4" class="lla">@LAB_PRG15_MIRROR__d4b4:</a><span class="ce">; [$d4b4]</span></span>
<span class="l"><a class="anc" name="d4b4" href="#d4b4">[d4b4]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d4b6" href="#d4b6">[d4b6]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d4b8" href="#d4b8">[d4b8]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertPPUAttrData">Screen_ScrollVertPPUAttrData</a>,X</span></span></span>
<span class="l"><a class="anc" name="d4bb" href="#d4bb">[d4bb]</a><span class="cd"><span class="i">STA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d4bd" href="#d4bd">[d4bd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertPPUAttrData">Screen_ScrollVertPPUAttrData</a>,X</span></span></span>
<span class="l"><a class="anc" name="d4c0" href="#d4c0">[d4c0]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="d4c1" href="#d4c1">[d4c1]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d4c2" href="#d4c2">[d4c2]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="d4c4" href="#d4c4">[d4c4]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d4b4">@LAB_PRG15_MIRROR__d4b4</a></span></span></span>
<span class="l"><a class="anc" name="d4c6" href="#d4c6">[d4c6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d4c8" href="#d4c8">[d4c8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_MaybeUnused_0075">Screen_MaybeUnused_0075</a></span></span></span>
<span class="l"><a class="anc" name="d4ca" href="#d4ca">[d4ca]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"><a class="anc" name="d4cb" href="#d4cb">[d4cb]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__d4cb_1_"></a><div class="c">;
; XREFS:
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;
</div><span class="l"><a class="anc" name="d4cc" href="#d4cc">[d4cc]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__d4cb_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__d4cb_1_:</a><span class="ce">; [$d4cc]</span></span>
<span class="l"><a class="anc" name="d4cc" href="#d4cc">[d4cc]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d4cd" href="#d4cd">[d4cd]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$08</span></span><span class="ce">; [$d4cd] byte</span></span>
<span class="l"></span>
<a name="SET_BLOCKS_TILEMAP_OFFSETS_L"></a><div class="c">;
; XREFS:
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
</div><span class="l"><a class="anc" name="d4cf" href="#d4cf">[d4cf]</a><a href="#SET_BLOCKS_TILEMAP_OFFSETS_L" class="la">SET_BLOCKS_TILEMAP_OFFSETS_L:</a><span class="ce">; [$d4cf]</span></span>
<span class="l"><a class="anc" name="d4cf" href="#d4cf">[d4cf]</a><span class="cd"><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d4d0" href="#d4d0">[d4d0]</a><span class="cd"><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<a name="SET_BLOCKS_TILEMAP_OFFSETS_U"></a><div class="c">;
; XREFS:
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
</div><span class="l"><a class="anc" name="d4d1" href="#d4d1">[d4d1]</a><a href="#SET_BLOCKS_TILEMAP_OFFSETS_U" class="la">SET_BLOCKS_TILEMAP_OFFSETS_U:</a><span class="ce">; [$d4d1]</span></span>
<span class="l"><a class="anc" name="d4d1" href="#d4d1">[d4d1]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d4d2" href="#d4d2">[d4d2]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="BLOCK_ATTRS_BITMASKS"></a><div class="cp">;============================================================================
; Block attribute masks during screen scrolling.
;
; This is used for both vertical and horizontal scrolling.
;
; XREFS:
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Screen_LoadBlockDataVert">Screen_LoadBlockDataVert</a>
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
</div><span class="l"><a class="anc" name="d4d3" href="#d4d3">[d4d3]</a><a href="#BLOCK_ATTRS_BITMASKS" class="la">BLOCK_ATTRS_BITMASKS:</a><span class="ce">; [$d4d3]</span></span>
<span class="l"><a class="anc" name="d4d3" href="#d4d3">[d4d3]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [0]: Mask bits 0 and 1</span></span>
<span class="l"><a class="anc" name="d4d4" href="#d4d4">[d4d4]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [1]: Mask bits 2 and 3</span></span>
<span class="l"><a class="anc" name="d4d5" href="#d4d5">[d4d5]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]: Mask bits 4 and 5</span></span>
<span class="l"><a class="anc" name="d4d6" href="#d4d6">[d4d6]</a><span class="cd"><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [3]: Mask bits 6 and 7</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadAttrsHoriz"></a><div class="cp">;============================================================================
; Load block attributes when scrolling horizontally.
;
; This sets the loading mode to load attributes, and then
; load a round of blocks horizontally.
;
; INPUTS:
;     X:
;         0 = Load blocks to the left.
;         1 = Load blocks to the right.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a>:
;         The mode set to loading attributes.
;
; CALLS:
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
; XREFS:
;     <a href="#Screen_LoadDataLeft">Screen_LoadDataLeft</a>
;     <a href="#Screen_LoadDataRight">Screen_LoadDataRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="d4d7" href="#d4d7">[d4d7]</a><a href="#Screen_LoadAttrsHoriz" class="la">Screen_LoadAttrsHoriz:</a><span class="ce">; [$d4d7]</span></span>
<span class="l"><a class="anc" name="d4d7" href="#d4d7">[d4d7]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span><span class="ce">; Set load mode to 1 (load attributes).</span></span>
<span class="l"><a class="anc" name="d4d9" href="#d4d9">[d4d9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a></span></span><span class="ce">; Load the data.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadDataRight"></a><div class="cp">;============================================================================
; Load screen data for the screen to the right.
;
; Every 4 counts (2, 6, 10, ...), this will load
; attribute data.
;
; Every 4 counts (1, 5, 9, ...), this will load
; tile data.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a>:
;         The load counter for blocks.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Screen_LoadAttrsHoriz">Screen_LoadAttrsHoriz</a>
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
; XREFS:
;     <a href="#Screen_HandleScrollRight">Screen_HandleScrollRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="d4dc" href="#d4dc">[d4dc]</a><a href="#Screen_LoadDataRight" class="la">Screen_LoadDataRight:</a><span class="ce">; [$d4dc]</span></span>
<span class="l"><a class="anc" name="d4dc" href="#d4dc">[d4dc]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; 0 = Load Tiles mode</span></span>
<span class="l"><a class="anc" name="d4de" href="#d4de">[d4de]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span><span class="ce">; Set as the default mode.</span></span>
<span class="l"><a class="anc" name="d4e0" href="#d4e0">[d4e0]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (reuse as "is right" flag, set to 1).</span></span>
<span class="l"><a class="anc" name="d4e1" href="#d4e1">[d4e1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span><span class="ce">; A = Horizontal blocks counter</span></span>
<span class="l"><a class="anc" name="d4e3" href="#d4e3">[d4e3]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Keep the lower nibble.</span></span>
<span class="l"><a class="anc" name="d4e5" href="#d4e5">[d4e5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it 2 (every 4 blocks, starting at 2)?</span></span>
<span class="l"><a class="anc" name="d4e7" href="#d4e7">[d4e7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadAttrsHoriz">Screen_LoadAttrsHoriz</a></span></span><span class="ce">; If so, load attributes.</span></span>
<span class="l"><a class="anc" name="d4e9" href="#d4e9">[d4e9]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Else, keep the lower 3 bits.</span></span>
<span class="l"><a class="anc" name="d4eb" href="#d4eb">[d4eb]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Is it 1 (every 4 blocks, starting at 1)?</span></span>
<span class="l"><a class="anc" name="d4ed" href="#d4ed">[d4ed]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a></span></span><span class="ce">; If so, load tiles.</span></span>
<span class="l"><a class="anc" name="d4ef" href="#d4ef">[d4ef]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadDataLeft"></a><div class="cp">;============================================================================
; Load screen data for the screen to the left.
;
; Every 16 counts (values 15, 31, 47, ...), this will load
; attribute data.
;
; Every 8 counts (values 6, 14, 22, ...), this will load
; tile data.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a>:
;         The load counter for blocks.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Screen_LoadAttrsHoriz">Screen_LoadAttrsHoriz</a>
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
; XREFS:
;     <a href="#Screen_HandleScrollLeft">Screen_HandleScrollLeft</a>
;============================================================================
</div><span class="l"><a class="anc" name="d4f0" href="#d4f0">[d4f0]</a><a href="#Screen_LoadDataLeft" class="la">Screen_LoadDataLeft:</a><span class="ce">; [$d4f0]</span></span>
<span class="l"><a class="anc" name="d4f0" href="#d4f0">[d4f0]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; 0 = Load Tiles mode</span></span>
<span class="l"><a class="anc" name="d4f2" href="#d4f2">[d4f2]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span><span class="ce">; Set as the default mode.</span></span>
<span class="l"><a class="anc" name="d4f4" href="#d4f4">[d4f4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span><span class="ce">; A = Horizontal blocks counter</span></span>
<span class="l"><a class="anc" name="d4f6" href="#d4f6">[d4f6]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Keep the lower nibble.</span></span>
<span class="l"><a class="anc" name="d4f8" href="#d4f8">[d4f8]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0f</span></span><span class="ce">; Is it 0xF (every 16, starting at 15)?</span></span>
<span class="l"><a class="anc" name="d4fa" href="#d4fa">[d4fa]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadAttrsHoriz">Screen_LoadAttrsHoriz</a></span></span><span class="ce">; If so, load attributes.</span></span>
<span class="l"><a class="anc" name="d4fc" href="#d4fc">[d4fc]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Else, keep the lower 3 bits.</span></span>
<span class="l"><a class="anc" name="d4fe" href="#d4fe">[d4fe]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is it 6 (every 8 blocks, starting at 6)?</span></span>
<span class="l"><a class="anc" name="d500" href="#d500">[d500]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a></span></span><span class="ce">; If so, load tiles.</span></span>
<span class="l"><a class="anc" name="d502" href="#d502">[d502]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Else, return.</span></span>
<span class="l"></span>
</pre><pre><a name="Screen_LoadBlocksHoriz"></a><div class="cp">;============================================================================
; TODO: Document Screen_LoadBlocksHoriz
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Screen_LoadAttrsHoriz">Screen_LoadAttrsHoriz</a>
;     <a href="#Screen_LoadDataLeft">Screen_LoadDataLeft</a>
;     <a href="#Screen_LoadDataRight">Screen_LoadDataRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="d503" href="#d503">[d503]</a><a href="#Screen_LoadBlocksHoriz" class="la">Screen_LoadBlocksHoriz:</a><span class="ce">; [$d503]</span></span>
<span class="l"><a class="anc" name="d503" href="#d503">[d503]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d505" href="#d505">[d505]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d506" href="#d506">[d506]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#SCROLL_HORIZ_END_POS">SCROLL_HORIZ_END_POS</a>,X</span></span></span>
<span class="l"><a class="anc" name="d509" href="#d509">[d509]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d50b" href="#d50b">[d50b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="d50d" href="#d50d">[d50d]</a><span class="cd"><span class="i">ADC</span> <span class="o">$d61b,X</span></span></span>
<span class="l"><a class="anc" name="d510" href="#d510">[d510]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollHorizDirection">Screen_Maybe_ScrollHorizDirection</a></span></span></span>
<span class="l"><a class="anc" name="d512" href="#d512">[d512]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="d514" href="#d514">[d514]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MaybeUnused_006d">MaybeUnused_006d</a></span></span></span>
<span class="l"><a class="anc" name="d516" href="#d516">[d516]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d518" href="#d518">[d518]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d519" href="#d519">[d519]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d51a" href="#d51a">[d51a]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d51b" href="#d51b">[d51b]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d51c" href="#d51c">[d51c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span></span>
<span class="l"><a class="anc" name="d51e" href="#d51e">[d51e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d520" href="#d520">[d520]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><a class="anc" name="d522" href="#d522">[d522]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="d524" href="#d524">[d524]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d526" href="#d526">[d526]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollLoadMode">Screen_ScrollLoadMode</a></span></span></span>
<span class="l"><a class="anc" name="d528" href="#d528">[d528]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadPPUData">@_loadPPUData</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load 30 blocks to render in the next draw phase.
;
</div><span class="l"><a class="anc" name="d52a" href="#d52a">[d52a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (counter)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d52c:@_loadBlocksLoop"></a><div class="c">;
; Determine the offset for the blocks to load.
;
</div><span class="l"><a class="anc" name="d52c" href="#d52c">[d52c]</a><a href="#:d52c:@_loadBlocksLoop" class="lla">@_loadBlocksLoop:</a><span class="ce">; [$d52c]</span></span>
<span class="l"><a class="anc" name="d52c" href="#d52c">[d52c]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span></span>
<span class="l"><a class="anc" name="d52e" href="#d52e">[d52e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the blocks information.
;
</div><span class="l"><a class="anc" name="d530" href="#d530">[d530]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d531" href="#d531">[d531]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d533" href="#d533">[d533]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d535" href="#d535">[d535]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d537" href="#d537">[d537]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d539" href="#d539">[d539]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d53b" href="#d53b">[d53b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData3CurAddr">CurrentArea_BlockData3CurAddr</a></span></span></span>
<span class="l"><a class="anc" name="d53d" href="#d53d">[d53d]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d53f" href="#d53f">[d53f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData4CurAddr">CurrentArea_BlockData4CurAddr</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Convert the block counter to a tile width.
;
</div><span class="l"><a class="anc" name="d541" href="#d541">[d541]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadCounter">Screen_ScrollHorizLoadCounter</a></span></span></span>
<span class="l"><a class="anc" name="d543" href="#d543">[d543]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="d545" href="#d545">[d545]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d546" href="#d546">[d546]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d547" href="#d547">[d547]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d548" href="#d548">[d548]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1CurAddr">CurrentArea_BlockData1CurAddr</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d54b" href="#d54b">[d54b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_0200">Temp_0200</a>,X</span></span></span>
<span class="l"><a class="anc" name="d54e" href="#d54e">[d54e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData2CurAddr">CurrentArea_BlockData2CurAddr</a>,Y</span></span></span>
<span class="l"><a class="anc" name="d551" href="#d551">[d551]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_0201">Temp_0201</a>,X</span></span></span>
<span class="l"><a class="anc" name="d554" href="#d554">[d554]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><a class="anc" name="d556" href="#d556">[d556]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d557" href="#d557">[d557]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="d559" href="#d559">[d559]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><a class="anc" name="d55b" href="#d55b">[d55b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d55d" href="#d55d">[d55d]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d55f" href="#d55f">[d55f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"><a class="anc" name="d561" href="#d561">[d561]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d562" href="#d562">[d562]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d563" href="#d563">[d563]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$1e</span></span></span>
<span class="l"><a class="anc" name="d565" href="#d565">[d565]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loadBlocksLoop">@_loadBlocksLoop</a></span></span></span>
<span class="l"><a class="anc" name="d567" href="#d567">[d567]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d569" href="#d569">[d569]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocksLoaded">Screen_ScrollHorizBlocksLoaded</a></span></span></span>
<span class="l"><a class="anc" name="d56b" href="#d56b">[d56b]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="d56c" href="#d56c">[d56c]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d56d" href="#d56d">[d56d]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d56e" href="#d56e">[d56e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span></span>
<span class="l"><a class="anc" name="d570" href="#d570">[d570]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d571" href="#d571">[d571]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span></span>
<span class="l"><a class="anc" name="d573" href="#d573">[d573]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d574" href="#d574">[d574]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d575" href="#d575">[d575]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span></span>
<span class="l"><a class="anc" name="d577" href="#d577">[d577]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d578" href="#d578">[d578]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="d57a" href="#d57a">[d57a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUTileMapAddr_L">Screen_ScrollHorizBlocks_PPUTileMapAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d57c" href="#d57c">[d57c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollHorizDirection">Screen_Maybe_ScrollHorizDirection</a></span></span></span>
<span class="l"><a class="anc" name="d57e" href="#d57e">[d57e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d580" href="#d580">[d580]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d581" href="#d581">[d581]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d582" href="#d582">[d582]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="d584" href="#d584">[d584]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUTileMapAddr_U">Screen_ScrollHorizBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d586" href="#d586">[d586]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d587:@_loadPPUData"></a><div class="c">;
; Clear 8 bytes of memory.
;
; This isn't used for any data management purposes. It
; may be to delay some aspect of screen scrolling.
;
</div><span class="l"><a class="anc" name="d587" href="#d587">[d587]</a><a href="#:d587:@_loadPPUData" class="lla">@_loadPPUData:</a><span class="ce">; [$d587]</span></span>
<span class="l"><a class="anc" name="d587" href="#d587">[d587]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$f8</span></span><span class="ce">; Y = 0xF8 (loop counter)</span></span>
<span class="l"><a class="anc" name="d589" href="#d589">[d589]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (value to write)</span></span>
<span class="l"></span>
<a name=":d58b:@_clearLoop"></a><span class="l"><a class="anc" name="d58b" href="#d58b">[d58b]</a><a href="#:d58b:@_clearLoop" class="lla">@_clearLoop:</a><span class="ce">; [$d58b]</span></span>
<span class="l"><a class="anc" name="d58b" href="#d58b">[d58b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHoriz_ZeroData">Screen_ScrollHoriz_ZeroData</a>,Y</span></span><span class="ce">; Write a 0 to this empty block.</span></span>
<span class="l"><a class="anc" name="d58e" href="#d58e">[d58e]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="d58f" href="#d58f">[d58f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_clearLoop">@_clearLoop</a></span></span><span class="ce">; If != 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin loading PPU attribute data and scheduling to draw.
;
</div><span class="l"><a class="anc" name="d591" href="#d591">[d591]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (loop counter)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d593:@_loadAttrDataLoop"></a><div class="c">;
; Start by storing the data load offset and the block
; attribute value from area data, storing in temp.
;
; The screen buffer data will contain the offset into the
; block attributes data.
;
</div><span class="l"><a class="anc" name="d593" href="#d593">[d593]</a><a href="#:d593:@_loadAttrDataLoop" class="lla">@_loadAttrDataLoop:</a><span class="ce">; [$d593]</span></span>
<span class="l"><a class="anc" name="d593" href="#d593">[d593]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span><span class="ce">; Y = Attr data load offset</span></span>
<span class="l"><a class="anc" name="d595" href="#d595">[d595]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; A = Screen buffer data at offset (block attribute offset)</span></span>
<span class="l"><a class="anc" name="d597" href="#d597">[d597]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="d598" href="#d598">[d598]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span><span class="ce">; A = block attribute at resulting screen buffer data offset value</span></span>
<span class="l"><a class="anc" name="d59a" href="#d59a">[d59a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Generate an index 0-3 into a lookup table. This will be:
;
; 0 = Bits 0-1 -- Even loop counter, even load offset
; 1 = Bits 2-3 -- Even loop counter, odd load offset
; 2 = Bits 4-5 -- Odd loop counter, even load offset
; 3 = Bits 6-7 -- Odd loop counter, odd load offset
;
</div><span class="l"><a class="anc" name="d59c" href="#d59c">[d59c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span><span class="ce">; A = Attr data load offset</span></span>
<span class="l"><a class="anc" name="d59e" href="#d59e">[d59e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the least-significant bit (even/odd).</span></span>
<span class="l"><a class="anc" name="d5a0" href="#d5a0">[d5a0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><a class="anc" name="d5a2" href="#d5a2">[d5a2]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X (loop counter)</span></span>
<span class="l"><a class="anc" name="d5a3" href="#d5a3">[d5a3]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the loop counter's least-significant bit (even/odd).</span></span>
<span class="l"><a class="anc" name="d5a5" href="#d5a5">[d5a5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A *= 2</span></span>
<span class="l"><a class="anc" name="d5a6" href="#d5a6">[d5a6]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; OR with the load offset's even/odd bit.</span></span>
<span class="l"><a class="anc" name="d5a8" href="#d5a8">[d5a8]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (result)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Mask 2 bits of the block attributes based on that index.
;
</div><span class="l"><a class="anc" name="d5a9" href="#d5a9">[d5a9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; A = Loaded block attribute</span></span>
<span class="l"><a class="anc" name="d5ab" href="#d5ab">[d5ab]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="#BLOCK_ATTRS_BITMASKS">BLOCK_ATTRS_BITMASKS</a>,Y</span></span><span class="ce">; AND with the bitmask based on our computed index.</span></span>
<span class="l"><a class="anc" name="d5ae" href="#d5ae">[d5ae]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the result to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Generate the destination index into the PPU attribute data.
;
; This will be the loop counter / 2.
;
</div><span class="l"><a class="anc" name="d5af" href="#d5af">[d5af]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X (loop counter)</span></span>
<span class="l"><a class="anc" name="d5b0" href="#d5b0">[d5b0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; A = A / 2</span></span>
<span class="l"><a class="anc" name="d5b1" href="#d5b1">[d5b1]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; OR the result with the value already loaded at this loop
; index, and store it back.
;
</div><span class="l"><a class="anc" name="d5b2" href="#d5b2">[d5b2]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the masked block attribute from stack.</span></span>
<span class="l"><a class="anc" name="d5b3" href="#d5b3">[d5b3]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizPPUAttrData">Screen_ScrollHorizPPUAttrData</a>,Y</span></span><span class="ce">; OR with the data already set.</span></span>
<span class="l"><a class="anc" name="d5b6" href="#d5b6">[d5b6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizPPUAttrData">Screen_ScrollHorizPPUAttrData</a>,Y</span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Advance the screen buffer address by 16 bytes.
;
</div><span class="l"><a class="anc" name="d5b9" href="#d5b9">[d5b9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; A = Lower byte of Current screen buffer address.</span></span>
<span class="l"><a class="anc" name="d5bb" href="#d5bb">[d5bb]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d5bc" href="#d5bc">[d5bc]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16</span></span>
<span class="l"><a class="anc" name="d5be" href="#d5be">[d5be]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span><span class="ce">; Store as the new lower byte.</span></span>
<span class="l"><a class="anc" name="d5c0" href="#d5c0">[d5c0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; A = Upper byte of Current screen buffer address.</span></span>
<span class="l"><a class="anc" name="d5c2" href="#d5c2">[d5c2]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; A += Carry from lower increment</span></span>
<span class="l"><a class="anc" name="d5c4" href="#d5c4">[d5c4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Advance the loop counter, and loop if &lt; 15.
;
</div><span class="l"><a class="anc" name="d5c6" href="#d5c6">[d5c6]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (loop counter)</span></span>
<span class="l"><a class="anc" name="d5c7" href="#d5c7">[d5c7]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$0f</span></span><span class="ce">; Is this &lt; 15?</span></span>
<span class="l"><a class="anc" name="d5c9" href="#d5c9">[d5c9]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loadAttrDataLoop">@_loadAttrDataLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Generate a bitmask that will be ANDed to screen
; buffer data and OR'd back to scroll PPU attribute
; data futher below.
;
</div><span class="l"><a class="anc" name="d5cb" href="#d5cb">[d5cb]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$cc</span></span><span class="ce">; Default bitmask to enable bits 2-3, 6-7 (11001100)</span></span>
<span class="l"><a class="anc" name="d5cd" href="#d5cd">[d5cd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span><span class="ce">; Load the data load offset.</span></span>
<span class="l"><a class="anc" name="d5cf" href="#d5cf">[d5cf]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Is it even?</span></span>
<span class="l"><a class="anc" name="d5d1" href="#d5d1">[d5d1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_updatePPUAttrAddr">@_updatePPUAttrAddr</a></span></span><span class="ce">; If so, jump to skip.</span></span>
<span class="l"><a class="anc" name="d5d3" href="#d5d3">[d5d3]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$33</span></span><span class="ce">; Set bitmask to enable bits 0-1, 4-5 (00110011)</span></span>
<span class="l"></span>
<a name=":d5d5:@_updatePPUAttrAddr"></a><span class="l"><a class="anc" name="d5d5" href="#d5d5">[d5d5]</a><a href="#:d5d5:@_updatePPUAttrAddr" class="lla">@_updatePPUAttrAddr:</a><span class="ce">; [$d5d5]</span></span>
<span class="l"><a class="anc" name="d5d5" href="#d5d5">[d5d5]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Store for later.</span></span>
<span class="l"><a class="anc" name="d5d7" href="#d5d7">[d5d7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizLoadOffset">Screen_ScrollHorizLoadOffset</a></span></span><span class="ce">; A = Data load offset.</span></span>
<span class="l"><a class="anc" name="d5d9" href="#d5d9">[d5d9]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; A = A / 2</span></span>
<span class="l"><a class="anc" name="d5da" href="#d5da">[d5da]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d5db" href="#d5db">[d5db]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$08</span></span><span class="ce">; A += 8</span></span>
<span class="l"><a class="anc" name="d5dd" href="#d5dd">[d5dd]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (new screen buffer write offset)</span></span>
<span class="l"><a class="anc" name="d5de" href="#d5de">[d5de]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d5df" href="#d5df">[d5df]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$c0</span></span><span class="ce">; A += 0xC0</span></span>
<span class="l"><a class="anc" name="d5e1" href="#d5e1">[d5e1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUAttrAddr_L">Screen_ScrollHorizBlocks_PPUAttrAddr_L</a></span></span><span class="ce">; Set as the lower byte of the PPU attr address.</span></span>
<span class="l"><a class="anc" name="d5e3" href="#d5e3">[d5e3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollHorizDirection">Screen_Maybe_ScrollHorizDirection</a></span></span></span>
<span class="l"><a class="anc" name="d5e5" href="#d5e5">[d5e5]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d5e7" href="#d5e7">[d5e7]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d5e8" href="#d5e8">[d5e8]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d5e9" href="#d5e9">[d5e9]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d5ea" href="#d5ea">[d5ea]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$23</span></span></span>
<span class="l"><a class="anc" name="d5ec" href="#d5ec">[d5ec]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUAttrAddr_U">Screen_ScrollHorizBlocks_PPUAttrAddr_U</a></span></span><span class="ce">; Set as the upper byte of the PPU attr address.</span></span>
<span class="l"><a class="anc" name="d5ee" href="#d5ee">[d5ee]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_TILEMAP_OFFSETS_L">SET_BLOCKS_TILEMAP_OFFSETS_L</a>,X</span></span></span>
<span class="l"><a class="anc" name="d5f1" href="#d5f1">[d5f1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_08">Temp_08</a></span></span></span>
<span class="l"><a class="anc" name="d5f3" href="#d5f3">[d5f3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_TILEMAP_OFFSETS_U">SET_BLOCKS_TILEMAP_OFFSETS_U</a>,X</span></span></span>
<span class="l"><a class="anc" name="d5f6" href="#d5f6">[d5f6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_09">Temp_09</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update 64 blocks of PPU attribute data.
;
; This will OR the bitmask above to each of the 64
; bytes of PPU attribute data already computed.
;
</div><span class="l"><a class="anc" name="d5f8" href="#d5f8">[d5f8]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (loop counter)</span></span>
<span class="l"></span>
<a name=":d5fa:@_updatePPUAttrDataLoop"></a><span class="l"><a class="anc" name="d5fa" href="#d5fa">[d5fa]</a><a href="#:d5fa:@_updatePPUAttrDataLoop" class="lla">@_updatePPUAttrDataLoop:</a><span class="ce">; [$d5fa]</span></span>
<span class="l"><a class="anc" name="d5fa" href="#d5fa">[d5fa]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Load the value from the screen buffer write offset at Y.</span></span>
<span class="l"><a class="anc" name="d5fc" href="#d5fc">[d5fc]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; AND with the bitmask computed above.</span></span>
<span class="l"><a class="anc" name="d5fe" href="#d5fe">[d5fe]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizPPUAttrData">Screen_ScrollHorizPPUAttrData</a>,X</span></span><span class="ce">; OR with the existing PPU attribute data</span></span>
<span class="l"><a class="anc" name="d601" href="#d601">[d601]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizPPUAttrData">Screen_ScrollHorizPPUAttrData</a>,X</span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="d604" href="#d604">[d604]</a><span class="cd"><span class="i">STA</span> <span class="o">(<a href="RAM.html#Temp_08">Temp_08</a>),Y</span></span><span class="ce">; Store it back in the screen buffer at write offset Y.</span></span>
<span class="l"><a class="anc" name="d606" href="#d606">[d606]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (loop counter)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The next three instructions are effectively unused.
; Legacy code?
;
</div><span class="l"><a class="anc" name="d607" href="#d607">[d607]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; &lt;unused&gt;</span></span>
<span class="l"><a class="anc" name="d608" href="#d608">[d608]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; &lt;unused&gt;</span></span>
<span class="l"><a class="anc" name="d60a" href="#d60a">[d60a]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; &lt;unused&gt;</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Advance the earlier loop counter (which should start at 15)
; by 8 each loop iteration.
;
</div><span class="l"><a class="anc" name="d60b" href="#d60b">[d60b]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (loop counter from initial attribute loading)</span></span>
<span class="l"><a class="anc" name="d60c" href="#d60c">[d60c]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d60d" href="#d60d">[d60d]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$08</span></span><span class="ce">; A += 8</span></span>
<span class="l"><a class="anc" name="d60f" href="#d60f">[d60f]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="d610" href="#d610">[d610]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$40</span></span><span class="ce">; Is it &lt; 64?</span></span>
<span class="l"><a class="anc" name="d612" href="#d612">[d612]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_updatePPUAttrDataLoop">@_updatePPUAttrDataLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Mark the attribute data as loaded.
;
</div><span class="l"><a class="anc" name="d614" href="#d614">[d614]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d616" href="#d616">[d616]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizAttrsLoaded">Screen_ScrollHorizAttrsLoaded</a></span></span><span class="ce">; Set attribute data loaded.</span></span>
<span class="l"><a class="anc" name="d618" href="#d618">[d618]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="SCROLL_HORIZ_END_POS"></a><div class="c">;
; XREFS:
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
</div><span class="l"><a class="anc" name="d619" href="#d619">[d619]</a><a href="#SCROLL_HORIZ_END_POS" class="la">SCROLL_HORIZ_END_POS:</a><span class="ce">; [$d619]</span></span>
<span class="l"><a class="anc" name="d619" href="#d619">[d619]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d61a" href="#d61a">[d61a]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__d61b"></a><div class="c">;
; XREFS:
;     <a href="#Screen_LoadBlocksHoriz">Screen_LoadBlocksHoriz</a>
;
</div><span class="l"><a class="anc" name="d61b" href="#d61b">[d61b]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__d61b" class="la">BYTE_ARRAY_PRG15_MIRROR__d61b:</a><span class="ce">; [$d61b]</span></span>
<span class="l"><a class="anc" name="d61b" href="#d61b">[d61b]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d61c" href="#d61c">[d61c]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
</pre><pre><a name="Screen_RunWriteScrollDataHandler"></a><div class="cp">;============================================================================
; TODO: Document Screen_RunWriteScrollDataHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ScrollScreenRight">Area_ScrollScreenRight</a>
;     <a href="#PPU_HandleOnInterrupt">PPU_HandleOnInterrupt</a>
;     <a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="d61d" href="#d61d">[d61d]</a><a href="#Screen_RunWriteScrollDataHandler" class="la">Screen_RunWriteScrollDataHandler:</a><span class="ce">; [$d61d]</span></span>
<span class="l"><a class="anc" name="d61d" href="#d61d">[d61d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d61f" href="#d61f">[d61f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d621" href="#d621">[d621]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Screen_LoadBlocksStage">Screen_LoadBlocksStage</a></span></span></span>
<span class="l"></span>
<a name=":d623:@_loop"></a><span class="l"><a class="anc" name="d623" href="#d623">[d623]</a><a href="#:d623:@_loop" class="lla">@_loop:</a><span class="ce">; [$d623]</span></span>
<span class="l"><a class="anc" name="d623" href="#d623">[d623]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_NeighborBlocksLoadedByDirection">Screen_NeighborBlocksLoadedByDirection</a>,X</span></span></span>
<span class="l"><a class="anc" name="d625" href="#d625">[d625]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__d631">@LAB_PRG15_MIRROR__d631</a></span></span></span>
<span class="l"><a class="anc" name="d627" href="#d627">[d627]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d628" href="#d628">[d628]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d629" href="#d629">[d629]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d62b" href="#d62b">[d62b]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d62c" href="#d62c">[d62c]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d62e" href="#d62e">[d62e]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="d630" href="#d630">[d630]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":d631:@LAB_PRG15_MIRROR__d631"></a><span class="l"><a class="anc" name="d631" href="#d631">[d631]</a><a href="#:d631:@LAB_PRG15_MIRROR__d631" class="lla">@LAB_PRG15_MIRROR__d631:</a><span class="ce">; [$d631]</span></span>
<span class="l"><a class="anc" name="d631" href="#d631">[d631]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d633" href="#d633">[d633]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_NeighborBlocksLoadedByDirection">Screen_NeighborBlocksLoadedByDirection</a>,X</span></span></span>
<span class="l"><a class="anc" name="d635" href="#d635">[d635]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d637" href="#d637">[d637]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d638" href="#d638">[d638]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d639" href="#d639">[d639]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d63b" href="#d63b">[d63b]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d63c" href="#d63c">[d63c]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Screen_LoadBlocksStage">Screen_LoadBlocksStage</a></span></span></span>
<span class="l"><a class="anc" name="d63e" href="#d63e">[d63e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span></span>
<span class="l"><a class="anc" name="d640" href="#d640">[d640]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d642" href="#d642">[d642]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d643" href="#d643">[d643]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SCREEN_WRITESCROLL_HANDLERS_U">SCREEN_WRITESCROLL_HANDLERS_U</a>,X</span></span></span>
<span class="l"><a class="anc" name="d646" href="#d646">[d646]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d647" href="#d647">[d647]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SCREEN_WRITESCROLL_HANDLERS_L">SCREEN_WRITESCROLL_HANDLERS_L</a>,X</span></span></span>
<span class="l"><a class="anc" name="d64a" href="#d64a">[d64a]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d64b" href="#d64b">[d64b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="SCREEN_WRITESCROLL_HANDLERS_L"></a><div class="c">;
; XREFS:
;     <a href="#Screen_RunWriteScrollDataHandler">Screen_RunWriteScrollDataHandler</a>
;
</div><span class="l"><a class="anc" name="d64c" href="#d64c">[d64c]</a><a href="#SCREEN_WRITESCROLL_HANDLERS_L" class="la">SCREEN_WRITESCROLL_HANDLERS_L:</a><span class="ce">; [$d64c]</span></span>
<span class="l"><a class="anc" name="d64c" href="#d64c">[d64c]</a><span class="cd"><span class="i">db</span> <span class="o">&lt;<a href="#Screen_WriteScrollVertPPUTileData">Screen_WriteScrollVertPPUTileData</a>-1</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d64d" href="#d64d">[d64d]</a><span class="cd"><span class="i">db</span> <span class="o">$72</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d64e" href="#d64e">[d64e]</a><span class="cd"><span class="i">db</span> <span class="o">$98</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d64f" href="#d64f">[d64f]</a><span class="cd"><span class="i">db</span> <span class="o">$b0</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<a name="SCREEN_WRITESCROLL_HANDLERS_U"></a><div class="c">;
; XREFS:
;     <a href="#Screen_RunWriteScrollDataHandler">Screen_RunWriteScrollDataHandler</a>
;
</div><span class="l"><a class="anc" name="d650" href="#d650">[d650]</a><a href="#SCREEN_WRITESCROLL_HANDLERS_U" class="la">SCREEN_WRITESCROLL_HANDLERS_U:</a><span class="ce">; [$d650]</span></span>
<span class="l"><a class="anc" name="d650" href="#d650">[d650]</a><span class="cd"><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d651" href="#d651">[d651]</a><span class="cd"><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d652" href="#d652">[d652]</a><span class="cd"><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d653" href="#d653">[d653]</a><span class="cd"><span class="i">db</span> <span class="o">$d6</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
</pre><pre><a name="Screen_WriteScrollVertPPUTileData"></a><div class="cp">;============================================================================
; TODO: Document Screen_WriteScrollVertPPUTileData
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#SCREEN_WRITESCROLL_HANDLERS_L">SCREEN_WRITESCROLL_HANDLERS_L</a>
;     [$PRG15_MIRROR::d64c]
;============================================================================
</div><span class="l"><a class="anc" name="d654" href="#d654">[d654]</a><a href="#Screen_WriteScrollVertPPUTileData" class="la">Screen_WriteScrollVertPPUTileData:</a><span class="ce">; [$d654]</span></span>
<span class="l"><a class="anc" name="d654" href="#d654">[d654]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span></span>
<span class="l"><a class="anc" name="d656" href="#d656">[d656]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><a class="anc" name="d658" href="#d658">[d658]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><a class="anc" name="d65b" href="#d65b">[d65b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_U">Screen_ScrollVertBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d65d" href="#d65d">[d65d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d660" href="#d660">[d660]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUTileMapAddr_L">Screen_ScrollVertBlocks_PPUTileMapAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d662" href="#d662">[d662]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d665" href="#d665">[d665]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d667:@_loop"></a><span class="l"><a class="anc" name="d667" href="#d667">[d667]</a><a href="#:d667:@_loop" class="lla">@_loop:</a><span class="ce">; [$d667]</span></span>
<span class="l"><a class="anc" name="d667" href="#d667">[d667]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#DataArray">DataArray</a>,X</span></span></span>
<span class="l"><a class="anc" name="d66a" href="#d66a">[d66a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><a class="anc" name="d66d" href="#d66d">[d66d]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d66e" href="#d66e">[d66e]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="d670" href="#d670">[d670]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="d672" href="#d672">[d672]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Screen_WriteScrollHorizPPUTileData"></a><div class="cp">;============================================================================
; TODO: Document Screen_WriteScrollHorizPPUTileData
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#SCREEN_WRITESCROLL_HANDLERS_L">SCREEN_WRITESCROLL_HANDLERS_L</a>
;     [$PRG15_MIRROR::d64d]
;============================================================================
</div><span class="l"><a class="anc" name="d673" href="#d673">[d673]</a><a href="#Screen_WriteScrollHorizPPUTileData" class="la">Screen_WriteScrollHorizPPUTileData:</a><span class="ce">; [$d673]</span></span>
<span class="l"><a class="anc" name="d673" href="#d673">[d673]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span></span>
<span class="l"><a class="anc" name="d675" href="#d675">[d675]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="d677" href="#d677">[d677]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><a class="anc" name="d67a" href="#d67a">[d67a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUTileMapAddr_U">Screen_ScrollHorizBlocks_PPUTileMapAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d67c" href="#d67c">[d67c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d67f" href="#d67f">[d67f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUTileMapAddr_L">Screen_ScrollHorizBlocks_PPUTileMapAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d681" href="#d681">[d681]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d684" href="#d684">[d684]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d686:@_loop"></a><span class="l"><a class="anc" name="d686" href="#d686">[d686]</a><a href="#:d686:@_loop" class="lla">@_loop:</a><span class="ce">; [$d686]</span></span>
<span class="l"><a class="anc" name="d686" href="#d686">[d686]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_0200">Temp_0200</a>,X</span></span></span>
<span class="l"><a class="anc" name="d689" href="#d689">[d689]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><a class="anc" name="d68c" href="#d68c">[d68c]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d68d" href="#d68d">[d68d]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$1a</span></span></span>
<span class="l"><a class="anc" name="d68f" href="#d68f">[d68f]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="d691" href="#d691">[d691]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ControlFlags">PPU_ControlFlags</a></span></span></span>
<span class="l"><a class="anc" name="d693" href="#d693">[d693]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><a class="anc" name="d695" href="#d695">[d695]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUCTRL">PPUCTRL</a></span></span></span>
<span class="l"><a class="anc" name="d698" href="#d698">[d698]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Screen_WriteScrollVertPPUAttrData"></a><div class="cp">;============================================================================
; TODO: Document Screen_WriteScrollVertPPUAttrData
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#SCREEN_WRITESCROLL_HANDLERS_L">SCREEN_WRITESCROLL_HANDLERS_L</a>
;     [$PRG15_MIRROR::d64e]
;============================================================================
</div><span class="l"><a class="anc" name="d699" href="#d699">[d699]</a><a href="#Screen_WriteScrollVertPPUAttrData" class="la">Screen_WriteScrollVertPPUAttrData:</a><span class="ce">; [$d699]</span></span>
<span class="l"><a class="anc" name="d699" href="#d699">[d699]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUAttrAddr_U">Screen_ScrollVertBlocks_PPUAttrAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d69b" href="#d69b">[d69b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d69e" href="#d69e">[d69e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertBlocks_PPUAttrAddr_L">Screen_ScrollVertBlocks_PPUAttrAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d6a0" href="#d6a0">[d6a0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d6a3" href="#d6a3">[d6a3]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d6a5:@_loop"></a><span class="l"><a class="anc" name="d6a5" href="#d6a5">[d6a5]</a><a href="#:d6a5:@_loop" class="lla">@_loop:</a><span class="ce">; [$d6a5]</span></span>
<span class="l"><a class="anc" name="d6a5" href="#d6a5">[d6a5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollVertPPUAttrData">Screen_ScrollVertPPUAttrData</a>,X</span></span></span>
<span class="l"><a class="anc" name="d6a8" href="#d6a8">[d6a8]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><a class="anc" name="d6ab" href="#d6ab">[d6ab]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d6ac" href="#d6ac">[d6ac]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="d6ae" href="#d6ae">[d6ae]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="d6b0" href="#d6b0">[d6b0]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Screen_WriteScrollHorizPPUAttrData"></a><div class="cp">;============================================================================
; TODO: Document Screen_WriteScrollHorizPPUAttrData
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#SCREEN_WRITESCROLL_HANDLERS_L">SCREEN_WRITESCROLL_HANDLERS_L</a>
;     [$PRG15_MIRROR::d64f]
;============================================================================
</div><span class="l"><a class="anc" name="d6b1" href="#d6b1">[d6b1]</a><a href="#Screen_WriteScrollHorizPPUAttrData" class="la">Screen_WriteScrollHorizPPUAttrData:</a><span class="ce">; [$d6b1]</span></span>
<span class="l"><a class="anc" name="d6b1" href="#d6b1">[d6b1]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":d6b3:@_loop"></a><span class="l"><a class="anc" name="d6b3" href="#d6b3">[d6b3]</a><a href="#:d6b3:@_loop" class="lla">@_loop:</a><span class="ce">; [$d6b3]</span></span>
<span class="l"><a class="anc" name="d6b3" href="#d6b3">[d6b3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUAttrAddr_U">Screen_ScrollHorizBlocks_PPUAttrAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d6b5" href="#d6b5">[d6b5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d6b8" href="#d6b8">[d6b8]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d6b9" href="#d6b9">[d6b9]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d6ba" href="#d6ba">[d6ba]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d6bb" href="#d6bb">[d6bb]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d6bc" href="#d6bc">[d6bc]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d6bd" href="#d6bd">[d6bd]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizBlocks_PPUAttrAddr_L">Screen_ScrollHorizBlocks_PPUAttrAddr_L</a></span></span></span>
<span class="l"><a class="anc" name="d6bf" href="#d6bf">[d6bf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="d6c2" href="#d6c2">[d6c2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollHorizPPUAttrData">Screen_ScrollHorizPPUAttrData</a>,X</span></span></span>
<span class="l"><a class="anc" name="d6c5" href="#d6c5">[d6c5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><a class="anc" name="d6c8" href="#d6c8">[d6c8]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d6c9" href="#d6c9">[d6c9]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="d6cb" href="#d6cb">[d6cb]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loop">@_loop</a></span></span></span>
<span class="l"><a class="anc" name="d6cd" href="#d6cd">[d6cd]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_HandleBreakableFloor"></a><div class="cp">;============================================================================
; Handle a breakable floor block the player is standing on.
;
; This is called when the game determines the player is
; standing on a breakable floor block.
;
; The block will be taken through a transition phase,
; depending on the duration in which the player has been
; on the block. This will go through 3 transitions.
;
; The transitions go from:
;
;     0x34 -&gt; 0x2C -&gt; 0x5C -&gt; 0x13
;
; INPUTS:
;     X:
;         The block position to update.
;
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         The block type at the offset.
;
;     <a href="#BREAKABLE_FLOOR_TRANSITIONS">BREAKABLE_FLOOR_TRANSITIONS</a>:
;         Sequence of breakable floor block types.
;
; OUTPUTS:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         The updated screen buffer.
;
;     <a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a>:
;         Updated block type.
;
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;
; XREFS:
;     <a href="#Player_CheckOnBreakableBlock">Player_CheckOnBreakableBlock</a>
;============================================================================
</div><span class="l"><a class="anc" name="d6ce" href="#d6ce">[d6ce]</a><a href="#Area_HandleBreakableFloor" class="la">Area_HandleBreakableFloor:</a><span class="ce">; [$d6ce]</span></span>
<span class="l"><a class="anc" name="d6ce" href="#d6ce">[d6ce]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Temporarily store the block position.</span></span>
<span class="l"><a class="anc" name="d6d0" href="#d6d0">[d6d0]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (loop counter)</span></span>
<span class="l"><a class="anc" name="d6d2" href="#d6d2">[d6d2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; A = block type (value to search for)</span></span>
<span class="l"></span>
<a name=":d6d4:@_checkBlockLoop"></a><span class="l"><a class="anc" name="d6d4" href="#d6d4">[d6d4]</a><a href="#:d6d4:@_checkBlockLoop" class="lla">@_checkBlockLoop:</a><span class="ce">; [$d6d4]</span></span>
<span class="l"><a class="anc" name="d6d4" href="#d6d4">[d6d4]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="#BREAKABLE_FLOOR_TRANSITIONS">BREAKABLE_FLOOR_TRANSITIONS</a>,X</span></span><span class="ce">; Does the block match the table at this index?</span></span>
<span class="l"><a class="anc" name="d6d7" href="#d6d7">[d6d7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_finishLoop">@_finishLoop</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><a class="anc" name="d6d9" href="#d6d9">[d6d9]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Else, X++</span></span>
<span class="l"><a class="anc" name="d6da" href="#d6da">[d6da]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$03</span></span><span class="ce">; Is X &lt; 3?</span></span>
<span class="l"><a class="anc" name="d6dc" href="#d6dc">[d6dc]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_checkBlockLoop">@_checkBlockLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"><a class="anc" name="d6de" href="#d6de">[d6de]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_updateBlocks">@_updateBlocks</a></span></span><span class="ce">; Else, jump to update the block.</span></span>
<span class="l"></span>
<a name=":d6e0:@_finishLoop"></a><span class="l"><a class="anc" name="d6e0" href="#d6e0">[d6e0]</a><a href="#:d6e0:@_finishLoop" class="lla">@_finishLoop:</a><span class="ce">; [$d6e0]</span></span>
<span class="l"><a class="anc" name="d6e0" href="#d6e0">[d6e0]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (table index of block to set)</span></span>
<span class="l"></span>
<a name=":d6e1:@_updateBlocks"></a><span class="l"><a class="anc" name="d6e1" href="#d6e1">[d6e1]</a><a href="#:d6e1:@_updateBlocks" class="lla">@_updateBlocks:</a><span class="ce">; [$d6e1]</span></span>
<span class="l"><a class="anc" name="d6e1" href="#d6e1">[d6e1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#BREAKABLE_FLOOR_TRANSITIONS">BREAKABLE_FLOOR_TRANSITIONS</a>,X</span></span><span class="ce">; Load the block to set to.</span></span>
<span class="l"><a class="anc" name="d6e4" href="#d6e4">[d6e4]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a></span></span><span class="ce">; DEADCODE: This is overridden in <a href="#Area_SetBlocks">Area_SetBlocks</a></span></span>
<span class="l"><a class="anc" name="d6e7" href="#d6e7">[d6e7]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; X = Block position (stored earlier)</span></span>
<span class="l"><a class="anc" name="d6e9" href="#d6e9">[d6e9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store in the screen buffer as the new block.</span></span>
<span class="l"><a class="anc" name="d6ec" href="#d6ec">[d6ec]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; And set it for the area data.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="BREAKABLE_FLOOR_TRANSITIONS"></a><div class="cp">;============================================================================
; Sequence of block types for breakable floor transitions.
;
; XREFS:
;     <a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a>
;
</div><span class="l"><a class="anc" name="d6ef" href="#d6ef">[d6ef]</a><a href="#BREAKABLE_FLOOR_TRANSITIONS" class="la">BREAKABLE_FLOOR_TRANSITIONS:</a><span class="ce">; [$d6ef]</span></span>
<span class="l"><a class="anc" name="d6ef" href="#d6ef">[d6ef]</a><span class="cd"><span class="i">db</span> <span class="o">$34</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<a name="BREAKABLE_FLOOR_TRANSITIONS_1_"></a><div class="c">;
; XREFS:
;     <a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a>
;
</div><span class="l"><a class="anc" name="d6f0" href="#d6f0">[d6f0]</a><a href="#BREAKABLE_FLOOR_TRANSITIONS_1_" class="la">BREAKABLE_FLOOR_TRANSITIONS_1_:</a><span class="ce">; [$d6f0]</span></span>
<span class="l"><a class="anc" name="d6f0" href="#d6f0">[d6f0]</a><span class="cd"><span class="i">db</span> <span class="o">$2c</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<a name="BREAKABLE_FLOOR_TRANSITIONS_2_"></a><div class="c">;
; XREFS:
;     <a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a>
;
</div><span class="l"><a class="anc" name="d6f1" href="#d6f1">[d6f1]</a><a href="#BREAKABLE_FLOOR_TRANSITIONS_2_" class="la">BREAKABLE_FLOOR_TRANSITIONS_2_:</a><span class="ce">; [$d6f1]</span></span>
<span class="l"><a class="anc" name="d6f1" href="#d6f1">[d6f1]</a><span class="cd"><span class="i">db</span> <span class="o">$5c</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d6f2" href="#d6f2">[d6f2]</a><span class="cd"><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SET_BLOCKS_SCREEN_TILEMAP_ADDRS_U"></a><div class="cp">;============================================================================
; Screen PPU start addresses for updating blocks.
;
; This maps a value to the upper byte of the PPU
; start address for use when updating blocks on the
; screen.
;
; This is used in <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>.
;
; XREFS:
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;
</div><span class="l"><a class="anc" name="d6f3" href="#d6f3">[d6f3]</a><a href="#SET_BLOCKS_SCREEN_TILEMAP_ADDRS_U" class="la">SET_BLOCKS_SCREEN_TILEMAP_ADDRS_U:</a><span class="ce">; [$d6f3]</span></span>
<span class="l"><a class="anc" name="d6f3" href="#d6f3">[d6f3]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [0]: Screen 0</span></span>
<span class="l"><a class="anc" name="d6f4" href="#d6f4">[d6f4]</a><span class="cd"><span class="i">db</span> <span class="o">$24</span></span><span class="ce">; [1]: Screen 1</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenPathToMascon"></a><div class="cp">;============================================================================
; Open the path to Mascon.
;
; This will animate the removal of the stone coverings on
; the fountain and then drop down the ladder so it can be
; climbed to Mascon.
;
; INPUTS:
;     <a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a>:
;         The block position of the top of the fountain
;         cover.
;
;     <a href="#GAME_LADDER_TO_MASCON_BLOCK_OFFSETS">GAME_LADDER_TO_MASCON_BLOCK_OFFSETS</a>:
;         The offsets for animating the fountain cover.
;
; OUTPUTS:
;     <a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a>:
;         The number of ladder blocks remaining to place.
;
;     <a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a>:
;         The position of the next ladder block to place.
;
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         The updated screen buffer.
;
; CALLS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;
; XREFS:
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#ScreenEvents_HandlePathToMasconEvent">ScreenEvents_HandlePathToMasconEvent</a>
;============================================================================
</div><span class="l"><a class="anc" name="d6f5" href="#d6f5">[d6f5]</a><a href="#Game_OpenPathToMascon" class="la">Game_OpenPathToMascon:</a><span class="ce">; [$d6f5]</span></span>
<div class="c">;
; Push the stone covering block offset to the stack for later.
;
</div><span class="l"><a class="anc" name="d6f5" href="#d6f5">[d6f5]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="d6f6" href="#d6f6">[d6f6]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the top stone covering.
;
</div><span class="l"><a class="anc" name="d6f7" href="#d6f7">[d6f7]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; X = Block position (in $YX form).</span></span>
<span class="l"><a class="anc" name="d6f9" href="#d6f9">[d6f9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_1_AIR">MASCON_FOUNTAIN_BLOCK_1_AIR</a></span></span><span class="ce">; A = Block ID to place.</span></span>
<span class="l"><a class="anc" name="d6fc" href="#d6fc">[d6fc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store it in the screen buffer at the target location.</span></span>
<span class="l"><a class="anc" name="d6ff" href="#d6ff">[d6ff]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the bottom stone covering.
;
</div><span class="l"><a class="anc" name="d702" href="#d702">[d702]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; X = Block position (in $YX form).</span></span>
<span class="l"><a class="anc" name="d704" href="#d704">[d704]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d705" href="#d705">[d705]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; X += 16 (next row down; YPos += 1).</span></span>
<span class="l"><a class="anc" name="d707" href="#d707">[d707]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d708" href="#d708">[d708]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_2_AIR">MASCON_FOUNTAIN_BLOCK_2_AIR</a></span></span><span class="ce">; A = Block ID to place.</span></span>
<span class="l"><a class="anc" name="d70b" href="#d70b">[d70b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store it in the screen buffer at the target location.</span></span>
<span class="l"><a class="anc" name="d70e" href="#d70e">[d70e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Pop the original stone covering block offset.
;
</div><span class="l"><a class="anc" name="d711" href="#d711">[d711]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack (original block position)</span></span>
<span class="l"><a class="anc" name="d712" href="#d712">[d712]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d713" href="#d713">[d713]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#GAME_LADDER_TO_MASCON_BLOCK_OFFSETS">GAME_LADDER_TO_MASCON_BLOCK_OFFSETS</a>,X</span></span><span class="ce">; A = Block position offset, based on the arguments.</span></span>
<span class="l"><a class="anc" name="d716" href="#d716">[d716]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d717" href="#d717">[d717]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; A += Target block position.</span></span>
<span class="l"><a class="anc" name="d719" href="#d719">[d719]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d71a" href="#d71a">[d71a]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; Update the block position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Place the top stone covering.
;
</div><span class="l"><a class="anc" name="d71c" href="#d71c">[d71c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_1_STONE">MASCON_FOUNTAIN_BLOCK_1_STONE</a></span></span><span class="ce">; A = Stone block.</span></span>
<span class="l"><a class="anc" name="d71f" href="#d71f">[d71f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Place it in the screen buffer at the offset.</span></span>
<span class="l"><a class="anc" name="d722" href="#d722">[d722]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Place the bottom stone covering.
;
</div><span class="l"><a class="anc" name="d725" href="#d725">[d725]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; A = Block position.</span></span>
<span class="l"><a class="anc" name="d727" href="#d727">[d727]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d728" href="#d728">[d728]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16 (next row).</span></span>
<span class="l"><a class="anc" name="d72a" href="#d72a">[d72a]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d72b" href="#d72b">[d72b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_2_STONE">MASCON_FOUNTAIN_BLOCK_2_STONE</a></span></span><span class="ce">; A = Stone block.</span></span>
<span class="l"><a class="anc" name="d72e" href="#d72e">[d72e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Place it in the screen buffer.</span></span>
<span class="l"><a class="anc" name="d731" href="#d731">[d731]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare to animate the dropping of the ladder.
;
</div><span class="l"><a class="anc" name="d734" href="#d734">[d734]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="d736" href="#d736">[d736]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a></span></span><span class="ce">; Set the ladder block count to 7.</span></span>
<span class="l"><a class="anc" name="d738" href="#d738">[d738]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$22</span></span></span>
<span class="l"><a class="anc" name="d73a" href="#d73a">[d73a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; Set the position of the top of the ladder to X=2, Y=2.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the Path to Mascon quest is not yet complete.
;
</div><span class="l"><a class="anc" name="d73c" href="#d73c">[d73c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the completed quests.</span></span>
<span class="l"><a class="anc" name="d73f" href="#d73f">[d73f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Is Path to Mascon completed?</span></span>
<span class="l"><a class="anc" name="d741" href="#d741">[d741]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_clearCoverings">@_clearCoverings</a></span></span><span class="ce">; If it is, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Path to Mascon is not complete. Wait for 30 interrupts.
;
</div><span class="l"><a class="anc" name="d743" href="#d743">[d743]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$1e</span></span><span class="ce">; X = 30 (loop counter)</span></span>
<span class="l"></span>
<a name=":d745:@_waitforInterruptLoop"></a><span class="l"><a class="anc" name="d745" href="#d745">[d745]</a><a href="#:d745:@_waitforInterruptLoop" class="lla">@_waitforInterruptLoop:</a><span class="ce">; [$d745]</span></span>
<span class="l"><a class="anc" name="d745" href="#d745">[d745]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span><span class="ce">; Wait for an interrupt.</span></span>
<span class="l"><a class="anc" name="d748" href="#d748">[d748]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--;</span></span>
<span class="l"><a class="anc" name="d749" href="#d749">[d749]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_waitforInterruptLoop">@_waitforInterruptLoop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d74b:@_clearCoverings"></a><div class="c">;
; Clear the top stone block on the fountain.
;
</div><span class="l"><a class="anc" name="d74b" href="#d74b">[d74b]</a><a href="#:d74b:@_clearCoverings" class="lla">@_clearCoverings:</a><span class="ce">; [$d74b]</span></span>
<span class="l"><a class="anc" name="d74b" href="#d74b">[d74b]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; X = Fountain cover block position.</span></span>
<span class="l"><a class="anc" name="d74d" href="#d74d">[d74d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_1_AIR">MASCON_FOUNTAIN_BLOCK_1_AIR</a></span></span><span class="ce">; A = Air block.</span></span>
<span class="l"><a class="anc" name="d750" href="#d750">[d750]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Set in the screen buffer at the cover position.</span></span>
<span class="l"><a class="anc" name="d753" href="#d753">[d753]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the bottom stone block on the fountain.
;
</div><span class="l"><a class="anc" name="d756" href="#d756">[d756]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; A = Fountain cover block position.</span></span>
<span class="l"><a class="anc" name="d758" href="#d758">[d758]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d759" href="#d759">[d759]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16 (next row).</span></span>
<span class="l"><a class="anc" name="d75b" href="#d75b">[d75b]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d75c" href="#d75c">[d75c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#MASCON_FOUNTAIN_BLOCK_2_AIR">MASCON_FOUNTAIN_BLOCK_2_AIR</a></span></span><span class="ce">; A = Air block.</span></span>
<span class="l"><a class="anc" name="d75f" href="#d75f">[d75f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Set in the screen buffer at the cover position.</span></span>
<span class="l"><a class="anc" name="d762" href="#d762">[d762]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update the block on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Drop the ladder to the path to Mascon.
;
</div><span class="l"><a class="anc" name="d765" href="#d765">[d765]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a></span></span><span class="ce">; Drop the ladder.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="MASCON_FOUNTAIN_BLOCK_1_AIR"></a><div class="cp">;============================================================================
; Two cleared fountain stone block coverings.
;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a class="anc" name="d768" href="#d768">[d768]</a><a href="#MASCON_FOUNTAIN_BLOCK_1_AIR" class="la">MASCON_FOUNTAIN_BLOCK_1_AIR:</a><span class="ce">; [$d768]</span></span>
<span class="l"><a class="anc" name="d768" href="#d768">[d768]</a><span class="cd"><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; Air</span></span>
<span class="l"></span>
<a name="MASCON_FOUNTAIN_BLOCK_2_AIR"></a><div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a class="anc" name="d769" href="#d769">[d769]</a><a href="#MASCON_FOUNTAIN_BLOCK_2_AIR" class="la">MASCON_FOUNTAIN_BLOCK_2_AIR:</a><span class="ce">; [$d769]</span></span>
<span class="l"><a class="anc" name="d769" href="#d769">[d769]</a><span class="cd"><span class="i">db</span> <span class="o">$42</span></span><span class="ce">; Air</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="MASCON_FOUNTAIN_BLOCK_1_STONE"></a><div class="cp">;============================================================================
; Two set fountain stone block coverings.
;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a class="anc" name="d76a" href="#d76a">[d76a]</a><a href="#MASCON_FOUNTAIN_BLOCK_1_STONE" class="la">MASCON_FOUNTAIN_BLOCK_1_STONE:</a><span class="ce">; [$d76a]</span></span>
<span class="l"><a class="anc" name="d76a" href="#d76a">[d76a]</a><span class="cd"><span class="i">db</span> <span class="o">$88</span></span><span class="ce">; Stone cover</span></span>
<span class="l"></span>
<a name="MASCON_FOUNTAIN_BLOCK_2_STONE"></a><div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a class="anc" name="d76b" href="#d76b">[d76b]</a><a href="#MASCON_FOUNTAIN_BLOCK_2_STONE" class="la">MASCON_FOUNTAIN_BLOCK_2_STONE:</a><span class="ce">; [$d76b]</span></span>
<span class="l"><a class="anc" name="d76b" href="#d76b">[d76b]</a><span class="cd"><span class="i">db</span> <span class="o">$88</span></span><span class="ce">; Stone cover</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="GAME_LADDER_TO_MASCON_BLOCK_OFFSETS"></a><div class="cp">;============================================================================
; Lookup table for quickly calculating a relative X or Y position for placing
; a block.
;
; At index 0, X will be incremented by 1.
;
; At index 1, Y will be incremented by 1 (screen wrap-around).
;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
</div><span class="l"><a class="anc" name="d76c" href="#d76c">[d76c]</a><a href="#GAME_LADDER_TO_MASCON_BLOCK_OFFSETS" class="la">GAME_LADDER_TO_MASCON_BLOCK_OFFSETS:</a><span class="ce">; [$d76c]</span></span>
<span class="l"><a class="anc" name="d76c" href="#d76c">[d76c]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]: X + 1</span></span>
<span class="l"><a class="anc" name="d76d" href="#d76d">[d76d]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [1]: Y + 1</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_DropLadderToMascon"></a><div class="cp">;============================================================================
; Drop the ladder down to open the path to Mascon.
;
; This will animate placing all the ladder blocks, clearing
; a path up to the door to Mascon.
;
; Despite this only ever being called from the screen leading
; to Mascon, this will first check if it's on that screen.
; This appears to be code from some older design.
;
; INPUTS:
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The current region.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen.
;
;     <a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a>:
;         The starting ladder position to place.
;
;     <a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a>:
;         The total number of ladder blocks to place.
;
; OUTPUTS:
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         The updated screen buffer.
;
;     <a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a>:
;     <a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a>:
;         Clobbered.
;
;     <a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a>:
;         Cleared (0).
;
; CALLS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;
; XREFS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;============================================================================
</div><span class="l"><a class="anc" name="d76e" href="#d76e">[d76e]</a><a href="#Game_DropLadderToMascon" class="la">Game_DropLadderToMascon:</a><span class="ce">; [$d76e]</span></span>
<div class="c">;
; Check if we're on the screen with the path to Mascon.
;
; NOTE: This is only ever called from this screen,
;       so it's interesting that this check exists.
;
</div><span class="l"><a class="anc" name="d76e" href="#d76e">[d76e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Load the current region.</span></span>
<span class="l"><a class="anc" name="d771" href="#d771">[d771]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Are we in Trunk?</span></span>
<span class="l"><a class="anc" name="d773" href="#d773">[d773]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_dropLadderLoop">@_dropLadderLoop</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"><a class="anc" name="d775" href="#d775">[d775]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Load the current screen.</span></span>
<span class="l"><a class="anc" name="d777" href="#d777">[d777]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$28</span></span><span class="ce">; Is it the screen with the blocked path?</span></span>
<span class="l"><a class="anc" name="d779" href="#d779">[d779]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_dropLadderLoop">@_dropLadderLoop</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're on the right screen. Mark the path as opened.
;
</div><span class="l"><a class="anc" name="d77b" href="#d77b">[d77b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the quests.</span></span>
<span class="l"><a class="anc" name="d77e" href="#d77e">[d77e]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$20</span></span><span class="ce">; Mark the path to Mascon opened.</span></span>
<span class="l"><a class="anc" name="d780" href="#d780">[d780]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d783:@_dropLadderLoop"></a><div class="c">;
; Wait for 4 interrupts.
;
</div><span class="l"><a class="anc" name="d783" href="#d783">[d783]</a><a href="#:d783:@_dropLadderLoop" class="lla">@_dropLadderLoop:</a><span class="ce">; [$d783]</span></span>
<span class="l"><a class="anc" name="d783" href="#d783">[d783]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"><a class="anc" name="d786" href="#d786">[d786]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"><a class="anc" name="d789" href="#d789">[d789]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"><a class="anc" name="d78c" href="#d78c">[d78c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the Drop Ladder sound effect.
;
</div><span class="l"><a class="anc" name="d78f" href="#d78f">[d78f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$17</span></span><span class="ce">; 0x17 == Drop ladder sound effect.</span></span>
<span class="l"><a class="anc" name="d791" href="#d791">[d791]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound effect.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Place the ladder block.
;
</div><span class="l"><a class="anc" name="d794" href="#d794">[d794]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; X = Next ladder block position.</span></span>
<span class="l"><a class="anc" name="d796" href="#d796">[d796]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="#DROP_LADDER_TO_MASCON_LADDER_BLOCK">DROP_LADDER_TO_MASCON_LADDER_BLOCK</a></span></span><span class="ce">; A = Ladder block.</span></span>
<span class="l"><a class="anc" name="d799" href="#d799">[d799]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Store in the screen buffer at X.</span></span>
<span class="l"><a class="anc" name="d79c" href="#d79c">[d79c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span><span class="ce">; Update blocks on the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increment the ladder position, decrement the number of blocks
; to place, and loop.
;
</div><span class="l"><a class="anc" name="d79f" href="#d79f">[d79f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; A = Ladder position.</span></span>
<span class="l"><a class="anc" name="d7a1" href="#d7a1">[d7a1]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d7a2" href="#d7a2">[d7a2]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; A += 16 (next row)</span></span>
<span class="l"><a class="anc" name="d7a4" href="#d7a4">[d7a4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_LadderPos">PathToMascon_LadderPos</a></span></span><span class="ce">; Store as the new position.</span></span>
<span class="l"><a class="anc" name="d7a6" href="#d7a6">[d7a6]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#PathToMascon_LadderBlocksRemaining">PathToMascon_LadderBlocksRemaining</a></span></span><span class="ce">; Decrement the number of ladder blocks to place.</span></span>
<span class="l"><a class="anc" name="d7a8" href="#d7a8">[d7a8]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_dropLadderLoop">@_dropLadderLoop</a></span></span><span class="ce">; If there are still blocks remaining, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the "Opening Path" flag.
;
</div><span class="l"><a class="anc" name="d7aa" href="#d7aa">[d7aa]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d7ac" href="#d7ac">[d7ac]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a></span></span><span class="ce">; Set opening to 0.</span></span>
<span class="l"><a class="anc" name="d7ae" href="#d7ae">[d7ae]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="DROP_LADDER_TO_MASCON_LADDER_BLOCK"></a><div class="c">;
; XREFS:
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;
</div><span class="l"><a class="anc" name="d7af" href="#d7af">[d7af]</a><a href="#DROP_LADDER_TO_MASCON_LADDER_BLOCK" class="la">DROP_LADDER_TO_MASCON_LADDER_BLOCK:</a><span class="ce">; [$d7af]</span></span>
<span class="l"><a class="anc" name="d7af" href="#d7af">[d7af]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; Ladder block</span></span>
<span class="l"></span>
</pre><pre><a name="SpriteBehavior_EnemyUnused18_SomethingSetBlocks"></a><div class="cp">;============================================================================
; TODO: Document SpriteBehavior_EnemyUnused18_SomethingSetBlocks
;
; INPUTS:
;     X
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG14.html#SpriteBehavior_EnemyUnused18__9991">SpriteBehavior_EnemyUnused18__9991</a>
;============================================================================
</div><span class="l"><a class="anc" name="d7b0" href="#d7b0">[d7b0]</a><a href="#SpriteBehavior_EnemyUnused18_SomethingSetBlocks" class="la">SpriteBehavior_EnemyUnused18_SomethingSetBlocks:</a><span class="ce">; [$d7b0]</span></span>
<span class="l"><a class="anc" name="d7b0" href="#d7b0">[d7b0]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d7b1" href="#d7b1">[d7b1]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d7b2" href="#d7b2">[d7b2]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="d7b3" href="#d7b3">[d7b3]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d7b4" href="#d7b4">[d7b4]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Something_UnusedSprite_ScreenBufferOffset">Something_UnusedSprite_ScreenBufferOffset</a></span></span></span>
<span class="l"><a class="anc" name="d7b7" href="#d7b7">[d7b7]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Something_UnusedSprite_BlockOffset">Something_UnusedSprite_BlockOffset</a></span></span></span>
<span class="l"><a class="anc" name="d7ba" href="#d7ba">[d7ba]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="d7bd" href="#d7bd">[d7bd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks">Area_SetBlocks</a></span></span></span>
<span class="l"><a class="anc" name="d7c0" href="#d7c0">[d7c0]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d7c1" href="#d7c1">[d7c1]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d7c2" href="#d7c2">[d7c2]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d7c3" href="#d7c3">[d7c3]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d7c4" href="#d7c4">[d7c4]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_SetBlocks"></a><div class="cp">;============================================================================
; TODO: Document Area_SetBlocks
;
; INPUTS:
;     A
;     X
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a>
;     <a href="#Game_DropLadderToMascon">Game_DropLadderToMascon</a>
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#SpriteBehavior_EnemyUnused18_SomethingSetBlocks">SpriteBehavior_EnemyUnused18_SomethingSetBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d7c5" href="#d7c5">[d7c5]</a><a href="#Area_SetBlocks" class="la">Area_SetBlocks:</a><span class="ce">; [$d7c5]</span></span>
<span class="l"><a class="anc" name="d7c5" href="#d7c5">[d7c5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a></span></span></span>
<span class="l"><a class="anc" name="d7c8" href="#d7c8">[d7c8]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d7ca" href="#d7ca">[d7ca]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d7cb" href="#d7cb">[d7cb]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d7cc" href="#d7cc">[d7cc]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d7cf" href="#d7cf">[d7cf]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d7d0" href="#d7d0">[d7d0]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="d7d2" href="#d7d2">[d7d2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d7d5" href="#d7d5">[d7d5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="d7d7" href="#d7d7">[d7d7]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="d7d8" href="#d7d8">[d7d8]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d7d9" href="#d7d9">[d7d9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetPPUAddrForBlockIndex">Area_SetPPUAddrForBlockIndex</a></span></span></span>
<span class="l"><a class="anc" name="d7dc" href="#d7dc">[d7dc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks_WriteBlockData12">Area_SetBlocks_WriteBlockData12</a></span></span></span>
<span class="l"><a class="anc" name="d7df" href="#d7df">[d7df]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d7e2" href="#d7e2">[d7e2]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d7e3" href="#d7e3">[d7e3]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="d7e5" href="#d7e5">[d7e5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d7e8" href="#d7e8">[d7e8]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d7eb" href="#d7eb">[d7eb]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d7ed" href="#d7ed">[d7ed]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d7f0" href="#d7f0">[d7f0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks_WriteBlockData34">Area_SetBlocks_WriteBlockData34</a></span></span></span>
<span class="l"><a class="anc" name="d7f3" href="#d7f3">[d7f3]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d7f4" href="#d7f4">[d7f4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a></span></span></span>
<span class="l"><a class="anc" name="d7f7" href="#d7f7">[d7f7]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d7f8" href="#d7f8">[d7f8]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d7f9" href="#d7f9">[d7f9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="d7fc" href="#d7fc">[d7fc]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="d7fd" href="#d7fd">[d7fd]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="d7fe" href="#d7fe">[d7fe]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_SetBlocks_WriteBlockData12"></a><div class="cp">;============================================================================
; Write two blocks from area data 1 and 2 to the PPU buffer.
;
; This will load two tiles from the area data from
; <a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a> and
; <a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a> at offset
; <a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a> and write them to the PPU
; buffer at the provided offset.
;
; INPUTS:
;     X:
;         The offset within the PPU buffer to write to.
;
;     <a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>:
;         The block data used for the first block.
;
;     <a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>:
;         The block data used for the second block.
;
;     <a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a>:
;         The offset within the area block data to read from.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The updated PPU buffer.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The updated upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d7ff" href="#d7ff">[d7ff]</a><a href="#Area_SetBlocks_WriteBlockData12" class="la">Area_SetBlocks_WriteBlockData12:</a><span class="ce">; [$d7ff]</span></span>
<div class="c">;
; Set the tile length to 2.
;
</div><span class="l"><a class="anc" name="d7ff" href="#d7ff">[d7ff]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="d801" href="#d801">[d801]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Write length of 2.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the first block and write to the PPU.
;
</div><span class="l"><a class="anc" name="d804" href="#d804">[d804]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a></span></span><span class="ce">; Load the block position within the level.</span></span>
<span class="l"><a class="anc" name="d807" href="#d807">[d807]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>),Y</span></span><span class="ce">; Load the block at that position.</span></span>
<span class="l"><a class="anc" name="d809" href="#d809">[d809]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store it the PPU buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the second block and write to the PPU.
;
</div><span class="l"><a class="anc" name="d80c" href="#d80c">[d80c]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="d80d" href="#d80d">[d80d]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData2StartAddr">CurrentArea_BlockData2StartAddr</a>),Y</span></span><span class="ce">; Load the block position within the level.</span></span>
<span class="l"><a class="anc" name="d80f" href="#d80f">[d80f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Load the block at that position.Store it the PPU buffer.</span></span>
<span class="l"><a class="anc" name="d812" href="#d812">[d812]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the new upper bounds of the buffer.
;
</div><span class="l"><a class="anc" name="d813" href="#d813">[d813]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Set X as the new upper bounds of the PPU buffer.</span></span>
<span class="l"><a class="anc" name="d815" href="#d815">[d815]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_SetBlocks_WriteBlockData34"></a><div class="cp">;============================================================================
; Write two blocks from area data 3 and 4 to the PPU buffer.
;
; This will load two tiles from the area data from
; <a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a> and
; <a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a> at offset
; <a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a> and write them to the PPU
; buffer at the provided offset.
;
; INPUTS:
;     X:
;         The offset within the PPU buffer to write to.
;
;     <a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>:
;         The block data used for the first block.
;
;     <a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>:
;         The block data used for the second block.
;
;     <a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a>:
;         The offset within the area block data to read from.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The updated PPU buffer.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The updated upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d816" href="#d816">[d816]</a><a href="#Area_SetBlocks_WriteBlockData34" class="la">Area_SetBlocks_WriteBlockData34:</a><span class="ce">; [$d816]</span></span>
<div class="c">;
; Set the tile length to 2.
;
</div><span class="l"><a class="anc" name="d816" href="#d816">[d816]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="d818" href="#d818">[d818]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the first block and write to the PPU.
;
</div><span class="l"><a class="anc" name="d81b" href="#d81b">[d81b]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a></span></span></span>
<span class="l"><a class="anc" name="d81e" href="#d81e">[d81e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData3StartAddr">CurrentArea_BlockData3StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d820" href="#d820">[d820]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the second block and write to the PPU.
;
</div><span class="l"><a class="anc" name="d823" href="#d823">[d823]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="d824" href="#d824">[d824]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockData4StartAddr">CurrentArea_BlockData4StartAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="d826" href="#d826">[d826]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="d829" href="#d829">[d829]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the new upper bounds of the buffer.
;
</div><span class="l"><a class="anc" name="d82a" href="#d82a">[d82a]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="d82c" href="#d82c">[d82c]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Area_SetBlocks_SetAttributes"></a><div class="cp">;============================================================================
; TODO: Document Area_SetBlocks_SetAttributes
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d82d" href="#d82d">[d82d]</a><a href="#Area_SetBlocks_SetAttributes" class="la">Area_SetBlocks_SetAttributes:</a><span class="ce">; [$d82d]</span></span>
<div class="c">;
; Create a normalized offset from the index.
;
; This will be the index + 32.
;
; Effectively, this is ensuring we always have bit 5
; set, and are starting at a value of &gt;= 32 for the
; bit math.
;
</div><span class="l"><a class="anc" name="d82d" href="#d82d">[d82d]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d82e" href="#d82e">[d82e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$20</span></span><span class="ce">; A = index + 32</span></span>
<span class="l"><a class="anc" name="d830" href="#d830">[d830]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Create a floored offset from the index.
;
; This will be one of 0, 8, 16, 24, 32, 40, 48, or 56.
; It will be stored in <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a> for later.
;
</div><span class="l"><a class="anc" name="d832" href="#d832">[d832]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; A = A / 4</span></span>
<span class="l"><a class="anc" name="d833" href="#d833">[d833]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d834" href="#d834">[d834]</a><span class="cd"><span class="i">AND</span> <span class="o">#$38</span></span><span class="ce">; Round down to a multiple of 8.</span></span>
<span class="l"><a class="anc" name="d836" href="#d836">[d836]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the lower starting byte for the PPU address.
;
; This is where the block will be written to on the
; screen.
;
; Result is the floored offset (multiple of 8) OR'd
; with half the lower nibble of the normalized offset.
;
</div><span class="l"><a class="anc" name="d839" href="#d839">[d839]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; A = normalized offset.</span></span>
<span class="l"><a class="anc" name="d83b" href="#d83b">[d83b]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; A = lower nibble of A.</span></span>
<span class="l"><a class="anc" name="d83d" href="#d83d">[d83d]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; A = A / 2</span></span>
<span class="l"><a class="anc" name="d83e" href="#d83e">[d83e]</a><span class="cd"><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; OR with the floored offset.</span></span>
<span class="l"><a class="anc" name="d841" href="#d841">[d841]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute a corner index (0..3) based on the offset.
;
; The corner is composed of bits 0 and 4, packed into
; 2 bits. So:
;
;     0000 0000 == 0
;     0000 0001 == 1
;     0001 0000 == 2
;     0001 0001 == 3
;
</div><span class="l"><a class="anc" name="d844" href="#d844">[d844]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; A = normalized offset.</span></span>
<span class="l"><a class="anc" name="d846" href="#d846">[d846]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Keep bit 4 (result = 0 or 16)</span></span>
<span class="l"><a class="anc" name="d848" href="#d848">[d848]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Convert to value 0 or 2.</span></span>
<span class="l"><a class="anc" name="d849" href="#d849">[d849]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d84a" href="#d84a">[d84a]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d84b" href="#d84b">[d84b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Store the result.</span></span>
<span class="l"><a class="anc" name="d84d" href="#d84d">[d84d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; A = floored offset.</span></span>
<span class="l"><a class="anc" name="d84f" href="#d84f">[d84f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep bit 0 (result = 0 or 1).</span></span>
<span class="l"><a class="anc" name="d851" href="#d851">[d851]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; OR with the value we just calculated (result = 0..3)</span></span>
<span class="l"><a class="anc" name="d853" href="#d853">[d853]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the block attributes for this block.
;
</div><span class="l"><a class="anc" name="d855" href="#d855">[d855]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Arg_BlockAttributesIndex">Arg_BlockAttributesIndex</a></span></span><span class="ce">; Y = block attributes index for the new block.</span></span>
<span class="l"><a class="anc" name="d858" href="#d858">[d858]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span><span class="ce">; A = block attributes for that index.</span></span>
<span class="l"><a class="anc" name="d85a" href="#d85a">[d85a]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; X = corner (0..3 value from above).</span></span>
<span class="l"><a class="anc" name="d85c" href="#d85c">[d85c]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="#SET_BLOCKS_TILE_CORNER_MASK">SET_BLOCKS_TILE_CORNER_MASK</a>,X</span></span><span class="ce">; A = block attributes for the given corner.</span></span>
<span class="l"><a class="anc" name="d85f" href="#d85f">[d85f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Get the screen index we're drawing to.
;
</div><span class="l"><a class="anc" name="d860" href="#d860">[d860]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span><span class="ce">; A = Scroll screen to update.</span></span>
<span class="l"><a class="anc" name="d862" href="#d862">[d862]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the right-most bit (0 or 1)</span></span>
<span class="l"><a class="anc" name="d864" href="#d864">[d864]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = result as an index for the lookup tables.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute a start address for that screen.
;
; NOTE: Despite using a lookup table, this will always
;       be $0242 (<a href="RAM.html#TextBox_AttributeData">TextBox_AttributeData</a>), since all
;       values in the tables are the same for all indexes.
;
;       This is code that could be optimized away.
;
</div><span class="l"><a class="anc" name="d865" href="#d865">[d865]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_TILEMAP_OFFSETS_L">SET_BLOCKS_TILEMAP_OFFSETS_L</a>,X</span></span><span class="ce">; A = lower byte of PPU address</span></span>
<span class="l"><a class="anc" name="d868" href="#d868">[d868]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="d86a" href="#d86a">[d86a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_TILEMAP_OFFSETS_U">SET_BLOCKS_TILEMAP_OFFSETS_U</a>,X</span></span><span class="ce">; A = upper byte of PPU address</span></span>
<span class="l"><a class="anc" name="d86d" href="#d86d">[d86d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the upper starting byte for the PPU address.
;
</div><span class="l"><a class="anc" name="d86f" href="#d86f">[d86f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SET_BLOCKS_SCREEN_TILEMAP_ADDRS_U">SET_BLOCKS_SCREEN_TILEMAP_ADDRS_U</a>,X</span></span><span class="ce">; A = tilemap address for the screen.</span></span>
<span class="l"><a class="anc" name="d872" href="#d872">[d872]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store as the upper byte of the tilemap address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Combine the new data for this corner with the existing
; data.
;
</div><span class="l"><a class="anc" name="d875" href="#d875">[d875]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Y = lower byte of tilemap address computed above.</span></span>
<span class="l"><a class="anc" name="d878" href="#d878">[d878]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the data for this block.</span></span>
<span class="l"><a class="anc" name="d87a" href="#d87a">[d87a]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; X = corner value (0..3)</span></span>
<span class="l"><a class="anc" name="d87c" href="#d87c">[d87c]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="#SET_BLOCKS_TILE_CORNER_MASK_INVERT">SET_BLOCKS_TILE_CORNER_MASK_INVERT</a>,X</span></span><span class="ce">; Invert the corner mask (keep all non-updated corner data).</span></span>
<span class="l"><a class="anc" name="d87f" href="#d87f">[d87f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; Store as the new value.</span></span>
<span class="l"><a class="anc" name="d881" href="#d881">[d881]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the updated block attributes for the corner.</span></span>
<span class="l"><a class="anc" name="d882" href="#d882">[d882]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_06">Temp_06</a></span></span><span class="ce">; OR it with the non-updating corner values.</span></span>
<span class="l"><a class="anc" name="d884" href="#d884">[d884]</a><span class="cd"><span class="i">STA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="d886" href="#d886">[d886]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; And push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Create a final PPU attribute target address to draw to.
;
; This is going to be an address starting at $23C0.
;
</div><span class="l"><a class="anc" name="d887" href="#d887">[d887]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Load the upper byte of the PPU address.</span></span>
<span class="l"><a class="anc" name="d88a" href="#d88a">[d88a]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$03</span></span><span class="ce">; Ensure it starts at 0x03 (address &gt;= $03XX).

Realistically, $23C0 (we guarantee 0x20 or 0x24 above for the screen).</span></span>
<span class="l"><a class="anc" name="d88c" href="#d88c">[d88c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"><a class="anc" name="d88f" href="#d88f">[d88f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Load the lower byte.</span></span>
<span class="l"><a class="anc" name="d892" href="#d892">[d892]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$c0</span></span><span class="ce">; Ensure it starts at 0xC0 (address &gt;= $XXC0)</span></span>
<span class="l"><a class="anc" name="d894" href="#d894">[d894]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write the attribute data to the PPU buffer.
;
</div><span class="l"><a class="anc" name="d897" href="#d897">[d897]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d899" href="#d899">[d899]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue 1 byte.</span></span>
<span class="l"><a class="anc" name="d89c" href="#d89c">[d89c]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the attribute data to write from stack.</span></span>
<span class="l"><a class="anc" name="d89d" href="#d89d">[d89d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store it in the buffer at X.</span></span>
<span class="l"><a class="anc" name="d8a0" href="#d8a0">[d8a0]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (new offset)</span></span>
<span class="l"><a class="anc" name="d8a1" href="#d8a1">[d8a1]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="d8a3" href="#d8a3">[d8a3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="SET_BLOCKS_TILE_CORNER_MASK"></a><div class="c">;
; XREFS:
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;
</div><span class="l"><a class="anc" name="d8a4" href="#d8a4">[d8a4]</a><a href="#SET_BLOCKS_TILE_CORNER_MASK" class="la">SET_BLOCKS_TILE_CORNER_MASK:</a><span class="ce">; [$d8a4]</span></span>
<span class="l"><a class="anc" name="d8a4" href="#d8a4">[d8a4]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d8a5" href="#d8a5">[d8a5]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d8a6" href="#d8a6">[d8a6]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d8a7" href="#d8a7">[d8a7]</a><span class="cd"><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<a name="SET_BLOCKS_TILE_CORNER_MASK_INVERT"></a><div class="c">;
; XREFS:
;     <a href="#Area_SetBlocks_SetAttributes">Area_SetBlocks_SetAttributes</a>
;
</div><span class="l"><a class="anc" name="d8a8" href="#d8a8">[d8a8]</a><a href="#SET_BLOCKS_TILE_CORNER_MASK_INVERT" class="la">SET_BLOCKS_TILE_CORNER_MASK_INVERT:</a><span class="ce">; [$d8a8]</span></span>
<span class="l"><a class="anc" name="d8a8" href="#d8a8">[d8a8]</a><span class="cd"><span class="i">db</span> <span class="o">$fc</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d8a9" href="#d8a9">[d8a9]</a><span class="cd"><span class="i">db</span> <span class="o">$f3</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="d8aa" href="#d8aa">[d8aa]</a><span class="cd"><span class="i">db</span> <span class="o">$cf</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="d8ab" href="#d8ab">[d8ab]</a><span class="cd"><span class="i">db</span> <span class="o">$3f</span></span><span class="ce">; [3]:</span></span>
</pre><pre><a name="Area_SetPPUAddrForBlockIndex"></a><div class="cp">;============================================================================
; TODO: Document Area_SetPPUAddrForBlockIndex
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_SetBlocks">Area_SetBlocks</a>
;============================================================================
</div><span class="l"><a class="anc" name="d8ac" href="#d8ac">[d8ac]</a><a href="#Area_SetPPUAddrForBlockIndex" class="la">Area_SetPPUAddrForBlockIndex:</a><span class="ce">; [$d8ac]</span></span>
<div class="c">;
; Build an address based on the X, Y position.
;
; X = X * 2
; Y = Y * 4
;
</div><span class="l"><a class="anc" name="d8ac" href="#d8ac">[d8ac]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d8ae" href="#d8ae">[d8ae]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8b1" href="#d8b1">[d8b1]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d8b2" href="#d8b2">[d8b2]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="d8b4" href="#d8b4">[d8b4]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d8b5" href="#d8b5">[d8b5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d8b8" href="#d8b8">[d8b8]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="d8b9" href="#d8b9">[d8b9]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="d8bb" href="#d8bb">[d8bb]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d8bc" href="#d8bc">[d8bc]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8bf" href="#d8bf">[d8bf]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="d8c0" href="#d8c0">[d8c0]</a><span class="cd"><span class="i">ROL</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8c3" href="#d8c3">[d8c3]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d8c4" href="#d8c4">[d8c4]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d8c7" href="#d8c7">[d8c7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d8ca" href="#d8ca">[d8ca]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span></span>
<span class="l"><a class="anc" name="d8cc" href="#d8cc">[d8cc]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="d8ce" href="#d8ce">[d8ce]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="d8cf" href="#d8cf">[d8cf]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8d2" href="#d8d2">[d8d2]</a><span class="cd"><span class="i">ORA</span> <span class="o">$d8ea,Y</span></span></span>
<span class="l"><a class="anc" name="d8d5" href="#d8d5">[d8d5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8d8" href="#d8d8">[d8d8]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d8db" href="#d8db">[d8db]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="d8dc" href="#d8dc">[d8dc]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="d8de" href="#d8de">[d8de]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="d8e1" href="#d8e1">[d8e1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8e4" href="#d8e4">[d8e4]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d8e6" href="#d8e6">[d8e6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="d8e9" href="#d8e9">[d8e9]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__d8ea"></a><div class="c">;
; XREFS:
;     <a href="#Area_SetPPUAddrForBlockIndex">Area_SetPPUAddrForBlockIndex</a>
;
</div><span class="l"><a class="anc" name="d8ea" href="#d8ea">[d8ea]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__d8ea" class="la">BYTE_ARRAY_PRG15_MIRROR__d8ea:</a><span class="ce">; [$d8ea]</span></span>
<span class="l"><a class="anc" name="d8ea" href="#d8ea">[d8ea]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="d8eb" href="#d8eb">[d8eb]</a><span class="cd"><span class="i">db</span> <span class="o">$24</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_HandleDeath"></a><div class="cp">;============================================================================
; Reset the state for the player upon death.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
; OUTPUTS:
;     <a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a>:
;     <a href="RAM.html#Player_MovementTick">Player_MovementTick</a>:
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         Cleared.
;
; CALLS:
;     <a href="#Screen_ClearSprites">Screen_ClearSprites</a>
;     <a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a>
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a>
;     <a href="PRG14.html#PlayerDeath_ResetSelectedItemState">PlayerDeath_ResetSelectedItemState</a>
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;     <a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;     <a href="#Screen_NextTransitionState">Screen_NextTransitionState</a>
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="d8ec" href="#d8ec">[d8ec]</a><a href="#Player_HandleDeath" class="la">Player_HandleDeath:</a><span class="ce">; [$d8ec]</span></span>
<span class="l"><a class="anc" name="d8ec" href="#d8ec">[d8ec]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><a class="anc" name="d8ee" href="#d8ee">[d8ee]</a><span class="cd"><span class="i">TXS</span></span><span class="ce">; Set as stack pointer</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14 (Logic)
;
</div><span class="l"><a class="anc" name="d8ef" href="#d8ef">[d8ef]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><a class="anc" name="d8f1" href="#d8f1">[d8f1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 14.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear all player bits but the facing direction.
;
</div><span class="l"><a class="anc" name="d8f4" href="#d8f4">[d8f4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="d8f6" href="#d8f6">[d8f6]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Remove all but the facing direction bit.</span></span>
<span class="l"><a class="anc" name="d8f8" href="#d8f8">[d8f8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear out more player state.
;
</div><span class="l"><a class="anc" name="d8fa" href="#d8fa">[d8fa]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d8fc" href="#d8fc">[d8fc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Set player status to 0.</span></span>
<span class="l"><a class="anc" name="d8fe" href="#d8fe">[d8fe]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span><span class="ce">; Set the movement tick to 0.</span></span>
<span class="l"><a class="anc" name="d900" href="#d900">[d900]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Set invincibility phase to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Push the inventory state to the stack.
;
</div><span class="l"><a class="anc" name="d902" href="#d902">[d902]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Load the selected weapon.</span></span>
<span class="l"><a class="anc" name="d905" href="#d905">[d905]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="d906" href="#d906">[d906]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span><span class="ce">; Load the selected armor.</span></span>
<span class="l"><a class="anc" name="d909" href="#d909">[d909]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="d90a" href="#d90a">[d90a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Load the selected shield.</span></span>
<span class="l"><a class="anc" name="d90d" href="#d90d">[d90d]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="d90e" href="#d90e">[d90e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedMagic">SelectedMagic</a></span></span><span class="ce">; Load the selected magic.</span></span>
<span class="l"><a class="anc" name="d911" href="#d911">[d911]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="d912" href="#d912">[d912]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="d915" href="#d915">[d915]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait for interrupt and call other functions to
; reset state.
;
</div><span class="l"><a class="anc" name="d916" href="#d916">[d916]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span><span class="ce">; Wait for interrupt.</span></span>
<span class="l"><a class="anc" name="d919" href="#d919">[d919]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span><span class="ce">; Reset animations.</span></span>
<span class="l"><a class="anc" name="d91c" href="#d91c">[d91c]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7bf</span></span><span class="ce">; Reset selected item state.</span></span>
<span class="l"><a class="anc" name="d91f" href="#d91f">[d91f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawSprite">Player_DrawSprite</a></span></span><span class="ce">; Update player sprite.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare state for screen transitions.
;
</div><span class="l"><a class="anc" name="d922" href="#d922">[d922]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d924" href="#d924">[d924]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Clear the screen transition counter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reset the player death state.
;
</div><span class="l"><a class="anc" name="d927" href="#d927">[d927]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span><span class="ce">; Clear the dead flag.</span></span>
<span class="l"><a class="anc" name="d92a" href="#d92a">[d92a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="d92c" href="#d92c">[d92c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Clear the death animation phase.</span></span>
<span class="l"><a class="anc" name="d92f" href="#d92f">[d92f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Clear the death animation counter.</span></span>
<span class="l"><a class="anc" name="d932" href="#d932">[d932]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span><span class="ce">; Clear the palette index.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the sprites and music.
;
</div><span class="l"><a class="anc" name="d935" href="#d935">[d935]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ClearSprites">Screen_ClearSprites</a></span></span><span class="ce">; Clear sprites from the screen.</span></span>
<span class="l"><a class="anc" name="d938" href="#d938">[d938]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d93a" href="#d93a">[d93a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Clear the music.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the death sound effect.
;
</div><span class="l"><a class="anc" name="d93c" href="#d93c">[d93c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$16</span></span><span class="ce">; 0x16 == Player death sound.</span></span>
<span class="l"><a class="anc" name="d93e" href="#d93e">[d93e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play the sound effect.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d941:@_dissolvePlayerLoop"></a><div class="c">;
; Begin our death animation loop.
;
; This will dissolve the user's sprite.
;
</div><span class="l"><a class="anc" name="d941" href="#d941">[d941]</a><a href="#:d941:@_dissolvePlayerLoop" class="lla">@_dissolvePlayerLoop:</a><span class="ce">; [$d941]</span></span>
<span class="l"><a class="anc" name="d941" href="#d941">[d941]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="d944" href="#d944">[d944]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span><span class="ce">; Reset animations.</span></span>
<span class="l"><a class="anc" name="d947" href="#d947">[d947]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_NextTransitionState">Screen_NextTransitionState</a></span></span><span class="ce">; Prepare for the next screen state.</span></span>
<span class="l"><a class="anc" name="d94a" href="#d94a">[d94a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the player.</span></span>
<span class="l"><a class="anc" name="d94d" href="#d94d">[d94d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a></span></span><span class="ce">; Draw the next cycle of the death animation.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check whether to reset the animation state.
;
</div><span class="l"><a class="anc" name="d950" href="#d950">[d950]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Load the animation phase.</span></span>
<span class="l"><a class="anc" name="d953" href="#d953">[d953]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (complete)?</span></span>
<span class="l"><a class="anc" name="d955" href="#d955">[d955]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextLoop">@_prepareNextLoop</a></span></span><span class="ce">; If not, prepare for the next loop.</span></span>
<span class="l"><a class="anc" name="d957" href="#d957">[d957]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Load the screen transition counter.</span></span>
<span class="l"><a class="anc" name="d95a" href="#d95a">[d95a]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$10</span></span><span class="ce">; Is it &gt;= 16?</span></span>
<span class="l"><a class="anc" name="d95c" href="#d95c">[d95c]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_prepareNextLoop">@_prepareNextLoop</a></span></span><span class="ce">; If so, prepare for next loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear animation state.
;
</div><span class="l"><a class="anc" name="d95e" href="#d95e">[d95e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d960" href="#d960">[d960]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Clear the animation phase.</span></span>
<span class="l"><a class="anc" name="d963" href="#d963">[d963]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Clear the animation counter.</span></span>
<span class="l"></span>
<a name=":d966:@_prepareNextLoop"></a><span class="l"><a class="anc" name="d966" href="#d966">[d966]</a><a href="#:d966:@_prepareNextLoop" class="lla">@_prepareNextLoop:</a><span class="ce">; [$d966]</span></span>
<span class="l"><a class="anc" name="d966" href="#d966">[d966]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Increment the screen transition counter.</span></span>
<span class="l"><a class="anc" name="d969" href="#d969">[d969]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_continueDissolvePlayerLoop">@_continueDissolvePlayerLoop</a></span></span><span class="ce">; If transition counter != 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're past the player death animation.
;
; Load the palette and update the screen.
;
</div><span class="l"><a class="anc" name="d96b" href="#d96b">[d96b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span></span>
<span class="l"><a class="anc" name="d96e" href="#d96e">[d96e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a></span></span><span class="ce">; Load the palette.</span></span>
<span class="l"><a class="anc" name="d971" href="#d971">[d971]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span><span class="ce">; Append 0 to the PPU buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the player's inventory.
;
</div><span class="l"><a class="anc" name="d974" href="#d974">[d974]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the selected item from the stack.</span></span>
<span class="l"><a class="anc" name="d975" href="#d975">[d975]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="d978" href="#d978">[d978]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the magic from the stack.</span></span>
<span class="l"><a class="anc" name="d979" href="#d979">[d979]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedMagic">SelectedMagic</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="d97c" href="#d97c">[d97c]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the shield from the stack.</span></span>
<span class="l"><a class="anc" name="d97d" href="#d97d">[d97d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="d980" href="#d980">[d980]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the armor from the stack.</span></span>
<span class="l"><a class="anc" name="d981" href="#d981">[d981]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="d984" href="#d984">[d984]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the weapon from the stack.</span></span>
<span class="l"><a class="anc" name="d985" href="#d985">[d985]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the death music.
;
</div><span class="l"><a class="anc" name="d988" href="#d988">[d988]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Death music.</span></span>
<span class="l"><a class="anc" name="d98a" href="#d98a">[d98a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the sprite loaded state.
;
</div><span class="l"><a class="anc" name="d98c" href="#d98c">[d98c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="d98e" href="#d98e">[d98e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a></span></span><span class="ce">; Set loaded state to 0xFF.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0xFF via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>.
;
</div><span class="l"><a class="anc" name="d990" href="#d990">[d990]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="d993" href="#d993">[d993]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="d994" href="#d994">[d994]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":d996:@_afterIScriptFarJump"></a><span class="l"><a class="anc" name="d996" href="#d996">[d996]</a><a href="#:d996:@_afterIScriptFarJump" class="lla">@_afterIScriptFarJump:</a><span class="ce">; [$d996]</span></span>
<span class="l"><a class="anc" name="d996" href="#d996">[d996]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; 0 = No music</span></span>
<span class="l"><a class="anc" name="d998" href="#d998">[d998]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set initial gold and experience via jump
; to <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>.
;
</div><span class="l"><a class="anc" name="d99a" href="#d99a">[d99a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run:</span></span>
<span class="l"><a class="anc" name="d99d" href="#d99d">[d99d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="d99e" href="#d99e">[d99e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a></span></span>
<span class="l"></span>
<a name=":d9a0:@_afterSetExpGoldFarJump"></a><span class="l"><a class="anc" name="d9a0" href="#d9a0">[d9a0]</a><a href="#:d9a0:@_afterSetExpGoldFarJump" class="lla">@_afterSetExpGoldFarJump:</a><span class="ce">; [$d9a0]</span></span>
<span class="l"><a class="anc" name="d9a0" href="#d9a0">[d9a0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span><span class="ce">; Fade the screen to black.</span></span>
<span class="l"><a class="anc" name="d9a3" href="#d9a3">[d9a3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a></span></span><span class="ce">; Reset state for spawn.</span></span>
<span class="l"><a class="anc" name="d9a6" href="#d9a6">[d9a6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_Spawn">Player_Spawn</a></span></span><span class="ce">; Spawn the player.</span></span>
<span class="l"></span>
<a name=":d9a9:@_continueDissolvePlayerLoop"></a><span class="l"><a class="anc" name="d9a9" href="#d9a9">[d9a9]</a><a href="#:d9a9:@_continueDissolvePlayerLoop" class="lla">@_continueDissolvePlayerLoop:</a><span class="ce">; [$d9a9]</span></span>
<span class="l"><a class="anc" name="d9a9" href="#d9a9">[d9a9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_dissolvePlayerLoop">@_dissolvePlayerLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="EndGame_Begin"></a><div class="cp">;============================================================================
; Begin the end-game sequence following the final boss kill.
;
; This will freeze the game briefly, fade to black, and then
; briefly wait while playing music before moving the player
; into the King's room for the final dialogue sequence.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a>
;     <a href="#Screen_ClearSprites">Screen_ClearSprites</a>
;     <a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#ScreenEvents_HandleFinalBossKilled">ScreenEvents_HandleFinalBossKilled</a>
;============================================================================
</div><span class="l"><a class="anc" name="d9ac" href="#d9ac">[d9ac]</a><a href="#EndGame_Begin" class="la">EndGame_Begin:</a><span class="ce">; [$d9ac]</span></span>
<div class="c">;
; Clear all sprites from the screen.
;
</div><span class="l"><a class="anc" name="d9ac" href="#d9ac">[d9ac]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ClearSprites">Screen_ClearSprites</a></span></span><span class="ce">; Clear sprites.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait 120 frames before beginning the fade-out.
;
</div><span class="l"><a class="anc" name="d9af" href="#d9af">[d9af]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$78</span></span><span class="ce">; X = 120 (loop counter)</span></span>
<span class="l"></span>
<a name=":d9b1:@_beforeFadeLoop"></a><span class="l"><a class="anc" name="d9b1" href="#d9b1">[d9b1]</a><a href="#:d9b1:@_beforeFadeLoop" class="lla">@_beforeFadeLoop:</a><span class="ce">; [$d9b1]</span></span>
<span class="l"><a class="anc" name="d9b1" href="#d9b1">[d9b1]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="d9b2" href="#d9b2">[d9b2]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="d9b3" href="#d9b3">[d9b3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="d9b6" href="#d9b6">[d9b6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span><span class="ce">; Reset for this frame.</span></span>
<span class="l"><a class="anc" name="d9b9" href="#d9b9">[d9b9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a></span></span><span class="ce">; Draw the screen and player in a semi-paused state.</span></span>
<span class="l"><a class="anc" name="d9bc" href="#d9bc">[d9bc]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop our loop counter.</span></span>
<span class="l"><a class="anc" name="d9bd" href="#d9bd">[d9bd]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="d9be" href="#d9be">[d9be]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="d9bf" href="#d9bf">[d9bf]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_beforeFadeLoop">@_beforeFadeLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Fade the screen to black.
;
</div><span class="l"><a class="anc" name="d9c1" href="#d9c1">[d9c1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span><span class="ce">; Fade to black.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait another 120 frames before switching screens.
;
</div><span class="l"><a class="anc" name="d9c4" href="#d9c4">[d9c4]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$78</span></span><span class="ce">; X = 120 (loop counter)</span></span>
<span class="l"></span>
<a name=":d9c6:@_beforeTransitionLoop"></a><span class="l"><a class="anc" name="d9c6" href="#d9c6">[d9c6]</a><a href="#:d9c6:@_beforeTransitionLoop" class="lla">@_beforeTransitionLoop:</a><span class="ce">; [$d9c6]</span></span>
<span class="l"><a class="anc" name="d9c6" href="#d9c6">[d9c6]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X (loop counter)</span></span>
<span class="l"><a class="anc" name="d9c7" href="#d9c7">[d9c7]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="d9c8" href="#d9c8">[d9c8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="d9cb" href="#d9cb">[d9cb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span><span class="ce">; Reset for this frame.</span></span>
<span class="l"><a class="anc" name="d9ce" href="#d9ce">[d9ce]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop our loop counter.</span></span>
<span class="l"><a class="anc" name="d9cf" href="#d9cf">[d9cf]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (loop counter)</span></span>
<span class="l"><a class="anc" name="d9d0" href="#d9d0">[d9d0]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="d9d1" href="#d9d1">[d9d1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_beforeTransitionLoop">@_beforeTransitionLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Move the player to the King's room and begin the
; end-game dialogue sequence.
;
</div><span class="l"><a class="anc" name="d9d3" href="#d9d3">[d9d3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a></span></span><span class="ce">; Begin the next transition into the King's room.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_DrawDeathAnimation"></a><div class="cp">;============================================================================
; Draw the player's death animation.
;
; This will make us of the Clear Vertical Lines PPU
; draw command
; (<a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>),
; clearing away lines from the player sprite in a set
; pattern until a counter is reached and the player is gone.
;
; This will run for 250 frames.
;
; INPUTS:
;     <a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a>:
;         The phase to pass to the draw command.
;
;     <a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a>:
;         The animation counter, which will govern
;         phase, tile address, and total animation
;         time.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The upper bounds of the PPU buffer.
;
;     <a href="#DEATH_ANIMATION_DRAW_ADDR_LOWER">DEATH_ANIMATION_DRAW_ADDR_LOWER</a>:
;         A mapping of counter values to player tile
;         lower address bytes.
;
; OUTPUTS:
;     <a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a>:
;         The updated death animation counter.
;
;     <a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a>:
;         The updated death animation phase.
;
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer to write to.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new upper bounds of the PPU buffer.
;
; XREFS:
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;============================================================================
</div><span class="l"><a class="anc" name="d9d6" href="#d9d6">[d9d6]</a><a href="#Player_DrawDeathAnimation" class="la">Player_DrawDeathAnimation:</a><span class="ce">; [$d9d6]</span></span>
<span class="l"><a class="anc" name="d9d6" href="#d9d6">[d9d6]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Load the death animation phase.</span></span>
<span class="l"><a class="anc" name="d9d9" href="#d9d9">[d9d9]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &gt;= 8?</span></span>
<span class="l"><a class="anc" name="d9db" href="#d9db">[d9db]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><a class="anc" name="d9dd" href="#d9dd">[d9dd]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Load the animation death counter.</span></span>
<span class="l"><a class="anc" name="d9e0" href="#d9e0">[d9e0]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_dissolveSprite">@_dissolveSprite</a></span></span><span class="ce">; If &gt;= 0, jump to dissolve the sprite.</span></span>
<span class="l"><a class="anc" name="d9e2" href="#d9e2">[d9e2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Else, load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="d9e4" href="#d9e4">[d9e4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Every 3 out of 4 ticks...</span></span>
<span class="l"><a class="anc" name="d9e6" href="#d9e6">[d9e6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; Return.</span></span>
<span class="l"><a class="anc" name="d9e8" href="#d9e8">[d9e8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d9ea" href="#d9ea">[d9ea]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Clear the death counter.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":d9ed:@_dissolveSprite"></a><div class="c">;
; Queue draw command 0xFA, dissolving the character's sprite
; by removal of vertical lines.
;
; This is
; <a href="#PPUBuffer_DrawCommand_RemoveVerticalLines">PPUBuffer_DrawCommand_RemoveVerticalLines</a>.
;
; Draw 250 frames.
;
</div><span class="l"><a class="anc" name="d9ed" href="#d9ed">[d9ed]</a><a href="#:d9ed:@_dissolveSprite" class="lla">@_dissolveSprite:</a><span class="ce">; [$d9ed]</span></span>
<span class="l"><a class="anc" name="d9ed" href="#d9ed">[d9ed]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; X = PPU buffer upper bounds.</span></span>
<span class="l"><a class="anc" name="d9ef" href="#d9ef">[d9ef]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$fa</span></span><span class="ce">; A = 0xFA (Remove Vertical Lines draw command).</span></span>
<span class="l"><a class="anc" name="d9f1" href="#d9f1">[d9f1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set that as the command to execute.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the current player phase for the draw.
;
</div><span class="l"><a class="anc" name="d9f4" href="#d9f4">[d9f4]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="d9f5" href="#d9f5">[d9f5]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Load the animation phase.</span></span>
<span class="l"><a class="anc" name="d9f8" href="#d9f8">[d9f8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set that as the phase parameter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the upper byte of the address to 0.
;
</div><span class="l"><a class="anc" name="d9fb" href="#d9fb">[d9fb]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="d9fc" href="#d9fc">[d9fc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="d9fe" href="#d9fe">[d9fe]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set 0 as the upper address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the lower byte of the address based on the counter.
;
</div><span class="l"><a class="anc" name="da01" href="#da01">[da01]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="da02" href="#da02">[da02]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Load the animation counter.</span></span>
<span class="l"><a class="anc" name="da05" href="#da05">[da05]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DEATH_ANIMATION_DRAW_ADDR_LOWER">DEATH_ANIMATION_DRAW_ADDR_LOWER</a>,Y</span></span><span class="ce">; Load the lower address for Y.</span></span>
<span class="l"><a class="anc" name="da08" href="#da08">[da08]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set it as the lower address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store the new upper bounds of the PPU buffer.
;
</div><span class="l"><a class="anc" name="da0b" href="#da0b">[da0b]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="da0c" href="#da0c">[da0c]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Set as the new upper bounds for the PPU buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the animation counter.
;
</div><span class="l"><a class="anc" name="da0e" href="#da0e">[da0e]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Increment the animation counter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If &gt;= 8, reset the counter and increment the phase.
;
</div><span class="l"><a class="anc" name="da11" href="#da11">[da11]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Load the new animation counter.</span></span>
<span class="l"><a class="anc" name="da14" href="#da14">[da14]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &lt; 8?</span></span>
<span class="l"><a class="anc" name="da16" href="#da16">[da16]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Reset the animation counter and increment the phase.
; <a href="#Player_HandleDeath">Player_HandleDeath</a> will see this and prepare the
; next
; round of vertical line removals.
;
</div><span class="l"><a class="anc" name="da18" href="#da18">[da18]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="da1a" href="#da1a">[da1a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationCounter">Player_DeathAnimationCounter</a></span></span><span class="ce">; Set the animation counter to 0xFF.</span></span>
<span class="l"><a class="anc" name="da1d" href="#da1d">[da1d]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Player_DeathAnimationPhase">Player_DeathAnimationPhase</a></span></span><span class="ce">; Increment the animation phase.</span></span>
<span class="l"></span>
<a name=":da20:@_return"></a><span class="l"><a class="anc" name="da20" href="#da20">[da20]</a><a href="#:da20:@_return" class="lla">@_return:</a><span class="ce">; [$da20]</span></span>
<span class="l"><a class="anc" name="da20" href="#da20">[da20]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="DEATH_ANIMATION_DRAW_ADDR_LOWER"></a><div class="cp">;============================================================================
; Lower bytes for the player's tiles to update during death animation.
;
; XREFS:
;     <a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_DrawDeathAnimation">Player_DrawDeathAnimation</a>
;
</div><span class="l"><a class="anc" name="da21" href="#da21">[da21]</a><a href="#DEATH_ANIMATION_DRAW_ADDR_LOWER" class="la">DEATH_ANIMATION_DRAW_ADDR_LOWER:</a><span class="ce">; [$da21]</span></span>
<span class="l"><a class="anc" name="da21" href="#da21">[da21]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="da22" href="#da22">[da22]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="da23" href="#da23">[da23]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="da24" href="#da24">[da24]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="da25" href="#da25">[da25]</a><span class="cd"><span class="i">db</span> <span class="o">$40</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="da26" href="#da26">[da26]</a><span class="cd"><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="da27" href="#da27">[da27]</a><span class="cd"><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="da28" href="#da28">[da28]</a><span class="cd"><span class="i">db</span> <span class="o">$70</span></span><span class="ce">; [7]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UNUSED_Screen_ClearFadeOutStage"></a><div class="cp">;============================================================================
; DEADCODE: Clear the fade-out stage for the screen transitions.
;============================================================================
</div><span class="l"><a class="anc" name="da29" href="#da29">[da29]</a><a href="#UNUSED_Screen_ClearFadeOutStage" class="la">UNUSED_Screen_ClearFadeOutStage:</a><span class="ce">; [$da29]</span></span>
<span class="l"><a class="anc" name="da29" href="#da29">[da29]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="da2b" href="#da2b">[da2b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span></span>
<span class="l"><a class="anc" name="da2e" href="#da2e">[da2e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_FadeToBlack"></a><div class="cp">;============================================================================
; Fade the screen out to black.
;
; This is called during door transitions or after
; dissolving a character during death.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#WaitForInterrupt">WaitForInterrupt</a>
;     <a href="#Screen_NextTransitionState">Screen_NextTransitionState</a>
;
; XREFS:
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;     <a href="#_afterSetExpGoldFarJump">_afterSetExpGoldFarJump</a>
;     [$PRG15_MIRROR::d9a0]
;============================================================================
</div><span class="l"><a class="anc" name="da2f" href="#da2f">[da2f]</a><a href="#Screen_FadeToBlack" class="la">Screen_FadeToBlack:</a><span class="ce">; [$da2f]</span></span>
<span class="l"><a class="anc" name="da2f" href="#da2f">[da2f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; X = 0 (loop counter)</span></span>
<span class="l"><a class="anc" name="da31" href="#da31">[da31]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span><span class="ce">; Set as the index into the screen palette lookup.</span></span>
<span class="l"></span>
<a name=":da34:@_loop"></a><span class="l"><a class="anc" name="da34" href="#da34">[da34]</a><a href="#:da34:@_loop" class="lla">@_loop:</a><span class="ce">; [$da34]</span></span>
<span class="l"><a class="anc" name="da34" href="#da34">[da34]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForInterrupt">WaitForInterrupt</a></span></span><span class="ce">; Wait for the next interrupt.</span></span>
<span class="l"><a class="anc" name="da37" href="#da37">[da37]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_NextTransitionState">Screen_NextTransitionState</a></span></span><span class="ce">; Update the screen for this palete.</span></span>
<span class="l"><a class="anc" name="da3a" href="#da3a">[da3a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span><span class="ce">; Load the palette index.</span></span>
<span class="l"><a class="anc" name="da3d" href="#da3d">[da3d]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &lt; 4?</span></span>
<span class="l"><a class="anc" name="da3f" href="#da3f">[da3f]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"><a class="anc" name="da41" href="#da41">[da41]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_NextTransitionState"></a><div class="cp">;============================================================================
; Handle the next state for a screen transition.
;
; This may be used when entering a building or when dying.
; An outer loop will call this each tick. It won't begin
; the fadeout until <a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a> is a value 0-4.
;
; The palette will increase at periodic intervals,
; eventually ending with a black screen.
;
; INPUTS:
;     <a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a>:
;         The current palette index.
;
;     <a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a>:
;         The counter for this loop.
;
;     <a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a>:
;         The palette index to apply for the transition.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a>:
;         The new palette index.
;
;     <a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a>:
;         The fade-out counter.
;
; XREFS:
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Screen_FadeToBlack">Screen_FadeToBlack</a>
;============================================================================
</div><span class="l"><a class="anc" name="da42" href="#da42">[da42]</a><a href="#Screen_NextTransitionState" class="la">Screen_NextTransitionState:</a><span class="ce">; [$da42]</span></span>
<span class="l"><a class="anc" name="da42" href="#da42">[da42]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span><span class="ce">; Load the current palette index.</span></span>
<span class="l"><a class="anc" name="da45" href="#da45">[da45]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &gt;= 4?</span></span>
<span class="l"><a class="anc" name="da47" href="#da47">[da47]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_doneFadeOut">@_doneFadeOut</a></span></span><span class="ce">; If so, jump to finish up.</span></span>
<span class="l"><a class="anc" name="da49" href="#da49">[da49]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a></span></span><span class="ce">; A = fadeout counter.</span></span>
<span class="l"><a class="anc" name="da4c" href="#da4c">[da4c]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="da4d" href="#da4d">[da4d]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$32</span></span><span class="ce">; A += 0x32 (50)</span></span>
<span class="l"><a class="anc" name="da4f" href="#da4f">[da4f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutCounter">Screen_FadeOutCounter</a></span></span><span class="ce">; Store as the new value.</span></span>
<span class="l"><a class="anc" name="da52" href="#da52">[da52]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_doneFadeOut">@_doneFadeOut</a></span></span><span class="ce">; If 0, don't alter the palette.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Fade out to the next palette towards black.
;
</div><span class="l"><a class="anc" name="da54" href="#da54">[da54]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span><span class="ce">; Load the screen palette index.</span></span>
<span class="l"><a class="anc" name="da57" href="#da57">[da57]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_SetFadeOutPalette">Screen_SetFadeOutPalette</a></span></span><span class="ce">; Load the palette into memory.</span></span>
<span class="l"><a class="anc" name="da5a" href="#da5a">[da5a]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span><span class="ce">; Increment the palette index to the next transition state.</span></span>
<span class="l"></span>
<a name=":da5d:@_doneFadeOut"></a><span class="l"><a class="anc" name="da5d" href="#da5d">[da5d]</a><a href="#:da5d:@_doneFadeOut" class="lla">@_doneFadeOut:</a><span class="ce">; [$da5d]</span></span>
<span class="l"><a class="anc" name="da5d" href="#da5d">[da5d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_TransitionCounter">Screen_TransitionCounter</a></span></span><span class="ce">; Load the screen transition counter.</span></span>
<span class="l"><a class="anc" name="da60" href="#da60">[da60]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it &lt; 80?</span></span>
<span class="l"><a class="anc" name="da62" href="#da62">[da62]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're doing player death, and have finished dissolving
; the player. We can now begin fading to black.
;
</div><span class="l"><a class="anc" name="da64" href="#da64">[da64]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="da66" href="#da66">[da66]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_FadeOutStage">Screen_FadeOutStage</a></span></span><span class="ce">; Set the palette to 0.</span></span>
<span class="l"></span>
<a name=":da69:@_return"></a><span class="l"><a class="anc" name="da69" href="#da69">[da69]</a><a href="#:da69:@_return" class="lla">@_return:</a><span class="ce">; [$da69]</span></span>
<span class="l"><a class="anc" name="da69" href="#da69">[da69]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_InitStateForStartScreen"></a><div class="cp">;============================================================================
; Initialize the state for the Faxanadu start screen.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         Set to Eolis.
;
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         Set to Eolis.
;
; CALLS:
;     <a href="PRG14.html#Player_InitInventoryState">Player_InitInventoryState</a>
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;
; XREFS:
;     <a href="#Game_Init">Game_Init</a>
;============================================================================
</div><span class="l"><a class="anc" name="da6a" href="#da6a">[da6a]</a><a href="#Game_InitStateForStartScreen" class="la">Game_InitStateForStartScreen:</a><span class="ce">; [$da6a]</span></span>
<span class="l"><a class="anc" name="da6a" href="#da6a">[da6a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><a class="anc" name="da6c" href="#da6c">[da6c]</a><span class="cd"><span class="i">TXS</span></span><span class="ce">; Copy to stack pointer.</span></span>
<span class="l"><a class="anc" name="da6d" href="#da6d">[da6d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="da6f" href="#da6f">[da6f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Set as the current area (Eolis)</span></span>
<span class="l"><a class="anc" name="da71" href="#da71">[da71]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Set as the current region (Eolis)</span></span>
<span class="l"><a class="anc" name="da74" href="#da74">[da74]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7ae</span></span><span class="ce">; Initialize the player inventory.</span></span>
<span class="l"><a class="anc" name="da77" href="#da77">[da77]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a></span></span><span class="ce">; Initiate the spawn state.</span></span>
<span class="l"><a class="anc" name="da7a" href="#da7a">[da7a]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_ShowStartScreen">Game_ShowStartScreen</a></span></span><span class="ce">; Show the start screen.</span></span>
<span class="l"></span>
</pre><pre><a name="Game_InitStateForSpawn"></a><div class="cp">;============================================================================
; TODO: Document Game_InitStateForSpawn
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="da7d" href="#da7d">[da7d]</a><a href="#Game_InitStateForSpawn" class="la">Game_InitStateForSpawn:</a><span class="ce">; [$da7d]</span></span>
<span class="l"><a class="anc" name="da7d" href="#da7d">[da7d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until the PPU is flushed.</span></span>
<span class="l"><a class="anc" name="da80" href="#da80">[da80]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="da82" href="#da82">[da82]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span><span class="ce">; Set the player as alive.</span></span>
<span class="l"><a class="anc" name="da85" href="#da85">[da85]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Reset PPU buffer upper bounds to 0.</span></span>
<span class="l"><a class="anc" name="da87" href="#da87">[da87]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer_ReadOffset">PPUBuffer_ReadOffset</a></span></span><span class="ce">; Reset PPU buffer offset to 0.</span></span>
<span class="l"><a class="anc" name="da89" href="#da89">[da89]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a></span></span><span class="ce">; Mark the screen as loaded and ready.</span></span>
<span class="l"><a class="anc" name="da8b" href="#da8b">[da8b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetInitialState">Player_SetInitialState</a></span></span><span class="ce">; Initialize the player's initial state.</span></span>
<span class="l"><a class="anc" name="da8e" href="#da8e">[da8e]</a><span class="cd"><span class="i">JSR</span> <span class="o">$ba55</span></span><span class="ce">; Clear any visible magic on screen.</span></span>
<span class="l"><a class="anc" name="da91" href="#da91">[da91]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_LoadCommon">Sprites_LoadCommon</a></span></span><span class="ce">; Load sprites from bank 8.</span></span>
<span class="l"><a class="anc" name="da94" href="#da94">[da94]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="da96" href="#da96">[da96]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Maybe_Game_Ready">Maybe_Game_Ready</a></span></span><span class="ce">; Set that the game is ready to play.</span></span>
<span class="l"><a class="anc" name="da99" href="#da99">[da99]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="da9b" href="#da9b">[da9b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span><span class="ce">; Clear the scrolling screen pixel state.</span></span>
<span class="l"><a class="anc" name="da9d" href="#da9d">[da9d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span><span class="ce">; Clear the scrolling screen state.</span></span>
<span class="l"><a class="anc" name="da9f" href="#da9f">[da9f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_SetupEnterScreen"></a><div class="cp">;============================================================================
; Setup state for entering a new screen.
;
; This is called when switching screens or entering through
; a door.
;
; This will set up the game and screen state for the
; destination and load new sprites.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#Screen_Load">Screen_Load</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a class="anc" name="daa0" href="#daa0">[daa0]</a><a href="#Game_SetupEnterScreen" class="la">Game_SetupEnterScreen:</a><span class="ce">; [$daa0]</span></span>
<span class="l"><a class="anc" name="daa0" href="#daa0">[daa0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until the PPU is flushed.</span></span>
<span class="l"><a class="anc" name="daa3" href="#daa3">[daa3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span><span class="ce">; Load the screen state.</span></span>
<span class="l"><a class="anc" name="daa6" href="#daa6">[daa6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span><span class="ce">; Reset the screen and enable interrupts.</span></span>
<span class="l"><a class="anc" name="daa9" href="#daa9">[daa9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="daac" href="#daac">[daac]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load the sprite images.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_SetupEnterBuilding"></a><div class="cp">;============================================================================
; Setup state for entering a building.
;
; This will set up the game and screen state for the
; destination building and load new sprites.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#EndGame_MoveToKingsRoom">EndGame_MoveToKingsRoom</a>
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a class="anc" name="daaf" href="#daaf">[daaf]</a><a href="#Game_SetupEnterBuilding" class="la">Game_SetupEnterBuilding:</a><span class="ce">; [$daaf]</span></span>
<span class="l"><a class="anc" name="daaf" href="#daaf">[daaf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until the PPU is flushed.</span></span>
<span class="l"><a class="anc" name="dab2" href="#dab2">[dab2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_EnterBuilding">Game_EnterBuilding</a></span></span><span class="ce">; Load state for the building.</span></span>
<span class="l"><a class="anc" name="dab5" href="#dab5">[dab5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span><span class="ce">; Reset the screen and enable interrupts.</span></span>
<span class="l"><a class="anc" name="dab8" href="#dab8">[dab8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="dabb" href="#dabb">[dabb]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load the sprite images.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_SetupExitBuilding"></a><div class="cp">;============================================================================
; Setup state for exiting a building.
;
; This will set up the game and screen state for the
; area outside the building and load new sprites.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Game_BeginExitBuilding">Game_BeginExitBuilding</a>
;============================================================================
</div><span class="l"><a class="anc" name="dabe" href="#dabe">[dabe]</a><a href="#Game_SetupExitBuilding" class="la">Game_SetupExitBuilding:</a><span class="ce">; [$dabe]</span></span>
<span class="l"><a class="anc" name="dabe" href="#dabe">[dabe]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until the PPU is flushed.</span></span>
<span class="l"><a class="anc" name="dac1" href="#dac1">[dac1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_ExitBuilding">Game_ExitBuilding</a></span></span><span class="ce">; Load state for the area outside the building.</span></span>
<span class="l"><a class="anc" name="dac4" href="#dac4">[dac4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span><span class="ce">; Reset the screen and enable interrupts.</span></span>
<span class="l"><a class="anc" name="dac7" href="#dac7">[dac7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="daca" href="#daca">[daca]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load the sprite images.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_SetupNewArea"></a><div class="cp">;============================================================================
; Setup state for a new area.
;
; This will set up the game and screen state for the
; area and load new sprites.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Player_CheckSwitchScreen_SwitchAreaHoriz">Player_CheckSwitchScreen_SwitchAreaHoriz</a>
;============================================================================
</div><span class="l"><a class="anc" name="dacd" href="#dacd">[dacd]</a><a href="#Game_SetupNewArea" class="la">Game_SetupNewArea:</a><span class="ce">; [$dacd]</span></span>
<span class="l"><a class="anc" name="dacd" href="#dacd">[dacd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until the PPU is flushed.</span></span>
<span class="l"><a class="anc" name="dad0" href="#dad0">[dad0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a></span></span><span class="ce">; Load state for the new area.</span></span>
<span class="l"><a class="anc" name="dad3" href="#dad3">[dad3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span><span class="ce">; Reset the screen and enable interrupts.</span></span>
<span class="l"><a class="anc" name="dad6" href="#dad6">[dad6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="dad9" href="#dad9">[dad9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load the sprite images.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_SetupAndLoadOutsideArea"></a><div class="cp">;============================================================================
; Setup state for an area in a new region of the game.
;
; This will set up the game and screen state for the
; area and load new sprites.
;
; This is used when exiting a door to the outside, or
; when using the controller 2 debug code to switch areas.
;
; INPUTS:
;     <a href="#DOOR_OUTSIDE_REGION_INDEXES">DOOR_OUTSIDE_REGION_INDEXES</a>:
;         Mapping of regions to areas to place the player.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The new area to set.
;
; CALLS:
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Debug_ChooseArea">Debug_ChooseArea</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;============================================================================
</div><span class="l"><a class="anc" name="dadc" href="#dadc">[dadc]</a><a href="#Game_SetupAndLoadOutsideArea" class="la">Game_SetupAndLoadOutsideArea:</a><span class="ce">; [$dadc]</span></span>
<span class="l"><a class="anc" name="dadc" href="#dadc">[dadc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until the PPU is flushed.</span></span>
<span class="l"><a class="anc" name="dadf" href="#dadf">[dadf]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Load the region.</span></span>
<span class="l"><a class="anc" name="dae2" href="#dae2">[dae2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DOOR_OUTSIDE_REGION_INDEXES">DOOR_OUTSIDE_REGION_INDEXES</a>,X</span></span><span class="ce">; Load the area of the game to place the player for this region.</span></span>
<span class="l"><a class="anc" name="dae5" href="#dae5">[dae5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Store as the new area.</span></span>
<span class="l"><a class="anc" name="dae7" href="#dae7">[dae7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a></span></span><span class="ce">; Load data for the area.</span></span>
<span class="l"><a class="anc" name="daea" href="#daea">[daea]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span><span class="ce">; Reset the screen and enable interrupts.</span></span>
<span class="l"><a class="anc" name="daed" href="#daed">[daed]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="daf0" href="#daf0">[daf0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load the sprite images.</span></span>
<span class="l"><a class="anc" name="daf3" href="#daf3">[daf3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span><span class="ce">; Run the game mainloop.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="FUN_PRG15_MIRROR__daf6"></a><div class="cp">;============================================================================
; DEADCODE
;
; Would assign the area based on transitioning from another.
;============================================================================
</div><span class="l"><a class="anc" name="daf6" href="#daf6">[daf6]</a><a href="#FUN_PRG15_MIRROR__daf6" class="la">FUN_PRG15_MIRROR__daf6:</a><span class="ce">; [$daf6]</span></span>
<span class="l"><a class="anc" name="daf6" href="#daf6">[daf6]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><a class="anc" name="daf9" href="#daf9">[daf9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DOOR_OUTSIDE_REGION_INDEXES">DOOR_OUTSIDE_REGION_INDEXES</a>,X</span></span></span>
<span class="l"><a class="anc" name="dafc" href="#dafc">[dafc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"></span>
<a name="DOOR_OUTSIDE_REGION_INDEXES"></a><div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__daf6">FUN_PRG15_MIRROR__daf6</a>
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;
</div><span class="l"><a class="anc" name="dafe" href="#dafe">[dafe]</a><a href="#DOOR_OUTSIDE_REGION_INDEXES" class="la">DOOR_OUTSIDE_REGION_INDEXES:</a><span class="ce">; [$dafe]</span></span>
<span class="l"><a class="anc" name="dafe" href="#dafe">[dafe]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_EOLIS</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="daff" href="#daff">[daff]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">; [1]: Trunk</span></span>
<span class="l"><a class="anc" name="db00" href="#db00">[db00]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">; [2]: Mist</span></span>
<span class="l"><a class="anc" name="db01" href="#db01">[db01]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">; [3]: Branch</span></span>
<span class="l"><a class="anc" name="db02" href="#db02">[db02]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_DAYBREAK</span></span><span class="ce">; [4]: Dartmoor</span></span>
<span class="l"><a class="anc" name="db03" href="#db03">[db03]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_EVIL_FORTRESS</span></span><span class="ce">; [5]: Evil Fortress</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="EndGame_BeginKingsRoomSequence"></a><div class="cp">;============================================================================
; Place the player in the King's room and move toward the King.
;
; This is part of the end-game sequence, and takes place
; immediately after the final boss is killed and the screen
; fades out.
;
; The player will be placed back in the King's room, and
; will then begin moving automatically toward the King.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#EndGame_MoveToKingsRoom">EndGame_MoveToKingsRoom</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;
; XREFS:
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;============================================================================
</div><span class="l"><a class="anc" name="db04" href="#db04">[db04]</a><a href="#EndGame_BeginKingsRoomSequence" class="la">EndGame_BeginKingsRoomSequence:</a><span class="ce">; [$db04]</span></span>
<span class="l"><a class="anc" name="db04" href="#db04">[db04]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#EndGame_MoveToKingsRoom">EndGame_MoveToKingsRoom</a></span></span><span class="ce">; Place the player in the King's room.</span></span>
<span class="l"><a class="anc" name="db07" href="#db07">[db07]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#EndGame_MainLoop">EndGame_MainLoop</a></span></span><span class="ce">; Move the player toward the King.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_Spawn"></a><div class="cp">;============================================================================
; Spawn the player.
;
; This will set the player's HP and MP to max, reset
; quest state and timed items, and place the player in
; the latest temple.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The completed quests.
;
; OUTPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The updated completed quests.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The filled player HP.
;
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         The filled player MP.
;
; CALLS:
;     <a href="#Game_ClearTimedItems">Game_ClearTimedItems</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;
; XREFS:
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="db0a" href="#db0a">[db0a]</a><a href="#Player_Spawn" class="la">Player_Spawn:</a><span class="ce">; [$db0a]</span></span>
<span class="l"><a class="anc" name="db0a" href="#db0a">[db0a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$50</span></span></span>
<span class="l"><a class="anc" name="db0c" href="#db0c">[db0c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Set the initial player HP to 80.</span></span>
<span class="l"><a class="anc" name="db0f" href="#db0f">[db0f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Set the initial player MP to 80.</span></span>
<span class="l"><a class="anc" name="db12" href="#db12">[db12]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the completed quests.</span></span>
<span class="l"><a class="anc" name="db15" href="#db15">[db15]</a><span class="cd"><span class="i">AND</span> <span class="o">#$ef</span></span><span class="ce">; Disable the Mattock barrier to Mascon quest.</span></span>
<span class="l"><a class="anc" name="db17" href="#db17">[db17]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="db1a" href="#db1a">[db1a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_ClearTimedItems">Game_ClearTimedItems</a></span></span><span class="ce">; Cleared all timed items.</span></span>
<span class="l"><a class="anc" name="db1d" href="#db1d">[db1d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_SpawnInTemple">Game_SpawnInTemple</a></span></span><span class="ce">; Spawn in the temple.</span></span>
<span class="l"><a class="anc" name="db20" href="#db20">[db20]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a></span></span><span class="ce">; Change the state to be inside a building.</span></span>
<span class="l"><a class="anc" name="db23" href="#db23">[db23]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span><span class="ce">; Start the mainloop.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_Start"></a><div class="cp">;============================================================================
; Start the game.
;
; This runs after the intro animation finishes, placing
; the player at the gates of Eolis with no MP and no
; experience.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Player_MP">Player_MP</a>:
;         Set to 0.
;
;     <a href="RAM.html#Experience">Experience</a>:
;         Set to 0.
;
;     See Fallthrough.
;
; CALLS:
;     <a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a>
;     <a href="#Game_ClearTimedItems">Game_ClearTimedItems</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;     <a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; FALLTHROUGH:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;
; XREFS:
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="db26" href="#db26">[db26]</a><a href="#Game_Start" class="la">Game_Start:</a><span class="ce">; [$db26]</span></span>
<span class="l"><a class="anc" name="db26" href="#db26">[db26]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_ClearTimedItems">Game_ClearTimedItems</a></span></span><span class="ce">; Clear all timed items.</span></span>
<span class="l"><a class="anc" name="db29" href="#db29">[db29]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span><span class="ce">; Wait until everything is drawn to the screen.</span></span>
<span class="l"><a class="anc" name="db2c" href="#db2c">[db2c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a></span></span><span class="ce">; Load the first level.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the player's MP.
;
</div><span class="l"><a class="anc" name="db2f" href="#db2f">[db2f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="db31" href="#db31">[db31]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Set MP to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the player's experience.
;
</div><span class="l"><a class="anc" name="db34" href="#db34">[db34]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="db36" href="#db36">[db36]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Set lower byte of experience to 0.</span></span>
<span class="l"><a class="anc" name="db39" href="#db39">[db39]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; And upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare state for the first screen of Eolis, including the
; intro trigger sprite entity.
;
</div><span class="l"><a class="anc" name="db3c" href="#db3c">[db3c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span><span class="ce">; Reset the screen and enable interrupts.</span></span>
<span class="l"><a class="anc" name="db3f" href="#db3f">[db3f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="db42" href="#db42">[db42]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span><span class="ce">; Load images for the current sprite entities (which will be the intro trigger).</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_MainLoop"></a><div class="cp">;============================================================================
; Mainloop for the game.
;
; This controls all input, rendering, and eventing while
; playing the game.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a class="anc" name="db45" href="#db45">[db45]</a><a href="#Game_MainLoop" class="la">Game_MainLoop:</a><span class="ce">; [$db45]</span></span>
<span class="l"><a class="anc" name="db45" href="#db45">[db45]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><a class="anc" name="db47" href="#db47">[db47]</a><span class="cd"><span class="i">TXS</span></span><span class="ce">; Transfer to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14 to run sprite logic.
;
</div><span class="l"><a class="anc" name="db48" href="#db48">[db48]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0e</span></span><span class="ce">; Bank 14 = Logic</span></span>
<span class="l"><a class="anc" name="db4a" href="#db4a">[db4a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare to draw sprites.
;
</div><span class="l"><a class="anc" name="db4d" href="#db4d">[db4d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="db50" href="#db50">[db50]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span><span class="ce">; Reset the sprite state for the screen.</span></span>
<span class="l"><a class="anc" name="db53" href="#db53">[db53]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a></span></span></span>
<span class="l"><a class="anc" name="db56" href="#db56">[db56]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b982</span></span><span class="ce">; Draw the player's shield sprite.</span></span>
<span class="l"><a class="anc" name="db59" href="#db59">[db59]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the player's body sprite.</span></span>
<span class="l"><a class="anc" name="db5c" href="#db5c">[db5c]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7d6</span></span><span class="ce">; Draw the player's weapon sprite.</span></span>
<span class="l"><a class="anc" name="db5f" href="#db5f">[db5f]</a><span class="cd"><span class="i">JSR</span> <span class="o">$ba5b</span></span><span class="ce">; Check and handle casting magic.</span></span>
<span class="l"><a class="anc" name="db62" href="#db62">[db62]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a></span></span><span class="ce">; Active selected item?</span></span>
<span class="l"><a class="anc" name="db65" href="#db65">[db65]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Update all sprites.</span></span>
<span class="l"><a class="anc" name="db68" href="#db68">[db68]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a></span></span></span>
<span class="l"><a class="anc" name="db6b" href="#db6b">[db6b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Fog_OnTick">Fog_OnTick</a></span></span></span>
<span class="l"><a class="anc" name="db6e" href="#db6e">[db6e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a></span></span></span>
<span class="l"><a class="anc" name="db71" href="#db71">[db71]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a></span></span></span>
<span class="l"><a class="anc" name="db74" href="#db74">[db74]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a></span></span></span>
<span class="l"><a class="anc" name="db77" href="#db77">[db77]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerIsDead">PlayerIsDead</a></span></span></span>
<span class="l"><a class="anc" name="db7a" href="#db7a">[db7a]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_playerIsNotDead">@_playerIsNotDead</a></span></span></span>
<span class="l"><a class="anc" name="db7c" href="#db7c">[db7c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_HandleDeath">Player_HandleDeath</a></span></span></span>
<span class="l"></span>
<a name=":db7f:@_playerIsNotDead"></a><span class="l"><a class="anc" name="db7f" href="#db7f">[db7f]</a><a href="#:db7f:@_playerIsNotDead" class="lla">@_playerIsNotDead:</a><span class="ce">; [$db7f]</span></span>
<span class="l"><a class="anc" name="db7f" href="#db7f">[db7f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="db81" href="#db81">[db81]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
<span class="l"><a class="anc" name="db83" href="#db83">[db83]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WaitUntilClear">PPUBuffer_WaitUntilClear</a></span></span></span>
<span class="l"><a class="anc" name="db86" href="#db86">[db86]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Maybe_Game_Ready">Maybe_Game_Ready</a></span></span></span>
<span class="l"><a class="anc" name="db89" href="#db89">[db89]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__db91">@LAB_PRG15_MIRROR__db91</a></span></span></span>
<span class="l"><a class="anc" name="db8b" href="#db8b">[db8b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="db8d" href="#db8d">[db8d]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="db8f" href="#db8f">[db8f]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__dbaf">@LAB_PRG15_MIRROR__dbaf</a></span></span></span>
<span class="l"></span>
<a name=":db91:@LAB_PRG15_MIRROR__db91"></a><span class="l"><a class="anc" name="db91" href="#db91">[db91]</a><a href="#:db91:@LAB_PRG15_MIRROR__db91" class="lla">@LAB_PRG15_MIRROR__db91:</a><span class="ce">; [$db91]</span></span>
<span class="l"><a class="anc" name="db91" href="#db91">[db91]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span></span>
<span class="l"><a class="anc" name="db94" href="#db94">[db94]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="db97" href="#db97">[db97]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ClearSprites">Screen_ClearSprites</a></span></span></span>
<span class="l"><a class="anc" name="db9a" href="#db9a">[db9a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a></span></span></span>
<span class="l"><a class="anc" name="db9d" href="#db9d">[db9d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="dba0" href="#dba0">[dba0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
<span class="l"><a class="anc" name="dba3" href="#dba3">[dba3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WaitUntilFlushed">PPU_WaitUntilFlushed</a></span></span></span>
<span class="l"><a class="anc" name="dba6" href="#dba6">[dba6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_UpdateForScroll">Game_UpdateForScroll</a></span></span></span>
<span class="l"><a class="anc" name="dba9" href="#dba9">[dba9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetForGamePlay">Screen_ResetForGamePlay</a></span></span></span>
<span class="l"><a class="anc" name="dbac" href="#dbac">[dbac]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
<span class="l"></span>
<a name=":dbaf:@LAB_PRG15_MIRROR__dbaf"></a><span class="l"><a class="anc" name="dbaf" href="#dbaf">[dbaf]</a><a href="#:dbaf:@LAB_PRG15_MIRROR__dbaf" class="lla">@LAB_PRG15_MIRROR__dbaf:</a><span class="ce">; [$dbaf]</span></span>
<span class="l"><a class="anc" name="dbaf" href="#dbaf">[dbaf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="dbb2" href="#dbb2">[dbb2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span></span>
<span class="l"><a class="anc" name="dbb5" href="#dbb5">[dbb5]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b982</span></span></span>
<span class="l"><a class="anc" name="dbb8" href="#dbb8">[dbb8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span></span>
<span class="l"><a class="anc" name="dbbb" href="#dbbb">[dbbb]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7d6</span></span></span>
<span class="l"><a class="anc" name="dbbe" href="#dbbe">[dbbe]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ClearSprites">Screen_ClearSprites</a></span></span></span>
<span class="l"><a class="anc" name="dbc1" href="#dbc1">[dbc1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a></span></span></span>
<span class="l"><a class="anc" name="dbc4" href="#dbc4">[dbc4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="dbc7" href="#dbc7">[dbc7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span></span>
<span class="l"></span>
<a name=":dbca:@_scrolling"></a><span class="l"><a class="anc" name="dbca" href="#dbca">[dbca]</a><a href="#:dbca:@_scrolling" class="lla">@_scrolling:</a><span class="ce">; [$dbca]</span></span>
<span class="l"><a class="anc" name="dbca" href="#dbca">[dbca]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span></span>
<span class="l"><a class="anc" name="dbcd" href="#dbcd">[dbcd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span></span>
<span class="l"><a class="anc" name="dbd0" href="#dbd0">[dbd0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_UpdatePlayerOnScroll">Game_UpdatePlayerOnScroll</a></span></span></span>
<span class="l"><a class="anc" name="dbd3" href="#dbd3">[dbd3]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b982</span></span></span>
<span class="l"><a class="anc" name="dbd6" href="#dbd6">[dbd6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span></span>
<span class="l"><a class="anc" name="dbd9" href="#dbd9">[dbd9]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7d6</span></span></span>
<span class="l"><a class="anc" name="dbdc" href="#dbdc">[dbdc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_HandleScroll">Screen_HandleScroll</a></span></span></span>
<span class="l"><a class="anc" name="dbdf" href="#dbdf">[dbdf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_HandleScroll">Screen_HandleScroll</a></span></span></span>
<span class="l"><a class="anc" name="dbe2" href="#dbe2">[dbe2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_HandleScroll">Screen_HandleScroll</a></span></span></span>
<span class="l"><a class="anc" name="dbe5" href="#dbe5">[dbe5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_HandleScroll">Screen_HandleScroll</a></span></span></span>
<span class="l"><a class="anc" name="dbe8" href="#dbe8">[dbe8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="dbea" href="#dbea">[dbea]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_scrolling">@_scrolling</a></span></span></span>
<span class="l"><a class="anc" name="dbec" href="#dbec">[dbec]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_MainLoop">Game_MainLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="EndGame_MainLoop"></a><div class="cp">;============================================================================
; Mainloop for the end of the game.
;
; This will act as a normal mainloop, except the button
; inputs will be simulated to approach the King and trigger
; the dialogue.
;
; The actual ending-game sequence happens after interacting
; with the King, which uses an IScript action to initiate
; the end-game outro sequence.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#EndGame_MovePlayerTowardKing">EndGame_MovePlayerTowardKing</a>
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#Fog_OnTick">Fog_OnTick</a>
;     <a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a>
;     <a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a>
;     <a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a>
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;     <a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a>
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;     <a href="PRG14.html#Player_DrawShield">Player_DrawShield</a>
;     <a href="PRG14.html#Player_DrawWeapon">Player_DrawWeapon</a>
;     Sprites_UpdateAll
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a>
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="dbef" href="#dbef">[dbef]</a><a href="#EndGame_MainLoop" class="la">EndGame_MainLoop:</a><span class="ce">; [$dbef]</span></span>
<span class="l"><a class="anc" name="dbef" href="#dbef">[dbef]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF (unused -- noop)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14.
;
</div><span class="l"><a class="anc" name="dbf1" href="#dbf1">[dbf1]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><a class="anc" name="dbf3" href="#dbf3">[dbf3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Set bank to 14 (Logic).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Wait for a frame and prepare for renders.
;
</div><span class="l"><a class="anc" name="dbf6" href="#dbf6">[dbf6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="dbf9" href="#dbf9">[dbf9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForGamePlay">Screen_ResetSpritesForGamePlay</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Move the player a step/jump toward the King, or begin
; interaction, depending on position.
;
</div><span class="l"><a class="anc" name="dbfc" href="#dbfc">[dbfc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#EndGame_MovePlayerTowardKing">EndGame_MovePlayerTowardKing</a></span></span><span class="ce">; Simulate the player's button press.</span></span>
<span class="l"><a class="anc" name="dbff" href="#dbff">[dbff]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a></span></span><span class="ce">; Update the player's position/state.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Perform all the standard mainloop operations.
;
</div><span class="l"><a class="anc" name="dc02" href="#dc02">[dc02]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b982</span></span><span class="ce">; Draw the shield.</span></span>
<span class="l"><a class="anc" name="dc05" href="#dc05">[dc05]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the armor.</span></span>
<span class="l"><a class="anc" name="dc08" href="#dc08">[dc08]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7d6</span></span><span class="ce">; Draw the weapon.</span></span>
<span class="l"><a class="anc" name="dc0b" href="#dc0b">[dc0b]</a><span class="cd"><span class="i">JSR</span> <span class="o">$ba5b</span></span><span class="ce">; No-op</span></span>
<span class="l"><a class="anc" name="dc0e" href="#dc0e">[dc0e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckUseCurrentItem">GameLoop_CheckUseCurrentItem</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><a class="anc" name="dc11" href="#dc11">[dc11]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Update sprites.</span></span>
<span class="l"><a class="anc" name="dc14" href="#dc14">[dc14]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CountdownItems">GameLoop_CountdownItems</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><a class="anc" name="dc17" href="#dc17">[dc17]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Fog_OnTick">Fog_OnTick</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><a class="anc" name="dc1a" href="#dc1a">[dc1a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><a class="anc" name="dc1d" href="#dc1d">[dc1d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a></span></span><span class="ce">; No-op</span></span>
<span class="l"><a class="anc" name="dc20" href="#dc20">[dc20]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#EndGame_MainLoop">EndGame_MainLoop</a></span></span><span class="ce">; Loop.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="EndGame_MovePlayerTowardKing"></a><div class="cp">;============================================================================
; Move the player toward the King in the end-game.
;
; This will move the player by simulating holding down the
; Left joypad button, pressing the A button when at the
; stairs, and pressing Up when at the King.
;
; This is all done by factoring in the current player position:
;
; 1. Press Left until at X=79.
;
; 2. At X=79, keep pressing Jump and left.
;
; 3. At X=68, release and press Up.
;
; INPUTS:
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The current player X position.
;
; OUTPUTS:
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The simulated button presses.
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="dc23" href="#dc23">[dc23]</a><a href="#EndGame_MovePlayerTowardKing" class="la">EndGame_MovePlayerTowardKing:</a><span class="ce">; [$dc23]</span></span>
<span class="l"><a class="anc" name="dc23" href="#dc23">[dc23]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; A = player X.</span></span>
<span class="l"><a class="anc" name="dc25" href="#dc25">[dc25]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$61</span></span><span class="ce">; Is it &gt;= 97?</span></span>
<span class="l"><a class="anc" name="dc27" href="#dc27">[dc27]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_setButtonsLeft">@_setButtonsLeft</a></span></span><span class="ce">; If so, jump to just press Left.</span></span>
<span class="l"><a class="anc" name="dc29" href="#dc29">[dc29]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$50</span></span><span class="ce">; Is it &gt;= 80?</span></span>
<span class="l"><a class="anc" name="dc2b" href="#dc2b">[dc2b]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_setJumpLeft">@_setJumpLeft</a></span></span><span class="ce">; If so, jump to press Left+A.</span></span>
<span class="l"><a class="anc" name="dc2d" href="#dc2d">[dc2d]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$44</span></span><span class="ce">; Is it &gt;= 68?</span></span>
<span class="l"><a class="anc" name="dc2f" href="#dc2f">[dc2f]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_setButtonsLeft">@_setButtonsLeft</a></span></span><span class="ce">; If so, jump to press Left.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Simulate pressing Up to engage with the King.
;
</div><span class="l"><a class="anc" name="dc31" href="#dc31">[dc31]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; 0x08 == Up button bitmask.</span></span>
<span class="l"><a class="anc" name="dc33" href="#dc33">[dc33]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set as the current button mask.</span></span>
<span class="l"><a class="anc" name="dc35" href="#dc35">[dc35]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Set as the changed button mask.</span></span>
<span class="l"><a class="anc" name="dc37" href="#dc37">[dc37]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":dc38:@_setButtonsLeft"></a><div class="c">;
; Simulate pressing Left.
;
</div><span class="l"><a class="anc" name="dc38" href="#dc38">[dc38]</a><a href="#:dc38:@_setButtonsLeft" class="lla">@_setButtonsLeft:</a><span class="ce">; [$dc38]</span></span>
<span class="l"><a class="anc" name="dc38" href="#dc38">[dc38]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span><span class="ce">; 0x02 == Left button bitmask.</span></span>
<span class="l"><a class="anc" name="dc3a" href="#dc3a">[dc3a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set as the current button mask.</span></span>
<span class="l"><a class="anc" name="dc3c" href="#dc3c">[dc3c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Set as the changed button mask.</span></span>
<span class="l"><a class="anc" name="dc3e" href="#dc3e">[dc3e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":dc3f:@_setJumpLeft"></a><div class="c">;
; Simulate pressing Left+A to jump left.
;
</div><span class="l"><a class="anc" name="dc3f" href="#dc3f">[dc3f]</a><a href="#:dc3f:@_setJumpLeft" class="lla">@_setJumpLeft:</a><span class="ce">; [$dc3f]</span></span>
<span class="l"><a class="anc" name="dc3f" href="#dc3f">[dc3f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$82</span></span><span class="ce">; 0x82 == Left + A button bitmask.</span></span>
<span class="l"><a class="anc" name="dc41" href="#dc41">[dc41]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set as the current button mask.</span></span>
<span class="l"><a class="anc" name="dc43" href="#dc43">[dc43]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Set as the changed button mask.</span></span>
<span class="l"></span>
<a name="RETURN_DC45"></a><div class="c">;
; XREFS:
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;
</div><span class="l"><a class="anc" name="dc45" href="#dc45">[dc45]</a><a href="#RETURN_DC45" class="la">RETURN_DC45:</a><span class="ce">; [$dc45]</span></span>
<span class="l"><a class="anc" name="dc45" href="#dc45">[dc45]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_DrawScreenInFrozenState"></a><div class="cp">;============================================================================
; Draw the player and sprites in a frozen state.
;
; This is used when needing to draw sprites without anything
; moving around or interacting with each other.
;
; It's invoked when writing messages, filling HP/MP, or in
; the end-game sequence.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>:
;         The loaded state for the sprites.
;
;         If 0xFF, this function will immediately return.
;
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The player's current status flag.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;     <a href="PRG14.html#Player_DrawShield">Player_DrawShield</a>
;     <a href="PRG14.html#Player_DrawWeapon">Player_DrawWeapon</a>
;     <a href="PRG14.html#Sprites_UpdateAll">Sprites_UpdateAll</a>
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;     <a href="#Player_FillHPAndMP">Player_FillHPAndMP</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;============================================================================
</div><span class="l"><a class="anc" name="dc46" href="#dc46">[dc46]</a><a href="#Game_DrawScreenInFrozenState" class="la">Game_DrawScreenInFrozenState:</a><span class="ce">; [$dc46]</span></span>
<span class="l"><a class="anc" name="dc46" href="#dc46">[dc46]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a></span></span><span class="ce">; Load the loaded state.</span></span>
<span class="l"><a class="anc" name="dc48" href="#dc48">[dc48]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="dc4a" href="#dc4a">[dc4a]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_DC45">RETURN_DC45</a></span></span><span class="ce">; If so, then return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14.
;
</div><span class="l"><a class="anc" name="dc4c" href="#dc4c">[dc4c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current bank.</span></span>
<span class="l"><a class="anc" name="dc4f" href="#dc4f">[dc4f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="dc50" href="#dc50">[dc50]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0e</span></span></span>
<span class="l"><a class="anc" name="dc52" href="#dc52">[dc52]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 14.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Temporarily clear Wing Boots state.
;
</div><span class="l"><a class="anc" name="dc55" href="#dc55">[dc55]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flag.</span></span>
<span class="l"><a class="anc" name="dc57" href="#dc57">[dc57]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack so it can be restored later.</span></span>
<span class="l"><a class="anc" name="dc58" href="#dc58">[dc58]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Keep all but the Wing Boots flag.</span></span>
<span class="l"><a class="anc" name="dc5a" href="#dc5a">[dc5a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the player.
;
</div><span class="l"><a class="anc" name="dc5c" href="#dc5c">[dc5c]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b982</span></span><span class="ce">; Draw the shield.</span></span>
<span class="l"><a class="anc" name="dc5f" href="#dc5f">[dc5f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawBody">Player_DrawBody</a></span></span><span class="ce">; Draw the armor.</span></span>
<span class="l"><a class="anc" name="dc62" href="#dc62">[dc62]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b7d6</span></span><span class="ce">; Draw the weapon.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the player's status flags.
;
</div><span class="l"><a class="anc" name="dc65" href="#dc65">[dc65]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the status flag.</span></span>
<span class="l"><a class="anc" name="dc66" href="#dc66">[dc66]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw all the sprites, but with sprites paused.
;
; This flag will will disable all behavioral updates for
; sprites.
;
</div><span class="l"><a class="anc" name="dc68" href="#dc68">[dc68]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; A = 1</span></span>
<span class="l"><a class="anc" name="dc6a" href="#dc6a">[dc6a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Sprites_UpdatesPaused">Sprites_UpdatesPaused</a></span></span><span class="ce">; Set as the paused state for sprites.</span></span>
<span class="l"><a class="anc" name="dc6d" href="#dc6d">[dc6d]</a><span class="cd"><span class="i">JSR</span> <span class="o">$8070</span></span><span class="ce">; Update all sprites.</span></span>
<span class="l"><a class="anc" name="dc70" href="#dc70">[dc70]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="dc72" href="#dc72">[dc72]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Sprites_UpdatesPaused">Sprites_UpdatesPaused</a></span></span><span class="ce">; Clear the paused state.</span></span>
<span class="l"><a class="anc" name="dc75" href="#dc75">[dc75]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore the previous bank.</span></span>
</pre><pre><a name="Game_LoadAreaTable"></a><div class="cp">;============================================================================
; TODO: Document Game_LoadAreaTable
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a class="anc" name="dc78" href="#dc78">[dc78]</a><a href="#Game_LoadAreaTable" class="la">Game_LoadAreaTable:</a><span class="ce">; [$dc78]</span></span>
<div class="c">;
; XXX Set the address for the area in the areas table.
;
</div><span class="l"><a class="anc" name="dc78" href="#dc78">[dc78]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dc79" href="#dc79">[dc79]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="dc7a" href="#dc7a">[dc7a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a>,Y</span></span></span>
<span class="l"><a class="anc" name="dc7d" href="#dc7d">[dc7d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_ScreenBlocksOffset">Area_ScreenBlocksOffset</a></span></span></span>
<span class="l"><a class="anc" name="dc7f" href="#dc7f">[dc7f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#ROMBankStart">ROMBankStart</a>+1,Y</span></span></span>
<span class="l"><a class="anc" name="dc82" href="#dc82">[dc82]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dc83" href="#dc83">[dc83]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dc85" href="#dc85">[dc85]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_ScreenBlocksOffset_U">Area_ScreenBlocksOffset_U</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current ROM bank and switch to bank 3, where the
; areas table lives.
;
</div><span class="l"><a class="anc" name="dc87" href="#dc87">[dc87]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="dc8a" href="#dc8a">[dc8a]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="dc8b" href="#dc8b">[dc8b]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="dc8d" href="#dc8d">[dc8d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="dc90" href="#dc90">[dc90]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the start of the area's pointer table in
; 0x{@address 007C}.
;
; This will be <a href="PRG3.html#AREAS_TABLE_PTR">AREAS_TABLE_PTR</a> in Bank 3.
;
</div><span class="l"><a class="anc" name="dc93" href="#dc93">[dc93]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><a class="anc" name="dc95" href="#dc95">[dc95]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a>+1</span></span></span>
<span class="l"><a class="anc" name="dc98" href="#dc98">[dc98]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dc99" href="#dc99">[dc99]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dc9b" href="#dc9b">[dc9b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="dc9d" href="#dc9d">[dc9d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="dc9f" href="#dc9f">[dc9f]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dca0" href="#dca0">[dca0]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="dca1" href="#dca1">[dca1]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dca3" href="#dca3">[dca3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a></span></span></span>
<span class="l"><a class="anc" name="dca5" href="#dca5">[dca5]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dca6" href="#dca6">[dca6]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dca8" href="#dca8">[dca8]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dca9" href="#dca9">[dca9]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dcab" href="#dcab">[dcab]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_TableAddr_U">CurrentArea_TableAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="dcad" href="#dcad">[dcad]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dcaf" href="#dcaf">[dcaf]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcb1" href="#dcb1">[dcb1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><a class="anc" name="dcb3" href="#dcb3">[dcb3]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dcb4" href="#dcb4">[dcb4]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcb6" href="#dcb6">[dcb6]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dcb7" href="#dcb7">[dcb7]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dcb9" href="#dcb9">[dcb9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store the addresses of the block attributes and 4 groups of
; block data in addresses {@address 007E}.
;
</div><span class="l"><a class="anc" name="dcbb" href="#dcbb">[dcbb]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dcbd" href="#dcbd">[dcbd]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$05</span></span></span>
<span class="l"></span>
<a name=":dcbf:@LAB_PRG15_MIRROR__dcbf"></a><span class="l"><a class="anc" name="dcbf" href="#dcbf">[dcbf]</a><a href="#:dcbf:@LAB_PRG15_MIRROR__dcbf" class="lla">@LAB_PRG15_MIRROR__dcbf:</a><span class="ce">; [$dcbf]</span></span>
<span class="l"><a class="anc" name="dcbf" href="#dcbf">[dcbf]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcc1" href="#dcc1">[dcc1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>,Y</span></span></span>
<span class="l"><a class="anc" name="dcc4" href="#dcc4">[dcc4]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dcc5" href="#dcc5">[dcc5]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcc7" href="#dcc7">[dcc7]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dcc8" href="#dcc8">[dcc8]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dcca" href="#dcca">[dcca]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>,Y</span></span></span>
<span class="l"><a class="anc" name="dccd" href="#dccd">[dccd]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dcce" href="#dcce">[dcce]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="dccf" href="#dccf">[dccf]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__dcbf">@LAB_PRG15_MIRROR__dcbf</a></span></span></span>
<span class="l"><a class="anc" name="dcd1" href="#dcd1">[dcd1]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$02</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the block properties, scrolling data, door locations,
; and door destinations addresses.
;
</div><span class="l"><a class="anc" name="dcd3" href="#dcd3">[dcd3]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcd5" href="#dcd5">[dcd5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockPropertiesAddr">CurrentArea_BlockPropertiesAddr</a></span></span></span>
<span class="l"><a class="anc" name="dcd7" href="#dcd7">[dcd7]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dcd8" href="#dcd8">[dcd8]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcda" href="#dcda">[dcda]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dcdb" href="#dcdb">[dcdb]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dcdd" href="#dcdd">[dcdd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockPropertiesAddr_U">CurrentArea_BlockPropertiesAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="dcdf" href="#dcdf">[dcdf]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="dce1" href="#dce1">[dce1]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dce3" href="#dce3">[dce3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ScrollingDataAddr">CurrentArea_ScrollingDataAddr</a></span></span></span>
<span class="l"><a class="anc" name="dce5" href="#dce5">[dce5]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dce6" href="#dce6">[dce6]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dce8" href="#dce8">[dce8]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dce9" href="#dce9">[dce9]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dceb" href="#dceb">[dceb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#ScrollingData_U">ScrollingData_U</a></span></span></span>
<span class="l"><a class="anc" name="dced" href="#dced">[dced]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="dcef" href="#dcef">[dcef]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcf1" href="#dcf1">[dcf1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr">CurrentArea_DoorLocationsAddr</a></span></span></span>
<span class="l"><a class="anc" name="dcf3" href="#dcf3">[dcf3]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dcf4" href="#dcf4">[dcf4]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcf6" href="#dcf6">[dcf6]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dcf7" href="#dcf7">[dcf7]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dcf9" href="#dcf9">[dcf9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr_U">CurrentArea_DoorLocationsAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="dcfb" href="#dcfb">[dcfb]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="dcfd" href="#dcfd">[dcfd]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dcff" href="#dcff">[dcff]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a></span></span></span>
<span class="l"><a class="anc" name="dd01" href="#dd01">[dd01]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="dd02" href="#dd02">[dd02]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_TableAddr">CurrentArea_TableAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="dd04" href="#dd04">[dd04]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="dd05" href="#dd05">[dd05]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="dd07" href="#dd07">[dd07]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorDestinationsAddr_U">CurrentArea_DoorDestinationsAddr_U</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to the previous bank.
;
</div><span class="l"><a class="anc" name="dd09" href="#dd09">[dd09]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="dd0a" href="#dd0a">[dd0a]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="dd0b" href="#dd0b">[dd0b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="dd0e" href="#dd0e">[dd0e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_UpdateForScroll"></a><div class="cp">;============================================================================
; Update the scroll state during a mainloop iteration.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="dd0f" href="#dd0f">[dd0f]</a><a href="#Game_UpdateForScroll" class="la">Game_UpdateForScroll:</a><span class="ce">; [$dd0f]</span></span>
<span class="l"><a class="anc" name="dd0f" href="#dd0f">[dd0f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a></span></span></span>
<span class="l"><a class="anc" name="dd12" href="#dd12">[dd12]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_SetupNew"></a><div class="cp">;============================================================================
; Set up state for a new screen.
;
; This is called when loading a new screen or entering a
; building. It's responsible for the following:
;
; * Setting the player sprite position and drawing it.
; * Loading common sprites.
; * Setting area/screen state (palette, positions,
;   scrolling).
; * Drawing the HUD.
;
; INPUTS:
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The screen index being loaded in the area.
;
;     <a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a>:
;         The screen palette being loaded.
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The starting position for the player.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The loaded screen index.
;
;     <a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a>:
;         The player's Y scroll position, set to 0.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;     <a href="RAM.html#Player_PosY">Player_PosY</a>:
;         The starting position for the player on the
;         screen, based on <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>.
;
;     <a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a>:
;     <a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a>:
;         The scroll screen, set to 0.
;
;     <a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a>:
;         The loaded palette.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The horizontal scroll counter, set to 0.
;
; CALLS:
;     <a href="#Area_ScrollScreenRight">Area_ScrollScreenRight</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;     <a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a>
;     <a href="#Sprites_LoadCommon">Sprites_LoadCommon</a>
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;     <a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a>
;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;     <a href="#Screen_Load">Screen_Load</a>
;============================================================================
</div><span class="l"><a class="anc" name="dd13" href="#dd13">[dd13]</a><a href="#Screen_SetupNew" class="la">Screen_SetupNew:</a><span class="ce">; [$dd13]</span></span>
<span class="l"><a class="anc" name="dd13" href="#dd13">[dd13]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a></span></span><span class="ce">; Draw the player sprite.</span></span>
<span class="l"><a class="anc" name="dd16" href="#dd16">[dd16]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_LoadCommon">Sprites_LoadCommon</a></span></span></span>
<span class="l"><a class="anc" name="dd19" href="#dd19">[dd19]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="dd1b" href="#dd1b">[dd1b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="dd1d" href="#dd1d">[dd1d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollScreenRight">Area_ScrollScreenRight</a></span></span></span>
<span class="l"><a class="anc" name="dd20" href="#dd20">[dd20]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a></span></span></span>
<span class="l"><a class="anc" name="dd23" href="#dd23">[dd23]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="dd25" href="#dd25">[dd25]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span></span>
<span class="l"><a class="anc" name="dd28" href="#dd28">[dd28]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadUIPalette">Screen_LoadUIPalette</a></span></span></span>
<span class="l"><a class="anc" name="dd2b" href="#dd2b">[dd2b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dd2d" href="#dd2d">[dd2d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="dd2f" href="#dd2f">[dd2f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span></span>
<span class="l"><a class="anc" name="dd31" href="#dd31">[dd31]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><a class="anc" name="dd33" href="#dd33">[dd33]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="dd35" href="#dd35">[dd35]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="dd37" href="#dd37">[dd37]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="dd39" href="#dd39">[dd39]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="dd3b" href="#dd3b">[dd3b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="dd3d" href="#dd3d">[dd3d]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dd3e" href="#dd3e">[dd3e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dd3f" href="#dd3f">[dd3f]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dd40" href="#dd40">[dd40]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dd41" href="#dd41">[dd41]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="dd43" href="#dd43">[dd43]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_SetHUDPPUAttributes">UI_SetHUDPPUAttributes</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_Load"></a><div class="cp">;============================================================================
; Load the current screen.
;
; This will set up the palette, reset sprites, load
; metadata for the screen (sprites, values, and special
; events), and prepare for rendering.
;
; INPUTS:
;     <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>:
;         The current loaded state.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>:
;         The new loaded state (0).
;
; CALLS:
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;     <a href="#Screen_ClearSprites">Screen_ClearSprites</a>
;     <a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a>
;     <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>
;     <a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a>
;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="dd46" href="#dd46">[dd46]</a><a href="#Screen_Load" class="la">Screen_Load:</a><span class="ce">; [$dd46]</span></span>
<span class="l"><a class="anc" name="dd46" href="#dd46">[dd46]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_SetupNew">Screen_SetupNew</a></span></span><span class="ce">; Draw the HUD and prepare setup for the screen.</span></span>
<span class="l"><a class="anc" name="dd49" href="#dd49">[dd49]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dd4b" href="#dd4b">[dd4b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span><span class="ce">; Load the palette.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_SetupSprites"></a><div class="cp">;============================================================================
; Set up sprites and palette for the screen.
;
; This will clear out the existing sprites and then load
; in new ones.
;
; After load, the screen will be set as ready and the
; palette written.
;
; INPUTS:
;     <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>:
;         The screen's current ready state.
;
; OUTPUTS:
;     <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>:
;         The new state, set to ready.
;
; CALLS:
;     <a href="#Screen_ClearSprites">Screen_ClearSprites</a>
;     <a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a>
;     <a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a>
;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;============================================================================
</div><span class="l"><a class="anc" name="dd4e" href="#dd4e">[dd4e]</a><a href="#Screen_SetupSprites" class="la">Screen_SetupSprites:</a><span class="ce">; [$dd4e]</span></span>
<div class="c">;
; Clear all the sprite data for the screen and load in
; new sprites.
;
; Note that this code checks <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>
; and only loads if it's not 1, but in the shipped game the
; only values are 0 and 0xFF, so the path always runs.
;
</div><span class="l"><a class="anc" name="dd4e" href="#dd4e">[dd4e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ClearSprites">Screen_ClearSprites</a></span></span><span class="ce">; Clear current sprite data.</span></span>
<span class="l"><a class="anc" name="dd51" href="#dd51">[dd51]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a></span></span><span class="ce">; Get the screen state.</span></span>
<span class="l"><a class="anc" name="dd53" href="#dd53">[dd53]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Is it 1? (DEADCODE: It never will be).</span></span>
<span class="l"><a class="anc" name="dd55" href="#dd55">[dd55]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_setReady">@_setReady</a></span></span><span class="ce">; If not, skip loading sprites.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load sprite information. Despite the conditional, this
; will always execute, since the screen state is never 1
; in the shipped again.
;
</div><span class="l"><a class="anc" name="dd57" href="#dd57">[dd57]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a></span></span><span class="ce">; Load information for the screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":dd5a:@_setReady"></a><div class="c">;
; Mark the screen as ready, and write the palette.
;
</div><span class="l"><a class="anc" name="dd5a" href="#dd5a">[dd5a]</a><a href="#:dd5a:@_setReady" class="lla">@_setReady:</a><span class="ce">; [$dd5a]</span></span>
<span class="l"><a class="anc" name="dd5a" href="#dd5a">[dd5a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dd5c" href="#dd5c">[dd5c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a></span></span><span class="ce">; Set the state to ready.</span></span>
<span class="l"><a class="anc" name="dd5e" href="#dd5e">[dd5e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span><span class="ce">; Write the palette to the PPU buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_SpawnInTemple"></a><div class="cp">;============================================================================
; Spawn the player in a temple.
;
; This is called when starting up a new life for the player.
; The player will be spawned in a temple, placed in the
; specified area and screen, using the correct palette and
; player positions.
;
; INPUTS:
;     <a href="RAM.html#TempleSpawnPoint">TempleSpawnPoint</a>:
;         The index of the template in which the player will
;         be spawned.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The starting screen outside the template.
;
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The area in which the player will be placed outside
;         the template.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The X position the player will be in outside the
;         temple.
;
;     <a href="RAM.html#Player_PosY">Player_PosY</a>:
;         The Y position the player will be in outside the
;         temple.
;
;     <a href="RAM.html#Area_DestScreen">Area_DestScreen</a>:
;         TODO
;
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         TODO
;
;     <a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a>:
;         TODO: The index of the palette outside the temple?
;
;     <a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a>:
;         The music to play outside the temple.
;
;     <a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a>:
;         The palette inside the temple.
;
;     <a href="RAM.html#Building_TilesIndex">Building_TilesIndex</a>:
;         Index for the building tiles.
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The start position inside the temple.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The music to play inside the temple.
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         TODO
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The new player flags (set to face left inside
;         the temple).
;
; XREFS:
;     <a href="#Player_Spawn">Player_Spawn</a>
;============================================================================
</div><span class="l"><a class="anc" name="dd61" href="#dd61">[dd61]</a><a href="#Game_SpawnInTemple" class="la">Game_SpawnInTemple:</a><span class="ce">; [$dd61]</span></span>
<div class="c">;
; Set the starting area/screen/position information outside the
; temple.
;
</div><span class="l"><a class="anc" name="dd61" href="#dd61">[dd61]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#TempleSpawnPoint">TempleSpawnPoint</a></span></span><span class="ce">; X = index of the temple spawn point.</span></span>
<span class="l"><a class="anc" name="dd64" href="#dd64">[dd64]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#START_SCREEN_FOR_TEMPLE_SPAWN">START_SCREEN_FOR_TEMPLE_SPAWN</a>,X</span></span><span class="ce">; Set the current screen for outside the temple.</span></span>
<span class="l"><a class="anc" name="dd67" href="#dd67">[dd67]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="dd69" href="#dd69">[dd69]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN">START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN</a>,X</span></span></span>
<span class="l"><a class="anc" name="dd6c" href="#dd6c">[dd6c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><a class="anc" name="dd6f" href="#dd6f">[dd6f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN">START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN</a>,X</span></span></span>
<span class="l"><a class="anc" name="dd72" href="#dd72">[dd72]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="dd74" href="#dd74">[dd74]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN">MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN</a>,X</span></span></span>
<span class="l"><a class="anc" name="dd77" href="#dd77">[dd77]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="dd79" href="#dd79">[dd79]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DEST_SCREEN_FOR_TEMPLE_SPAWN">DEST_SCREEN_FOR_TEMPLE_SPAWN</a>,X</span></span></span>
<span class="l"><a class="anc" name="dd7c" href="#dd7c">[dd7c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_DestScreen">Area_DestScreen</a></span></span></span>
<span class="l"><a class="anc" name="dd7f" href="#dd7f">[dd7f]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="#CURRENT_REGION_FOR_TEMPLE_SPAWN">CURRENT_REGION_FOR_TEMPLE_SPAWN</a>,X</span></span></span>
<span class="l"><a class="anc" name="dd82" href="#dd82">[dd82]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="dd84" href="#dd84">[dd84]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_PALETTE_INDEXES">AREA_PALETTE_INDEXES</a>,Y</span></span></span>
<span class="l"><a class="anc" name="dd87" href="#dd87">[dd87]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span></span>
<span class="l"><a class="anc" name="dd8a" href="#dd8a">[dd8a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>,Y</span></span></span>
<span class="l"><a class="anc" name="dd8d" href="#dd8d">[dd8d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a></span></span></span>
<span class="l"><a class="anc" name="dd90" href="#dd90">[dd90]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$12</span></span></span>
<span class="l"><a class="anc" name="dd92" href="#dd92">[dd92]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="dd94" href="#dd94">[dd94]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="dd96" href="#dd96">[dd96]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Building_TilesIndex">Building_TilesIndex</a></span></span></span>
<span class="l"><a class="anc" name="dd99" href="#dd99">[dd99]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$9e</span></span></span>
<span class="l"><a class="anc" name="dd9b" href="#dd9b">[dd9b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="dd9d" href="#dd9d">[dd9d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0e</span></span></span>
<span class="l"><a class="anc" name="dd9f" href="#dd9f">[dd9f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><a class="anc" name="dda2" href="#dda2">[dda2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="dda4" href="#dda4">[dda4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the player to face left inside the temple.
;
</div><span class="l"><a class="anc" name="dda6" href="#dda6">[dda6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="dda8" href="#dda8">[dda8]</a><span class="cd"><span class="i">AND</span> <span class="o">#$bf</span></span></span>
<span class="l"><a class="anc" name="ddaa" href="#ddaa">[ddaa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ddac" href="#ddac">[ddac]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="CURRENT_REGION_FOR_TEMPLE_SPAWN"></a><div class="cp">;============================================================================
; A mapping of Temple spawn positions to regions.
;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="ddad" href="#ddad">[ddad]</a><a href="#CURRENT_REGION_FOR_TEMPLE_SPAWN" class="la">CURRENT_REGION_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddad]</span></span>
<span class="l"><a class="anc" name="ddad" href="#ddad">[ddad]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><a class="anc" name="ddae" href="#ddae">[ddae]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="ddaf" href="#ddaf">[ddaf]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="ddb0" href="#ddb0">[ddb0]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><a class="anc" name="ddb1" href="#ddb1">[ddb1]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="ddb2" href="#ddb2">[ddb2]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="ddb3" href="#ddb3">[ddb3]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="ddb4" href="#ddb4">[ddb4]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN"></a><div class="cp">;============================================================================
; A mapping of Temple spawn positions to outside X positions.
;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="ddb5" href="#ddb5">[ddb5]</a><a href="#START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN" class="la">START_PLAYERPOSX_FULL_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddb5]</span></span>
<span class="l"><a class="anc" name="ddb5" href="#ddb5">[ddb5]</a><span class="cd"><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><a class="anc" name="ddb6" href="#ddb6">[ddb6]</a><span class="cd"><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="ddb7" href="#ddb7">[ddb7]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="ddb8" href="#ddb8">[ddb8]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><a class="anc" name="ddb9" href="#ddb9">[ddb9]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="ddba" href="#ddba">[ddba]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="ddbb" href="#ddbb">[ddbb]</a><span class="cd"><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="ddbc" href="#ddbc">[ddbc]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN"></a><div class="cp">;============================================================================
; A mapping of Temple spawn positions to outside Y positions.
;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="ddbd" href="#ddbd">[ddbd]</a><a href="#MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN" class="la">MAYBE_START_PLAYERPOSY_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddbd]</span></span>
<span class="l"><a class="anc" name="ddbd" href="#ddbd">[ddbd]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><a class="anc" name="ddbe" href="#ddbe">[ddbe]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="ddbf" href="#ddbf">[ddbf]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="ddc0" href="#ddc0">[ddc0]</a><span class="cd"><span class="i">db</span> <span class="o">$80</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><a class="anc" name="ddc1" href="#ddc1">[ddc1]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="ddc2" href="#ddc2">[ddc2]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="ddc3" href="#ddc3">[ddc3]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="ddc4" href="#ddc4">[ddc4]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="DEST_SCREEN_FOR_TEMPLE_SPAWN"></a><div class="cp">;============================================================================
; TODO: A mapping of Temple spawn positions to &lt;TODO&gt;.
;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="ddc5" href="#ddc5">[ddc5]</a><a href="#DEST_SCREEN_FOR_TEMPLE_SPAWN" class="la">DEST_SCREEN_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddc5]</span></span>
<span class="l"><a class="anc" name="ddc5" href="#ddc5">[ddc5]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><a class="anc" name="ddc6" href="#ddc6">[ddc6]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="ddc7" href="#ddc7">[ddc7]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="ddc8" href="#ddc8">[ddc8]</a><span class="cd"><span class="i">db</span> <span class="o">$1e</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><a class="anc" name="ddc9" href="#ddc9">[ddc9]</a><span class="cd"><span class="i">db</span> <span class="o">$23</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="ddca" href="#ddca">[ddca]</a><span class="cd"><span class="i">db</span> <span class="o">$2b</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="ddcb" href="#ddcb">[ddcb]</a><span class="cd"><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="ddcc" href="#ddcc">[ddcc]</a><span class="cd"><span class="i">db</span> <span class="o">$3c</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN"></a><div class="cp">;============================================================================
; A mapping of Temple spawn positions to next areas.
;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="ddcd" href="#ddcd">[ddcd]</a><a href="#START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN" class="la">START_MAYBE_NEXT_AREA_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddcd]</span></span>
<span class="l"><a class="anc" name="ddcd" href="#ddcd">[ddcd]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><a class="anc" name="ddce" href="#ddce">[ddce]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_TRUNK</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="ddcf" href="#ddcf">[ddcf]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_TRUNK</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="ddd0" href="#ddd0">[ddd0]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><a class="anc" name="ddd1" href="#ddd1">[ddd1]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="ddd2" href="#ddd2">[ddd2]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="ddd3" href="#ddd3">[ddd3]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="ddd4" href="#ddd4">[ddd4]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_DARTMOOR</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="START_SCREEN_FOR_TEMPLE_SPAWN"></a><div class="cp">;============================================================================
; A mapping of Temple spawn positions to start screens.
;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="ddd5" href="#ddd5">[ddd5]</a><a href="#START_SCREEN_FOR_TEMPLE_SPAWN" class="la">START_SCREEN_FOR_TEMPLE_SPAWN:</a><span class="ce">; [$ddd5]</span></span>
<span class="l"><a class="anc" name="ddd5" href="#ddd5">[ddd5]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]: First town</span></span>
<span class="l"><a class="anc" name="ddd6" href="#ddd6">[ddd6]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="ddd7" href="#ddd7">[ddd7]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="ddd8" href="#ddd8">[ddd8]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [3]: Fog</span></span>
<span class="l"><a class="anc" name="ddd9" href="#ddd9">[ddd9]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="ddda" href="#ddda">[ddda]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="dddb" href="#dddb">[dddb]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="dddc" href="#dddc">[dddc]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [7]: Final town</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="EndGame_MoveToKingsRoom"></a><div class="cp">;============================================================================
; Move the player to the King's Room for the end-game.
;
; This sets the state to load the King's Room and places
; the player in the correct place. The Temple music will
; be played while in the room.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's flags.
;
; OUTPUTS:
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The music to play for the area (Temple music).
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;     <a href="RAM.html#Area_DestScreen">Area_DestScreen</a>:
;         The screen to load (68).
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The new loading screen index.
;
;     <a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a>:
;         The palette for the room.
;
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The updated region (Eolis).
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The starting X/Y position (X=13, Y=9).
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated player's flags.
;
;     <a href="RAM.html#Building_TilesIndex">Building_TilesIndex</a>:
;         The tiles for the room.
;
; CALLS:
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;
; XREFS:
;     <a href="#EndGame_BeginKingsRoomSequence">EndGame_BeginKingsRoomSequence</a>
;============================================================================
</div><span class="l"><a class="anc" name="dddd" href="#dddd">[dddd]</a><a href="#EndGame_MoveToKingsRoom" class="la">EndGame_MoveToKingsRoom:</a><span class="ce">; [$dddd]</span></span>
<div class="c">;
; Move the player back to Eolis.
;
</div><span class="l"><a class="anc" name="dddd" href="#dddd">[dddd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dddf" href="#dddf">[dddf]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; Set the screen index to 0.</span></span>
<span class="l"><a class="anc" name="dde1" href="#dde1">[dde1]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Set the region to Eolis.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the Temple music.
;
</div><span class="l"><a class="anc" name="dde4" href="#dde4">[dde4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0d</span></span></span>
<span class="l"><a class="anc" name="dde6" href="#dde6">[dde6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Play the Temple music.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Move the player to the right of the room.
;
</div><span class="l"><a class="anc" name="dde9" href="#dde9">[dde9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$9d</span></span></span>
<span class="l"><a class="anc" name="ddeb" href="#ddeb">[ddeb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span><span class="ce">; Set the start position to X=13, Y=9.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the palette for the King's room.
;
</div><span class="l"><a class="anc" name="dded" href="#dded">[dded]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$11</span></span></span>
<span class="l"><a class="anc" name="ddef" href="#ddef">[ddef]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span><span class="ce">; Set the Palette for the King's room.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the King's Room screen.
;
</div><span class="l"><a class="anc" name="ddf1" href="#ddf1">[ddf1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$44</span></span></span>
<span class="l"><a class="anc" name="ddf3" href="#ddf3">[ddf3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Set the screen to 68.</span></span>
<span class="l"><a class="anc" name="ddf5" href="#ddf5">[ddf5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_DestScreen">Area_DestScreen</a></span></span></span>
<span class="l"><a class="anc" name="ddf8" href="#ddf8">[ddf8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="ddfa" href="#ddfa">[ddfa]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Building_TilesIndex">Building_TilesIndex</a></span></span><span class="ce">; Set the tiles to 6.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Face the player to the left.
;
</div><span class="l"><a class="anc" name="ddfd" href="#ddfd">[ddfd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player flags.</span></span>
<span class="l"><a class="anc" name="ddff" href="#ddff">[ddff]</a><span class="cd"><span class="i">AND</span> <span class="o">#$bf</span></span><span class="ce">; Set to facing left.</span></span>
<span class="l"><a class="anc" name="de01" href="#de01">[de01]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="de03" href="#de03">[de03]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a></span></span><span class="ce">; Trigger the Enter Building logic.</span></span>
</pre><pre><a name="Game_EnterBuilding"></a><div class="cp">;============================================================================
; TODO: Document Game_EnterBuilding
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a>
;============================================================================
</div><span class="l"><a class="anc" name="de06" href="#de06">[de06]</a><a href="#Game_EnterBuilding" class="la">Game_EnterBuilding:</a><span class="ce">; [$de06]</span></span>
<div class="c">;
; Unset the player's current weapon. Players can't attack in
; buildings.
;
</div><span class="l"><a class="anc" name="de06" href="#de06">[de06]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="de08" href="#de08">[de08]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span><span class="ce">; Clear the weapon.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the music for this area.
;
</div><span class="l"><a class="anc" name="de0b" href="#de0b">[de0b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Load the default music for the area.</span></span>
<span class="l"><a class="anc" name="de0e" href="#de0e">[de0e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Push a buch of state to return to when exiting the door.
;
</div><span class="l"><a class="anc" name="de10" href="#de10">[de10]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current area.</span></span>
<span class="l"><a class="anc" name="de12" href="#de12">[de12]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_SavedArea">Area_SavedArea</a></span></span><span class="ce">; Save it for when exiting the building.</span></span>
<span class="l"><a class="anc" name="de15" href="#de15">[de15]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Load the current screen in the area.</span></span>
<span class="l"><a class="anc" name="de17" href="#de17">[de17]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_SavedScreen">Area_SavedScreen</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"><a class="anc" name="de1a" href="#de1a">[de1a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span><span class="ce">; Load the current palette.</span></span>
<span class="l"><a class="anc" name="de1d" href="#de1d">[de1d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Screen_SavedPalette">Screen_SavedPalette</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the player's X/Y position (rounded to the nearest
; block).
;
</div><span class="l"><a class="anc" name="de20" href="#de20">[de20]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span><span class="ce">; Load the player's Y position.</span></span>
<span class="l"><a class="anc" name="de22" href="#de22">[de22]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Normalize to a block offset.</span></span>
<span class="l"><a class="anc" name="de24" href="#de24">[de24]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_SavedPosXY">Player_SavedPosXY</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"><a class="anc" name="de27" href="#de27">[de27]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player's block X position.</span></span>
<span class="l"><a class="anc" name="de29" href="#de29">[de29]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Normalize it to a block offset.</span></span>
<span class="l"><a class="anc" name="de2b" href="#de2b">[de2b]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift to the lower byte.</span></span>
<span class="l"><a class="anc" name="de2c" href="#de2c">[de2c]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="de2d" href="#de2d">[de2d]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="de2e" href="#de2e">[de2e]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="de2f" href="#de2f">[de2f]</a><span class="cd"><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#Player_SavedPosXY">Player_SavedPosXY</a></span></span><span class="ce">; Combine it with the saved X/Y position.</span></span>
<span class="l"><a class="anc" name="de32" href="#de32">[de32]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_SavedPosXY">Player_SavedPosXY</a></span></span><span class="ce">; And save it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the new area to enter and load it.
;
</div><span class="l"><a class="anc" name="de35" href="#de35">[de35]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="de37" href="#de37">[de37]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Set the current area to 4 (inside buildings)</span></span>
<span class="l"><a class="anc" name="de39" href="#de39">[de39]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>,X</span></span><span class="ce">; Load the bank for this area.</span></span>
<span class="l"><a class="anc" name="de3c" href="#de3c">[de3c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; Store as the current area ROM bank.</span></span>
<span class="l"><a class="anc" name="de3e" href="#de3e">[de3e]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><a class="anc" name="de40" href="#de40">[de40]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a></span></span><span class="ce">; Push the current bank and switch to the new one.</span></span>
<span class="l"><a class="anc" name="de43" href="#de43">[de43]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current area again.</span></span>
<span class="l"><a class="anc" name="de45" href="#de45">[de45]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>,X</span></span><span class="ce">; Get the index into the screen data table in this bank.</span></span>
<span class="l"><a class="anc" name="de48" href="#de48">[de48]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span><span class="ce">; Load the area table for the screen.</span></span>
<span class="l"><a class="anc" name="de4b" href="#de4b">[de4b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a></span></span><span class="ce">; Restore the previous bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the index into the tiles for this area and load them.
;
</div><span class="l"><a class="anc" name="de4e" href="#de4e">[de4e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Building_TilesIndex">Building_TilesIndex</a></span></span></span>
<span class="l"><a class="anc" name="de51" href="#de51">[de51]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span></span>
<span class="l"><a class="anc" name="de53" href="#de53">[de53]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadTiles">Area_LoadTiles</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the palette.
;
</div><span class="l"><a class="anc" name="de56" href="#de56">[de56]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="de58" href="#de58">[de58]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set up the screen and the sprites.
;
</div><span class="l"><a class="anc" name="de5b" href="#de5b">[de5b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_SetupNew">Screen_SetupNew</a></span></span></span>
<span class="l"><a class="anc" name="de5e" href="#de5e">[de5e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_DestScreen">Area_DestScreen</a></span></span></span>
<span class="l"><a class="anc" name="de61" href="#de61">[de61]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="de63" href="#de63">[de63]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_SetupSprites">Screen_SetupSprites</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Game_ExitBuilding"></a><div class="cp">;============================================================================
; TODO: Document Game_ExitBuilding
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a>
;============================================================================
</div><span class="l"><a class="anc" name="de66" href="#de66">[de66]</a><a href="#Game_ExitBuilding" class="la">Game_ExitBuilding:</a><span class="ce">; [$de66]</span></span>
<span class="l"><a class="anc" name="de66" href="#de66">[de66]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span></span>
<span class="l"><a class="anc" name="de69" href="#de69">[de69]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span></span>
<span class="l"><a class="anc" name="de6c" href="#de6c">[de6c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><a class="anc" name="de6f" href="#de6f">[de6f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span></span>
<span class="l"><a class="anc" name="de71" href="#de71">[de71]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#Area_SavedArea">Area_SavedArea</a></span></span></span>
<span class="l"><a class="anc" name="de74" href="#de74">[de74]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="de76" href="#de76">[de76]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>,X</span></span></span>
<span class="l"><a class="anc" name="de79" href="#de79">[de79]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><a class="anc" name="de7b" href="#de7b">[de7b]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><a class="anc" name="de7d" href="#de7d">[de7d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a></span></span></span>
<span class="l"><a class="anc" name="de80" href="#de80">[de80]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="de82" href="#de82">[de82]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>,X</span></span></span>
<span class="l"><a class="anc" name="de85" href="#de85">[de85]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span></span>
<span class="l"><a class="anc" name="de88" href="#de88">[de88]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a></span></span></span>
<span class="l"><a class="anc" name="de8b" href="#de8b">[de8b]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="de8d" href="#de8d">[de8d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>,X</span></span></span>
<span class="l"><a class="anc" name="de90" href="#de90">[de90]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span></span>
<span class="l"><a class="anc" name="de92" href="#de92">[de92]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadTiles">Area_LoadTiles</a></span></span></span>
<span class="l"><a class="anc" name="de95" href="#de95">[de95]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_SavedScreen">Area_SavedScreen</a></span></span></span>
<span class="l"><a class="anc" name="de98" href="#de98">[de98]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="de9a" href="#de9a">[de9a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_SavedPalette">Screen_SavedPalette</a></span></span></span>
<span class="l"><a class="anc" name="de9d" href="#de9d">[de9d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="de9f" href="#de9f">[de9f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_SavedPosXY">Player_SavedPosXY</a></span></span></span>
<span class="l"><a class="anc" name="dea2" href="#dea2">[dea2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="dea4" href="#dea4">[dea4]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_LoadFirstLevel"></a><div class="cp">;============================================================================
; Load the very first level.
;
; This will load the gates to Eolis, loading in all the
; area data, screen, tile data, and music.
;
; It also takes care of setting the player's initial HP.
;
; INPUTS:
;     <a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>:
;         Mapping of areas to PRG ROM banks.
;
;     <a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>:
;         Mapping of areas to sprite banks.
;
;     <a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>:
;         Mapping of areas to tile indexes.
;
;     <a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>:
;         Mapping of areas to music.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area (Eolis).
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen.
;
;     <a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a>:
;         The palette for the area.
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The current screen index.
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The starting X/Y position.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the area.
;
;     CurrentROMBank:
;         The starting ROM bank.
;
;     <a href="RAM.html#Music_Current">Music_Current</a>:
;         The current music to play.
;
;     <a href="RAM.html#Player_HP_U">Player_HP_U</a>:
;         The player's starting HP (16).
;
;     <a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a>:
;         The tiles index for the area.
;
; CALLS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;     <a href="#Screen_Load">Screen_Load</a>
;     <a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a>
;     <a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a>
;     <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>
;     <a href="#Player_SetInitialState">Player_SetInitialState</a>
;
; XREFS:
;     <a href="#Game_Start">Game_Start</a>
;============================================================================
</div><span class="l"><a class="anc" name="dea7" href="#dea7">[dea7]</a><a href="#Game_LoadFirstLevel" class="la">Game_LoadFirstLevel:</a><span class="ce">; [$dea7]</span></span>
<span class="l"><a class="anc" name="dea7" href="#dea7">[dea7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set this as the current town.
;
</div><span class="l"><a class="anc" name="dea9" href="#dea9">[dea9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Set the current area to 0 (Eolis).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the initial state of the player, and hard-code their
; health to the starting amount of 16HP.
;
</div><span class="l"><a class="anc" name="deab" href="#deab">[deab]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetInitialState">Player_SetInitialState</a></span></span><span class="ce">; Set the initial player state.</span></span>
<span class="l"><a class="anc" name="deae" href="#deae">[deae]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="deb0" href="#deb0">[deb0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span><span class="ce">; Set the HP to 16.</span></span>
<span class="l"><a class="anc" name="deb3" href="#deb3">[deb3]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = Current area</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the block properties for this area.
;
; The bank containing the properties for the area will
; be loaded temporarily while fetching the block properties.
;
</div><span class="l"><a class="anc" name="deb5" href="#deb5">[deb5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>,X</span></span><span class="ce">; A = PRG bank for the area.</span></span>
<span class="l"><a class="anc" name="deb8" href="#deb8">[deb8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; Store as the current bank.</span></span>
<span class="l"><a class="anc" name="deba" href="#deba">[deba]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; X = current bank.</span></span>
<span class="l"><a class="anc" name="debc" href="#debc">[debc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a></span></span><span class="ce">; Push the current bank and update to this area's bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the area information.
;
; NOTE: There's a bug here. This *should* be passing in the
;       area index, but it's mistakenly passing in the resulting
;       ROM bank. In the shipped game, this is 0 in both cases,
;       but it means that any shuffling around of banks will do
;       the wrong thing if not starting with area 0, bank 0.
;
</div><span class="l"><a class="anc" name="debf" href="#debf">[debf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>,X</span></span><span class="ce">; A = sprite bank for the area.</span></span>
<span class="l"><a class="anc" name="dec2" href="#dec2">[dec2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span><span class="ce">; Load the area information.</span></span>
<span class="l"><a class="anc" name="dec5" href="#dec5">[dec5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a></span></span><span class="ce">; Restore the previous bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Start on the current screen.
;
</div><span class="l"><a class="anc" name="dec8" href="#dec8">[dec8]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="deca" href="#deca">[deca]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="decc" href="#decc">[decc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Current screen = 0</span></span>
<span class="l"><a class="anc" name="dece" href="#dece">[dece]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; Screen index = 0</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tiles and images for the area.
;
</div><span class="l"><a class="anc" name="ded0" href="#ded0">[ded0]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="ded2" href="#ded2">[ded2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>,X</span></span><span class="ce">; A = tiles index.</span></span>
<span class="l"><a class="anc" name="ded5" href="#ded5">[ded5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span><span class="ce">; Store that.</span></span>
<span class="l"><a class="anc" name="ded7" href="#ded7">[ded7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadTiles">Area_LoadTiles</a></span></span><span class="ce">; Load the tileset pages for that index.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the palette for the area.
;
</div><span class="l"><a class="anc" name="deda" href="#deda">[deda]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dedc" href="#dedc">[dedc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span><span class="ce">; Load the palette for that index.</span></span>
<span class="l"><a class="anc" name="dedf" href="#dedf">[dedf]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="dee1" href="#dee1">[dee1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_PALETTE_INDEXES">AREA_PALETTE_INDEXES</a>,X</span></span><span class="ce">; Load the palette.</span></span>
<span class="l"><a class="anc" name="dee4" href="#dee4">[dee4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span><span class="ce">; And store it as the current one for the area.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the music for this area.
;
</div><span class="l"><a class="anc" name="dee6" href="#dee6">[dee6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>,X</span></span><span class="ce">; Load the music for the area.</span></span>
<span class="l"><a class="anc" name="dee9" href="#dee9">[dee9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; And store it as the current music.</span></span>
<span class="l"><a class="anc" name="deeb" href="#deeb">[deeb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; And as the default for the area.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the start X/Y position for the player as X=1, Y=9.
;
</div><span class="l"><a class="anc" name="deee" href="#deee">[deee]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$91</span></span></span>
<span class="l"><a class="anc" name="def0" href="#def0">[def0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span><span class="ce">; Set start position.</span></span>
<span class="l"><a class="anc" name="def2" href="#def2">[def2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span><span class="ce">; Load this screen.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_LoadCurrentArea"></a><div class="cp">;============================================================================
; Load the information on the current area.
;
; This will load the area data, tile data, palette, and
; music.
;
; INPUTS:
;     <a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>:
;         Mapping of areas to PRG ROM banks.
;
;     <a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>:
;         Mapping of areas to sprite banks.
;
;     <a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>:
;         Mapping of areas to tile indexes.
;
;     <a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>:
;         Mapping of areas to music.
;
; OUTPUTS:
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen.
;
;     <a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a>:
;         The palette for the area.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the area.
;
;     CurrentROMBank:
;         The starting ROM bank.
;
;     <a href="RAM.html#Music_Current">Music_Current</a>:
;         The current music to play.
;
;     <a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a>:
;         The tiles index for the area.
;
; CALLS:
;     <a href="#Area_LoadTiles">Area_LoadTiles</a>
;     <a href="#Screen_Load">Screen_Load</a>
;     <a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a>
;     <a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a>
;     <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>
;     <a href="#Player_SetInitialState">Player_SetInitialState</a>
;
; XREFS:
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;============================================================================
</div><span class="l"><a class="anc" name="def5" href="#def5">[def5]</a><a href="#Game_LoadCurrentArea" class="la">Game_LoadCurrentArea:</a><span class="ce">; [$def5]</span></span>
<span class="l"><a class="anc" name="def5" href="#def5">[def5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetInitialState">Player_SetInitialState</a></span></span><span class="ce">; Set the initial player state.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the bank for this area.
;
</div><span class="l"><a class="anc" name="def8" href="#def8">[def8]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="defa" href="#defa">[defa]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>,X</span></span><span class="ce">; Load the ROM bank for the area.</span></span>
<span class="l"><a class="anc" name="defd" href="#defd">[defd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; Store that as the current bank.</span></span>
<span class="l"><a class="anc" name="deff" href="#deff">[deff]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span><span class="ce">; X = current bank.</span></span>
<span class="l"><a class="anc" name="df01" href="#df01">[df01]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a></span></span><span class="ce">; Save the current bank and switch to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the bank for the sprites for this area.
;
</div><span class="l"><a class="anc" name="df04" href="#df04">[df04]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="df06" href="#df06">[df06]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>,X</span></span><span class="ce">; A = bank for the sprites.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load information on the area.
;
</div><span class="l"><a class="anc" name="df09" href="#df09">[df09]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span><span class="ce">; Load the table of information on this area.</span></span>
<span class="l"><a class="anc" name="df0c" href="#df0c">[df0c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a></span></span><span class="ce">; Restore to the previous bank.</span></span>
<span class="l"><a class="anc" name="df0f" href="#df0f">[df0f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; A = current screen index.</span></span>
<span class="l"><a class="anc" name="df11" href="#df11">[df11]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Store as the current screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tiles for the area.
;
</div><span class="l"><a class="anc" name="df13" href="#df13">[df13]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="df15" href="#df15">[df15]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>,X</span></span><span class="ce">; A = tiles index for the area.</span></span>
<span class="l"><a class="anc" name="df18" href="#df18">[df18]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span><span class="ce">; Store as the current tiles index.</span></span>
<span class="l"><a class="anc" name="df1a" href="#df1a">[df1a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadTiles">Area_LoadTiles</a></span></span><span class="ce">; Load all tileset images for that index.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the palette for the area.
;
</div><span class="l"><a class="anc" name="df1d" href="#df1d">[df1d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="df1f" href="#df1f">[df1f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span><span class="ce">; Load palette 0.</span></span>
<span class="l"><a class="anc" name="df22" href="#df22">[df22]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; X = current area.</span></span>
<span class="l"><a class="anc" name="df24" href="#df24">[df24]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_PALETTE_INDEXES">AREA_PALETTE_INDEXES</a>,X</span></span><span class="ce">; Load the palette for the area.</span></span>
<span class="l"><a class="anc" name="df27" href="#df27">[df27]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span><span class="ce">; Store as the current palette.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the music for the area.
;
</div><span class="l"><a class="anc" name="df29" href="#df29">[df29]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>,X</span></span><span class="ce">; Load the music for the area.</span></span>
<span class="l"><a class="anc" name="df2c" href="#df2c">[df2c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"><a class="anc" name="df2e" href="#df2e">[df2e]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Store as the default.</span></span>
<span class="l"><a class="anc" name="df31" href="#df31">[df31]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span><span class="ce">; Load this screen.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="AREA_TO_SCREEN_DATA_BANKS"></a><div class="cp">;============================================================================
; A mapping of areas to the ROM banks containing block/area data.
;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;
</div><span class="l"><a class="anc" name="df34" href="#df34">[df34]</a><a href="#AREA_TO_SCREEN_DATA_BANKS" class="la">AREA_TO_SCREEN_DATA_BANKS:</a><span class="ce">; [$df34]</span></span>
<span class="l"><a class="anc" name="df34" href="#df34">[df34]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_0_AREA_DATA</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="df35" href="#df35">[df35]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_1_AREA_DATA</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="df36" href="#df36">[df36]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_0_AREA_DATA</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="df37" href="#df37">[df37]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_0_AREA_DATA</span></span><span class="ce">; [3]: Mascon</span></span>
<span class="l"></span>
<a name="AREA_TO_SCREEN_DATA_BANKS_4_"></a><div class="c">;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;
</div><span class="l"><a class="anc" name="df38" href="#df38">[df38]</a><a href="#AREA_TO_SCREEN_DATA_BANKS_4_" class="la">AREA_TO_SCREEN_DATA_BANKS_4_:</a><span class="ce">; [$df38]</span></span>
<span class="l"><a class="anc" name="df38" href="#df38">[df38]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_2_AREA_DATA</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="df39" href="#df39">[df39]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_1_AREA_DATA</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="df3a" href="#df3a">[df3a]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_2_AREA_DATA</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="df3b" href="#df3b">[df3b]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_2_AREA_DATA</span></span><span class="ce">; [7]: Evil Fortress</span></span>
<span class="l"></span>
<a name="AREA_TO_BANK_OFFSET"></a><div class="c">;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;
</div><span class="l"><a class="anc" name="df3c" href="#df3c">[df3c]</a><a href="#AREA_TO_BANK_OFFSET" class="la">AREA_TO_BANK_OFFSET:</a><span class="ce">; [$df3c]</span></span>
<span class="l"><a class="anc" name="df3c" href="#df3c">[df3c]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_0_AREA_DATA</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="df3d" href="#df3d">[df3d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_0_AREA_DATA</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="df3e" href="#df3e">[df3e]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_1_AREA_DATA</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="df3f" href="#df3f">[df3f]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_2_AREA_DATA</span></span><span class="ce">; [3]: Mascon</span></span>
<span class="l"></span>
<a name="AREA_TO_BANK_OFFSET_4_"></a><div class="c">;
; XREFS:
;     <a href="#Game_EnterBuilding">Game_EnterBuilding</a>
;
</div><span class="l"><a class="anc" name="df40" href="#df40">[df40]</a><a href="#AREA_TO_BANK_OFFSET_4_" class="la">AREA_TO_BANK_OFFSET_4_:</a><span class="ce">; [$df40]</span></span>
<span class="l"><a class="anc" name="df40" href="#df40">[df40]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_1_AREA_DATA</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="df41" href="#df41">[df41]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_1_AREA_DATA</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="df42" href="#df42">[df42]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_0_AREA_DATA</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="df43" href="#df43">[df43]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_2_AREA_DATA</span></span><span class="ce">; [7]: Evil Fortress</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="CURRENT_AREA_TO_TILES_INDEX_TABLE"></a><div class="cp">;============================================================================
; Pointers into 0xCF07 addressed by chunk ID
;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_ExitBuilding">Game_ExitBuilding</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;
</div><span class="l"><a class="anc" name="df44" href="#df44">[df44]</a><a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE" class="la">CURRENT_AREA_TO_TILES_INDEX_TABLE:</a><span class="ce">; [$df44]</span></span>
<span class="l"><a class="anc" name="df44" href="#df44">[df44]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="df45" href="#df45">[df45]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]: First town</span></span>
<span class="l"><a class="anc" name="df46" href="#df46">[df46]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="df47" href="#df47">[df47]</a><span class="cd"><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="df48" href="#df48">[df48]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="df49" href="#df49">[df49]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="df4a" href="#df4a">[df4a]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="df4b" href="#df4b">[df4b]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [7]: Final boss room</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="AREA_PALETTE_INDEXES"></a><div class="cp">;============================================================================
; Mapping of areas to palette indexes.
;
; XREFS:
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="df4c" href="#df4c">[df4c]</a><a href="#AREA_PALETTE_INDEXES" class="la">AREA_PALETTE_INDEXES:</a><span class="ce">; [$df4c]</span></span>
<span class="l"><a class="anc" name="df4c" href="#df4c">[df4c]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_EOLIS</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="df4d" href="#df4d">[df4d]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="df4e" href="#df4e">[df4e]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="df4f" href="#df4f">[df4f]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="df50" href="#df50">[df50]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="df51" href="#df51">[df51]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="df52" href="#df52">[df52]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_DARTMOOR</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="df53" href="#df53">[df53]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_EVIL_FORTRESS</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="df54" href="#df54">[df54]</a><span class="cd"><span class="i">hex</span> <span class="o">00 00 00 00 00 00 00 00</span></span><span class="ce">; [$df54] undefined</span></span>
<span class="l"></span>
<a name="AREA_TO_MUSIC_TABLE"></a><div class="c">;
; XREFS:
;     <a href="#Game_EnterAreaHandler">Game_EnterAreaHandler</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;     <a href="#Game_SpawnInTemple">Game_SpawnInTemple</a>
;
</div><span class="l"><a class="anc" name="df5c" href="#df5c">[df5c]</a><a href="#AREA_TO_MUSIC_TABLE" class="la">AREA_TO_MUSIC_TABLE:</a><span class="ce">; [$df5c]</span></span>
<span class="l"><a class="anc" name="df5c" href="#df5c">[df5c]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_EOLIS</span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="df5d" href="#df5d">[df5d]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_APOLUNE</span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="df5e" href="#df5e">[df5e]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_FOREPAW</span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="df5f" href="#df5f">[df5f]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_MASCON_VICTIM</span></span><span class="ce">; [3]: Mascon</span></span>
<span class="l"><a class="anc" name="df60" href="#df60">[df60]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_MASCON_VICTIM</span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="df61" href="#df61">[df61]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_CONFLATE</span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="df62" href="#df62">[df62]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_DAYBREAK</span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="df63" href="#df63">[df63]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_EVIL_FORTRESS</span></span><span class="ce">; [7]: Evil Fortress</span></span>
<span class="l"></span>
</pre><pre><a name="Game_EnterAreaHandler"></a><div class="cp">;============================================================================
; TODO: Document Game_EnterAreaHandler
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_SetupNewArea">Game_SetupNewArea</a>
;============================================================================
</div><span class="l"><a class="anc" name="df64" href="#df64">[df64]</a><a href="#Game_EnterAreaHandler" class="la">Game_EnterAreaHandler:</a><span class="ce">; [$df64]</span></span>
<span class="l"><a class="anc" name="df64" href="#df64">[df64]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="df66" href="#df66">[df66]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_SCREEN_DATA_BANKS">AREA_TO_SCREEN_DATA_BANKS</a>,X</span></span></span>
<span class="l"><a class="anc" name="df69" href="#df69">[df69]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><a class="anc" name="df6b" href="#df6b">[df6b]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#CurrentArea_ROMBank">CurrentArea_ROMBank</a></span></span></span>
<span class="l"><a class="anc" name="df6d" href="#df6d">[df6d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_SaveROMBankAndUpdateTo">MMC1_SaveROMBankAndUpdateTo</a></span></span></span>
<span class="l"><a class="anc" name="df70" href="#df70">[df70]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="df72" href="#df72">[df72]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_BANK_OFFSET">AREA_TO_BANK_OFFSET</a>,X</span></span></span>
<span class="l"><a class="anc" name="df75" href="#df75">[df75]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_LoadAreaTable">Game_LoadAreaTable</a></span></span></span>
<span class="l"><a class="anc" name="df78" href="#df78">[df78]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_RestorePrevROMBank">MMC1_RestorePrevROMBank</a></span></span></span>
<span class="l"><a class="anc" name="df7b" href="#df7b">[df7b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="df7d" href="#df7d">[df7d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="df7f" href="#df7f">[df7f]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="df81" href="#df81">[df81]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TO_MUSIC_TABLE">AREA_TO_MUSIC_TABLE</a>,X</span></span></span>
<span class="l"><a class="anc" name="df84" href="#df84">[df84]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span></span>
<span class="l"><a class="anc" name="df86" href="#df86">[df86]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><a class="anc" name="df89" href="#df89">[df89]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#CURRENT_AREA_TO_TILES_INDEX_TABLE">CURRENT_AREA_TO_TILES_INDEX_TABLE</a>,X</span></span></span>
<span class="l"><a class="anc" name="df8c" href="#df8c">[df8c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_TilesIndex">Area_TilesIndex</a></span></span></span>
<span class="l"><a class="anc" name="df8e" href="#df8e">[df8e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_LoadTiles">Area_LoadTiles</a></span></span></span>
<span class="l"><a class="anc" name="df91" href="#df91">[df91]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="df93" href="#df93">[df93]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span></span>
<span class="l"><a class="anc" name="df96" href="#df96">[df96]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Screen_Load">Screen_Load</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Debug_ChooseArea"></a><div class="cp">;============================================================================
; Debug code to switch the current area region.
;
; This allows the player to control which part of the game
; they're in.
;
; By pressing Up on the second controller, the player will
; be moved up a region.
;
; By pressing Down, they player will be moved down a region.
;
; This isn't activated by default, but can be swapped in
; through the following Game Genie codes (overriding the
; ability to pause):
;
;     OPYISU
;     NIYIVU
;
; INPUTS:
;     <a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a>:
;         The second controller's button mask.
;
; OUTPUTS:
;     <a href="RAM.html#Area_Region">Area_Region</a>:
;         The updated region.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         Set to 0.
;
; CALLS:
;     <a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a>
;============================================================================
</div><span class="l"><a class="anc" name="df99" href="#df99">[df99]</a><a href="#Debug_ChooseArea" class="la">Debug_ChooseArea:</a><span class="ce">; [$df99]</span></span>
<span class="l"><a class="anc" name="df99" href="#df99">[df99]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy2_ButtonMask">Joy2_ButtonMask</a></span></span><span class="ce">; Load the player 2 controller buttons.</span></span>
<span class="l"><a class="anc" name="df9b" href="#df9b">[df9b]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0c</span></span><span class="ce">; Is Up or Down pressed?</span></span>
<span class="l"><a class="anc" name="df9d" href="#df9d">[df9d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_DFDD">RETURN_DFDD</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Figure out which region to switch to based on button press.
;
</div><span class="l"><a class="anc" name="df9f" href="#df9f">[df9f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$04</span></span><span class="ce">; Is Down pressed?</span></span>
<span class="l"><a class="anc" name="dfa1" href="#dfa1">[dfa1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_nextArea">@_nextArea</a></span></span><span class="ce">; If so, switch to the next area.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Up was pressed. Go forward a region.
;
</div><span class="l"><a class="anc" name="dfa3" href="#dfa3">[dfa3]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Increment the region.</span></span>
<span class="l"><a class="anc" name="dfa6" href="#dfa6">[dfa6]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; A = incremented region.</span></span>
<span class="l"><a class="anc" name="dfa9" href="#dfa9">[dfa9]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is it in bounds?</span></span>
<span class="l"><a class="anc" name="dfab" href="#dfab">[dfab]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_switchArea">@_switchArea</a></span></span><span class="ce">; If so, switch to the area.</span></span>
<span class="l"><a class="anc" name="dfad" href="#dfad">[dfad]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Else...</span></span>
<span class="l"><a class="anc" name="dfaf" href="#dfaf">[dfaf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Set the region to (Eolis).</span></span>
<span class="l"><a class="anc" name="dfb2" href="#dfb2">[dfb2]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_switchArea">@_switchArea</a></span></span><span class="ce">; And switch to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":dfb4:@_nextArea"></a><div class="c">;
; Down was pressed. Go back a region.
;
</div><span class="l"><a class="anc" name="dfb4" href="#dfb4">[dfb4]</a><a href="#:dfb4:@_nextArea" class="lla">@_nextArea:</a><span class="ce">; [$dfb4]</span></span>
<span class="l"><a class="anc" name="dfb4" href="#dfb4">[dfb4]</a><span class="cd"><span class="i">DEC</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Decrement the region.</span></span>
<span class="l"><a class="anc" name="dfb7" href="#dfb7">[dfb7]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_switchArea">@_switchArea</a></span></span><span class="ce">; If it's in bounds, switch to the previous area.</span></span>
<span class="l"><a class="anc" name="dfb9" href="#dfb9">[dfb9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$05</span></span><span class="ce">; Else, set the region to the final fortress.</span></span>
<span class="l"><a class="anc" name="dfbb" href="#dfbb">[dfbb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span><span class="ce">; Store as the new region.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":dfbe:@_switchArea"></a><div class="c">;
; Set the current screen to 0 and load it.
;
</div><span class="l"><a class="anc" name="dfbe" href="#dfbe">[dfbe]</a><a href="#:dfbe:@_switchArea" class="lla">@_switchArea:</a><span class="ce">; [$dfbe]</span></span>
<span class="l"><a class="anc" name="dfbe" href="#dfbe">[dfbe]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="dfc0" href="#dfc0">[dfc0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Set current screen to 0.</span></span>
<span class="l"><a class="anc" name="dfc2" href="#dfc2">[dfc2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a></span></span><span class="ce">; Load the area.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Fog_OnTick"></a><div class="cp">;============================================================================
; Update the fog state on tick.
;
; This will first check if the area supports fog (Forepaw
; area with the Mist palette).
;
; If fog is allowed, it will proceed to animate fog
; every odd tick and update fog state every even tick.
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area.
;
;     <a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a>:
;         The screen's palette.
;
;     <a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a>:
;         The current fog index.
;
;     <a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a>:
;         The current fog generator value.
;
; OUTPUTS:
;     <a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a>:
;         The updated fog index.
;
;     <a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a>:
;         The updated fog generator value.
;
; CALLS:
;     <a href="#Fog_UpdateTiles">Fog_UpdateTiles</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="dfc5" href="#dfc5">[dfc5]</a><a href="#Fog_OnTick" class="la">Fog_OnTick:</a><span class="ce">; [$dfc5]</span></span>
<span class="l"><a class="anc" name="dfc5" href="#dfc5">[dfc5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current area.</span></span>
<span class="l"><a class="anc" name="dfc7" href="#dfc7">[dfc7]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it Forepaw?</span></span>
<span class="l"><a class="anc" name="dfc9" href="#dfc9">[dfc9]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"><a class="anc" name="dfcb" href="#dfcb">[dfcb]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Screen_PaletteIndex">Screen_PaletteIndex</a></span></span><span class="ce">; Load the current palette.</span></span>
<span class="l"><a class="anc" name="dfce" href="#dfce">[dfce]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; Is it Mist?</span></span>
<span class="l"><a class="anc" name="dfd0" href="#dfd0">[dfd0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"><a class="anc" name="dfd2" href="#dfd2">[dfd2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a></span></span><span class="ce">; Load the fog index.</span></span>
<span class="l"><a class="anc" name="dfd4" href="#dfd4">[dfd4]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Is it an odd value?</span></span>
<span class="l"><a class="anc" name="dfd5" href="#dfd5">[dfd5]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#Fog_UpdateTiles">Fog_UpdateTiles</a></span></span><span class="ce">; If so, jump to rotate tiles.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Decrement the fog generator and check if it reached 0.
; If so, increment the fog index.
;
</div><span class="l"><a class="anc" name="dfd7" href="#dfd7">[dfd7]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; Decrement the fog generator.</span></span>
<span class="l"><a class="anc" name="dfd9" href="#dfd9">[dfd9]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span><span class="ce">; If != 0, return.</span></span>
<span class="l"><a class="anc" name="dfdb" href="#dfdb">[dfdb]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a></span></span><span class="ce">; Else, increment the fog index.</span></span>
<span class="l"></span>
<a name="RETURN_DFDD"></a><div class="c">;
; XREFS:
;     <a href="#Debug_ChooseArea">Debug_ChooseArea</a>
;
</div><span class="l"><a class="anc" name="dfdd" href="#dfdd">[dfdd]</a><a href="#RETURN_DFDD" class="la">RETURN_DFDD:</a><span class="ce">; [$dfdd]</span></span>
<span class="l"><a class="anc" name="dfdd" href="#dfdd">[dfdd]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Fog_UpdateTiles"></a><div class="cp">;============================================================================
; Animate a fog tile and update fog generation state.
;
; This will take a fog tile represented by the current
; fog generation value and rotate each row of its contents
; one pixel to the right, wrapping around to the left.
;
; The fog generation value is then incremented by 2,
; wrapping around from 7 to 0. If it hits 0, the fog
; index is inremented and a new starting fog generation
; value is chosen based on that index.
;
; INPUTS:
;     <a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a>:
;         The current fog generator value.
;
;     <a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a>:
;         The current fog index value.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The current upper bounds of the PPU buffer.
;
; OUTPUTS:
;     <a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a>:
;         The updated fog generator value.
;
;     <a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a>:
;         The updated fog index value.
;
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The updated PPU buffer, with the rotate-right
;         command scheduled.
;
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The updated upper bounds of the PPU buffer.
;
;
; XREFS:
;     <a href="#Fog_OnTick">Fog_OnTick</a>
;============================================================================
</div><span class="l"><a class="anc" name="dfde" href="#dfde">[dfde]</a><a href="#Fog_UpdateTiles" class="la">Fog_UpdateTiles:</a><span class="ce">; [$dfde]</span></span>
<span class="l"><a class="anc" name="dfde" href="#dfde">[dfde]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Load the upper bounds of the fog generator.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Queue drawing command "Rotate tiles right."
;
</div><span class="l"><a class="anc" name="dfe0" href="#dfe0">[dfe0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$fc</span></span><span class="ce">; 0xFC == Rotate Tiles Right draw command.</span></span>
<span class="l"><a class="anc" name="dfe2" href="#dfe2">[dfe2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set as the command.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the upper byte of the tile address to 0x18.
;
</div><span class="l"><a class="anc" name="dfe5" href="#dfe5">[dfe5]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="dfe6" href="#dfe6">[dfe6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$18</span></span><span class="ce">; 0x18 == Upper byte of the sprite tile address.</span></span>
<span class="l"><a class="anc" name="dfe8" href="#dfe8">[dfe8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set it as the upper byte for the draw command.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate a lower byte for the tile based on the
; fog tile index.
;
; This will be the existing value * 16 (tile data size).
;
</div><span class="l"><a class="anc" name="dfeb" href="#dfeb">[dfeb]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="dfec" href="#dfec">[dfec]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; Load the fog generator value.</span></span>
<span class="l"><a class="anc" name="dfee" href="#dfee">[dfee]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; Increment for later (not involved in the math).</span></span>
<span class="l"><a class="anc" name="dff0" href="#dff0">[dff0]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply the value we loaded by 16.</span></span>
<span class="l"><a class="anc" name="dff1" href="#dff1">[dff1]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dff2" href="#dff2">[dff2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dff3" href="#dff3">[dff3]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="dff4" href="#dff4">[dff4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Set as the lower byte for the draw command.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the new upper bounds for the PPU buffer.
;
; This will increment by 3.
;
</div><span class="l"><a class="anc" name="dff7" href="#dff7">[dff7]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="dff8" href="#dff8">[dff8]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Set as the new upper bounds.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the fog tile index.
;
; It'll increment by 2 (from above and here), keeping and
; wrapping around with a value range of 0..7.
;
</div><span class="l"><a class="anc" name="dffa" href="#dffa">[dffa]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; Increment the fog generator value.</span></span>
<span class="l"><a class="anc" name="dffc" href="#dffc">[dffc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; Load the result.</span></span>
<span class="l"><a class="anc" name="dffe" href="#dffe">[dffe]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Keep it in range 0..7.</span></span>
<span class="l"><a class="anc" name="e000" href="#e000">[e000]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"><a class="anc" name="e002" href="#e002">[e002]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_E011">RETURN_E011</a></span></span><span class="ce">; If != 0, we're done.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The fog generator value hit 0. Increment the fog
; index and look up a new starting fog generator value.
;
</div><span class="l"><a class="anc" name="e004" href="#e004">[e004]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a></span></span><span class="ce">; Increment the fog index.</span></span>
<span class="l"><a class="anc" name="e006" href="#e006">[e006]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Fog_StateIndex">Fog_StateIndex</a></span></span><span class="ce">; Load it.</span></span>
<span class="l"><a class="anc" name="e008" href="#e008">[e008]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Divide by 2.</span></span>
<span class="l"><a class="anc" name="e009" href="#e009">[e009]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; And convert to an index in the lookup table.</span></span>
<span class="l"><a class="anc" name="e00b" href="#e00b">[e00b]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="e00c" href="#e00c">[e00c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#FOG_START_TILE_INDEXES">FOG_START_TILE_INDEXES</a>,X</span></span><span class="ce">; Load a starting fog generator value at that index.</span></span>
<span class="l"><a class="anc" name="e00f" href="#e00f">[e00f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Fog_TileIndex">Fog_TileIndex</a></span></span><span class="ce">; And set it.</span></span>
<span class="l"></span>
<a name="RETURN_E011"></a><div class="c">;
; XREFS:
;     <a href="#Fog_OnTick">Fog_OnTick</a>
;     <a href="#Fog_UpdateTiles">Fog_UpdateTiles</a>
;
</div><span class="l"><a class="anc" name="e011" href="#e011">[e011]</a><a href="#RETURN_E011" class="la">RETURN_E011:</a><span class="ce">; [$e011]</span></span>
<span class="l"><a class="anc" name="e011" href="#e011">[e011]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="FOG_START_TILE_INDEXES"></a><div class="c">;
; XREFS:
;     <a href="#Fog_UpdateTiles">Fog_UpdateTiles</a>
;
</div><span class="l"><a class="anc" name="e012" href="#e012">[e012]</a><a href="#FOG_START_TILE_INDEXES" class="la">FOG_START_TILE_INDEXES:</a><span class="ce">; [$e012]</span></span>
<span class="l"><a class="anc" name="e012" href="#e012">[e012]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e013" href="#e013">[e013]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e014" href="#e014">[e014]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e015" href="#e015">[e015]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_CheckShowPlayerMenu"></a><div class="cp">;============================================================================
; Check whether the Player Menu can and should be shown.
;
; The menu can be shown anywhere other than the first
; screen of the first town (where the game begins).
;
; If the menu can be shown, then it will be shown if
; the Select button has been pressed.
;
; INPUTS:
;     <a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a>:
;         The current area.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The current screen of the current area.
;
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The bitmask of newly-pressed buttons.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="e016" href="#e016">[e016]</a><a href="#GameLoop_CheckShowPlayerMenu" class="la">GameLoop_CheckShowPlayerMenu:</a><span class="ce">; [$e016]</span></span>
<div class="c">;
; Check to make sure we're not outside the walls of Eolis.
;
</div><span class="l"><a class="anc" name="e016" href="#e016">[e016]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; A = current area.</span></span>
<span class="l"><a class="anc" name="e018" href="#e018">[e018]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_allowInventory">@_allowInventory</a></span></span><span class="ce">; If it's &gt; Eolis, the player can open the inventory. Jump.</span></span>
<span class="l"><a class="anc" name="e01a" href="#e01a">[e01a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; A = current screen.</span></span>
<span class="l"><a class="anc" name="e01c" href="#e01c">[e01c]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_E02A">RETURN_E02A</a></span></span><span class="ce">; If it's 0, then we're outside the walls. No inventory allowed. Return.</span></span>
<span class="l"></span>
<a name=":e01e:@_allowInventory"></a><span class="l"><a class="anc" name="e01e" href="#e01e">[e01e]</a><a href="#:e01e:@_allowInventory" class="lla">@_allowInventory:</a><span class="ce">; [$e01e]</span></span>
<span class="l"><a class="anc" name="e01e" href="#e01e">[e01e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; A = controller 1 button mask.</span></span>
<span class="l"><a class="anc" name="e020" href="#e020">[e020]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Is Select pressed?</span></span>
<span class="l"><a class="anc" name="e022" href="#e022">[e022]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_E02A">RETURN_E02A</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Open the inventory via jump to <a href="PRG12.html#PlayerMenu_Show">PlayerMenu_Show</a>.
;
</div><span class="l"><a class="anc" name="e024" href="#e024">[e024]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Open the Player Menu.</span></span>
<span class="l"><a class="anc" name="e027" href="#e027">[e027]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="e028" href="#e028">[e028]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#PlayerMenu_Show">PlayerMenu_Show</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#PlayerMenu_Show">PlayerMenu_Show</a></span></span>
<span class="l"></span>
<a name="RETURN_E02A"></a><div class="c">;
; XREFS:
;     <a href="#GameLoop_CheckPauseGame">GameLoop_CheckPauseGame</a>
;     <a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a>
;
</div><span class="l"><a class="anc" name="e02a" href="#e02a">[e02a]</a><a href="#RETURN_E02A" class="la">RETURN_E02A:</a><span class="ce">; [$e02a]</span></span>
<span class="l"><a class="anc" name="e02a" href="#e02a">[e02a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_CheckPauseGame"></a><div class="cp">;============================================================================
; Check whether the player has paused.
;
; If they have, then stay paused until the player
; unpauses.
;
; This function won't return until the player unpaused.
; While paused, <a href="RAM.html#Game_PausedState">Game_PausedState</a> will be set.
;
; INPUTS:
;     <a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a>:
;         The changed button mask to check.
;
; OUTPUTS:
;     <a href="RAM.html#Game_PausedState">Game_PausedState</a>:
;         1 while paused. 0 on return.
;
; CALLS:
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;     <a href="#Sprites_FlipRanges">Sprites_FlipRanges</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="e02b" href="#e02b">[e02b]</a><a href="#GameLoop_CheckPauseGame" class="la">GameLoop_CheckPauseGame:</a><span class="ce">; [$e02b]</span></span>
<div class="c">;
; Check if the player pressed Start.
;
</div><span class="l"><a class="anc" name="e02b" href="#e02b">[e02b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Load the button state.</span></span>
<span class="l"><a class="anc" name="e02d" href="#e02d">[e02d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Check if the Pause button is pressed.</span></span>
<span class="l"><a class="anc" name="e02f" href="#e02f">[e02f]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#RETURN_E02A">RETURN_E02A</a></span></span><span class="ce">; If paused...</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player paused. Set the flag and wait until unpaused.
;
</div><span class="l"><a class="anc" name="e031" href="#e031">[e031]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e033" href="#e033">[e033]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Game_PausedState">Game_PausedState</a></span></span><span class="ce">; Set the Paused flag.</span></span>
<span class="l"></span>
<a name=":e036:@_waitForUnpause"></a><span class="l"><a class="anc" name="e036" href="#e036">[e036]</a><a href="#:e036:@_waitForUnpause" class="lla">@_waitForUnpause:</a><span class="ce">; [$e036]</span></span>
<span class="l"><a class="anc" name="e036" href="#e036">[e036]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait...</span></span>
<span class="l"><a class="anc" name="e039" href="#e039">[e039]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_FlipRanges">Sprites_FlipRanges</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the player unpaused.
;
</div><span class="l"><a class="anc" name="e03c" href="#e03c">[e03c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Check if the Pause button was pressed again.</span></span>
<span class="l"><a class="anc" name="e03e" href="#e03e">[e03e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="e040" href="#e040">[e040]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_waitForUnpause">@_waitForUnpause</a></span></span><span class="ce">; Until pause is pressed again, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Unpause the game.
;
</div><span class="l"><a class="anc" name="e042" href="#e042">[e042]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Clear the Paused flag.</span></span>
<span class="l"><a class="anc" name="e044" href="#e044">[e044]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Game_PausedState">Game_PausedState</a></span></span></span>
<span class="l"><a class="anc" name="e047" href="#e047">[e047]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_UpdatePlayerOnScroll"></a><div class="cp">;============================================================================
; Update player state during a screen scroll.
;
; This will preserve the controller buttons that were
; pressed at the beginning of the screen scroll, regardless
; of any changes made to those buttons since.
;
; It will then position the player based off of a scroll
; transition counter, and increment that counter. This
; counter helps coordinate at which points the player's
; sprite appears to move and where it ends up.
;
; INPUTS:
;     <a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a>:
;         The controller 1 buttons pressed at the beginning
;         of the screen scroll.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The counter used to control player position during
;         scroll.
;
; OUTPUTS:
;     <a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a>:
;         The restored button mask.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The updated counter.
;
; CALLS:
;     <a href="#Game_MovePlayerOnScroll">Game_MovePlayerOnScroll</a>
;
; XREFS:
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Screen_UpdateForScroll">Screen_UpdateForScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="e048" href="#e048">[e048]</a><a href="#Game_UpdatePlayerOnScroll" class="la">Game_UpdatePlayerOnScroll:</a><span class="ce">; [$e048]</span></span>
<div class="c">;
; Preserve the previous pressed buttons while scrolling.
;
</div><span class="l"><a class="anc" name="e048" href="#e048">[e048]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_PrevButtonMask">Joy1_PrevButtonMask</a></span></span><span class="ce">; Load the previous button mask.</span></span>
<span class="l"><a class="anc" name="e04a" href="#e04a">[e04a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span><span class="ce">; Set it as the current button mask.</span></span>
<span class="l"><a class="anc" name="e04c" href="#e04c">[e04c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_MovePlayerOnScroll">Game_MovePlayerOnScroll</a></span></span><span class="ce">; Update the player position.</span></span>
<span class="l"><a class="anc" name="e04f" href="#e04f">[e04f]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Increment the screen scroll transition counter.</span></span>
<span class="l"><a class="anc" name="e051" href="#e051">[e051]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Game_MovePlayerOnScrollLeft"></a><div class="cp">;============================================================================
; TODO: Document Game_MovePlayerOnScrollLeft
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_MovePlayerOnScroll">Game_MovePlayerOnScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="e052" href="#e052">[e052]</a><a href="#Game_MovePlayerOnScrollLeft" class="la">Game_MovePlayerOnScrollLeft:</a><span class="ce">; [$e052]</span></span>
<div class="c">;
; The screen is scrolling to the screen to the left.
;
; If we're in the first 4 frames of the screen transition,
; move the player left 4px per frame until it wraps the
; screen.
;
</div><span class="l"><a class="anc" name="e052" href="#e052">[e052]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><a class="anc" name="e054" href="#e054">[e054]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &gt;= 4?</span></span>
<span class="l"><a class="anc" name="e056" href="#e056">[e056]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e065">@LAB_PRG15_MIRROR__e065</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><a class="anc" name="e058" href="#e058">[e058]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><a class="anc" name="e05a" href="#e05a">[e05a]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e05b" href="#e05b">[e05b]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$04</span></span><span class="ce">; Subtract 4.</span></span>
<span class="l"><a class="anc" name="e05d" href="#e05d">[e05d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e05f" href="#e05f">[e05f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Load our screen scroll counter.</span></span>
<span class="l"><a class="anc" name="e061" href="#e061">[e061]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$00</span></span><span class="ce">; Subtract carry.</span></span>
<span class="l"><a class="anc" name="e063" href="#e063">[e063]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e065:@LAB_PRG15_MIRROR__e065"></a><div class="c">;
; Update <a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a> based on the
; player's X position.
;
</div><span class="l"><a class="anc" name="e065" href="#e065">[e065]</a><a href="#:e065:@LAB_PRG15_MIRROR__e065" class="lla">@LAB_PRG15_MIRROR__e065:</a><span class="ce">; [$e065]</span></span>
<span class="l"><a class="anc" name="e065" href="#e065">[e065]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e067" href="#e067">[e067]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="e069" href="#e069">[e069]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_MovePlayerOnScroll"></a><div class="cp">;============================================================================
; Move the player while the screen is scrolling.
;
; This will position the player on the screen based on the
; state of the screen scroll.
;
; When scrolling horizontally, it will inch the player
; toward the nearest screen boundary until it wraps.
;
; When scrolling vertically, nothing useful happens.
;
; NOTE: The function is full of useless code that's not
;       needed. Conditionals and variable settings that
;       never get used by anything else.
;
;       Y scrolling effects aren't in Faxanadu, and the
;       code managing that doesn't end up doing anything
;       useful.
;
;       For X scrolling, we set some variables that also
;       either don't get used or don't have any true
;       impact on the logic in which they're used.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a>:
;         The direction in which the screen is scrolling.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The transition counter used during screen scroll
;         to help position the player.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The player's current X position.
;
; OUTPUTS:
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The updated player position.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         An updated X value used during screen scroll.
;         This is set in the first 4 frames of scrolling
;         left or right, but is thought to ultimately be
;         useless.
;
;     <a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a>:
;     <a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a>
;         Ultimately unused values. Remnants of dead code.
;
; XREFS:
;     <a href="#Game_UpdatePlayerOnScroll">Game_UpdatePlayerOnScroll</a>
;============================================================================
</div><span class="l"><a class="anc" name="e06a" href="#e06a">[e06a]</a><a href="#Game_MovePlayerOnScroll" class="la">Game_MovePlayerOnScroll:</a><span class="ce">; [$e06a]</span></span>
<div class="c">;
; Check which direction the screen is scrolling.
;
</div><span class="l"><a class="anc" name="e06a" href="#e06a">[e06a]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span><span class="ce">; Load the screen scroll direction.</span></span>
<span class="l"><a class="anc" name="e06c" href="#e06c">[e06c]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_MovePlayerOnScrollLeft">Game_MovePlayerOnScrollLeft</a></span></span><span class="ce">; If 0, jump to handle scrolling left.</span></span>
<span class="l"><a class="anc" name="e06e" href="#e06e">[e06e]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="e06f" href="#e06f">[e06f]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_scrollRight">@_scrollRight</a></span></span><span class="ce">; If 1, jump to handle scrolling right.</span></span>
<span class="l"><a class="anc" name="e071" href="#e071">[e071]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="e072" href="#e072">[e072]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_scrollUp">@_scrollUp</a></span></span><span class="ce">; If 2, jump to handle scrolling up.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The screen is scrolling to the screen below.
;
</div><span class="l"><a class="anc" name="e074" href="#e074">[e074]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><a class="anc" name="e076" href="#e076">[e076]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &lt; 8?</span></span>
<span class="l"><a class="anc" name="e078" href="#e078">[e078]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return1">@_return1</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><a class="anc" name="e07a" href="#e07a">[e07a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span><span class="ce">; Load the player's Y position during scroll.</span></span>
<span class="l"><a class="anc" name="e07c" href="#e07c">[e07c]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e07d" href="#e07d">[e07d]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$04</span></span><span class="ce">; Subtract 4</span></span>
<span class="l"><a class="anc" name="e07f" href="#e07f">[e07f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e081" href="#e081">[e081]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"></span>
<a name=":e082:@_return1"></a><span class="l"><a class="anc" name="e082" href="#e082">[e082]</a><a href="#:e082:@_return1" class="lla">@_return1:</a><span class="ce">; [$e082]</span></span>
<span class="l"><a class="anc" name="e082" href="#e082">[e082]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e083:@_scrollUp"></a><div class="c">;
; The screen is scrolling to the screen above.
;
</div><span class="l"><a class="anc" name="e083" href="#e083">[e083]</a><a href="#:e083:@_scrollUp" class="lla">@_scrollUp:</a><span class="ce">; [$e083]</span></span>
<span class="l"><a class="anc" name="e083" href="#e083">[e083]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><a class="anc" name="e085" href="#e085">[e085]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it &lt; 8?</span></span>
<span class="l"><a class="anc" name="e087" href="#e087">[e087]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return2">@_return2</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"><a class="anc" name="e089" href="#e089">[e089]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span><span class="ce">; Load the player Y position during scroll.</span></span>
<span class="l"><a class="anc" name="e08b" href="#e08b">[e08b]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e08c" href="#e08c">[e08c]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4.</span></span>
<span class="l"><a class="anc" name="e08e" href="#e08e">[e08e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e090" href="#e090">[e090]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"></span>
<a name=":e091:@_return2"></a><span class="l"><a class="anc" name="e091" href="#e091">[e091]</a><a href="#:e091:@_return2" class="lla">@_return2:</a><span class="ce">; [$e091]</span></span>
<span class="l"><a class="anc" name="e091" href="#e091">[e091]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e092:@_scrollRight"></a><div class="c">;
; The screen is scrolling to the screen to the right.
;
; If we're in the first 4 frames of the screen transition,
; move the player right 4px per frame until it wraps the
; screen.
;
</div><span class="l"><a class="anc" name="e092" href="#e092">[e092]</a><a href="#:e092:@_scrollRight" class="lla">@_scrollRight:</a><span class="ce">; [$e092]</span></span>
<span class="l"><a class="anc" name="e092" href="#e092">[e092]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Load the transition counter.</span></span>
<span class="l"><a class="anc" name="e094" href="#e094">[e094]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is it &gt;= 4?</span></span>
<span class="l"><a class="anc" name="e096" href="#e096">[e096]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_finishScrollRight">@_finishScrollRight</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><a class="anc" name="e098" href="#e098">[e098]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><a class="anc" name="e09a" href="#e09a">[e09a]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e09b" href="#e09b">[e09b]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4.</span></span>
<span class="l"><a class="anc" name="e09d" href="#e09d">[e09d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e09f" href="#e09f">[e09f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Load our screen scroll counter.</span></span>
<span class="l"><a class="anc" name="e0a1" href="#e0a1">[e0a1]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry.</span></span>
<span class="l"><a class="anc" name="e0a3" href="#e0a3">[e0a3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e0a5:@_finishScrollRight"></a><div class="c">;
; Update <a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a> based on the
; player's X position.
;
</div><span class="l"><a class="anc" name="e0a5" href="#e0a5">[e0a5]</a><a href="#:e0a5:@_finishScrollRight" class="lla">@_finishScrollRight:</a><span class="ce">; [$e0a5]</span></span>
<span class="l"><a class="anc" name="e0a5" href="#e0a5">[e0a5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e0a7" href="#e0a7">[e0a7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="e0a9" href="#e0a9">[e0a9]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetInitialState"></a><div class="cp">;============================================================================
; Set the initial state for a player on level load.
;
; This will face the player right, set their movement
; speed, status, disable invincibility, and other state.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         TODO
;
;     <a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a>:
;         TODO
;
;     <a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a>:
;         TODO
;
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;         The initial player movement speed (0 in
;         lower byte).
;
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The player's status (0).
;
;     <a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a>:
;         The invincibility phase (0).
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player will be facing right.
;
;     <a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a>:
;         TODO (set to 0xFF).
;
;     <a href="RAM.html#Player_Unused_00ab">Player_Unused_00ab</a>:
;         TODO (set to 2).
;
; XREFS:
;     <a href="#Game_InitStateForSpawn">Game_InitStateForSpawn</a>
;     <a href="#Game_LoadCurrentArea">Game_LoadCurrentArea</a>
;     <a href="#Game_LoadFirstLevel">Game_LoadFirstLevel</a>
;============================================================================
</div><span class="l"><a class="anc" name="e0aa" href="#e0aa">[e0aa]</a><a href="#Player_SetInitialState" class="la">Player_SetInitialState:</a><span class="ce">; [$e0aa]</span></span>
<div class="c">;
; Clear scroll state.
;
</div><span class="l"><a class="anc" name="e0aa" href="#e0aa">[e0aa]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e0ac" href="#e0ac">[e0ac]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><a class="anc" name="e0ae" href="#e0ae">[e0ae]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="e0b0" href="#e0b0">[e0b0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span></span>
<span class="l"><a class="anc" name="e0b2" href="#e0b2">[e0b2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span><span class="ce">; DEADCODE: Overridden below.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the starting speed, status, and iframes.
;
</div><span class="l"><a class="anc" name="e0b4" href="#e0b4">[e0b4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Set the player speed to 0.</span></span>
<span class="l"><a class="anc" name="e0b6" href="#e0b6">[e0b6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Set the player status to 0.</span></span>
<span class="l"><a class="anc" name="e0b8" href="#e0b8">[e0b8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Set the invincibility phase to 0.</span></span>
<span class="l"><a class="anc" name="e0ba" href="#e0ba">[e0ba]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span><span class="ce">; Set this again, apparently.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Face the player to the right.
;
</div><span class="l"><a class="anc" name="e0bc" href="#e0bc">[e0bc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$40</span></span><span class="ce">; 0x04 = Face player right bit.</span></span>
<span class="l"><a class="anc" name="e0be" href="#e0be">[e0be]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Set that on the player's flags.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the accessory information.
;
</div><span class="l"><a class="anc" name="e0c0" href="#e0c0">[e0c0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="e0c2" href="#e0c2">[e0c2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Unused value. This is written to but never read from.
;
</div><span class="l"><a class="anc" name="e0c4" href="#e0c4">[e0c4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e0c6" href="#e0c6">[e0c6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Unused_00ab">Player_Unused_00ab</a></span></span></span>
<span class="l"><a class="anc" name="e0c8" href="#e0c8">[e0c8]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="RETURN_E0C9"></a><div class="c">;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;
</div><span class="l"><a class="anc" name="e0c9" href="#e0c9">[e0c9]</a><a href="#RETURN_E0C9" class="la">RETURN_E0C9:</a><span class="ce">; [$e0c9]</span></span>
<span class="l"><a class="anc" name="e0c9" href="#e0c9">[e0c9]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_UpdatePlayer"></a><div class="cp">;============================================================================
; Check and update state for the player.
;
; This is run on every game tick to check what the
; player is doing and to update its state.
;
; This checks for attacking, climbing, jumping, iframes,
; entering doors, falling to the ground, pushing blocks,
; and moving between screens.
;
; INPUTS:
;     <a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a>:
;         The current screen scroll direction.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a>
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;     <a href="#Player_HandleIFrames">Player_HandleIFrames</a>
;     Player_CheckHandleEnterDoor
;     <a href="#Player_CheckOnBreakableBlock">Player_CheckOnBreakableBlock</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="e0ca" href="#e0ca">[e0ca]</a><a href="#GameLoop_UpdatePlayer" class="la">GameLoop_UpdatePlayer:</a><span class="ce">; [$e0ca]</span></span>
<span class="l"><a class="anc" name="e0ca" href="#e0ca">[e0ca]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a></span></span><span class="ce">; Check if the player has attacked and handle it.</span></span>
<span class="l"><a class="anc" name="e0cd" href="#e0cd">[e0cd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a></span></span></span>
<span class="l"><a class="anc" name="e0d0" href="#e0d0">[e0d0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleJump">Player_CheckHandleJump</a></span></span><span class="ce">; Check if the player has jumped and handle it.</span></span>
<span class="l"><a class="anc" name="e0d3" href="#e0d3">[e0d3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_HandleIFrames">Player_HandleIFrames</a></span></span><span class="ce">; Handle any pending iframes.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if screen scrolling is occurring.
;
</div><span class="l"><a class="anc" name="e0d6" href="#e0d6">[e0d6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span><span class="ce">; A = scrolling activity.</span></span>
<span class="l"><a class="anc" name="e0d8" href="#e0d8">[e0d8]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is the screen scrolling in either direction?</span></span>
<span class="l"><a class="anc" name="e0da" href="#e0da">[e0da]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#RETURN_E0C9">RETURN_E0C9</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The screen is not scrolling.
;
</div><span class="l"><a class="anc" name="e0dc" href="#e0dc">[e0dc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a></span></span><span class="ce">; Check if the player is entering a door.</span></span>
<span class="l"><a class="anc" name="e0df" href="#e0df">[e0df]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckOnBreakableBlock">Player_CheckOnBreakableBlock</a></span></span></span>
<span class="l"><a class="anc" name="e0e2" href="#e0e2">[e0e2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a></span></span><span class="ce">; Check if the player is pushing the block to open a path to Mascon.</span></span>
<span class="l"><a class="anc" name="e0e5" href="#e0e5">[e0e5]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a></span></span><span class="ce">; Check the block the player is on and handle it.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_HandleIFrames"></a><div class="cp">;============================================================================
; Handle any invincibility frames that may be set.
;
; Invincibility frames start at 0x3C.
;
; If the player has invincibility frames, the frame counter
; will be reduced by 1.
;
; The user's knockback will be reset when the counter hits
; 0x38, at which point the player can safely move.
;
; The user is invincible until the counter hits 0.
;
; INPUTS:
;     <a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a>:
;         The current invincibility phase, from 0x3C to 0.
;
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The player's current status flag.
;
; OUTPUTS:
;     <a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a>:
;         The new status flag with knockback removed, when
;         hitting 0x39 or lower.
;
; CALLS:
;     <a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a>
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e0e8" href="#e0e8">[e0e8]</a><a href="#Player_HandleIFrames" class="la">Player_HandleIFrames:</a><span class="ce">; [$e0e8]</span></span>
<span class="l"><a class="anc" name="e0e8" href="#e0e8">[e0e8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Check the current invincibility phase.</span></span>
<span class="l"><a class="anc" name="e0ea" href="#e0ea">[e0ea]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_removeIFrames">@_removeIFrames</a></span></span><span class="ce">; If the phase is now 1, remove iframe status.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Invincibility is active. Reduce it by 1.
;
</div><span class="l"><a class="anc" name="e0ec" href="#e0ec">[e0ec]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Reduce our invincibility phase by 1.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check where we are in the phase. It starts at 0x3C, and
; until it hits 0x39, it will be in knockback phase.
;
</div><span class="l"><a class="anc" name="e0ee" href="#e0ee">[e0ee]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_InvincibilityPhase">Player_InvincibilityPhase</a></span></span><span class="ce">; Check the invincibility phase.</span></span>
<span class="l"><a class="anc" name="e0f0" href="#e0f0">[e0f0]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$39</span></span><span class="ce">; Is it 0x39?</span></span>
<span class="l"><a class="anc" name="e0f2" href="#e0f2">[e0f2]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_resetSpeed">@_resetSpeed</a></span></span><span class="ce">; If so, reset the speed but don't change the player status.</span></span>
<span class="l"><a class="anc" name="e0f4" href="#e0f4">[e0f4]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_removeIFrames">@_removeIFrames</a></span></span><span class="ce">; If not over, update the player status.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the knockback speed and return, leaving the knockback
; state intact.
;
</div><span class="l"><a class="anc" name="e0f6" href="#e0f6">[e0f6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Set standard acceleration.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e0f9:@_resetSpeed"></a><div class="c">;
; Set the knockback speed, but then clear the knockback.
;
</div><span class="l"><a class="anc" name="e0f9" href="#e0f9">[e0f9]</a><a href="#:e0f9:@_resetSpeed" class="lla">@_resetSpeed:</a><span class="ce">; [$e0f9]</span></span>
<span class="l"><a class="anc" name="e0f9" href="#e0f9">[e0f9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Reset the player speed.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e0fc:@_removeIFrames"></a><div class="c">;
; Clear knockback from the player flags.
;
</div><span class="l"><a class="anc" name="e0fc" href="#e0fc">[e0fc]</a><a href="#:e0fc:@_removeIFrames" class="lla">@_removeIFrames:</a><span class="ce">; [$e0fc]</span></span>
<span class="l"><a class="anc" name="e0fc" href="#e0fc">[e0fc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e0fe" href="#e0fe">[e0fe]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fd</span></span><span class="ce">; Clear the knockback bit.</span></span>
<span class="l"><a class="anc" name="e100" href="#e100">[e100]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Save them.</span></span>
<span class="l"><a class="anc" name="e102" href="#e102">[e102]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleAttack"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleAttack
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e103" href="#e103">[e103]</a><a href="#Player_CheckHandleAttack" class="la">Player_CheckHandleAttack:</a><span class="ce">; [$e103]</span></span>
<span class="l"><a class="anc" name="e103" href="#e103">[e103]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e105" href="#e105">[e105]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_updateHitPhase">@_updateHitPhase</a></span></span><span class="ce">; If already attacking, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is not yet attacking. Check first if the
; player is allowed to attack.
;
</div><span class="l"><a class="anc" name="e107" href="#e107">[e107]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_IsClimbing">Player_IsClimbing</a></span></span><span class="ce">; Is the player climbing?</span></span>
<span class="l"><a class="anc" name="e10a" href="#e10a">[e10a]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_clearAttacking">@_clearAttacking</a></span></span><span class="ce">; If so, clear any attacking state and return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player isn't climbing. Check if they've attacked.
;
</div><span class="l"><a class="anc" name="e10c" href="#e10c">[e10c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Load the controller 1 button mask.</span></span>
<span class="l"><a class="anc" name="e10e" href="#e10e">[e10e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is the B button set?</span></span>
<span class="l"><a class="anc" name="e110" href="#e110">[e110]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_clearAttacking">@_clearAttacking</a></span></span><span class="ce">; If not, clear any attacking state and return.</span></span>
<span class="l"><a class="anc" name="e112" href="#e112">[e112]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><a class="anc" name="e114" href="#e114">[e114]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Was the player in attack mode?</span></span>
<span class="l"><a class="anc" name="e116" href="#e116">[e116]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_setAttacking">@_setAttacking</a></span></span><span class="ce">; If so, set the attacking state.</span></span>
<span class="l"><a class="anc" name="e118" href="#e118">[e118]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e119:@_clearAttacking"></a><div class="c">;
; Clear the attacking state for the player.
;
</div><span class="l"><a class="anc" name="e119" href="#e119">[e119]</a><a href="#:e119:@_clearAttacking" class="lla">@_clearAttacking:</a><span class="ce">; [$e119]</span></span>
<span class="l"><a class="anc" name="e119" href="#e119">[e119]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e11b" href="#e11b">[e11b]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fe</span></span><span class="ce">; Clear the Attacking bit.</span></span>
<span class="l"><a class="anc" name="e11d" href="#e11d">[e11d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e11f" href="#e11f">[e11f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e120:@_setAttacking"></a><div class="c">;
; Set the attacking state for the player.
;
; This will update the flags and begin the animation
; phase timer.
;
</div><span class="l"><a class="anc" name="e120" href="#e120">[e120]</a><a href="#:e120:@_setAttacking" class="lla">@_setAttacking:</a><span class="ce">; [$e120]</span></span>
<span class="l"><a class="anc" name="e120" href="#e120">[e120]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e122" href="#e122">[e122]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Set the Attacking bit.</span></span>
<span class="l"><a class="anc" name="e124" href="#e124">[e124]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e126" href="#e126">[e126]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Load the player's status flags.</span></span>
<span class="l"><a class="anc" name="e128" href="#e128">[e128]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$01</span></span><span class="ce">; Set the Attacking bit.</span></span>
<span class="l"><a class="anc" name="e12a" href="#e12a">[e12a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the phase state.
;
</div><span class="l"><a class="anc" name="e12c" href="#e12c">[e12c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e12e" href="#e12e">[e12e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span><span class="ce">; Set phase timer to 0.</span></span>
<span class="l"><a class="anc" name="e130" href="#e130">[e130]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span><span class="ce">; Set phase counter to 0.</span></span>
<span class="l"></span>
<a name=":e132:@_updateHitPhase"></a><span class="l"><a class="anc" name="e132" href="#e132">[e132]</a><a href="#:e132:@_updateHitPhase" class="lla">@_updateHitPhase:</a><span class="ce">; [$e132]</span></span>
<span class="l"><a class="anc" name="e132" href="#e132">[e132]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span><span class="ce">; Increment the current phase timer.</span></span>
<span class="l"><a class="anc" name="e134" href="#e134">[e134]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span><span class="ce">; A = updated phase timer.</span></span>
<span class="l"><a class="anc" name="e136" href="#e136">[e136]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span><span class="ce">; X = phase counter.</span></span>
<span class="l"><a class="anc" name="e138" href="#e138">[e138]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="#PLAYER_HIT_PHASES">PLAYER_HIT_PHASES</a>,X</span></span><span class="ce">; Check against the phase lookup table.</span></span>
<span class="l"><a class="anc" name="e13b" href="#e13b">[e13b]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If we're not transitioning to the next phase count, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're done with that phase. Move to the next and
; reset the timer.
;
</div><span class="l"><a class="anc" name="e13d" href="#e13d">[e13d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e13f" href="#e13f">[e13f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseTimer">PlayerHitsPhaseTimer</a></span></span><span class="ce">; Reset the current phase's timer to 0.</span></span>
<span class="l"><a class="anc" name="e141" href="#e141">[e141]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Phase counter++</span></span>
<span class="l"><a class="anc" name="e142" href="#e142">[e142]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$03</span></span><span class="ce">; Is it &gt;= 3 (end of phases)?</span></span>
<span class="l"><a class="anc" name="e144" href="#e144">[e144]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_finishAttacking">@_finishAttacking</a></span></span><span class="ce">; If so, finish the attacking state.</span></span>
<span class="l"><a class="anc" name="e146" href="#e146">[e146]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span><span class="ce">; Else, increment the phase counter for the next frame.</span></span>
<span class="l"></span>
<a name=":e148:@_return"></a><span class="l"><a class="anc" name="e148" href="#e148">[e148]</a><a href="#:e148:@_return" class="lla">@_return:</a><span class="ce">; [$e148]</span></span>
<span class="l"><a class="anc" name="e148" href="#e148">[e148]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e149:@_finishAttacking"></a><span class="l"><a class="anc" name="e149" href="#e149">[e149]</a><a href="#:e149:@_finishAttacking" class="lla">@_finishAttacking:</a><span class="ce">; [$e149]</span></span>
<span class="l"><a class="anc" name="e149" href="#e149">[e149]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e14b" href="#e14b">[e14b]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Clear the Attacking flag.</span></span>
<span class="l"><a class="anc" name="e14d" href="#e14d">[e14d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<a name="RETURN_E14F"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;
</div><span class="l"><a class="anc" name="e14f" href="#e14f">[e14f]</a><a href="#RETURN_E14F" class="la">RETURN_E14F:</a><span class="ce">; [$e14f]</span></span>
<span class="l"><a class="anc" name="e14f" href="#e14f">[e14f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="PLAYER_HIT_PHASES"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a>
;
</div><span class="l"><a class="anc" name="e150" href="#e150">[e150]</a><a href="#PLAYER_HIT_PHASES" class="la">PLAYER_HIT_PHASES:</a><span class="ce">; [$e150]</span></span>
<span class="l"><a class="anc" name="e150" href="#e150">[e150]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]: 8 frames thrusting out weapon</span></span>
<span class="l"><a class="anc" name="e151" href="#e151">[e151]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [1]: 3 frames of waiting</span></span>
<span class="l"><a class="anc" name="e152" href="#e152">[e152]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]: 8 frames withdrawing weapon</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_HandleKnockback"></a><div class="cp">;============================================================================
; Handle knockback when getting hit.
;
; This will knock the player back in the direction opposite
; where the player was facing.
;
; It will temporarily flip the facing bit and then move in
; that direction. The original bit will then be restored.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's flags.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated flags, with any new state applied
;         from the move but the flipped bit retained.
;
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a>
;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;============================================================================
</div><span class="l"><a class="anc" name="e153" href="#e153">[e153]</a><a href="#Player_HandleKnockback" class="la">Player_HandleKnockback:</a><span class="ce">; [$e153]</span></span>
<div class="c">;
; Temporarily store the player's current flags.
;
</div><span class="l"><a class="anc" name="e153" href="#e153">[e153]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e155" href="#e155">[e155]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Take only the facing bit.</span></span>
<span class="l"><a class="anc" name="e157" href="#e157">[e157]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Flip the facing bit and knock back in the flipped direction.
;
</div><span class="l"><a class="anc" name="e158" href="#e158">[e158]</a><span class="cd"><span class="i">EOR</span> <span class="o">#$40</span></span><span class="ce">; Flip the facing bit temporarily for the purpose of knockback.</span></span>
<span class="l"><a class="anc" name="e15a" href="#e15a">[e15a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store as the new flags.</span></span>
<span class="l"><a class="anc" name="e15c" href="#e15c">[e15c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a></span></span><span class="ce">; Move based on the facing bit.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the original flags, merging with any updated bits
; from the move.
;
</div><span class="l"><a class="anc" name="e15f" href="#e15f">[e15f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the original flags.</span></span>
<span class="l"><a class="anc" name="e160" href="#e160">[e160]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e162" href="#e162">[e162]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the flags set above.</span></span>
<span class="l"><a class="anc" name="e164" href="#e164">[e164]</a><span class="cd"><span class="i">AND</span> <span class="o">#$bf</span></span><span class="ce">; Clear the facing bit.</span></span>
<span class="l"><a class="anc" name="e166" href="#e166">[e166]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; OR with the original facing bit.</span></span>
<span class="l"><a class="anc" name="e168" href="#e168">[e168]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e16a" href="#e16a">[e16a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_KnockbackHoriz"></a><div class="cp">;============================================================================
; Move the player left or right due to knockback.
;
; The player will be knocked back based on the direction
; they're facing.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;
; XREFS:
;     <a href="#Player_HandleKnockback">Player_HandleKnockback</a>
;============================================================================
</div><span class="l"><a class="anc" name="e16b" href="#e16b">[e16b]</a><a href="#Player_KnockbackHoriz" class="la">Player_KnockbackHoriz:</a><span class="ce">; [$e16b]</span></span>
<span class="l"><a class="anc" name="e16b" href="#e16b">[e16b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e16d" href="#e16d">[e16d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Is the player facing right?</span></span>
<span class="l"><a class="anc" name="e16f" href="#e16f">[e16f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Player_TryMoveRight">Player_TryMoveRight</a></span></span><span class="ce">; If so, move right.</span></span>
<span class="l"><a class="anc" name="e171" href="#e171">[e171]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleJump"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleJump
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e174" href="#e174">[e174]</a><a href="#Player_CheckHandleJump" class="la">Player_CheckHandleJump:</a><span class="ce">; [$e174]</span></span>
<span class="l"><a class="anc" name="e174" href="#e174">[e174]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ScrollDirection">Screen_ScrollDirection</a></span></span></span>
<span class="l"><a class="anc" name="e176" href="#e176">[e176]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#RETURN_E14F">RETURN_E14F</a></span></span></span>
<span class="l"><a class="anc" name="e178" href="#e178">[e178]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e17a" href="#e17a">[e17a]</a><span class="cd"><span class="i">AND</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e17c" href="#e17c">[e17c]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Player_HandleKnockback">Player_HandleKnockback</a></span></span></span>
<span class="l"><a class="anc" name="e17e" href="#e17e">[e17e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e180" href="#e180">[e180]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_playerCanFly">@_playerCanFly</a></span></span></span>
<span class="l"><a class="anc" name="e182" href="#e182">[e182]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e184" href="#e184">[e184]</a><span class="cd"><span class="i">AND</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="e186" href="#e186">[e186]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_playerCanFly">@_playerCanFly</a></span></span></span>
<span class="l"><a class="anc" name="e188" href="#e188">[e188]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e18a" href="#e18a">[e18a]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="e18c" href="#e18c">[e18c]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_playerNotMoving">@_playerNotMoving</a></span></span></span>
<span class="l"><a class="anc" name="e18e" href="#e18e">[e18e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e190" href="#e190">[e190]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="e192" href="#e192">[e192]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Player_TryMoveRight">Player_TryMoveRight</a></span></span></span>
<span class="l"><a class="anc" name="e194" href="#e194">[e194]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
<span class="l"></span>
<a name=":e197:@_playerCanFly"></a><span class="l"><a class="anc" name="e197" href="#e197">[e197]</a><a href="#:e197:@_playerCanFly" class="lla">@_playerCanFly:</a><span class="ce">; [$e197]</span></span>
<span class="l"><a class="anc" name="e197" href="#e197">[e197]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e199" href="#e199">[e199]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1be">@LAB_PRG15_MIRROR__e1be</a></span></span></span>
<span class="l"><a class="anc" name="e19b" href="#e19b">[e19b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e19d" href="#e19d">[e19d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e19f" href="#e19f">[e19f]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_playerNotMoving">@_playerNotMoving</a></span></span></span>
<span class="l"><a class="anc" name="e1a1" href="#e1a1">[e1a1]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><a class="anc" name="e1a3" href="#e1a3">[e1a3]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e1a4" href="#e1a4">[e1a4]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_TryMoveRight">Player_TryMoveRight</a></span></span></span>
<span class="l"><a class="anc" name="e1a6" href="#e1a6">[e1a6]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e1a7" href="#e1a7">[e1a7]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_playerNotMoving">@_playerNotMoving</a></span></span></span>
<span class="l"><a class="anc" name="e1a9" href="#e1a9">[e1a9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
<span class="l"></span>
<a name=":e1ac:@_playerNotMoving"></a><span class="l"><a class="anc" name="e1ac" href="#e1ac">[e1ac]</a><a href="#:e1ac:@_playerNotMoving" class="lla">@_playerNotMoving:</a><span class="ce">; [$e1ac]</span></span>
<span class="l"><a class="anc" name="e1ac" href="#e1ac">[e1ac]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e1ae" href="#e1ae">[e1ae]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0c</span></span></span>
<span class="l"><a class="anc" name="e1b0" href="#e1b0">[e1b0]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1be">@LAB_PRG15_MIRROR__e1be</a></span></span></span>
<span class="l"><a class="anc" name="e1b2" href="#e1b2">[e1b2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e1b4" href="#e1b4">[e1b4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e1b6" href="#e1b6">[e1b6]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1be">@LAB_PRG15_MIRROR__e1be</a></span></span></span>
<span class="l"><a class="anc" name="e1b8" href="#e1b8">[e1b8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e1ba" href="#e1ba">[e1ba]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e1bc" href="#e1bc">[e1bc]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e1c5">@LAB_PRG15_MIRROR__e1c5</a></span></span></span>
<span class="l"></span>
<a name=":e1be:@LAB_PRG15_MIRROR__e1be"></a><span class="l"><a class="anc" name="e1be" href="#e1be">[e1be]</a><a href="#:e1be:@LAB_PRG15_MIRROR__e1be" class="lla">@LAB_PRG15_MIRROR__e1be:</a><span class="ce">; [$e1be]</span></span>
<span class="l"><a class="anc" name="e1be" href="#e1be">[e1be]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e1c0" href="#e1c0">[e1c0]</a><span class="cd"><span class="i">AND</span> <span class="o">#$df</span></span></span>
<span class="l"><a class="anc" name="e1c2" href="#e1c2">[e1c2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e1c4" href="#e1c4">[e1c4]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e1c5:@LAB_PRG15_MIRROR__e1c5"></a><span class="l"><a class="anc" name="e1c5" href="#e1c5">[e1c5]</a><a href="#:e1c5:@LAB_PRG15_MIRROR__e1c5" class="lla">@LAB_PRG15_MIRROR__e1c5:</a><span class="ce">; [$e1c5]</span></span>
<span class="l"><a class="anc" name="e1c5" href="#e1c5">[e1c5]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><a class="anc" name="e1c7" href="#e1c7">[e1c7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e1c9" href="#e1c9">[e1c9]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e1cb" href="#e1cb">[e1cb]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e1cd" href="#e1cd">[e1cd]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#Player_TryMoveLeft">Player_TryMoveLeft</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_TryMoveRight"></a><div class="cp">;============================================================================
; Try moving the player right.
;
; This is used when handling knockback or jumping. It will
; move based on any existing acceleration, or the default
; if the player wasn't previously moving, and then try to
; position the player. That may position up againt a block,
; at the edge of the screen, or onto the next screen.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;     <a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a>:
;         The player's current X position.
;
;     <a href="RAM.html#Area_ScreenToTheRight">Area_ScreenToTheRight</a>:
;         The ID of the screen to the right.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The counter used for scrolling.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated flags.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;     <a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a>:
;         The updated player X position.
;
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;         The updated move acceleration.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The new screen, if switching screens.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The updated counter used for scrolling.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The transition counter for the player movement,
;         if scrolling screens.
;
; CALLS:
;     <a href="#Area_ScrollTo">Area_ScrollTo</a>
;     <a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a>
;     <a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a>
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;     <a href="#Player_SetPosAtRightEdge">Player_SetPosAtRightEdge</a>
;     <a href="#Screen_IsEdge">Screen_IsEdge</a>
;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;     <a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a>
;============================================================================
</div><span class="l"><a class="anc" name="e1cf" href="#e1cf">[e1cf]</a><a href="#Player_TryMoveRight" class="la">Player_TryMoveRight:</a><span class="ce">; [$e1cf]</span></span>
<div class="c">;
; Check whether the player is moving.
;
</div><span class="l"><a class="anc" name="e1cf" href="#e1cf">[e1cf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e1d1" href="#e1d1">[e1d1]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Check the moving bit.</span></span>
<span class="l"><a class="anc" name="e1d3" href="#e1d3">[e1d3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_setMoving">@_setMoving</a></span></span><span class="ce">; If set, jump to handle movement.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is not moving. Reset the movement speed.
;
</div><span class="l"><a class="anc" name="e1d5" href="#e1d5">[e1d5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Start with the standard acceleration.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e1d8:@_setMoving"></a><div class="c">;
; Calculate movement speed and set the player to move to
; the right.
;
</div><span class="l"><a class="anc" name="e1d8" href="#e1d8">[e1d8]</a><a href="#:e1d8:@_setMoving" class="lla">@_setMoving:</a><span class="ce">; [$e1d8]</span></span>
<span class="l"><a class="anc" name="e1d8" href="#e1d8">[e1d8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a></span></span><span class="ce">; Calculate the new walking speed.</span></span>
<span class="l"><a class="anc" name="e1db" href="#e1db">[e1db]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e1dd" href="#e1dd">[e1dd]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$60</span></span><span class="ce">; Set moving and to the right.</span></span>
<span class="l"><a class="anc" name="e1df" href="#e1df">[e1df]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store as the new flags.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the player's X position to factor in acceleration.
;
</div><span class="l"><a class="anc" name="e1e1" href="#e1e1">[e1e1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a></span></span><span class="ce">; Load the fractional X position.</span></span>
<span class="l"><a class="anc" name="e1e3" href="#e1e3">[e1e3]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e1e4" href="#e1e4">[e1e4]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Add the move acceleration.</span></span>
<span class="l"><a class="anc" name="e1e6" href="#e1e6">[e1e6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a></span></span><span class="ce">; Store as the new fractional position.</span></span>
<span class="l"><a class="anc" name="e1e8" href="#e1e8">[e1e8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the full X position.</span></span>
<span class="l"><a class="anc" name="e1ea" href="#e1ea">[e1ea]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span><span class="ce">; Add the move acceleration.</span></span>
<span class="l"><a class="anc" name="e1ec" href="#e1ec">[e1ec]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the block there is passable.
;
</div><span class="l"><a class="anc" name="e1ee" href="#e1ee">[e1ee]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e1f0" href="#e1f0">[e1f0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span><span class="ce">; Is the block to the right passable?</span></span>
<span class="l"><a class="anc" name="e1f3" href="#e1f3">[e1f3]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_checkAtRightEdge">@_checkAtRightEdge</a></span></span><span class="ce">; If not, jump to check for an edge or transition boundary.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The block is not passable. Cap the position.
;
</div><span class="l"><a class="anc" name="e1f5" href="#e1f5">[e1f5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><a class="anc" name="e1f7" href="#e1f7">[e1f7]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Cap it.</span></span>
<span class="l"><a class="anc" name="e1f9" href="#e1f9">[e1f9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="e1fb" href="#e1fb">[e1fb]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e1fe:@_checkAtRightEdge"></a><div class="c">;
; Check if the player is far enough to the right for
; any screen transition logic.
;
</div><span class="l"><a class="anc" name="e1fe" href="#e1fe">[e1fe]</a><a href="#:e1fe:@_checkAtRightEdge" class="lla">@_checkAtRightEdge:</a><span class="ce">; [$e1fe]</span></span>
<span class="l"><a class="anc" name="e1fe" href="#e1fe">[e1fe]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; X = Player X position.</span></span>
<span class="l"><a class="anc" name="e200" href="#e200">[e200]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$f1</span></span><span class="ce">; Is it too far left to perform a screen transition?</span></span>
<span class="l"><a class="anc" name="e202" href="#e202">[e202]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the player is at the edge and can scroll.
;
</div><span class="l"><a class="anc" name="e204" href="#e204">[e204]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e206" href="#e206">[e206]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span><span class="ce">; Check if the screen is the right-most edge.</span></span>
<span class="l"><a class="anc" name="e209" href="#e209">[e209]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_SetPosAtRightEdge">Player_SetPosAtRightEdge</a></span></span><span class="ce">; If so, jump to set the position there.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There's a screen to the right. Transition there.
;
</div><span class="l"><a class="anc" name="e20b" href="#e20b">[e20b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheRight">Area_ScreenToTheRight</a></span></span><span class="ce">; A = Neighboring screen to the right.</span></span>
<span class="l"><a class="anc" name="e20d" href="#e20d">[e20d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Store as the new current screen.</span></span>
<span class="l"><a class="anc" name="e20f" href="#e20f">[e20f]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e211" href="#e211">[e211]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollTo">Area_ScrollTo</a></span></span><span class="ce">; Begin scrolling to the right.</span></span>
<span class="l"><a class="anc" name="e214" href="#e214">[e214]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span><span class="ce">; Increment the scroll counter.</span></span>
<span class="l"><a class="anc" name="e216" href="#e216">[e216]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e218" href="#e218">[e218]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Clear the transition counter.</span></span>
<span class="l"></span>
<a name=":e21a:@_return"></a><span class="l"><a class="anc" name="e21a" href="#e21a">[e21a]</a><a href="#:e21a:@_return" class="lla">@_return:</a><span class="ce">; [$e21a]</span></span>
<span class="l"><a class="anc" name="e21a" href="#e21a">[e21a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetPosAtRightEdge"></a><div class="cp">;============================================================================
; Position the player at the right edge of the screen.
;
; The player will be positioned at 0xF0.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The updated X position.
;
; XREFS:
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="e21b" href="#e21b">[e21b]</a><a href="#Player_SetPosAtRightEdge" class="la">Player_SetPosAtRightEdge:</a><span class="ce">; [$e21b]</span></span>
<span class="l"><a class="anc" name="e21b" href="#e21b">[e21b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="e21d" href="#e21d">[e21d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Set the X position to 0xF0.</span></span>
<span class="l"><a class="anc" name="e21f" href="#e21f">[e21f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_TryMoveLeft"></a><div class="cp">;============================================================================
; Try moving the player left.
;
; This is used when handling knockback or jumping. It will
; move based on any existing acceleration, or the default
; if the player wasn't previously moving, and then try to
; position the player. That may position up againt a block,
; at the edge of the screen, or onto the next screen.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;     <a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a>:
;         The player's current X position.
;
;     <a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a>:
;         The ID of the screen to the left.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The counter used for scrolling.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated flags.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;     <a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a>:
;         The updated player X position.
;
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;         The updated move acceleration.
;
;     <a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a>:
;         The new screen, if switching screens.
;
;     <a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a>:
;         The updated counter used for scrolling.
;
;     <a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a>:
;         The transition counter for the player movement,
;         if scrolling screens.
;
; CALLS:
;     <a href="#Area_ScrollTo">Area_ScrollTo</a>
;     <a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a>
;     <a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a>
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;     <a href="#Player_SetPosAtRightEdge">Player_SetPosAtRightEdge</a>
;     <a href="#Screen_IsEdge">Screen_IsEdge</a>
;
; XREFS:
;     <a href="#Player_CheckHandleJump">Player_CheckHandleJump</a>
;     <a href="#Player_KnockbackHoriz">Player_KnockbackHoriz</a>
;============================================================================
</div><span class="l"><a class="anc" name="e220" href="#e220">[e220]</a><a href="#Player_TryMoveLeft" class="la">Player_TryMoveLeft:</a><span class="ce">; [$e220]</span></span>
<div class="c">;
; Check whether the player is moving.
;
</div><span class="l"><a class="anc" name="e220" href="#e220">[e220]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e222" href="#e222">[e222]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Check the moving bit.</span></span>
<span class="l"><a class="anc" name="e224" href="#e224">[e224]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_setMoving">@_setMoving</a></span></span><span class="ce">; If set, jump to handle movement.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is not moving. Reset the movement speed.
;
</div><span class="l"><a class="anc" name="e226" href="#e226">[e226]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span><span class="ce">; Start with the standard acceleration.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e229:@_setMoving"></a><div class="c">;
; Calculate movement speed and set the player to move to
; the left.
;
</div><span class="l"><a class="anc" name="e229" href="#e229">[e229]</a><a href="#:e229:@_setMoving" class="lla">@_setMoving:</a><span class="ce">; [$e229]</span></span>
<span class="l"><a class="anc" name="e229" href="#e229">[e229]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a></span></span><span class="ce">; Calculate the new walking speed.</span></span>
<span class="l"><a class="anc" name="e22c" href="#e22c">[e22c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e22e" href="#e22e">[e22e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$bf</span></span><span class="ce">; Set the player to face left.</span></span>
<span class="l"><a class="anc" name="e230" href="#e230">[e230]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$20</span></span><span class="ce">; Set the player to moving.</span></span>
<span class="l"><a class="anc" name="e232" href="#e232">[e232]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store as the new flags.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the player's X position to factor in acceleration.
;
</div><span class="l"><a class="anc" name="e234" href="#e234">[e234]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a></span></span><span class="ce">; Load the fractional X position.</span></span>
<span class="l"><a class="anc" name="e236" href="#e236">[e236]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e237" href="#e237">[e237]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Subtract the move acceleration.</span></span>
<span class="l"><a class="anc" name="e239" href="#e239">[e239]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Frac">Player_PosX_Frac</a></span></span><span class="ce">; Store as the new fractional position.</span></span>
<span class="l"><a class="anc" name="e23b" href="#e23b">[e23b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the full X position.</span></span>
<span class="l"><a class="anc" name="e23d" href="#e23d">[e23d]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span><span class="ce">; Subtract the move acceleration.</span></span>
<span class="l"><a class="anc" name="e23f" href="#e23f">[e23f]</a><span class="cd"><span class="i">PHP</span></span><span class="ce">; Push all flags.</span></span>
<span class="l"><a class="anc" name="e240" href="#e240">[e240]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_saveFlags">@_saveFlags</a></span></span><span class="ce">; If &gt;= 0, jump.</span></span>
<span class="l"><a class="anc" name="e242" href="#e242">[e242]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Else, cap at 0, so it doesn't wrap.</span></span>
<span class="l"></span>
<a name=":e244:@_saveFlags"></a><span class="l"><a class="anc" name="e244" href="#e244">[e244]</a><a href="#:e244:@_saveFlags" class="lla">@_saveFlags:</a><span class="ce">; [$e244]</span></span>
<span class="l"><a class="anc" name="e244" href="#e244">[e244]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Store the new X position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the block there is passable.
;
</div><span class="l"><a class="anc" name="e246" href="#e246">[e246]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e248" href="#e248">[e248]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span><span class="ce">; Is the block to the left passable?</span></span>
<span class="l"><a class="anc" name="e24b" href="#e24b">[e24b]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_checkAtLeftEdge">@_checkAtLeftEdge</a></span></span><span class="ce">; If not, jump to check for an edge or transition boundary.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The block is not passable. Cap the position.
;
</div><span class="l"><a class="anc" name="e24d" href="#e24d">[e24d]</a><span class="cd"><span class="i">PLP</span></span><span class="ce">; Pop the flags from the acceleration calculation.</span></span>
<span class="l"><a class="anc" name="e24e" href="#e24e">[e24e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><a class="anc" name="e250" href="#e250">[e250]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Is this in the first 16 pixels?</span></span>
<span class="l"><a class="anc" name="e252" href="#e252">[e252]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return1">@_return1</a></span></span><span class="ce">; If so, we're done.</span></span>
<span class="l"><a class="anc" name="e254" href="#e254">[e254]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player X position.</span></span>
<span class="l"><a class="anc" name="e256" href="#e256">[e256]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Keep all but pixels 0-16.</span></span>
<span class="l"><a class="anc" name="e258" href="#e258">[e258]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e259" href="#e259">[e259]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Add 16 pixels.</span></span>
<span class="l"><a class="anc" name="e25b" href="#e25b">[e25b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Store as the new position.</span></span>
<span class="l"></span>
<a name=":e25d:@_return1"></a><span class="l"><a class="anc" name="e25d" href="#e25d">[e25d]</a><a href="#:e25d:@_return1" class="lla">@_return1:</a><span class="ce">; [$e25d]</span></span>
<span class="l"><a class="anc" name="e25d" href="#e25d">[e25d]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; And we're done.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e25e:@_checkAtLeftEdge"></a><div class="c">;
; Check if the player is far enough to the left for
; any screen transition logic.
;
</div><span class="l"><a class="anc" name="e25e" href="#e25e">[e25e]</a><a href="#:e25e:@_checkAtLeftEdge" class="lla">@_checkAtLeftEdge:</a><span class="ce">; [$e25e]</span></span>
<span class="l"><a class="anc" name="e25e" href="#e25e">[e25e]</a><span class="cd"><span class="i">PLP</span></span><span class="ce">; Pop the flags from the acceleration calculation.</span></span>
<span class="l"><a class="anc" name="e25f" href="#e25f">[e25f]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return2">@_return2</a></span></span><span class="ce">; If it didn't overflow off the left, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the player is at the edge and can scroll.
;
</div><span class="l"><a class="anc" name="e261" href="#e261">[e261]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e263" href="#e263">[e263]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span><span class="ce">; Check if the screen is the left-most edge.</span></span>
<span class="l"><a class="anc" name="e266" href="#e266">[e266]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_setAtLeftEdge">@_setAtLeftEdge</a></span></span><span class="ce">; If at the edge, jump to cap the position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There's a screen to the left. Transition there.
;
</div><span class="l"><a class="anc" name="e268" href="#e268">[e268]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a></span></span><span class="ce">; A = Neighboring screen to the left.</span></span>
<span class="l"><a class="anc" name="e26a" href="#e26a">[e26a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Store as the new current screen.</span></span>
<span class="l"><a class="anc" name="e26c" href="#e26c">[e26c]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e26e" href="#e26e">[e26e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollTo">Area_ScrollTo</a></span></span><span class="ce">; Begin scrolling to the left.</span></span>
<span class="l"><a class="anc" name="e271" href="#e271">[e271]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e273" href="#e273">[e273]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Set the X position to 0.</span></span>
<span class="l"><a class="anc" name="e275" href="#e275">[e275]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_ScrollPlayerTransitionCounter">Screen_ScrollPlayerTransitionCounter</a></span></span><span class="ce">; Clear the transition counter.</span></span>
<span class="l"></span>
<a name=":e277:@_return2"></a><span class="l"><a class="anc" name="e277" href="#e277">[e277]</a><a href="#:e277:@_return2" class="lla">@_return2:</a><span class="ce">; [$e277]</span></span>
<span class="l"><a class="anc" name="e277" href="#e277">[e277]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e278:@_setAtLeftEdge"></a><div class="c">;
; The player is at the left-most edge, but didn't pass it.
;
</div><span class="l"><a class="anc" name="e278" href="#e278">[e278]</a><a href="#:e278:@_setAtLeftEdge" class="lla">@_setAtLeftEdge:</a><span class="ce">; [$e278]</span></span>
<span class="l"><a class="anc" name="e278" href="#e278">[e278]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e27a" href="#e27a">[e27a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Set the X position to 0.</span></span>
<span class="l"><a class="anc" name="e27c" href="#e27c">[e27c]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; And return.</span></span>
<span class="l"><a class="anc" name="e27d" href="#e27d">[e27d]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e27e" href="#e27e">[e27e]</a><span class="cd"><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetStandardAcceleration"></a><div class="cp">;============================================================================
; Set the standard player acceleration.
;
; This will set to the default aceleration of 0xC0.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>+1:
;         The default acceleration (0xC0).
;
; XREFS:
;     <a href="#Player_HandleIFrames">Player_HandleIFrames</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;     <a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a>
;============================================================================
</div><span class="l"><a class="anc" name="e27f" href="#e27f">[e27f]</a><a href="#Player_SetStandardAcceleration" class="la">Player_SetStandardAcceleration:</a><span class="ce">; [$e27f]</span></span>
<span class="l"><a class="anc" name="e27f" href="#e27f">[e27f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="e281" href="#e281">[e281]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Set the lower byte of movement acceleation to 0xC0.</span></span>
<span class="l"><a class="anc" name="e283" href="#e283">[e283]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e285" href="#e285">[e285]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span><span class="ce">; Set the upper byte to 0.</span></span>
<span class="l"><a class="anc" name="e287" href="#e287">[e287]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UpdatePosFromKnockback"></a><div class="cp">;============================================================================
; Update the player's position based on knockback.
;
; This will accelerate the player by 8 pixels when its
; position is next updated.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>:
;     <a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a>+1:
;         The updated acceleration.
;
; XREFS:
;     <a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a>
;============================================================================
</div><span class="l"><a class="anc" name="e288" href="#e288">[e288]</a><a href="#Player_UpdatePosFromKnockback" class="la">Player_UpdatePosFromKnockback:</a><span class="ce">; [$e288]</span></span>
<div class="c">;
; The player's in knockback state. Bump the player
; back a bunch.
;
</div><span class="l"><a class="anc" name="e288" href="#e288">[e288]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e28a" href="#e28a">[e28a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span><span class="ce">; Set lower acceleration byte to 0.</span></span>
<span class="l"><a class="anc" name="e28c" href="#e28c">[e28c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e28e" href="#e28e">[e28e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span><span class="ce">; Set upper to 8.</span></span>
<span class="l"><a class="anc" name="e290" href="#e290">[e290]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_UpdateAcceleration"></a><div class="cp">;============================================================================
; TODO: Document Player_UpdateAcceleration
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="e291" href="#e291">[e291]</a><a href="#Player_UpdateAcceleration" class="la">Player_UpdateAcceleration:</a><span class="ce">; [$e291]</span></span>
<span class="l"><a class="anc" name="e291" href="#e291">[e291]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e293" href="#e293">[e293]</a><span class="cd"><span class="i">AND</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e295" href="#e295">[e295]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Player_UpdatePosFromKnockback">Player_UpdatePosFromKnockback</a></span></span></span>
<span class="l"><a class="anc" name="e297" href="#e297">[e297]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e299" href="#e299">[e299]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0c</span></span></span>
<span class="l"><a class="anc" name="e29b" href="#e29b">[e29b]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2a3">@LAB_PRG15_MIRROR__e2a3</a></span></span></span>
<span class="l"><a class="anc" name="e29d" href="#e29d">[e29d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e29f" href="#e29f">[e29f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e2a1" href="#e2a1">[e2a1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Player_SetStandardAcceleration">Player_SetStandardAcceleration</a></span></span></span>
<span class="l"></span>
<a name=":e2a3:@LAB_PRG15_MIRROR__e2a3"></a><span class="l"><a class="anc" name="e2a3" href="#e2a3">[e2a3]</a><a href="#:e2a3:@LAB_PRG15_MIRROR__e2a3" class="lla">@LAB_PRG15_MIRROR__e2a3:</a><span class="ce">; [$e2a3]</span></span>
<span class="l"><a class="anc" name="e2a3" href="#e2a3">[e2a3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span></span>
<span class="l"><a class="anc" name="e2a5" href="#e2a5">[e2a5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="e2a7" href="#e2a7">[e2a7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span></span>
<span class="l"><a class="anc" name="e2a9" href="#e2a9">[e2a9]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e2ab" href="#e2ab">[e2ab]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="e2ad" href="#e2ad">[e2ad]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span></span>
<span class="l"><a class="anc" name="e2b0" href="#e2b0">[e2b0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e2b1" href="#e2b1">[e2b1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e2b2" href="#e2b2">[e2b2]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e2b4" href="#e2b4">[e2b4]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e2b5" href="#e2b5">[e2b5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span></span>
<span class="l"><a class="anc" name="e2b7" href="#e2b7">[e2b7]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e2b8" href="#e2b8">[e2b8]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#@_return">@_return</a>+1,X</span></span></span>
<span class="l"><a class="anc" name="e2bb" href="#e2bb">[e2bb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration">Player_MoveAcceleration</a></span></span></span>
<span class="l"><a class="anc" name="e2bd" href="#e2bd">[e2bd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span></span>
<span class="l"><a class="anc" name="e2bf" href="#e2bf">[e2bf]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e2c1" href="#e2c1">[e2c1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MoveAcceleration_U">Player_MoveAcceleration_U</a></span></span></span>
<span class="l"></span>
<a name=":e2c3:@_return"></a><span class="l"><a class="anc" name="e2c3" href="#e2c3">[e2c3]</a><a href="#:e2c3:@_return" class="lla">@_return:</a><span class="ce">; [$e2c3]</span></span>
<span class="l"><a class="anc" name="e2c3" href="#e2c3">[e2c3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__e2c4"></a><div class="c">;
; XREFS:
;     <a href="#Player_UpdateAcceleration">Player_UpdateAcceleration</a>
;
</div><span class="l"><a class="anc" name="e2c4" href="#e2c4">[e2c4]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__e2c4" class="la">BYTE_ARRAY_PRG15_MIRROR__e2c4:</a><span class="ce">; [$e2c4]</span></span>
<span class="l"><a class="anc" name="e2c4" href="#e2c4">[e2c4]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e2c5" href="#e2c5">[e2c5]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e2c6" href="#e2c6">[e2c6]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e2c7" href="#e2c7">[e2c7]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleClimb"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimb
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e2c8" href="#e2c8">[e2c8]</a><a href="#Player_CheckHandleClimb" class="la">Player_CheckHandleClimb:</a><span class="ce">; [$e2c8]</span></span>
<span class="l"><a class="anc" name="e2c8" href="#e2c8">[e2c8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span><span class="ce">; A = Player status flags.</span></span>
<span class="l"><a class="anc" name="e2ca" href="#e2ca">[e2ca]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2d6">@LAB_PRG15_MIRROR__e2d6</a></span></span></span>
<span class="l"><a class="anc" name="e2cc" href="#e2cc">[e2cc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e2ce" href="#e2ce">[e2ce]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2d6">@LAB_PRG15_MIRROR__e2d6</a></span></span></span>
<span class="l"><a class="anc" name="e2d0" href="#e2d0">[e2d0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a></span></span></span>
<span class="l"><a class="anc" name="e2d3" href="#e2d3">[e2d3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2f4">@LAB_PRG15_MIRROR__e2f4</a></span></span></span>
<span class="l"></span>
<a name=":e2d6:@LAB_PRG15_MIRROR__e2d6"></a><span class="l"><a class="anc" name="e2d6" href="#e2d6">[e2d6]</a><a href="#:e2d6:@LAB_PRG15_MIRROR__e2d6" class="lla">@LAB_PRG15_MIRROR__e2d6:</a><span class="ce">; [$e2d6]</span></span>
<span class="l"><a class="anc" name="e2d6" href="#e2d6">[e2d6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a></span></span></span>
<span class="l"><a class="anc" name="e2d9" href="#e2d9">[e2d9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e2db" href="#e2db">[e2db]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e2dd" href="#e2dd">[e2dd]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2fe">@LAB_PRG15_MIRROR__e2fe</a></span></span></span>
<span class="l"><a class="anc" name="e2df" href="#e2df">[e2df]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e2e1" href="#e2e1">[e2e1]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0c</span></span></span>
<span class="l"><a class="anc" name="e2e3" href="#e2e3">[e2e3]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2fe">@LAB_PRG15_MIRROR__e2fe</a></span></span></span>
<span class="l"><a class="anc" name="e2e5" href="#e2e5">[e2e5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e2e7" href="#e2e7">[e2e7]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="e2e9" href="#e2e9">[e2e9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e2eb" href="#e2eb">[e2eb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e2ed" href="#e2ed">[e2ed]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e2ef" href="#e2ef">[e2ef]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e2f4">@LAB_PRG15_MIRROR__e2f4</a></span></span></span>
<span class="l"><a class="anc" name="e2f1" href="#e2f1">[e2f1]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a></span></span></span>
<span class="l"></span>
<a name=":e2f4:@LAB_PRG15_MIRROR__e2f4"></a><span class="l"><a class="anc" name="e2f4" href="#e2f4">[e2f4]</a><a href="#:e2f4:@LAB_PRG15_MIRROR__e2f4" class="lla">@LAB_PRG15_MIRROR__e2f4:</a><span class="ce">; [$e2f4]</span></span>
<span class="l"><a class="anc" name="e2f4" href="#e2f4">[e2f4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e2f6" href="#e2f6">[e2f6]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e2f7" href="#e2f7">[e2f7]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e2f8" href="#e2f8">[e2f8]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e2f9" href="#e2f9">[e2f9]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a></span></span></span>
<span class="l"><a class="anc" name="e2fb" href="#e2fb">[e2fb]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e2fc" href="#e2fc">[e2fc]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a></span></span></span>
<span class="l"></span>
<a name=":e2fe:@LAB_PRG15_MIRROR__e2fe"></a><span class="l"><a class="anc" name="e2fe" href="#e2fe">[e2fe]</a><a href="#:e2fe:@LAB_PRG15_MIRROR__e2fe" class="lla">@LAB_PRG15_MIRROR__e2fe:</a><span class="ce">; [$e2fe]</span></span>
<span class="l"><a class="anc" name="e2fe" href="#e2fe">[e2fe]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleClimbUp"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimbUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a class="anc" name="e301" href="#e301">[e301]</a><a href="#Player_CheckHandleClimbUp" class="la">Player_CheckHandleClimbUp:</a><span class="ce">; [$e301]</span></span>
<span class="l"><a class="anc" name="e301" href="#e301">[e301]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e303" href="#e303">[e303]</a><span class="cd"><span class="i">AND</span> <span class="o">#$da</span></span></span>
<span class="l"><a class="anc" name="e305" href="#e305">[e305]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e307" href="#e307">[e307]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e309" href="#e309">[e309]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e30c" href="#e30c">[e30c]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e343">@LAB_PRG15_MIRROR__e343</a></span></span></span>
<span class="l"><a class="anc" name="e30e" href="#e30e">[e30e]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><a class="anc" name="e310" href="#e310">[e310]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e312" href="#e312">[e312]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e31e">@LAB_PRG15_MIRROR__e31e</a></span></span></span>
<span class="l"><a class="anc" name="e314" href="#e314">[e314]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e316" href="#e316">[e316]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e317" href="#e317">[e317]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e319" href="#e319">[e319]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e31b" href="#e31b">[e31b]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e32b">@LAB_PRG15_MIRROR__e32b</a></span></span></span>
<span class="l"></span>
<a name=":e31e:@LAB_PRG15_MIRROR__e31e"></a><span class="l"><a class="anc" name="e31e" href="#e31e">[e31e]</a><a href="#:e31e:@LAB_PRG15_MIRROR__e31e" class="lla">@LAB_PRG15_MIRROR__e31e:</a><span class="ce">; [$e31e]</span></span>
<span class="l"><a class="anc" name="e31e" href="#e31e">[e31e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e320" href="#e320">[e320]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e321" href="#e321">[e321]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$a0</span></span></span>
<span class="l"><a class="anc" name="e323" href="#e323">[e323]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e325" href="#e325">[e325]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e327" href="#e327">[e327]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e329" href="#e329">[e329]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"></span>
<a name=":e32b:@LAB_PRG15_MIRROR__e32b"></a><span class="l"><a class="anc" name="e32b" href="#e32b">[e32b]</a><a href="#:e32b:@LAB_PRG15_MIRROR__e32b" class="lla">@LAB_PRG15_MIRROR__e32b:</a><span class="ce">; [$e32b]</span></span>
<span class="l"><a class="anc" name="e32b" href="#e32b">[e32b]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e343">@LAB_PRG15_MIRROR__e343</a></span></span></span>
<span class="l"><a class="anc" name="e32d" href="#e32d">[e32d]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e32f" href="#e32f">[e32f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><a class="anc" name="e332" href="#e332">[e332]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e344">@LAB_PRG15_MIRROR__e344</a></span></span></span>
<span class="l"><a class="anc" name="e334" href="#e334">[e334]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenAbove">Area_ScreenAbove</a></span></span></span>
<span class="l"><a class="anc" name="e336" href="#e336">[e336]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="e338" href="#e338">[e338]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e33a" href="#e33a">[e33a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollTo">Area_ScrollTo</a></span></span></span>
<span class="l"><a class="anc" name="e33d" href="#e33d">[e33d]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="e33f" href="#e33f">[e33f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="e341" href="#e341">[e341]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"></span>
<a name=":e343:@LAB_PRG15_MIRROR__e343"></a><span class="l"><a class="anc" name="e343" href="#e343">[e343]</a><a href="#:e343:@LAB_PRG15_MIRROR__e343" class="lla">@LAB_PRG15_MIRROR__e343:</a><span class="ce">; [$e343]</span></span>
<span class="l"><a class="anc" name="e343" href="#e343">[e343]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e344:@LAB_PRG15_MIRROR__e344"></a><span class="l"><a class="anc" name="e344" href="#e344">[e344]</a><a href="#:e344:@LAB_PRG15_MIRROR__e344" class="lla">@LAB_PRG15_MIRROR__e344:</a><span class="ce">; [$e344]</span></span>
<span class="l"><a class="anc" name="e344" href="#e344">[e344]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e346" href="#e346">[e346]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e348" href="#e348">[e348]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleClimbDown"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimbDown
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a class="anc" name="e349" href="#e349">[e349]</a><a href="#Player_CheckHandleClimbDown" class="la">Player_CheckHandleClimbDown:</a><span class="ce">; [$e349]</span></span>
<span class="l"><a class="anc" name="e349" href="#e349">[e349]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e34b" href="#e34b">[e34b]</a><span class="cd"><span class="i">AND</span> <span class="o">#$da</span></span></span>
<span class="l"><a class="anc" name="e34d" href="#e34d">[e34d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e34f" href="#e34f">[e34f]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e351" href="#e351">[e351]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e354" href="#e354">[e354]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_E393">RETURN_E393</a></span></span></span>
<span class="l"><a class="anc" name="e356" href="#e356">[e356]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><a class="anc" name="e358" href="#e358">[e358]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e35a" href="#e35a">[e35a]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e36c">@LAB_PRG15_MIRROR__e36c</a></span></span></span>
<span class="l"><a class="anc" name="e35c" href="#e35c">[e35c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e35e" href="#e35e">[e35e]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e35f" href="#e35f">[e35f]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="e361" href="#e361">[e361]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e363" href="#e363">[e363]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e365" href="#e365">[e365]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e367" href="#e367">[e367]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e369" href="#e369">[e369]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_MoveDownScreen">Player_MoveDownScreen</a></span></span></span>
<span class="l"></span>
<a name=":e36c:@LAB_PRG15_MIRROR__e36c"></a><span class="l"><a class="anc" name="e36c" href="#e36c">[e36c]</a><a href="#:e36c:@LAB_PRG15_MIRROR__e36c" class="lla">@LAB_PRG15_MIRROR__e36c:</a><span class="ce">; [$e36c]</span></span>
<span class="l"><a class="anc" name="e36c" href="#e36c">[e36c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e36e" href="#e36e">[e36e]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e36f" href="#e36f">[e36f]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="e371" href="#e371">[e371]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e373" href="#e373">[e373]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e375" href="#e375">[e375]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e377" href="#e377">[e377]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_MoveDownScreen"></a><div class="cp">;============================================================================
; TODO: Document Player_MoveDownScreen
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a>
;============================================================================
</div><span class="l"><a class="anc" name="e379" href="#e379">[e379]</a><a href="#Player_MoveDownScreen" class="la">Player_MoveDownScreen:</a><span class="ce">; [$e379]</span></span>
<span class="l"><a class="anc" name="e379" href="#e379">[e379]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$c1</span></span></span>
<span class="l"><a class="anc" name="e37b" href="#e37b">[e37b]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#RETURN_E393">RETURN_E393</a></span></span></span>
<span class="l"><a class="anc" name="e37d" href="#e37d">[e37d]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e37f" href="#e37f">[e37f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><a class="anc" name="e382" href="#e382">[e382]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_SetPosAtBottomEdge">Player_SetPosAtBottomEdge</a></span></span></span>
<span class="l"><a class="anc" name="e384" href="#e384">[e384]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenBelow">Area_ScreenBelow</a></span></span></span>
<span class="l"><a class="anc" name="e386" href="#e386">[e386]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="e388" href="#e388">[e388]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e38a" href="#e38a">[e38a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollTo">Area_ScrollTo</a></span></span></span>
<span class="l"><a class="anc" name="e38d" href="#e38d">[e38d]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="e38f" href="#e38f">[e38f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e391" href="#e391">[e391]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"></span>
<a name="RETURN_E393"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a>
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;
</div><span class="l"><a class="anc" name="e393" href="#e393">[e393]</a><a href="#RETURN_E393" class="la">RETURN_E393:</a><span class="ce">; [$e393]</span></span>
<span class="l"><a class="anc" name="e393" href="#e393">[e393]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetPosAtBottomEdge"></a><div class="cp">;============================================================================
; Set the player at the bottom-most position of the screen.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_PosY">Player_PosY</a>:
;         The updated player position (set to 0xC0).
;
; XREFS:
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="e394" href="#e394">[e394]</a><a href="#Player_SetPosAtBottomEdge" class="la">Player_SetPosAtBottomEdge:</a><span class="ce">; [$e394]</span></span>
<span class="l"><a class="anc" name="e394" href="#e394">[e394]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="e396" href="#e396">[e396]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span><span class="ce">; Set player Y position to 0xC0 (192).</span></span>
<span class="l"><a class="anc" name="e398" href="#e398">[e398]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleClimbMaybeSide"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleClimbMaybeSide
;
; INPUTS:
;     X
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a class="anc" name="e399" href="#e399">[e399]</a><a href="#Player_CheckHandleClimbMaybeSide" class="la">Player_CheckHandleClimbMaybeSide:</a><span class="ce">; [$e399]</span></span>
<span class="l"><a class="anc" name="e399" href="#e399">[e399]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><a class="anc" name="e39b" href="#e39b">[e39b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="e39d" href="#e39d">[e39d]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3a5">@LAB_PRG15_MIRROR__e3a5</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the player's Jumping state.
;
</div><span class="l"><a class="anc" name="e39f" href="#e39f">[e39f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e3a1" href="#e3a1">[e3a1]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fe</span></span><span class="ce">; Clear the Jumping bit.</span></span>
<span class="l"><a class="anc" name="e3a3" href="#e3a3">[e3a3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Save it back.</span></span>
<span class="l"></span>
<a name=":e3a5:@LAB_PRG15_MIRROR__e3a5"></a><span class="l"><a class="anc" name="e3a5" href="#e3a5">[e3a5]</a><a href="#:e3a5:@LAB_PRG15_MIRROR__e3a5" class="lla">@LAB_PRG15_MIRROR__e3a5:</a><span class="ce">; [$e3a5]</span></span>
<span class="l"><a class="anc" name="e3a5" href="#e3a5">[e3a5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e3a7" href="#e3a7">[e3a7]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e3a8" href="#e3a8">[e3a8]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3ad">@LAB_PRG15_MIRROR__e3ad</a></span></span></span>
<span class="l"><a class="anc" name="e3aa" href="#e3aa">[e3aa]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_StayOnLadderAndContinue">Player_StayOnLadderAndContinue</a></span></span></span>
<span class="l"></span>
<a name=":e3ad:@LAB_PRG15_MIRROR__e3ad"></a><span class="l"><a class="anc" name="e3ad" href="#e3ad">[e3ad]</a><a href="#:e3ad:@LAB_PRG15_MIRROR__e3ad" class="lla">@LAB_PRG15_MIRROR__e3ad:</a><span class="ce">; [$e3ad]</span></span>
<span class="l"><a class="anc" name="e3ad" href="#e3ad">[e3ad]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e3af" href="#e3af">[e3af]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e3b2" href="#e3b2">[e3b2]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3b7">@LAB_PRG15_MIRROR__e3b7</a></span></span></span>
<span class="l"><a class="anc" name="e3b4" href="#e3b4">[e3b4]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_StayOnLadderAndContinue">Player_StayOnLadderAndContinue</a></span></span></span>
<span class="l"></span>
<a name=":e3b7:@LAB_PRG15_MIRROR__e3b7"></a><span class="l"><a class="anc" name="e3b7" href="#e3b7">[e3b7]</a><a href="#:e3b7:@LAB_PRG15_MIRROR__e3b7" class="lla">@LAB_PRG15_MIRROR__e3b7:</a><span class="ce">; [$e3b7]</span></span>
<span class="l"><a class="anc" name="e3b7" href="#e3b7">[e3b7]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a></span></span></span>
<span class="l"><a class="anc" name="e3ba" href="#e3ba">[e3ba]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e3bc" href="#e3bc">[e3bc]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3cd">@LAB_PRG15_MIRROR__e3cd</a></span></span></span>
<span class="l"><a class="anc" name="e3be" href="#e3be">[e3be]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"><a class="anc" name="e3c0" href="#e3c0">[e3c0]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e3c2" href="#e3c2">[e3c2]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3c9">@LAB_PRG15_MIRROR__e3c9</a></span></span></span>
<span class="l"><a class="anc" name="e3c4" href="#e3c4">[e3c4]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"><a class="anc" name="e3c6" href="#e3c6">[e3c6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a></span></span></span>
<span class="l"></span>
<a name=":e3c9:@LAB_PRG15_MIRROR__e3c9"></a><span class="l"><a class="anc" name="e3c9" href="#e3c9">[e3c9]</a><a href="#:e3c9:@LAB_PRG15_MIRROR__e3c9" class="lla">@LAB_PRG15_MIRROR__e3c9:</a><span class="ce">; [$e3c9]</span></span>
<span class="l"><a class="anc" name="e3c9" href="#e3c9">[e3c9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e3cb" href="#e3cb">[e3cb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"></span>
<a name=":e3cd:@LAB_PRG15_MIRROR__e3cd"></a><span class="l"><a class="anc" name="e3cd" href="#e3cd">[e3cd]</a><a href="#:e3cd:@LAB_PRG15_MIRROR__e3cd" class="lla">@LAB_PRG15_MIRROR__e3cd:</a><span class="ce">; [$e3cd]</span></span>
<span class="l"><a class="anc" name="e3cd" href="#e3cd">[e3cd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e3cf" href="#e3cf">[e3cf]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3d1">@LAB_PRG15_MIRROR__e3d1</a></span></span></span>
<span class="l"></span>
<a name=":e3d1:@LAB_PRG15_MIRROR__e3d1"></a><span class="l"><a class="anc" name="e3d1" href="#e3d1">[e3d1]</a><a href="#:e3d1:@LAB_PRG15_MIRROR__e3d1" class="lla">@LAB_PRG15_MIRROR__e3d1:</a><span class="ce">; [$e3d1]</span></span>
<span class="l"><a class="anc" name="e3d1" href="#e3d1">[e3d1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e3d3" href="#e3d3">[e3d3]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="e3d5" href="#e3d5">[e3d5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e3d7" href="#e3d7">[e3d7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e3d9" href="#e3d9">[e3d9]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e3db" href="#e3db">[e3db]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Player_StayOnLadderAndContinue">Player_StayOnLadderAndContinue</a></span></span></span>
<span class="l"><a class="anc" name="e3dd" href="#e3dd">[e3dd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="e3df" href="#e3df">[e3df]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3f5">@LAB_PRG15_MIRROR__e3f5</a></span></span></span>
<span class="l"><a class="anc" name="e3e1" href="#e3e1">[e3e1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e3e3" href="#e3e3">[e3e3]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e3f5">@LAB_PRG15_MIRROR__e3f5</a></span></span></span>
<span class="l"><a class="anc" name="e3e5" href="#e3e5">[e3e5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e3e7" href="#e3e7">[e3e7]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e3e8" href="#e3e8">[e3e8]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e3ea" href="#e3ea">[e3ea]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BYTE_00a0">BYTE_00a0</a></span></span></span>
<span class="l"><a class="anc" name="e3ec" href="#e3ec">[e3ec]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e3ee" href="#e3ee">[e3ee]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e3f0" href="#e3f0">[e3f0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e3f2" href="#e3f2">[e3f2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Area_ScrollScreenDown">Area_ScrollScreenDown</a></span></span></span>
<span class="l"></span>
<a name=":e3f5:@LAB_PRG15_MIRROR__e3f5"></a><span class="l"><a class="anc" name="e3f5" href="#e3f5">[e3f5]</a><a href="#:e3f5:@LAB_PRG15_MIRROR__e3f5" class="lla">@LAB_PRG15_MIRROR__e3f5:</a><span class="ce">; [$e3f5]</span></span>
<span class="l"><a class="anc" name="e3f5" href="#e3f5">[e3f5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e3f7" href="#e3f7">[e3f7]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e3f8" href="#e3f8">[e3f8]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e3fa" href="#e3fa">[e3fa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_ScrollScreenDown"></a><div class="cp">;============================================================================
; TODO: Document Area_ScrollScreenDown
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a class="anc" name="e3fc" href="#e3fc">[e3fc]</a><a href="#Area_ScrollScreenDown" class="la">Area_ScrollScreenDown:</a><span class="ce">; [$e3fc]</span></span>
<span class="l"><a class="anc" name="e3fc" href="#e3fc">[e3fc]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$c1</span></span></span>
<span class="l"><a class="anc" name="e3fe" href="#e3fe">[e3fe]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e41e">@LAB_PRG15_MIRROR__e41e</a></span></span></span>
<span class="l"><a class="anc" name="e400" href="#e400">[e400]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e402" href="#e402">[e402]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><a class="anc" name="e405" href="#e405">[e405]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e40e">@LAB_PRG15_MIRROR__e40e</a></span></span></span>
<span class="l"><a class="anc" name="e407" href="#e407">[e407]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="e409" href="#e409">[e409]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e40b" href="#e40b">[e40b]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e42c">@LAB_PRG15_MIRROR__e42c</a></span></span></span>
<span class="l"></span>
<a name=":e40e:@LAB_PRG15_MIRROR__e40e"></a><span class="l"><a class="anc" name="e40e" href="#e40e">[e40e]</a><a href="#:e40e:@LAB_PRG15_MIRROR__e40e" class="lla">@LAB_PRG15_MIRROR__e40e:</a><span class="ce">; [$e40e]</span></span>
<span class="l"><a class="anc" name="e40e" href="#e40e">[e40e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenBelow">Area_ScreenBelow</a></span></span></span>
<span class="l"><a class="anc" name="e410" href="#e410">[e410]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="e412" href="#e412">[e412]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e414" href="#e414">[e414]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollTo">Area_ScrollTo</a></span></span></span>
<span class="l"><a class="anc" name="e417" href="#e417">[e417]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="e419" href="#e419">[e419]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e41b" href="#e41b">[e41b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e41d" href="#e41d">[e41d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e41e:@LAB_PRG15_MIRROR__e41e"></a><span class="l"><a class="anc" name="e41e" href="#e41e">[e41e]</a><a href="#:e41e:@LAB_PRG15_MIRROR__e41e" class="lla">@LAB_PRG15_MIRROR__e41e:</a><span class="ce">; [$e41e]</span></span>
<span class="l"><a class="anc" name="e41e" href="#e41e">[e41e]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e420" href="#e420">[e420]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e423" href="#e423">[e423]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e42b">@LAB_PRG15_MIRROR__e42b</a></span></span></span>
<span class="l"><a class="anc" name="e425" href="#e425">[e425]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e427" href="#e427">[e427]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="e429" href="#e429">[e429]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"></span>
<a name=":e42b:@LAB_PRG15_MIRROR__e42b"></a><span class="l"><a class="anc" name="e42b" href="#e42b">[e42b]</a><a href="#:e42b:@LAB_PRG15_MIRROR__e42b" class="lla">@LAB_PRG15_MIRROR__e42b:</a><span class="ce">; [$e42b]</span></span>
<span class="l"><a class="anc" name="e42b" href="#e42b">[e42b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e42c:@LAB_PRG15_MIRROR__e42c"></a><span class="l"><a class="anc" name="e42c" href="#e42c">[e42c]</a><a href="#:e42c:@LAB_PRG15_MIRROR__e42c" class="lla">@LAB_PRG15_MIRROR__e42c:</a><span class="ce">; [$e42c]</span></span>
<span class="l"><a class="anc" name="e42c" href="#e42c">[e42c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e42e" href="#e42e">[e42e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fb</span></span></span>
<span class="l"><a class="anc" name="e430" href="#e430">[e430]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e432" href="#e432">[e432]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_ClearJumpingAndHoldingToClimb"></a><div class="cp">;============================================================================
; TODO: Document Player_ClearJumpingAndHoldingToClimb
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;============================================================================
</div><span class="l"><a class="anc" name="e433" href="#e433">[e433]</a><a href="#Player_ClearJumpingAndHoldingToClimb" class="la">Player_ClearJumpingAndHoldingToClimb:</a><span class="ce">; [$e433]</span></span>
<span class="l"><a class="anc" name="e433" href="#e433">[e433]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e435" href="#e435">[e435]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fc</span></span></span>
<span class="l"><a class="anc" name="e437" href="#e437">[e437]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"></span>
<a name="RETURN_E439"></a><div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a class="anc" name="e439" href="#e439">[e439]</a><a href="#RETURN_E439" class="la">RETURN_E439:</a><span class="ce">; [$e439]</span></span>
<span class="l"><a class="anc" name="e439" href="#e439">[e439]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Player_StayOnLadderAndContinue"></a><div class="cp">;============================================================================
; TODO: Document Player_StayOnLadderAndContinue
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a class="anc" name="e43a" href="#e43a">[e43a]</a><a href="#Player_StayOnLadderAndContinue" class="la">Player_StayOnLadderAndContinue:</a><span class="ce">; [$e43a]</span></span>
<div class="c">;
; Clear the Falling Off state.
;
</div><span class="l"><a class="anc" name="e43a" href="#e43a">[e43a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e43c" href="#e43c">[e43c]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fb</span></span><span class="ce">; Clear the Falling Off flag.</span></span>
<span class="l"><a class="anc" name="e43e" href="#e43e">[e43e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Save it back.</span></span>
<span class="l"><a class="anc" name="e440" href="#e440">[e440]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e442" href="#e442">[e442]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_ClimbLadderOffset">Maybe_ClimbLadderOffset</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><a name="Player_ContinueHandleClimbOrJump"></a><div class="cp">;============================================================================
; TODO: Document Player_ContinueHandleClimbOrJump
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a class="anc" name="e444" href="#e444">[e444]</a><a href="#Player_ContinueHandleClimbOrJump" class="la">Player_ContinueHandleClimbOrJump:</a><span class="ce">; [$e444]</span></span>
<div class="c">;
; Check if the player is jumping.
;
</div><span class="l"><a class="anc" name="e444" href="#e444">[e444]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e446" href="#e446">[e446]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift the Jump flag into Carry.</span></span>
<span class="l"><a class="anc" name="e447" href="#e447">[e447]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_isJumping">@_isJumping</a></span></span><span class="ce">; If set (player is jumping), then jump (branch).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is not jumping.
;
</div><span class="l"><a class="anc" name="e449" href="#e449">[e449]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; X = Controller 1 changed button mask.</span></span>
<span class="l"><a class="anc" name="e44b" href="#e44b">[e44b]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#Player_ClearJumpingAndHoldingToClimb">Player_ClearJumpingAndHoldingToClimb</a></span></span><span class="ce">; If the player is holding down A, then check grabbing for a ladder and return.</span></span>
<span class="l"><a class="anc" name="e44d" href="#e44d">[e44d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_IsClimbing">Player_IsClimbing</a></span></span></span>
<span class="l"><a class="anc" name="e450" href="#e450">[e450]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#RETURN_E439">RETURN_E439</a></span></span></span>
<span class="l"><a class="anc" name="e452" href="#e452">[e452]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e454" href="#e454">[e454]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e457" href="#e457">[e457]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#RETURN_E4B6">RETURN_E4B6</a></span></span></span>
<span class="l"><a class="anc" name="e459" href="#e459">[e459]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e45b" href="#e45b">[e45b]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e45d" href="#e45d">[e45d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e45f" href="#e45f">[e45f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e461" href="#e461">[e461]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"></span>
<a name=":e463:@_isJumping"></a><span class="l"><a class="anc" name="e463" href="#e463">[e463]</a><a href="#:e463:@_isJumping" class="lla">@_isJumping:</a><span class="ce">; [$e463]</span></span>
<span class="l"><a class="anc" name="e463" href="#e463">[e463]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><a class="anc" name="e465" href="#e465">[e465]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="e467" href="#e467">[e467]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e46b">@LAB_PRG15_MIRROR__e46b</a></span></span></span>
<span class="l"><a class="anc" name="e469" href="#e469">[e469]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e4a2">@LAB_PRG15_MIRROR__e4a2</a></span></span></span>
<span class="l"></span>
<a name=":e46b:@LAB_PRG15_MIRROR__e46b"></a><span class="l"><a class="anc" name="e46b" href="#e46b">[e46b]</a><a href="#:e46b:@LAB_PRG15_MIRROR__e46b" class="lla">@LAB_PRG15_MIRROR__e46b:</a><span class="ce">; [$e46b]</span></span>
<span class="l"><a class="anc" name="e46b" href="#e46b">[e46b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e46d" href="#e46d">[e46d]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e46e" href="#e46e">[e46e]</a><span class="cd"><span class="i">SBC</span> <span class="o">$e4d6,X</span></span></span>
<span class="l"><a class="anc" name="e471" href="#e471">[e471]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e473" href="#e473">[e473]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e481">@LAB_PRG15_MIRROR__e481</a></span></span></span>
<span class="l"><a class="anc" name="e475" href="#e475">[e475]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e477" href="#e477">[e477]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_IsEdge">Screen_IsEdge</a></span></span></span>
<span class="l"><a class="anc" name="e47a" href="#e47a">[e47a]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#Area_ScrollScreenUp">Area_ScrollScreenUp</a></span></span></span>
<span class="l"><a class="anc" name="e47c" href="#e47c">[e47c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e47e" href="#e47e">[e47e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e49a">@LAB_PRG15_MIRROR__e49a</a></span></span></span>
<span class="l"></span>
<a name=":e481:@LAB_PRG15_MIRROR__e481"></a><span class="l"><a class="anc" name="e481" href="#e481">[e481]</a><a href="#:e481:@LAB_PRG15_MIRROR__e481" class="lla">@LAB_PRG15_MIRROR__e481:</a><span class="ce">; [$e481]</span></span>
<span class="l"><a class="anc" name="e481" href="#e481">[e481]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e483" href="#e483">[e483]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e486" href="#e486">[e486]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Area_Something_IncDAT00a6">Area_Something_IncDAT00a6</a></span></span></span>
<span class="l"><a class="anc" name="e488" href="#e488">[e488]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><a class="anc" name="e48a" href="#e48a">[e48a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e48c" href="#e48c">[e48c]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e48e" href="#e48e">[e48e]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e48f" href="#e48f">[e48f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e491" href="#e491">[e491]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="e493" href="#e493">[e493]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e495" href="#e495">[e495]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e49a">@LAB_PRG15_MIRROR__e49a</a></span></span></span>
<span class="l"><a class="anc" name="e497" href="#e497">[e497]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e498" href="#e498">[e498]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"></span>
<a name=":e49a:@LAB_PRG15_MIRROR__e49a"></a><span class="l"><a class="anc" name="e49a" href="#e49a">[e49a]</a><a href="#:e49a:@LAB_PRG15_MIRROR__e49a" class="lla">@LAB_PRG15_MIRROR__e49a:</a><span class="ce">; [$e49a]</span></span>
<span class="l"><a class="anc" name="e49a" href="#e49a">[e49a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e49c" href="#e49c">[e49c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e49e" href="#e49e">[e49e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><a class="anc" name="e4a0" href="#e4a0">[e4a0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Area_Something_IncDAT00a6">Area_Something_IncDAT00a6</a></span></span></span>
<span class="l"></span>
<a name=":e4a2:@LAB_PRG15_MIRROR__e4a2"></a><span class="l"><a class="anc" name="e4a2" href="#e4a2">[e4a2]</a><a href="#:e4a2:@LAB_PRG15_MIRROR__e4a2" class="lla">@LAB_PRG15_MIRROR__e4a2:</a><span class="ce">; [$e4a2]</span></span>
<span class="l"><a class="anc" name="e4a2" href="#e4a2">[e4a2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e4a4" href="#e4a4">[e4a4]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e4a5" href="#e4a5">[e4a5]</a><span class="cd"><span class="i">ADC</span> <span class="o">$e4d6,X</span></span></span>
<span class="l"><a class="anc" name="e4a8" href="#e4a8">[e4a8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e4aa" href="#e4aa">[e4aa]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e4ac" href="#e4ac">[e4ac]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckIfPassable">Player_CheckIfPassable</a></span></span></span>
<span class="l"><a class="anc" name="e4af" href="#e4af">[e4af]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Maybe_SetPlayerForScrollUp">Maybe_SetPlayerForScrollUp</a></span></span></span>
<span class="l"></span>
<a name="Area_Something_IncDAT00a6"></a><div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a class="anc" name="e4b1" href="#e4b1">[e4b1]</a><a href="#Area_Something_IncDAT00a6" class="la">Area_Something_IncDAT00a6:</a><span class="ce">; [$e4b1]</span></span>
<span class="l"><a class="anc" name="e4b1" href="#e4b1">[e4b1]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"><a class="anc" name="e4b3" href="#e4b3">[e4b3]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e4b4" href="#e4b4">[e4b4]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Something_Player_ClimbLadderCheckPos">Something_Player_ClimbLadderCheckPos</a></span></span></span>
<span class="l"></span>
<a name="RETURN_E4B6"></a><div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a class="anc" name="e4b6" href="#e4b6">[e4b6]</a><a href="#RETURN_E4B6" class="la">RETURN_E4B6:</a><span class="ce">; [$e4b6]</span></span>
<span class="l"><a class="anc" name="e4b6" href="#e4b6">[e4b6]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_ScrollScreenUp"></a><div class="cp">;============================================================================
; TODO: Document Area_ScrollScreenUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;============================================================================
</div><span class="l"><a class="anc" name="e4b7" href="#e4b7">[e4b7]</a><a href="#Area_ScrollScreenUp" class="la">Area_ScrollScreenUp:</a><span class="ce">; [$e4b7]</span></span>
<span class="l"><a class="anc" name="e4b7" href="#e4b7">[e4b7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenAbove">Area_ScreenAbove</a></span></span></span>
<span class="l"><a class="anc" name="e4b9" href="#e4b9">[e4b9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="e4bb" href="#e4bb">[e4bb]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="e4bd" href="#e4bd">[e4bd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ScrollTo">Area_ScrollTo</a></span></span></span>
<span class="l"><a class="anc" name="e4c0" href="#e4c0">[e4c0]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="e4c2" href="#e4c2">[e4c2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="e4c4" href="#e4c4">[e4c4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e4c6" href="#e4c6">[e4c6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Maybe_SetPlayerForScrollUp">Maybe_SetPlayerForScrollUp</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Maybe_SetPlayerForScrollUp"></a><div class="cp">;============================================================================
; TODO: Document Maybe_SetPlayerForScrollUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Area_ScrollScreenUp">Area_ScrollScreenUp</a>
;============================================================================
</div><span class="l"><a class="anc" name="e4c9" href="#e4c9">[e4c9]</a><a href="#Maybe_SetPlayerForScrollUp" class="la">Maybe_SetPlayerForScrollUp:</a><span class="ce">; [$e4c9]</span></span>
<span class="l"><a class="anc" name="e4c9" href="#e4c9">[e4c9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e4cb" href="#e4cb">[e4cb]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="e4cd" href="#e4cd">[e4cd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e4cf" href="#e4cf">[e4cf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e4d1" href="#e4d1">[e4d1]</a><span class="cd"><span class="i">AND</span> <span class="o">#$fe</span></span></span>
<span class="l"><a class="anc" name="e4d3" href="#e4d3">[e4d3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e4d5" href="#e4d5">[e4d5]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__e4d6"></a><div class="c">;
; XREFS:
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;
</div><span class="l"><a class="anc" name="e4d6" href="#e4d6">[e4d6]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__e4d6" class="la">BYTE_ARRAY_PRG15_MIRROR__e4d6:</a><span class="ce">; [$e4d6]</span></span>
<span class="l"><a class="anc" name="e4d6" href="#e4d6">[e4d6]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e4d7" href="#e4d7">[e4d7]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e4d8" href="#e4d8">[e4d8]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e4d9" href="#e4d9">[e4d9]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="e4da" href="#e4da">[e4da]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="e4db" href="#e4db">[e4db]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="e4dc" href="#e4dc">[e4dc]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="e4dd" href="#e4dd">[e4dd]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="e4de" href="#e4de">[e4de]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="e4df" href="#e4df">[e4df]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="e4e0" href="#e4e0">[e4e0]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="e4e1" href="#e4e1">[e4e1]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]:</span></span>
<span class="l"><a class="anc" name="e4e2" href="#e4e2">[e4e2]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [12]:</span></span>
<span class="l"><a class="anc" name="e4e3" href="#e4e3">[e4e3]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [13]:</span></span>
<span class="l"><a class="anc" name="e4e4" href="#e4e4">[e4e4]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><a class="anc" name="e4e5" href="#e4e5">[e4e5]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [15]:</span></span>
<span class="l"><a class="anc" name="e4e6" href="#e4e6">[e4e6]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [16]:</span></span>
<span class="l"><a class="anc" name="e4e7" href="#e4e7">[e4e7]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [17]:</span></span>
<span class="l"><a class="anc" name="e4e8" href="#e4e8">[e4e8]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [18]:</span></span>
<span class="l"><a class="anc" name="e4e9" href="#e4e9">[e4e9]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]:</span></span>
<span class="l"><a class="anc" name="e4ea" href="#e4ea">[e4ea]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [20]:</span></span>
<span class="l"><a class="anc" name="e4eb" href="#e4eb">[e4eb]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [21]:</span></span>
<span class="l"><a class="anc" name="e4ec" href="#e4ec">[e4ec]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [22]:</span></span>
<span class="l"><a class="anc" name="e4ed" href="#e4ed">[e4ed]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [23]:</span></span>
<span class="l"><a class="anc" name="e4ee" href="#e4ee">[e4ee]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [24]:</span></span>
<span class="l"><a class="anc" name="e4ef" href="#e4ef">[e4ef]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [25]:</span></span>
<span class="l"><a class="anc" name="e4f0" href="#e4f0">[e4f0]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [26]:</span></span>
<span class="l"><a class="anc" name="e4f1" href="#e4f1">[e4f1]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [27]:</span></span>
<span class="l"><a class="anc" name="e4f2" href="#e4f2">[e4f2]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [28]:</span></span>
<span class="l"><a class="anc" name="e4f3" href="#e4f3">[e4f3]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [29]:</span></span>
<span class="l"><a class="anc" name="e4f4" href="#e4f4">[e4f4]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [30]:</span></span>
<span class="l"><a class="anc" name="e4f5" href="#e4f5">[e4f5]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [31]:</span></span>
<span class="l"></span>
</pre><pre><a name="Area_CheckCanClimbAdjacent"></a><div class="cp">;============================================================================
; TODO: Document Area_CheckCanClimbAdjacent
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;============================================================================
</div><span class="l"><a class="anc" name="e4f6" href="#e4f6">[e4f6]</a><a href="#Area_CheckCanClimbAdjacent" class="la">Area_CheckCanClimbAdjacent:</a><span class="ce">; [$e4f6]</span></span>
<span class="l"><a class="anc" name="e4f6" href="#e4f6">[e4f6]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e4f8" href="#e4f8">[e4f8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Load the controller 1 button mask.</span></span>
<span class="l"><a class="anc" name="e4fa" href="#e4fa">[e4fa]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; If Left or Right pressed?</span></span>
<span class="l"><a class="anc" name="e4fc" href="#e4fc">[e4fc]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If not, jump to return a false result.</span></span>
<span class="l"><a class="anc" name="e4fe" href="#e4fe">[e4fe]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Keep the Right Button bit.</span></span>
<span class="l"><a class="anc" name="e500" href="#e500">[e500]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e503">@LAB_PRG15_MIRROR__e503</a></span></span></span>
<span class="l"><a class="anc" name="e502" href="#e502">[e502]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"></span>
<a name=":e503:@LAB_PRG15_MIRROR__e503"></a><span class="l"><a class="anc" name="e503" href="#e503">[e503]</a><a href="#:e503:@LAB_PRG15_MIRROR__e503" class="lla">@LAB_PRG15_MIRROR__e503:</a><span class="ce">; [$e503]</span></span>
<span class="l"><a class="anc" name="e503" href="#e503">[e503]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e505" href="#e505">[e505]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e506" href="#e506">[e506]</a><span class="cd"><span class="i">ADC</span> <span class="o">$e524,X</span></span></span>
<span class="l"><a class="anc" name="e509" href="#e509">[e509]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e50b" href="#e50b">[e50b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e50d" href="#e50d">[e50d]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e50e" href="#e50e">[e50e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="e510" href="#e510">[e510]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e512" href="#e512">[e512]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="e514" href="#e514">[e514]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span></span>
<span class="l"><a class="anc" name="e516" href="#e516">[e516]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e519" href="#e519">[e519]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e51c" href="#e51c">[e51c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e51e" href="#e51e">[e51e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e51f:@_returnFalse"></a><span class="l"><a class="anc" name="e51f" href="#e51f">[e51f]</a><a href="#:e51f:@_returnFalse" class="lla">@_returnFalse:</a><span class="ce">; [$e51f]</span></span>
<span class="l"><a class="anc" name="e51f" href="#e51f">[e51f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (false).</span></span>
<span class="l"><a class="anc" name="e521" href="#e521">[e521]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store it as the result.</span></span>
<span class="l"><a class="anc" name="e523" href="#e523">[e523]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_PRG15_MIRROR__e524"></a><div class="c">;
; XREFS:
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;
</div><span class="l"><a class="anc" name="e524" href="#e524">[e524]</a><a href="#BYTE_PRG15_MIRROR__e524" class="la">BYTE_PRG15_MIRROR__e524:</a><span class="ce">; [$e524]</span></span>
<span class="l"><a class="anc" name="e524" href="#e524">[e524]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [$e524] byte</span></span>
<span class="l"></span>
<a name="BYTE_PRG15_MIRROR__e525"></a><div class="c">;
; XREFS:
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;
</div><span class="l"><a class="anc" name="e525" href="#e525">[e525]</a><a href="#BYTE_PRG15_MIRROR__e525" class="la">BYTE_PRG15_MIRROR__e525:</a><span class="ce">; [$e525]</span></span>
<span class="l"><a class="anc" name="e525" href="#e525">[e525]</a><span class="cd"><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [$e525] byte</span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckHandleEnterDoor"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckHandleEnterDoor
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e526" href="#e526">[e526]</a><a href="#Player_CheckHandleEnterDoor" class="la">Player_CheckHandleEnterDoor:</a><span class="ce">; [$e526]</span></span>
<span class="l"><a class="anc" name="e526" href="#e526">[e526]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e528" href="#e528">[e528]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e52a" href="#e52a">[e52a]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="e52c" href="#e52c">[e52c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a></span></span><span class="ce">; Set the new state based on the other end of the door.</span></span>
<span class="l"><a class="anc" name="e52f" href="#e52f">[e52f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Check the result of that.</span></span>
<span class="l"><a class="anc" name="e531" href="#e531">[e531]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="e533" href="#e533">[e533]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span></span>
<span class="l"><a class="anc" name="e535" href="#e535">[e535]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fe</span></span></span>
<span class="l"><a class="anc" name="e537" href="#e537">[e537]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is going inside.
;
</div><span class="l"><a class="anc" name="e539" href="#e539">[e539]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_RunDoorRequirementHandler">Game_RunDoorRequirementHandler</a></span></span></span>
<span class="l"><a class="anc" name="e53c" href="#e53c">[e53c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><a class="anc" name="e53f" href="#e53f">[e53f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The door is not locked.
;
</div><span class="l"><a class="anc" name="e541" href="#e541">[e541]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span></span>
<span class="l"><a class="anc" name="e543" href="#e543">[e543]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="e545" href="#e545">[e545]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a></span></span></span>
<span class="l"><a class="anc" name="e547" href="#e547">[e547]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span></span>
<span class="l"><a class="anc" name="e54a" href="#e54a">[e54a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$06</span></span></span>
<span class="l"></span>
<a name=":e54c:@_paletteCheckLoop"></a><span class="l"><a class="anc" name="e54c" href="#e54c">[e54c]</a><a href="#:e54c:@_paletteCheckLoop" class="lla">@_paletteCheckLoop:</a><span class="ce">; [$e54c]</span></span>
<span class="l"><a class="anc" name="e54c" href="#e54c">[e54c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="e54e" href="#e54e">[e54e]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="#@_return">@_return</a>+1,X</span></span></span>
<span class="l"><a class="anc" name="e551" href="#e551">[e551]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_setupArea">@_setupArea</a></span></span></span>
<span class="l"><a class="anc" name="e553" href="#e553">[e553]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="e554" href="#e554">[e554]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_paletteCheckLoop">@_paletteCheckLoop</a></span></span></span>
<span class="l"><a class="anc" name="e556" href="#e556">[e556]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_enterScreen">@_enterScreen</a></span></span></span>
<span class="l"></span>
<a name=":e558:@_setupArea"></a><span class="l"><a class="anc" name="e558" href="#e558">[e558]</a><a href="#:e558:@_setupArea" class="lla">@_setupArea:</a><span class="ce">; [$e558]</span></span>
<span class="l"><a class="anc" name="e558" href="#e558">[e558]</a><span class="cd"><span class="i">LDA</span> <span class="o">$e570,X</span></span></span>
<span class="l"><a class="anc" name="e55b" href="#e55b">[e55b]</a><span class="cd"><span class="i">CMP</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><a class="anc" name="e55e" href="#e55e">[e55e]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_enterScreen">@_enterScreen</a></span></span></span>
<span class="l"><a class="anc" name="e560" href="#e560">[e560]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span></span>
<span class="l"><a class="anc" name="e562" href="#e562">[e562]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"></span>
<a name=":e565:@_enterScreen"></a><span class="l"><a class="anc" name="e565" href="#e565">[e565]</a><a href="#:e565:@_enterScreen" class="lla">@_enterScreen:</a><span class="ce">; [$e565]</span></span>
<span class="l"><a class="anc" name="e565" href="#e565">[e565]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a></span></span></span>
<span class="l"></span>
<a name=":e568:@_return"></a><span class="l"><a class="anc" name="e568" href="#e568">[e568]</a><a href="#:e568:@_return" class="lla">@_return:</a><span class="ce">; [$e568]</span></span>
<span class="l"><a class="anc" name="e568" href="#e568">[e568]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="cp">;============================================================================
; Mapping of palettes to accompanying music.
;
; These two tables work together, along with a loop, to
; match up palettes to the music that should play when
; switching screens.
;============================================================================
</div><span class="l"><a class="anc" name="e569" href="#e569">[e569]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e56a" href="#e56a">[e56a]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWER</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e56b" href="#e56b">[e56b]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e56c" href="#e56c">[e56c]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_SUFFER</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="e56d" href="#e56d">[e56d]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_DARTMOOR</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<a name="Palette_ARRAY_PRG15_MIRROR__e569_5_"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a class="anc" name="e56e" href="#e56e">[e56e]</a><a href="#Palette_ARRAY_PRG15_MIRROR__e569_5_" class="la">Palette_ARRAY_PRG15_MIRROR__e569_5_:</a><span class="ce">; [$e56e]</span></span>
<span class="l"><a class="anc" name="e56e" href="#e56e">[e56e]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_FRATERNAL</span></span><span class="ce">; [5]:</span></span>
<span class="l"></span>
<a name="Palette_ARRAY_PRG15_MIRROR__e569_6_"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a class="anc" name="e56f" href="#e56f">[e56f]</a><a href="#Palette_ARRAY_PRG15_MIRROR__e569_6_" class="la">Palette_ARRAY_PRG15_MIRROR__e569_6_:</a><span class="ce">; [$e56f]</span></span>
<span class="l"><a class="anc" name="e56f" href="#e56f">[e56f]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_KING_GRIEVES_ROOM</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="e570" href="#e570">[e570]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_APOLUNE</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e571" href="#e571">[e571]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e572" href="#e572">[e572]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_FOREPAW</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e573" href="#e573">[e573]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="e574" href="#e574">[e574]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_DAYBREAK</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<a name="Music_ARRAY_PRG15_MIRROR__e570_5_"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a class="anc" name="e575" href="#e575">[e575]</a><a href="#Music_ARRAY_PRG15_MIRROR__e570_5_" class="la">Music_ARRAY_PRG15_MIRROR__e570_5_:</a><span class="ce">; [$e575]</span></span>
<span class="l"><a class="anc" name="e575" href="#e575">[e575]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [5]:</span></span>
<span class="l"></span>
<a name="Music_ARRAY_PRG15_MIRROR__e570_6_"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;
</div><span class="l"><a class="anc" name="e576" href="#e576">[e576]</a><a href="#Music_ARRAY_PRG15_MIRROR__e570_6_" class="la">Music_ARRAY_PRG15_MIRROR__e570_6_:</a><span class="ce">; [$e576]</span></span>
<span class="l"><a class="anc" name="e576" href="#e576">[e576]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_MAYBE_TOWER</span></span><span class="ce">; [6]:</span></span>
<span class="l"></span>
</pre><pre><a name="Player_EnterDoorToInside"></a><div class="cp">;============================================================================
; TODO: Document Player_EnterDoorToInside
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a class="anc" name="e577" href="#e577">[e577]</a><a href="#Player_EnterDoorToInside" class="la">Player_EnterDoorToInside:</a><span class="ce">; [$e577]</span></span>
<span class="l"><a class="anc" name="e577" href="#e577">[e577]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="e579" href="#e579">[e579]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#Area_DestScreen">Area_DestScreen</a></span></span></span>
<span class="l"><a class="anc" name="e57c" href="#e57c">[e57c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="e57e" href="#e57e">[e57e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="e580" href="#e580">[e580]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e581" href="#e581">[e581]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#BUILDING_PALETTES">BUILDING_PALETTES</a>,X</span></span></span>
<span class="l"><a class="anc" name="e584" href="#e584">[e584]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="e586" href="#e586">[e586]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#BUILDING_MAYBE_TILES_INDEXES">BUILDING_MAYBE_TILES_INDEXES</a>,X</span></span></span>
<span class="l"><a class="anc" name="e589" href="#e589">[e589]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Building_TilesIndex">Building_TilesIndex</a></span></span></span>
<span class="l"><a class="anc" name="e58c" href="#e58c">[e58c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#BUILDING_START_POSITIONS">BUILDING_START_POSITIONS</a>,X</span></span></span>
<span class="l"><a class="anc" name="e58f" href="#e58f">[e58f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="e591" href="#e591">[e591]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><a class="anc" name="e594" href="#e594">[e594]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a></span></span></span>
<span class="l"><a class="anc" name="e597" href="#e597">[e597]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#BUILDING_MUSIC">BUILDING_MUSIC</a>,X</span></span></span>
<span class="l"><a class="anc" name="e59a" href="#e59a">[e59a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span></span>
<span class="l"><a class="anc" name="e59d" href="#e59d">[e59d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Where does this door take the player?
;
</div><span class="l"><a class="anc" name="e59f" href="#e59f">[e59f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="e5a1" href="#e5a1">[e5a1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e5a6">@LAB_PRG15_MIRROR__e5a6</a></span></span></span>
<span class="l"><a class="anc" name="e5a3" href="#e5a3">[e5a3]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_BeginExitBuilding">Game_BeginExitBuilding</a></span></span></span>
<span class="l"></span>
<a name=":e5a6:@LAB_PRG15_MIRROR__e5a6"></a><span class="l"><a class="anc" name="e5a6" href="#e5a6">[e5a6]</a><a href="#:e5a6:@LAB_PRG15_MIRROR__e5a6" class="lla">@LAB_PRG15_MIRROR__e5a6:</a><span class="ce">; [$e5a6]</span></span>
<span class="l"><a class="anc" name="e5a6" href="#e5a6">[e5a6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e5a8" href="#e5a8">[e5a8]</a><span class="cd"><span class="i">AND</span> <span class="o">#$bf</span></span></span>
<span class="l"><a class="anc" name="e5aa" href="#e5aa">[e5aa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e5ac" href="#e5ac">[e5ac]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span></span>
<span class="l"><a class="anc" name="e5af" href="#e5af">[e5af]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupEnterBuilding">Game_SetupEnterBuilding</a></span></span></span>
</pre><pre><a name="Player_EnterDoorToOutside"></a><div class="cp">;============================================================================
; TODO: Document Player_EnterDoorToOutside
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a class="anc" name="e5b2" href="#e5b2">[e5b2]</a><a href="#Player_EnterDoorToOutside" class="la">Player_EnterDoorToOutside:</a><span class="ce">; [$e5b2]</span></span>
<div class="c">;
; The player opened a door back to the outside.
;
</div><span class="l"><a class="anc" name="e5b2" href="#e5b2">[e5b2]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e5b3" href="#e5b3">[e5b3]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><a class="anc" name="e5b6" href="#e5b6">[e5b6]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e5b7" href="#e5b7">[e5b7]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="e5b8" href="#e5b8">[e5b8]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the door is locked.
;
</div><span class="l"><a class="anc" name="e5b9" href="#e5b9">[e5b9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DOOR_LOOKUP_REQUIREMENTS">DOOR_LOOKUP_REQUIREMENTS</a>,Y</span></span></span>
<span class="l"><a class="anc" name="e5bc" href="#e5bc">[e5bc]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><a class="anc" name="e5bf" href="#e5bf">[e5bf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_RunDoorRequirementHandler">Game_RunDoorRequirementHandler</a></span></span></span>
<span class="l"><a class="anc" name="e5c2" href="#e5c2">[e5c2]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="e5c3" href="#e5c3">[e5c3]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="e5c4" href="#e5c4">[e5c4]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><a class="anc" name="e5c7" href="#e5c7">[e5c7]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#SUB_RETURN_E5DA">SUB_RETURN_E5DA</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This door is not locked.
;
</div><span class="l"><a class="anc" name="e5c9" href="#e5c9">[e5c9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#MAYBE_REGION_TRANSITION_MAP">MAYBE_REGION_TRANSITION_MAP</a>,Y</span></span></span>
<span class="l"><a class="anc" name="e5cc" href="#e5cc">[e5cc]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Area_Region">Area_Region</a></span></span></span>
<span class="l"><a class="anc" name="e5cf" href="#e5cf">[e5cf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#MAYBE_SCREEN_TRANSITION_MAP">MAYBE_SCREEN_TRANSITION_MAP</a>,Y</span></span></span>
<span class="l"><a class="anc" name="e5d2" href="#e5d2">[e5d2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="e5d4" href="#e5d4">[e5d4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_FadeToBlack">Screen_FadeToBlack</a></span></span></span>
<span class="l"><a class="anc" name="e5d7" href="#e5d7">[e5d7]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupAndLoadOutsideArea">Game_SetupAndLoadOutsideArea</a></span></span></span>
<span class="l"></span>
<a name="SUB_RETURN_E5DA"></a><div class="c">;
; XREFS:
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a class="anc" name="e5da" href="#e5da">[e5da]</a><a href="#SUB_RETURN_E5DA" class="la">SUB_RETURN_E5DA:</a><span class="ce">; [$e5da]</span></span>
<span class="l"><a class="anc" name="e5da" href="#e5da">[e5da]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="DOOR_LOOKUP_REQUIREMENTS"></a><div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a class="anc" name="e5db" href="#e5db">[e5db]</a><a href="#DOOR_LOOKUP_REQUIREMENTS" class="la">DOOR_LOOKUP_REQUIREMENTS:</a><span class="ce">; [$e5db]</span></span>
<span class="l"><a class="anc" name="e5db" href="#e5db">[e5db]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: No key required</span></span>
<span class="l"><a class="anc" name="e5dc" href="#e5dc">[e5dc]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]: "J" key required</span></span>
<span class="l"><a class="anc" name="e5dd" href="#e5dd">[e5dd]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]: No key required</span></span>
<span class="l"><a class="anc" name="e5de" href="#e5de">[e5de]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [3]: "Q" key required</span></span>
<span class="l"><a class="anc" name="e5df" href="#e5df">[e5df]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [4]: No key required</span></span>
<span class="l"><a class="anc" name="e5e0" href="#e5e0">[e5e0]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [5]: "A" key required</span></span>
<span class="l"><a class="anc" name="e5e1" href="#e5e1">[e5e1]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [6]: No key required</span></span>
<span class="l"><a class="anc" name="e5e2" href="#e5e2">[e5e2]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [7]: Ring of Dworf required</span></span>
<span class="l"><a class="anc" name="e5e3" href="#e5e3">[e5e3]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [8]: No key required</span></span>
<span class="l"><a class="anc" name="e5e4" href="#e5e4">[e5e4]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [9]: Demon's Ring required</span></span>
<span class="l"><a class="anc" name="e5e5" href="#e5e5">[e5e5]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [10]: No key required</span></span>
<span class="l"><a class="anc" name="e5e6" href="#e5e6">[e5e6]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]: No key required</span></span>
<span class="l"></span>
<a name="MAYBE_REGION_TRANSITION_MAP"></a><div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a class="anc" name="e5e7" href="#e5e7">[e5e7]</a><a href="#MAYBE_REGION_TRANSITION_MAP" class="la">MAYBE_REGION_TRANSITION_MAP:</a><span class="ce">; [$e5e7]</span></span>
<span class="l"><a class="anc" name="e5e7" href="#e5e7">[e5e7]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e5e8" href="#e5e8">[e5e8]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_TRUNK</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e5e9" href="#e5e9">[e5e9]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_EOLIS</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e5ea" href="#e5ea">[e5ea]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="e5eb" href="#e5eb">[e5eb]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_TRUNK</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="e5ec" href="#e5ec">[e5ec]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="e5ed" href="#e5ed">[e5ed]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_MIST</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="e5ee" href="#e5ee">[e5ee]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_DARTMOOR</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="e5ef" href="#e5ef">[e5ef]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_BRANCH</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="e5f0" href="#e5f0">[e5f0]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_EVIL_FORTRESS</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="e5f1" href="#e5f1">[e5f1]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_DARTMOOR</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="e5f2" href="#e5f2">[e5f2]</a><span class="cd"><span class="i">db</span> <span class="o">REGION_EVIL_FORTRESS</span></span><span class="ce">; [11]:</span></span>
<span class="l"></span>
<a name="MAYBE_SCREEN_TRANSITION_MAP"></a><div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;
</div><span class="l"><a class="anc" name="e5f3" href="#e5f3">[e5f3]</a><a href="#MAYBE_SCREEN_TRANSITION_MAP" class="la">MAYBE_SCREEN_TRANSITION_MAP:</a><span class="ce">; [$e5f3]</span></span>
<span class="l"><a class="anc" name="e5f3" href="#e5f3">[e5f3]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e5f4" href="#e5f4">[e5f4]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="e5f5" href="#e5f5">[e5f5]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="e5f6" href="#e5f6">[e5f6]</a><span class="cd"><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="e5f7" href="#e5f7">[e5f7]</a><span class="cd"><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="e5f8" href="#e5f8">[e5f8]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="e5f9" href="#e5f9">[e5f9]</a><span class="cd"><span class="i">db</span> <span class="o">$1f</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="e5fa" href="#e5fa">[e5fa]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="e5fb" href="#e5fb">[e5fb]</a><span class="cd"><span class="i">db</span> <span class="o">$27</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="e5fc" href="#e5fc">[e5fc]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="e5fd" href="#e5fd">[e5fd]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="e5fe" href="#e5fe">[e5fe]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [11]:</span></span>
<span class="l"></span>
<a name="BUILDING_MUSIC"></a><div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a class="anc" name="e5ff" href="#e5ff">[e5ff]</a><a href="#BUILDING_MUSIC" class="la">BUILDING_MUSIC:</a><span class="ce">; [$e5ff]</span></span>
<span class="l"><a class="anc" name="e5ff" href="#e5ff">[e5ff]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_KINGS_ROOM</span></span><span class="ce">; [0]: King's Room</span></span>
<span class="l"><a class="anc" name="e600" href="#e600">[e600]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_TEMPLE</span></span><span class="ce">; [1]: Temple</span></span>
<span class="l"><a class="anc" name="e601" href="#e601">[e601]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [2]: Hospital</span></span>
<span class="l"><a class="anc" name="e602" href="#e602">[e602]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [3]: Tavern</span></span>
<span class="l"><a class="anc" name="e603" href="#e603">[e603]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [4]: Tool Shop</span></span>
<span class="l"><a class="anc" name="e604" href="#e604">[e604]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [5]: Key Shop</span></span>
<span class="l"><a class="anc" name="e605" href="#e605">[e605]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [6]: House</span></span>
<span class="l"><a class="anc" name="e606" href="#e606">[e606]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [7]: Meat Shop</span></span>
<span class="l"><a class="anc" name="e607" href="#e607">[e607]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [8]: Martial Arts</span></span>
<span class="l"><a class="anc" name="e608" href="#e608">[e608]</a><span class="cd"><span class="i">db</span> <span class="o">MUSIC_SHOP</span></span><span class="ce">; [9]: Magic Shop</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="BUILDING_PALETTES"></a><div class="cp">;============================================================================
; Mapping of building indexes to palette indexes.
;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a class="anc" name="e609" href="#e609">[e609]</a><a href="#BUILDING_PALETTES" class="la">BUILDING_PALETTES:</a><span class="ce">; [$e609]</span></span>
<span class="l"><a class="anc" name="e609" href="#e609">[e609]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_KINGS_ROOM</span></span><span class="ce">; [0]: King's Room</span></span>
<span class="l"><a class="anc" name="e60a" href="#e60a">[e60a]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TEMPLE</span></span><span class="ce">; [1]: Temple</span></span>
<span class="l"><a class="anc" name="e60b" href="#e60b">[e60b]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_HOSPITAL</span></span><span class="ce">; [2]: Hospital</span></span>
<span class="l"><a class="anc" name="e60c" href="#e60c">[e60c]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TAVERN</span></span><span class="ce">; [3]: Tavern</span></span>
<span class="l"><a class="anc" name="e60d" href="#e60d">[e60d]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOOL_SHOP</span></span><span class="ce">; [4]: Tool Shop</span></span>
<span class="l"><a class="anc" name="e60e" href="#e60e">[e60e]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_KEY_SHOP</span></span><span class="ce">; [5]: Key Shop</span></span>
<span class="l"><a class="anc" name="e60f" href="#e60f">[e60f]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_HOUSE</span></span><span class="ce">; [6]: House</span></span>
<span class="l"><a class="anc" name="e610" href="#e610">[e610]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MEAT_SHOP</span></span><span class="ce">; [7]: Meat Shop</span></span>
<span class="l"><a class="anc" name="e611" href="#e611">[e611]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MARTIAL_ARTS</span></span><span class="ce">; [8]: Martial Arts</span></span>
<span class="l"><a class="anc" name="e612" href="#e612">[e612]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MAGIC_SHOP</span></span><span class="ce">; [9]: Magic Shop</span></span>
<span class="l"></span>
<a name="BUILDING_MAYBE_TILES_INDEXES"></a><div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a class="anc" name="e613" href="#e613">[e613]</a><a href="#BUILDING_MAYBE_TILES_INDEXES" class="la">BUILDING_MAYBE_TILES_INDEXES:</a><span class="ce">; [$e613]</span></span>
<span class="l"><a class="anc" name="e613" href="#e613">[e613]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [0]: King's Room</span></span>
<span class="l"><a class="anc" name="e614" href="#e614">[e614]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [1]: Temple</span></span>
<span class="l"><a class="anc" name="e615" href="#e615">[e615]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]: Hospital</span></span>
<span class="l"><a class="anc" name="e616" href="#e616">[e616]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [3]: Tavern</span></span>
<span class="l"><a class="anc" name="e617" href="#e617">[e617]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [4]: Tool Shop</span></span>
<span class="l"><a class="anc" name="e618" href="#e618">[e618]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [5]: Key Shop</span></span>
<span class="l"><a class="anc" name="e619" href="#e619">[e619]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [6]: House</span></span>
<span class="l"><a class="anc" name="e61a" href="#e61a">[e61a]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [7]: Meat Shop</span></span>
<span class="l"><a class="anc" name="e61b" href="#e61b">[e61b]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [8]: Martial Arts</span></span>
<span class="l"><a class="anc" name="e61c" href="#e61c">[e61c]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [9]: Magic Shop</span></span>
<span class="l"></span>
<a name="BUILDING_START_POSITIONS"></a><div class="c">;
; XREFS:
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;
</div><span class="l"><a class="anc" name="e61d" href="#e61d">[e61d]</a><a href="#BUILDING_START_POSITIONS" class="la">BUILDING_START_POSITIONS:</a><span class="ce">; [$e61d]</span></span>
<span class="l"><a class="anc" name="e61d" href="#e61d">[e61d]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">; [0]: King's Room</span></span>
<span class="l"><a class="anc" name="e61e" href="#e61e">[e61e]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">; [1]: Temple</span></span>
<span class="l"><a class="anc" name="e61f" href="#e61f">[e61f]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">; [2]: Hospital</span></span>
<span class="l"><a class="anc" name="e620" href="#e620">[e620]</a><span class="cd"><span class="i">db</span> <span class="o">$8e</span></span><span class="ce">; [3]: Tavern</span></span>
<span class="l"><a class="anc" name="e621" href="#e621">[e621]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [4]: Tool Shop</span></span>
<span class="l"><a class="anc" name="e622" href="#e622">[e622]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [5]: Key Shop</span></span>
<span class="l"><a class="anc" name="e623" href="#e623">[e623]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [6]: House</span></span>
<span class="l"><a class="anc" name="e624" href="#e624">[e624]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">; [7]: Meat Shop</span></span>
<span class="l"><a class="anc" name="e625" href="#e625">[e625]</a><span class="cd"><span class="i">db</span> <span class="o">$8e</span></span><span class="ce">; [8]: Martial Arts</span></span>
<span class="l"><a class="anc" name="e626" href="#e626">[e626]</a><span class="cd"><span class="i">db</span> <span class="o">$8e</span></span><span class="ce">; [9]: Magic Shop</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Screen_IsEdge"></a><div class="cp">;============================================================================
; Return whether the screen is the edge in a given direction.
;
; INPUTS:
;     Y:
;         The direction to check relative to the screen.
;
;         0 = Screen left
;         1 = Screen right
;         2 = Screen above
;         3 = Screen below
;
; OUTPUTS:
;     C:
;         1 if this screen is the edge.
;         0 if it has a neighboring screen.
;
; XREFS:
;     <a href="#Area_ScrollScreenDown">Area_ScrollScreenDown</a>
;     <a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a>
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="e627" href="#e627">[e627]</a><a href="#Screen_IsEdge" class="la">Screen_IsEdge:</a><span class="ce">; [$e627]</span></span>
<span class="l"><a class="anc" name="e627" href="#e627">[e627]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_ScreenToTheLeft">Area_ScreenToTheLeft</a>,Y</span></span><span class="ce">; Load the screen ID at the given neighbor.</span></span>
<span class="l"><a class="anc" name="e62a" href="#e62a">[e62a]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; If 0xFF, C = 1. Else, C = 0</span></span>
<span class="l"><a class="anc" name="e62c" href="#e62c">[e62c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_CanMoveUp"></a><div class="cp">;============================================================================
; TODO: Document Area_CanMoveUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_CanPlayerMoveRight">Area_CanPlayerMoveRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="e62d" href="#e62d">[e62d]</a><a href="#Area_CanMoveUp" class="la">Area_CanMoveUp:</a><span class="ce">; [$e62d]</span></span>
<span class="l"><a class="anc" name="e62d" href="#e62d">[e62d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e62f" href="#e62f">[e62f]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e630" href="#e630">[e630]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e631" href="#e631">[e631]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e632" href="#e632">[e632]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e633" href="#e633">[e633]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e634" href="#e634">[e634]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e637" href="#e637">[e637]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e63a" href="#e63a">[e63a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e63c" href="#e63c">[e63c]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e63d" href="#e63d">[e63d]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e640" href="#e640">[e640]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e643" href="#e643">[e643]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e645" href="#e645">[e645]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e647" href="#e647">[e647]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e649" href="#e649">[e649]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e64b" href="#e64b">[e64b]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e658">@LAB_PRG15_MIRROR__e658</a></span></span></span>
<span class="l"><a class="anc" name="e64d" href="#e64d">[e64d]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e64e" href="#e64e">[e64e]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstColumnInRightScreen">FirstColumnInRightScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e651" href="#e651">[e651]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e654" href="#e654">[e654]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e656" href="#e656">[e656]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<a name=":e658:@LAB_PRG15_MIRROR__e658"></a><span class="l"><a class="anc" name="e658" href="#e658">[e658]</a><a href="#:e658:@LAB_PRG15_MIRROR__e658" class="lla">@LAB_PRG15_MIRROR__e658:</a><span class="ce">; [$e658]</span></span>
<span class="l"><a class="anc" name="e658" href="#e658">[e658]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e65a" href="#e65a">[e65a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_CanPlayerMoveRight"></a><div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveRight
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;============================================================================
</div><span class="l"><a class="anc" name="e65b" href="#e65b">[e65b]</a><a href="#Area_CanPlayerMoveRight" class="la">Area_CanPlayerMoveRight:</a><span class="ce">; [$e65b]</span></span>
<span class="l"><a class="anc" name="e65b" href="#e65b">[e65b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e65d" href="#e65d">[e65d]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e65e" href="#e65e">[e65e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="e660" href="#e660">[e660]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e662" href="#e662">[e662]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Area_CanMoveUp">Area_CanMoveUp</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
</pre><pre><a name="Area_CanPlayerMoveAtY"></a><div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveAtY
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_CanPlayerMoveLeft">Area_CanPlayerMoveLeft</a>
;============================================================================
</div><span class="l"><a class="anc" name="e664" href="#e664">[e664]</a><a href="#Area_CanPlayerMoveAtY" class="la">Area_CanPlayerMoveAtY:</a><span class="ce">; [$e664]</span></span>
<span class="l"><a class="anc" name="e664" href="#e664">[e664]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e666" href="#e666">[e666]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e668" href="#e668">[e668]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e66b" href="#e66b">[e66b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e66e" href="#e66e">[e66e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e670" href="#e670">[e670]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="e671" href="#e671">[e671]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e672" href="#e672">[e672]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="e674" href="#e674">[e674]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e675" href="#e675">[e675]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e678" href="#e678">[e678]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e67a" href="#e67a">[e67a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e67c" href="#e67c">[e67c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e67e" href="#e67e">[e67e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e680" href="#e680">[e680]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><a class="anc" name="e682" href="#e682">[e682]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="e683" href="#e683">[e683]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e684" href="#e684">[e684]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="e686" href="#e686">[e686]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e687" href="#e687">[e687]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e68a" href="#e68a">[e68a]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e68c" href="#e68c">[e68c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<a name=":e68e:@_returnResult"></a><span class="l"><a class="anc" name="e68e" href="#e68e">[e68e]</a><a href="#:e68e:@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e68e]</span></span>
<span class="l"><a class="anc" name="e68e" href="#e68e">[e68e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e690" href="#e690">[e690]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_CanPlayerMoveLeft"></a><div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveLeft
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;============================================================================
</div><span class="l"><a class="anc" name="e691" href="#e691">[e691]</a><a href="#Area_CanPlayerMoveLeft" class="la">Area_CanPlayerMoveLeft:</a><span class="ce">; [$e691]</span></span>
<span class="l"><a class="anc" name="e691" href="#e691">[e691]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e693" href="#e693">[e693]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e694" href="#e694">[e694]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e696" href="#e696">[e696]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e698" href="#e698">[e698]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#Area_CanPlayerMoveAtY">Area_CanPlayerMoveAtY</a></span></span></span>
<span class="l"><a class="anc" name="e69a" href="#e69a">[e69a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e69c" href="#e69c">[e69c]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e69d" href="#e69d">[e69d]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e69e" href="#e69e">[e69e]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e69f" href="#e69f">[e69f]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e6a0" href="#e6a0">[e6a0]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e6a1" href="#e6a1">[e6a1]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e6a4" href="#e6a4">[e6a4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e6a7" href="#e6a7">[e6a7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6a9" href="#e6a9">[e6a9]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e6aa" href="#e6aa">[e6aa]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e6ad" href="#e6ad">[e6ad]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e6b0" href="#e6b0">[e6b0]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6b2" href="#e6b2">[e6b2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6b4" href="#e6b4">[e6b4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e6b6" href="#e6b6">[e6b6]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e6b8" href="#e6b8">[e6b8]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e6c5">@LAB_PRG15_MIRROR__e6c5</a></span></span></span>
<span class="l"><a class="anc" name="e6ba" href="#e6ba">[e6ba]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e6bb" href="#e6bb">[e6bb]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastColumnLeftScreen">LastColumnLeftScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e6be" href="#e6be">[e6be]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e6c1" href="#e6c1">[e6c1]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6c3" href="#e6c3">[e6c3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<a name=":e6c5:@LAB_PRG15_MIRROR__e6c5"></a><span class="l"><a class="anc" name="e6c5" href="#e6c5">[e6c5]</a><a href="#:e6c5:@LAB_PRG15_MIRROR__e6c5" class="lla">@LAB_PRG15_MIRROR__e6c5:</a><span class="ce">; [$e6c5]</span></span>
<span class="l"><a class="anc" name="e6c5" href="#e6c5">[e6c5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6c7" href="#e6c7">[e6c7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckIfPassable"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckIfPassable
;
; INPUTS:
;     X
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Area_ScrollScreenDown">Area_ScrollScreenDown</a>
;     <a href="#Player_CheckHandleClimbDown">Player_CheckHandleClimbDown</a>
;     <a href="#Player_CheckHandleClimbMaybeSide">Player_CheckHandleClimbMaybeSide</a>
;     <a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a>
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="e6c8" href="#e6c8">[e6c8]</a><a href="#Player_CheckIfPassable" class="la">Player_CheckIfPassable:</a><span class="ce">; [$e6c8]</span></span>
<span class="l"><a class="anc" name="e6c8" href="#e6c8">[e6c8]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="e6c9" href="#e6c9">[e6c9]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Area_CanPlayerMoveLeft">Area_CanPlayerMoveLeft</a></span></span></span>
<span class="l"><a class="anc" name="e6cb" href="#e6cb">[e6cb]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="e6cc" href="#e6cc">[e6cc]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Area_CanPlayerMoveRight">Area_CanPlayerMoveRight</a></span></span></span>
<span class="l"><a class="anc" name="e6ce" href="#e6ce">[e6ce]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="e6cf" href="#e6cf">[e6cf]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Area_CanPlayerMoveUp">Area_CanPlayerMoveUp</a></span></span></span>
<span class="l"><a class="anc" name="e6d1" href="#e6d1">[e6d1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e6d3" href="#e6d3">[e6d3]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e6d4" href="#e6d4">[e6d4]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="e6d6" href="#e6d6">[e6d6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e6d8" href="#e6d8">[e6d8]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$d0</span></span></span>
<span class="l"><a class="anc" name="e6da" href="#e6da">[e6da]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a></span></span></span>
<span class="l"><a class="anc" name="e6dc" href="#e6dc">[e6dc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e6de" href="#e6de">[e6de]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e6df" href="#e6df">[e6df]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e6e0" href="#e6e0">[e6e0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e6e1" href="#e6e1">[e6e1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e6e2" href="#e6e2">[e6e2]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e6e3" href="#e6e3">[e6e3]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstRowBelowScreen">FirstRowBelowScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e6e6" href="#e6e6">[e6e6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e6e9" href="#e6e9">[e6e9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6eb" href="#e6eb">[e6eb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e6ed" href="#e6ed">[e6ed]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e6ef" href="#e6ef">[e6ef]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><a class="anc" name="e6f1" href="#e6f1">[e6f1]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e6f2" href="#e6f2">[e6f2]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#FirstRowBelowScreen">FirstRowBelowScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e6f5" href="#e6f5">[e6f5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e6f8" href="#e6f8">[e6f8]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6fa" href="#e6fa">[e6fa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<a name=":e6fc:@_returnResult"></a><span class="l"><a class="anc" name="e6fc" href="#e6fc">[e6fc]</a><a href="#:e6fc:@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e6fc]</span></span>
<span class="l"><a class="anc" name="e6fc" href="#e6fc">[e6fc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e6fe" href="#e6fe">[e6fe]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_CanMoveImmediatelyRight"></a><div class="cp">;============================================================================
; TODO: Document Area_CanMoveImmediatelyRight
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Area_CanPlayerMoveUp">Area_CanPlayerMoveUp</a>
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;============================================================================
</div><span class="l"><a class="anc" name="e6ff" href="#e6ff">[e6ff]</a><a href="#Area_CanMoveImmediatelyRight" class="la">Area_CanMoveImmediatelyRight:</a><span class="ce">; [$e6ff]</span></span>
<span class="l"><a class="anc" name="e6ff" href="#e6ff">[e6ff]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e701" href="#e701">[e701]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e702" href="#e702">[e702]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="e704" href="#e704">[e704]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e706" href="#e706">[e706]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e709" href="#e709">[e709]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e70c" href="#e70c">[e70c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e70e" href="#e70e">[e70e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e710" href="#e710">[e710]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e712" href="#e712">[e712]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e713" href="#e713">[e713]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="e715" href="#e715">[e715]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e717" href="#e717">[e717]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><a class="anc" name="e719" href="#e719">[e719]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e71a" href="#e71a">[e71a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_IsBlockImpassable">ScreenBuffer_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e71d" href="#e71d">[e71d]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e71f" href="#e71f">[e71f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<a name=":e721:@_returnResult"></a><span class="l"><a class="anc" name="e721" href="#e721">[e721]</a><a href="#:e721:@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e721]</span></span>
<span class="l"><a class="anc" name="e721" href="#e721">[e721]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e723" href="#e723">[e723]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Area_CanPlayerMoveUp"></a><div class="cp">;============================================================================
; TODO: Document Area_CanPlayerMoveUp
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     Z
;
; XREFS:
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;============================================================================
</div><span class="l"><a class="anc" name="e724" href="#e724">[e724]</a><a href="#Area_CanPlayerMoveUp" class="la">Area_CanPlayerMoveUp:</a><span class="ce">; [$e724]</span></span>
<span class="l"><a class="anc" name="e724" href="#e724">[e724]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e726" href="#e726">[e726]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e727" href="#e727">[e727]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e729" href="#e729">[e729]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e72b" href="#e72b">[e72b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="e72d" href="#e72d">[e72d]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a></span></span></span>
<span class="l"><a class="anc" name="e72f" href="#e72f">[e72f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e731" href="#e731">[e731]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e732" href="#e732">[e732]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e733" href="#e733">[e733]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e734" href="#e734">[e734]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e735" href="#e735">[e735]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e736" href="#e736">[e736]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastRowAboveScreen">LastRowAboveScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e739" href="#e739">[e739]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e73c" href="#e73c">[e73c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e73e" href="#e73e">[e73e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e740" href="#e740">[e740]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e742" href="#e742">[e742]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnResult">@_returnResult</a></span></span></span>
<span class="l"><a class="anc" name="e744" href="#e744">[e744]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e745" href="#e745">[e745]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#LastRowAboveScreen">LastRowAboveScreen</a>,X</span></span></span>
<span class="l"><a class="anc" name="e748" href="#e748">[e748]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a></span></span></span>
<span class="l"><a class="anc" name="e74b" href="#e74b">[e74b]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e74d" href="#e74d">[e74d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<a name=":e74f:@_returnResult"></a><span class="l"><a class="anc" name="e74f" href="#e74f">[e74f]</a><a href="#:e74f:@_returnResult" class="lla">@_returnResult:</a><span class="ce">; [$e74f]</span></span>
<span class="l"><a class="anc" name="e74f" href="#e74f">[e74f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e751" href="#e751">[e751]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Player_CheckIfOnLadder"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckIfOnLadder
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckHandleClimb">Player_CheckHandleClimb</a>
;============================================================================
</div><span class="l"><a class="anc" name="e752" href="#e752">[e752]</a><a href="#Player_CheckIfOnLadder" class="la">Player_CheckIfOnLadder:</a><span class="ce">; [$e752]</span></span>
<div class="c">;
; Build the target block pixel position to look up.
;
; This will offset the X by +7, which helps grab onto the block
; if just to the left of it.
;
</div><span class="l"><a class="anc" name="e752" href="#e752">[e752]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; A = player X position</span></span>
<span class="l"><a class="anc" name="e754" href="#e754">[e754]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e755" href="#e755">[e755]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$07</span></span><span class="ce">; Add 7.</span></span>
<span class="l"><a class="anc" name="e757" href="#e757">[e757]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store the player's new X pixel position</span></span>
<span class="l"><a class="anc" name="e759" href="#e759">[e759]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span><span class="ce">; Load the player's Y position</span></span>
<span class="l"><a class="anc" name="e75b" href="#e75b">[e75b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store the player's Y pixel position</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the block at this position is climbable.
;
</div><span class="l"><a class="anc" name="e75d" href="#e75d">[e75d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert to a block position.</span></span>
<span class="l"><a class="anc" name="e760" href="#e760">[e760]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block at that position.</span></span>
<span class="l"><a class="anc" name="e763" href="#e763">[e763]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property for that block.</span></span>
<span class="l"><a class="anc" name="e766" href="#e766">[e766]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e768" href="#e768">[e768]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span><span class="ce">; Check if it's climbable.</span></span>
<span class="l"><a class="anc" name="e76b" href="#e76b">[e76b]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The block is not climbable. Check if the player is
; overlapping a block to the right, and check that.
;
</div><span class="l"><a class="anc" name="e76d" href="#e76d">[e76d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; A = player X position.</span></span>
<span class="l"><a class="anc" name="e76f" href="#e76f">[e76f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e771" href="#e771">[e771]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e773" href="#e773">[e773]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkBlockBelow">@_checkBlockBelow</a></span></span></span>
<span class="l"><a class="anc" name="e775" href="#e775">[e775]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e776" href="#e776">[e776]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="e779" href="#e779">[e779]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><a class="anc" name="e77c" href="#e77c">[e77c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e77e" href="#e77e">[e77e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span></span>
<span class="l"><a class="anc" name="e781" href="#e781">[e781]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"></span>
<a name=":e783:@_checkBlockBelow"></a><span class="l"><a class="anc" name="e783" href="#e783">[e783]</a><a href="#:e783:@_checkBlockBelow" class="lla">@_checkBlockBelow:</a><span class="ce">; [$e783]</span></span>
<span class="l"><a class="anc" name="e783" href="#e783">[e783]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e785" href="#e785">[e785]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e786" href="#e786">[e786]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="e788" href="#e788">[e788]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e78a" href="#e78a">[e78a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e78c" href="#e78c">[e78c]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e78d" href="#e78d">[e78d]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$1f</span></span></span>
<span class="l"><a class="anc" name="e78f" href="#e78f">[e78f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e791" href="#e791">[e791]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e794" href="#e794">[e794]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="e797" href="#e797">[e797]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><a class="anc" name="e79a" href="#e79a">[e79a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"><a class="anc" name="e79c" href="#e79c">[e79c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span></span>
<span class="l"><a class="anc" name="e79f" href="#e79f">[e79f]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"><a class="anc" name="e7a1" href="#e7a1">[e7a1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e7a3" href="#e7a3">[e7a3]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e7a5" href="#e7a5">[e7a5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="e7a7" href="#e7a7">[e7a7]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_resetCanClimb">@_resetCanClimb</a></span></span></span>
<span class="l"><a class="anc" name="e7a9" href="#e7a9">[e7a9]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="e7aa" href="#e7aa">[e7aa]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="e7ad" href="#e7ad">[e7ad]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><a class="anc" name="e7b0" href="#e7b0">[e7b0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e7b2:@_resetCanClimb"></a><div class="c">;
; Reset the can-climb bit.
;
</div><span class="l"><a class="anc" name="e7b2" href="#e7b2">[e7b2]</a><a href="#:e7b2:@_resetCanClimb" class="lla">@_resetCanClimb:</a><span class="ce">; [$e7b2]</span></span>
<span class="l"><a class="anc" name="e7b2" href="#e7b2">[e7b2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e7b4" href="#e7b4">[e7b4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f7</span></span><span class="ce">; Clear the can-climb bit.</span></span>
<span class="l"><a class="anc" name="e7b6" href="#e7b6">[e7b6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_IsBlockClimbable">Area_IsBlockClimbable</a></span></span><span class="ce">; Is the current block climbable?</span></span>
<span class="l"><a class="anc" name="e7b9" href="#e7b9">[e7b9]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_clearBit5AndReturn">@_clearBit5AndReturn</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the can-climb bit.
;
</div><span class="l"><a class="anc" name="e7bb" href="#e7bb">[e7bb]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; Else, set the can-climbable bit.</span></span>
<span class="l"><a class="anc" name="e7bd" href="#e7bd">[e7bd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Set the ladder flag bit</span></span>
<span class="l"><a class="anc" name="e7bf" href="#e7bf">[e7bf]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e7c0:@_clearBit5AndReturn"></a><span class="l"><a class="anc" name="e7c0" href="#e7c0">[e7c0]</a><a href="#:e7c0:@_clearBit5AndReturn" class="lla">@_clearBit5AndReturn:</a><span class="ce">; [$e7c0]</span></span>
<span class="l"><a class="anc" name="e7c0" href="#e7c0">[e7c0]</a><span class="cd"><span class="i">AND</span> <span class="o">#$ef</span></span><span class="ce">; Clear bit 5.</span></span>
<span class="l"><a class="anc" name="e7c2" href="#e7c2">[e7c2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e7c4" href="#e7c4">[e7c4]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_SetStateFromDoorDestination"></a><div class="cp">;============================================================================
; Set state from the area at the other end of the door.
;
; This checks if the player is in front of a door (being
; careful to check any overlapping blocks) and then looks up
; the area at the other end of the door.
;
; If a matching door is found (one that maps to the current
; screen and block position), then a new screen index, start
; position, palette, and door key requirement for the
; current screen will be set. This prepares for switching to
; the new area.
;
; INPUTS:
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The X position of the player.
;
;     <a href="RAM.html#Player_PosY">Player_PosY</a>:
;         The Y position of the player.
;
; OUTPUTS:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         1 if a door could be entered.
;         0 if one could not.
;
;     <a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>:
;         The start position when switching to the new area.
;
;     <a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a>:
;         The new screen when switching to the new area.
;
;     <a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a>:
;         The new palette when switching to the new area.
;
;     <a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a>:
;         The key requirement for the matching doro when
;         switching to the new area.
;
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a>
;         Clobbered.
;
; CALLS:
;     <a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a>
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;============================================================================
</div><span class="l"><a class="anc" name="e7c5" href="#e7c5">[e7c5]</a><a href="#Area_SetStateFromDoorDestination" class="la">Area_SetStateFromDoorDestination:</a><span class="ce">; [$e7c5]</span></span>
<div class="c">;
; Convert the player position to a normalized block position.
;
</div><span class="l"><a class="anc" name="e7c5" href="#e7c5">[e7c5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player's full X position.</span></span>
<span class="l"><a class="anc" name="e7c7" href="#e7c7">[e7c7]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e7c8" href="#e7c8">[e7c8]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$07</span></span><span class="ce">; Add 7.</span></span>
<span class="l"><a class="anc" name="e7ca" href="#e7ca">[e7ca]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the X pixel position argument.</span></span>
<span class="l"><a class="anc" name="e7cc" href="#e7cc">[e7cc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span><span class="ce">; Load the player's full Y position.</span></span>
<span class="l"><a class="anc" name="e7ce" href="#e7ce">[e7ce]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store as the Y pixel position argument.</span></span>
<span class="l"><a class="anc" name="e7d0" href="#e7d0">[e7d0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Conver to block positions.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the block at this position from the screen and
; check what it is.
;
</div><span class="l"><a class="anc" name="e7d3" href="#e7d3">[e7d3]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block from the screen buffer.</span></span>
<span class="l"><a class="anc" name="e7d6" href="#e7d6">[e7d6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Get the block property.</span></span>
<span class="l"><a class="anc" name="e7d9" href="#e7d9">[e7d9]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Is it a door?</span></span>
<span class="l"><a class="anc" name="e7db" href="#e7db">[e7db]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsDoor">@_blockIsDoor</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; It's not a door. The player may still be near a door.
; Let's round to the nearest block to the right and check
; again.
;
</div><span class="l"><a class="anc" name="e7dd" href="#e7dd">[e7dd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player's full X position.</span></span>
<span class="l"><a class="anc" name="e7df" href="#e7df">[e7df]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Check the lower nibble.</span></span>
<span class="l"><a class="anc" name="e7e1" href="#e7e1">[e7e1]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is it on a full block boundary?</span></span>
<span class="l"><a class="anc" name="e7e3" href="#e7e3">[e7e3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_blockIsNotDoor">@_blockIsNotDoor</a></span></span><span class="ce">; _blockIsAir</span></span>
<span class="l"><a class="anc" name="e7e5" href="#e7e5">[e7e5]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Increment the block position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We normalized to the next overlapped block. Now check
; to see if it's a door.
;
</div><span class="l"><a class="anc" name="e7e6" href="#e7e6">[e7e6]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block at that position.</span></span>
<span class="l"><a class="anc" name="e7e9" href="#e7e9">[e7e9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"><a class="anc" name="e7ec" href="#e7ec">[e7ec]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Is it a door?</span></span>
<span class="l"><a class="anc" name="e7ee" href="#e7ee">[e7ee]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsDoor">@_blockIsDoor</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e7f0:@_blockIsNotDoor"></a><div class="c">;
; The player was not standing in front of a door.
; Consider this block passable.
;
</div><span class="l"><a class="anc" name="e7f0" href="#e7f0">[e7f0]</a><a href="#:e7f0:@_blockIsNotDoor" class="lla">@_blockIsNotDoor:</a><span class="ce">; [$e7f0]</span></span>
<span class="l"><a class="anc" name="e7f0" href="#e7f0">[e7f0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e7f2" href="#e7f2">[e7f2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set the resulting block property as air.</span></span>
<span class="l"><a class="anc" name="e7f4" href="#e7f4">[e7f4]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e7f5:@_blockIsDoor"></a><div class="c">;
; The player is standing in front of a door.
;
; Check to see where they are.
;
</div><span class="l"><a class="anc" name="e7f5" href="#e7f5">[e7f5]</a><a href="#:e7f5:@_blockIsDoor" class="lla">@_blockIsDoor:</a><span class="ce">; [$e7f5]</span></span>
<span class="l"><a class="anc" name="e7f5" href="#e7f5">[e7f5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Load the current region.</span></span>
<span class="l"><a class="anc" name="e7f7" href="#e7f7">[e7f7]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this the area around Victim(?) ?</span></span>
<span class="l"><a class="anc" name="e7f9" href="#e7f9">[e7f9]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e7fe">@LAB_PRG15_MIRROR__e7fe</a></span></span><span class="ce">; If not, jump and continue on.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We won't be handling anything in this area. We're done here.
;
</div><span class="l"><a class="anc" name="e7fb" href="#e7fb">[e7fb]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#SUB_RETURN_E5DA">SUB_RETURN_E5DA</a></span></span><span class="ce">; Else, we're done.</span></span>
<span class="l"></span>
<a name=":e7fe:@LAB_PRG15_MIRROR__e7fe"></a><span class="l"><a class="anc" name="e7fe" href="#e7fe">[e7fe]</a><a href="#:e7fe:@LAB_PRG15_MIRROR__e7fe" class="lla">@LAB_PRG15_MIRROR__e7fe:</a><span class="ce">; [$e7fe]</span></span>
<span class="l"><a class="anc" name="e7fe" href="#e7fe">[e7fe]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e800" href="#e800">[e800]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Mark the resulting block as solid by default.</span></span>
<span class="l"><a class="anc" name="e802" href="#e802">[e802]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_BlockPos">Temp_BlockPos</a></span></span><span class="ce">; Store our block X position temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Get the location of the doors for this area and store
; the address for access below.
;
</div><span class="l"><a class="anc" name="e804" href="#e804">[e804]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr">CurrentArea_DoorLocationsAddr</a></span></span><span class="ce">; Load the lower byte of the doors address.</span></span>
<span class="l"><a class="anc" name="e806" href="#e806">[e806]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"><a class="anc" name="e808" href="#e808">[e808]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_DoorLocationsAddr_U">CurrentArea_DoorLocationsAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="e80a" href="#e80a">[e80a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to Bank 3 (level data).
;
</div><span class="l"><a class="anc" name="e80c" href="#e80c">[e80c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="e80f" href="#e80f">[e80f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="e810" href="#e810">[e810]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e812" href="#e812">[e812]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Load bank 3.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e815:@_doorCheckLoop"></a><div class="c">;
; Check the byte stored in address stored starting at
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> to see if it's an air block or the screen
; index.
;
</div><span class="l"><a class="anc" name="e815" href="#e815">[e815]</a><a href="#:e815:@_doorCheckLoop" class="lla">@_doorCheckLoop:</a><span class="ce">; [$e815]</span></span>
<span class="l"><a class="anc" name="e815" href="#e815">[e815]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"><a class="anc" name="e817" href="#e817">[e817]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the first byte from the referenced address.</span></span>
<span class="l"><a class="anc" name="e819" href="#e819">[e819]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="e81b" href="#e81b">[e81b]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnAirBlock">@_returnAirBlock</a></span></span><span class="ce">; If so, consider this air and return.</span></span>
<span class="l"><a class="anc" name="e81d" href="#e81d">[e81d]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span><span class="ce">; Is it the current screen index?</span></span>
<span class="l"><a class="anc" name="e81f" href="#e81f">[e81f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e852">@LAB_PRG15_MIRROR__e852</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; That was a match.
;
; Next, check the next byte in the address referenced by
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> to see if it's the stored block position
; from above (<a href="RAM.html#Temp_BlockPos">Temp_BlockPos</a>).
;
</div><span class="l"><a class="anc" name="e821" href="#e821">[e821]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="e822" href="#e822">[e822]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the next byte from the referenced address.</span></span>
<span class="l"><a class="anc" name="e824" href="#e824">[e824]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_BlockPos">Temp_BlockPos</a></span></span><span class="ce">; Is it the block position we stored?</span></span>
<span class="l"><a class="anc" name="e826" href="#e826">[e826]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e852">@LAB_PRG15_MIRROR__e852</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; That was a match too.
;
; Load the next byte referenced in <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> and store
; that
; as a block position in <a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a>.
;
</div><span class="l"><a class="anc" name="e828" href="#e828">[e828]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="e829" href="#e829">[e829]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the next byte from the referenced address.</span></span>
<span class="l"><a class="anc" name="e82b" href="#e82b">[e82b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span><span class="ce">; Store that byte as a temporary block position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the next byte from the address referenced in
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a> and store as the area's start X/Y
; location (<a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a>).
;
</div><span class="l"><a class="anc" name="e82d" href="#e82d">[e82d]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="e82e" href="#e82e">[e82e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the next byte from the referenced address.</span></span>
<span class="l"><a class="anc" name="e830" href="#e830">[e830]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span><span class="ce">; Store as the area's starting X/Y position.</span></span>
<span class="l"><a class="anc" name="e832" href="#e832">[e832]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_BlockPos2">Temp_BlockPos2</a></span></span><span class="ce">; A = Byte we had just stored up above.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check the current area. If it's around Mascon somewhere,
; we'll need to reduce the value by 32.
;
; TODO: Check why this is.
;
</div><span class="l"><a class="anc" name="e834" href="#e834">[e834]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Y = current area</span></span>
<span class="l"><a class="anc" name="e836" href="#e836">[e836]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$03</span></span><span class="ce">; Is the current area 3?</span></span>
<span class="l"><a class="anc" name="e838" href="#e838">[e838]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e83d">@LAB_PRG15_MIRROR__e83d</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We'll need to normalize the block position.
;
</div><span class="l"><a class="anc" name="e83a" href="#e83a">[e83a]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="e83b" href="#e83b">[e83b]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$20</span></span><span class="ce">; Reduce it by 32.</span></span>
<span class="l"></span>
<a name=":e83d:@LAB_PRG15_MIRROR__e83d"></a><span class="l"><a class="anc" name="e83d" href="#e83d">[e83d]</a><a href="#:e83d:@LAB_PRG15_MIRROR__e83d" class="lla">@LAB_PRG15_MIRROR__e83d:</a><span class="ce">; [$e83d]</span></span>
<span class="l"><a class="anc" name="e83d" href="#e83d">[e83d]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply the block position by 4.</span></span>
<span class="l"><a class="anc" name="e83e" href="#e83e">[e83e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load state from the door destination at this block.
;
; We'll load the screen index, palette, and the key
; requirement.
;
</div><span class="l"><a class="anc" name="e83f" href="#e83f">[e83f]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (block position)</span></span>
<span class="l"><a class="anc" name="e840" href="#e840">[e840]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a>),Y</span></span><span class="ce">; Load the screen index from the door destination.</span></span>
<span class="l"><a class="anc" name="e842" href="#e842">[e842]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span><span class="ce">; Store it as the new screen index.</span></span>
<span class="l"><a class="anc" name="e844" href="#e844">[e844]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="e845" href="#e845">[e845]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a>),Y</span></span><span class="ce">; Load the palette from the door destination.</span></span>
<span class="l"><a class="anc" name="e847" href="#e847">[e847]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span><span class="ce">; Store it as the new palette.</span></span>
<span class="l"><a class="anc" name="e849" href="#e849">[e849]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="e84a" href="#e84a">[e84a]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_DoorDestinationsAddr">CurrentArea_DoorDestinationsAddr</a>),Y</span></span><span class="ce">; Load the key requirement.</span></span>
<span class="l"><a class="anc" name="e84c" href="#e84c">[e84c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e84f" href="#e84f">[e84f]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_restoreBankAndReturn">@_restoreBankAndReturn</a></span></span><span class="ce">; We're done. Restore our bank and set our results.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e852:@LAB_PRG15_MIRROR__e852"></a><div class="c">;
; Skip the 4 bytes of information of the area at the other end
; of the door destination. We'll set up to process the next one.
;
</div><span class="l"><a class="anc" name="e852" href="#e852">[e852]</a><a href="#:e852:@LAB_PRG15_MIRROR__e852" class="lla">@LAB_PRG15_MIRROR__e852:</a><span class="ce">; [$e852]</span></span>
<span class="l"><a class="anc" name="e852" href="#e852">[e852]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Load the lower byte of the door destination address we stored.</span></span>
<span class="l"><a class="anc" name="e854" href="#e854">[e854]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e855" href="#e855">[e855]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Add 4 (skip the information found on the other side of that door).</span></span>
<span class="l"><a class="anc" name="e857" href="#e857">[e857]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it back out.</span></span>
<span class="l"><a class="anc" name="e859" href="#e859">[e859]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Load the upper byte of the address.</span></span>
<span class="l"><a class="anc" name="e85b" href="#e85b">[e85b]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry flag, if the lower byte overflowed.</span></span>
<span class="l"><a class="anc" name="e85d" href="#e85d">[e85d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="e85f" href="#e85f">[e85f]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_doorCheckLoop">@_doorCheckLoop</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e862:@_returnAirBlock"></a><div class="c">;
; Consider this air.
;
</div><span class="l"><a class="anc" name="e862" href="#e862">[e862]</a><a href="#:e862:@_returnAirBlock" class="lla">@_returnAirBlock:</a><span class="ce">; [$e862]</span></span>
<span class="l"><a class="anc" name="e862" href="#e862">[e862]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e864" href="#e864">[e864]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set the resulting block property to 0 (air).</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e866:@_restoreBankAndReturn"></a><div class="c">;
; Restore the previous ROM bank and return.
;
</div><span class="l"><a class="anc" name="e866" href="#e866">[e866]</a><a href="#:e866:@_restoreBankAndReturn" class="lla">@_restoreBankAndReturn:</a><span class="ce">; [$e866]</span></span>
<span class="l"><a class="anc" name="e866" href="#e866">[e866]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the previous bank from the stack.</span></span>
<span class="l"><a class="anc" name="e867" href="#e867">[e867]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (bank)</span></span>
<span class="l"><a class="anc" name="e868" href="#e868">[e868]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Update to the bank.</span></span>
<span class="l"><a class="anc" name="e86b" href="#e86b">[e86b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_ConvertPixelsToBlockPos"></a><div class="cp">;============================================================================
; Convert a screen position from pixels to blocks.
;
; This will operate off of the stored PixelPosX and PixelPosY.
;
; INPUTS:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;         The X pixel position to convert.
;
;     <a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a>:
;         The Y pixel position to convert.
;
; Outputs:
;     X:
;         The new block position.
;
; XREFS:
;     <a href="PRG14.html#CastMagic_CheckDirection_CheckImpassable">CastMagic_CheckDirection_CheckImpassable</a>
;     <a href="PRG14.html#CurrentSprite_CalculateVisibility">CurrentSprite_CalculateVisibility</a>
;     <a href="PRG14.html#CurrentSprite_CanMoveInDirection">CurrentSprite_CanMoveInDirection</a>
;     <a href="PRG14.html#FUN_PRG14__854c">FUN_PRG14__854c</a>
;     <a href="PRG14.html#Player_CalculateVisibility">Player_CalculateVisibility</a>
;     <a href="PRG14.html#SpriteBehavior_NecronAides">SpriteBehavior_NecronAides</a>
;     <a href="PRG14.html#Sprites_MoveRight__86c6">Sprites_MoveRight__86c6</a>
;     <a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a>
;     <a href="#Area_CanPlayerMoveAtY">Area_CanPlayerMoveAtY</a>
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a>
;     <a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a>
;     <a href="#Player_CheckOnBreakableBlock">Player_CheckOnBreakableBlock</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;============================================================================
</div><span class="l"><a class="anc" name="e86c" href="#e86c">[e86c]</a><a href="#Area_ConvertPixelsToBlockPos" class="la">Area_ConvertPixelsToBlockPos:</a><span class="ce">; [$e86c]</span></span>
<span class="l"><a class="anc" name="e86c" href="#e86c">[e86c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Load the stored Y coordinate for comparison</span></span>
<span class="l"><a class="anc" name="e86e" href="#e86e">[e86e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Clear out the lower nibble</span></span>
<span class="l"><a class="anc" name="e870" href="#e870">[e870]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="e872" href="#e872">[e872]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Load the stored X coordinate for comparison</span></span>
<span class="l"><a class="anc" name="e874" href="#e874">[e874]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Convert X to block positions</span></span>
<span class="l"><a class="anc" name="e875" href="#e875">[e875]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e876" href="#e876">[e876]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e877" href="#e877">[e877]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e878" href="#e878">[e878]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Include the Y block position</span></span>
<span class="l"><a class="anc" name="e87a" href="#e87a">[e87a]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Store in X and return</span></span>
<span class="l"><a class="anc" name="e87b" href="#e87b">[e87b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="ScreenBuffer_IsBlockImpassable"></a><div class="cp">;============================================================================
; Return whether a block at a given screen buffer index is impassable.
;
; INPUTS:
;     Y:
;         The index into the blocks table.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         A map of impassable blocks.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable.
;         0 if it is passable.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="PRG14.html#CastMagic_CheckDirection_CheckImpassable">CastMagic_CheckDirection_CheckImpassable</a>
;     <a href="PRG14.html#CurrentSprite_CanMoveInDirection">CurrentSprite_CanMoveInDirection</a>
;     <a href="PRG14.html#Sprites_MoveRight__86c6">Sprites_MoveRight__86c6</a>
;     <a href="#Area_CanMoveImmediatelyRight">Area_CanMoveImmediatelyRight</a>
;     <a href="#Area_CanPlayerMoveAtY">Area_CanPlayerMoveAtY</a>
;     <a href="#Area_CheckCanClimbAdjacent">Area_CheckCanClimbAdjacent</a>
;============================================================================
</div><span class="l"><a class="anc" name="e87c" href="#e87c">[e87c]</a><a href="#ScreenBuffer_IsBlockImpassable" class="la">ScreenBuffer_IsBlockImpassable:</a><span class="ce">; [$e87c]</span></span>
<span class="l"><a class="anc" name="e87c" href="#e87c">[e87c]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block at the given index, and fall through.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_IsBlockImpassable"></a><div class="cp">;============================================================================
; Return whether a block at a given block property index is impassable.
;
; INPUTS:
;     Y:
;         The index into the blocks table.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         A map of impassable blocks.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable.
;         0 if it is passable.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="#Area_CanMoveUp">Area_CanMoveUp</a>
;     <a href="#Area_CanPlayerMoveLeft">Area_CanPlayerMoveLeft</a>
;     <a href="#Area_CanPlayerMoveUp">Area_CanPlayerMoveUp</a>
;     <a href="#Player_CheckIfPassable">Player_CheckIfPassable</a>
;============================================================================
</div><span class="l"><a class="anc" name="e87f" href="#e87f">[e87f]</a><a href="#Area_IsBlockImpassable" class="la">Area_IsBlockImpassable:</a><span class="ce">; [$e87f]</span></span>
<span class="l"><a class="anc" name="e87f" href="#e87f">[e87f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Get the property of the provided block, and fall through.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_GetFromImpassableMap"></a><div class="cp">;============================================================================
; Return whether a block property is an impassable type.
;
; INPUTS:
;     A:
;         The block property type.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         The map of impassable block properties.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable.
;         0 if it is passable.
;
; XREFS:
;     <a href="#Area_IsBlockImpassableOrLadder">Area_IsBlockImpassableOrLadder</a>
;============================================================================
</div><span class="l"><a class="anc" name="e882" href="#e882">[e882]</a><a href="#Area_GetFromImpassableMap" class="la">Area_GetFromImpassableMap:</a><span class="ce">; [$e882]</span></span>
<span class="l"><a class="anc" name="e882" href="#e882">[e882]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="e883" href="#e883">[e883]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>,Y</span></span><span class="ce">; A = Impassable flag for the block property type.</span></span>
<span class="l"><a class="anc" name="e886" href="#e886">[e886]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; And return it.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_IsBlockImpassableOrLadder"></a><div class="cp">;============================================================================
; Return whether a block at the given screen buffer index is impassable or a
; ladder.
;
; INPUTS:
;     X:
;         The index within the screen buffer, for
;         getting the block property index.
;
;     <a href="#BLOCK_PROPERTY_IMPASSABLE_MAP">BLOCK_PROPERTY_IMPASSABLE_MAP</a>:
;         A map of impassable block types.
;
; OUTPUTS:
;     A:
;         1 if the block is impassable or a ladder.
;         0 if it is passable.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;
; XREFS:
;     <a href="PRG14.html#FUN_PRG14__854c">FUN_PRG14__854c</a>
;============================================================================
</div><span class="l"><a class="anc" name="e887" href="#e887">[e887]</a><a href="#Area_IsBlockImpassableOrLadder" class="la">Area_IsBlockImpassableOrLadder:</a><span class="ce">; [$e887]</span></span>
<span class="l"><a class="anc" name="e887" href="#e887">[e887]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block property offset from the screen buffer at X.</span></span>
<span class="l"><a class="anc" name="e88a" href="#e88a">[e88a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"><a class="anc" name="e88d" href="#e88d">[e88d]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it a ladder?</span></span>
<span class="l"><a class="anc" name="e88f" href="#e88f">[e88f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Area_GetFromImpassableMap">Area_GetFromImpassableMap</a></span></span><span class="ce">; If not a ladder, look up from the passable map.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This is a ladder.
;
</div><span class="l"><a class="anc" name="e891" href="#e891">[e891]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; Return true.</span></span>
<span class="l"><a class="anc" name="e893" href="#e893">[e893]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_StoreBlockIsAir"></a><div class="cp">;============================================================================
; DEADCODE: Set whether a block is truly air.
;
; This loads the specified block property and then
; determines if it's actually air. This will be stored in
; <a href="RAM.html#Blocks_Result">Blocks_Result</a>.
;
; INPUTS:
;     X:
;         The index into the screen buffer.
;
; OUTPUTS:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         The result of the check.
;
;         1 for solid-like.
;         0 for air-like.
;
; CALLS:
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;============================================================================
</div><span class="l"><a class="anc" name="e894" href="#e894">[e894]</a><a href="#Area_StoreBlockIsAir" class="la">Area_StoreBlockIsAir:</a><span class="ce">; [$e894]</span></span>
<div class="c">;
; Load the block property at this screen buffer offset.
;
</div><span class="l"><a class="anc" name="e894" href="#e894">[e894]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Y = block property at screen buffer X</span></span>
<span class="l"><a class="anc" name="e897" href="#e897">[e897]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; Load the block property.</span></span>
<span class="l"><a class="anc" name="e89a" href="#e89a">[e89a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store that in a temporary variable.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is a solid block.
;
</div><span class="l"><a class="anc" name="e89c" href="#e89c">[e89c]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Is it solid?</span></span>
<span class="l"><a class="anc" name="e89e" href="#e89e">[e89e]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsSolid">@_blockIsSolid</a></span></span><span class="ce">; If so, then jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is a ladder.
;
</div><span class="l"><a class="anc" name="e8a0" href="#e8a0">[e8a0]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it a ladder?</span></span>
<span class="l"><a class="anc" name="e8a2" href="#e8a2">[e8a2]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsSolid">@_blockIsSolid</a></span></span><span class="ce">; If so, then jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this is a block transitioning to another screen.
;
</div><span class="l"><a class="anc" name="e8a4" href="#e8a4">[e8a4]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; Is this a transition to a screen?</span></span>
<span class="l"><a class="anc" name="e8a6" href="#e8a6">[e8a6]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_blockIsSolid">@_blockIsSolid</a></span></span><span class="ce">; If so, then jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; It's not solid. Store a result of 0 (air).
;
</div><span class="l"><a class="anc" name="e8a8" href="#e8a8">[e8a8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e8aa" href="#e8aa">[e8aa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set result = 0.</span></span>
<span class="l"><a class="anc" name="e8ac" href="#e8ac">[e8ac]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e8ad:@_blockIsSolid"></a><div class="c">;
; It is solid. Store a result of 1 (solid).
;
</div><span class="l"><a class="anc" name="e8ad" href="#e8ad">[e8ad]</a><a href="#:e8ad:@_blockIsSolid" class="lla">@_blockIsSolid:</a><span class="ce">; [$e8ad]</span></span>
<span class="l"><a class="anc" name="e8ad" href="#e8ad">[e8ad]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e8af" href="#e8af">[e8af]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Set result = 1.</span></span>
<span class="l"><a class="anc" name="e8b1" href="#e8b1">[e8b1]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_IsBlockClimbable"></a><div class="cp">;============================================================================
; Determine if the current block is climbable.
;
; This will check the provided block property (stored in
; a temp variable) and check if it can be climbed.
;
; INPUTS:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         The block property to check.
;
; OUTPUTS:
;     C:
;         1 if it's climbable.
;         0 if it is not.
;
; XREFS:
;     <a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a>
;============================================================================
</div><span class="l"><a class="anc" name="e8b2" href="#e8b2">[e8b2]</a><a href="#Area_IsBlockClimbable" class="la">Area_IsBlockClimbable:</a><span class="ce">; [$e8b2]</span></span>
<span class="l"><a class="anc" name="e8b2" href="#e8b2">[e8b2]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><a class="anc" name="e8b3" href="#e8b3">[e8b3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Load the block property provided in the temp variable.</span></span>
<span class="l"><a class="anc" name="e8b5" href="#e8b5">[e8b5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span><span class="ce">; Is it a ladder?</span></span>
<span class="l"><a class="anc" name="e8b7" href="#e8b7">[e8b7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_isLadder">@_isLadder</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"><a class="anc" name="e8b9" href="#e8b9">[e8b9]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; TODO: Is it... something else ladder-like?</span></span>
<span class="l"><a class="anc" name="e8bb" href="#e8bb">[e8bb]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_isNotLadder">@_isNotLadder</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e8bd:@_isLadder"></a><div class="c">;
; This is a ladder.
;
</div><span class="l"><a class="anc" name="e8bd" href="#e8bd">[e8bd]</a><a href="#:e8bd:@_isLadder" class="lla">@_isLadder:</a><span class="ce">; [$e8bd]</span></span>
<span class="l"><a class="anc" name="e8bd" href="#e8bd">[e8bd]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A.</span></span>
<span class="l"><a class="anc" name="e8be" href="#e8be">[e8be]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Set carry to 1 as a truthy result.</span></span>
<span class="l"><a class="anc" name="e8bf" href="#e8bf">[e8bf]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e8c0:@_isNotLadder"></a><span class="l"><a class="anc" name="e8c0" href="#e8c0">[e8c0]</a><a href="#:e8c0:@_isNotLadder" class="lla">@_isNotLadder:</a><span class="ce">; [$e8c0]</span></span>
<span class="l"><a class="anc" name="e8c0" href="#e8c0">[e8c0]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A.</span></span>
<span class="l"><a class="anc" name="e8c1" href="#e8c1">[e8c1]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Set carry to 0 as a falsy result.</span></span>
<span class="l"><a class="anc" name="e8c2" href="#e8c2">[e8c2]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="ScreenBuffer_LoadBlockProperty"></a><div class="cp">;============================================================================
; Return the block property referenced at the given screen buffer index.
;
; This will load the block property referenced in the screen
; buffer and then fall through to
; <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>.
;
; Block properties are stored with upper and lower nibbles
; representing different blocks. This will look up the
; appropriate block property based on whether the provided
; index is even or odd, and return a value with just a lower
; nibble set based on the properties.
;
; INPUTS:
;     X:
;         The index into the screen buffer.
;
;     <a href="RAM.html#BlockProperties">BlockProperties</a>:
;         The block properties to load from.
;
; OUTPUTS:
;     A:
;         A byte containing the property.
;
; XREFS:
;     <a href="PRG14.html#CurrentSprite_CalculateVisibility">CurrentSprite_CalculateVisibility</a>
;     <a href="PRG14.html#Player_CalculateVisibility">Player_CalculateVisibility</a>
;     <a href="PRG14.html#SpriteBehavior_NecronAides">SpriteBehavior_NecronAides</a>
;     <a href="#CastMagic_CalculateVisibility">CastMagic_CalculateVisibility</a>
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="e8c3" href="#e8c3">[e8c3]</a><a href="#ScreenBuffer_LoadBlockProperty" class="la">ScreenBuffer_LoadBlockProperty:</a><span class="ce">; [$e8c3]</span></span>
<span class="l"><a class="anc" name="e8c3" href="#e8c3">[e8c3]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block property index from the screen buffer.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_GetBlockProperty"></a><div class="cp">;============================================================================
; Return the block property at the given index.
;
; Block properties are stored with upper and lower nibbles
; representing different blocks. This will look up the
; appropriate block property based on whether the provided
; index is even or odd, and return a value with just a lower
; nibble set based on the properties.
;
; INPUTS:
;     Y:
;         The index into the block properties.
;
;     BlockProperties:
;         The block properties to load from.
;
; OUTPUTS:
;     A:
;         A byte containing the property.
;
; XREFS:
;     <a href="#Area_IsBlockImpassable">Area_IsBlockImpassable</a>
;     <a href="#Area_IsBlockImpassableOrLadder">Area_IsBlockImpassableOrLadder</a>
;     <a href="#Area_SetStateFromDoorDestination">Area_SetStateFromDoorDestination</a>
;     <a href="#Area_StoreBlockIsAir">Area_StoreBlockIsAir</a>
;     <a href="#Player_CheckIfOnLadder">Player_CheckIfOnLadder</a>
;     <a href="#Player_CheckOnBreakableBlock">Player_CheckOnBreakableBlock</a>
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;============================================================================
</div><span class="l"><a class="anc" name="e8c6" href="#e8c6">[e8c6]</a><a href="#Area_GetBlockProperty" class="la">Area_GetBlockProperty:</a><span class="ce">; [$e8c6]</span></span>
<span class="l"><a class="anc" name="e8c6" href="#e8c6">[e8c6]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="e8c7" href="#e8c7">[e8c7]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Y = even block offset based on the index.</span></span>
<span class="l"><a class="anc" name="e8c8" href="#e8c8">[e8c8]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="e8c9" href="#e8c9">[e8c9]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_isEven">@_isEven</a></span></span><span class="ce">; Check whether this is even or odd.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the block property at the index, moving the data in
; the upper nibble to the lower nibble.
;
</div><span class="l"><a class="anc" name="e8cb" href="#e8cb">[e8cb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockProperties">BlockProperties</a>,Y</span></span><span class="ce">; Load the block property at the index.</span></span>
<span class="l"><a class="anc" name="e8ce" href="#e8ce">[e8ce]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift to the lower nibble.</span></span>
<span class="l"><a class="anc" name="e8cf" href="#e8cf">[e8cf]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e8d0" href="#e8d0">[e8d0]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e8d1" href="#e8d1">[e8d1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e8d2" href="#e8d2">[e8d2]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e8d3:@_isEven"></a><div class="c">;
; Load the block property, masking out the upper nibble.
;
</div><span class="l"><a class="anc" name="e8d3" href="#e8d3">[e8d3]</a><a href="#:e8d3:@_isEven" class="lla">@_isEven:</a><span class="ce">; [$e8d3]</span></span>
<span class="l"><a class="anc" name="e8d3" href="#e8d3">[e8d3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockProperties">BlockProperties</a>,Y</span></span><span class="ce">; Load the block property at the index.</span></span>
<span class="l"><a class="anc" name="e8d6" href="#e8d6">[e8d6]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Mask out the upper nibble, giving just the lower.</span></span>
<span class="l"><a class="anc" name="e8d8" href="#e8d8">[e8d8]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="BLOCK_PROPERTY_IMPASSABLE_MAP"></a><div class="cp">;============================================================================
; Map of block property IDs to impassibility flags.
;
; XREFS:
;     <a href="#Area_GetFromImpassableMap">Area_GetFromImpassableMap</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Area_GetFromImpassableMap">Area_GetFromImpassableMap</a>
;
</div><span class="l"><a class="anc" name="e8d9" href="#e8d9">[e8d9]</a><a href="#BLOCK_PROPERTY_IMPASSABLE_MAP" class="la">BLOCK_PROPERTY_IMPASSABLE_MAP:</a><span class="ce">; [$e8d9]</span></span>
<span class="l"><a class="anc" name="e8d9" href="#e8d9">[e8d9]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Air</span></span>
<span class="l"><a class="anc" name="e8da" href="#e8da">[e8da]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]: Solid</span></span>
<span class="l"><a class="anc" name="e8db" href="#e8db">[e8db]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]: Ladder</span></span>
<span class="l"><a class="anc" name="e8dc" href="#e8dc">[e8dc]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [3]: Door</span></span>
<span class="l"><a class="anc" name="e8dd" href="#e8dd">[e8dd]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [4]: Foreground</span></span>
<span class="l"><a class="anc" name="e8de" href="#e8de">[e8de]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [5]: Breakable floor</span></span>
<span class="l"><a class="anc" name="e8df" href="#e8df">[e8df]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [6]: Pushable</span></span>
<span class="l"><a class="anc" name="e8e0" href="#e8e0">[e8e0]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [7]: ??</span></span>
<span class="l"><a class="anc" name="e8e1" href="#e8e1">[e8e1]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [8]: ??</span></span>
<span class="l"><a class="anc" name="e8e2" href="#e8e2">[e8e2]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [9]: Maybe: Transition down</span></span>
<span class="l"><a class="anc" name="e8e3" href="#e8e3">[e8e3]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [10]: Maybe: Transition up</span></span>
<span class="l"><a class="anc" name="e8e4" href="#e8e4">[e8e4]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [11]: Breakable by Mattock</span></span>
<span class="l"><a class="anc" name="e8e5" href="#e8e5">[e8e5]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [12]: Area transition left-to-right</span></span>
<span class="l"><a class="anc" name="e8e6" href="#e8e6">[e8e6]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [13]: Area transition right-to-left</span></span>
<span class="l"><a class="anc" name="e8e7" href="#e8e7">[e8e7]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]: ??</span></span>
<span class="l"><a class="anc" name="e8e8" href="#e8e8">[e8e8]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [15]: ??</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Area_ScrollTo"></a><div class="cp">;============================================================================
; Begin scrolling to an adjacent room.
;
; This will begin clearing out state for the current room
; and then begin scrolling to the next in the given
; direction.
;
; INPUTS:
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the current area.
;
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The event ID for the current screen being
;         scrolled from.
;
; OUTPUTS:
;     <a href="RAM.html#CastMagic_Type">CastMagic_Type</a>:
;         The cast magic type, reset to 0xFF.
;
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The interrupt counter, reset to 0.
;
;     <a href="RAM.html#Player_MovementTick">Player_MovementTick</a>:
;         The player movement tick, reset to 0.
;
; CALLS:
;     <a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a>
;
; XREFS:
;     <a href="#Area_ScrollScreenDown">Area_ScrollScreenDown</a>
;     <a href="#Area_ScrollScreenUp">Area_ScrollScreenUp</a>
;     <a href="#Player_CheckHandleClimbUp">Player_CheckHandleClimbUp</a>
;     <a href="#Player_MoveDownScreen">Player_MoveDownScreen</a>
;     <a href="#Player_TryMoveLeft">Player_TryMoveLeft</a>
;     <a href="#Player_TryMoveRight">Player_TryMoveRight</a>
;============================================================================
</div><span class="l"><a class="anc" name="e8e9" href="#e8e9">[e8e9]</a><a href="#Area_ScrollTo" class="la">Area_ScrollTo:</a><span class="ce">; [$e8e9]</span></span>
<span class="l"><a class="anc" name="e8e9" href="#e8e9">[e8e9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Load the current screen's event ID.</span></span>
<span class="l"><a class="anc" name="e8ec" href="#e8ec">[e8ec]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Keep the numeric ID.</span></span>
<span class="l"><a class="anc" name="e8ee" href="#e8ee">[e8ee]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span><span class="ce">; Is it 1 (boss room)?</span></span>
<span class="l"><a class="anc" name="e8f0" href="#e8f0">[e8f0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_clearStates">@_clearStates</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player is scrolling from a boss room. Reset the music
; back to the default music for the area.
;
</div><span class="l"><a class="anc" name="e8f2" href="#e8f2">[e8f2]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Load the default music for the area.</span></span>
<span class="l"><a class="anc" name="e8f5" href="#e8f5">[e8f5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"></span>
<a name=":e8f7:@_clearStates"></a><span class="l"><a class="anc" name="e8f7" href="#e8f7">[e8f7]</a><a href="#:e8f7:@_clearStates" class="lla">@_clearStates:</a><span class="ce">; [$e8f7]</span></span>
<span class="l"><a class="anc" name="e8f7" href="#e8f7">[e8f7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="e8f9" href="#e8f9">[e8f9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span><span class="ce">; Set player movement tick to 0.</span></span>
<span class="l"><a class="anc" name="e8fb" href="#e8fb">[e8fb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Set interrupt counter to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear any cast magic.
;
</div><span class="l"><a class="anc" name="e8fd" href="#e8fd">[e8fd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span><span class="ce">; A = 0xFF (unset)</span></span>
<span class="l"><a class="anc" name="e8ff" href="#e8ff">[e8ff]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CastMagic_Type">CastMagic_Type</a></span></span><span class="ce">; Set as the magic type on screen.</span></span>
<span class="l"><a class="anc" name="e902" href="#e902">[e902]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Area_LoadScrollDataRight">Area_LoadScrollDataRight</a></span></span><span class="ce">; Now scroll to the room.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckOnBreakableBlock"></a><div class="cp">;============================================================================
; Check if the player is on a breakable block.
;
; This will check the blocks below the player to see if
; they're on a breakable block. If so, the block breaking
; logic will activate.
;
; This is not checked on every frame.
;
; INPUTS:
;     <a href="RAM.html#InterruptCounter">InterruptCounter</a>:
;         The current interrupt counter.
;
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags, used to determine
;         the facing direction.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The player's current X position in blocks.
;
;     <a href="RAM.html#Player_PosY">Player_PosY</a>:
;         The player's current Y position.
;
; OUTPUTS:
;     <a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a>:
;     <a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a>:
;     <a href="RAM.html#Blocks_Result">Blocks_Result</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a>
;     <a href="#Area_GetBlockProperty">Area_GetBlockProperty</a>
;     <a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a>
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e905" href="#e905">[e905]</a><a href="#Player_CheckOnBreakableBlock" class="la">Player_CheckOnBreakableBlock:</a><span class="ce">; [$e905]</span></span>
<div class="c">;
; Only check for falling periodically.
;
</div><span class="l"><a class="anc" name="e905" href="#e905">[e905]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#InterruptCounter">InterruptCounter</a></span></span><span class="ce">; Load the interrupt counter.</span></span>
<span class="l"><a class="anc" name="e907" href="#e907">[e907]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Are we ready to check for falling?</span></span>
<span class="l"><a class="anc" name="e909" href="#e909">[e909]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin checking against a block 32 pixels down.
;
</div><span class="l"><a class="anc" name="e90b" href="#e90b">[e90b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span><span class="ce">; A = Player's Y position.</span></span>
<span class="l"><a class="anc" name="e90d" href="#e90d">[e90d]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e90e" href="#e90e">[e90e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$20</span></span><span class="ce">; A += 32</span></span>
<span class="l"><a class="anc" name="e910" href="#e910">[e910]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span><span class="ce">; Store as the Y argument for block checks.</span></span>
<span class="l"><a class="anc" name="e912" href="#e912">[e912]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$f0</span></span><span class="ce">; Is it &gt;= 0xEF? (one block below the screen)</span></span>
<span class="l"><a class="anc" name="e914" href="#e914">[e914]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, stop falling.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player may be permitted to fall. Check the block
; it's on.
;
</div><span class="l"><a class="anc" name="e916" href="#e916">[e916]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="e918" href="#e918">[e918]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Keep only the facing bit.</span></span>
<span class="l"><a class="anc" name="e91a" href="#e91a">[e91a]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span><span class="ce">; Shift this into bit 0.</span></span>
<span class="l"><a class="anc" name="e91b" href="#e91b">[e91b]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e91c" href="#e91c">[e91c]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e91d" href="#e91d">[e91d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Mask out everything else.</span></span>
<span class="l"><a class="anc" name="e91f" href="#e91f">[e91f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check the first block the player is overlapping.
;
</div><span class="l"><a class="anc" name="e920" href="#e920">[e920]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = facing value.</span></span>
<span class="l"><a class="anc" name="e921" href="#e921">[e921]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; A = Player X position.</span></span>
<span class="l"><a class="anc" name="e923" href="#e923">[e923]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e924" href="#e924">[e924]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#@_CHECK_BREAKABLE_BLOCK_X_OFFSETS">@_CHECK_BREAKABLE_BLOCK_X_OFFSETS</a>,X</span></span><span class="ce">; Load a block offset to round to the nearest overlapping blocks.</span></span>
<span class="l"><a class="anc" name="e927" href="#e927">[e927]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the X position to check.</span></span>
<span class="l"><a class="anc" name="e929" href="#e929">[e929]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert it to a block position.</span></span>
<span class="l"><a class="anc" name="e92c" href="#e92c">[e92c]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block value from the screen.</span></span>
<span class="l"><a class="anc" name="e92f" href="#e92f">[e92f]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store as the block result.</span></span>
<span class="l"><a class="anc" name="e931" href="#e931">[e931]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span><span class="ce">; And get its corresponding property.</span></span>
<span class="l"><a class="anc" name="e934" href="#e934">[e934]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$05</span></span><span class="ce">; Is it 5 (breakable floor)?</span></span>
<span class="l"><a class="anc" name="e936" href="#e936">[e936]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkNextBlock">@_checkNextBlock</a></span></span><span class="ce">; If not, check the next overlapping block.</span></span>
<span class="l"><a class="anc" name="e938" href="#e938">[e938]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the facing bit from the stack.</span></span>
<span class="l"><a class="anc" name="e939" href="#e939">[e939]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a></span></span><span class="ce">; Handle breakable floor logic.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e93c:@_checkNextBlock"></a><div class="c">;
; Check the second block the player is overlapping.
;
</div><span class="l"><a class="anc" name="e93c" href="#e93c">[e93c]</a><a href="#:e93c:@_checkNextBlock" class="lla">@_checkNextBlock:</a><span class="ce">; [$e93c]</span></span>
<span class="l"><a class="anc" name="e93c" href="#e93c">[e93c]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the facing bit from the stack.</span></span>
<span class="l"><a class="anc" name="e93d" href="#e93d">[e93d]</a><span class="cd"><span class="i">EOR</span> <span class="o">#$01</span></span><span class="ce">; XOR the facing bit to check the other direction.</span></span>
<span class="l"><a class="anc" name="e93f" href="#e93f">[e93f]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="e940" href="#e940">[e940]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; A = Player X position.</span></span>
<span class="l"><a class="anc" name="e942" href="#e942">[e942]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e943" href="#e943">[e943]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#@_CHECK_BREAKABLE_BLOCK_X_OFFSETS">@_CHECK_BREAKABLE_BLOCK_X_OFFSETS</a>,X</span></span><span class="ce">; Load a block offset to round to the next overlapping blocks.</span></span>
<span class="l"><a class="anc" name="e946" href="#e946">[e946]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span><span class="ce">; Store as the X position to check.</span></span>
<span class="l"><a class="anc" name="e948" href="#e948">[e948]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span><span class="ce">; Convert it to a block position.</span></span>
<span class="l"><a class="anc" name="e94b" href="#e94b">[e94b]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Load the block value from the screen.</span></span>
<span class="l"><a class="anc" name="e94e" href="#e94e">[e94e]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Blocks_Result">Blocks_Result</a></span></span><span class="ce">; Store as the block result.</span></span>
<span class="l"><a class="anc" name="e950" href="#e950">[e950]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"><a class="anc" name="e953" href="#e953">[e953]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$05</span></span><span class="ce">; Is it 5 (breakable floor)?</span></span>
<span class="l"><a class="anc" name="e955" href="#e955">[e955]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, return.</span></span>
<span class="l"><a class="anc" name="e957" href="#e957">[e957]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Area_HandleBreakableFloor">Area_HandleBreakableFloor</a></span></span><span class="ce">; Handle breakable floor logic.</span></span>
<span class="l"></span>
<a name=":e95a:@_return"></a><span class="l"><a class="anc" name="e95a" href="#e95a">[e95a]</a><a href="#:e95a:@_return" class="lla">@_return:</a><span class="ce">; [$e95a]</span></span>
<span class="l"><a class="anc" name="e95a" href="#e95a">[e95a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e95b:@_CHECK_BREAKABLE_BLOCK_X_OFFSETS"></a><div class="cp">;============================================================================
; Map of facing bit values to block X offsets for checking breakable blocks.
;
; XREFS:
;     <a href="#Player_CheckOnBreakableBlock">Player_CheckOnBreakableBlock</a>
;============================================================================
</div><span class="l"><a class="anc" name="e95b" href="#e95b">[e95b]</a><a href="#:e95b:@_CHECK_BREAKABLE_BLOCK_X_OFFSETS" class="lla">@_CHECK_BREAKABLE_BLOCK_X_OFFSETS:</a><span class="ce">; [$e95b]</span></span>
<span class="l"><a class="anc" name="e95b" href="#e95b">[e95b]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [0]: Facing left</span></span>
<span class="l"><a class="anc" name="e95c" href="#e95c">[e95c]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [1]: Facing right</span></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckPushingBlock"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckPushingBlock
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e95d" href="#e95d">[e95d]</a><a href="#Player_CheckPushingBlock" class="la">Player_CheckPushingBlock:</a><span class="ce">; [$e95d]</span></span>
<span class="l"><a class="anc" name="e95d" href="#e95d">[e95d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e95f" href="#e95f">[e95f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="e961" href="#e961">[e961]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"><a class="anc" name="e963" href="#e963">[e963]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span></span>
<span class="l"><a class="anc" name="e966" href="#e966">[e966]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="e968" href="#e968">[e968]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"><a class="anc" name="e96a" href="#e96a">[e96a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span></span>
<span class="l"><a class="anc" name="e96d" href="#e96d">[e96d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="e96f" href="#e96f">[e96f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="e971" href="#e971">[e971]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"><a class="anc" name="e973" href="#e973">[e973]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="e975" href="#e975">[e975]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="e977" href="#e977">[e977]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e978" href="#e978">[e978]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e979" href="#e979">[e979]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e97a" href="#e97a">[e97a]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e97c" href="#e97c">[e97c]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e97d" href="#e97d">[e97d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e97f" href="#e97f">[e97f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e981" href="#e981">[e981]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e983" href="#e983">[e983]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e984" href="#e984">[e984]</a><span class="cd"><span class="i">ADC</span> <span class="o">$e9be,X</span></span></span>
<span class="l"><a class="anc" name="e987" href="#e987">[e987]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Fetch the block property at this position.
;
</div><span class="l"><a class="anc" name="e989" href="#e989">[e989]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e98c" href="#e98c">[e98c]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="e98f" href="#e98f">[e98f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_GetBlockProperty">Area_GetBlockProperty</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the block is pushable. If so, we'll handle it.
;
</div><span class="l"><a class="anc" name="e992" href="#e992">[e992]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="e994" href="#e994">[e994]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9b9">@LAB_PRG15_MIRROR__e9b9</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This is pushable. Increase the push counter.
;
; We'll play a sound when we hit 0x3F, and finish pushing
; after 0x60.
;
</div><span class="l"><a class="anc" name="e996" href="#e996">[e996]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><a class="anc" name="e998" href="#e998">[e998]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><a class="anc" name="e99a" href="#e99a">[e99a]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$3f</span></span></span>
<span class="l"><a class="anc" name="e99c" href="#e99c">[e99c]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9a3">@LAB_PRG15_MIRROR__e9a3</a></span></span></span>
<span class="l"><a class="anc" name="e99e" href="#e99e">[e99e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e9a0" href="#e9a0">[e9a0]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span></span>
<span class="l"></span>
<a name=":e9a3:@LAB_PRG15_MIRROR__e9a3"></a><span class="l"><a class="anc" name="e9a3" href="#e9a3">[e9a3]</a><a href="#:e9a3:@LAB_PRG15_MIRROR__e9a3" class="lla">@LAB_PRG15_MIRROR__e9a3:</a><span class="ce">; [$e9a3]</span></span>
<span class="l"><a class="anc" name="e9a3" href="#e9a3">[e9a3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><a class="anc" name="e9a5" href="#e9a5">[e9a5]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$60</span></span></span>
<span class="l"><a class="anc" name="e9a7" href="#e9a7">[e9a7]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="e9a9" href="#e9a9">[e9a9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e9ab" href="#e9ab">[e9ab]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a></span></span></span>
<span class="l"><a class="anc" name="e9ad" href="#e9ad">[e9ad]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span></span>
<span class="l"><a class="anc" name="e9af" href="#e9af">[e9af]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="e9b1" href="#e9b1">[e9b1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="e9b2" href="#e9b2">[e9b2]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="e9b4" href="#e9b4">[e9b4]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="e9b5" href="#e9b5">[e9b5]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a></span></span></span>
<span class="l"></span>
<a name=":e9b8:@_return"></a><span class="l"><a class="anc" name="e9b8" href="#e9b8">[e9b8]</a><a href="#:e9b8:@_return" class="lla">@_return:</a><span class="ce">; [$e9b8]</span></span>
<span class="l"><a class="anc" name="e9b8" href="#e9b8">[e9b8]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":e9b9:@LAB_PRG15_MIRROR__e9b9"></a><span class="l"><a class="anc" name="e9b9" href="#e9b9">[e9b9]</a><a href="#:e9b9:@LAB_PRG15_MIRROR__e9b9" class="lla">@LAB_PRG15_MIRROR__e9b9:</a><span class="ce">; [$e9b9]</span></span>
<span class="l"><a class="anc" name="e9b9" href="#e9b9">[e9b9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="e9bb" href="#e9bb">[e9bb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BlockPushCounter">BlockPushCounter</a></span></span></span>
<span class="l"><a class="anc" name="e9bd" href="#e9bd">[e9bd]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__e9be"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckPushingBlock">Player_CheckPushingBlock</a>
;
</div><span class="l"><a class="anc" name="e9be" href="#e9be">[e9be]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__e9be" class="la">BYTE_ARRAY_PRG15_MIRROR__e9be:</a><span class="ce">; [$e9be]</span></span>
<span class="l"><a class="anc" name="e9be" href="#e9be">[e9be]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="e9bf" href="#e9bf">[e9bf]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
</pre><pre><a name="Player_CheckSwitchScreen"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckSwitchScreen
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#GameLoop_UpdatePlayer">GameLoop_UpdatePlayer</a>
;============================================================================
</div><span class="l"><a class="anc" name="e9c0" href="#e9c0">[e9c0]</a><a href="#Player_CheckSwitchScreen" class="la">Player_CheckSwitchScreen:</a><span class="ce">; [$e9c0]</span></span>
<div class="c">;
; Check the current block the player is on.
;
</div><span class="l"><a class="anc" name="e9c0" href="#e9c0">[e9c0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="e9c2" href="#e9c2">[e9c2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosY">Arg_PixelPosY</a></span></span></span>
<span class="l"><a class="anc" name="e9c4" href="#e9c4">[e9c4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e9c6" href="#e9c6">[e9c6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e9c8" href="#e9c8">[e9c8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e9cb" href="#e9cb">[e9cb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span></span>
<span class="l"><a class="anc" name="e9ce" href="#e9ce">[e9ce]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$09</span></span></span>
<span class="l"><a class="anc" name="e9d0" href="#e9d0">[e9d0]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9de">@LAB_PRG15_MIRROR__e9de</a></span></span></span>
<span class="l"><a class="anc" name="e9d2" href="#e9d2">[e9d2]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="e9d4" href="#e9d4">[e9d4]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9de">@LAB_PRG15_MIRROR__e9de</a></span></span></span>
<span class="l"><a class="anc" name="e9d6" href="#e9d6">[e9d6]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0d</span></span></span>
<span class="l"><a class="anc" name="e9d8" href="#e9d8">[e9d8]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9de">@LAB_PRG15_MIRROR__e9de</a></span></span></span>
<span class="l"><a class="anc" name="e9da" href="#e9da">[e9da]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0c</span></span></span>
<span class="l"><a class="anc" name="e9dc" href="#e9dc">[e9dc]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e9de:@LAB_PRG15_MIRROR__e9de"></a><div class="c">;
; Check the next block.
;
</div><span class="l"><a class="anc" name="e9de" href="#e9de">[e9de]</a><a href="#:e9de:@LAB_PRG15_MIRROR__e9de" class="lla">@LAB_PRG15_MIRROR__e9de:</a><span class="ce">; [$e9de]</span></span>
<span class="l"><a class="anc" name="e9de" href="#e9de">[e9de]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="e9e0" href="#e9e0">[e9e0]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="e9e1" href="#e9e1">[e9e1]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="e9e3" href="#e9e3">[e9e3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_PixelPosX">Arg_PixelPosX</a></span></span></span>
<span class="l"><a class="anc" name="e9e5" href="#e9e5">[e9e5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Area_ConvertPixelsToBlockPos">Area_ConvertPixelsToBlockPos</a></span></span></span>
<span class="l"><a class="anc" name="e9e8" href="#e9e8">[e9e8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#ScreenBuffer_LoadBlockProperty">ScreenBuffer_LoadBlockProperty</a></span></span></span>
<span class="l"><a class="anc" name="e9eb" href="#e9eb">[e9eb]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$09</span></span></span>
<span class="l"><a class="anc" name="e9ed" href="#e9ed">[e9ed]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9fb">@LAB_PRG15_MIRROR__e9fb</a></span></span></span>
<span class="l"><a class="anc" name="e9ef" href="#e9ef">[e9ef]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="e9f1" href="#e9f1">[e9f1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9fb">@LAB_PRG15_MIRROR__e9fb</a></span></span></span>
<span class="l"><a class="anc" name="e9f3" href="#e9f3">[e9f3]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0d</span></span></span>
<span class="l"><a class="anc" name="e9f5" href="#e9f5">[e9f5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__e9fb">@LAB_PRG15_MIRROR__e9fb</a></span></span></span>
<span class="l"><a class="anc" name="e9f7" href="#e9f7">[e9f7]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0c</span></span></span>
<span class="l"><a class="anc" name="e9f9" href="#e9f9">[e9f9]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":e9fb:@LAB_PRG15_MIRROR__e9fb"></a><div class="c">;
; Check if this is a horizontal transition block. If so,
; switch the area.
;
</div><span class="l"><a class="anc" name="e9fb" href="#e9fb">[e9fb]</a><a href="#:e9fb:@LAB_PRG15_MIRROR__e9fb" class="lla">@LAB_PRG15_MIRROR__e9fb:</a><span class="ce">; [$e9fb]</span></span>
<span class="l"><a class="anc" name="e9fb" href="#e9fb">[e9fb]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0c</span></span></span>
<span class="l"><a class="anc" name="e9fd" href="#e9fd">[e9fd]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_CheckSwitchScreen_SwitchAreaHoriz">Player_CheckSwitchScreen_SwitchAreaHoriz</a></span></span></span>
<span class="l"><a class="anc" name="e9ff" href="#e9ff">[e9ff]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0d</span></span></span>
<span class="l"><a class="anc" name="ea01" href="#ea01">[ea01]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Player_CheckSwitchScreen_SwitchAreaHoriz">Player_CheckSwitchScreen_SwitchAreaHoriz</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This is a vertical transition block. Switch the
; area.
;
</div><span class="l"><a class="anc" name="ea03" href="#ea03">[ea03]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="ea05" href="#ea05">[ea05]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ea06" href="#ea06">[ea06]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="ea07" href="#ea07">[ea07]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#@_return">@_return</a>+1,X</span></span></span>
<span class="l"><a class="anc" name="ea0a" href="#ea0a">[ea0a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><a class="anc" name="ea0c" href="#ea0c">[ea0c]</a><span class="cd"><span class="i">LDA</span> <span class="o">$ea38,X</span></span></span>
<span class="l"><a class="anc" name="ea0f" href="#ea0f">[ea0f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="ea11" href="#ea11">[ea11]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":ea13:@LAB_PRG15_MIRROR__ea13"></a><span class="l"><a class="anc" name="ea13" href="#ea13">[ea13]</a><a href="#:ea13:@LAB_PRG15_MIRROR__ea13" class="lla">@LAB_PRG15_MIRROR__ea13:</a><span class="ce">; [$ea13]</span></span>
<span class="l"><a class="anc" name="ea13" href="#ea13">[ea13]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea15" href="#ea15">[ea15]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ea17" href="#ea17">[ea17]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="ea19" href="#ea19">[ea19]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="ea1b" href="#ea1b">[ea1b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea2f">@LAB_PRG15_MIRROR__ea2f</a></span></span></span>
<span class="l"><a class="anc" name="ea1d" href="#ea1d">[ea1d]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea1e" href="#ea1e">[ea1e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea20" href="#ea20">[ea20]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="ea22" href="#ea22">[ea22]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea23" href="#ea23">[ea23]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea25" href="#ea25">[ea25]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="ea27" href="#ea27">[ea27]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea28" href="#ea28">[ea28]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea2a" href="#ea2a">[ea2a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="ea2c" href="#ea2c">[ea2c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupEnterScreen">Game_SetupEnterScreen</a></span></span></span>
<span class="l"></span>
<a name=":ea2f:@LAB_PRG15_MIRROR__ea2f"></a><span class="l"><a class="anc" name="ea2f" href="#ea2f">[ea2f]</a><a href="#:ea2f:@LAB_PRG15_MIRROR__ea2f" class="lla">@LAB_PRG15_MIRROR__ea2f:</a><span class="ce">; [$ea2f]</span></span>
<span class="l"><a class="anc" name="ea2f" href="#ea2f">[ea2f]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea30" href="#ea30">[ea30]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea31" href="#ea31">[ea31]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea32" href="#ea32">[ea32]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea33" href="#ea33">[ea33]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea13">@LAB_PRG15_MIRROR__ea13</a></span></span></span>
<span class="l"></span>
<a name=":ea36:@_return"></a><span class="l"><a class="anc" name="ea36" href="#ea36">[ea36]</a><a href="#:ea36:@_return" class="lla">@_return:</a><span class="ce">; [$ea36]</span></span>
<span class="l"><a class="anc" name="ea36" href="#ea36">[ea36]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="USHORT_PRG15_MIRROR__ea37"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;
</div><span class="l"><a class="anc" name="ea37" href="#ea37">[ea37]</a><a href="#USHORT_PRG15_MIRROR__ea37" class="la">USHORT_PRG15_MIRROR__ea37:</a><span class="ce">; [$ea37]</span></span>
<span class="l"><a class="anc" name="ea37" href="#ea37">[ea37]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Eolis</span></span>
<span class="l"><a class="anc" name="ea39" href="#ea39">[ea39]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea47">BYTE_PRG15_MIRROR__ea47</a></span></span><span class="ce">; Apolune</span></span>
<span class="l"><a class="anc" name="ea3b" href="#ea3b">[ea3b]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Forepaw</span></span>
<span class="l"><a class="anc" name="ea3d" href="#ea3d">[ea3d]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Mascon</span></span>
<span class="l"><a class="anc" name="ea3f" href="#ea3f">[ea3f]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Victim</span></span>
<span class="l"><a class="anc" name="ea41" href="#ea41">[ea41]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Conflate</span></span>
<span class="l"><a class="anc" name="ea43" href="#ea43">[ea43]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Daybreak</span></span>
<span class="l"><a class="anc" name="ea45" href="#ea45">[ea45]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#BYTE_PRG15_MIRROR__ea4f">BYTE_PRG15_MIRROR__ea4f</a></span></span><span class="ce">; Evil Fortress</span></span>
<span class="l"></span>
<a name="BYTE_PRG15_MIRROR__ea47"></a><span class="l"><a class="anc" name="ea47" href="#ea47">[ea47]</a><a href="#BYTE_PRG15_MIRROR__ea47" class="la">BYTE_PRG15_MIRROR__ea47:</a><span class="ce">; [$ea47]</span></span>
<span class="l"><a class="anc" name="ea47" href="#ea47">[ea47]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; Current screen comparator</span></span>
<span class="l"><a class="anc" name="ea48" href="#ea48">[ea48]</a><span class="cd"><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; New screen index</span></span>
<span class="l"><a class="anc" name="ea49" href="#ea49">[ea49]</a><span class="cd"><span class="i">db</span> <span class="o">$b3</span></span><span class="ce">; Y, X</span></span>
<span class="l"><a class="anc" name="ea4a" href="#ea4a">[ea4a]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; Area</span></span>
<span class="l"><a class="anc" name="ea4b" href="#ea4b">[ea4b]</a><span class="cd"><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; Current screen comparator</span></span>
<span class="l"><a class="anc" name="ea4c" href="#ea4c">[ea4c]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; New screen index</span></span>
<span class="l"><a class="anc" name="ea4d" href="#ea4d">[ea4d]</a><span class="cd"><span class="i">db</span> <span class="o">$2d</span></span><span class="ce">; Y, X</span></span>
<span class="l"><a class="anc" name="ea4e" href="#ea4e">[ea4e]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; Area</span></span>
<span class="l"></span>
<a name="BYTE_PRG15_MIRROR__ea4f"></a><div class="c">;
; XREFS:
;     <a href="#USHORT_PRG15_MIRROR__ea37">USHORT_PRG15_MIRROR__ea37</a>
;     [$PRG15_MIRROR::ea37]
;
</div><span class="l"><a class="anc" name="ea4f" href="#ea4f">[ea4f]</a><a href="#BYTE_PRG15_MIRROR__ea4f" class="la">BYTE_PRG15_MIRROR__ea4f:</a><span class="ce">; [$ea4f]</span></span>
<span class="l"><a class="anc" name="ea4f" href="#ea4f">[ea4f]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$ea4f] byte</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_BeginExitBuilding"></a><div class="cp">;============================================================================
; Begin exiting a building.
;
; This will face the player to the right and begin playing the
; music in the outside world.
;
; It will then proceed to set up state for the outside area.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The current player's flags.
;
;     <a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a>:
;         The music played outside in this area.
;
; OUTPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The updated player's flags, facing right.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The updated music to play.
;
; CALLS:
;     <a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a>
;
; XREFS:
;     <a href="#Player_CheckSwitchScreen_SwitchAreaHoriz">Player_CheckSwitchScreen_SwitchAreaHoriz</a>
;     <a href="#Player_EnterDoorToInside">Player_EnterDoorToInside</a>
;============================================================================
</div><span class="l"><a class="anc" name="ea50" href="#ea50">[ea50]</a><a href="#Game_BeginExitBuilding" class="la">Game_BeginExitBuilding:</a><span class="ce">; [$ea50]</span></span>
<div class="c">;
; Face the player to the right.
;
</div><span class="l"><a class="anc" name="ea50" href="#ea50">[ea50]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player flags.</span></span>
<span class="l"><a class="anc" name="ea52" href="#ea52">[ea52]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$40</span></span><span class="ce">; Face the player right.</span></span>
<span class="l"><a class="anc" name="ea54" href="#ea54">[ea54]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Store the flags.</span></span>
<span class="l"><a class="anc" name="ea56" href="#ea56">[ea56]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Area_Music_Outside">Area_Music_Outside</a></span></span><span class="ce">; Load the music used outside the building.</span></span>
<span class="l"><a class="anc" name="ea59" href="#ea59">[ea59]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Set as the music to play.</span></span>
<span class="l"><a class="anc" name="ea5c" href="#ea5c">[ea5c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupExitBuilding">Game_SetupExitBuilding</a></span></span><span class="ce">; Jump to finish the exit-building logic.</span></span>
</pre><pre><a name="Player_CheckSwitchScreen_SwitchAreaHoriz"></a><div class="cp">;============================================================================
; TODO: Document Player_CheckSwitchScreen_SwitchAreaHoriz
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_CheckSwitchScreen">Player_CheckSwitchScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="ea5f" href="#ea5f">[ea5f]</a><a href="#Player_CheckSwitchScreen_SwitchAreaHoriz" class="la">Player_CheckSwitchScreen_SwitchAreaHoriz:</a><span class="ce">; [$ea5f]</span></span>
<div class="c">;
; Check if the player is in the area of Victim.
;
</div><span class="l"><a class="anc" name="ea5f" href="#ea5f">[ea5f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="ea61" href="#ea61">[ea61]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="ea63" href="#ea63">[ea63]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_BeginExitBuilding">Game_BeginExitBuilding</a></span></span></span>
<span class="l"><a class="anc" name="ea65" href="#ea65">[ea65]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ea66" href="#ea66">[ea66]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="ea67" href="#ea67">[ea67]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>,Y</span></span></span>
<span class="l"><a class="anc" name="ea6a" href="#ea6a">[ea6a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><a class="anc" name="ea6c" href="#ea6c">[ea6c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>+1,Y</span></span></span>
<span class="l"><a class="anc" name="ea6f" href="#ea6f">[ea6f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="ea71" href="#ea71">[ea71]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":ea73:@LAB_PRG15_MIRROR__ea73"></a><span class="l"><a class="anc" name="ea73" href="#ea73">[ea73]</a><a href="#:ea73:@LAB_PRG15_MIRROR__ea73" class="lla">@LAB_PRG15_MIRROR__ea73:</a><span class="ce">; [$ea73]</span></span>
<span class="l"><a class="anc" name="ea73" href="#ea73">[ea73]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea75" href="#ea75">[ea75]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ea77" href="#ea77">[ea77]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="ea79" href="#ea79">[ea79]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Area_CurrentScreen">Area_CurrentScreen</a></span></span></span>
<span class="l"><a class="anc" name="ea7b" href="#ea7b">[ea7b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea94">@LAB_PRG15_MIRROR__ea94</a></span></span></span>
<span class="l"><a class="anc" name="ea7d" href="#ea7d">[ea7d]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea7e" href="#ea7e">[ea7e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea80" href="#ea80">[ea80]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span></span>
<span class="l"><a class="anc" name="ea82" href="#ea82">[ea82]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea83" href="#ea83">[ea83]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea85" href="#ea85">[ea85]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Area_LoadingScreenIndex">Area_LoadingScreenIndex</a></span></span></span>
<span class="l"><a class="anc" name="ea87" href="#ea87">[ea87]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea88" href="#ea88">[ea88]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea8a" href="#ea8a">[ea8a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_StartPosYX">Screen_StartPosYX</a></span></span></span>
<span class="l"><a class="anc" name="ea8c" href="#ea8c">[ea8c]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="ea8d" href="#ea8d">[ea8d]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="ea8f" href="#ea8f">[ea8f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Screen_DestPaletteOrIndex">Screen_DestPaletteOrIndex</a></span></span></span>
<span class="l"><a class="anc" name="ea91" href="#ea91">[ea91]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_SetupNewArea">Game_SetupNewArea</a></span></span></span>
<span class="l"></span>
<a name=":ea94:@LAB_PRG15_MIRROR__ea94"></a><span class="l"><a class="anc" name="ea94" href="#ea94">[ea94]</a><a href="#:ea94:@LAB_PRG15_MIRROR__ea94" class="lla">@LAB_PRG15_MIRROR__ea94:</a><span class="ce">; [$ea94]</span></span>
<span class="l"><a class="anc" name="ea94" href="#ea94">[ea94]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="ea95" href="#ea95">[ea95]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ea96" href="#ea96">[ea96]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="ea98" href="#ea98">[ea98]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="ea99" href="#ea99">[ea99]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ea73">@LAB_PRG15_MIRROR__ea73</a></span></span></span>
<span class="l"></span>
<a name=":ea9b:@_return"></a><span class="l"><a class="anc" name="ea9b" href="#ea9b">[ea9b]</a><a href="#:ea9b:@_return" class="lla">@_return:</a><span class="ce">; [$ea9b]</span></span>
<span class="l"><a class="anc" name="ea9b" href="#ea9b">[ea9b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="AREA_TOWN_TRANSITIONS_DATA"></a><div class="c">;
; XREFS:
;     <a href="#Player_CheckSwitchScreen_SwitchAreaHoriz">Player_CheckSwitchScreen_SwitchAreaHoriz</a>
;
</div><span class="l"><a class="anc" name="ea9c" href="#ea9c">[ea9c]</a><a href="#AREA_TOWN_TRANSITIONS_DATA" class="la">AREA_TOWN_TRANSITIONS_DATA:</a><span class="ce">; [$ea9c]</span></span>
<span class="l"><a class="anc" name="ea9c" href="#ea9c">[ea9c]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_EMPTY">TOWN_TRANSITIONS_EMPTY</a></span></span><span class="ce">; [0]: Eolis</span></span>
<span class="l"><a class="anc" name="ea9e" href="#ea9e">[ea9e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_APOLUNE">TOWN_TRANSITIONS_APOLUNE</a></span></span><span class="ce">; [1]: Apolune</span></span>
<span class="l"><a class="anc" name="eaa0" href="#eaa0">[eaa0]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_FOREPAW">TOWN_TRANSITIONS_FOREPAW</a></span></span><span class="ce">; [2]: Forepaw</span></span>
<span class="l"><a class="anc" name="eaa2" href="#eaa2">[eaa2]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_MASCON">TOWN_TRANSITIONS_MASCON</a></span></span><span class="ce">; [3]: Mascon</span></span>
<span class="l"><a class="anc" name="eaa4" href="#eaa4">[eaa4]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_EMPTY">TOWN_TRANSITIONS_EMPTY</a></span></span><span class="ce">; [4]: Victim</span></span>
<span class="l"><a class="anc" name="eaa6" href="#eaa6">[eaa6]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_CONFLATE">TOWN_TRANSITIONS_CONFLATE</a></span></span><span class="ce">; [5]: Conflate</span></span>
<span class="l"><a class="anc" name="eaa8" href="#eaa8">[eaa8]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_DAYBREAK">TOWN_TRANSITIONS_DAYBREAK</a></span></span><span class="ce">; [6]: Daybreak</span></span>
<span class="l"><a class="anc" name="eaaa" href="#eaaa">[eaaa]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#TOWN_TRANSITIONS_EMPTY">TOWN_TRANSITIONS_EMPTY</a></span></span><span class="ce">; [7]: Evil Fortress</span></span>
<span class="l"></span>
<a name="TOWN_TRANSITIONS_APOLUNE"></a><div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::ea9e]
;
</div><span class="l"><a class="anc" name="eaac" href="#eaac">[eaac]</a><a href="#TOWN_TRANSITIONS_APOLUNE" class="la">TOWN_TRANSITIONS_APOLUNE:</a><span class="ce">; [$eaac]</span></span>
<span class="l"><a class="anc" name="eaac" href="#eaac">[eaac]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [$eaac] byte</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span></span>
<span class="l"><a class="anc" name="eaae" href="#eaae">[eaae]</a><span class="cd"><span class="i">db</span> <span class="o">$02,$92</span></span><span class="ce">; [$eaae] byte</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span></span>
<span class="l"><a class="anc" name="eab1" href="#eab1">[eab1]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; Entering Apolune from Trunk (screen 7)</span></span>
<span class="l"><a class="anc" name="eab2" href="#eab2">[eab2]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eab3" href="#eab3">[eab3]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">;   |-&gt; Screen index 0</span></span>
<span class="l"><a class="anc" name="eab4" href="#eab4">[eab4]</a><span class="cd"><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position Y=9, X=2</span></span>
<span class="l"><a class="anc" name="eab5" href="#eab5">[eab5]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eab6" href="#eab6">[eab6]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [$eab6] byte</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span></span>
<span class="l"><a class="anc" name="eab8" href="#eab8">[eab8]</a><span class="cd"><span class="i">db</span> <span class="o">$01,$9e</span></span><span class="ce">; [$eab8] byte</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span></span>
<span class="l"><a class="anc" name="eabb" href="#eabb">[eabb]</a><span class="cd"><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">; Entering Forepaw from Trunk (screen 26)</span></span>
<span class="l"><a class="anc" name="eabc" href="#eabc">[eabc]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eabd" href="#eabd">[eabd]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">;   |-&gt; Screen index 2</span></span>
<span class="l"><a class="anc" name="eabe" href="#eabe">[eabe]</a><span class="cd"><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position X=2, Y=9</span></span>
<span class="l"><a class="anc" name="eabf" href="#eabf">[eabf]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eac0" href="#eac0">[eac0]</a><span class="cd"><span class="i">db</span> <span class="o">$1d</span></span><span class="ce">; [$eac0] byte</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span></span>
<span class="l"><a class="anc" name="eac2" href="#eac2">[eac2]</a><span class="cd"><span class="i">db</span> <span class="o">$03,$9e</span></span><span class="ce">; [$eac2] byte</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span></span>
<span class="l"><a class="anc" name="eac5" href="#eac5">[eac5]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eac5] byte</span></span>
<span class="l"></span>
<a name="TOWN_TRANSITIONS_MASCON"></a><div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa2]
;
</div><span class="l"><a class="anc" name="eac6" href="#eac6">[eac6]</a><a href="#TOWN_TRANSITIONS_MASCON" class="la">TOWN_TRANSITIONS_MASCON:</a><span class="ce">; [$eac6]</span></span>
<span class="l"><a class="anc" name="eac6" href="#eac6">[eac6]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; Exiting left from Apolune screen 0</span></span>
<span class="l"><a class="anc" name="eac7" href="#eac7">[eac7]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 1</span></span>
<span class="l"><a class="anc" name="eac8" href="#eac8">[eac8]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">;   |-&gt; Screen index 6</span></span>
<span class="l"><a class="anc" name="eac9" href="#eac9">[eac9]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position Y=7, X=14</span></span>
<span class="l"><a class="anc" name="eaca" href="#eaca">[eaca]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   '-&gt; Palette 6</span></span>
<span class="l"><a class="anc" name="eacb" href="#eacb">[eacb]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; Exit right from Apolune screen 1</span></span>
<span class="l"><a class="anc" name="eacc" href="#eacc">[eacc]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 1</span></span>
<span class="l"><a class="anc" name="eacd" href="#eacd">[eacd]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">;   |-&gt; Screen index 8</span></span>
<span class="l"><a class="anc" name="eace" href="#eace">[eace]</a><span class="cd"><span class="i">db</span> <span class="o">$71</span></span><span class="ce">;   |-&gt; Start position Y=7, X=1</span></span>
<span class="l"><a class="anc" name="eacf" href="#eacf">[eacf]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   '-&gt; Palette 6</span></span>
<span class="l"><a class="anc" name="ead0" href="#ead0">[ead0]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; Exiting left from Forepaw to Trunk (screen 2)</span></span>
<span class="l"><a class="anc" name="ead1" href="#ead1">[ead1]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 1</span></span>
<span class="l"><a class="anc" name="ead2" href="#ead2">[ead2]</a><span class="cd"><span class="i">db</span> <span class="o">$1a</span></span><span class="ce">;   |-&gt; Screen index 26</span></span>
<span class="l"><a class="anc" name="ead3" href="#ead3">[ead3]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><a class="anc" name="ead4" href="#ead4">[ead4]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   '-&gt; Palette 6</span></span>
<span class="l"><a class="anc" name="ead5" href="#ead5">[ead5]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; Exiting right from Forepaw to Branch (screen 3)</span></span>
<span class="l"><a class="anc" name="ead6" href="#ead6">[ead6]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_APOLUNE</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="ead7" href="#ead7">[ead7]</a><span class="cd"><span class="i">db</span> <span class="o">$1d</span></span><span class="ce">;   |-&gt; Screen index 29</span></span>
<span class="l"><a class="anc" name="ead8" href="#ead8">[ead8]</a><span class="cd"><span class="i">db</span> <span class="o">$71</span></span><span class="ce">;   |-&gt; Start position X=1, Y=7</span></span>
<span class="l"><a class="anc" name="ead9" href="#ead9">[ead9]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_OUTSIDE</span></span><span class="ce">;   |-&gt; Palette 6</span></span>
<span class="l"><a class="anc" name="eada" href="#eada">[eada]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; Exiting left from Mascon to Mist (screen 4)</span></span>
<span class="l"><a class="anc" name="eadb" href="#eadb">[eadb]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 2</span></span>
<span class="l"><a class="anc" name="eadc" href="#eadc">[eadc]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">;   |-&gt; Screen index 9</span></span>
<span class="l"><a class="anc" name="eadd" href="#eadd">[eadd]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><a class="anc" name="eade" href="#eade">[eade]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><a class="anc" name="eadf" href="#eadf">[eadf]</a><span class="cd"><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; Exiting right from Mascon to Mist (screen 5)</span></span>
<span class="l"><a class="anc" name="eae0" href="#eae0">[eae0]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 2</span></span>
<span class="l"><a class="anc" name="eae1" href="#eae1">[eae1]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">;   |-&gt; Screen index 12</span></span>
<span class="l"><a class="anc" name="eae2" href="#eae2">[eae2]</a><span class="cd"><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><a class="anc" name="eae3" href="#eae3">[eae3]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><a class="anc" name="eae4" href="#eae4">[eae4]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; Exit left from Victim to Mist from screen 6</span></span>
<span class="l"><a class="anc" name="eae5" href="#eae5">[eae5]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 2</span></span>
<span class="l"><a class="anc" name="eae6" href="#eae6">[eae6]</a><span class="cd"><span class="i">db</span> <span class="o">$22</span></span><span class="ce">;   |-&gt; Screen index 34</span></span>
<span class="l"><a class="anc" name="eae7" href="#eae7">[eae7]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><a class="anc" name="eae8" href="#eae8">[eae8]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><a class="anc" name="eae9" href="#eae9">[eae9]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; Exit right from Victim to Mist on screen 7</span></span>
<span class="l"><a class="anc" name="eaea" href="#eaea">[eaea]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_FOREPAW</span></span><span class="ce">;   |-&gt; Switch to area 7</span></span>
<span class="l"><a class="anc" name="eaeb" href="#eaeb">[eaeb]</a><span class="cd"><span class="i">db</span> <span class="o">$25</span></span><span class="ce">;   |-&gt; Screen index = 37</span></span>
<span class="l"><a class="anc" name="eaec" href="#eaec">[eaec]</a><span class="cd"><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><a class="anc" name="eaed" href="#eaed">[eaed]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_MIST</span></span><span class="ce">;   '-&gt; Palette 10</span></span>
<span class="l"><a class="anc" name="eaee" href="#eaee">[eaee]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; Exit left from Conflate to Branch</span></span>
<span class="l"><a class="anc" name="eaef" href="#eaef">[eaef]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">;   |-&gt; Switch to area 5</span></span>
<span class="l"><a class="anc" name="eaf0" href="#eaf0">[eaf0]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">;   |-&gt; Screen index 13</span></span>
<span class="l"><a class="anc" name="eaf1" href="#eaf1">[eaf1]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><a class="anc" name="eaf2" href="#eaf2">[eaf2]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">;   '-&gt; Palette 8</span></span>
<span class="l"><a class="anc" name="eaf3" href="#eaf3">[eaf3]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; Exit left from Daybreak to Branch</span></span>
<span class="l"><a class="anc" name="eaf4" href="#eaf4">[eaf4]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">;   |-&gt; Switch to area 5</span></span>
<span class="l"><a class="anc" name="eaf5" href="#eaf5">[eaf5]</a><span class="cd"><span class="i">db</span> <span class="o">$23</span></span><span class="ce">;   |-&gt; Screen index 35</span></span>
<span class="l"><a class="anc" name="eaf6" href="#eaf6">[eaf6]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><a class="anc" name="eaf7" href="#eaf7">[eaf7]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">;   '-&gt; Palette 8</span></span>
<span class="l"><a class="anc" name="eaf8" href="#eaf8">[eaf8]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; Exit right from Daybreak to Branch</span></span>
<span class="l"><a class="anc" name="eaf9" href="#eaf9">[eaf9]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_CONFLATE</span></span><span class="ce">;   |-&gt; Switch to area 5</span></span>
<span class="l"><a class="anc" name="eafa" href="#eafa">[eafa]</a><span class="cd"><span class="i">db</span> <span class="o">$24</span></span><span class="ce">;   |-&gt; Screen index 36</span></span>
<span class="l"><a class="anc" name="eafb" href="#eafb">[eafb]</a><span class="cd"><span class="i">db</span> <span class="o">$71</span></span><span class="ce">;   |-&gt; Start position X=1, Y=7</span></span>
<span class="l"><a class="anc" name="eafc" href="#eafc">[eafc]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_BRANCH</span></span><span class="ce">;   '-&gt; Palette 8</span></span>
<span class="l"><a class="anc" name="eafd" href="#eafd">[eafd]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; Exit left from Dartmoor to Branch (screen 12)</span></span>
<span class="l"><a class="anc" name="eafe" href="#eafe">[eafe]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_DAYBREAK</span></span><span class="ce">;   |-&gt; Switch to area 6</span></span>
<span class="l"><a class="anc" name="eaff" href="#eaff">[eaff]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">;   |-&gt; Screen index 3</span></span>
<span class="l"><a class="anc" name="eb00" href="#eb00">[eb00]</a><span class="cd"><span class="i">db</span> <span class="o">$7e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=7</span></span>
<span class="l"><a class="anc" name="eb01" href="#eb01">[eb01]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_DARTMOOR</span></span><span class="ce">;   '-&gt; Palette 12</span></span>
<span class="l"><a class="anc" name="eb02" href="#eb02">[eb02]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb02] byte</span></span>
<span class="l"></span>
<a name="TOWN_TRANSITIONS_FOREPAW"></a><div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa0]
;
</div><span class="l"><a class="anc" name="eb03" href="#eb03">[eb03]</a><a href="#TOWN_TRANSITIONS_FOREPAW" class="la">TOWN_TRANSITIONS_FOREPAW:</a><span class="ce">; [$eb03]</span></span>
<span class="l"><a class="anc" name="eb03" href="#eb03">[eb03]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; Entering Mascon from Mist (screen 9)</span></span>
<span class="l"><a class="anc" name="eb04" href="#eb04">[eb04]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb05" href="#eb05">[eb05]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">;   |-&gt; Screen index 4</span></span>
<span class="l"><a class="anc" name="eb06" href="#eb06">[eb06]</a><span class="cd"><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><a class="anc" name="eb07" href="#eb07">[eb07]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb08" href="#eb08">[eb08]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; Entering left to Mascon from Mist</span></span>
<span class="l"><a class="anc" name="eb09" href="#eb09">[eb09]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb0a" href="#eb0a">[eb0a]</a><span class="cd"><span class="i">db</span> <span class="o">$05</span></span><span class="ce">;   |-&gt; Screen index 5</span></span>
<span class="l"><a class="anc" name="eb0b" href="#eb0b">[eb0b]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><a class="anc" name="eb0c" href="#eb0c">[eb0c]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb0d" href="#eb0d">[eb0d]</a><span class="cd"><span class="i">db</span> <span class="o">$22</span></span><span class="ce">; Enering right to Victim from Mist (screen 34)</span></span>
<span class="l"><a class="anc" name="eb0e" href="#eb0e">[eb0e]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb0f" href="#eb0f">[eb0f]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">;   |-&gt; Screen index 6</span></span>
<span class="l"><a class="anc" name="eb10" href="#eb10">[eb10]</a><span class="cd"><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><a class="anc" name="eb11" href="#eb11">[eb11]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb12" href="#eb12">[eb12]</a><span class="cd"><span class="i">db</span> <span class="o">$25</span></span><span class="ce">; Entering left to Victim from Mist (screen 37)</span></span>
<span class="l"><a class="anc" name="eb13" href="#eb13">[eb13]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb14" href="#eb14">[eb14]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">;   |-&gt; Screen index 7</span></span>
<span class="l"><a class="anc" name="eb15" href="#eb15">[eb15]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><a class="anc" name="eb16" href="#eb16">[eb16]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb17" href="#eb17">[eb17]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb17] byte</span></span>
<span class="l"></span>
<a name="TOWN_TRANSITIONS_CONFLATE"></a><div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa6]
;
</div><span class="l"><a class="anc" name="eb18" href="#eb18">[eb18]</a><a href="#TOWN_TRANSITIONS_CONFLATE" class="la">TOWN_TRANSITIONS_CONFLATE:</a><span class="ce">; [$eb18]</span></span>
<span class="l"><a class="anc" name="eb18" href="#eb18">[eb18]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; Entering right to Conflate from Branch (screen 13)</span></span>
<span class="l"><a class="anc" name="eb19" href="#eb19">[eb19]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb1a" href="#eb1a">[eb1a]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">;   |-&gt; Screen index 8</span></span>
<span class="l"><a class="anc" name="eb1b" href="#eb1b">[eb1b]</a><span class="cd"><span class="i">db</span> <span class="o">$91</span></span><span class="ce">;   |-&gt; Start position X=1, Y=9</span></span>
<span class="l"><a class="anc" name="eb1c" href="#eb1c">[eb1c]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb1d" href="#eb1d">[eb1d]</a><span class="cd"><span class="i">db</span> <span class="o">$23</span></span><span class="ce">; Entering Daybreak from Branch (screen 35)</span></span>
<span class="l"><a class="anc" name="eb1e" href="#eb1e">[eb1e]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb1f" href="#eb1f">[eb1f]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">;   |-&gt; Screen index 10</span></span>
<span class="l"><a class="anc" name="eb20" href="#eb20">[eb20]</a><span class="cd"><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position X=2, Y=9</span></span>
<span class="l"><a class="anc" name="eb21" href="#eb21">[eb21]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb22" href="#eb22">[eb22]</a><span class="cd"><span class="i">db</span> <span class="o">$24</span></span><span class="ce">; Entering Daybreak from Branch (screen 36)</span></span>
<span class="l"><a class="anc" name="eb23" href="#eb23">[eb23]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb24" href="#eb24">[eb24]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">;   |-&gt; Screen index 11</span></span>
<span class="l"><a class="anc" name="eb25" href="#eb25">[eb25]</a><span class="cd"><span class="i">db</span> <span class="o">$9e</span></span><span class="ce">;   |-&gt; Start position X=14, Y=9</span></span>
<span class="l"><a class="anc" name="eb26" href="#eb26">[eb26]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb27" href="#eb27">[eb27]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb27] byte</span></span>
<span class="l"></span>
<a name="TOWN_TRANSITIONS_DAYBREAK"></a><div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa8]
;
</div><span class="l"><a class="anc" name="eb28" href="#eb28">[eb28]</a><a href="#TOWN_TRANSITIONS_DAYBREAK" class="la">TOWN_TRANSITIONS_DAYBREAK:</a><span class="ce">; [$eb28]</span></span>
<span class="l"><a class="anc" name="eb28" href="#eb28">[eb28]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; Entering right to Dartmoor from Branch (screen 3)</span></span>
<span class="l"><a class="anc" name="eb29" href="#eb29">[eb29]</a><span class="cd"><span class="i">db</span> <span class="o">AREA_MASCON</span></span><span class="ce">;   |-&gt; Switch to area 3</span></span>
<span class="l"><a class="anc" name="eb2a" href="#eb2a">[eb2a]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">;   |-&gt; Screen index 12</span></span>
<span class="l"><a class="anc" name="eb2b" href="#eb2b">[eb2b]</a><span class="cd"><span class="i">db</span> <span class="o">$92</span></span><span class="ce">;   |-&gt; Start position X=2, Y=9</span></span>
<span class="l"><a class="anc" name="eb2c" href="#eb2c">[eb2c]</a><span class="cd"><span class="i">db</span> <span class="o">PALETTE_TOWN</span></span><span class="ce">;   '-&gt; Palette 27</span></span>
<span class="l"><a class="anc" name="eb2d" href="#eb2d">[eb2d]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb2d] byte</span></span>
<span class="l"></span>
<a name="TOWN_TRANSITIONS_EMPTY"></a><div class="c">;
; XREFS:
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::ea9c]
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaa4]
;     <a href="#AREA_TOWN_TRANSITIONS_DATA">AREA_TOWN_TRANSITIONS_DATA</a>
;     [$PRG15_MIRROR::eaaa]
;
</div><span class="l"><a class="anc" name="eb2e" href="#eb2e">[eb2e]</a><a href="#TOWN_TRANSITIONS_EMPTY" class="la">TOWN_TRANSITIONS_EMPTY:</a><span class="ce">; [$eb2e]</span></span>
<span class="l"><a class="anc" name="eb2e" href="#eb2e">[eb2e]</a><span class="cd"><span class="i">db</span> <span class="o">$ff</span></span><span class="ce">; [$eb2e] byte</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_RunDoorRequirementHandler"></a><div class="cp">;============================================================================
; Run the door requirement handler function for the current door.
;
; This will look up the door requirement handler function
; corresponding to <a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a> and run it,
; checking that the requirements for the door have been met.
; The Checks and behavior are entirely up to that function.
;
; INPUTS:
;     <a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a>:
;         The key requirement for the current door.
;
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>:
;         The lookup table of door requirement handlers.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#Player_CheckHandleEnterDoor">Player_CheckHandleEnterDoor</a>
;     <a href="#Player_EnterDoorToOutside">Player_EnterDoorToOutside</a>
;============================================================================
</div><span class="l"><a class="anc" name="eb2f" href="#eb2f">[eb2f]</a><a href="#Game_RunDoorRequirementHandler" class="la">Game_RunDoorRequirementHandler:</a><span class="ce">; [$eb2f]</span></span>
<span class="l"><a class="anc" name="eb2f" href="#eb2f">[eb2f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><a class="anc" name="eb32" href="#eb32">[eb32]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="eb34" href="#eb34">[eb34]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="eb35" href="#eb35">[eb35]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="eb36" href="#eb36">[eb36]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>+1,Y</span></span></span>
<span class="l"><a class="anc" name="eb39" href="#eb39">[eb39]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="eb3a" href="#eb3a">[eb3a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>,Y</span></span></span>
<span class="l"><a class="anc" name="eb3d" href="#eb3d">[eb3d]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"></span>
<a name=":eb3e:@_return"></a><span class="l"><a class="anc" name="eb3e" href="#eb3e">[eb3e]</a><a href="#:eb3e:@_return" class="lla">@_return:</a><span class="ce">; [$eb3e]</span></span>
<span class="l"><a class="anc" name="eb3e" href="#eb3e">[eb3e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS"></a><div class="cp">;============================================================================
; A mapping of door requirement lookup function addresses.
;
; XREFS:
;     <a href="#Game_RunDoorRequirementHandler">Game_RunDoorRequirementHandler</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Game_RunDoorRequirementHandler">Game_RunDoorRequirementHandler</a>
;
</div><span class="l"><a class="anc" name="eb3f" href="#eb3f">[eb3f]</a><a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS" class="la">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS:</a><span class="ce">; [$eb3f]</span></span>
<span class="l"><a class="anc" name="eb3f" href="#eb3f">[eb3f]</a><span class="cd"><span class="i">db</span> <span class="o">$3d</span></span><span class="ce">; [0]: No key, return</span></span>
<span class="l"></span>
<a name="DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS_0__1"></a><div class="c">;
; XREFS:
;     <a href="#Game_RunDoorRequirementHandler">Game_RunDoorRequirementHandler</a>
;
</div><span class="l"><a class="anc" name="eb40" href="#eb40">[eb40]</a><a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS_0__1" class="la">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS_0__1:</a><span class="ce">; [$eb40]</span></span>
<span class="l"><a class="anc" name="eb40" href="#eb40">[eb40]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="eb41" href="#eb41">[eb41]</a><span class="cd"><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [1]: "A" Key</span></span>
<span class="l"><a class="anc" name="eb42" href="#eb42">[eb42]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="eb43" href="#eb43">[eb43]</a><span class="cd"><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [2]: "K" Key</span></span>
<span class="l"><a class="anc" name="eb44" href="#eb44">[eb44]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="eb45" href="#eb45">[eb45]</a><span class="cd"><span class="i">db</span> <span class="o">$70</span></span><span class="ce">; [3]: "Q" Key</span></span>
<span class="l"><a class="anc" name="eb46" href="#eb46">[eb46]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="eb47" href="#eb47">[eb47]</a><span class="cd"><span class="i">db</span> <span class="o">$80</span></span><span class="ce">; [4]: "J" Key</span></span>
<span class="l"><a class="anc" name="eb48" href="#eb48">[eb48]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="eb49" href="#eb49">[eb49]</a><span class="cd"><span class="i">db</span> <span class="o">$90</span></span><span class="ce">; [5]: "Jo" Key</span></span>
<span class="l"><a class="anc" name="eb4a" href="#eb4a">[eb4a]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="eb4b" href="#eb4b">[eb4b]</a><span class="cd"><span class="i">db</span> <span class="o">$a0</span></span><span class="ce">; [6]: Ring of Elf</span></span>
<span class="l"><a class="anc" name="eb4c" href="#eb4c">[eb4c]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="eb4d" href="#eb4d">[eb4d]</a><span class="cd"><span class="i">db</span> <span class="o">$b0</span></span><span class="ce">; [7]: Ring of Dworf</span></span>
<span class="l"><a class="anc" name="eb4e" href="#eb4e">[eb4e]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="eb4f" href="#eb4f">[eb4f]</a><span class="cd"><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [8]: Demon's Ring</span></span>
<span class="l"><a class="anc" name="eb50" href="#eb50">[eb50]</a><span class="cd"><span class="i">db</span> <span class="o">$eb</span></span><span class="ce">; [8]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithAKey"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the "A" Key.
;
; This will check if the player has the "A" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb41]
;============================================================================
</div><span class="l"><a class="anc" name="eb51" href="#eb51">[eb51]</a><a href="#Game_OpenDoorWithAKey" class="la">Game_OpenDoorWithAKey:</a><span class="ce">; [$eb51]</span></span>
<span class="l"><a class="anc" name="eb51" href="#eb51">[eb51]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="eb54" href="#eb54">[eb54]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this the "A" Key?</span></span>
<span class="l"><a class="anc" name="eb56" href="#eb56">[eb56]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7D (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="eb58" href="#eb58">[eb58]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7d</span></span><span class="ce">; 0x7D == "A" Key required IScript.</span></span>
<span class="l"><a class="anc" name="eb5a" href="#eb5a">[eb5a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="eb5d" href="#eb5d">[eb5d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="eb5e" href="#eb5e">[eb5e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":eb60:@_afterFarJump"></a><span class="l"><a class="anc" name="eb60" href="#eb60">[eb60]</a><a href="#:eb60:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb60]</span></span>
<span class="l"><a class="anc" name="eb60" href="#eb60">[eb60]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithKKey"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the "K" Key.
;
; This will check if the player has the "K" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb43]
;============================================================================
</div><span class="l"><a class="anc" name="eb61" href="#eb61">[eb61]</a><a href="#Game_OpenDoorWithKKey" class="la">Game_OpenDoorWithKKey:</a><span class="ce">; [$eb61]</span></span>
<span class="l"><a class="anc" name="eb61" href="#eb61">[eb61]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="eb64" href="#eb64">[eb64]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$05</span></span><span class="ce">; Is this the "K" Key?</span></span>
<span class="l"><a class="anc" name="eb66" href="#eb66">[eb66]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7C (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="eb68" href="#eb68">[eb68]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7c</span></span><span class="ce">; 0x7C == "K" Key required IScript.</span></span>
<span class="l"><a class="anc" name="eb6a" href="#eb6a">[eb6a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="eb6d" href="#eb6d">[eb6d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="eb6e" href="#eb6e">[eb6e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":eb70:@_afterFarJump"></a><span class="l"><a class="anc" name="eb70" href="#eb70">[eb70]</a><a href="#:eb70:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb70]</span></span>
<span class="l"><a class="anc" name="eb70" href="#eb70">[eb70]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithQKey"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the "Q" Key.
;
; This will check if the player has the "Q" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb45]
;============================================================================
</div><span class="l"><a class="anc" name="eb71" href="#eb71">[eb71]</a><a href="#Game_OpenDoorWithQKey" class="la">Game_OpenDoorWithQKey:</a><span class="ce">; [$eb71]</span></span>
<span class="l"><a class="anc" name="eb71" href="#eb71">[eb71]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="eb74" href="#eb74">[eb74]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is this the "Q" Key?</span></span>
<span class="l"><a class="anc" name="eb76" href="#eb76">[eb76]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7B (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="eb78" href="#eb78">[eb78]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7b</span></span><span class="ce">; 0x7B == "Q" Key required IScript.</span></span>
<span class="l"><a class="anc" name="eb7a" href="#eb7a">[eb7a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="eb7d" href="#eb7d">[eb7d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="eb7e" href="#eb7e">[eb7e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":eb80:@_afterFarJump"></a><span class="l"><a class="anc" name="eb80" href="#eb80">[eb80]</a><a href="#:eb80:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb80]</span></span>
<span class="l"><a class="anc" name="eb80" href="#eb80">[eb80]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithJKey"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the "J" Key.
;
; This will check if the player has the "J" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb47]
;============================================================================
</div><span class="l"><a class="anc" name="eb81" href="#eb81">[eb81]</a><a href="#Game_OpenDoorWithJKey" class="la">Game_OpenDoorWithJKey:</a><span class="ce">; [$eb81]</span></span>
<span class="l"><a class="anc" name="eb81" href="#eb81">[eb81]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="eb84" href="#eb84">[eb84]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Is this the "J" Key?</span></span>
<span class="l"><a class="anc" name="eb86" href="#eb86">[eb86]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7 (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="eb88" href="#eb88">[eb88]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span><span class="ce">; 0x02 == "J" Key required IScript.</span></span>
<span class="l"><a class="anc" name="eb8a" href="#eb8a">[eb8a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="eb8d" href="#eb8d">[eb8d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="eb8e" href="#eb8e">[eb8e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":eb90:@_afterFarJump"></a><span class="l"><a class="anc" name="eb90" href="#eb90">[eb90]</a><a href="#:eb90:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eb90]</span></span>
<span class="l"><a class="anc" name="eb90" href="#eb90">[eb90]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithJoKey"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the "Jo" Key.
;
; This will check if the player has the "Jo" Key, and
; if they do, the door will be unlocked and entered.
; The key will be consumed.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb49]
;============================================================================
</div><span class="l"><a class="anc" name="eb91" href="#eb91">[eb91]</a><a href="#Game_OpenDoorWithJoKey" class="la">Game_OpenDoorWithJoKey:</a><span class="ce">; [$eb91]</span></span>
<span class="l"><a class="anc" name="eb91" href="#eb91">[eb91]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span><span class="ce">; Load the selected item.</span></span>
<span class="l"><a class="anc" name="eb94" href="#eb94">[eb94]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$08</span></span><span class="ce">; Is this the "Jo" Key?</span></span>
<span class="l"><a class="anc" name="eb96" href="#eb96">[eb96]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7E (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="eb98" href="#eb98">[eb98]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7e</span></span><span class="ce">; 0x7E == "Jo" Key required IScript.</span></span>
<span class="l"><a class="anc" name="eb9a" href="#eb9a">[eb9a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="eb9d" href="#eb9d">[eb9d]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="eb9e" href="#eb9e">[eb9e]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":eba0:@_afterFarJump"></a><span class="l"><a class="anc" name="eba0" href="#eba0">[eba0]</a><a href="#:eba0:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$eba0]</span></span>
<span class="l"><a class="anc" name="eba0" href="#eba0">[eba0]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithRingOfElf"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the Ring of Elf.
;
; This will check if the player has the Ring of Elf, and
; if they do, the door will be unlocked and entered.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb4b]
;============================================================================
</div><span class="l"><a class="anc" name="eba1" href="#eba1">[eba1]</a><a href="#Game_OpenDoorWithRingOfElf" class="la">Game_OpenDoorWithRingOfElf:</a><span class="ce">; [$eba1]</span></span>
<span class="l"><a class="anc" name="eba1" href="#eba1">[eba1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><a class="anc" name="eba4" href="#eba4">[eba4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$80</span></span><span class="ce">; Does the player have the Ring of Elf?</span></span>
<span class="l"><a class="anc" name="eba6" href="#eba6">[eba6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Game_UnlockDoor">Game_UnlockDoor</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7F (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="eba8" href="#eba8">[eba8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == Ring required IScript.</span></span>
<span class="l"><a class="anc" name="ebaa" href="#ebaa">[ebaa]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="ebad" href="#ebad">[ebad]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="ebae" href="#ebae">[ebae]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":ebb0:@_afterFarJump"></a><span class="l"><a class="anc" name="ebb0" href="#ebb0">[ebb0]</a><a href="#:ebb0:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebb0]</span></span>
<span class="l"><a class="anc" name="ebb0" href="#ebb0">[ebb0]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithRingOfDworf"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the Ring of Dworf.
;
; This will check if the player has the Ring of Dworf, and
; if they do, the door will be unlocked and entered.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb4d]
;============================================================================
</div><span class="l"><a class="anc" name="ebb1" href="#ebb1">[ebb1]</a><a href="#Game_OpenDoorWithRingOfDworf" class="la">Game_OpenDoorWithRingOfDworf:</a><span class="ce">; [$ebb1]</span></span>
<span class="l"><a class="anc" name="ebb1" href="#ebb1">[ebb1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><a class="anc" name="ebb4" href="#ebb4">[ebb4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Does the player have the Ring of Dworf?</span></span>
<span class="l"><a class="anc" name="ebb6" href="#ebb6">[ebb6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Game_UnlockDoor">Game_UnlockDoor</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7F (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="ebb8" href="#ebb8">[ebb8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == Ring required IScript.</span></span>
<span class="l"><a class="anc" name="ebba" href="#ebba">[ebba]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="ebbd" href="#ebbd">[ebbd]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="ebbe" href="#ebbe">[ebbe]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":ebc0:@_afterFarJump"></a><span class="l"><a class="anc" name="ebc0" href="#ebc0">[ebc0]</a><a href="#:ebc0:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebc0]</span></span>
<span class="l"><a class="anc" name="ebc0" href="#ebc0">[ebc0]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_OpenDoorWithDemonsRing"></a><div class="cp">;============================================================================
; Attempt to open a door marked with the Demon's Ring.
;
; This will check if the player has the Demon's Ring, and
; if they do, the door will be unlocked and entered.
;
; If the door can't be unlocked, a message will be
; displayed.
;
; INPUTS:
;     <a href="RAM.html#SelectedItem">SelectedItem</a>:
;         The selected item.
;
; CALLS:
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;
; XREFS:
;     <a href="#DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS">DOOR_REQUIREMENT_LOOKUP_FUNC_ADDRS</a>
;     [$PRG15_MIRROR::eb4f]
;============================================================================
</div><span class="l"><a class="anc" name="ebc1" href="#ebc1">[ebc1]</a><a href="#Game_OpenDoorWithDemonsRing" class="la">Game_OpenDoorWithDemonsRing:</a><span class="ce">; [$ebc1]</span></span>
<span class="l"><a class="anc" name="ebc1" href="#ebc1">[ebc1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SpecialItems">SpecialItems</a></span></span><span class="ce">; Load the special items.</span></span>
<span class="l"><a class="anc" name="ebc4" href="#ebc4">[ebc4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Does the player have the Demon's Ring?</span></span>
<span class="l"><a class="anc" name="ebc6" href="#ebc6">[ebc6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#Game_UnlockDoor">Game_UnlockDoor</a></span></span><span class="ce">; If so, unlock the door and enter.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Run IScript 0x7F (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="ebc8" href="#ebc8">[ebc8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$7f</span></span><span class="ce">; 0x7F == Ring required IScript.</span></span>
<span class="l"><a class="anc" name="ebca" href="#ebca">[ebca]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="ebcd" href="#ebcd">[ebcd]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="ebce" href="#ebce">[ebce]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":ebd0:@_afterFarJump"></a><span class="l"><a class="anc" name="ebd0" href="#ebd0">[ebd0]</a><a href="#:ebd0:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebd0]</span></span>
<span class="l"><a class="anc" name="ebd0" href="#ebd0">[ebd0]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Game_UnlockDoorWithUsableItem"></a><div class="cp">;============================================================================
; TODO: Document Game_UnlockDoorWithUsableItem
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_OpenDoorWithAKey">Game_OpenDoorWithAKey</a>
;     <a href="#Game_OpenDoorWithJKey">Game_OpenDoorWithJKey</a>
;     <a href="#Game_OpenDoorWithJoKey">Game_OpenDoorWithJoKey</a>
;     <a href="#Game_OpenDoorWithKKey">Game_OpenDoorWithKKey</a>
;     <a href="#Game_OpenDoorWithQKey">Game_OpenDoorWithQKey</a>
;============================================================================
</div><span class="l"><a class="anc" name="ebd1" href="#ebd1">[ebd1]</a><a href="#Game_UnlockDoorWithUsableItem" class="la">Game_UnlockDoorWithUsableItem:</a><span class="ce">; [$ebd1]</span></span>
<div class="c">;
; Run IScript 0x84 (via jump to <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>).
;
</div><span class="l"><a class="anc" name="ebd1" href="#ebd1">[ebd1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$84</span></span><span class="ce">; 0x84 == Used key IScript.</span></span>
<span class="l"><a class="anc" name="ebd3" href="#ebd3">[ebd3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Run the IScript:</span></span>
<span class="l"><a class="anc" name="ebd6" href="#ebd6">[ebd6]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="ebd7" href="#ebd7">[ebd7]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a></span></span>
<span class="l"></span>
<a name=":ebd9:@_afterFarJump"></a><span class="l"><a class="anc" name="ebd9" href="#ebd9">[ebd9]</a><a href="#:ebd9:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$ebd9]</span></span>
<span class="l"><a class="anc" name="ebd9" href="#ebd9">[ebd9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ebdb" href="#ebdb">[ebdb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span></span>
<span class="l"><a class="anc" name="ebde" href="#ebde">[ebde]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_ClearSelectedItemPic">UI_ClearSelectedItemPic</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Game_UnlockDoor"></a><div class="cp">;============================================================================
; TODO: Document Game_UnlockDoor
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Game_OpenDoorWithDemonsRing">Game_OpenDoorWithDemonsRing</a>
;     <a href="#Game_OpenDoorWithRingOfDworf">Game_OpenDoorWithRingOfDworf</a>
;     <a href="#Game_OpenDoorWithRingOfElf">Game_OpenDoorWithRingOfElf</a>
;============================================================================
</div><span class="l"><a class="anc" name="ebe1" href="#ebe1">[ebe1]</a><a href="#Game_UnlockDoor" class="la">Game_UnlockDoor:</a><span class="ce">; [$ebe1]</span></span>
<span class="l"><a class="anc" name="ebe1" href="#ebe1">[ebe1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ebe3" href="#ebe3">[ebe3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentDoor_KeyRequirement">CurrentDoor_KeyRequirement</a></span></span></span>
<span class="l"><a class="anc" name="ebe6" href="#ebe6">[ebe6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$84</span></span></span>
<span class="l"><a class="anc" name="ebe8" href="#ebe8">[ebe8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$06</span></span></span>
<span class="l"><a class="anc" name="ebea" href="#ebea">[ebea]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span></span>
<span class="l"><a class="anc" name="ebed" href="#ebed">[ebed]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_DrawBody"></a><div class="cp">;============================================================================
; TODO: Document Player_DrawBody
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;============================================================================
</div><span class="l"><a class="anc" name="ebee" href="#ebee">[ebee]</a><a href="#Player_DrawBody" class="la">Player_DrawBody:</a><span class="ce">; [$ebee]</span></span>
<span class="l"><a class="anc" name="ebee" href="#ebee">[ebee]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span></span>
<span class="l"><a class="anc" name="ebf1" href="#ebf1">[ebf1]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ebf4">@LAB_PRG15_MIRROR__ebf4</a></span></span></span>
<span class="l"><a class="anc" name="ebf3" href="#ebf3">[ebf3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ebf4:@LAB_PRG15_MIRROR__ebf4"></a><div class="c">;
; Check the loaded state for the screen to determine
; the arguments to use.
;
; NOTE: This seems to be old code. Nothing sets
; <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a> to anything but 0x00 or 0xFF.
; It appears that at some point they simplified this, which
; makes all of this dead code.
;
</div><span class="l"><a class="anc" name="ebf4" href="#ebf4">[ebf4]</a><a href="#:ebf4:@LAB_PRG15_MIRROR__ebf4" class="lla">@LAB_PRG15_MIRROR__ebf4:</a><span class="ce">; [$ebf4]</span></span>
<span class="l"><a class="anc" name="ebf4" href="#ebf4">[ebf4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a></span></span></span>
<span class="l"><a class="anc" name="ebf6" href="#ebf6">[ebf6]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="ebf8" href="#ebf8">[ebf8]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec11">@LAB_PRG15_MIRROR__ec11</a></span></span></span>
<span class="l"><a class="anc" name="ebfa" href="#ebfa">[ebfa]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="ebfc" href="#ebfc">[ebfc]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec11">@LAB_PRG15_MIRROR__ec11</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Ths code path should always be hit when this function is
; called.
;
</div><span class="l"><a class="anc" name="ebfe" href="#ebfe">[ebfe]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="ec00" href="#ec00">[ec00]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span></span>
<span class="l"><a class="anc" name="ec02" href="#ec02">[ec02]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Screen_Maybe_ScrollXCounter">Screen_Maybe_ScrollXCounter</a></span></span></span>
<span class="l"><a class="anc" name="ec04" href="#ec04">[ec04]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a></span></span></span>
<span class="l"><a class="anc" name="ec06" href="#ec06">[ec06]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="ec08" href="#ec08">[ec08]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span></span>
<span class="l"><a class="anc" name="ec0a" href="#ec0a">[ec0a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Something_ScrollPosY">Player_Something_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="ec0c" href="#ec0c">[ec0c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a></span></span></span>
<span class="l"><a class="anc" name="ec0e" href="#ec0e">[ec0e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec21">@LAB_PRG15_MIRROR__ec21</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ec11:@LAB_PRG15_MIRROR__ec11"></a><div class="c">;
; This whole section seems unreachable. <a href="RAM.html#Screen_ReadyState">Screen_ReadyState</a>
; should never reach these values. This may be dead code.
;
</div><span class="l"><a class="anc" name="ec11" href="#ec11">[ec11]</a><a href="#:ec11:@LAB_PRG15_MIRROR__ec11" class="lla">@LAB_PRG15_MIRROR__ec11:</a><span class="ce">; [$ec11]</span></span>
<span class="l"><a class="anc" name="ec11" href="#ec11">[ec11]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerX_ForScroll">Maybe_PlayerX_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="ec13" href="#ec13">[ec13]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span></span>
<span class="l"><a class="anc" name="ec15" href="#ec15">[ec15]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenHoriz">PPU_ScrollScreenHoriz</a></span></span></span>
<span class="l"><a class="anc" name="ec17" href="#ec17">[ec17]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosX">Unused_Sprite_ScrollPosX</a></span></span></span>
<span class="l"><a class="anc" name="ec19" href="#ec19">[ec19]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_PlayerY_ForScroll">Maybe_PlayerY_ForScroll</a></span></span></span>
<span class="l"><a class="anc" name="ec1b" href="#ec1b">[ec1b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span></span>
<span class="l"><a class="anc" name="ec1d" href="#ec1d">[ec1d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreenVert">PPU_ScrollScreenVert</a></span></span></span>
<span class="l"><a class="anc" name="ec1f" href="#ec1f">[ec1f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Unused_Sprite_ScrollPosY">Unused_Sprite_ScrollPosY</a></span></span></span>
<span class="l"></span>
<a name=":ec21:@LAB_PRG15_MIRROR__ec21"></a><span class="l"><a class="anc" name="ec21" href="#ec21">[ec21]</a><a href="#:ec21:@LAB_PRG15_MIRROR__ec21" class="lla">@LAB_PRG15_MIRROR__ec21:</a><span class="ce">; [$ec21]</span></span>
<span class="l"><a class="anc" name="ec21" href="#ec21">[ec21]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b9ed</span></span></span>
<span class="l"><a class="anc" name="ec24" href="#ec24">[ec24]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_SetFacingLeft">Player_SetFacingLeft</a></span></span></span>
<span class="l"><a class="anc" name="ec27" href="#ec27">[ec27]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a></span></span></span>
<span class="l"><a class="anc" name="ec2a" href="#ec2a">[ec2a]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="ec2b" href="#ec2b">[ec2b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span></span>
<span class="l"><a class="anc" name="ec2e" href="#ec2e">[ec2e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ec2f" href="#ec2f">[ec2f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="ec31" href="#ec31">[ec31]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><a class="anc" name="ec34" href="#ec34">[ec34]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="ec36" href="#ec36">[ec36]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ec38" href="#ec38">[ec38]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ec39" href="#ec39">[ec39]</a><span class="cd"><span class="i">EOR</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="ec3b" href="#ec3b">[ec3b]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="ec3d" href="#ec3d">[ec3d]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="ec3e" href="#ec3e">[ec3e]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="ec3f" href="#ec3f">[ec3f]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ec40" href="#ec40">[ec40]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#PLAYER_BODY_TILEINFO_START_OFFSETS">PLAYER_BODY_TILEINFO_START_OFFSETS</a>,X</span></span></span>
<span class="l"><a class="anc" name="ec43" href="#ec43">[ec43]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprite_SetPlayerAppearanceAddr">Sprite_SetPlayerAppearanceAddr</a></span></span></span>
<span class="l"><a class="anc" name="ec46" href="#ec46">[ec46]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a></span></span></span>
<span class="l"></span>
<a name="PLAYER_BODY_TILEINFO_START_OFFSETS"></a><div class="c">;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;
</div><span class="l"><a class="anc" name="ec49" href="#ec49">[ec49]</a><a href="#PLAYER_BODY_TILEINFO_START_OFFSETS" class="la">PLAYER_BODY_TILEINFO_START_OFFSETS:</a><span class="ce">; [$ec49]</span></span>
<span class="l"><a class="anc" name="ec49" href="#ec49">[ec49]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]: Leather Armor</span></span>
<span class="l"><a class="anc" name="ec4a" href="#ec4a">[ec4a]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]: Leather Armor + Shield</span></span>
<span class="l"><a class="anc" name="ec4b" href="#ec4b">[ec4b]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [2]: Studded Mail</span></span>
<span class="l"><a class="anc" name="ec4c" href="#ec4c">[ec4c]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [3]: Studded Mail + Shield</span></span>
<span class="l"><a class="anc" name="ec4d" href="#ec4d">[ec4d]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [4]: Full Plate</span></span>
<span class="l"><a class="anc" name="ec4e" href="#ec4e">[ec4e]</a><span class="cd"><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [5]: Full Plate + Shield</span></span>
<span class="l"><a class="anc" name="ec4f" href="#ec4f">[ec4f]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [6]: Battle Suit</span></span>
<span class="l"><a class="anc" name="ec50" href="#ec50">[ec50]</a><span class="cd"><span class="i">db</span> <span class="o">$38</span></span><span class="ce">; [7]: Battle Suit + Shield</span></span>
<span class="l"></span>
</pre><pre><a name="Player_SetFacingLeft"></a><div class="cp">;============================================================================
; TODO: Document Player_SetFacingLeft
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a class="anc" name="ec51" href="#ec51">[ec51]</a><a href="#Player_SetFacingLeft" class="la">Player_SetFacingLeft:</a><span class="ce">; [$ec51]</span></span>
<span class="l"><a class="anc" name="ec51" href="#ec51">[ec51]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ec53" href="#ec53">[ec53]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="ec55" href="#ec55">[ec55]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><a class="anc" name="ec57" href="#ec57">[ec57]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="FUN_PRG15_MIRROR__ec58"></a><div class="cp">;============================================================================
; TODO: Document FUN_PRG15_MIRROR__ec58
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a class="anc" name="ec58" href="#ec58">[ec58]</a><a href="#FUN_PRG15_MIRROR__ec58" class="la">FUN_PRG15_MIRROR__ec58:</a><span class="ce">; [$ec58]</span></span>
<span class="l"><a class="anc" name="ec58" href="#ec58">[ec58]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ec5a" href="#ec5a">[ec5a]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="ec5c" href="#ec5c">[ec5c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"><a class="anc" name="ec5e" href="#ec5e">[ec5e]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="ec60" href="#ec60">[ec60]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="ec62" href="#ec62">[ec62]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ec64" href="#ec64">[ec64]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ec66" href="#ec66">[ec66]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="ec68" href="#ec68">[ec68]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec6b">@LAB_PRG15_MIRROR__ec6b</a></span></span></span>
<span class="l"><a class="anc" name="ec6a" href="#ec6a">[ec6a]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"></span>
<a name=":ec6b:@LAB_PRG15_MIRROR__ec6b"></a><span class="l"><a class="anc" name="ec6b" href="#ec6b">[ec6b]</a><a href="#:ec6b:@LAB_PRG15_MIRROR__ec6b" class="lla">@LAB_PRG15_MIRROR__ec6b:</a><span class="ce">; [$ec6b]</span></span>
<span class="l"><a class="anc" name="ec6b" href="#ec6b">[ec6b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#@_return">@_return</a>+1,Y</span></span></span>
<span class="l"><a class="anc" name="ec6e" href="#ec6e">[ec6e]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b880</span></span></span>
<span class="l"><a class="anc" name="ec71" href="#ec71">[ec71]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="ec73" href="#ec73">[ec73]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ec74" href="#ec74">[ec74]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span></span>
<span class="l"><a class="anc" name="ec76" href="#ec76">[ec76]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span></span>
<span class="l"><a class="anc" name="ec78" href="#ec78">[ec78]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="ec7a" href="#ec7a">[ec7a]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="ec7c" href="#ec7c">[ec7c]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span></span>
<span class="l"><a class="anc" name="ec7e" href="#ec7e">[ec7e]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span></span>
<span class="l"><a class="anc" name="ec80" href="#ec80">[ec80]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosY">Player_PosY</a></span></span></span>
<span class="l"><a class="anc" name="ec82" href="#ec82">[ec82]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span></span>
<span class="l"><a class="anc" name="ec84" href="#ec84">[ec84]</a><span class="cd"><span class="i">JSR</span> <span class="o">$b9ed</span></span></span>
<span class="l"><a class="anc" name="ec87" href="#ec87">[ec87]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span></span>
<span class="l"><a class="anc" name="ec8a" href="#ec8a">[ec8a]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ec8b" href="#ec8b">[ec8b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="ec8d" href="#ec8d">[ec8d]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ec8f" href="#ec8f">[ec8f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span></span>
<span class="l"><a class="anc" name="ec92" href="#ec92">[ec92]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="ec94" href="#ec94">[ec94]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ec97">@LAB_PRG15_MIRROR__ec97</a></span></span></span>
<span class="l"><a class="anc" name="ec96" href="#ec96">[ec96]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"></span>
<a name=":ec97:@LAB_PRG15_MIRROR__ec97"></a><span class="l"><a class="anc" name="ec97" href="#ec97">[ec97]</a><a href="#:ec97:@LAB_PRG15_MIRROR__ec97" class="lla">@LAB_PRG15_MIRROR__ec97:</a><span class="ce">; [$ec97]</span></span>
<span class="l"><a class="anc" name="ec97" href="#ec97">[ec97]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="ec98" href="#ec98">[ec98]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="ec9a" href="#ec9a">[ec9a]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="ec9b" href="#ec9b">[ec9b]</a><span class="cd"><span class="i">LDA</span> <span class="o">$eca4,Y</span></span></span>
<span class="l"><a class="anc" name="ec9e" href="#ec9e">[ec9e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_SetPlayerAppearanceAddr">Sprite_SetPlayerAppearanceAddr</a></span></span></span>
<span class="l"></span>
<a name=":eca1:@_return"></a><span class="l"><a class="anc" name="eca1" href="#eca1">[eca1]</a><a href="#:eca1:@_return" class="lla">@_return:</a><span class="ce">; [$eca1]</span></span>
<span class="l"><a class="anc" name="eca1" href="#eca1">[eca1]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__eca2"></a><div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;
</div><span class="l"><a class="anc" name="eca2" href="#eca2">[eca2]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__eca2" class="la">BYTE_ARRAY_PRG15_MIRROR__eca2:</a><span class="ce">; [$eca2]</span></span>
<span class="l"><a class="anc" name="eca2" href="#eca2">[eca2]</a><span class="cd"><span class="i">db</span> <span class="o">$f8</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__eca2_1_"></a><div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;
</div><span class="l"><a class="anc" name="eca3" href="#eca3">[eca3]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__eca2_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__eca2_1_:</a><span class="ce">; [$eca3]</span></span>
<span class="l"><a class="anc" name="eca3" href="#eca3">[eca3]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__eca4"></a><div class="c">;
; XREFS:
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;
</div><span class="l"><a class="anc" name="eca4" href="#eca4">[eca4]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__eca4" class="la">BYTE_ARRAY_PRG15_MIRROR__eca4:</a><span class="ce">; [$eca4]</span></span>
<span class="l"><a class="anc" name="eca4" href="#eca4">[eca4]</a><span class="cd"><span class="i">db</span> <span class="o">$63</span></span><span class="ce">; [0]: Leather Armor</span></span>
<span class="l"><a class="anc" name="eca5" href="#eca5">[eca5]</a><span class="cd"><span class="i">db</span> <span class="o">$67</span></span><span class="ce">; [1]: Leather Armor + Shield</span></span>
<span class="l"><a class="anc" name="eca6" href="#eca6">[eca6]</a><span class="cd"><span class="i">db</span> <span class="o">$64</span></span><span class="ce">; [2]: Studded Mail</span></span>
<span class="l"><a class="anc" name="eca7" href="#eca7">[eca7]</a><span class="cd"><span class="i">db</span> <span class="o">$68</span></span><span class="ce">; [3]: Studded Mail + Shield</span></span>
<span class="l"><a class="anc" name="eca8" href="#eca8">[eca8]</a><span class="cd"><span class="i">db</span> <span class="o">$65</span></span><span class="ce">; [4]: Full Plate</span></span>
<span class="l"><a class="anc" name="eca9" href="#eca9">[eca9]</a><span class="cd"><span class="i">db</span> <span class="o">$69</span></span><span class="ce">; [5]: Full Plate + Shield</span></span>
<span class="l"><a class="anc" name="ecaa" href="#ecaa">[ecaa]</a><span class="cd"><span class="i">db</span> <span class="o">$66</span></span><span class="ce">; [6]: Battle Suit</span></span>
<span class="l"><a class="anc" name="ecab" href="#ecab">[ecab]</a><span class="cd"><span class="i">db</span> <span class="o">$6a</span></span><span class="ce">; [7]: Battle Suit + Shield</span></span>
<span class="l"></span>
</pre><pre><a name="Player_GetBodySpriteFrameOffset"></a><div class="cp">;============================================================================
; TODO: Document Player_GetBodySpriteFrameOffset
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a class="anc" name="ecac" href="#ecac">[ecac]</a><a href="#Player_GetBodySpriteFrameOffset" class="la">Player_GetBodySpriteFrameOffset:</a><span class="ce">; [$ecac]</span></span>
<span class="l"><a class="anc" name="ecac" href="#ecac">[ecac]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ecae" href="#ecae">[ecae]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ecaf" href="#ecaf">[ecaf]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecb8">@LAB_PRG15_MIRROR__ecb8</a></span></span></span>
<span class="l"><a class="anc" name="ecb1" href="#ecb1">[ecb1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ecb3" href="#ecb3">[ecb3]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__eccc">@LAB_PRG15_MIRROR__eccc</a></span></span></span>
<span class="l"><a class="anc" name="ecb5" href="#ecb5">[ecb5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="ecb7" href="#ecb7">[ecb7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":ecb8:@LAB_PRG15_MIRROR__ecb8"></a><span class="l"><a class="anc" name="ecb8" href="#ecb8">[ecb8]</a><a href="#:ecb8:@LAB_PRG15_MIRROR__ecb8" class="lla">@LAB_PRG15_MIRROR__ecb8:</a><span class="ce">; [$ecb8]</span></span>
<span class="l"><a class="anc" name="ecb8" href="#ecb8">[ecb8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_IsClimbing">Player_IsClimbing</a></span></span></span>
<span class="l"><a class="anc" name="ecbb" href="#ecbb">[ecbb]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecc8">@LAB_PRG15_MIRROR__ecc8</a></span></span></span>
<span class="l"><a class="anc" name="ecbd" href="#ecbd">[ecbd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><a class="anc" name="ecbf" href="#ecbf">[ecbf]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="ecc1" href="#ecc1">[ecc1]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ecc2" href="#ecc2">[ecc2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ecc3" href="#ecc3">[ecc3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><a class="anc" name="ecc5" href="#ecc5">[ecc5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="ecc7" href="#ecc7">[ecc7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":ecc8:@LAB_PRG15_MIRROR__ecc8"></a><span class="l"><a class="anc" name="ecc8" href="#ecc8">[ecc8]</a><a href="#:ecc8:@LAB_PRG15_MIRROR__ecc8" class="lla">@LAB_PRG15_MIRROR__ecc8:</a><span class="ce">; [$ecc8]</span></span>
<span class="l"><a class="anc" name="ecc8" href="#ecc8">[ecc8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ecca" href="#ecca">[ecca]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecd2">@LAB_PRG15_MIRROR__ecd2</a></span></span></span>
<span class="l"></span>
<a name=":eccc:@LAB_PRG15_MIRROR__eccc"></a><span class="l"><a class="anc" name="eccc" href="#eccc">[eccc]</a><a href="#:eccc:@LAB_PRG15_MIRROR__eccc" class="lla">@LAB_PRG15_MIRROR__eccc:</a><span class="ce">; [$eccc]</span></span>
<span class="l"><a class="anc" name="eccc" href="#eccc">[eccc]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#PlayerHitsPhaseCounter">PlayerHitsPhaseCounter</a></span></span></span>
<span class="l"><a class="anc" name="ecce" href="#ecce">[ecce]</a><span class="cd"><span class="i">LDA</span> <span class="o">$ecf3,X</span></span></span>
<span class="l"><a class="anc" name="ecd1" href="#ecd1">[ecd1]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":ecd2:@LAB_PRG15_MIRROR__ecd2"></a><span class="l"><a class="anc" name="ecd2" href="#ecd2">[ecd2]</a><a href="#:ecd2:@LAB_PRG15_MIRROR__ecd2" class="lla">@LAB_PRG15_MIRROR__ecd2:</a><span class="ce">; [$ecd2]</span></span>
<span class="l"><a class="anc" name="ecd2" href="#ecd2">[ecd2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_StatusFlag">Player_StatusFlag</a></span></span></span>
<span class="l"><a class="anc" name="ecd4" href="#ecd4">[ecd4]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecdd">@LAB_PRG15_MIRROR__ecdd</a></span></span></span>
<span class="l"><a class="anc" name="ecd6" href="#ecd6">[ecd6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ButtonMask">Joy1_ButtonMask</a></span></span></span>
<span class="l"><a class="anc" name="ecd8" href="#ecd8">[ecd8]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecdd">@LAB_PRG15_MIRROR__ecdd</a></span></span></span>
<span class="l"><a class="anc" name="ecda" href="#ecda">[ecda]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="ecdc" href="#ecdc">[ecdc]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":ecdd:@LAB_PRG15_MIRROR__ecdd"></a><span class="l"><a class="anc" name="ecdd" href="#ecdd">[ecdd]</a><a href="#:ecdd:@LAB_PRG15_MIRROR__ecdd" class="lla">@LAB_PRG15_MIRROR__ecdd:</a><span class="ce">; [$ecdd]</span></span>
<span class="l"><a class="anc" name="ecdd" href="#ecdd">[ecdd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span></span>
<span class="l"><a class="anc" name="ecdf" href="#ecdf">[ecdf]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="ece1" href="#ece1">[ece1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ecea">@LAB_PRG15_MIRROR__ecea</a></span></span></span>
<span class="l"><a class="anc" name="ece3" href="#ece3">[ece3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_MovementTick">Player_MovementTick</a></span></span></span>
<span class="l"><a class="anc" name="ece5" href="#ece5">[ece5]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ece6" href="#ece6">[ece6]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ece7" href="#ece7">[ece7]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="ece8" href="#ece8">[ece8]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<a name=":ecea:@LAB_PRG15_MIRROR__ecea"></a><span class="l"><a class="anc" name="ecea" href="#ecea">[ecea]</a><a href="#:ecea:@LAB_PRG15_MIRROR__ecea" class="lla">@LAB_PRG15_MIRROR__ecea:</a><span class="ce">; [$ecea]</span></span>
<span class="l"><a class="anc" name="ecea" href="#ecea">[ecea]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="eceb" href="#eceb">[eceb]</a><span class="cd"><span class="i">LDA</span> <span class="o">$ecef,X</span></span></span>
<span class="l"><a class="anc" name="ecee" href="#ecee">[ecee]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__ecef"></a><div class="c">;
; XREFS:
;     <a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a>
;
</div><span class="l"><a class="anc" name="ecef" href="#ecef">[ecef]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__ecef" class="la">BYTE_ARRAY_PRG15_MIRROR__ecef:</a><span class="ce">; [$ecef]</span></span>
<span class="l"><a class="anc" name="ecef" href="#ecef">[ecef]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="ecf0" href="#ecf0">[ecf0]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="ecf1" href="#ecf1">[ecf1]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="ecf2" href="#ecf2">[ecf2]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [3]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__ecf3"></a><div class="c">;
; XREFS:
;     <a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a>
;
</div><span class="l"><a class="anc" name="ecf3" href="#ecf3">[ecf3]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__ecf3" class="la">BYTE_ARRAY_PRG15_MIRROR__ecf3:</a><span class="ce">; [$ecf3]</span></span>
<span class="l"><a class="anc" name="ecf3" href="#ecf3">[ecf3]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="ecf4" href="#ecf4">[ecf4]</a><span class="cd"><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="ecf5" href="#ecf5">[ecf5]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_IsClimbing"></a><div class="cp">;============================================================================
; Return whether the player is climbing a ladder.
;
; This will depend on the following conditions:
;
; 1. Whether the player is in front of a ladder.
;
; 2. Whether the player is either:
;
;    1. Directly on a ladder block, or
;
;    2. Not falling off the ladder.
;
; 3. Whether the climbing bit is set.
;
; INPUTS:
;     <a href="RAM.html#Player_Flags">Player_Flags</a>:
;         The player's current flags.
;
;     <a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a>:
;         The full X position of the player.
;
; OUTPUTS:
;     C:
;         1 if the player is climbing.
;         0 if the player is not.
;
; XREFS:
;     <a href="PRG14.html#Player_CastMagic">Player_CastMagic</a>
;     <a href="#Player_CheckHandleAttack">Player_CheckHandleAttack</a>
;     <a href="#Player_ContinueHandleClimbOrJump">Player_ContinueHandleClimbOrJump</a>
;     <a href="#Player_GetBodySpriteFrameOffset">Player_GetBodySpriteFrameOffset</a>
;============================================================================
</div><span class="l"><a class="anc" name="ecf6" href="#ecf6">[ecf6]</a><a href="#Player_IsClimbing" class="la">Player_IsClimbing:</a><span class="ce">; [$ecf6]</span></span>
<div class="c">;
; Check if the player can currently climb an available ladder.
;
</div><span class="l"><a class="anc" name="ecf6" href="#ecf6">[ecf6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="ecf8" href="#ecf8">[ecf8]</a><span class="cd"><span class="i">AND</span> <span class="o">#$08</span></span><span class="ce">; Can the player currently climb?</span></span>
<span class="l"><a class="anc" name="ecfa" href="#ecfa">[ecfa]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If not, return false.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; A ladder is available to climb.
;
; Check if the player's X position is on an even block boundary.
;
</div><span class="l"><a class="anc" name="ecfc" href="#ecfc">[ecfc]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_PosX_Block">Player_PosX_Block</a></span></span><span class="ce">; Load the player's X position.</span></span>
<span class="l"><a class="anc" name="ecfe" href="#ecfe">[ecfe]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Is it on a block boundary?</span></span>
<span class="l"><a class="anc" name="ed00" href="#ed00">[ed00]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_checkClimbing">@_checkClimbing</a></span></span><span class="ce">; If not, then jump to check if the player is climbing.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player's X position is on an even byte boundary.
;
; Check if the player is currently falling off a ledge or
; ladder.
;
</div><span class="l"><a class="anc" name="ed02" href="#ed02">[ed02]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="ed04" href="#ed04">[ed04]</a><span class="cd"><span class="i">AND</span> <span class="o">#$04</span></span><span class="ce">; Is the player currently falling?</span></span>
<span class="l"><a class="anc" name="ed06" href="#ed06">[ed06]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If so, return false.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ed08:@_checkClimbing"></a><div class="c">;
; Check if the player is currently climbing.
;
</div><span class="l"><a class="anc" name="ed08" href="#ed08">[ed08]</a><a href="#:ed08:@_checkClimbing" class="lla">@_checkClimbing:</a><span class="ce">; [$ed08]</span></span>
<span class="l"><a class="anc" name="ed08" href="#ed08">[ed08]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_Flags">Player_Flags</a></span></span><span class="ce">; Load the player's flags.</span></span>
<span class="l"><a class="anc" name="ed0a" href="#ed0a">[ed0a]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Is the player climbing?</span></span>
<span class="l"><a class="anc" name="ed0c" href="#ed0c">[ed0c]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_returnFalse">@_returnFalse</a></span></span><span class="ce">; If not, return false.</span></span>
<span class="l"><a class="anc" name="ed0e" href="#ed0e">[ed0e]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Set C = 1 to return true.</span></span>
<span class="l"><a class="anc" name="ed0f" href="#ed0f">[ed0f]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":ed10:@_returnFalse"></a><span class="l"><a class="anc" name="ed10" href="#ed10">[ed10]</a><a href="#:ed10:@_returnFalse" class="lla">@_returnFalse:</a><span class="ce">; [$ed10]</span></span>
<span class="l"><a class="anc" name="ed10" href="#ed10">[ed10]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Set C = 0 to return false.</span></span>
<span class="l"><a class="anc" name="ed11" href="#ed11">[ed11]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_DrawSpriteImmediately"></a><div class="cp">;============================================================================
; Draw the player sprite immediately.
;
; This will load the body/armor and draw it, followed by the
; weapon (if equipped) and then the shield (if equipped and
; not the Battle Helmet).
;
; The sprite will be flushed to the PPU immediately. This
; is done during screen setup, and differs from the normal
; behavior in <a href="#Player_DrawSprite">Player_DrawSprite</a>.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a>:
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_LoadArmorTile">Player_LoadArmorTile</a>
;     <a href="#Player_LoadShieldTile">Player_LoadShieldTile</a>
;     <a href="#Player_LoadWeaponTile">Player_LoadWeaponTile</a>
;     <a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a>
;     <a href="#Player_LoadShieldTilesToPPU">Player_LoadShieldTilesToPPU</a>
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;     <a href="#PPUBuffer_Draw">PPUBuffer_Draw</a>
;
; XREFS:
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;============================================================================
</div><span class="l"><a class="anc" name="ed12" href="#ed12">[ed12]</a><a href="#Player_DrawSpriteImmediately" class="la">Player_DrawSpriteImmediately:</a><span class="ce">; [$ed12]</span></span>
<div class="c">;
; Load and draw the player's sprite.
;
</div><span class="l"><a class="anc" name="ed12" href="#ed12">[ed12]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a></span></span><span class="ce">; Load the armor sprite information.</span></span>
<span class="l"></span>
<a name=":ed15:@_drawArmorLoop"></a><span class="l"><a class="anc" name="ed15" href="#ed15">[ed15]</a><a href="#:ed15:@_drawArmorLoop" class="lla">@_drawArmorLoop:</a><span class="ce">; [$ed15]</span></span>
<span class="l"><a class="anc" name="ed15" href="#ed15">[ed15]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadArmorTile">Player_LoadArmorTile</a></span></span><span class="ce">; Draw a tile of armor.</span></span>
<span class="l"><a class="anc" name="ed18" href="#ed18">[ed18]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span><span class="ce">; Draw to the PPU.</span></span>
<span class="l"><a class="anc" name="ed1b" href="#ed1b">[ed1b]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Increment the read offset.</span></span>
<span class="l"><a class="anc" name="ed1d" href="#ed1d">[ed1d]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the tile count.</span></span>
<span class="l"><a class="anc" name="ed1f" href="#ed1f">[ed1f]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawArmorLoop">@_drawArmorLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load and draw the weapon sprite, if one is equipped.
;
</div><span class="l"><a class="anc" name="ed21" href="#ed21">[ed21]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a></span></span><span class="ce">; Load the weapon sprite information.</span></span>
<span class="l"><a class="anc" name="ed24" href="#ed24">[ed24]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Get the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed26" href="#ed26">[ed26]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_loadShield">@_loadShield</a></span></span><span class="ce">; If &lt; 0, skip weapon drawing.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ed28:@_drawWeaponLoop"></a><div class="c">;
; The player has a weapon equipped. Draw the tiles.
;
</div><span class="l"><a class="anc" name="ed28" href="#ed28">[ed28]</a><a href="#:ed28:@_drawWeaponLoop" class="lla">@_drawWeaponLoop:</a><span class="ce">; [$ed28]</span></span>
<span class="l"><a class="anc" name="ed28" href="#ed28">[ed28]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadWeaponTile">Player_LoadWeaponTile</a></span></span><span class="ce">; Draw a tile of the weapon.</span></span>
<span class="l"><a class="anc" name="ed2b" href="#ed2b">[ed2b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Draw">PPUBuffer_Draw</a></span></span><span class="ce">; Draw to the PPU.</span></span>
<span class="l"><a class="anc" name="ed2e" href="#ed2e">[ed2e]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Increment the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed30" href="#ed30">[ed30]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the tile count.</span></span>
<span class="l"><a class="anc" name="ed32" href="#ed32">[ed32]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawWeaponLoop">@_drawWeaponLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ed34:@_loadShield"></a><div class="c">;
; Load and draw the shield sprite.
;
</div><span class="l"><a class="anc" name="ed34" href="#ed34">[ed34]</a><a href="#:ed34:@_loadShield" class="lla">@_loadShield:</a><span class="ce">; [$ed34]</span></span>
<span class="l"><a class="anc" name="ed34" href="#ed34">[ed34]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadShieldTilesToPPU">Player_LoadShieldTilesToPPU</a></span></span><span class="ce">; Load the shield sprite information.</span></span>
<span class="l"><a class="anc" name="ed37" href="#ed37">[ed37]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Load the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed39" href="#ed39">[ed39]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If &lt; 0 (unset), return.</span></span>
<span class="l"></span>
<a name=":ed3b:@_drawShieldLoop"></a><span class="l"><a class="anc" name="ed3b" href="#ed3b">[ed3b]</a><a href="#:ed3b:@_drawShieldLoop" class="lla">@_drawShieldLoop:</a><span class="ce">; [$ed3b]</span></span>
<span class="l"><a class="anc" name="ed3b" href="#ed3b">[ed3b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadShieldTile">Player_LoadShieldTile</a></span></span><span class="ce">; Draw a tile of the shield.</span></span>
<span class="l"><a class="anc" name="ed3e" href="#ed3e">[ed3e]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Increment the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed40" href="#ed40">[ed40]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the tile count.</span></span>
<span class="l"><a class="anc" name="ed42" href="#ed42">[ed42]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawShieldLoop">@_drawShieldLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<a name=":ed44:@_return"></a><span class="l"><a class="anc" name="ed44" href="#ed44">[ed44]</a><a href="#:ed44:@_return" class="lla">@_return:</a><span class="ce">; [$ed44]</span></span>
<span class="l"><a class="anc" name="ed44" href="#ed44">[ed44]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_DrawSprite"></a><div class="cp">;============================================================================
; Draw the player sprite.
;
; This will load the body/armor and draw it, followed by the
; weapon (if equipped) and then the shield (if equipped and
; not the Battle Helmet).
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a>:
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_LoadArmorTile">Player_LoadArmorTile</a>
;     <a href="#Player_LoadShieldTile">Player_LoadShieldTile</a>
;     <a href="#Player_LoadWeaponTile">Player_LoadWeaponTile</a>
;     <a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a>
;     <a href="#Player_LoadShieldTilesToPPU">Player_LoadShieldTilesToPPU</a>
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;
; XREFS:
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_SetArmor">Player_SetArmor</a>
;     <a href="#Player_SetShield">Player_SetShield</a>
;     <a href="#Player_SetWeapon">Player_SetWeapon</a>
;============================================================================
</div><span class="l"><a class="anc" name="ed45" href="#ed45">[ed45]</a><a href="#Player_DrawSprite" class="la">Player_DrawSprite:</a><span class="ce">; [$ed45]</span></span>
<div class="c">;
; Load and draw the player's sprite.
;
</div><span class="l"><a class="anc" name="ed45" href="#ed45">[ed45]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a></span></span><span class="ce">; Load the armor sprite information.</span></span>
<span class="l"></span>
<a name=":ed48:@_drawArmorLoop"></a><span class="l"><a class="anc" name="ed48" href="#ed48">[ed48]</a><a href="#:ed48:@_drawArmorLoop" class="lla">@_drawArmorLoop:</a><span class="ce">; [$ed48]</span></span>
<span class="l"><a class="anc" name="ed48" href="#ed48">[ed48]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadArmorTile">Player_LoadArmorTile</a></span></span><span class="ce">; Draw a tile of armor.</span></span>
<span class="l"><a class="anc" name="ed4b" href="#ed4b">[ed4b]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Increment the read offset.</span></span>
<span class="l"><a class="anc" name="ed4d" href="#ed4d">[ed4d]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the tile count.</span></span>
<span class="l"><a class="anc" name="ed4f" href="#ed4f">[ed4f]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawArmorLoop">@_drawArmorLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load and draw the weapon sprite, if one is equipped.
;
</div><span class="l"><a class="anc" name="ed51" href="#ed51">[ed51]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a></span></span><span class="ce">; Load the weapon sprite information.</span></span>
<span class="l"><a class="anc" name="ed54" href="#ed54">[ed54]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Get the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed56" href="#ed56">[ed56]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_loadShield">@_loadShield</a></span></span><span class="ce">; If &lt; 0, skip weapon drawing.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ed58:@_drawWeaponLoop"></a><div class="c">;
; The player has a weapon equipped. Draw the tiles.
;
</div><span class="l"><a class="anc" name="ed58" href="#ed58">[ed58]</a><a href="#:ed58:@_drawWeaponLoop" class="lla">@_drawWeaponLoop:</a><span class="ce">; [$ed58]</span></span>
<span class="l"><a class="anc" name="ed58" href="#ed58">[ed58]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadWeaponTile">Player_LoadWeaponTile</a></span></span><span class="ce">; Draw a tile of the weapon.</span></span>
<span class="l"><a class="anc" name="ed5b" href="#ed5b">[ed5b]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Increment the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed5d" href="#ed5d">[ed5d]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the tile count.</span></span>
<span class="l"><a class="anc" name="ed5f" href="#ed5f">[ed5f]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawWeaponLoop">@_drawWeaponLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ed61:@_loadShield"></a><div class="c">;
; Load and draw the shield sprite.
;
</div><span class="l"><a class="anc" name="ed61" href="#ed61">[ed61]</a><a href="#:ed61:@_loadShield" class="lla">@_loadShield:</a><span class="ce">; [$ed61]</span></span>
<span class="l"><a class="anc" name="ed61" href="#ed61">[ed61]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadShieldTilesToPPU">Player_LoadShieldTilesToPPU</a></span></span><span class="ce">; Load the shield sprite information.</span></span>
<span class="l"><a class="anc" name="ed64" href="#ed64">[ed64]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Load the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed66" href="#ed66">[ed66]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If &lt; 0 (unset), return.</span></span>
<span class="l"></span>
<a name=":ed68:@_drawShieldLoop"></a><span class="l"><a class="anc" name="ed68" href="#ed68">[ed68]</a><a href="#:ed68:@_drawShieldLoop" class="lla">@_drawShieldLoop:</a><span class="ce">; [$ed68]</span></span>
<span class="l"><a class="anc" name="ed68" href="#ed68">[ed68]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_LoadShieldTile">Player_LoadShieldTile</a></span></span><span class="ce">; Draw a tile of the shield.</span></span>
<span class="l"><a class="anc" name="ed6b" href="#ed6b">[ed6b]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Increment the tile read offset.</span></span>
<span class="l"><a class="anc" name="ed6d" href="#ed6d">[ed6d]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Decrement the tile count.</span></span>
<span class="l"><a class="anc" name="ed6f" href="#ed6f">[ed6f]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawShieldLoop">@_drawShieldLoop</a></span></span><span class="ce">; If &gt;= 0, loop.</span></span>
<span class="l"></span>
<a name=":ed71:@_return"></a><span class="l"><a class="anc" name="ed71" href="#ed71">[ed71]</a><a href="#:ed71:@_return" class="lla">@_return:</a><span class="ce">; [$ed71]</span></span>
<span class="l"><a class="anc" name="ed71" href="#ed71">[ed71]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadArmorTilesToPPU"></a><div class="cp">;============================================================================
; Load all tiles for the player's armor into the PPU.
;
; This will load the tiles for the selected armor into
; the PPU, for all poses (walking, climbing, jumping, etc.).
; These tiles come from <a href="PRG8.html#TILES_PLAYER_ARMOR_ADDRS_INDEX">TILES_PLAYER_ARMOR_ADDRS_INDEX</a>.
;
; Different sets of tiles are chosen based on whether
; there's a shield equipped.
;
; It's called when spawning a player or when changing
; weapons/armor.
;
; INPUTS:
;     <a href="RAM.html#SelectedArmor">SelectedArmor</a>:
;         The currently-selected armor.
;
;     <a href="RAM.html#SelectedShield">SelectedShield</a>:
;         The currently-selected shield.
;
;     <a href="#PLAYER_ARMOR_TILE_COUNTS">PLAYER_ARMOR_TILE_COUNTS</a>:
;         Tile counts for all poses for each armor.
;
; OUTPUTS:
;     <a href="RAM.html#Player_ArmorLookupIndex">Player_ArmorLookupIndex</a>:
;     <a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_LoadArmorSpriteTilesAddr">Player_LoadArmorSpriteTilesAddr</a>
;
; XREFS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="ed72" href="#ed72">[ed72]</a><a href="#Player_LoadArmorTilesToPPU" class="la">Player_LoadArmorTilesToPPU:</a><span class="ce">; [$ed72]</span></span>
<div class="c">;
; Clear initial state for drawing the armor.
;
</div><span class="l"><a class="anc" name="ed72" href="#ed72">[ed72]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ed74" href="#ed74">[ed74]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Set the tile read offset to 0.</span></span>
<span class="l"><a class="anc" name="ed76" href="#ed76">[ed76]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a></span></span><span class="ce">; Set the sprite segment PPU addresses to 0.</span></span>
<span class="l"><a class="anc" name="ed78" href="#ed78">[ed78]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate an index into the tile information tables for the
; armor (and possibly armor + shield, if the Battle Suit isn't
; equipped).
;
</div><span class="l"><a class="anc" name="ed7a" href="#ed7a">[ed7a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span><span class="ce">; Load the selected armor.</span></span>
<span class="l"><a class="anc" name="ed7d" href="#ed7d">[ed7d]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary.</span></span>
<span class="l"><a class="anc" name="ed7e" href="#ed7e">[ed7e]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Load the selected shield.</span></span>
<span class="l"><a class="anc" name="ed81" href="#ed81">[ed81]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$03</span></span><span class="ce">; Is it the Battle Helmet?</span></span>
<span class="l"><a class="anc" name="ed83" href="#ed83">[ed83]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_loadArmor">@_loadArmor</a></span></span><span class="ce">; If so, jump (skip special armor + shield logic).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There's a shield equipped, and the player isn't wielding
; the full Battle Suit + Battle Helmet. Set the index to be
; odd so we look up a sprite entry compatible with a shield.
;
</div><span class="l"><a class="anc" name="ed85" href="#ed85">[ed85]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$01</span></span><span class="ce">; Offset the lookup index to include armor + shield tiles.</span></span>
<span class="l"></span>
<a name=":ed87:@_loadArmor"></a><span class="l"><a class="anc" name="ed87" href="#ed87">[ed87]</a><a href="#:ed87:@_loadArmor" class="lla">@_loadArmor:</a><span class="ce">; [$ed87]</span></span>
<span class="l"><a class="anc" name="ed87" href="#ed87">[ed87]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_ArmorLookupIndex">Player_ArmorLookupIndex</a></span></span><span class="ce">; Store the lookup index based on the armor word boundary and possibly the shield bit.</span></span>
<span class="l"><a class="anc" name="ed89" href="#ed89">[ed89]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = result.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Determine the number of tiles to load from the lookup table.
;
; The caller will use this to iterate through the tiles to
; load.
;
</div><span class="l"><a class="anc" name="ed8a" href="#ed8a">[ed8a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PLAYER_ARMOR_TILE_COUNTS">PLAYER_ARMOR_TILE_COUNTS</a>,X</span></span><span class="ce">; Load the tile count.</span></span>
<span class="l"><a class="anc" name="ed8d" href="#ed8d">[ed8d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it for the parent caller to use.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Normalize the lookup index to be based on a 4-byte
; boundary (2 bytes for the armor address, 2 for the
; armor + shield address), and then load the sprite
; tiles.
;
</div><span class="l"><a class="anc" name="ed8f" href="#ed8f">[ed8f]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = Lookup index.</span></span>
<span class="l"><a class="anc" name="ed90" href="#ed90">[ed90]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 2 (so index considers armor and armor + shield entries).</span></span>
<span class="l"><a class="anc" name="ed91" href="#ed91">[ed91]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = result.</span></span>
<span class="l"><a class="anc" name="ed92" href="#ed92">[ed92]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_LoadArmorSpriteTilesAddr">Player_LoadArmorSpriteTilesAddr</a></span></span><span class="ce">; Load the sprite tiles information.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PLAYER_ARMOR_TILE_COUNTS"></a><div class="cp">;============================================================================
; The number of available tiles used for all player poses
; for a given armor/shield combination.
;
; XREFS:
;     <a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a>
;
</div><span class="l"><a class="anc" name="ed95" href="#ed95">[ed95]</a><a href="#PLAYER_ARMOR_TILE_COUNTS" class="la">PLAYER_ARMOR_TILE_COUNTS:</a><span class="ce">; [$ed95]</span></span>
<span class="l"><a class="anc" name="ed95" href="#ed95">[ed95]</a><span class="cd"><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [0]: Leather Armor (51 tiles)</span></span>
<span class="l"><a class="anc" name="ed96" href="#ed96">[ed96]</a><span class="cd"><span class="i">db</span> <span class="o">$27</span></span><span class="ce">; [1]: Leather Armor + Shield (39 tiles)</span></span>
<span class="l"><a class="anc" name="ed97" href="#ed97">[ed97]</a><span class="cd"><span class="i">db</span> <span class="o">$33</span></span><span class="ce">; [2]: Studded Mail (51 tiles)</span></span>
<span class="l"><a class="anc" name="ed98" href="#ed98">[ed98]</a><span class="cd"><span class="i">db</span> <span class="o">$27</span></span><span class="ce">; [3]: Studded Mail + Shield (39 tiles)</span></span>
<span class="l"><a class="anc" name="ed99" href="#ed99">[ed99]</a><span class="cd"><span class="i">db</span> <span class="o">$34</span></span><span class="ce">; [4]: Full Plate (52 tiles)</span></span>
<span class="l"><a class="anc" name="ed9a" href="#ed9a">[ed9a]</a><span class="cd"><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [5]: Full Plate + Shield (40 tiles)</span></span>
<span class="l"><a class="anc" name="ed9b" href="#ed9b">[ed9b]</a><span class="cd"><span class="i">db</span> <span class="o">$32</span></span><span class="ce">; [6]: Battle Helmet (50 tiles)</span></span>
<span class="l"><a class="anc" name="ed9c" href="#ed9c">[ed9c]</a><span class="cd"><span class="i">db</span> <span class="o">$32</span></span><span class="ce">; [7]: Battle Helmet + Shield (50 tiles)</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadWeaponTilesToPPU"></a><div class="cp">;============================================================================
; Load all tiles for the player's weapon into the PPU.
;
; This will load the tiles for the selected weapon into
; the PPU, for all poses (walking, swinging, etc.).
; These tiles come from <a href="PRG8.html#TILES_PLAYER_WEAPON_ADDRS_INDEX">TILES_PLAYER_WEAPON_ADDRS_INDEX</a>.
;
; It's called when spawning a player or when changing
; weapons/armor.
;
; INPUTS:
;     <a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a>:
;         The currently-selected weapon.
;
;     <a href="#PLAYER_WEAPON_TILE_COUNTS">PLAYER_WEAPON_TILE_COUNTS</a>:
;         Tile counts for all poses for each weapon.
;
; OUTPUTS:
;     <a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_LoadWeaponSpriteTileAddrs">Player_LoadWeaponSpriteTileAddrs</a>
;
; XREFS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="ed9d" href="#ed9d">[ed9d]</a><a href="#Player_LoadWeaponTilesToPPU" class="la">Player_LoadWeaponTilesToPPU:</a><span class="ce">; [$ed9d]</span></span>
<span class="l"><a class="anc" name="ed9d" href="#ed9d">[ed9d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ed9f" href="#ed9f">[ed9f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Set the tile read offset to 0.</span></span>
<span class="l"><a class="anc" name="eda1" href="#eda1">[eda1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span><span class="ce">; Load the selected weapon.</span></span>
<span class="l"><a class="anc" name="eda4" href="#eda4">[eda4]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (unset)?</span></span>
<span class="l"><a class="anc" name="eda6" href="#eda6">[eda6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loadWeaponTiles">@_loadWeaponTiles</a></span></span><span class="ce">; If not, jump to load tiles.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; No sword is equipped. Set the offset to 0xFF, to disable
; drawing.
;
</div><span class="l"><a class="anc" name="eda8" href="#eda8">[eda8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Set the read offset to 0xFF.</span></span>
<span class="l"><a class="anc" name="edaa" href="#edaa">[edaa]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":edab:@_loadWeaponTiles"></a><div class="c">;
; Determine the number of tiles to load from the lookup table.
;
; The caller will use this to iterate through the tiles to
; load.
;
</div><span class="l"><a class="anc" name="edab" href="#edab">[edab]</a><a href="#:edab:@_loadWeaponTiles" class="lla">@_loadWeaponTiles:</a><span class="ce">; [$edab]</span></span>
<span class="l"><a class="anc" name="edab" href="#edab">[edab]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = weapon.</span></span>
<span class="l"><a class="anc" name="edac" href="#edac">[edac]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PLAYER_WEAPON_TILE_COUNTS">PLAYER_WEAPON_TILE_COUNTS</a>,X</span></span><span class="ce">; Load the tile count.</span></span>
<span class="l"><a class="anc" name="edaf" href="#edaf">[edaf]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it for the parent caller to use.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the PPU address to load tiles into and load them.
;
</div><span class="l"><a class="anc" name="edb1" href="#edb1">[edb1]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; X = tile count.</span></span>
<span class="l"><a class="anc" name="edb2" href="#edb2">[edb2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary.</span></span>
<span class="l"><a class="anc" name="edb3" href="#edb3">[edb3]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = resulting index.</span></span>
<span class="l"><a class="anc" name="edb4" href="#edb4">[edb4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PLAYER_WEAPON_TILE_PPU_ADDRS">PLAYER_WEAPON_TILE_PPU_ADDRS</a>,Y</span></span><span class="ce">; Load the lower byte of the target PPU address for weapons.</span></span>
<span class="l"><a class="anc" name="edb7" href="#edb7">[edb7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a></span></span><span class="ce">; Set it for load.</span></span>
<span class="l"><a class="anc" name="edb9" href="#edb9">[edb9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PLAYER_WEAPON_TILE_PPU_ADDRS">PLAYER_WEAPON_TILE_PPU_ADDRS</a>+1,Y</span></span><span class="ce">; Load the upper byte of the target PPU address for weapons.</span></span>
<span class="l"><a class="anc" name="edbc" href="#edbc">[edbc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a></span></span><span class="ce">; Set it for load.</span></span>
<span class="l"><a class="anc" name="edbe" href="#edbe">[edbe]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_LoadWeaponSpriteTileAddrs">Player_LoadWeaponSpriteTileAddrs</a></span></span><span class="ce">; Load the sprite tiles information.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PLAYER_WEAPON_TILE_COUNTS"></a><div class="cp">;============================================================================
; The number of available tiles used for all player poses
; for a given weapon.
;
; XREFS:
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;
</div><span class="l"><a class="anc" name="edc1" href="#edc1">[edc1]</a><a href="#PLAYER_WEAPON_TILE_COUNTS" class="la">PLAYER_WEAPON_TILE_COUNTS:</a><span class="ce">; [$edc1]</span></span>
<span class="l"><a class="anc" name="edc1" href="#edc1">[edc1]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]: Dagger</span></span>
<span class="l"><a class="anc" name="edc2" href="#edc2">[edc2]</a><span class="cd"><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [1]: Long Sword</span></span>
<span class="l"><a class="anc" name="edc3" href="#edc3">[edc3]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [2]: Giant Blade</span></span>
<span class="l"><a class="anc" name="edc4" href="#edc4">[edc4]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [3]: Dragon Slayer</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PLAYER_WEAPON_TILE_PPU_ADDRS"></a><div class="cp">;============================================================================
; PPU target addresses for each weapon type's loaded tiles.
;
; XREFS:
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;
</div><span class="l"><a class="anc" name="edc5" href="#edc5">[edc5]</a><a href="#PLAYER_WEAPON_TILE_PPU_ADDRS" class="la">PLAYER_WEAPON_TILE_PPU_ADDRS:</a><span class="ce">; [$edc5]</span></span>
<span class="l"><a class="anc" name="edc5" href="#edc5">[edc5]</a><span class="cd"><span class="i">dw</span> <span class="o">$0380</span></span><span class="ce">; [0]: Dagger</span></span>
<span class="l"><a class="anc" name="edc7" href="#edc7">[edc7]</a><span class="cd"><span class="i">dw</span> <span class="o">$0380</span></span><span class="ce">; [1]: Long Sword</span></span>
<span class="l"><a class="anc" name="edc9" href="#edc9">[edc9]</a><span class="cd"><span class="i">dw</span> <span class="o">$0380</span></span><span class="ce">; [2]: Giant Blade</span></span>
<span class="l"><a class="anc" name="edcb" href="#edcb">[edcb]</a><span class="cd"><span class="i">dw</span> <span class="o">$0340</span></span><span class="ce">; [3]: Dragon Slayer</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadShieldTilesToPPU"></a><div class="cp">;============================================================================
; Load all tiles for the player's shield into the PPU.
;
; This will load the tiles for the selected shield into
; the PPU, for all poses (walking, swinging, etc.).
; These tiles come from a range starting at
; <a href="PRG8.html#TILES_SHIELDS_START_SMALL_SHIELD_01">TILES_SHIELDS_START_SMALL_SHIELD_01</a>.
;
; It's called when spawning a player or when changing
; weapons/armor.
;
; Tile indexes and counts are static. They aren't loaded
; from a lookup table like with weapons/armor. There are
; always 5 tiles for a shield.
;
; The exception is the Battle Helmet, which is not rendered
; directly, as it's part of the armor tiles.
;
; INPUTS:
;     <a href="RAM.html#SelectedShield">SelectedShield</a>:
;         The currently-selected shield.
;
; OUTPUTS:
;     <a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#Player_LoadShieldSpriteTileAddrs">Player_LoadShieldSpriteTileAddrs</a>
;
; XREFS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="edcd" href="#edcd">[edcd]</a><a href="#Player_LoadShieldTilesToPPU" class="la">Player_LoadShieldTilesToPPU:</a><span class="ce">; [$edcd]</span></span>
<span class="l"><a class="anc" name="edcd" href="#edcd">[edcd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="edcf" href="#edcf">[edcf]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Set the tile read offset to 0.</span></span>
<span class="l"><a class="anc" name="edd1" href="#edd1">[edd1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Load the selected shield.</span></span>
<span class="l"><a class="anc" name="edd4" href="#edd4">[edd4]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$03</span></span><span class="ce">; Is it the Battle Helmet (or unset -- 0xFF)?</span></span>
<span class="l"><a class="anc" name="edd6" href="#edd6">[edd6]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_loadShieldTiles">@_loadShieldTiles</a></span></span><span class="ce">; If not, then jump to handle standard shields.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This is the Battle Helmet or there's no helmet equipped.
; In either case, set the loaded value as the result.
;
</div><span class="l"><a class="anc" name="edd8" href="#edd8">[edd8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Set the read offset to the shield value. This will be 3 or 0xFF.</span></span>
<span class="l"><a class="anc" name="edda" href="#edda">[edda]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; And return.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":eddb:@_loadShieldTiles"></a><div class="c">;
; An actual shield is equipped. Begin setting the lookup
; index for the shield and a tile count of 5.
;
</div><span class="l"><a class="anc" name="eddb" href="#eddb">[eddb]</a><a href="#:eddb:@_loadShieldTiles" class="lla">@_loadShieldTiles:</a><span class="ce">; [$eddb]</span></span>
<span class="l"><a class="anc" name="eddb" href="#eddb">[eddb]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert the shield index to a word value for lookup.</span></span>
<span class="l"><a class="anc" name="eddc" href="#eddc">[eddc]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = resulting index.</span></span>
<span class="l"><a class="anc" name="eddd" href="#eddd">[eddd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$05</span></span><span class="ce">; 5 tiles.</span></span>
<span class="l"><a class="anc" name="eddf" href="#eddf">[eddf]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Set as the tile count for the load loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the PPU address to load into to 0x0300.
;
</div><span class="l"><a class="anc" name="ede1" href="#ede1">[ede1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ede3" href="#ede3">[ede3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a></span></span><span class="ce">; Set the lower byte of the PPU address to 0.</span></span>
<span class="l"><a class="anc" name="ede5" href="#ede5">[ede5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="ede7" href="#ede7">[ede7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a></span></span><span class="ce">; And upper to 3.</span></span>
<span class="l"><a class="anc" name="ede9" href="#ede9">[ede9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_LoadShieldSpriteTileAddrs">Player_LoadShieldSpriteTileAddrs</a></span></span><span class="ce">; Load the sprite tiles information.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetWeapon"></a><div class="cp">;============================================================================
; Set the player's current weapon.
;
; If the player is in an area where the weapon can be
; equipped, then equip and redraw the player sprite.
;
; INPUTS:
;     A:
;         The weapon to set:
;
;         0 = Hand Dagger
;         1 = Long Sword
;         2 = Giant Blade
;         3 = Dragon Slayer
;
; OUTPUTS:
;     <a href="RAM.html#SelectedWeapon">SelectedWeapon</a>:
;         The updated selected weapon.
;
;     <a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a>:
;         The weapon currently equipped by the player,
;         if in an area allowing that.
;
; CALLS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a class="anc" name="edec" href="#edec">[edec]</a><a href="#Player_SetWeapon" class="la">Player_SetWeapon:</a><span class="ce">; [$edec]</span></span>
<span class="l"><a class="anc" name="edec" href="#edec">[edec]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the weapon to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check that the player is not in a building.
;
; A weapon cannot be set while in a building.
;
</div><span class="l"><a class="anc" name="eded" href="#eded">[eded]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Area_CurrentArea">Area_CurrentArea</a></span></span><span class="ce">; Set A = current area.</span></span>
<span class="l"><a class="anc" name="edef" href="#edef">[edef]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$04</span></span><span class="ce">; Is this the building?</span></span>
<span class="l"><a class="anc" name="edf1" href="#edf1">[edf1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_cannotEquip">@_cannotEquip</a></span></span><span class="ce">; If so, branch.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The weapon can be equipped. Equip it and redraw the player.
;
</div><span class="l"><a class="anc" name="edf3" href="#edf3">[edf3]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the weapon from the stack.</span></span>
<span class="l"><a class="anc" name="edf4" href="#edf4">[edf4]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Set as the current weapon in the inventory.</span></span>
<span class="l"><a class="anc" name="edf7" href="#edf7">[edf7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_CurWeapon">Player_CurWeapon</a></span></span><span class="ce">; Store as the current weapon.</span></span>
<span class="l"><a class="anc" name="edfa" href="#edfa">[edfa]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawSprite">Player_DrawSprite</a></span></span><span class="ce">; Draw the player sprite.</span></span>
<span class="l"><a class="anc" name="edfd" href="#edfd">[edfd]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear Carry.</span></span>
<span class="l"><a class="anc" name="edfe" href="#edfe">[edfe]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":edff:@_cannotEquip"></a><div class="c">;
; The weapon cannot currently be equipped. Set the weapon
; but do not draw.
;
</div><span class="l"><a class="anc" name="edff" href="#edff">[edff]</a><a href="#:edff:@_cannotEquip" class="lla">@_cannotEquip:</a><span class="ce">; [$edff]</span></span>
<span class="l"><a class="anc" name="edff" href="#edff">[edff]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the weapon from the stack.</span></span>
<span class="l"><a class="anc" name="ee00" href="#ee00">[ee00]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedWeapon">SelectedWeapon</a></span></span><span class="ce">; Set as the current weapon.</span></span>
<span class="l"><a class="anc" name="ee03" href="#ee03">[ee03]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear Carry.</span></span>
<span class="l"><a class="anc" name="ee04" href="#ee04">[ee04]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetArmor"></a><div class="cp">;============================================================================
; Set the player's current armor.
;
; The armor will be equipped and the player sprite redrawn.
;
; INPUTS:
;     A:
;         0 = Leather
;         1 = Studded Mail
;         2 = Full Plate
;         3 = Battle Suit
;
; OUTPUTS:
;     <a href="RAM.html#SelectedArmor">SelectedArmor</a>:
;         The new selected armor.
;
; CALLS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a class="anc" name="ee05" href="#ee05">[ee05]</a><a href="#Player_SetArmor" class="la">Player_SetArmor:</a><span class="ce">; [$ee05]</span></span>
<span class="l"><a class="anc" name="ee05" href="#ee05">[ee05]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedArmor">SelectedArmor</a></span></span><span class="ce">; Set the selected armor.</span></span>
<span class="l"><a class="anc" name="ee08" href="#ee08">[ee08]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawSprite">Player_DrawSprite</a></span></span><span class="ce">; Draw the player sprite.</span></span>
<span class="l"><a class="anc" name="ee0b" href="#ee0b">[ee0b]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear Carry.</span></span>
<span class="l"><a class="anc" name="ee0c" href="#ee0c">[ee0c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetShield"></a><div class="cp">;============================================================================
; Set the player's current shield.
;
; The shield will be equipped and the player sprite redrawn.
;
; INPUTS:
;     A:
;         The shield to set:
;
;         0 = Small
;         1 = Large
;         2 = Magic
;         3 = Battle Helmet
;
; OUTPUTS:
;     <a href="RAM.html#SelectedShield">SelectedShield</a>:
;         The new selected armor
;
; CALLS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a class="anc" name="ee0d" href="#ee0d">[ee0d]</a><a href="#Player_SetShield" class="la">Player_SetShield:</a><span class="ce">; [$ee0d]</span></span>
<span class="l"><a class="anc" name="ee0d" href="#ee0d">[ee0d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedShield">SelectedShield</a></span></span><span class="ce">; Set the selected shield.</span></span>
<span class="l"><a class="anc" name="ee10" href="#ee10">[ee10]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_DrawSprite">Player_DrawSprite</a></span></span><span class="ce">; Draw the player sprite.</span></span>
<span class="l"><a class="anc" name="ee13" href="#ee13">[ee13]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Clear Carry.</span></span>
<span class="l"><a class="anc" name="ee14" href="#ee14">[ee14]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadArmorSpriteTilesAddr"></a><div class="cp">;============================================================================
; Load the start address for the current armor's tiles.
;
; This will locate the address in bank 8 where the tiles
; can be read, in preparation for drawing to the screen.
;
; The initial address in bank 8 ({@address PRG8::8000}) points to an
; index table mapping armor IDs to tile start addresses.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a>:
;     <a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>:
;         Address where tile data can be read.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Player_LoadArmorTilesToPPU">Player_LoadArmorTilesToPPU</a>
;============================================================================
</div><span class="l"><a class="anc" name="ee15" href="#ee15">[ee15]</a><a href="#Player_LoadArmorSpriteTilesAddr" class="la">Player_LoadArmorSpriteTilesAddr:</a><span class="ce">; [$ee15]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8 (sprites).
;
</div><span class="l"><a class="anc" name="ee15" href="#ee15">[ee15]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="ee18" href="#ee18">[ee18]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the bank to the stack.</span></span>
<span class="l"><a class="anc" name="ee19" href="#ee19">[ee19]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="ee1b" href="#ee1b">[ee1b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address of the index of armor types to tile IDs.
;
</div><span class="l"><a class="anc" name="ee1e" href="#ee1e">[ee1e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a></span></span><span class="ce">; Load the lower byte of the address of the armor index.</span></span>
<span class="l"><a class="anc" name="ee21" href="#ee21">[ee21]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a></span></span><span class="ce">; Set as the lower byte.</span></span>
<span class="l"><a class="anc" name="ee23" href="#ee23">[ee23]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#ROMBankStart">ROMBankStart</a>+1</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ee26" href="#ee26">[ee26]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ee27" href="#ee27">[ee27]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><a class="anc" name="ee29" href="#ee29">[ee29]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a></span></span><span class="ce">; And set it as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tiles start address of the armor type from the index.
;
</div><span class="l"><a class="anc" name="ee2b" href="#ee2b">[ee2b]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Read the lower byte of the tiles start address.</span></span>
<span class="l"><a class="anc" name="ee2d" href="#ee2d">[ee2d]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ee2e" href="#ee2e">[ee2e]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><a class="anc" name="ee2f" href="#ee2f">[ee2f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Read the upper byte of the tiles start address.</span></span>
<span class="l"><a class="anc" name="ee31" href="#ee31">[ee31]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ee32" href="#ee32">[ee32]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><a class="anc" name="ee34" href="#ee34">[ee34]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a></span></span><span class="ce">; And store as the upper byte of the address.</span></span>
<span class="l"><a class="anc" name="ee36" href="#ee36">[ee36]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the lower byte.</span></span>
<span class="l"><a class="anc" name="ee37" href="#ee37">[ee37]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a></span></span><span class="ce">; And store it as the lower byte of the address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to the saved bank.
;
</div><span class="l"><a class="anc" name="ee39" href="#ee39">[ee39]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved ROM bank from the stack.</span></span>
<span class="l"><a class="anc" name="ee3a" href="#ee3a">[ee3a]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set it to X</span></span>
<span class="l"><a class="anc" name="ee3b" href="#ee3b">[ee3b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"><a class="anc" name="ee3e" href="#ee3e">[ee3e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadWeaponSpriteTileAddrs"></a><div class="cp">;============================================================================
; Load the start address for the current weapon's tiles.
;
; This will locate the address in bank 8 where the tiles
; can be read, in preparation for drawing to the screen.
;
; The initial address in bank 8 ({@address PRG8::8002}) points to an
; index table mapping weapon IDs to tile start addresses.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a>:
;     <a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>:
;         Address where tile data can be read.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Player_LoadWeaponTilesToPPU">Player_LoadWeaponTilesToPPU</a>
;============================================================================
</div><span class="l"><a class="anc" name="ee3f" href="#ee3f">[ee3f]</a><a href="#Player_LoadWeaponSpriteTileAddrs" class="la">Player_LoadWeaponSpriteTileAddrs:</a><span class="ce">; [$ee3f]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8 (sprites).
;
</div><span class="l"><a class="anc" name="ee3f" href="#ee3f">[ee3f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="ee42" href="#ee42">[ee42]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the bank to the stack.</span></span>
<span class="l"><a class="anc" name="ee43" href="#ee43">[ee43]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="ee45" href="#ee45">[ee45]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address of the index of weapon types to tile IDs.
;
</div><span class="l"><a class="anc" name="ee48" href="#ee48">[ee48]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$8002</span></span><span class="ce">; Load the lower byte of the address of the weapon index.</span></span>
<span class="l"><a class="anc" name="ee4b" href="#ee4b">[ee4b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a></span></span><span class="ce">; Set as the lower byte.</span></span>
<span class="l"><a class="anc" name="ee4d" href="#ee4d">[ee4d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$8003</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ee50" href="#ee50">[ee50]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ee51" href="#ee51">[ee51]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><a class="anc" name="ee53" href="#ee53">[ee53]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a></span></span><span class="ce">; And set it as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tiles start address of the weapon type from the
; index.
;
</div><span class="l"><a class="anc" name="ee55" href="#ee55">[ee55]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Read the lower byte of the tiles start address.</span></span>
<span class="l"><a class="anc" name="ee57" href="#ee57">[ee57]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ee58" href="#ee58">[ee58]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><a class="anc" name="ee59" href="#ee59">[ee59]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Read the upper byte of the tiles start address.</span></span>
<span class="l"><a class="anc" name="ee5b" href="#ee5b">[ee5b]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ee5c" href="#ee5c">[ee5c]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><a class="anc" name="ee5e" href="#ee5e">[ee5e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a></span></span><span class="ce">; And store as the upper byte of the address.</span></span>
<span class="l"><a class="anc" name="ee60" href="#ee60">[ee60]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the lower byte.</span></span>
<span class="l"><a class="anc" name="ee61" href="#ee61">[ee61]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a></span></span><span class="ce">; And store it as the lower byte of the address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to the saved bank.
;
</div><span class="l"><a class="anc" name="ee63" href="#ee63">[ee63]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved ROM bank from the stack.</span></span>
<span class="l"><a class="anc" name="ee64" href="#ee64">[ee64]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set it to X</span></span>
<span class="l"><a class="anc" name="ee65" href="#ee65">[ee65]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"><a class="anc" name="ee68" href="#ee68">[ee68]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadShieldSpriteTileAddrs"></a><div class="cp">;============================================================================
; Load the start address for the current shield's tiles.
;
; This will locate the address in bank 8 where the tiles
; can be read, in preparation for drawing to the screen.
;
; The initial address in bank 8 ({@address PRG8::800C}) points to an
; index table mapping shield IDs to tile start addresses.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a>:
;     <a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>:
;         Address where tile data can be read.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Player_LoadShieldTilesToPPU">Player_LoadShieldTilesToPPU</a>
;============================================================================
</div><span class="l"><a class="anc" name="ee69" href="#ee69">[ee69]</a><a href="#Player_LoadShieldSpriteTileAddrs" class="la">Player_LoadShieldSpriteTileAddrs:</a><span class="ce">; [$ee69]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8 (sprites).
;
</div><span class="l"><a class="anc" name="ee69" href="#ee69">[ee69]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="ee6c" href="#ee6c">[ee6c]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the bank to the stack.</span></span>
<span class="l"><a class="anc" name="ee6d" href="#ee6d">[ee6d]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="ee6f" href="#ee6f">[ee6f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address of the index of shield types to tile IDs.
;
</div><span class="l"><a class="anc" name="ee72" href="#ee72">[ee72]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$800c</span></span><span class="ce">; Load the lower byte of the address of the shield index.</span></span>
<span class="l"><a class="anc" name="ee75" href="#ee75">[ee75]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a></span></span><span class="ce">; Set as the lower byte.</span></span>
<span class="l"><a class="anc" name="ee77" href="#ee77">[ee77]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$800d</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ee7a" href="#ee7a">[ee7a]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ee7b" href="#ee7b">[ee7b]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><a class="anc" name="ee7d" href="#ee7d">[ee7d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a></span></span><span class="ce">; And set it as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tiles start address of the shield type from the index.
;
</div><span class="l"><a class="anc" name="ee7f" href="#ee7f">[ee7f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Read the lower byte of the tiles start address.</span></span>
<span class="l"><a class="anc" name="ee81" href="#ee81">[ee81]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ee82" href="#ee82">[ee82]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Increment the offset.</span></span>
<span class="l"><a class="anc" name="ee83" href="#ee83">[ee83]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Read the upper byte of the tiles start address.</span></span>
<span class="l"><a class="anc" name="ee85" href="#ee85">[ee85]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ee86" href="#ee86">[ee86]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><a class="anc" name="ee88" href="#ee88">[ee88]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_U">Player_SpriteTileReadAddr_U</a></span></span><span class="ce">; And store as the upper byte of the address.</span></span>
<span class="l"><a class="anc" name="ee8a" href="#ee8a">[ee8a]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the lower byte.</span></span>
<span class="l"><a class="anc" name="ee8b" href="#ee8b">[ee8b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a></span></span><span class="ce">; And store it as the lower byte of the address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to the saved bank.
;
</div><span class="l"><a class="anc" name="ee8d" href="#ee8d">[ee8d]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved ROM bank from the stack.</span></span>
<span class="l"><a class="anc" name="ee8e" href="#ee8e">[ee8e]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set it to X.</span></span>
<span class="l"><a class="anc" name="ee8f" href="#ee8f">[ee8f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"><a class="anc" name="ee92" href="#ee92">[ee92]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadShieldTile"></a><div class="cp">;============================================================================
; Load a tile of the player's shield into the PPU.
;
; This is repeatedly called in a loop.
;
; The process for loading a tile involves:
;
; 1. Switching to bank 8.
; 2. Loading the start of the tiles address.
; 3. Splitting the nibbles of the tile ID to a 2-byte
;    offset into the tile address.
; 4. Writing to the PPU buffer, to load into the PPU.
;
; As a note, there's a lot of back-and-forth bank switching
; that seems entirely unnecessary. Probably an area that
; could be optimized.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;         Current address in the PPU to write to.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         Updated to queue PPU tile loading.
;
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;         Next address in the PPU to write to.
;
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="ee93" href="#ee93">[ee93]</a><a href="#Player_LoadShieldTile" class="la">Player_LoadShieldTile:</a><span class="ce">; [$ee93]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8 (sprites).
;
</div><span class="l"><a class="anc" name="ee93" href="#ee93">[ee93]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="ee96" href="#ee96">[ee96]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the bank to the stack.</span></span>
<span class="l"><a class="anc" name="ee97" href="#ee97">[ee97]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="ee99" href="#ee99">[ee99]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address for the start of the shield tile IDs.
;
</div><span class="l"><a class="anc" name="ee9c" href="#ee9c">[ee9c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#USHORT_800a">USHORT_800a</a></span></span><span class="ce">; Load the lower byte of the tile IDs start address.</span></span>
<span class="l"><a class="anc" name="ee9f" href="#ee9f">[ee9f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte of the address to read from.</span></span>
<span class="l"><a class="anc" name="eea1" href="#eea1">[eea1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#USHORT_800a">USHORT_800a</a>+1</span></span><span class="ce">; Load the upper byte of the tile IDs start address.</span></span>
<span class="l"><a class="anc" name="eea4" href="#eea4">[eea4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store as the upper byte of the address to read from.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the shield tile.
;
</div><span class="l"><a class="anc" name="eea6" href="#eea6">[eea6]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_LoadSpriteTile">Player_LoadSpriteTile</a></span></span><span class="ce">; Draw the tile.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadArmorTile"></a><div class="cp">;============================================================================
; Load a tile of the player's armor into the PPU.
;
; This is repeatedly called in a loop.
;
; The process for loading a tile involves:
;
; 1. Switching to bank 8.
; 2. Loading the start of the tiles address.
; 3. Splitting the nibbles of the tile ID to a 2-byte
;    offset into the tile address.
; 4. Writing to the PPU buffer, to load into the PPU.
;
; As a note, there's a lot of back-and-forth bank switching
; that seems entirely unnecessary. Probably an area that
; could be optimized.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;         Current address in the PPU to write to.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         Updated to queue PPU tile loading.
;
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;         Next address in the PPU to write to.
;
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="eea9" href="#eea9">[eea9]</a><a href="#Player_LoadArmorTile" class="la">Player_LoadArmorTile:</a><span class="ce">; [$eea9]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8 (sprites).
;
</div><span class="l"><a class="anc" name="eea9" href="#eea9">[eea9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="eeac" href="#eeac">[eeac]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the bank to the stack.</span></span>
<span class="l"><a class="anc" name="eead" href="#eead">[eead]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="eeaf" href="#eeaf">[eeaf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address for the start of the armor tile IDs.
;
</div><span class="l"><a class="anc" name="eeb2" href="#eeb2">[eeb2]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#USHORT_8004">USHORT_8004</a></span></span><span class="ce">; Load the lower byte of the tile IDs start address.</span></span>
<span class="l"><a class="anc" name="eeb5" href="#eeb5">[eeb5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte of the address to read from.</span></span>
<span class="l"><a class="anc" name="eeb7" href="#eeb7">[eeb7]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#USHORT_8004">USHORT_8004</a>+1</span></span><span class="ce">; Load the upper byte of the tile IDs start address.</span></span>
<span class="l"><a class="anc" name="eeba" href="#eeba">[eeba]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store as the upper byte of the address to read from.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the armor tile.
;
</div><span class="l"><a class="anc" name="eebc" href="#eebc">[eebc]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_LoadSpriteTile">Player_LoadSpriteTile</a></span></span><span class="ce">; Draw the tile.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_LoadWeaponTile"></a><div class="cp">;============================================================================
; Load a tile of the player's weapon into the PPU.
;
; This is called when spawning a player or when changing
; weapons/armor.
;
; This is repeatedly called in a loop.
;
; The process for loading a tile involves:
;
; 1. Switching to bank 8.
; 2. Loading the start of the tiles address.
; 3. Splitting the nibbles of the tile ID to a 2-byte
;    offset into the tile address.
; 4. Writing to the PPU buffer, to load into the PPU.
;
; As a note, there's a lot of back-and-forth bank switching
; that seems entirely unnecessary. Probably an area that
; could be optimized.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;         Current address in the PPU to write to.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         Updated to queue PPU tile loading.
;
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a>:
;     <a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a>:
;         Next address in the PPU to write to.
;
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#Player_DrawSprite">Player_DrawSprite</a>
;     <a href="#Player_DrawSpriteImmediately">Player_DrawSpriteImmediately</a>
;============================================================================
</div><span class="l"><a class="anc" name="eebf" href="#eebf">[eebf]</a><a href="#Player_LoadWeaponTile" class="la">Player_LoadWeaponTile:</a><span class="ce">; [$eebf]</span></span>
<div class="c">;
; Save the current ROM bank and switch to bank 8 (sprites).
;
</div><span class="l"><a class="anc" name="eebf" href="#eebf">[eebf]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="eec2" href="#eec2">[eec2]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the bank to the stack.</span></span>
<span class="l"><a class="anc" name="eec3" href="#eec3">[eec3]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="eec5" href="#eec5">[eec5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address for the start of the weapon tile IDs.
;
</div><span class="l"><a class="anc" name="eec8" href="#eec8">[eec8]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#EOLIS_BLOCKS">EOLIS_BLOCKS</a></span></span><span class="ce">; Load the lower byte of the tile IDs start address.</span></span>
<span class="l"><a class="anc" name="eecb" href="#eecb">[eecb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte of the address to read from.</span></span>
<span class="l"><a class="anc" name="eecd" href="#eecd">[eecd]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#EOLIS_BLOCKS">EOLIS_BLOCKS</a>+1</span></span><span class="ce">; Load the upper byte of the tile IDs start address.</span></span>
<span class="l"><a class="anc" name="eed0" href="#eed0">[eed0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store as the upper byte of the address to read from.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
<a name="Player_LoadSpriteTile"></a><div class="c">;
; Restore the previously-saved bank.
;
;
; XREFS:
;     <a href="#Player_LoadArmorTile">Player_LoadArmorTile</a>
;     <a href="#Player_LoadShieldTile">Player_LoadShieldTile</a>
;
</div><span class="l"><a class="anc" name="eed2" href="#eed2">[eed2]</a><a href="#Player_LoadSpriteTile" class="la">Player_LoadSpriteTile:</a><span class="ce">; [$eed2]</span></span>
<span class="l"><a class="anc" name="eed2" href="#eed2">[eed2]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved ROM bank from the stack.</span></span>
<span class="l"><a class="anc" name="eed3" href="#eed3">[eed3]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set it to X.</span></span>
<span class="l"><a class="anc" name="eed4" href="#eed4">[eed4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; And then save it again and switch away again, back to
; bank 8.
;
</div><span class="l"><a class="anc" name="eed7" href="#eed7">[eed7]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="eeda" href="#eeda">[eeda]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="eedb" href="#eedb">[eedb]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank.</span></span>
<span class="l"><a class="anc" name="eedd" href="#eedd">[eedd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare the read address for the tile.
;
</div><span class="l"><a class="anc" name="eee0" href="#eee0">[eee0]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Player_DrawTileReadOffset">Player_DrawTileReadOffset</a></span></span><span class="ce">; Load the tile read offset.</span></span>
<span class="l"><a class="anc" name="eee2" href="#eee2">[eee2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="eee4" href="#eee4">[eee4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Convert to a 2-byte value. The lower nibble will be stored
; as the lower byte in <a href="RAM.html#Temp_04">Temp_04</a>, and the upper nibble
; as the upper byte in <a href="RAM.html#Temp_05">Temp_05</a>. Effectively, splitting
; the nibbles into two bytes.
;
</div><span class="l"><a class="anc" name="eee6" href="#eee6">[eee6]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Player_SpriteTileReadAddr_L">Player_SpriteTileReadAddr_L</a>),Y</span></span><span class="ce">; Load the tile ID at the offset.</span></span>
<span class="l"><a class="anc" name="eee8" href="#eee8">[eee8]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left, upper bit into Carry.</span></span>
<span class="l"><a class="anc" name="eee9" href="#eee9">[eee9]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Rotate left, carry into bit 0, bit 7 into carry.</span></span>
<span class="l"><a class="anc" name="eeeb" href="#eeeb">[eeeb]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Repeat 3 more times, moving lower nibble into A, upper nibble into <a href="RAM.html#Temp_05">Temp_05</a>.</span></span>
<span class="l"><a class="anc" name="eeec" href="#eeec">[eeec]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="eeee" href="#eeee">[eeee]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="eeef" href="#eeef">[eeef]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="eef1" href="#eef1">[eef1]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="eef2" href="#eef2">[eef2]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Final storage of the upper byte.</span></span>
<span class="l"><a class="anc" name="eef4" href="#eef4">[eef4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span><span class="ce">; Final storage of the lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the saved bank.
;
</div><span class="l"><a class="anc" name="eef6" href="#eef6">[eef6]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved ROM bank from the stack.</span></span>
<span class="l"><a class="anc" name="eef7" href="#eef7">[eef7]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set it to X.</span></span>
<span class="l"><a class="anc" name="eef8" href="#eef8">[eef8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And switch back to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Convert the normalized 16-bit tile ID to an address.
;
; 0x80 + the upper byte of the tiles address will be
; added to the upper byte from the tile ID.
;
; The lower byte of the tiles address will be added to the
; lower byte from the tile ID.
;
; The result is the tile data address.
;
; Start with the lower byte of the address.
;
</div><span class="l"><a class="anc" name="eefb" href="#eefb">[eefb]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span><span class="ce">; Load the lower byte from the normalized tile ID.</span></span>
<span class="l"><a class="anc" name="eefd" href="#eefd">[eefd]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="eefe" href="#eefe">[eefe]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Add to the start of the tile IDs.</span></span>
<span class="l"><a class="anc" name="ef00" href="#ef00">[ef00]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span><span class="ce">; Store as the new lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Now handle the upper byte of the address.
;
</div><span class="l"><a class="anc" name="ef02" href="#ef02">[ef02]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Load the upper byte from the normalized tile ID.</span></span>
<span class="l"><a class="anc" name="ef04" href="#ef04">[ef04]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Add the upper byte of the address.</span></span>
<span class="l"><a class="anc" name="ef06" href="#ef06">[ef06]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ef07" href="#ef07">[ef07]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80.</span></span>
<span class="l"><a class="anc" name="ef09" href="#ef09">[ef09]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch bank to bank 8 (where this probably should have
; stayed all along).
;
</div><span class="l"><a class="anc" name="ef0b" href="#ef0b">[ef0b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current bank again.</span></span>
<span class="l"><a class="anc" name="ef0e" href="#ef0e">[ef0e]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ef0f" href="#ef0f">[ef0f]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; 8 = Sprites bank</span></span>
<span class="l"><a class="anc" name="ef11" href="#ef11">[ef11]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to it again.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the target PPU address to write the tiles to for the
; PPU buffer draw command.
;
</div><span class="l"><a class="anc" name="ef14" href="#ef14">[ef14]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a></span></span><span class="ce">; Load the upper byte of the PPU address of the sprite data.</span></span>
<span class="l"><a class="anc" name="ef16" href="#ef16">[ef16]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store as the upper byte to write to for the PPU draw command.</span></span>
<span class="l"><a class="anc" name="ef19" href="#ef19">[ef19]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a></span></span><span class="ce">; Load the lower byte.</span></span>
<span class="l"><a class="anc" name="ef1b" href="#ef1b">[ef1b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Queue 16 bytes (1 tile) to draw to the PPU.
;
</div><span class="l"><a class="anc" name="ef1e" href="#ef1e">[ef1e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16 bytes.</span></span>
<span class="l"><a class="anc" name="ef20" href="#ef20">[ef20]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue it as the draw length.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare a loop for writing bytes for the tile.
;
</div><span class="l"><a class="anc" name="ef23" href="#ef23">[ef23]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (loop counter/read offset).</span></span>
<span class="l"></span>
<a name=":ef25:@_copyLoop"></a><span class="l"><a class="anc" name="ef25" href="#ef25">[ef25]</a><a href="#:ef25:@_copyLoop" class="lla">@_copyLoop:</a><span class="ce">; [$ef25]</span></span>
<span class="l"><a class="anc" name="ef25" href="#ef25">[ef25]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_04">Temp_04</a>),Y</span></span><span class="ce">; Load a byte of the tile.</span></span>
<span class="l"><a class="anc" name="ef27" href="#ef27">[ef27]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Write it to the PPU buffer.</span></span>
<span class="l"><a class="anc" name="ef2a" href="#ef2a">[ef2a]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (buffer position).</span></span>
<span class="l"><a class="anc" name="ef2b" href="#ef2b">[ef2b]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter).</span></span>
<span class="l"><a class="anc" name="ef2c" href="#ef2c">[ef2c]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span><span class="ce">; Is it &lt; 16?</span></span>
<span class="l"><a class="anc" name="ef2e" href="#ef2e">[ef2e]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_copyLoop">@_copyLoop</a></span></span><span class="ce">; If so, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; 16 bytes are written. Update the PPU buffer write offset
; and restore the bank.
;
</div><span class="l"><a class="anc" name="ef30" href="#ef30">[ef30]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Update the PPU buffer write offset.</span></span>
<span class="l"><a class="anc" name="ef32" href="#ef32">[ef32]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved bank from the stack.</span></span>
<span class="l"><a class="anc" name="ef33" href="#ef33">[ef33]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set in X.</span></span>
<span class="l"><a class="anc" name="ef34" href="#ef34">[ef34]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; And update to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increment the PPU address for the next tile.
;
</div><span class="l"><a class="anc" name="ef37" href="#ef37">[ef37]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a></span></span><span class="ce">; Load the lower byte of the PPU address.</span></span>
<span class="l"><a class="anc" name="ef39" href="#ef39">[ef39]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ef3a" href="#ef3a">[ef3a]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Add 16 (next tile).</span></span>
<span class="l"><a class="anc" name="ef3c" href="#ef3c">[ef3c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_L">Player_SpriteSegmentPPUAddr_L</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="ef3e" href="#ef3e">[ef3e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ef40" href="#ef40">[ef40]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add Carry (if the lower byte wrapped).</span></span>
<span class="l"><a class="anc" name="ef42" href="#ef42">[ef42]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Player_SpriteSegmentPPUAddr_U">Player_SpriteSegmentPPUAddr_U</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="ef44" href="#ef44">[ef44]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UNUSED_ClearScreenSpecialEventID"></a><div class="cp">;============================================================================
; DEAD CODE: Unset the special event ID.
;
; This is not used in the game.
;============================================================================
</div><span class="l"><a class="anc" name="ef45" href="#ef45">[ef45]</a><a href="#UNUSED_ClearScreenSpecialEventID" class="la">UNUSED_ClearScreenSpecialEventID:</a><span class="ce">; [$ef45]</span></span>
<span class="l"><a class="anc" name="ef45" href="#ef45">[ef45]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ef47" href="#ef47">[ef47]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span></span>
<span class="l"><a class="anc" name="ef4a" href="#ef4a">[ef4a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="GameLoop_RunScreenEventHandlers"></a><div class="cp">;============================================================================
; Run special event handlers for the current screen.
;
; This will run code specific to some screens in the game,
; as indicated by the special event ID stored in a screen's
; metadata.
;
; See <a href="#Screen_LoadSpecialEventID">Screen_LoadSpecialEventID</a>.
;
; If a handler is found, it will be run directly following
; this function.
;
; INPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The loaded special event ID for the current
;         screen.
;
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>:
;         Table mapping special event IDs to handler
;         functions.
;
; OUTPUTS:
;     Stack (A):
;         The address of the handler to run, if any.
;
; XREFS:
;     <a href="#EndGame_MainLoop">EndGame_MainLoop</a>
;     <a href="#Game_MainLoop">Game_MainLoop</a>
;============================================================================
</div><span class="l"><a class="anc" name="ef4b" href="#ef4b">[ef4b]</a><a href="#GameLoop_RunScreenEventHandlers" class="la">GameLoop_RunScreenEventHandlers:</a><span class="ce">; [$ef4b]</span></span>
<div class="c">;
; Check if this screen has a special event ID.
;
</div><span class="l"><a class="anc" name="ef4b" href="#ef4b">[ef4b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Load the screen's special event ID.</span></span>
<span class="l"><a class="anc" name="ef4e" href="#ef4e">[ef4e]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="ef50" href="#ef50">[ef50]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, nothing to run. Return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if there's an entry in the table.
;
</div><span class="l"><a class="anc" name="ef52" href="#ef52">[ef52]</a><span class="cd"><span class="i">AND</span> <span class="o">#$7f</span></span><span class="ce">; Take the lower 7 bits.</span></span>
<span class="l"><a class="anc" name="ef54" href="#ef54">[ef54]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary for the lookup table.</span></span>
<span class="l"><a class="anc" name="ef55" href="#ef55">[ef55]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$06</span></span><span class="ce">; Is it &gt;= 6 (out of bounds)?</span></span>
<span class="l"><a class="anc" name="ef57" href="#ef57">[ef57]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address of the handler and push as the new address
; to run.
;
</div><span class="l"><a class="anc" name="ef59" href="#ef59">[ef59]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="ef5a" href="#ef5a">[ef5a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>+1,Y</span></span><span class="ce">; Load the lower byte of the handler address.</span></span>
<span class="l"><a class="anc" name="ef5d" href="#ef5d">[ef5d]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="ef5e" href="#ef5e">[ef5e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>,Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="ef61" href="#ef61">[ef61]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it.</span></span>
<span class="l"></span>
<a name=":ef62:@_return"></a><span class="l"><a class="anc" name="ef62" href="#ef62">[ef62]</a><a href="#:ef62:@_return" class="lla">@_return:</a><span class="ce">; [$ef62]</span></span>
<span class="l"><a class="anc" name="ef62" href="#ef62">[ef62]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SPECIAL_SCREEN_EVENT_LOOKUP_TABLE"></a><div class="cp">;============================================================================
; Special screen events lookup table.
;
; Each maps a special event ID to a handler that will run
; on each tick while on the screen.
;
; MOD NOTES:
;     By moving this table later into the bank and updating
;     both the address in
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;     and the table length in that function (6), you could
;     likely add new special handlers for screens
;
; XREFS:
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;
</div><span class="l"><a class="anc" name="ef63" href="#ef63">[ef63]</a><a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE" class="la">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE:</a><span class="ce">; [$ef63]</span></span>
<span class="l"><a class="anc" name="ef63" href="#ef63">[ef63]</a><span class="cd"><span class="i">db</span> <span class="o">$68</span></span><span class="ce">; [0]: Handle pushable block on path to Mascon.</span></span>
<span class="l"></span>
<a name="SPECIAL_SCREEN_EVENT_LOOKUP_TABLE_0__1"></a><div class="c">;
; XREFS:
;     <a href="#GameLoop_RunScreenEventHandlers">GameLoop_RunScreenEventHandlers</a>
;
</div><span class="l"><a class="anc" name="ef64" href="#ef64">[ef64]</a><a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE_0__1" class="la">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE_0__1:</a><span class="ce">; [$ef64]</span></span>
<span class="l"><a class="anc" name="ef64" href="#ef64">[ef64]</a><span class="cd"><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="ef65" href="#ef65">[ef65]</a><span class="cd"><span class="i">db</span> <span class="o">$9d</span></span><span class="ce">; [1]: Handle a standard boss battle.</span></span>
<span class="l"><a class="anc" name="ef66" href="#ef66">[ef66]</a><span class="cd"><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="ef67" href="#ef67">[ef67]</a><span class="cd"><span class="i">db</span> <span class="o">$d3</span></span><span class="ce">; [2]: Handle end-game sequence after killing the final boss.</span></span>
<span class="l"><a class="anc" name="ef68" href="#ef68">[ef68]</a><span class="cd"><span class="i">db</span> <span class="o">$ef</span></span><span class="ce">; [2]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="ScreenEvents_HandlePathToMasconEvent"></a><div class="cp">;============================================================================
; Handle checking the path to Mascon at the final fountain.
;
; This is a special screen event handler that checks whether
; the player has completed the quests to reach Mascon.
;
; This is only executed on the first tick for the screen,
; and disabled immediately after. If the fountains were
; completed, this will remove the block obscuring the
; ladder to Mascon and then drop down the ladder.
;
; INPUTS:
;     <a href="RAM.html#Quests">Quests</a>:
;         The quests completed.
;
; OUTPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The unset special event ID, to prevent this from
;         running more than once.
;
;     <a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a>:
;         Set to the block position to clear.
;
;     <a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a>:
;         Set to 1.
;
; CALLS:
;     <a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a>
;
; XREFS:
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>
;     [$PRG15_MIRROR::ef63]
;============================================================================
</div><span class="l"><a class="anc" name="ef69" href="#ef69">[ef69]</a><a href="#ScreenEvents_HandlePathToMasconEvent" class="la">ScreenEvents_HandlePathToMasconEvent:</a><span class="ce">; [$ef69]</span></span>
<div class="c">;
; Check if the path to Mascon has been opened.
;
</div><span class="l"><a class="anc" name="ef69" href="#ef69">[ef69]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Quests">Quests</a></span></span><span class="ce">; Load the list of completed quests.</span></span>
<span class="l"><a class="anc" name="ef6c" href="#ef6c">[ef6c]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Is the Mascon path completed?</span></span>
<span class="l"><a class="anc" name="ef6e" href="#ef6e">[ef6e]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_notCompleted">@_notCompleted</a></span></span><span class="ce">; If not, jump to return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The quest has been completed. Turn off this handler (clear
; the event ID) and manage the transition for the path to
; Mascon.
;
</div><span class="l"><a class="anc" name="ef70" href="#ef70">[ef70]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ef72" href="#ef72">[ef72]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Unset the special event ID.</span></span>
<span class="l"><a class="anc" name="ef75" href="#ef75">[ef75]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="ef77" href="#ef77">[ef77]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_Opening">PathToMascon_Opening</a></span></span><span class="ce">; Set the path to Mascon as opened.</span></span>
<span class="l"><a class="anc" name="ef79" href="#ef79">[ef79]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$56</span></span></span>
<span class="l"><a class="anc" name="ef7b" href="#ef7b">[ef7b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PathToMascon_FountainCoverPos">PathToMascon_FountainCoverPos</a></span></span><span class="ce">; Set the pushable block to X=6, Y=5.</span></span>
<span class="l"><a class="anc" name="ef7d" href="#ef7d">[ef7d]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="ef7f" href="#ef7f">[ef7f]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_OpenPathToMascon">Game_OpenPathToMascon</a></span></span><span class="ce">; Drop the ladder down to reach Mascon.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":ef82:@_notCompleted"></a><div class="c">;
; The criteria for the path wasn't set. Clear out this event
; ID so it won't be run until the next time the player is
; on the screen.
;
</div><span class="l"><a class="anc" name="ef82" href="#ef82">[ef82]</a><a href="#:ef82:@_notCompleted" class="lla">@_notCompleted:</a><span class="ce">; [$ef82]</span></span>
<span class="l"><a class="anc" name="ef82" href="#ef82">[ef82]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ef84" href="#ef84">[ef84]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Unset the special event ID.</span></span>
<span class="l"><a class="anc" name="ef87" href="#ef87">[ef87]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_HasSpritesNotOfType"></a><div class="cp">;============================================================================
; DEADCODE: Check if there are sprites not of a given entity.
;
; This does not appear to be used anywhere. It only
; references itself.
;============================================================================
</div><span class="l"><a class="anc" name="ef88" href="#ef88">[ef88]</a><a href="#Sprites_HasSpritesNotOfType" class="la">Sprites_HasSpritesNotOfType:</a><span class="ce">; [$ef88]</span></span>
<span class="l"><a class="anc" name="ef88" href="#ef88">[ef88]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="ef8a" href="#ef8a">[ef8a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"></span>
<a name=":ef8c:@LAB_PRG15_MIRROR__ef8c"></a><span class="l"><a class="anc" name="ef8c" href="#ef8c">[ef8c]</a><a href="#:ef8c:@LAB_PRG15_MIRROR__ef8c" class="lla">@LAB_PRG15_MIRROR__ef8c:</a><span class="ce">; [$ef8c]</span></span>
<span class="l"><a class="anc" name="ef8c" href="#ef8c">[ef8c]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span></span>
<span class="l"><a class="anc" name="ef8f" href="#ef8f">[ef8f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="ef91" href="#ef91">[ef91]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef99">@LAB_PRG15_MIRROR__ef99</a></span></span></span>
<span class="l"><a class="anc" name="ef93" href="#ef93">[ef93]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="ef95" href="#ef95">[ef95]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef99">@LAB_PRG15_MIRROR__ef99</a></span></span></span>
<span class="l"><a class="anc" name="ef97" href="#ef97">[ef97]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="ef98" href="#ef98">[ef98]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":ef99:@LAB_PRG15_MIRROR__ef99"></a><span class="l"><a class="anc" name="ef99" href="#ef99">[ef99]</a><a href="#:ef99:@LAB_PRG15_MIRROR__ef99" class="lla">@LAB_PRG15_MIRROR__ef99:</a><span class="ce">; [$ef99]</span></span>
<span class="l"><a class="anc" name="ef99" href="#ef99">[ef99]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="ef9a" href="#ef9a">[ef9a]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__ef8c">@LAB_PRG15_MIRROR__ef8c</a></span></span></span>
<span class="l"><a class="anc" name="ef9c" href="#ef9c">[ef9c]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="ef9d" href="#ef9d">[ef9d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="ScreenEvents_HandleBoss"></a><div class="cp">;============================================================================
; Handle checking for a boss on the screen.
;
; This is a special event handler used for boss rooms.
; It will default the music to boss battle music, and then
; check for the presence of a boss on every game tick.
;
; Once a boss has been defeated, the music will be set back
; to the default for the area and the handler will be shut
; down.
;
; INPUTS:
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The special event ID for the screen, used to
;         determine which bits of logic should run.
;
;     <a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a>:
;         The default music for the area.
;
; OUTPUTS:
;     <a href="RAM.html#Music_Current">Music_Current</a>:
;         The current music being played.
;
;     <a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a>:
;         The updated special event ID.
;
; CALLS:
;     <a href="#Sprites_HasBoss">Sprites_HasBoss</a>
;
; XREFS:
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>
;     [$PRG15_MIRROR::ef65]
;============================================================================
</div><span class="l"><a class="anc" name="ef9e" href="#ef9e">[ef9e]</a><a href="#ScreenEvents_HandleBoss" class="la">ScreenEvents_HandleBoss:</a><span class="ce">; [$ef9e]</span></span>
<div class="c">;
; Check if bit 7 is set. If not, prepare the boss battle music
; and initial state. This would only be done once on the screen.
;
</div><span class="l"><a class="anc" name="ef9e" href="#ef9e">[ef9e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span></span>
<span class="l"><a class="anc" name="efa1" href="#efa1">[efa1]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_checkForBoss">@_checkForBoss</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; This is the first tick on a boss battle screen. Take the
; opportunity to cap any item durations, and default the music
; to the boss battle music.
;
</div><span class="l"><a class="anc" name="efa3" href="#efa3">[efa3]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$80</span></span><span class="ce">; Set bit 7 to only run this conditional on the first game tick.</span></span>
<span class="l"><a class="anc" name="efa5" href="#efa5">[efa5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Save it.</span></span>
<span class="l"><a class="anc" name="efa8" href="#efa8">[efa8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#LimitItemDurations">LimitItemDurations</a></span></span><span class="ce">; Cap item durations within bounds.</span></span>
<span class="l"><a class="anc" name="efab" href="#efab">[efab]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="efad" href="#efad">[efad]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set the music to the boss battle music.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":efaf:@_checkForBoss"></a><div class="c">;
; Check if there's a boss on screen.
;
</div><span class="l"><a class="anc" name="efaf" href="#efaf">[efaf]</a><a href="#:efaf:@_checkForBoss" class="lla">@_checkForBoss:</a><span class="ce">; [$efaf]</span></span>
<span class="l"><a class="anc" name="efaf" href="#efaf">[efaf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_HasBoss">Sprites_HasBoss</a></span></span><span class="ce">; Check for a boss.</span></span>
<span class="l"><a class="anc" name="efb2" href="#efb2">[efb2]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If there is one, we're done. Return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The boss has been defeated. Restore the game state.
;
</div><span class="l"><a class="anc" name="efb4" href="#efb4">[efb4]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Areas_DefaultMusic">Areas_DefaultMusic</a></span></span><span class="ce">; Load the default music for the area.</span></span>
<span class="l"><a class="anc" name="efb7" href="#efb7">[efb7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set it as the current music.</span></span>
<span class="l"><a class="anc" name="efb9" href="#efb9">[efb9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="efbb" href="#efbb">[efbb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#CurrentScreen_SpecialEventID">CurrentScreen_SpecialEventID</a></span></span><span class="ce">; Clear the special event ID so this doesn't run again.</span></span>
<span class="l"></span>
<a name=":efbe:@_return"></a><span class="l"><a class="anc" name="efbe" href="#efbe">[efbe]</a><a href="#:efbe:@_return" class="lla">@_return:</a><span class="ce">; [$efbe]</span></span>
<span class="l"><a class="anc" name="efbe" href="#efbe">[efbe]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="LimitItemDurations"></a><div class="cp">;============================================================================
; Ensure Ointment and Hour Glass durations don't go below 0.
;
; If either goes below 0, it will be set to 0.
;
; INPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The Ointment duration.
;
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The Hour Glass duration.
;
; OUTPUTS:
;     <a href="RAM.html#DurationOintment">DurationOintment</a>:
;         The updated Ointment duration.
;
;     <a href="RAM.html#DurationHourGlass">DurationHourGlass</a>:
;         The updated Hour Glass duration.
;
; XREFS:
;     <a href="#ScreenEvents_HandleBoss">ScreenEvents_HandleBoss</a>
;============================================================================
</div><span class="l"><a class="anc" name="efbf" href="#efbf">[efbf]</a><a href="#LimitItemDurations" class="la">LimitItemDurations:</a><span class="ce">; [$efbf]</span></span>
<span class="l"><a class="anc" name="efbf" href="#efbf">[efbf]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Load the Ointment duration.</span></span>
<span class="l"><a class="anc" name="efc2" href="#efc2">[efc2]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_checkHourGlass">@_checkHourGlass</a></span></span><span class="ce">; If &gt;= 0, move on to the Hour Glass.</span></span>
<span class="l"><a class="anc" name="efc4" href="#efc4">[efc4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="efc6" href="#efc6">[efc6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationOintment">DurationOintment</a></span></span><span class="ce">; Set the Ointment duration to 0.</span></span>
<span class="l"></span>
<a name=":efc9:@_checkHourGlass"></a><span class="l"><a class="anc" name="efc9" href="#efc9">[efc9]</a><a href="#:efc9:@_checkHourGlass" class="lla">@_checkHourGlass:</a><span class="ce">; [$efc9]</span></span>
<span class="l"><a class="anc" name="efc9" href="#efc9">[efc9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Load the Hour Glass duration.</span></span>
<span class="l"><a class="anc" name="efcc" href="#efcc">[efcc]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If &gt;= 0, we're done.</span></span>
<span class="l"><a class="anc" name="efce" href="#efce">[efce]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="efd0" href="#efd0">[efd0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#DurationHourGlass">DurationHourGlass</a></span></span><span class="ce">; Set the Hour Glass duration to 0.</span></span>
<span class="l"></span>
<a name=":efd3:@_return"></a><span class="l"><a class="anc" name="efd3" href="#efd3">[efd3]</a><a href="#:efd3:@_return" class="lla">@_return:</a><span class="ce">; [$efd3]</span></span>
<span class="l"><a class="anc" name="efd3" href="#efd3">[efd3]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="ScreenEvents_HandleFinalBossKilled"></a><div class="cp">;============================================================================
; Handle checking for the death of the final boss.
;
; This is a special event handler used for the final boss
; room.
;
; If the boss dies (rather, if all sprite entities are
; cleared from the screen), this will switch back to the
; opening music and area, placing the player back in the
; King's room for the end game outro.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#Music_Current">Music_Current</a>:
;         Set to the Eolis music.
;
; CALLS:
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;     <a href="#Sprites_HasCurrentSprites">Sprites_HasCurrentSprites</a>
;     <a href="#EndGame_Begin">EndGame_Begin</a>
;
; XREFS:
;     <a href="#SPECIAL_SCREEN_EVENT_LOOKUP_TABLE">SPECIAL_SCREEN_EVENT_LOOKUP_TABLE</a>
;     [$PRG15_MIRROR::ef67]
;============================================================================
</div><span class="l"><a class="anc" name="efd4" href="#efd4">[efd4]</a><a href="#ScreenEvents_HandleFinalBossKilled" class="la">ScreenEvents_HandleFinalBossKilled:</a><span class="ce">; [$efd4]</span></span>
<span class="l"><a class="anc" name="efd4" href="#efd4">[efd4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_HasCurrentSprites">Sprites_HasCurrentSprites</a></span></span><span class="ce">; Are there sprites on screen?</span></span>
<span class="l"><a class="anc" name="efd7" href="#efd7">[efd7]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The final boss is dead. Transition toward the end game
; sequence.
;
; Start by switching the music to the Eolis music.
;
</div><span class="l"><a class="anc" name="efd9" href="#efd9">[efd9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span><span class="ce">; 0x07 == Eolis music</span></span>
<span class="l"><a class="anc" name="efdb" href="#efdb">[efdb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span><span class="ce">; Set as the current music.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the "Player got hit" sound.
;
</div><span class="l"><a class="anc" name="efdd" href="#efdd">[efdd]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span><span class="ce">; 0x04 == Player hit sound effect.</span></span>
<span class="l"><a class="anc" name="efdf" href="#efdf">[efdf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"><a class="anc" name="efe2" href="#efe2">[efe2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#EndGame_Begin">EndGame_Begin</a></span></span><span class="ce">; Begin the end-game sequence.</span></span>
<span class="l"></span>
<a name=":efe5:@_return"></a><span class="l"><a class="anc" name="efe5" href="#efe5">[efe5]</a><a href="#:efe5:@_return" class="lla">@_return:</a><span class="ce">; [$efe5]</span></span>
<span class="l"><a class="anc" name="efe5" href="#efe5">[efe5]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Maybe_IsSpriteEntityNotOnScreen"></a><div class="cp">;============================================================================
; Return whether the given sprite entity is *not* on the screen.
;
; This will loop through the sprites on screen and check if any
; match the entity type provided.
;
; INPUTS:
;     A:
;         The sprite entity to check for.
;
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The list of current sprite entities on screen.
;
; OUTPUTS:
;     C:
;         0 = Sprite entity is on screen.
;         1 = Sprite entity is not on screen.
;
;     <a href="RAM.html#Temp_00">Temp_00</a>:
;         Clobbered.
;
; XREFS:
;     <a href="PRG14.html#SpriteBehavior_BattleHelmetDroppedByZoradohna">SpriteBehavior_BattleHelmetDroppedByZoradohna</a>
;     <a href="PRG14.html#SpriteBehavior_BattleSuitDroppedByZoradohna">SpriteBehavior_BattleSuitDroppedByZoradohna</a>
;     <a href="PRG14.html#SpriteBehavior_BlackOnyxDropFromZoradohna">SpriteBehavior_BlackOnyxDropFromZoradohna</a>
;     <a href="PRG14.html#SpriteBehavior_DragonSlayerDroppedByKingGrieve">SpriteBehavior_DragonSlayerDroppedByKingGrieve</a>
;     <a href="PRG14.html#SpriteBehavior_MattockDroppedFromRipasheiku">SpriteBehavior_MattockDroppedFromRipasheiku</a>
;     <a href="PRG14.html#SpriteBehavior_PendantDroppedFromRipasheiku">SpriteBehavior_PendantDroppedFromRipasheiku</a>
;     <a href="PRG14.html#SpriteBehavior_WingBootsDroppedByZorugeriru">SpriteBehavior_WingBootsDroppedByZorugeriru</a>
;============================================================================
</div><span class="l"><a class="anc" name="efe6" href="#efe6">[efe6]</a><a href="#Maybe_IsSpriteEntityNotOnScreen" class="la">Maybe_IsSpriteEntityNotOnScreen:</a><span class="ce">; [$efe6]</span></span>
<span class="l"><a class="anc" name="efe6" href="#efe6">[efe6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; <a href="RAM.html#Temp_00">Temp_00</a> = Sprite type for comparison.</span></span>
<span class="l"><a class="anc" name="efe8" href="#efe8">[efe8]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$07</span></span><span class="ce">; Y = 7</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":efea:@_spriteLoop"></a><div class="c">;
; Check the entity for this index in the current sprites list.
;
</div><span class="l"><a class="anc" name="efea" href="#efea">[efea]</a><a href="#:efea:@_spriteLoop" class="lla">@_spriteLoop:</a><span class="ce">; [$efea]</span></span>
<span class="l"><a class="anc" name="efea" href="#efea">[efea]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,Y</span></span><span class="ce">; Load the entity of the sprite at loop index.</span></span>
<span class="l"><a class="anc" name="efed" href="#efed">[efed]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Is it the entity the caller is checking for?</span></span>
<span class="l"><a class="anc" name="efef" href="#efef">[efef]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_prepareNextLoopIter">@_prepareNextLoopIter</a></span></span><span class="ce">; If not, prepare for the next loop iteration.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The sprite entity is on the screen. Clear carry as the result.
;
</div><span class="l"><a class="anc" name="eff1" href="#eff1">[eff1]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Return false.</span></span>
<span class="l"><a class="anc" name="eff2" href="#eff2">[eff2]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":eff3:@_prepareNextLoopIter"></a><span class="l"><a class="anc" name="eff3" href="#eff3">[eff3]</a><a href="#:eff3:@_prepareNextLoopIter" class="lla">@_prepareNextLoopIter:</a><span class="ce">; [$eff3]</span></span>
<span class="l"><a class="anc" name="eff3" href="#eff3">[eff3]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="eff4" href="#eff4">[eff4]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_spriteLoop">@_spriteLoop</a></span></span><span class="ce">; If Y &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The sprite entity is not on the screen. Set carry as the
; result.
;
</div><span class="l"><a class="anc" name="eff6" href="#eff6">[eff6]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Return true.</span></span>
<span class="l"><a class="anc" name="eff7" href="#eff7">[eff7]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_HasBoss"></a><div class="cp">;============================================================================
; Return whether there's a boss on screen.
;
; This loops through all the sprite entities on the screen,
; looks up the category for each, and checks if that
; category is a boss.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The list of current sprite entities on screen.
;
;     <a href="PRG14.html#SPRITE_CATEGORIES_BY_ENTITY">SPRITE_CATEGORIES_BY_ENTITY</a>:
;         Lookup table of entities to categories.
;
; OUTPUTS:
;     C:
;         0 if there is no boss on screen.
;         1 if there is a boss on screen.
;
; XREFS:
;     <a href="#ScreenEvents_HandleBoss">ScreenEvents_HandleBoss</a>
;============================================================================
</div><span class="l"><a class="anc" name="eff8" href="#eff8">[eff8]</a><a href="#Sprites_HasBoss" class="la">Sprites_HasBoss:</a><span class="ce">; [$eff8]</span></span>
<span class="l"><a class="anc" name="eff8" href="#eff8">[eff8]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; X = 7 (loop counter).</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":effa:@_loop"></a><div class="c">;
; Check if this sprite is a boss.
;
</div><span class="l"><a class="anc" name="effa" href="#effa">[effa]</a><a href="#:effa:@_loop" class="lla">@_loop:</a><span class="ce">; [$effa]</span></span>
<span class="l"><a class="anc" name="effa" href="#effa">[effa]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,X</span></span><span class="ce">; Load the sprite entity at that index.</span></span>
<span class="l"><a class="anc" name="effd" href="#effd">[effd]</a><span class="cd"><span class="i">LDA</span> <span class="o">$b544,Y</span></span><span class="ce">; Load the category for the entity.</span></span>
<span class="l"><a class="anc" name="f000" href="#f000">[f000]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$07</span></span><span class="ce">; Is it 7 (boss)?</span></span>
<span class="l"><a class="anc" name="f002" href="#f002">[f002]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_notBoss">@_notBoss</a></span></span><span class="ce">; If not, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There is a boss on screen. Return true.
;
</div><span class="l"><a class="anc" name="f004" href="#f004">[f004]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Return true.</span></span>
<span class="l"><a class="anc" name="f005" href="#f005">[f005]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":f006:@_notBoss"></a><span class="l"><a class="anc" name="f006" href="#f006">[f006]</a><a href="#:f006:@_notBoss" class="lla">@_notBoss:</a><span class="ce">; [$f006]</span></span>
<span class="l"><a class="anc" name="f006" href="#f006">[f006]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="f007" href="#f007">[f007]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If X &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There is no boss on screen. Return false.
;
</div><span class="l"><a class="anc" name="f009" href="#f009">[f009]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Return false.</span></span>
<span class="l"><a class="anc" name="f00a" href="#f00a">[f00a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_HasCurrentSprites"></a><div class="cp">;============================================================================
; Return whether any sprites are currently on screen.
;
; INPUTS:
;     <a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>:
;         The types of sprites currently on the screen.
;
; OUTPUTS:
;     C:
;         1 if there are sprites on the screen.
;         0 if there are no sprites.
;
; XREFS:
;     <a href="#ScreenEvents_HandleFinalBossKilled">ScreenEvents_HandleFinalBossKilled</a>
;============================================================================
</div><span class="l"><a class="anc" name="f00b" href="#f00b">[f00b]</a><a href="#Sprites_HasCurrentSprites" class="la">Sprites_HasCurrentSprites:</a><span class="ce">; [$f00b]</span></span>
<span class="l"><a class="anc" name="f00b" href="#f00b">[f00b]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$07</span></span><span class="ce">; Y = 7 (loop counter).</span></span>
<span class="l"></span>
<a name=":f00d:@_loop"></a><span class="l"><a class="anc" name="f00d" href="#f00d">[f00d]</a><a href="#:f00d:@_loop" class="lla">@_loop:</a><span class="ce">; [$f00d]</span></span>
<span class="l"><a class="anc" name="f00d" href="#f00d">[f00d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprites_Entities">CurrentSprites_Entities</a>,Y</span></span><span class="ce">; Load the sprite entity at that index.</span></span>
<span class="l"><a class="anc" name="f010" href="#f010">[f010]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it unset?</span></span>
<span class="l"><a class="anc" name="f012" href="#f012">[f012]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_prepareNextLoopIter">@_prepareNextLoopIter</a></span></span><span class="ce">; If yes, jump to prepare for the next loop iteration.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; A sprite entity was found. Return true.
;
</div><span class="l"><a class="anc" name="f014" href="#f014">[f014]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Return true.</span></span>
<span class="l"><a class="anc" name="f015" href="#f015">[f015]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":f016:@_prepareNextLoopIter"></a><span class="l"><a class="anc" name="f016" href="#f016">[f016]</a><a href="#:f016:@_prepareNextLoopIter" class="lla">@_prepareNextLoopIter:</a><span class="ce">; [$f016]</span></span>
<span class="l"><a class="anc" name="f016" href="#f016">[f016]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="f017" href="#f017">[f017]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If Y &gt;= 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; A sprite entity was not found. Return false.
;
</div><span class="l"><a class="anc" name="f019" href="#f019">[f019]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Return false.</span></span>
<span class="l"><a class="anc" name="f01a" href="#f01a">[f01a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprite_DrawPortraitPartAppearance"></a><div class="cp">;============================================================================
; Draw part of a portrait to the screen as sprites.
;
; This will load the portrait tileinfo as an offset from
; the value referenced in <a href="PRG7.html#PORTRAIT_APPEARANCES_OFFSET">PORTRAIT_APPEARANCES_OFFSET</a>
; (<a href="PRG7.html#TILEINFO_PORTRAITS_ADDRS">TILEINFO_PORTRAITS_ADDRS</a>) and drawn as a sprite to
; the screen.
;
; INPUTS:
;     A:
;         The offset into the portrait tileinfo table.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank to switch back to.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#Sprite_Draw">Sprite_Draw</a>
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;============================================================================
</div><span class="l"><a class="anc" name="f01b" href="#f01b">[f01b]</a><a href="#Sprite_DrawPortraitPartAppearance" class="la">Sprite_DrawPortraitPartAppearance:</a><span class="ce">; [$f01b]</span></span>
<span class="l"><a class="anc" name="f01b" href="#f01b">[f01b]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (appearance offset).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current ROM bank and switch to bank 7.
;
</div><span class="l"><a class="anc" name="f01c" href="#f01c">[f01c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="f01f" href="#f01f">[f01f]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f020" href="#f020">[f020]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span><span class="ce">; Bank 7 = Sprites</span></span>
<span class="l"><a class="anc" name="f022" href="#f022">[f022]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address to load sprite images from.
;
; With the addresses stored in <a href="PRG7.html#PORTRAIT_APPEARANCES_OFFSET">PORTRAIT_APPEARANCES_OFFSET</a>
; and
; <a href="PRG7.html#PORTRAIT_APPEARANCES_OFFSET">PORTRAIT_APPEARANCES_OFFSET</a>+1, this should put us at a
; starting point of {@address PRG7::AFD5}, or {@address PRG7::B0D5} if
; offset overflowed.
;
</div><span class="l"><a class="anc" name="f025" href="#f025">[f025]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (appearance offset).</span></span>
<span class="l"><a class="anc" name="f026" href="#f026">[f026]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary for an index into the tileinfo table.</span></span>
<span class="l"><a class="anc" name="f027" href="#f027">[f027]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (index).</span></span>
<span class="l"><a class="anc" name="f028" href="#f028">[f028]</a><span class="cd"><span class="i">PHP</span></span><span class="ce">; Push flags to the stack.</span></span>
<span class="l"><a class="anc" name="f029" href="#f029">[f029]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#USHORT_800a">USHORT_800a</a></span></span><span class="ce">; Load the lower byte of the portraits tileinfo address.</span></span>
<span class="l"><a class="anc" name="f02c" href="#f02c">[f02c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte in the read address.</span></span>
<span class="l"><a class="anc" name="f02e" href="#f02e">[f02e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#USHORT_800a">USHORT_800a</a>+1</span></span><span class="ce">; Load the upper byte of the portraits tileinfo address.</span></span>
<span class="l"><a class="anc" name="f031" href="#f031">[f031]</a><span class="cd"><span class="i">PLP</span></span><span class="ce">; Pop flags from the stack.</span></span>
<span class="l"><a class="anc" name="f032" href="#f032">[f032]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to the upper byte.</span></span>
<span class="l"><a class="anc" name="f034" href="#f034">[f034]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"><a class="anc" name="f036" href="#f036">[f036]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_Draw">Sprite_Draw</a></span></span><span class="ce">; Draw the portrait sprite.</span></span>
<span class="l"></span>
</pre><pre><a name="Sprite_SetPlayerAppearanceAddr"></a><div class="cp">;============================================================================
; TODO: Document Sprite_SetPlayerAppearanceAddr
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#Player_DrawShield">Player_DrawShield</a>
;     <a href="PRG14.html#Player_DrawWeapon">Player_DrawWeapon</a>
;     <a href="#FUN_PRG15_MIRROR__ec58">FUN_PRG15_MIRROR__ec58</a>
;     <a href="#Player_DrawBody">Player_DrawBody</a>
;============================================================================
</div><span class="l"><a class="anc" name="f039" href="#f039">[f039]</a><a href="#Sprite_SetPlayerAppearanceAddr" class="la">Sprite_SetPlayerAppearanceAddr:</a><span class="ce">; [$f039]</span></span>
<span class="l"><a class="anc" name="f039" href="#f039">[f039]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="f03a" href="#f03a">[f03a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f03d" href="#f03d">[f03d]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f03e" href="#f03e">[f03e]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="f040" href="#f040">[f040]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f043" href="#f043">[f043]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address to load sprite images from.
;
; With the addresses stored in <a href="PRG7.html#PLAYER_APPEARANCES_OFFSET">PLAYER_APPEARANCES_OFFSET</a>
; and
; <a href="PRG7.html#PLAYER_APPEARANCES_OFFSET">PLAYER_APPEARANCES_OFFSET</a>+1, this should put us at a
; starting
; point of {@address PRG7::A9F1}, or {@address PRG7::AAF1} if offset
; overflowed.
;
</div><span class="l"><a class="anc" name="f044" href="#f044">[f044]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f045" href="#f045">[f045]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="f046" href="#f046">[f046]</a><span class="cd"><span class="i">PHP</span></span></span>
<span class="l"><a class="anc" name="f047" href="#f047">[f047]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$8008</span></span></span>
<span class="l"><a class="anc" name="f04a" href="#f04a">[f04a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span></span>
<span class="l"><a class="anc" name="f04c" href="#f04c">[f04c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$8009</span></span></span>
<span class="l"><a class="anc" name="f04f" href="#f04f">[f04f]</a><span class="cd"><span class="i">PLP</span></span></span>
<span class="l"><a class="anc" name="f050" href="#f050">[f050]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="f052" href="#f052">[f052]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span></span>
<span class="l"><a class="anc" name="f054" href="#f054">[f054]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_Draw">Sprite_Draw</a></span></span></span>
</pre><pre><a name="Sprite_SetAppearanceAddrFromOffset"></a><div class="cp">;============================================================================
; TODO: Document Sprite_SetAppearanceAddrFromOffset
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG14.html#Sprite_EnterNextAppearancePhase">Sprite_EnterNextAppearancePhase</a>
;     <a href="#CastMagic_SetAppearance">CastMagic_SetAppearance</a>
;     <a href="#UI_DrawPromptInputSymbol">UI_DrawPromptInputSymbol</a>
;============================================================================
</div><span class="l"><a class="anc" name="f057" href="#f057">[f057]</a><a href="#Sprite_SetAppearanceAddrFromOffset" class="la">Sprite_SetAppearanceAddrFromOffset:</a><span class="ce">; [$f057]</span></span>
<div class="c">;
; Switch to ROM bank 7 (PRG).
;
</div><span class="l"><a class="anc" name="f057" href="#f057">[f057]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (offset)</span></span>
<span class="l"><a class="anc" name="f058" href="#f058">[f058]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="f05b" href="#f05b">[f05b]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f05c" href="#f05c">[f05c]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="f05e" href="#f05e">[f05e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 7 (PRG).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address to load sprite images from.
;
; With the addresses stored in <a href="PRG7.html#SPRITE_APPEARANCES_OFFSET">SPRITE_APPEARANCES_OFFSET</a>
; and
; <a href="PRG7.html#SPRITE_APPEARANCES_OFFSET">SPRITE_APPEARANCES_OFFSET</a>+1, this should put us at a
; starting
; point of {@address PRG7::9036}, or {@address PRG7::9136} if offset
; overflowed.
;
</div><span class="l"><a class="anc" name="f061" href="#f061">[f061]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (restore offset)</span></span>
<span class="l"><a class="anc" name="f062" href="#f062">[f062]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply offset by 2, to get word boundaries in the lookup table.</span></span>
<span class="l"><a class="anc" name="f063" href="#f063">[f063]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (updated offset)</span></span>
<span class="l"><a class="anc" name="f064" href="#f064">[f064]</a><span class="cd"><span class="i">PHP</span></span><span class="ce">; Push flags and stack pointer.</span></span>
<span class="l"><a class="anc" name="f065" href="#f065">[f065]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#EOLIS_BLOCKS">EOLIS_BLOCKS</a></span></span><span class="ce">; Load the lower byte of the address to read from.</span></span>
<span class="l"><a class="anc" name="f068" href="#f068">[f068]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it for processing.</span></span>
<span class="l"><a class="anc" name="f06a" href="#f06a">[f06a]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#EOLIS_BLOCKS">EOLIS_BLOCKS</a>+1</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="f06d" href="#f06d">[f06d]</a><span class="cd"><span class="i">PLP</span></span><span class="ce">; Pop the flags and stack pointer.</span></span>
<span class="l"><a class="anc" name="f06e" href="#f06e">[f06e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 + carry to the upper byte.</span></span>
<span class="l"><a class="anc" name="f070" href="#f070">[f070]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprite_Draw"></a><div class="cp">;============================================================================
; Begin drawing a sprite.
;
; This will load the tiles information for a sprite,
; determining the main bounding box, the extents, the
; pivot point when flipping, and generating a suitable
; X and Y position to begin drawing tiles.
;
; Tile information begins with a header in the following
; form:
;
;     Byte 0: Upper nibble = Row count - 1
;             Lower nibble = Column count -1
;     Byte 1: Offset X in pixels (if positive, extends the
;             sprite right; if negative, extends left)
;     Byte 2: Offset Y in pixels (if positive, extends the
;             sprite downward; if negative, extends upward)
;     Byte 3: Block-aligned X pixel pivot position used to
;             render the main body of the sprite in a stable
;             position when flipping horizontally (only used
;             in <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a>.
;
; This is followed by bytes pointing to tile indexes for the
; list of available tiles for the sprite (with 0xFF meaning
; "empty tile"). <a href="#Sprite_Draw_Standard">Sprite_Draw_Standard</a> and
; <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a> handles this.
;
; INPUTS:
;
;
; XREFS:
;     <a href="#Sprite_DrawPortraitPartAppearance">Sprite_DrawPortraitPartAppearance</a>
;     <a href="#Sprite_SetPlayerAppearanceAddr">Sprite_SetPlayerAppearanceAddr</a>
;============================================================================
</div><span class="l"><a class="anc" name="f072" href="#f072">[f072]</a><a href="#Sprite_Draw" class="la">Sprite_Draw:</a><span class="ce">; [$f072]</span></span>
<div class="c">;
; Load the offset within our starting address stored in
; <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>.
;
</div><span class="l"><a class="anc" name="f072" href="#f072">[f072]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the offset for the lower byte.</span></span>
<span class="l"><a class="anc" name="f074" href="#f074">[f074]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f076" href="#f076">[f076]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (offset)</span></span>
<span class="l"><a class="anc" name="f077" href="#f077">[f077]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="f079" href="#f079">[f079]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 + carry to it.</span></span>
<span class="l"><a class="anc" name="f07b" href="#f07b">[f07b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_ReadAddr_U">Sprite_TileInfo_ReadAddr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load a byte from that offset. The upper nibble will be
; stored at <a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a> and the lower nibble
; will
; be in <a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a>.
;
</div><span class="l"><a class="anc" name="f07d" href="#f07d">[f07d]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (read offset)</span></span>
<span class="l"><a class="anc" name="f07f" href="#f07f">[f07f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the value at that address.</span></span>
<span class="l"><a class="anc" name="f081" href="#f081">[f081]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span><span class="ce">; Discard the upper nibble.</span></span>
<span class="l"><a class="anc" name="f083" href="#f083">[f083]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f085" href="#f085">[f085]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load it again.</span></span>
<span class="l"><a class="anc" name="f087" href="#f087">[f087]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Move upper nibble to lower.</span></span>
<span class="l"><a class="anc" name="f088" href="#f088">[f088]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f089" href="#f089">[f089]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f08a" href="#f08a">[f08a]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f08b" href="#f08b">[f08b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Initialize <a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a> and
; <a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a>
; to 0 by default.
;
</div><span class="l"><a class="anc" name="f08d" href="#f08d">[f08d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f08f" href="#f08f">[f08f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span><span class="ce">; Set to 0.</span></span>
<span class="l"><a class="anc" name="f091" href="#f091">[f091]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; Set to 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the X offset extending from the main bounding box
; to fill with tiles.
;
; This may be negative (filling tiles left of the main bounding
; box of the sprite) or positive (adding padding left of the
; sprite).
;
</div><span class="l"><a class="anc" name="f093" href="#f093">[f093]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (read offset)</span></span>
<span class="l"><a class="anc" name="f094" href="#f094">[f094]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the X offset byte.</span></span>
<span class="l"><a class="anc" name="f096" href="#f096">[f096]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_calcX">@_calcX</a></span></span><span class="ce">; If &gt; 0, jump.</span></span>
<span class="l"><a class="anc" name="f098" href="#f098">[f098]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span><span class="ce">; Set to 0xFF. This will set C=1 for the add below.</span></span>
<span class="l"></span>
<a name=":f09a:@_calcX"></a><span class="l"><a class="anc" name="f09a" href="#f09a">[f09a]</a><a href="#:f09a:@_calcX" class="lla">@_calcX:</a><span class="ce">; [$f09a]</span></span>
<span class="l"><a class="anc" name="f09a" href="#f09a">[f09a]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f09b" href="#f09b">[f09b]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span><span class="ce">; Add <a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a> to the X offset (which may be negative, extending left).</span></span>
<span class="l"><a class="anc" name="f09d" href="#f09d">[f09d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate the new value for <a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a>.
;
</div><span class="l"><a class="anc" name="f09f" href="#f09f">[f09f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f0a1" href="#f0a1">[f0a1]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span><span class="ce">; Add our stored value.</span></span>
<span class="l"><a class="anc" name="f0a3" href="#f0a3">[f0a3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span><span class="ce">; Store it back out.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the drawn X position to factor in any screen scrolling
; offsets.
;
</div><span class="l"><a class="anc" name="f0a5" href="#f0a5">[f0a5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; Load the new calculated X position.</span></span>
<span class="l"><a class="anc" name="f0a7" href="#f0a7">[f0a7]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="f0a8" href="#f0a8">[f0a8]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#PPU_ScrollX">PPU_ScrollX</a></span></span><span class="ce">; Subtract any scrolling offset that may be set.</span></span>
<span class="l"><a class="anc" name="f0aa" href="#f0aa">[f0aa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the Y offset extending from the main bounding box
; to fill with tiles.
;
; This may be negative (filling tiles above the main bounding
; box of the sprite) or positive (adding padding above the
; sprite).
;
</div><span class="l"><a class="anc" name="f0ac" href="#f0ac">[f0ac]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (read offset)</span></span>
<span class="l"><a class="anc" name="f0ad" href="#f0ad">[f0ad]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the Y offset byte.</span></span>
<span class="l"><a class="anc" name="f0af" href="#f0af">[f0af]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_calcY">@_calcY</a></span></span><span class="ce">; If &gt; 0, jump.</span></span>
<span class="l"><a class="anc" name="f0b1" href="#f0b1">[f0b1]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; Set to 0xFF. This will set C=1 for the add below.</span></span>
<span class="l"></span>
<a name=":f0b3:@_calcY"></a><span class="l"><a class="anc" name="f0b3" href="#f0b3">[f0b3]</a><a href="#:f0b3:@_calcY" class="lla">@_calcY:</a><span class="ce">; [$f0b3]</span></span>
<span class="l"><a class="anc" name="f0b3" href="#f0b3">[f0b3]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f0b4" href="#f0b4">[f0b4]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span><span class="ce">; Add <a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a> to the Y offset (which may be negative, extending up).</span></span>
<span class="l"><a class="anc" name="f0b6" href="#f0b6">[f0b6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add Carry to the offset, if it's set.
;
</div><span class="l"><a class="anc" name="f0b8" href="#f0b8">[f0b8]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f0ba" href="#f0ba">[f0ba]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; A = Y offset + carry (from above).</span></span>
<span class="l"><a class="anc" name="f0bc" href="#f0bc">[f0bc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; And then always offset by 32 pixels (the HUD height).
;
</div><span class="l"><a class="anc" name="f0be" href="#f0be">[f0be]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span><span class="ce">; Load the normalized Y position.</span></span>
<span class="l"><a class="anc" name="f0c0" href="#f0c0">[f0c0]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f0c1" href="#f0c1">[f0c1]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$20</span></span><span class="ce">; Add 32 (HUD height in pixels).</span></span>
<span class="l"><a class="anc" name="f0c3" href="#f0c3">[f0c3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add Carry again to the Y offset, if set. This happens if
; the HUD offset causes the value to overflow.
;
</div><span class="l"><a class="anc" name="f0c5" href="#f0c5">[f0c5]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; Load the Y offset.</span></span>
<span class="l"><a class="anc" name="f0c7" href="#f0c7">[f0c7]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add Carry, if set.</span></span>
<span class="l"><a class="anc" name="f0c9" href="#f0c9">[f0c9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the block-aligned X pixel pivot point into the sprite
; used to anchor the sprite when flipping. This is generally
; the left-most tile of the main body of the sprite. When
; the sprite turns around, it pivots at this point.
;
; Only <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a> uses this.
;
</div><span class="l"><a class="anc" name="f0cb" href="#f0cb">[f0cb]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (read offset).</span></span>
<span class="l"><a class="anc" name="f0cc" href="#f0cc">[f0cc]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the pivot point in pixels.</span></span>
<span class="l"><a class="anc" name="f0ce" href="#f0ce">[f0ce]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store it for use if drawing flipped.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Advance our start read address for this sprite to skip the 4
; bytes we just read.
;
</div><span class="l"><a class="anc" name="f0d0" href="#f0d0">[f0d0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a></span></span><span class="ce">; Load the lower byte of the sprite address.</span></span>
<span class="l"><a class="anc" name="f0d2" href="#f0d2">[f0d2]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f0d3" href="#f0d3">[f0d3]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$04</span></span><span class="ce">; Advance by 4 (skipping loaded state).</span></span>
<span class="l"><a class="anc" name="f0d5" href="#f0d5">[f0d5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a></span></span><span class="ce">; Set as the new lower byte of the address.</span></span>
<span class="l"><a class="anc" name="f0d7" href="#f0d7">[f0d7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_ReadAddr_U">Sprite_TileInfo_ReadAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="f0d9" href="#f0d9">[f0d9]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry, if lower overflowed.</span></span>
<span class="l"><a class="anc" name="f0db" href="#f0db">[f0db]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_ReadAddr_U">Sprite_TileInfo_ReadAddr_U</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We'll continue on based on whether the sprite is flipped.
;
</div><span class="l"><a class="anc" name="f0dd" href="#f0dd">[f0dd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Load the flip mask.</span></span>
<span class="l"><a class="anc" name="f0df" href="#f0df">[f0df]</a><span class="cd"><span class="i">AND</span> <span class="o">#$c0</span></span><span class="ce">; Keep only the horiz/vert flip bits.</span></span>
<span class="l"><a class="anc" name="f0e1" href="#f0e1">[f0e1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Store as a new flip mask.</span></span>
<span class="l"><a class="anc" name="f0e3" href="#f0e3">[f0e3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Load the resulting flip mask.</span></span>
<span class="l"><a class="anc" name="f0e5" href="#f0e5">[f0e5]</a><span class="cd"><span class="i">AND</span> <span class="o">#$40</span></span><span class="ce">; Check if it's flipped horizontally.</span></span>
<span class="l"><a class="anc" name="f0e7" href="#f0e7">[f0e7]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#Sprite_Draw_Standard">Sprite_Draw_Standard</a></span></span><span class="ce">; If not, draw in standard orientation.</span></span>
<span class="l"><a class="anc" name="f0e9" href="#f0e9">[f0e9]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a></span></span><span class="ce">; Else, draw horizontally flipped.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprite_Draw_Standard"></a><div class="cp">;============================================================================
; Draw all tiles for a sprite in the standard orientation.
;
; This will loop through all rows of the sprite, then all
; columns in a row, drawing each tile of the sprite.
;
; Tiles are read from the sprite information in bank 7,
; which is in the following form:
;
;     Byte 0: Upper = Row count - 1
;             Lower = Column count -1
;     Byte 1: Offset X (between first tile and "front" tile
;             used for alignment)
;     Byte 2: Offset Y
;     Byte 3: Block-aligned pixel position of the "front"
;             tile for alignment when flipping horizontally
;
; Followed by bytes pointing to tile indexes for the list
; of available tiles for the sprite (with 0xFF meaning
; "empty tile").
;
; INPUTS:
;
;
; XREFS:
;     <a href="#Sprite_Draw">Sprite_Draw</a>
;============================================================================
</div><span class="l"><a class="anc" name="f0ec" href="#f0ec">[f0ec]</a><a href="#Sprite_Draw_Standard" class="la">Sprite_Draw_Standard:</a><span class="ce">; [$f0ec]</span></span>
<div class="c">;
; The sprite is not flipped.
;
</div><span class="l"><a class="anc" name="f0ec" href="#f0ec">[f0ec]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0.</span></span>
<span class="l"><a class="anc" name="f0ee" href="#f0ee">[f0ee]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span><span class="ce">; Store it as the starting tiles Y offset.</span></span>
<span class="l"><a class="anc" name="f0f0" href="#f0f0">[f0f0]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (0, loop counter).</span></span>
<span class="l"></span>
<a name=":f0f1:@_drawRowLoop"></a><span class="l"><a class="anc" name="f0f1" href="#f0f1">[f0f1]</a><a href="#:f0f1:@_drawRowLoop" class="lla">@_drawRowLoop:</a><span class="ce">; [$f0f1]</span></span>
<span class="l"><a class="anc" name="f0f1" href="#f0f1">[f0f1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Load the number of tile columns remaining.</span></span>
<span class="l"><a class="anc" name="f0f3" href="#f0f3">[f0f3]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f0f4" href="#f0f4">[f0f4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0.</span></span>
<span class="l"><a class="anc" name="f0f6" href="#f0f6">[f0f6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span><span class="ce">; Store as the start tiles X offset.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f0f8:@_drawColLoop"></a><div class="c">;
; Check if the current sprite data value is not 0xFF (unset).
;
</div><span class="l"><a class="anc" name="f0f8" href="#f0f8">[f0f8]</a><a href="#:f0f8:@_drawColLoop" class="lla">@_drawColLoop:</a><span class="ce">; [$f0f8]</span></span>
<span class="l"><a class="anc" name="f0f8" href="#f0f8">[f0f8]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the value at the sprite data read address.</span></span>
<span class="l"><a class="anc" name="f0fa" href="#f0fa">[f0fa]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="f0fc" href="#f0fc">[f0fc]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_prepareNextCol">@_prepareNextCol</a></span></span><span class="ce">; If so, skip this row.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; It's not unset.
;
; Begin checking if we can add to the PPU.
;
; First we'll check if we can add sprites, or if the slots
; are full.
;
</div><span class="l"><a class="anc" name="f0fe" href="#f0fe">[f0fe]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a></span></span><span class="ce">; Can we add sprites this frame?</span></span>
<span class="l"><a class="anc" name="f100" href="#f100">[f100]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_endColLoop">@_endColLoop</a></span></span><span class="ce">; If not, jump, try the next row.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We can add sprites.
;
; Calculate the X coordinate as:
;
;     X = <a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a> +
;         <a href="#SPRITE_TILE_BLOCK_POSITIONS">SPRITE_TILE_BLOCK_POSITIONS</a>[<a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a>]
;
; With <a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a> being a block
; offset (each block being 16 pixels), the sprites are
; effectively started at a block position and then added
; normalized to a pixel position.
;
</div><span class="l"><a class="anc" name="f102" href="#f102">[f102]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span><span class="ce">; X = tile X offset.</span></span>
<span class="l"><a class="anc" name="f104" href="#f104">[f104]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; A = normalized X position.</span></span>
<span class="l"><a class="anc" name="f106" href="#f106">[f106]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#SPRITE_TILE_BLOCK_POSITIONS">SPRITE_TILE_BLOCK_POSITIONS</a>,X</span></span><span class="ce">; A += the offset from the lookup table at X.</span></span>
<span class="l"><a class="anc" name="f109" href="#f109">[f109]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this tile would fit on screen in the X direction.
;
</div><span class="l"><a class="anc" name="f10b" href="#f10b">[f10b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span><span class="ce">; Load the default X position.</span></span>
<span class="l"><a class="anc" name="f10d" href="#f10d">[f10d]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry (from overflow), if set.</span></span>
<span class="l"><a class="anc" name="f10f" href="#f10f">[f10f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_endColLoop">@_endColLoop</a></span></span><span class="ce">; If it doesn't fit on screen, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; X could fit on screen. Check Y.
;
; This will be calculated as:
;
;     Y = <a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a> +
;         <a href="#SPRITE_TILE_BLOCK_POSITIONS">SPRITE_TILE_BLOCK_POSITIONS</a>[<a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a>]
;
; Same logic applies as aboe.
;
</div><span class="l"><a class="anc" name="f111" href="#f111">[f111]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span><span class="ce">; X = tile Y offset.</span></span>
<span class="l"><a class="anc" name="f113" href="#f113">[f113]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span><span class="ce">; A = normalized Y position.</span></span>
<span class="l"><a class="anc" name="f115" href="#f115">[f115]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#SPRITE_TILE_BLOCK_POSITIONS">SPRITE_TILE_BLOCK_POSITIONS</a>,X</span></span><span class="ce">; A += the offset from the lookup table at X.</span></span>
<span class="l"><a class="anc" name="f118" href="#f118">[f118]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Store it temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if this tile would fit on screen in the Y direction.
;
</div><span class="l"><a class="anc" name="f11a" href="#f11a">[f11a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span><span class="ce">; Load the default Y position.</span></span>
<span class="l"><a class="anc" name="f11c" href="#f11c">[f11c]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry (from overflow), if set.</span></span>
<span class="l"><a class="anc" name="f11e" href="#f11e">[f11e]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_endColLoop">@_endColLoop</a></span></span><span class="ce">; If it doesn't fit on screen, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The sprite fits on screen.
;
; We'll begin writing the sprite to DMA.
;
</div><span class="l"><a class="anc" name="f120" href="#f120">[f120]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (loop counter)</span></span>
<span class="l"><a class="anc" name="f121" href="#f121">[f121]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push our loop counter to the stack.</span></span>
<span class="l"><a class="anc" name="f122" href="#f122">[f122]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Load the slot for this sprite.</span></span>
<span class="l"><a class="anc" name="f124" href="#f124">[f124]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 4 (for Y, tile ID, attributes, X bytes).</span></span>
<span class="l"><a class="anc" name="f125" href="#f125">[f125]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f126" href="#f126">[f126]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="RAM.html#Sprites_StartSlotRange">Sprites_StartSlotRange</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write the sprite Y position to DMA.
;
</div><span class="l"><a class="anc" name="f128" href="#f128">[f128]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (read offset)</span></span>
<span class="l"><a class="anc" name="f129" href="#f129">[f129]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Load the Y position.</span></span>
<span class="l"><a class="anc" name="f12b" href="#f12b">[f12b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Write the Y position to DMA.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write the sprite tile ID to DMA.
;
; The byte value is an index into the list of PPU tile IDs.
;
</div><span class="l"><a class="anc" name="f12e" href="#f12e">[f12e]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (read offset)</span></span>
<span class="l"><a class="anc" name="f12f" href="#f12f">[f12f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the tile index.</span></span>
<span class="l"><a class="anc" name="f131" href="#f131">[f131]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f132" href="#f132">[f132]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span><span class="ce">; Add the PPU starting offset for the list of tiles.</span></span>
<span class="l"><a class="anc" name="f134" href="#f134">[f134]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Write the tile ID to DMA.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write the sprite attributes.
;
; This will primarily be the palette, but it may also contain
; a flip mask. The flip mask will be normalized based on
; whether the full sprite is flipped.
;
</div><span class="l"><a class="anc" name="f137" href="#f137">[f137]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (read offset)</span></span>
<span class="l"><a class="anc" name="f138" href="#f138">[f138]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter)</span></span>
<span class="l"><a class="anc" name="f139" href="#f139">[f139]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span><span class="ce">; Load the attribute.</span></span>
<span class="l"><a class="anc" name="f13b" href="#f13b">[f13b]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; XOR with the flip mask.</span></span>
<span class="l"><a class="anc" name="f13d" href="#f13d">[f13d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate visibility for this tile.
;
; This will check if the tile is even or odd, using that
; as an index into <a href="#DRAW_SPRITE_VISIBILITY_MASK">DRAW_SPRITE_VISIBILITY_MASK</a>.
;
; If the tile is not visible, it will be set to background
; priority.
;
</div><span class="l"><a class="anc" name="f13f" href="#f13f">[f13f]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span><span class="ce">; Load the tile X offset.</span></span>
<span class="l"><a class="anc" name="f141" href="#f141">[f141]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Convert to an even/odd value for the visibility lookup table.</span></span>
<span class="l"><a class="anc" name="f143" href="#f143">[f143]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = result.</span></span>
<span class="l"><a class="anc" name="f144" href="#f144">[f144]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span><span class="ce">; Load the moving visibility of the sprite.</span></span>
<span class="l"><a class="anc" name="f146" href="#f146">[f146]</a><span class="cd"><span class="i">AND</span> <span class="o"><a href="#DRAW_SPRITE_VISIBILITY_MASK">DRAW_SPRITE_VISIBILITY_MASK</a>,Y</span></span><span class="ce">; AND with the lookup table, determining priority.</span></span>
<span class="l"><a class="anc" name="f149" href="#f149">[f149]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_storeAttribute">@_storeAttribute</a></span></span><span class="ce">; If non-0, keep foreground priority.
Else...</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The tile is obscured. Set the sprite to be a
; background sprite.
;
</div><span class="l"><a class="anc" name="f14b" href="#f14b">[f14b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Load the attribute calculated above.</span></span>
<span class="l"><a class="anc" name="f14d" href="#f14d">[f14d]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$20</span></span><span class="ce">; Set background priority.</span></span>
<span class="l"><a class="anc" name="f14f" href="#f14f">[f14f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; And store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f151:@_storeAttribute"></a><div class="c">;
; Write the tile attribute to DMA.
;
</div><span class="l"><a class="anc" name="f151" href="#f151">[f151]</a><a href="#:f151:@_storeAttribute" class="lla">@_storeAttribute:</a><span class="ce">; [$f151]</span></span>
<span class="l"><a class="anc" name="f151" href="#f151">[f151]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span><span class="ce">; Load the calculated attribute.</span></span>
<span class="l"><a class="anc" name="f153" href="#f153">[f153]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Store the tile attributes to DMA.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write the sprite X position to DMA.
;
</div><span class="l"><a class="anc" name="f156" href="#f156">[f156]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (read offset)</span></span>
<span class="l"><a class="anc" name="f157" href="#f157">[f157]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span><span class="ce">; Load the X position.</span></span>
<span class="l"><a class="anc" name="f159" href="#f159">[f159]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span><span class="ce">; Write the X coordinate to DMA.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare for the next column.
;
</div><span class="l"><a class="anc" name="f15c" href="#f15c">[f15c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_IncNextSpriteSlot">Sprites_IncNextSpriteSlot</a></span></span><span class="ce">; Finish up with this sprite's state.</span></span>
<span class="l"><a class="anc" name="f15f" href="#f15f">[f15f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A (loop counter) from stack.</span></span>
<span class="l"><a class="anc" name="f160" href="#f160">[f160]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (loop counter)</span></span>
<span class="l"></span>
<a name=":f161:@_endColLoop"></a><span class="l"><a class="anc" name="f161" href="#f161">[f161]</a><a href="#:f161:@_endColLoop" class="lla">@_endColLoop:</a><span class="ce">; [$f161]</span></span>
<span class="l"><a class="anc" name="f161" href="#f161">[f161]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter)</span></span>
<span class="l"></span>
<a name=":f162:@_prepareNextCol"></a><span class="l"><a class="anc" name="f162" href="#f162">[f162]</a><a href="#:f162:@_prepareNextCol" class="lla">@_prepareNextCol:</a><span class="ce">; [$f162]</span></span>
<span class="l"><a class="anc" name="f162" href="#f162">[f162]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter)</span></span>
<span class="l"><a class="anc" name="f163" href="#f163">[f163]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span><span class="ce">; Increment the tile X offset.</span></span>
<span class="l"><a class="anc" name="f165" href="#f165">[f165]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Decrement the number of columns remaining.</span></span>
<span class="l"><a class="anc" name="f167" href="#f167">[f167]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_drawColLoop">@_drawColLoop</a></span></span><span class="ce">; If there are columns remaining, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're on the next row. Reset the column count and advance
; the row counter.
;
</div><span class="l"><a class="anc" name="f169" href="#f169">[f169]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the original total columns remaining.</span></span>
<span class="l"><a class="anc" name="f16a" href="#f16a">[f16a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Store as the new columns count for the next row.</span></span>
<span class="l"><a class="anc" name="f16c" href="#f16c">[f16c]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span><span class="ce">; Increment the tile Y offset.</span></span>
<span class="l"><a class="anc" name="f16e" href="#f16e">[f16e]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a></span></span><span class="ce">; Decrement the number of rows remaining.</span></span>
<span class="l"><a class="anc" name="f170" href="#f170">[f170]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#Sprite_Draw_Finish">Sprite_Draw_Finish</a></span></span><span class="ce">; If there are no more rows, finish the drawing.</span></span>
<span class="l"><a class="anc" name="f172" href="#f172">[f172]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@_drawRowLoop">@_drawRowLoop</a></span></span><span class="ce">; Else, loop to draw the next row.</span></span>
<span class="l"></span>
</pre><pre><a name="Sprite_Draw_Finish"></a><div class="cp">;============================================================================
; TODO: Document Sprite_Draw_Finish
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a>
;     <a href="#Sprite_Draw_Standard">Sprite_Draw_Standard</a>
;============================================================================
</div><span class="l"><a class="anc" name="f175" href="#f175">[f175]</a><a href="#Sprite_Draw_Finish" class="la">Sprite_Draw_Finish:</a><span class="ce">; [$f175]</span></span>
<span class="l"><a class="anc" name="f175" href="#f175">[f175]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="f176" href="#f176">[f176]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="f177" href="#f177">[f177]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f17a" href="#f17a">[f17a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f17c" href="#f17c">[f17c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span></span>
<span class="l"><a class="anc" name="f17e" href="#f17e">[f17e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span></span>
<span class="l"><a class="anc" name="f180" href="#f180">[f180]</a><span class="cd"><span class="i">RTS</span></span></span>
</pre><pre><a name="Sprite_Draw_FlippedHoriz"></a><div class="cp">;============================================================================
; TODO: Document Sprite_Draw_FlippedHoriz
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#Sprite_Draw">Sprite_Draw</a>
;============================================================================
</div><span class="l"><a class="anc" name="f181" href="#f181">[f181]</a><a href="#Sprite_Draw_FlippedHoriz" class="la">Sprite_Draw_FlippedHoriz:</a><span class="ce">; [$f181]</span></span>
<div class="c">;
; The sprite is flipped.
;
</div><span class="l"><a class="anc" name="f181" href="#f181">[f181]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f183" href="#f183">[f183]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Set <a href="RAM.html#Temp_05">Temp_05</a> = 0.</span></span>
<span class="l"><a class="anc" name="f185" href="#f185">[f185]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span><span class="ce">; Load the number of columns remaining for a row.</span></span>
<span class="l"><a class="anc" name="f187" href="#f187">[f187]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (convert from 0-based count)</span></span>
<span class="l"><a class="anc" name="f188" href="#f188">[f188]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = result</span></span>
<span class="l"><a class="anc" name="f189" href="#f189">[f189]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply the columns by 8.</span></span>
<span class="l"><a class="anc" name="f18a" href="#f18a">[f18a]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f18b" href="#f18b">[f18b]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f18c" href="#f18c">[f18c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span><span class="ce">; Store for temporary use.</span></span>
<span class="l"><a class="anc" name="f18e" href="#f18e">[f18e]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; A = 4th byte from the sprite information.</span></span>
<span class="l"><a class="anc" name="f190" href="#f190">[f190]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A = A * 2</span></span>
<span class="l"><a class="anc" name="f191" href="#f191">[f191]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="f192" href="#f192">[f192]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span><span class="ce">; A = A - normalized column value.</span></span>
<span class="l"><a class="anc" name="f194" href="#f194">[f194]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f198">@LAB_PRG15_MIRROR__f198</a></span></span><span class="ce">; If negative, jump.</span></span>
<span class="l"><a class="anc" name="f196" href="#f196">[f196]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Else, it's positive. Decrement <a href="RAM.html#Temp_05">Temp_05</a>.</span></span>
<span class="l"></span>
<a name=":f198:@LAB_PRG15_MIRROR__f198"></a><span class="l"><a class="anc" name="f198" href="#f198">[f198]</a><a href="#:f198:@LAB_PRG15_MIRROR__f198" class="lla">@LAB_PRG15_MIRROR__f198:</a><span class="ce">; [$f198]</span></span>
<span class="l"><a class="anc" name="f198" href="#f198">[f198]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f199" href="#f199">[f199]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; A = A + normalized X position</span></span>
<span class="l"><a class="anc" name="f19b" href="#f19b">[f19b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span><span class="ce">; Store as the new position.</span></span>
<span class="l"><a class="anc" name="f19d" href="#f19d">[f19d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span></span>
<span class="l"><a class="anc" name="f19f" href="#f19f">[f19f]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="f1a1" href="#f1a1">[f1a1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span></span>
<span class="l"><a class="anc" name="f1a3" href="#f1a3">[f1a3]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f1a5" href="#f1a5">[f1a5]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><a class="anc" name="f1a7" href="#f1a7">[f1a7]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"></span>
<a name=":f1a8:@LAB_PRG15_MIRROR__f1a8"></a><span class="l"><a class="anc" name="f1a8" href="#f1a8">[f1a8]</a><a href="#:f1a8:@LAB_PRG15_MIRROR__f1a8" class="lla">@LAB_PRG15_MIRROR__f1a8:</a><span class="ce">; [$f1a8]</span></span>
<span class="l"><a class="anc" name="f1a8" href="#f1a8">[f1a8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_ColsRemaining">Temp_Sprites_ColsRemaining</a></span></span></span>
<span class="l"><a class="anc" name="f1aa" href="#f1aa">[f1aa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"></span>
<a name=":f1ac:@LAB_PRG15_MIRROR__f1ac"></a><span class="l"><a class="anc" name="f1ac" href="#f1ac">[f1ac]</a><a href="#:f1ac:@LAB_PRG15_MIRROR__f1ac" class="lla">@LAB_PRG15_MIRROR__f1ac:</a><span class="ce">; [$f1ac]</span></span>
<span class="l"><a class="anc" name="f1ac" href="#f1ac">[f1ac]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="f1ae" href="#f1ae">[f1ae]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f1b0" href="#f1b0">[f1b0]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f216">@LAB_PRG15_MIRROR__f216</a></span></span></span>
<span class="l"><a class="anc" name="f1b2" href="#f1b2">[f1b2]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a></span></span></span>
<span class="l"><a class="anc" name="f1b4" href="#f1b4">[f1b4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f215">@LAB_PRG15_MIRROR__f215</a></span></span></span>
<span class="l"><a class="anc" name="f1b6" href="#f1b6">[f1b6]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><a class="anc" name="f1b8" href="#f1b8">[f1b8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormXPos">Temp_Sprites_NormXPos</a></span></span></span>
<span class="l"><a class="anc" name="f1ba" href="#f1ba">[f1ba]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#SPRITE_TILE_BLOCK_POSITIONS">SPRITE_TILE_BLOCK_POSITIONS</a>,X</span></span></span>
<span class="l"><a class="anc" name="f1bd" href="#f1bd">[f1bd]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="f1bf" href="#f1bf">[f1bf]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetX">Sprite_TileInfo_OffsetX</a></span></span></span>
<span class="l"><a class="anc" name="f1c1" href="#f1c1">[f1c1]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f1c3" href="#f1c3">[f1c3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f215">@LAB_PRG15_MIRROR__f215</a></span></span></span>
<span class="l"><a class="anc" name="f1c5" href="#f1c5">[f1c5]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><a class="anc" name="f1c7" href="#f1c7">[f1c7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_NormYPos">Temp_Sprites_NormYPos</a></span></span></span>
<span class="l"><a class="anc" name="f1c9" href="#f1c9">[f1c9]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#SPRITE_TILE_BLOCK_POSITIONS">SPRITE_TILE_BLOCK_POSITIONS</a>,X</span></span></span>
<span class="l"><a class="anc" name="f1cc" href="#f1cc">[f1cc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="f1ce" href="#f1ce">[f1ce]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprite_TileInfo_OffsetY">Sprite_TileInfo_OffsetY</a></span></span></span>
<span class="l"><a class="anc" name="f1d0" href="#f1d0">[f1d0]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f1d2" href="#f1d2">[f1d2]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f215">@LAB_PRG15_MIRROR__f215</a></span></span></span>
<span class="l"><a class="anc" name="f1d4" href="#f1d4">[f1d4]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="f1d5" href="#f1d5">[f1d5]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f1d6" href="#f1d6">[f1d6]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span></span>
<span class="l"><a class="anc" name="f1d8" href="#f1d8">[f1d8]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f1d9" href="#f1d9">[f1d9]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f1da" href="#f1da">[f1da]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="RAM.html#Sprites_StartSlotRange">Sprites_StartSlotRange</a></span></span></span>
<span class="l"><a class="anc" name="f1dc" href="#f1dc">[f1dc]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="f1dd" href="#f1dd">[f1dd]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="f1df" href="#f1df">[f1df]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span></span>
<span class="l"><a class="anc" name="f1e2" href="#f1e2">[f1e2]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="f1e3" href="#f1e3">[f1e3]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="f1e5" href="#f1e5">[f1e5]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f1e6" href="#f1e6">[f1e6]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span></span>
<span class="l"><a class="anc" name="f1e8" href="#f1e8">[f1e8]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span></span>
<span class="l"><a class="anc" name="f1eb" href="#f1eb">[f1eb]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="f1ec" href="#f1ec">[f1ec]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="f1ed" href="#f1ed">[f1ed]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Sprite_TileInfo_ReadAddr_L">Sprite_TileInfo_ReadAddr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="f1ef" href="#f1ef">[f1ef]</a><span class="cd"><span class="i">EOR</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span></span>
<span class="l"><a class="anc" name="f1f1" href="#f1f1">[f1f1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="f1f3" href="#f1f3">[f1f3]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><a class="anc" name="f1f5" href="#f1f5">[f1f5]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="f1f7" href="#f1f7">[f1f7]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="f1f8" href="#f1f8">[f1f8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#MovingSpriteVisibility">MovingSpriteVisibility</a></span></span></span>
<span class="l"><a class="anc" name="f1fa" href="#f1fa">[f1fa]</a><span class="cd"><span class="i">AND</span> <span class="o">$f226,Y</span></span></span>
<span class="l"><a class="anc" name="f1fd" href="#f1fd">[f1fd]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f205">@LAB_PRG15_MIRROR__f205</a></span></span></span>
<span class="l"><a class="anc" name="f1ff" href="#f1ff">[f1ff]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="f201" href="#f201">[f201]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f203" href="#f203">[f203]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"></span>
<a name=":f205:@LAB_PRG15_MIRROR__f205"></a><span class="l"><a class="anc" name="f205" href="#f205">[f205]</a><a href="#:f205:@LAB_PRG15_MIRROR__f205" class="lla">@LAB_PRG15_MIRROR__f205:</a><span class="ce">; [$f205]</span></span>
<span class="l"><a class="anc" name="f205" href="#f205">[f205]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_01">Temp_01</a></span></span></span>
<span class="l"><a class="anc" name="f207" href="#f207">[f207]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span></span>
<span class="l"><a class="anc" name="f20a" href="#f20a">[f20a]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="f20b" href="#f20b">[f20b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_00">Temp_00</a></span></span></span>
<span class="l"><a class="anc" name="f20d" href="#f20d">[f20d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#SPRITE_0_RANGE_1_START">SPRITE_0_RANGE_1_START</a>,X</span></span></span>
<span class="l"><a class="anc" name="f210" href="#f210">[f210]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprites_IncNextSpriteSlot">Sprites_IncNextSpriteSlot</a></span></span></span>
<span class="l"><a class="anc" name="f213" href="#f213">[f213]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="f214" href="#f214">[f214]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"></span>
<a name=":f215:@LAB_PRG15_MIRROR__f215"></a><span class="l"><a class="anc" name="f215" href="#f215">[f215]</a><a href="#:f215:@LAB_PRG15_MIRROR__f215" class="lla">@LAB_PRG15_MIRROR__f215:</a><span class="ce">; [$f215]</span></span>
<span class="l"><a class="anc" name="f215" href="#f215">[f215]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"></span>
<a name=":f216:@LAB_PRG15_MIRROR__f216"></a><span class="l"><a class="anc" name="f216" href="#f216">[f216]</a><a href="#:f216:@LAB_PRG15_MIRROR__f216" class="lla">@LAB_PRG15_MIRROR__f216:</a><span class="ce">; [$f216]</span></span>
<span class="l"><a class="anc" name="f216" href="#f216">[f216]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="f217" href="#f217">[f217]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileXOffset">Temp_Sprites_TileXOffset</a></span></span></span>
<span class="l"><a class="anc" name="f219" href="#f219">[f219]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f1ac">@LAB_PRG15_MIRROR__f1ac</a></span></span></span>
<span class="l"><a class="anc" name="f21b" href="#f21b">[f21b]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Sprites_TileYOffset">Temp_Sprites_TileYOffset</a></span></span></span>
<span class="l"><a class="anc" name="f21d" href="#f21d">[f21d]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Sprites_RowsRemaining">Temp_Sprites_RowsRemaining</a></span></span></span>
<span class="l"><a class="anc" name="f21f" href="#f21f">[f21f]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f1a8">@LAB_PRG15_MIRROR__f1a8</a></span></span></span>
<span class="l"><a class="anc" name="f221" href="#f221">[f221]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_Draw_Finish">Sprite_Draw_Finish</a></span></span></span>
<span class="l"></span>
<a name="DRAW_SPRITE_VISIBILITY_MASK"></a><div class="c">;
; XREFS:
;     <a href="#Sprite_Draw_Standard">Sprite_Draw_Standard</a>
;
</div><span class="l"><a class="anc" name="f224" href="#f224">[f224]</a><a href="#DRAW_SPRITE_VISIBILITY_MASK" class="la">DRAW_SPRITE_VISIBILITY_MASK:</a><span class="ce">; [$f224]</span></span>
<span class="l"><a class="anc" name="f224" href="#f224">[f224]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]: Trailing visibility</span></span>
<span class="l"><a class="anc" name="f225" href="#f225">[f225]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]: Leading visibility</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__f226"></a><div class="c">;
; XREFS:
;     <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a>
;
</div><span class="l"><a class="anc" name="f226" href="#f226">[f226]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__f226" class="la">BYTE_ARRAY_PRG15_MIRROR__f226:</a><span class="ce">; [$f226]</span></span>
<span class="l"><a class="anc" name="f226" href="#f226">[f226]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="f227" href="#f227">[f227]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Sprites_IncNextSpriteSlot"></a><div class="cp">;============================================================================
; Increment the sprite slot, and mark when full.
;
; This alternates the sprite slots between 0-31 and 32-63.
; When populating 0-31, it will track whether all slots are
; full, and if so, <a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a> will be set
; to prevent further sprites from being added.
;
; INPUTS:
;     <a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a>:
;         The current slot for the next sprite.
;
; OUTPUTS:
;     <a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a>:
;         The next slot for the next sprite, if updated.
;
;     <a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a>:
;         Set to 1 (rather, incremented, but practically)
;         if the slots are full.
;
; XREFS:
;     <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a>
;     <a href="#Sprite_Draw_Standard">Sprite_Draw_Standard</a>
;============================================================================
</div><span class="l"><a class="anc" name="f228" href="#f228">[f228]</a><a href="#Sprites_IncNextSpriteSlot" class="la">Sprites_IncNextSpriteSlot:</a><span class="ce">; [$f228]</span></span>
<div class="c">;
; Alternate between sprites 0-31 and sprites 32-63.
;
; The bit being flipped is bit 5, value 32.
;
</div><span class="l"><a class="anc" name="f228" href="#f228">[f228]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Load the sprite slot ID.</span></span>
<span class="l"><a class="anc" name="f22a" href="#f22a">[f22a]</a><span class="cd"><span class="i">EOR</span> <span class="o">#$20</span></span><span class="ce">; Cap the value to &lt; 32.</span></span>
<span class="l"><a class="anc" name="f22c" href="#f22c">[f22c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Store the result.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If we're populating sprites 0-31, we'll check if we've
; hit the cap. If we're populating 32-63, we're done.
;
</div><span class="l"><a class="anc" name="f22e" href="#f22e">[f22e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$20</span></span><span class="ce">; Check if we're in 32-63.</span></span>
<span class="l"><a class="anc" name="f230" href="#f230">[f230]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; It's in sprite range 0-31.
;
</div><span class="l"><a class="anc" name="f232" href="#f232">[f232]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Increase the sprite slot.</span></span>
<span class="l"><a class="anc" name="f234" href="#f234">[f234]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Sprites_SpriteSlot">Sprites_SpriteSlot</a></span></span><span class="ce">; Load the new slot.</span></span>
<span class="l"><a class="anc" name="f236" href="#f236">[f236]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$20</span></span><span class="ce">; Are there slots left?</span></span>
<span class="l"><a class="anc" name="f238" href="#f238">[f238]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If so, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The slots are full. Mark it.
;
</div><span class="l"><a class="anc" name="f23a" href="#f23a">[f23a]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Sprites_SlotsFull">Sprites_SlotsFull</a></span></span><span class="ce">; Mark slots as full.</span></span>
<span class="l"></span>
<a name=":f23c:@_return"></a><span class="l"><a class="anc" name="f23c" href="#f23c">[f23c]</a><a href="#:f23c:@_return" class="lla">@_return:</a><span class="ce">; [$f23c]</span></span>
<span class="l"><a class="anc" name="f23c" href="#f23c">[f23c]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="SPRITE_TILE_BLOCK_POSITIONS"></a><div class="c">;
; XREFS:
;     <a href="#Sprite_Draw_FlippedHoriz">Sprite_Draw_FlippedHoriz</a>
;     <a href="#Sprite_Draw_Standard">Sprite_Draw_Standard</a>
;
</div><span class="l"><a class="anc" name="f23d" href="#f23d">[f23d]</a><a href="#SPRITE_TILE_BLOCK_POSITIONS" class="la">SPRITE_TILE_BLOCK_POSITIONS:</a><span class="ce">; [$f23d]</span></span>
<span class="l"><a class="anc" name="f23d" href="#f23d">[f23d]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="f23e" href="#f23e">[f23e]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="f23f" href="#f23f">[f23f]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="f240" href="#f240">[f240]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="f241" href="#f241">[f241]</a><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="f242" href="#f242">[f242]</a><span class="cd"><span class="i">db</span> <span class="o">$28</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="f243" href="#f243">[f243]</a><span class="cd"><span class="i">db</span> <span class="o">$30</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="f244" href="#f244">[f244]</a><span class="cd"><span class="i">db</span> <span class="o">$38</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="f245" href="#f245">[f245]</a><span class="cd"><span class="i">db</span> <span class="o">$40</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="f246" href="#f246">[f246]</a><span class="cd"><span class="i">db</span> <span class="o">$48</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="f247" href="#f247">[f247]</a><span class="cd"><span class="i">db</span> <span class="o">$50</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="f248" href="#f248">[f248]</a><span class="cd"><span class="i">db</span> <span class="o">$58</span></span><span class="ce">; [11]:</span></span>
<span class="l"><a class="anc" name="f249" href="#f249">[f249]</a><span class="cd"><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [12]:</span></span>
<span class="l"><a class="anc" name="f24a" href="#f24a">[f24a]</a><span class="cd"><span class="i">db</span> <span class="o">$68</span></span><span class="ce">; [13]:</span></span>
<span class="l"><a class="anc" name="f24b" href="#f24b">[f24b]</a><span class="cd"><span class="i">db</span> <span class="o">$70</span></span><span class="ce">; [14]:</span></span>
<span class="l"><a class="anc" name="f24c" href="#f24c">[f24c]</a><span class="cd"><span class="i">db</span> <span class="o">$78</span></span><span class="ce">; [15]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_LoadPortraitTiles"></a><div class="cp">;============================================================================
; Draw the portrait to the PPU.
;
; This will load the portrait tiles and palette and
; draw them to the PPU.
;
; INPUTS:
;     A:
;         The portrait ID to draw.
;
; OUTPUTS:
;     <a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a>:
;         The new portrait ID.
;
;     <a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a>:
;         A saved copy of the current palette ID.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a>
;     <a href="#IScripts_LoadPortraitTilesAddress">IScripts_LoadPortraitTilesAddress</a>
;     <a href="#IScripts_DrawPortraitTileToPPU">IScripts_DrawPortraitTileToPPU</a>
;     <a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a>
;     <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_Begin">IScripts_Begin</a>
;============================================================================
</div><span class="l"><a class="anc" name="f24d" href="#f24d">[f24d]</a><a href="#IScripts_LoadPortraitTiles" class="la">IScripts_LoadPortraitTiles:</a><span class="ce">; [$f24d]</span></span>
<div class="c">;
; Check if a portrait ID is set.
;
</div><span class="l"><a class="anc" name="f24d" href="#f24d">[f24d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; Set the current portrait ID.</span></span>
<span class="l"><a class="anc" name="f250" href="#f250">[f250]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = result.</span></span>
<span class="l"><a class="anc" name="f251" href="#f251">[f251]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If unset, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The portrait ID is set. Load the address and wait for an
; OAM reset.
;
</div><span class="l"><a class="anc" name="f253" href="#f253">[f253]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#IScripts_LoadPortraitTilesAddress">IScripts_LoadPortraitTilesAddress</a></span></span><span class="ce">; Load the tiles address for this portrait ID.</span></span>
<span class="l"><a class="anc" name="f256" href="#f256">[f256]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a></span></span><span class="ce">; Wait for OAM reset.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the sprite palette and switch to palette 2 for the
; portrait.
;
</div><span class="l"><a class="anc" name="f259" href="#f259">[f259]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Palette_SpritePaletteIndex">Palette_SpritePaletteIndex</a></span></span><span class="ce">; Load the current sprite palette index</span></span>
<span class="l"><a class="anc" name="f25c" href="#f25c">[f25c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a></span></span><span class="ce">; And save it for later.</span></span>
<span class="l"><a class="anc" name="f25f" href="#f25f">[f25f]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="f261" href="#f261">[f261]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span><span class="ce">; Load palette 2.</span></span>
<span class="l"><a class="anc" name="f264" href="#f264">[f264]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span><span class="ce">; Write the palette to the PPU.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the target PPU address to draw the portrait to.
; This will be $0900.
;
</div><span class="l"><a class="anc" name="f267" href="#f267">[f267]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$09</span></span><span class="ce">; Upper byte = 0x09.</span></span>
<span class="l"><a class="anc" name="f269" href="#f269">[f269]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"><a class="anc" name="f26b" href="#f26b">[f26b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Lower byte = 0x00.</span></span>
<span class="l"><a class="anc" name="f26d" href="#f26d">[f26d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin drawing the portrait. This will loop up to
; 256 times, drawing 16 tiles each.
;
</div><span class="l"><a class="anc" name="f26f" href="#f26f">[f26f]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (loop counter).</span></span>
<span class="l"></span>
<a name=":f271:@_drawLoop"></a><span class="l"><a class="anc" name="f271" href="#f271">[f271]</a><a href="#:f271:@_drawLoop" class="lla">@_drawLoop:</a><span class="ce">; [$f271]</span></span>
<span class="l"><a class="anc" name="f271" href="#f271">[f271]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (loop counter).</span></span>
<span class="l"><a class="anc" name="f272" href="#f272">[f272]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f273" href="#f273">[f273]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#IScripts_DrawPortraitTileToPPU">IScripts_DrawPortraitTileToPPU</a></span></span><span class="ce">; Draw a 16-byte tile to the PPU.</span></span>
<span class="l"><a class="anc" name="f276" href="#f276">[f276]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_finishDrawing">@_finishDrawing</a></span></span></span>
<span class="l"><a class="anc" name="f278" href="#f278">[f278]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the loop counter from the stack.</span></span>
<span class="l"><a class="anc" name="f279" href="#f279">[f279]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Set back in Y.</span></span>
<span class="l"><a class="anc" name="f27a" href="#f27a">[f27a]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="f27b" href="#f27b">[f27b]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_drawLoop">@_drawLoop</a></span></span><span class="ce">; If not wrapped to 0, loop.</span></span>
<span class="l"></span>
<a name=":f27d:@_return"></a><span class="l"><a class="anc" name="f27d" href="#f27d">[f27d]</a><a href="#:f27d:@_return" class="lla">@_return:</a><span class="ce">; [$f27d]</span></span>
<span class="l"><a class="anc" name="f27d" href="#f27d">[f27d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f27e:@_finishDrawing"></a><div class="c">;
; The portrait is finished.
;
</div><span class="l"><a class="anc" name="f27e" href="#f27e">[f27e]</a><a href="#:f27e:@_finishDrawing" class="lla">@_finishDrawing:</a><span class="ce">; [$f27e]</span></span>
<span class="l"><a class="anc" name="f27e" href="#f27e">[f27e]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the loop counter from the stack.</span></span>
<span class="l"><a class="anc" name="f27f" href="#f27f">[f27f]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Set back in Y.</span></span>
<span class="l"><a class="anc" name="f280" href="#f280">[f280]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_ClearPortraitImage"></a><div class="cp">;============================================================================
; Clear the portrait from the textbox.
;
; INPUTS:
;     <a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a>:
;         The palette index to restore.
;
; OUTPUTS:
;     <a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a>:
;         Set to 0xFF.
;
; CALLS:
;     <a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a>
;     <a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a>
;     <a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_EndScript">IScriptAction_EndScript</a>
;============================================================================
</div><span class="l"><a class="anc" name="f281" href="#f281">[f281]</a><a href="#IScripts_ClearPortraitImage" class="la">IScripts_ClearPortraitImage:</a><span class="ce">; [$f281]</span></span>
<span class="l"><a class="anc" name="f281" href="#f281">[f281]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f283" href="#f283">[f283]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; Clear the portrait ID.</span></span>
<span class="l"><a class="anc" name="f286" href="#f286">[f286]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Game_WaitForOAMReset">Game_WaitForOAMReset</a></span></span><span class="ce">; Wait for OAM reset.</span></span>
<span class="l"><a class="anc" name="f289" href="#f289">[f289]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Palette_SavedIndex">Palette_SavedIndex</a></span></span><span class="ce">; Load the saved sprite palette ID.</span></span>
<span class="l"><a class="anc" name="f28c" href="#f28c">[f28c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_LoadSpritePalette">Screen_LoadSpritePalette</a></span></span><span class="ce">; Load that palette's data.</span></span>
<span class="l"><a class="anc" name="f28f" href="#f28f">[f28f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WritePalette">PPUBuffer_WritePalette</a></span></span><span class="ce">; Write to the PPU buffer.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 14 and run
; <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>
; (from bank 15).
;
</div><span class="l"><a class="anc" name="f292" href="#f292">[f292]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Load sprite imagesin bank 14.</span></span>
<span class="l"><a class="anc" name="f295" href="#f295">[f295]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_14_LOGIC</span></span><span class="ce">; Bank = 14
Address = <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a></span></span>
<span class="l"><a class="anc" name="f296" href="#f296">[f296]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a>-1</span></span><span class="ce">; <a href="#GameLoop_LoadSpriteImages">GameLoop_LoadSpriteImages</a> [$PRG15_MIRROR::f296]</span></span>
<span class="l"></span>
<a name=":f298:@_afterFarJump"></a><span class="l"><a class="anc" name="f298" href="#f298">[f298]</a><a href="#:f298:@_afterFarJump" class="lla">@_afterFarJump:</a><span class="ce">; [$f298]</span></span>
<span class="l"><a class="anc" name="f298" href="#f298">[f298]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="IScripts_DrawPortraitAnimationFrame_Unset"></a><div class="c">;
; The portrait ID is unset. There's nothing to do.
;
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;
</div><span class="l"><a class="anc" name="f299" href="#f299">[f299]</a><a href="#IScripts_DrawPortraitAnimationFrame_Unset" class="la">IScripts_DrawPortraitAnimationFrame_Unset:</a><span class="ce">; [$f299]</span></span>
<span class="l"><a class="anc" name="f299" href="#f299">[f299]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Clean up the stack, popping the pushed frame.</span></span>
<span class="l"><a class="anc" name="f29a" href="#f29a">[f29a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_DrawPortraitAnimationFrame"></a><div class="cp">;============================================================================
; Draw a frame of portrait animation.
;
; This will draw the general portrait image and then
; layer on the eyes and mouth, animating them.
;
; Eyes will blink every other frame. Mouths will move
; every other frame.
;
; INPUTS:
;     <a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a>:
;         The current portrait ID.
;
; OUTPUTS:
;     <a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#IScripts_GetPortraitOffset">IScripts_GetPortraitOffset</a>
;     <a href="#Sprite_DrawPortraitPartAppearance">Sprite_DrawPortraitPartAppearance</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_UpdatePortraitAnimation">IScripts_UpdatePortraitAnimation</a>
;============================================================================
</div><span class="l"><a class="anc" name="f29b" href="#f29b">[f29b]</a><a href="#IScripts_DrawPortraitAnimationFrame" class="la">IScripts_DrawPortraitAnimationFrame:</a><span class="ce">; [$f29b]</span></span>
<span class="l"><a class="anc" name="f29b" href="#f29b">[f29b]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push the frame to the stack.</span></span>
<span class="l"><a class="anc" name="f29c" href="#f29c">[f29c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; Load the current portrait ID.</span></span>
<span class="l"><a class="anc" name="f29f" href="#f29f">[f29f]</a><span class="cd"><span class="i">BMI</span> <span class="o"><a href="#IScripts_DrawPortraitAnimationFrame_Unset">IScripts_DrawPortraitAnimationFrame_Unset</a></span></span><span class="ce">; If 0xFF, jump to finish.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; There's an active portrait. Begin preparing by clearing
; the flip mask state.
;
</div><span class="l"><a class="anc" name="f2a1" href="#f2a1">[f2a1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f2a3" href="#f2a3">[f2a3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Set the flip mask to 0 (not flipped).</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the general portrait image.
;
</div><span class="l"><a class="anc" name="f2a5" href="#f2a5">[f2a5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$90</span></span></span>
<span class="l"><a class="anc" name="f2a7" href="#f2a7">[f2a7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span><span class="ce">; Set the PPU offset to $0090.</span></span>
<span class="l"><a class="anc" name="f2a9" href="#f2a9">[f2a9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#IScripts_GetPortraitOffset">IScripts_GetPortraitOffset</a></span></span><span class="ce">; Get the portrait offset into the tileinfo for the ID.</span></span>
<span class="l"><a class="anc" name="f2ac" href="#f2ac">[f2ac]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprite_DrawPortraitPartAppearance">Sprite_DrawPortraitPartAppearance</a></span></span><span class="ce">; Draw as the portrait.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the eye animation.
;
; This will switch to new tiles every frame.
;
</div><span class="l"><a class="anc" name="f2af" href="#f2af">[f2af]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$90</span></span></span>
<span class="l"><a class="anc" name="f2b1" href="#f2b1">[f2b1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span><span class="ce">; Set the PPU offset to $0090.</span></span>
<span class="l"><a class="anc" name="f2b3" href="#f2b3">[f2b3]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the frame from the stack.</span></span>
<span class="l"><a class="anc" name="f2b4" href="#f2b4">[f2b4]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it again. We still have it in A.</span></span>
<span class="l"><a class="anc" name="f2b5" href="#f2b5">[f2b5]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Generate an even/odd index from it.</span></span>
<span class="l"><a class="anc" name="f2b7" href="#f2b7">[f2b7]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = result.</span></span>
<span class="l"><a class="anc" name="f2b8" href="#f2b8">[f2b8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#IScripts_GetPortraitOffset">IScripts_GetPortraitOffset</a></span></span><span class="ce">; Get the offset into the table for the portrait ID.</span></span>
<span class="l"><a class="anc" name="f2bb" href="#f2bb">[f2bb]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f2bc" href="#f2bc">[f2bc]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#PORTRAIT_EYE_APPEARANCE_OFFSETS">PORTRAIT_EYE_APPEARANCE_OFFSETS</a>,X</span></span><span class="ce">; Add the eyes animation offset for this even/odd frame.</span></span>
<span class="l"><a class="anc" name="f2bf" href="#f2bf">[f2bf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sprite_DrawPortraitPartAppearance">Sprite_DrawPortraitPartAppearance</a></span></span><span class="ce">; Draw as the eyes.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the mouth animation.
;
; This will switch to new tiles every other frame.
;
</div><span class="l"><a class="anc" name="f2c2" href="#f2c2">[f2c2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$90</span></span></span>
<span class="l"><a class="anc" name="f2c4" href="#f2c4">[f2c4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Sprites_PPUOffset">Sprites_PPUOffset</a></span></span><span class="ce">; Set the PPU offset to $0090.</span></span>
<span class="l"><a class="anc" name="f2c6" href="#f2c6">[f2c6]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the frame from the stack.</span></span>
<span class="l"><a class="anc" name="f2c7" href="#f2c7">[f2c7]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Divide the frame by 2 (reducing the animation rate to switch every other frame).</span></span>
<span class="l"><a class="anc" name="f2c8" href="#f2c8">[f2c8]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Convert that to an even/odd value.</span></span>
<span class="l"><a class="anc" name="f2ca" href="#f2ca">[f2ca]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = result.</span></span>
<span class="l"><a class="anc" name="f2cb" href="#f2cb">[f2cb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#IScripts_GetPortraitOffset">IScripts_GetPortraitOffset</a></span></span><span class="ce">; Get the offset into the table for the portrait ID.</span></span>
<span class="l"><a class="anc" name="f2ce" href="#f2ce">[f2ce]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f2cf" href="#f2cf">[f2cf]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="#PORTRAIT_MOUTH_APPEARANCE_OFFSETS">PORTRAIT_MOUTH_APPEARANCE_OFFSETS</a>,X</span></span><span class="ce">; Add the mouth animation offset for this even/odd frame.</span></span>
<span class="l"><a class="anc" name="f2d2" href="#f2d2">[f2d2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_DrawPortraitPartAppearance">Sprite_DrawPortraitPartAppearance</a></span></span><span class="ce">; Draw as the mouth.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_GetPortraitOffset"></a><div class="cp">;============================================================================
; Return the offset into the portraits table for the ID.
;
; This takes a portrait ID and returns an offset into
; <a href="PRG7.html#TILEINFO_PORTRAITS_ADDRS">TILEINFO_PORTRAITS_ADDRS</a>.
;
; INPUTS:
;     <a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a>:
;         The current portrait ID.
;
; OUTPUTS:
;     A:
;         The offset into the table.
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;============================================================================
</div><span class="l"><a class="anc" name="f2d5" href="#f2d5">[f2d5]</a><a href="#IScripts_GetPortraitOffset" class="la">IScripts_GetPortraitOffset:</a><span class="ce">; [$f2d5]</span></span>
<span class="l"><a class="anc" name="f2d5" href="#f2d5">[f2d5]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; Load the current portrait ID.</span></span>
<span class="l"><a class="anc" name="f2d8" href="#f2d8">[f2d8]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 4.</span></span>
<span class="l"><a class="anc" name="f2d9" href="#f2d9">[f2d9]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f2da" href="#f2da">[f2da]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f2db" href="#f2db">[f2db]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; And add the ID again (effectively multiplying by a total of 5).</span></span>
<span class="l"><a class="anc" name="f2de" href="#f2de">[f2de]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Return it as A.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PORTRAIT_EYE_APPEARANCE_OFFSETS"></a><div class="cp">;============================================================================
; Offsets for the portrait eye blinking animation frames.
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;
</div><span class="l"><a class="anc" name="f2df" href="#f2df">[f2df]</a><a href="#PORTRAIT_EYE_APPEARANCE_OFFSETS" class="la">PORTRAIT_EYE_APPEARANCE_OFFSETS:</a><span class="ce">; [$f2df]</span></span>
<span class="l"><a class="anc" name="f2df" href="#f2df">[f2df]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="f2e0" href="#f2e0">[f2e0]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PORTRAIT_MOUTH_APPEARANCE_OFFSETS"></a><div class="cp">;============================================================================
; Offsets for the portrait mouth movement animation frames.
;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#IScripts_DrawPortraitAnimationFrame">IScripts_DrawPortraitAnimationFrame</a>
;
</div><span class="l"><a class="anc" name="f2e1" href="#f2e1">[f2e1]</a><a href="#PORTRAIT_MOUTH_APPEARANCE_OFFSETS" class="la">PORTRAIT_MOUTH_APPEARANCE_OFFSETS:</a><span class="ce">; [$f2e1]</span></span>
<span class="l"><a class="anc" name="f2e1" href="#f2e1">[f2e1]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="f2e2" href="#f2e2">[f2e2]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [1]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_LoadPortraitTilesAddress"></a><div class="cp">;============================================================================
; Load the address for portrait tiles.
;
; This will switch to bank 8 and load the address used for
; the portrait tiles for the current portrait ID.
;
; Tiles are loaded from offsets into
; <a href="PRG8.html#SPRITE_TILES_PORTRAITS_ADDRS_INDEX">SPRITE_TILES_PORTRAITS_ADDRS_INDEX</a>.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank to switch back to after load.
;
;     <a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a>:
;         The current portrait ID.
;
;     <a href="PRG8.html#SPRITE_TILES_PORTRAITS_ADDRS_INDEX">SPRITE_TILES_PORTRAITS_ADDRS_INDEX</a>:
;         The pointer to the start of the portrait tiles
;         list.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;         The address for the portrait tiles.
;
; CALLS:
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#IScripts_LoadPortraitTiles">IScripts_LoadPortraitTiles</a>
;============================================================================
</div><span class="l"><a class="anc" name="f2e3" href="#f2e3">[f2e3]</a><a href="#IScripts_LoadPortraitTilesAddress" class="la">IScripts_LoadPortraitTilesAddress:</a><span class="ce">; [$f2e3]</span></span>
<div class="c">;
; Switch to bank 8 for the portrait sprites.
;
</div><span class="l"><a class="anc" name="f2e3" href="#f2e3">[f2e3]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="f2e6" href="#f2e6">[f2e6]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f2e7" href="#f2e7">[f2e7]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; Bank 8 = Sprites</span></span>
<span class="l"><a class="anc" name="f2e9" href="#f2e9">[f2e9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Convert a portrait ID to a word boundary for later lookup.
;
</div><span class="l"><a class="anc" name="f2ec" href="#f2ec">[f2ec]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#IScript_PortraitID">IScript_PortraitID</a></span></span><span class="ce">; Load the portrait ID.</span></span>
<span class="l"><a class="anc" name="f2ef" href="#f2ef">[f2ef]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a word boundary.</span></span>
<span class="l"><a class="anc" name="f2f0" href="#f2f0">[f2f0]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = result</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the address for the portrait tiles table.
;
</div><span class="l"><a class="anc" name="f2f1" href="#f2f1">[f2f1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$800e</span></span><span class="ce">; Load the lower byte of the start address for the portrait tiles.</span></span>
<span class="l"><a class="anc" name="f2f4" href="#f2f4">[f2f4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte.</span></span>
<span class="l"><a class="anc" name="f2f6" href="#f2f6">[f2f6]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:$800f</span></span><span class="ce">; Load the upper byte of the portrait address.</span></span>
<span class="l"><a class="anc" name="f2f9" href="#f2f9">[f2f9]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f2fa" href="#f2fa">[f2fa]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><a class="anc" name="f2fc" href="#f2fc">[f2fc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; And store as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the portrait from the sprite tiles list, using the
; portrait ID as the index.
;
</div><span class="l"><a class="anc" name="f2fe" href="#f2fe">[f2fe]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the lower byte of the address based on the potrait ID.</span></span>
<span class="l"><a class="anc" name="f300" href="#f300">[f300]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f301" href="#f301">[f301]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (next offset)</span></span>
<span class="l"><a class="anc" name="f302" href="#f302">[f302]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the upper byte of the tile.</span></span>
<span class="l"><a class="anc" name="f304" href="#f304">[f304]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f305" href="#f305">[f305]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><a class="anc" name="f307" href="#f307">[f307]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"><a class="anc" name="f309" href="#f309">[f309]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the lower byte.</span></span>
<span class="l"><a class="anc" name="f30a" href="#f30a">[f30a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a></span></span><span class="ce">; Store as the lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch back to the stored bank.
;
</div><span class="l"><a class="anc" name="f30c" href="#f30c">[f30c]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Switch to the previous bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="IScripts_DrawPortraitTileToPPU_IsDone"></a><div class="c">;
; The byte for the tile was 0xFF. Restore the bank
; and set a result of C=1, causing drawing to finish.
;
;
; XREFS:
;     <a href="#IScripts_DrawPortraitTileToPPU">IScripts_DrawPortraitTileToPPU</a>
;
</div><span class="l"><a class="anc" name="f30f" href="#f30f">[f30f]</a><a href="#IScripts_DrawPortraitTileToPPU_IsDone" class="la">IScripts_DrawPortraitTileToPPU_IsDone:</a><span class="ce">; [$f30f]</span></span>
<span class="l"><a class="anc" name="f30f" href="#f30f">[f30f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the saved bank from the stack.</span></span>
<span class="l"><a class="anc" name="f310" href="#f310">[f310]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (bank)</span></span>
<span class="l"><a class="anc" name="f311" href="#f311">[f311]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to it.</span></span>
<span class="l"><a class="anc" name="f314" href="#f314">[f314]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; Set C=1 for the result.</span></span>
<span class="l"><a class="anc" name="f315" href="#f315">[f315]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Return it.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_DrawPortraitTileToPPU"></a><div class="cp">;============================================================================
; Draw a portrait tile to the PPU.
;
; This will load the next byte for the portrait, which
; represents an offset into the portrait tile list.
;
; If this is 0xFF, then drawing is complete, and this will
; return with C=1.
;
; Otherwise, the tile will be drawn to the PPU and state
; will be prepared for the next tile.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank to return to.
;
;     <a href="RAM.html#Temp_Addr_U">Temp_Addr_U</a>:
;     <a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>:
;         The tile information address to read from.
;
; OUTPUTS:
;     C:
;         1 = Drawing is finished (byte was 0xFF).
;         0 = There are more tiles to draw.
;
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The updated PPU buffer state.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         The updated PPU target address (incremented
;         by 16).
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="#IScripts_LoadPortraitTiles">IScripts_LoadPortraitTiles</a>
;============================================================================
</div><span class="l"><a class="anc" name="f316" href="#f316">[f316]</a><a href="#IScripts_DrawPortraitTileToPPU" class="la">IScripts_DrawPortraitTileToPPU:</a><span class="ce">; [$f316]</span></span>
<div class="c">;
; Save the current bank and switch to bank 8.
;
</div><span class="l"><a class="anc" name="f316" href="#f316">[f316]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; Load the current ROM bank.</span></span>
<span class="l"><a class="anc" name="f319" href="#f319">[f319]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f31a" href="#f31a">[f31a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$08</span></span><span class="ce">; Bank 8 = Portrait sprites</span></span>
<span class="l"><a class="anc" name="f31c" href="#f31c">[f31c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the tile and see if it's set or if it's 0xFF.
;
</div><span class="l"><a class="anc" name="f31f" href="#f31f">[f31f]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span><span class="ce">; Load the tile index from the tiles address.</span></span>
<span class="l"><a class="anc" name="f321" href="#f321">[f321]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF?</span></span>
<span class="l"><a class="anc" name="f323" href="#f323">[f323]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#IScripts_DrawPortraitTileToPPU_IsDone">IScripts_DrawPortraitTileToPPU_IsDone</a></span></span><span class="ce">; If so, jump to finish.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Generate an offset into the tiles list, turning each nibble
; of the loaded byte into a 16-bit value.
;
; This is equivalent to:
;
;           A (lower) = (byte &lt;&lt; 4) &amp; 0xFF
;     <a href="RAM.html#Temp_05">Temp_05</a> (upper) = (byte &gt;&gt; 4) &amp; 0xFF
;
</div><span class="l"><a class="anc" name="f325" href="#f325">[f325]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (offset).</span></span>
<span class="l"><a class="anc" name="f327" href="#f327">[f327]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="f329" href="#f329">[f329]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Addr_L">Temp_Addr_L</a>),Y</span></span></span>
<span class="l"><a class="anc" name="f32b" href="#f32b">[f32b]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f32c" href="#f32c">[f32c]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="f32e" href="#f32e">[f32e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f32f" href="#f32f">[f32f]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="f331" href="#f331">[f331]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f332" href="#f332">[f332]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="f334" href="#f334">[f334]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f335" href="#f335">[f335]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span></span>
<span class="l"><a class="anc" name="f337" href="#f337">[f337]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Make the above relative to the address stored in
; <a href="PRG8.html#TILES_PORTRAITS_START_REF">TILES_PORTRAITS_START_REF</a> (+ $8000).
;
</div><span class="l"><a class="anc" name="f338" href="#f338">[f338]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:$8010</span></span><span class="ce">; Add the tile ID to the lower byte.</span></span>
<span class="l"><a class="anc" name="f33b" href="#f33b">[f33b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_04">Temp_04</a></span></span><span class="ce">; Store in <a href="RAM.html#Temp_04">Temp_04</a>.</span></span>
<span class="l"><a class="anc" name="f33d" href="#f33d">[f33d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; Load the calculated upper byte.</span></span>
<span class="l"><a class="anc" name="f33f" href="#f33f">[f33f]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:$8011</span></span><span class="ce">; Add the upper byte for the relative start address.</span></span>
<span class="l"><a class="anc" name="f342" href="#f342">[f342]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f343" href="#f343">[f343]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80.</span></span>
<span class="l"><a class="anc" name="f345" href="#f345">[f345]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_05">Temp_05</a></span></span><span class="ce">; And store as a new upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin writing to the PPU buffer.
;
</div><span class="l"><a class="anc" name="f347" href="#f347">[f347]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; Length = 16 (tile bytes).</span></span>
<span class="l"><a class="anc" name="f349" href="#f349">[f349]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue that as the PPU buffer length.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin populating the buffer with the tile's bytes.
;
</div><span class="l"><a class="anc" name="f34c" href="#f34c">[f34c]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (loop counter).</span></span>
<span class="l"></span>
<a name=":f34e:@_drawLoop"></a><span class="l"><a class="anc" name="f34e" href="#f34e">[f34e]</a><a href="#:f34e:@_drawLoop" class="lla">@_drawLoop:</a><span class="ce">; [$f34e]</span></span>
<span class="l"><a class="anc" name="f34e" href="#f34e">[f34e]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_04">Temp_04</a>),Y</span></span><span class="ce">; Load the next byte for the tile.</span></span>
<span class="l"><a class="anc" name="f350" href="#f350">[f350]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store it in the PPU buffer.</span></span>
<span class="l"><a class="anc" name="f353" href="#f353">[f353]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++ (destination).</span></span>
<span class="l"><a class="anc" name="f354" href="#f354">[f354]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++ (loop counter).</span></span>
<span class="l"><a class="anc" name="f355" href="#f355">[f355]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span><span class="ce">; Have we hit 16 bytes?</span></span>
<span class="l"><a class="anc" name="f357" href="#f357">[f357]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_drawLoop">@_drawLoop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; All tiles have been drawn. Update the write offset and
; advance the PPU address.
;
</div><span class="l"><a class="anc" name="f359" href="#f359">[f359]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store the new PPU buffer write offset.</span></span>
<span class="l"><a class="anc" name="f35b" href="#f35b">[f35b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Load the lower byte of the target address.</span></span>
<span class="l"><a class="anc" name="f35d" href="#f35d">[f35d]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f35e" href="#f35e">[f35e]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$10</span></span><span class="ce">; Advance by 16 bytes.</span></span>
<span class="l"><a class="anc" name="f360" href="#f360">[f360]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f362" href="#f362">[f362]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Load the upper byte of the target address.</span></span>
<span class="l"><a class="anc" name="f364" href="#f364">[f364]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add carry, if lower wrapped.</span></span>
<span class="l"><a class="anc" name="f366" href="#f366">[f366]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><a class="anc" name="f368" href="#f368">[f368]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the bank from the stack.</span></span>
<span class="l"><a class="anc" name="f369" href="#f369">[f369]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (bank).</span></span>
<span class="l"><a class="anc" name="f36a" href="#f36a">[f36a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to it.</span></span>
<span class="l"><a class="anc" name="f36d" href="#f36d">[f36d]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; Set C=0 for the result.</span></span>
<span class="l"><a class="anc" name="f36e" href="#f36e">[f36e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="SoundEffect_SetCurrent"></a><div class="cp">;============================================================================
; Set the ID of the sound effect to play.
;
; This assigns the sound effect to play during the next
; hardware interrupt.
;
; In theory, it also works off of a priority table to
; determine which sound effect should be playing, but
; in practice this was either disabled or never fully
; implemented. See the notes in the code.
;
; INPUTS:
;     A:
;         The ID of the sound effect to set.
;
;     <a href="RAM.html#SoundEffect_Unused_PriorityID">SoundEffect_Unused_PriorityID</a>:
;         The currently-played sound effect.
;
;     <a href="#SOUND_PRIORITIES">SOUND_PRIORITIES</a>:
;         The table of sound effect priorities.
;
; OUTPUTS:
;     <a href="RAM.html#SoundEffect_Unused_PriorityID">SoundEffect_Unused_PriorityID</a>:
;         The new value for the current sound ID, if set.
;
;     <a href="RAM.html#SoundEffect_Current">SoundEffect_Current</a>:
;         The new value for the next sound effect, if set.
;
; XREFS:
;     <a href="#Sound_PlayEffect">Sound_PlayEffect</a>
;============================================================================
</div><span class="l"><a class="anc" name="f36f" href="#f36f">[f36f]</a><a href="#SoundEffect_SetCurrent" class="la">SoundEffect_SetCurrent:</a><span class="ce">; [$f36f]</span></span>
<span class="l"><a class="anc" name="f36f" href="#f36f">[f36f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$1d</span></span><span class="ce">; Length of sound IDs array</span></span>
<span class="l"><a class="anc" name="f371" href="#f371">[f371]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If out of bounds, return.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; DEADCODE: Check the priority level of this sound effect.
;
; This code is run, but nothing really happens. Let's explore
; what it's doing:
;
; 1. It's taking <a href="RAM.html#SoundEffect_Unused_PriorityID">SoundEffect_Unused_PriorityID</a> and
;    comparing it to the ID of the sound effect to play.
;
; 2. If the new sound effect has a lower value, the variable
;    will be set to the new sound effect ID.
;
; 3. It then returns.
;
; This seems to work like a priority level. I'm guessing it's
; to choose a higher-priority ID.
;
; HOWEVER, this ID never gets used anywhere else, and it's only
; ever set to 0. That means any time this is called, the current
; sound effect ID's value in the table is compared against the
; first (ID=0) entry, which is 0, and therefore the sound effect's
; value will never be less (nothing in there has bit 7 set).
;
; This makes all this code a bit worthless, and a candidate for
; removal.
;
</div><span class="l"><a class="anc" name="f373" href="#f373">[f373]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = new sound ID</span></span>
<span class="l"><a class="anc" name="f374" href="#f374">[f374]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#SoundEffect_Unused_PriorityID">SoundEffect_Unused_PriorityID</a></span></span><span class="ce">; Y = current sound ID</span></span>
<span class="l"><a class="anc" name="f377" href="#f377">[f377]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#SOUND_PRIORITIES">SOUND_PRIORITIES</a>,Y</span></span><span class="ce">; A = Sound type for current sound from map</span></span>
<span class="l"><a class="anc" name="f37a" href="#f37a">[f37a]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="#SOUND_PRIORITIES">SOUND_PRIORITIES</a>,X</span></span><span class="ce">; Is this already the current sound?</span></span>
<span class="l"><a class="anc" name="f37d" href="#f37d">[f37d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_queueNext">@_queueNext</a></span></span><span class="ce">; If yes, then jump</span></span>
<span class="l"><a class="anc" name="f37f" href="#f37f">[f37f]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_queueNext">@_queueNext</a></span></span><span class="ce">; If it's a lower priority (larger number), then jump.</span></span>
<span class="l"><a class="anc" name="f381" href="#f381">[f381]</a><span class="cd"><span class="i">STX</span> <span class="o">a:<a href="RAM.html#SoundEffect_Unused_PriorityID">SoundEffect_Unused_PriorityID</a></span></span><span class="ce">; Set as the current sound.</span></span>
<span class="l"><a class="anc" name="f384" href="#f384">[f384]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f385:@_queueNext"></a><div class="c">;
; Set the sound effect to play at the next hardware interrupt.
;
</div><span class="l"><a class="anc" name="f385" href="#f385">[f385]</a><a href="#:f385:@_queueNext" class="lla">@_queueNext:</a><span class="ce">; [$f385]</span></span>
<span class="l"><a class="anc" name="f385" href="#f385">[f385]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#SoundEffect_Current">SoundEffect_Current</a></span></span><span class="ce">; Queue this up as the next effect.</span></span>
<span class="l"></span>
<a name=":f387:@_return"></a><span class="l"><a class="anc" name="f387" href="#f387">[f387]</a><a href="#:f387:@_return" class="lla">@_return:</a><span class="ce">; [$f387]</span></span>
<span class="l"><a class="anc" name="f387" href="#f387">[f387]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="SOUND_PRIORITIES"></a><div class="cp">;============================================================================
; DEADCODE: Table of sound effect priorities, indexed by sound ID.
;
; While code does reference this, no ID but 0 will ever be
; used. See the note in <a href="#SoundEffect_SetCurrent">SoundEffect_SetCurrent</a>.
;
; XREFS:
;     <a href="#SoundEffect_SetCurrent">SoundEffect_SetCurrent</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#SoundEffect_SetCurrent">SoundEffect_SetCurrent</a>
;
</div><span class="l"><a class="anc" name="f388" href="#f388">[f388]</a><a href="#SOUND_PRIORITIES" class="la">SOUND_PRIORITIES:</a><span class="ce">; [$f388]</span></span>
<span class="l"><a class="anc" name="f388" href="#f388">[f388]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="f389" href="#f389">[f389]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="f38a" href="#f38a">[f38a]</a><span class="cd"><span class="i">db</span> <span class="o">$15</span></span><span class="ce">; [2]: Hit enemy with weapon</span></span>
<span class="l"><a class="anc" name="f38b" href="#f38b">[f38b]</a><span class="cd"><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [3]: Enemy is dead</span></span>
<span class="l"><a class="anc" name="f38c" href="#f38c">[f38c]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [4]: Player hit</span></span>
<span class="l"><a class="anc" name="f38d" href="#f38d">[f38d]</a><span class="cd"><span class="i">db</span> <span class="o">$19</span></span><span class="ce">; [5]: Magic</span></span>
<span class="l"><a class="anc" name="f38e" href="#f38e">[f38e]</a><span class="cd"><span class="i">db</span> <span class="o">$0b</span></span><span class="ce">; [6]: Open door</span></span>
<span class="l"><a class="anc" name="f38f" href="#f38f">[f38f]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="f390" href="#f390">[f390]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [8]: Item picked up</span></span>
<span class="l"><a class="anc" name="f391" href="#f391">[f391]</a><span class="cd"><span class="i">db</span> <span class="o">$11</span></span><span class="ce">; [9]: Touched coin</span></span>
<span class="l"><a class="anc" name="f392" href="#f392">[f392]</a><span class="cd"><span class="i">db</span> <span class="o">$17</span></span><span class="ce">; [10]: Cast magic hit an obstacle</span></span>
<span class="l"><a class="anc" name="f393" href="#f393">[f393]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [11]: Cursor moved</span></span>
<span class="l"><a class="anc" name="f394" href="#f394">[f394]</a><span class="cd"><span class="i">db</span> <span class="o">$13</span></span><span class="ce">; [12]: Text input</span></span>
<span class="l"><a class="anc" name="f395" href="#f395">[f395]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [13]:</span></span>
<span class="l"><a class="anc" name="f396" href="#f396">[f396]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; [14]: Password character entered</span></span>
<span class="l"><a class="anc" name="f397" href="#f397">[f397]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [15]: Block pushed</span></span>
<span class="l"><a class="anc" name="f398" href="#f398">[f398]</a><span class="cd"><span class="i">db</span> <span class="o">$12</span></span><span class="ce">; [16]: Coin dropped</span></span>
<span class="l"><a class="anc" name="f399" href="#f399">[f399]</a><span class="cd"><span class="i">db</span> <span class="o">$0f</span></span><span class="ce">; [17]:</span></span>
<span class="l"><a class="anc" name="f39a" href="#f39a">[f39a]</a><span class="cd"><span class="i">db</span> <span class="o">$0e</span></span><span class="ce">; [18]:</span></span>
<span class="l"><a class="anc" name="f39b" href="#f39b">[f39b]</a><span class="cd"><span class="i">db</span> <span class="o">$06</span></span><span class="ce">; [19]: Filling HP or MP</span></span>
<span class="l"><a class="anc" name="f39c" href="#f39c">[f39c]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; [20]: Tilte magic cast</span></span>
<span class="l"><a class="anc" name="f39d" href="#f39d">[f39d]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; [21]: Player taking step</span></span>
<span class="l"><a class="anc" name="f39e" href="#f39e">[f39e]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; [22]:</span></span>
<span class="l"><a class="anc" name="f39f" href="#f39f">[f39f]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [23]:</span></span>
<span class="l"><a class="anc" name="f3a0" href="#f3a0">[f3a0]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [24]:</span></span>
<span class="l"><a class="anc" name="f3a1" href="#f3a1">[f3a1]</a><span class="cd"><span class="i">db</span> <span class="o">$05</span></span><span class="ce">; [25]: Gold changed</span></span>
<span class="l"><a class="anc" name="f3a2" href="#f3a2">[f3a2]</a><span class="cd"><span class="i">db</span> <span class="o">$03</span></span><span class="ce">; [26]: Item used</span></span>
<span class="l"><a class="anc" name="f3a3" href="#f3a3">[f3a3]</a><span class="cd"><span class="i">db</span> <span class="o">$10</span></span><span class="ce">; [27]: Touched meat</span></span>
<span class="l"><a class="anc" name="f3a4" href="#f3a4">[f3a4]</a><span class="cd"><span class="i">db</span> <span class="o">$02</span></span><span class="ce">; [28]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_LoadGlyphsForStrings"></a><div class="cp">;============================================================================
; Load glyph data for all strings into the PPU tile map.
;
; Glyph data is located in Bank 13 at $8000.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         Updated with the write position.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#PPU_WriteGlyphTile">PPU_WriteGlyphTile</a>
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;============================================================================
</div><span class="l"><a class="anc" name="f3a5" href="#f3a5">[f3a5]</a><a href="#PPU_LoadGlyphsForStrings" class="la">PPU_LoadGlyphsForStrings:</a><span class="ce">; [$f3a5]</span></span>
<span class="l"><a class="anc" name="f3a5" href="#f3a5">[f3a5]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f3a8" href="#f3a8">[f3a8]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f3a9" href="#f3a9">[f3a9]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0d</span></span></span>
<span class="l"><a class="anc" name="f3ab" href="#f3ab">[f3ab]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f3ae" href="#f3ae">[f3ae]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f3b0" href="#f3b0">[f3b0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f3b2" href="#f3b2">[f3b2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$80</span></span></span>
<span class="l"><a class="anc" name="f3b4" href="#f3b4">[f3b4]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="f3b6" href="#f3b6">[f3b6]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$12</span></span></span>
<span class="l"><a class="anc" name="f3b8" href="#f3b8">[f3b8]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="f3bb" href="#f3bb">[f3bb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f3bd" href="#f3bd">[f3bd]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="f3c0" href="#f3c0">[f3c0]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$60</span></span></span>
<span class="l"></span>
<a name=":f3c2:@LAB_PRG15_MIRROR__f3c2"></a><span class="l"><a class="anc" name="f3c2" href="#f3c2">[f3c2]</a><a href="#:f3c2:@LAB_PRG15_MIRROR__f3c2" class="lla">@LAB_PRG15_MIRROR__f3c2:</a><span class="ce">; [$f3c2]</span></span>
<span class="l"><a class="anc" name="f3c2" href="#f3c2">[f3c2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WriteGlyphTile">PPU_WriteGlyphTile</a></span></span></span>
<span class="l"><a class="anc" name="f3c5" href="#f3c5">[f3c5]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WriteGlyphTile">PPU_WriteGlyphTile</a></span></span></span>
<span class="l"><a class="anc" name="f3c8" href="#f3c8">[f3c8]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f3ca" href="#f3ca">[f3ca]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f3cb" href="#f3cb">[f3cb]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="f3cd" href="#f3cd">[f3cd]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f3d1">@LAB_PRG15_MIRROR__f3d1</a></span></span></span>
<span class="l"><a class="anc" name="f3cf" href="#f3cf">[f3cf]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"></span>
<a name=":f3d1:@LAB_PRG15_MIRROR__f3d1"></a><span class="l"><a class="anc" name="f3d1" href="#f3d1">[f3d1]</a><a href="#:f3d1:@LAB_PRG15_MIRROR__f3d1" class="lla">@LAB_PRG15_MIRROR__f3d1:</a><span class="ce">; [$f3d1]</span></span>
<span class="l"><a class="anc" name="f3d1" href="#f3d1">[f3d1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f3d3" href="#f3d3">[f3d3]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="f3d4" href="#f3d4">[f3d4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f3c2">@LAB_PRG15_MIRROR__f3c2</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_UpdatePRGBankToStackA"></a><div class="cp">;============================================================================
; Update the ROM bank in register A pushed to the stack.
;
; INPUTS:
;     Stack (A):
;         The stack to pop A from, containing the bank.
;
; OUTPUTS:
;     Stack (A):
;         The stack will be popped.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;
; XREFS:
;     <a href="#Game_DrawScreenInFrozenState">Game_DrawScreenInFrozenState</a>
;     <a href="#IScripts_LoadPortraitTilesAddress">IScripts_LoadPortraitTilesAddress</a>
;     <a href="#Screen_LoadSpriteInfo">Screen_LoadSpriteInfo</a>
;     <a href="#Sprites_LoadSpriteValue">Sprites_LoadSpriteValue</a>
;     <a href="#TextBox_LoadAndShowMessage">TextBox_LoadAndShowMessage</a>
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;     <a href="#TextBox_ShowNextChar">TextBox_ShowNextChar</a>
;     <a href="#UI_DrawSelectedItem">UI_DrawSelectedItem</a>
;============================================================================
</div><span class="l"><a class="anc" name="f3d6" href="#f3d6">[f3d6]</a><a href="#MMC1_UpdatePRGBankToStackA" class="la">MMC1_UpdatePRGBankToStackA:</a><span class="ce">; [$f3d6]</span></span>
<span class="l"><a class="anc" name="f3d6" href="#f3d6">[f3d6]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop the bank from the stack.</span></span>
<span class="l"><a class="anc" name="f3d7" href="#f3d7">[f3d7]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f3d8" href="#f3d8">[f3d8]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"><a class="anc" name="f3db" href="#f3db">[f3db]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_WriteGlyphTile"></a><div class="cp">;============================================================================
; Write a glyph to the list of tiles in the PPU.
;
; This is used by <a href="#PPU_LoadGlyphsForStrings">PPU_LoadGlyphsForStrings</a> to
; write a glyph tile for later use.
;
; INPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The temporary address to read bytes from.
;
; OUTPUTS:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         Data will be written to the PPU.
;
; XREFS:
;     <a href="#PPU_LoadGlyphsForStrings">PPU_LoadGlyphsForStrings</a>
;============================================================================
</div><span class="l"><a class="anc" name="f3dc" href="#f3dc">[f3dc]</a><a href="#PPU_WriteGlyphTile" class="la">PPU_WriteGlyphTile:</a><span class="ce">; [$f3dc]</span></span>
<span class="l"><a class="anc" name="f3dc" href="#f3dc">[f3dc]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<a name=":f3de:@_loop"></a><span class="l"><a class="anc" name="f3de" href="#f3de">[f3de]</a><a href="#:f3de:@_loop" class="lla">@_loop:</a><span class="ce">; [$f3de]</span></span>
<span class="l"><a class="anc" name="f3de" href="#f3de">[f3de]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; Load the byte from the temp string address.</span></span>
<span class="l"><a class="anc" name="f3e0" href="#f3e0">[f3e0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Write to the PPU.</span></span>
<span class="l"><a class="anc" name="f3e3" href="#f3e3">[f3e3]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="f3e4" href="#f3e4">[f3e4]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$08</span></span><span class="ce">; Have we written 8 bytes?</span></span>
<span class="l"><a class="anc" name="f3e6" href="#f3e6">[f3e6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="f3e8" href="#f3e8">[f3e8]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="IScripts_LoadAndShowMessage"></a><div class="cp">;============================================================================
; Load the specified message and progressively show it.
;
; Each character in the message will be shown one-by-one.
;
; INPUTS:
;     A:
;         The message ID to show.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#Messages_Load">Messages_Load</a>
;     <a href="#TextBox_LoadAndShowMessage">TextBox_LoadAndShowMessage</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_ShowBuySellMenu">IScriptAction_ShowBuySellMenu</a>
;============================================================================
</div><span class="l"><a class="anc" name="f3e9" href="#f3e9">[f3e9]</a><a href="#IScripts_LoadAndShowMessage" class="la">IScripts_LoadAndShowMessage:</a><span class="ce">; [$f3e9]</span></span>
<span class="l"><a class="anc" name="f3e9" href="#f3e9">[f3e9]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Messages_Load">Messages_Load</a></span></span><span class="ce">; Load the message.</span></span>
<span class="l"></span>
<a name=":f3ec:@_loop"></a><span class="l"><a class="anc" name="f3ec" href="#f3ec">[f3ec]</a><a href="#:f3ec:@_loop" class="lla">@_loop:</a><span class="ce">; [$f3ec]</span></span>
<span class="l"><a class="anc" name="f3ec" href="#f3ec">[f3ec]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_LoadAndShowMessage">TextBox_LoadAndShowMessage</a></span></span><span class="ce">; Show the next character from the message.</span></span>
<span class="l"><a class="anc" name="f3ef" href="#f3ef">[f3ef]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; Is it 0xFF (end of message)?</span></span>
<span class="l"><a class="anc" name="f3f2" href="#f3f2">[f3f2]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="f3f4" href="#f3f4">[f3f4]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Messages_Load"></a><div class="cp">;============================================================================
; Load a message from the message list.
;
; This will switch to Bank 13 and load a message from
; there at the specified message index.
;
; This works by scanning strings. It starts at the first
; message ($8300) and walks up to the messag index (or,
; technically, down from the message index - 1 to 0),
; scanning every character until the message terminator
; (0xFF) is hit.
;
; When we both hit the last message and hit the last
; terminator, we're done. We'll have the address of
; the message and the length.
;
; After loading, this will restore the bank and then
; fall through to <a href="#TextBox_ClearPasswordSize">TextBox_ClearPasswordSize</a>.
;
; INPUTS:
;     A:
;         The 1-based index of the message to load.
;
;     <a href="PRG13.html#MESSAGE_STRINGS">MESSAGE_STRINGS</a>:
;         The list of messages to scan.
;
; OUTPUTS:
;     <a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a>:
;         The length of the message string.
;
;     <a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a>:
;         The starting message character position (0).
;
;     <a href="RAM.html#Message_StartAddr">Message_StartAddr</a>+1:
;     <a href="RAM.html#Message_StartAddr">Message_StartAddr</a>:
;         The address of the start of the message string.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Set to address $1400.
;
;     <a href="RAM.html#TextBox_MessagePaused">TextBox_MessagePaused</a>:
;     <a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a>:
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;     <a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a>:
;         All set to 0.
;
;     <a href="RAM.html#Unused_Arg_Text_NumLines">Unused_Arg_Text_NumLines</a>:
;         Set to 4.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_OpenShop">IScriptAction_OpenShop</a>
;     <a href="PRG12.html#IScriptAction_ShowMessage">IScriptAction_ShowMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowQuestionMessage">IScriptAction_ShowQuestionMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowQuestionMessageCheckIfDismissed">IScriptAction_ShowQuestionMessageCheckIfDismissed</a>
;     <a href="PRG12.html#IScriptAction_ShowSellMenu">IScriptAction_ShowSellMenu</a>
;     <a href="PRG12.html#IScriptAction_ShowUnskippableMessage">IScriptAction_ShowUnskippableMessage</a>
;     <a href="PRG12.html#IScripts_ShowFinalMessage">IScripts_ShowFinalMessage</a>
;     <a href="#IScripts_LoadAndShowMessage">IScripts_LoadAndShowMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f3f5" href="#f3f5">[f3f5]</a><a href="#Messages_Load" class="la">Messages_Load:</a><span class="ce">; [$f3f5]</span></span>
<span class="l"><a class="anc" name="f3f5" href="#f3f5">[f3f5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save our current bank.
;
</div><span class="l"><a class="anc" name="f3f8" href="#f3f8">[f3f8]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = Our current bank</span></span>
<span class="l"><a class="anc" name="f3fb" href="#f3fb">[f3fb]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to Bank 13 for the strings.
;
</div><span class="l"><a class="anc" name="f3fc" href="#f3fc">[f3fc]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0d</span></span><span class="ce">; Update to Bank 13.</span></span>
<span class="l"><a class="anc" name="f3fe" href="#f3fe">[f3fe]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the start of the messages string (<a href="PRG13.html#MESSAGE_STRINGS">MESSAGE_STRINGS</a>).
;
</div><span class="l"><a class="anc" name="f401" href="#f401">[f401]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; Set the lower byte of the address for the strings.</span></span>
<span class="l"><a class="anc" name="f403" href="#f403">[f403]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f405" href="#f405">[f405]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$83</span></span><span class="ce">; Set the upper byte of the address for the strings.</span></span>
<span class="l"><a class="anc" name="f407" href="#f407">[f407]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the start of our message length for the
; string scan.
;
</div><span class="l"><a class="anc" name="f409" href="#f409">[f409]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0 (start of our lookup offset)</span></span>
<span class="l"><a class="anc" name="f40b" href="#f40b">[f40b]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a></span></span><span class="ce">; Set start character pos to 0</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare to loop through the message characters, starting
; at Message ID - 1 and going through 0.
;
; This will effectively from message ID 0 to the end of the
; provided message ID. We'll be doing a full string scan of
; every string along the way (there's no lookup table).
;
</div><span class="l"><a class="anc" name="f40e" href="#f40e">[f40e]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; X = MessageID</span></span>
<span class="l"><a class="anc" name="f411" href="#f411">[f411]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="f412" href="#f412">[f412]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_afterLoops">@_afterLoops</a></span></span><span class="ce">; If 0, don't do the message string index loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f414:@_messageLoop"></a><div class="c">;
; Loop through characters in the current message string.
;
; We'll loop until we hit the end of a string.
;
</div><span class="l"><a class="anc" name="f414" href="#f414">[f414]</a><a href="#:f414:@_messageLoop" class="lla">@_messageLoop:</a><span class="ce">; [$f414]</span></span>
<span class="l"><a class="anc" name="f414" href="#f414">[f414]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Character at Y from the current string.</span></span>
<span class="l"><a class="anc" name="f416" href="#f416">[f416]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If Y == 0, increment our upper byte position. This
; will happen when Y wraps around from 0xFF to 0.
;
</div><span class="l"><a class="anc" name="f417" href="#f417">[f417]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_checkChar">@_checkChar</a></span></span><span class="ce">; If Y != 0, jump.</span></span>
<span class="l"><a class="anc" name="f419" href="#f419">[f419]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Y is 0. Increment upper byte position.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f41b:@_checkChar"></a><div class="c">;
; Check if we hit a string terminator (0xFF). If so,
; decrement the local message ID index.
;
</div><span class="l"><a class="anc" name="f41b" href="#f41b">[f41b]</a><a href="#:f41b:@_checkChar" class="lla">@_checkChar:</a><span class="ce">; [$f41b]</span></span>
<span class="l"><a class="anc" name="f41b" href="#f41b">[f41b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is A (the character) 0xFF?</span></span>
<span class="l"><a class="anc" name="f41d" href="#f41d">[f41d]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_messageLoop">@_messageLoop</a></span></span><span class="ce">; If not 0xFF, loop.</span></span>
<span class="l"><a class="anc" name="f41f" href="#f41f">[f41f]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; A is 0xFF. X-- to the previous message ID.</span></span>
<span class="l"><a class="anc" name="f420" href="#f420">[f420]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_messageLoop">@_messageLoop</a></span></span><span class="ce">; If X != 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f422:@_afterLoops"></a><div class="c">;
; We found the start position of our string (or were there
; already). We're done. Begin storing state.
;
</div><span class="l"><a class="anc" name="f422" href="#f422">[f422]</a><a href="#:f422:@_afterLoops" class="lla">@_afterLoops:</a><span class="ce">; [$f422]</span></span>
<span class="l"><a class="anc" name="f422" href="#f422">[f422]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a></span></span><span class="ce">; Message length = Y</span></span>
<span class="l"><a class="anc" name="f425" href="#f425">[f425]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Load the new lower byte of the string position.</span></span>
<span class="l"><a class="anc" name="f427" href="#f427">[f427]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr">Message_StartAddr</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f42a" href="#f42a">[f42a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Load the new upper byte of the string position.</span></span>
<span class="l"><a class="anc" name="f42c" href="#f42c">[f42c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr_U">Message_StartAddr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore our previous bank.
;
</div><span class="l"><a class="anc" name="f42f" href="#f42f">[f42f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A (our previous bank) off the stack.</span></span>
<span class="l"><a class="anc" name="f430" href="#f430">[f430]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f431" href="#f431">[f431]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch bank to the bank.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_ClearPasswordSize"></a><div class="cp">;============================================================================
; Clear the size of the password text box.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Set to address $1400.
;
;     <a href="RAM.html#TextBox_MessagePaused">TextBox_MessagePaused</a>:
;     <a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a>:
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;     <a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a>:
;         All set to 0.
;
;     <a href="RAM.html#Unused_Arg_Text_NumLines">Unused_Arg_Text_NumLines</a>:
;         Set to 4.
;
; CALLS:
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_ShowPassword">IScriptAction_ShowPassword</a>
;============================================================================
</div><span class="l"><a class="anc" name="f434" href="#f434">[f434]</a><a href="#TextBox_ClearPasswordSize" class="la">TextBox_ClearPasswordSize:</a><span class="ce">; [$f434]</span></span>
<span class="l"><a class="anc" name="f434" href="#f434">[f434]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f436" href="#f436">[f436]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; Set line scroll offset to 0.</span></span>
<span class="l"><a class="anc" name="f439" href="#f439">[f439]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; Set character position in line to 0.</span></span>
<span class="l"><a class="anc" name="f43c" href="#f43c">[f43c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; Set the drawn line number to 0.</span></span>
<span class="l"><a class="anc" name="f43f" href="#f43f">[f43f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_MessagePaused">TextBox_MessagePaused</a></span></span><span class="ce">; Clear the message paused state.</span></span>
<span class="l"><a class="anc" name="f442" href="#f442">[f442]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span><span class="ce">; Set the title character offset to 0.</span></span>
<span class="l"><a class="anc" name="f445" href="#f445">[f445]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$04</span></span></span>
<span class="l"><a class="anc" name="f447" href="#f447">[f447]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Unused_Arg_Text_NumLines">Unused_Arg_Text_NumLines</a></span></span><span class="ce">; Set the textbo height to 4.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_ClearTextTiles"></a><div class="cp">;============================================================================
; Clear the text tiles from the textbox.
;
; This will loop through the text tiles and clear them out.
; Tiles $1400 through $1800 will be cleared.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         The PPU target address ($1400).
;
; CALLS:
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_FillPlaceholderText">IScripts_FillPlaceholderText</a>
;============================================================================
</div><span class="l"><a class="anc" name="f44a" href="#f44a">[f44a]</a><a href="#TextBox_ClearTextTiles" class="la">TextBox_ClearTextTiles:</a><span class="ce">; [$f44a]</span></span>
<div class="c">;
; Set the PPU target address to $1400. These are the
; text tiles.
;
</div><span class="l"><a class="anc" name="f44a" href="#f44a">[f44a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$14</span></span><span class="ce">; 0x14 == upper byte of the PPU address.</span></span>
<span class="l"><a class="anc" name="f44c" href="#f44c">[f44c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f44e" href="#f44e">[f44e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; 0x00 == lower byte.</span></span>
<span class="l"><a class="anc" name="f450" href="#f450">[f450]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f452" href="#f452">[f452]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$20</span></span><span class="ce">; Y = 32 (loop counter).</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f454:@_writeLoop"></a><div class="c">;
; Write the value 0x00 for bytes $1400 through $1800.
;
</div><span class="l"><a class="anc" name="f454" href="#f454">[f454]</a><a href="#:f454:@_writeLoop" class="lla">@_writeLoop:</a><span class="ce">; [$f454]</span></span>
<span class="l"><a class="anc" name="f454" href="#f454">[f454]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (loop counter)</span></span>
<span class="l"><a class="anc" name="f455" href="#f455">[f455]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push to the stack.</span></span>
<span class="l"><a class="anc" name="f456" href="#f456">[f456]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f458" href="#f458">[f458]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$20</span></span><span class="ce">; Y = 32</span></span>
<span class="l"><a class="anc" name="f45a" href="#f45a">[f45a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a></span></span><span class="ce">; Write 0x00 32 times to the PPU buffer.</span></span>
<span class="l"><a class="anc" name="f45d" href="#f45d">[f45d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a></span></span><span class="ce">; Address += 32</span></span>
<span class="l"><a class="anc" name="f460" href="#f460">[f460]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="f461" href="#f461">[f461]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A (loop counter)</span></span>
<span class="l"><a class="anc" name="f462" href="#f462">[f462]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="f463" href="#f463">[f463]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_writeLoop">@_writeLoop</a></span></span><span class="ce">; If &gt; 0, loop.</span></span>
<span class="l"></span>
<a name="TextBox_ClearShopSizeAtOffset_return"></a><div class="c">;
; XREFS:
;     <a href="#Maybe_TextBox_ShowCurrentMessageID">Maybe_TextBox_ShowCurrentMessageID</a>
;
</div><span class="l"><a class="anc" name="f465" href="#f465">[f465]</a><a href="#TextBox_ClearShopSizeAtOffset_return" class="la">TextBox_ClearShopSizeAtOffset_return:</a><span class="ce">; [$f465]</span></span>
<span class="l"><a class="anc" name="f465" href="#f465">[f465]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_ShowNextChar"></a><div class="cp">;============================================================================
; Show the next character in a textbox.
;
; This will temporarily switch to bank 13 (strings),
; increment the position to show, and show it.
;
; INPUTS:
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a>:
;         The current message character position.
;
; OUTPUTS:
;     <a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a>:
;         The incremented position.
;
;     <a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a>:
;         Set to 1.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a>
;     <a href="#Maybe_TextBox_ShowCurrentMessageID">Maybe_TextBox_ShowCurrentMessageID</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_OpenShop">IScriptAction_OpenShop</a>
;     <a href="PRG12.html#IScriptAction_ShowMessage">IScriptAction_ShowMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowQuestionMessage">IScriptAction_ShowQuestionMessage</a>
;     <a href="PRG12.html#IScriptAction_ShowQuestionMessageCheckIfDismissed">IScriptAction_ShowQuestionMessageCheckIfDismissed</a>
;     <a href="PRG12.html#IScriptAction_ShowSellMenu">IScriptAction_ShowSellMenu</a>
;     <a href="PRG12.html#IScriptAction_ShowUnskippableMessage">IScriptAction_ShowUnskippableMessage</a>
;     <a href="PRG12.html#IScripts_ShowFinalMessage">IScripts_ShowFinalMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f466" href="#f466">[f466]</a><a href="#TextBox_ShowNextChar" class="la">TextBox_ShowNextChar:</a><span class="ce">; [$f466]</span></span>
<div class="c">;
; Save the current bank and switch to bank 13 (strings).
;
</div><span class="l"><a class="anc" name="f466" href="#f466">[f466]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = current bank</span></span>
<span class="l"><a class="anc" name="f469" href="#f469">[f469]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f46a" href="#f46a">[f46a]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0d</span></span><span class="ce">; X = 13 (bank)</span></span>
<span class="l"><a class="anc" name="f46c" href="#f46c">[f46c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to bank 13.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Show the next character.
;
</div><span class="l"><a class="anc" name="f46f" href="#f46f">[f46f]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a></span></span><span class="ce">; Increment the next character position.</span></span>
<span class="l"><a class="anc" name="f472" href="#f472">[f472]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; A = 1</span></span>
<span class="l"><a class="anc" name="f474" href="#f474">[f474]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f477" href="#f477">[f477]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Maybe_TextBox_ShowCurrentMessageID">Maybe_TextBox_ShowCurrentMessageID</a></span></span><span class="ce">; Show this character in the message.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the bank and return.
;
</div><span class="l"><a class="anc" name="f47a" href="#f47a">[f47a]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore the pushed bank.</span></span>
</pre><pre><a name="TextBox_LoadAndShowMessage"></a><div class="cp">;============================================================================
; TODO: Document TextBox_LoadAndShowMessage
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#IScripts_LoadAndShowMessage">IScripts_LoadAndShowMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f47d" href="#f47d">[f47d]</a><a href="#TextBox_LoadAndShowMessage" class="la">TextBox_LoadAndShowMessage:</a><span class="ce">; [$f47d]</span></span>
<div class="c">;
; Save the current ROM.
;
</div><span class="l"><a class="anc" name="f47d" href="#f47d">[f47d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f480" href="#f480">[f480]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to Bank 13, where the strings are.
;
</div><span class="l"><a class="anc" name="f481" href="#f481">[f481]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0d</span></span></span>
<span class="l"><a class="anc" name="f483" href="#f483">[f483]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f486" href="#f486">[f486]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f488" href="#f488">[f488]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a></span></span></span>
<span class="l"><a class="anc" name="f48b" href="#f48b">[f48b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_DisplayMessage">TextBox_DisplayMessage</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the previous bank.
;
</div><span class="l"><a class="anc" name="f48e" href="#f48e">[f48e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="Maybe_TextBox_ShowCurrentMessageID"></a><div class="cp">;============================================================================
; TODO: Document Maybe_TextBox_ShowCurrentMessageID
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowNextChar">TextBox_ShowNextChar</a>
;============================================================================
</div><span class="l"><a class="anc" name="f491" href="#f491">[f491]</a><a href="#Maybe_TextBox_ShowCurrentMessageID" class="la">Maybe_TextBox_ShowCurrentMessageID:</a><span class="ce">; [$f491]</span></span>
<span class="l"><a class="anc" name="f491" href="#f491">[f491]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; Load the message ID to show.</span></span>
<span class="l"><a class="anc" name="f494" href="#f494">[f494]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ClearShopSizeAtOffset_return">TextBox_ClearShopSizeAtOffset_return</a></span></span><span class="ce">; If unset, return.</span></span>
<span class="l"><a class="anc" name="f496" href="#f496">[f496]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_MessagePaused">TextBox_MessagePaused</a></span></span></span>
<span class="l"><a class="anc" name="f499" href="#f499">[f499]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#TextBox_ClearShopSizeAtOffset_return">TextBox_ClearShopSizeAtOffset_return</a></span></span></span>
<span class="l"><a class="anc" name="f49b" href="#f49b">[f49b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Maybe_MessageCharPos">Maybe_MessageCharPos</a></span></span><span class="ce">; Load the character position to display.</span></span>
<span class="l"><a class="anc" name="f49e" href="#f49e">[f49e]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Check the first 2 bits.</span></span>
<span class="l"><a class="anc" name="f4a0" href="#f4a0">[f4a0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#TextBox_ClearShopSizeAtOffset_return">TextBox_ClearShopSizeAtOffset_return</a></span></span><span class="ce">; If neither bit is set, return.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
</pre><pre><a name="TextBox_DisplayMessage"></a><div class="cp">;============================================================================
; TODO: Document TextBox_DisplayMessage
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_LoadAndShowMessage">TextBox_LoadAndShowMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f4a2" href="#f4a2">[f4a2]</a><a href="#TextBox_DisplayMessage" class="la">TextBox_DisplayMessage:</a><span class="ce">; [$f4a2]</span></span>
<span class="l"><a class="anc" name="f4a2" href="#f4a2">[f4a2]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
<span class="l"><a class="anc" name="f4a5" href="#f4a5">[f4a5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a></span></span></span>
<span class="l"><a class="anc" name="f4a7" href="#f4a7">[f4a7]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$90</span></span></span>
<span class="l"><a class="anc" name="f4a9" href="#f4a9">[f4a9]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f4c3">@LAB_PRG15_MIRROR__f4c3</a></span></span></span>
<span class="l"><a class="anc" name="f4ab" href="#f4ab">[f4ab]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="f4ad" href="#f4ad">[f4ad]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Convert the player's title to an index in the string list.
;
</div><span class="l"><a class="anc" name="f4af" href="#f4af">[f4af]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span><span class="ce">; Load the player's title.</span></span>
<span class="l"><a class="anc" name="f4b2" href="#f4b2">[f4b2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left 4, converting to an index.</span></span>
<span class="l"><a class="anc" name="f4b3" href="#f4b3">[f4b3]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f4b4" href="#f4b4">[f4b4]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f4b5" href="#f4b5">[f4b5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f4b6" href="#f4b6">[f4b6]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f4b8" href="#f4b8">[f4b8]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f4b9" href="#f4b9">[f4b9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PLAYER_TITLE_STRINGS">PLAYER_TITLE_STRINGS</a>,X</span></span><span class="ce">; Look up the string.</span></span>
<span class="l"><a class="anc" name="f4bc" href="#f4bc">[f4bc]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
<span class="l"><a class="anc" name="f4bf" href="#f4bf">[f4bf]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f4c1" href="#f4c1">[f4c1]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a></span></span></span>
<span class="l"></span>
<a name=":f4c3:@LAB_PRG15_MIRROR__f4c3"></a><span class="l"><a class="anc" name="f4c3" href="#f4c3">[f4c3]</a><a href="#:f4c3:@LAB_PRG15_MIRROR__f4c3" class="lla">@LAB_PRG15_MIRROR__f4c3:</a><span class="ce">; [$f4c3]</span></span>
<span class="l"><a class="anc" name="f4c3" href="#f4c3">[f4c3]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f4c5" href="#f4c5">[f4c5]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
</pre><pre><a name="TextBox_ShowMessage_LoadMessage"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_LoadMessage
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_DisplayMessage">TextBox_DisplayMessage</a>
;     <a href="#TextBox_ShowMessage_Newline">TextBox_ShowMessage_Newline</a>
;============================================================================
</div><span class="l"><a class="anc" name="f4c8" href="#f4c8">[f4c8]</a><a href="#TextBox_ShowMessage_LoadMessage" class="la">TextBox_ShowMessage_LoadMessage:</a><span class="ce">; [$f4c8]</span></span>
<span class="l"><a class="anc" name="f4c8" href="#f4c8">[f4c8]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr">Message_StartAddr</a></span></span></span>
<span class="l"><a class="anc" name="f4cb" href="#f4cb">[f4cb]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f4cd" href="#f4cd">[f4cd]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr_U">Message_StartAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="f4d0" href="#f4d0">[f4d0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="f4d2" href="#f4d2">[f4d2]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a></span></span></span>
<span class="l"><a class="anc" name="f4d5" href="#f4d5">[f4d5]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a></span></span></span>
<span class="l"><a class="anc" name="f4d8" href="#f4d8">[f4d8]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f4dd">@LAB_PRG15_MIRROR__f4dd</a></span></span></span>
<span class="l"><a class="anc" name="f4da" href="#f4da">[f4da]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#Message_StartAddr_U">Message_StartAddr_U</a></span></span></span>
<span class="l"></span>
<a name=":f4dd:@LAB_PRG15_MIRROR__f4dd"></a><span class="l"><a class="anc" name="f4dd" href="#f4dd">[f4dd]</a><a href="#:f4dd:@LAB_PRG15_MIRROR__f4dd" class="lla">@LAB_PRG15_MIRROR__f4dd:</a><span class="ce">; [$f4dd]</span></span>
<span class="l"><a class="anc" name="f4dd" href="#f4dd">[f4dd]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"><a class="anc" name="f4df" href="#f4df">[f4df]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f4e1" href="#f4e1">[f4e1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_EndOfMessage">TextBox_ShowMessage_EndOfMessage</a></span></span></span>
<span class="l"><a class="anc" name="f4e3" href="#f4e3">[f4e3]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fe</span></span></span>
<span class="l"><a class="anc" name="f4e5" href="#f4e5">[f4e5]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Newline">TextBox_ShowMessage_Newline</a></span></span></span>
<span class="l"><a class="anc" name="f4e7" href="#f4e7">[f4e7]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fd</span></span></span>
<span class="l"><a class="anc" name="f4e9" href="#f4e9">[f4e9]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Space">TextBox_ShowMessage_Space</a></span></span></span>
<span class="l"><a class="anc" name="f4eb" href="#f4eb">[f4eb]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fb</span></span></span>
<span class="l"><a class="anc" name="f4ed" href="#f4ed">[f4ed]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_ShowPlayerTitle">TextBox_ShowMessage_ShowPlayerTitle</a></span></span></span>
<span class="l"><a class="anc" name="f4ef" href="#f4ef">[f4ef]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fc</span></span></span>
<span class="l"><a class="anc" name="f4f1" href="#f4f1">[f4f1]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Pause">TextBox_ShowMessage_Pause</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
</pre><pre><a name="TextBox_ShowMessageWithSound"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessageWithSound
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_DisplayMessage">TextBox_DisplayMessage</a>
;     <a href="#TextBox_ShowMessage_ShowPlayerTitle">TextBox_ShowMessage_ShowPlayerTitle</a>
;============================================================================
</div><span class="l"><a class="anc" name="f4f3" href="#f4f3">[f4f3]</a><a href="#TextBox_ShowMessageWithSound" class="la">TextBox_ShowMessageWithSound:</a><span class="ce">; [$f4f3]</span></span>
<span class="l"><a class="anc" name="f4f3" href="#f4f3">[f4f3]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#TextBox_PlayTextSound">TextBox_PlayTextSound</a></span></span></span>
<span class="l"><a class="anc" name="f4f6" href="#f4f6">[f4f6]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage">TextBox_ShowMessage</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Play the message sound effect.
;
</div><span class="l"><a class="anc" name="f4f8" href="#f4f8">[f4f8]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><a class="anc" name="f4f9" href="#f4f9">[f4f9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$01</span></span><span class="ce">; 0x01 == Message sound effect.</span></span>
<span class="l"><a class="anc" name="f4fb" href="#f4fb">[f4fb]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Sound_PlayEffect">Sound_PlayEffect</a></span></span><span class="ce">; Play it.</span></span>
<span class="l"><a class="anc" name="f4fe" href="#f4fe">[f4fe]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
</pre><pre><a name="TextBox_ShowMessage"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_ShowNextChar">PasswordScreen_ShowNextChar</a>
;     <a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a>
;============================================================================
</div><span class="l"><a class="anc" name="f4ff" href="#f4ff">[f4ff]</a><a href="#TextBox_ShowMessage" class="la">TextBox_ShowMessage:</a><span class="ce">; [$f4ff]</span></span>
<span class="l"><a class="anc" name="f4ff" href="#f4ff">[f4ff]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><a name="TextBox_ShowMessage_Space"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Space
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f502" href="#f502">[f502]</a><a href="#TextBox_ShowMessage_Space" class="la">TextBox_ShowMessage_Space:</a><span class="ce">; [$f502]</span></span>
<div class="c">;
; If it's 0xFD, it's a space.
;
</div><span class="l"><a class="anc" name="f502" href="#f502">[f502]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><a class="anc" name="f505" href="#f505">[f505]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><a class="anc" name="f508" href="#f508">[f508]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="f50a" href="#f50a">[f50a]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#TextBox_ShowMessage_Return">TextBox_ShowMessage_Return</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the next character in the message string.
;
</div><span class="l"><a class="anc" name="f50c" href="#f50c">[f50c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr">Message_StartAddr</a></span></span></span>
<span class="l"><a class="anc" name="f50f" href="#f50f">[f50f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f511" href="#f511">[f511]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr_U">Message_StartAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="f514" href="#f514">[f514]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="f516" href="#f516">[f516]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a></span></span></span>
<span class="l"><a class="anc" name="f519" href="#f519">[f519]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If it's 0xFF, the message ends.
;
</div><span class="l"><a class="anc" name="f51b" href="#f51b">[f51b]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f51d" href="#f51d">[f51d]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_EndOfMessage">TextBox_ShowMessage_EndOfMessage</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If it's 0xFC, finish this part of the message.
;
</div><span class="l"><a class="anc" name="f51f" href="#f51f">[f51f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$fc</span></span></span>
<span class="l"><a class="anc" name="f521" href="#f521">[f521]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Return">TextBox_ShowMessage_Return</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><a name="TextBox_ShowMessage_Newline"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Newline
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f523" href="#f523">[f523]</a><a href="#TextBox_ShowMessage_Newline" class="la">TextBox_ShowMessage_Newline:</a><span class="ce">; [$f523]</span></span>
<div class="c">;
; If it's 0xFE, it's a newline.
;
</div><span class="l"><a class="anc" name="f523" href="#f523">[f523]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span></span>
<span class="l"><a class="anc" name="f526" href="#f526">[f526]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><a name="TextBox_ShowMessage_IncLineAndReset"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_IncLineAndReset
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Prepare4Lines">TextBox_ShowMessage_Prepare4Lines</a>
;============================================================================
</div><span class="l"><a class="anc" name="f528" href="#f528">[f528]</a><a href="#TextBox_ShowMessage_IncLineAndReset" class="la">TextBox_ShowMessage_IncLineAndReset:</a><span class="ce">; [$f528]</span></span>
<div class="c">;
; Increment the line and reset the character position.
;
</div><span class="l"><a class="anc" name="f528" href="#f528">[f528]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f52a" href="#f52a">[f52a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; Set as the character position.</span></span>
<span class="l"><a class="anc" name="f52d" href="#f52d">[f52d]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; Y = line number</span></span>
<span class="l"><a class="anc" name="f530" href="#f530">[f530]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if we've reached the end of the textbox.
; If so, prepare the state for the next 4 lines.
;
</div><span class="l"><a class="anc" name="f531" href="#f531">[f531]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$04</span></span><span class="ce">; Is the line number 4?</span></span>
<span class="l"><a class="anc" name="f533" href="#f533">[f533]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a></span></span><span class="ce">; If so, jump.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We're not at the end of the textbox. Increment and return.
;
</div><span class="l"><a class="anc" name="f535" href="#f535">[f535]</a><span class="cd"><span class="i">STY</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; Els, set as the number of drawn lines.</span></span>
<span class="l"><a class="anc" name="f538" href="#f538">[f538]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_ShowMessage_Prepare4Lines"></a><div class="cp">;============================================================================
; Prepare a 4-line textbox for writing.
;
; This will set the initial draw position and data for
; a textbox covering 4 lines. It will then fill it with
; placeholder data and then clear it.
;
; This ensures state is set up to write text, and that
; the buffer is prepared.
;
; INPUTS:
;     <a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a>:
;         The 1-based starting character position.
;
;         If 0, this will just return.
;
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;         The last drawn line number.
;
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;         The line scroll offset of the tex tbox.
;
;     <a href="RAM.html#TextBox_X">TextBox_X</a>:
;         The X position of the text box.
;
;     <a href="RAM.html#TextBox_Y">TextBox_Y</a>:
;         The Y position of the text box.
;
; OUTPUTS:
;     <a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a>:
;         The X position to begin writing to.
;
;     <a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a>:
;         The Y position to begin writing to.
;
;     <a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a>:
;         The scroll offset of the line.
;
;     <a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a>:
;         The drawn line number.
;
; CALLS:
;     <a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a>
;     <a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;     <a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a>
;
; XREFS:
;     <a href="PRG12.html#TextBox_PrepareContinueMessage">TextBox_PrepareContinueMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f539" href="#f539">[f539]</a><a href="#TextBox_ShowMessage_Prepare4Lines" class="la">TextBox_ShowMessage_Prepare4Lines:</a><span class="ce">; [$f539]</span></span>
<div class="c">;
; Check if anything's ready to be written for this line.
;
</div><span class="l"><a class="anc" name="f539" href="#f539">[f539]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; Load the character position (1-based; 0 for not ready).</span></span>
<span class="l"><a class="anc" name="f53c" href="#f53c">[f53c]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#TextBox_ShowMessage_IncLineAndReset">TextBox_ShowMessage_IncLineAndReset</a></span></span><span class="ce">; If &gt; 0, the line can be drawn.</span></span>
<span class="l"><a class="anc" name="f53e" href="#f53e">[f53e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_ShowMessage_Pause"></a><div class="cp">;============================================================================
; Handle a pause in the message the player must acknowledge.
;
; This is message code 0xFC.
;
; If the very next code is 0xFF, this will simply end the
; message.
;
; INPUTS:
;     <a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a>:
;          The processed number of bytes of the message.
;
;     <a href="RAM.html#Message_StartAddr">Message_StartAddr</a>:
;     <a href="RAM.html#Message_StartAddr">Message_StartAddr</a>+1:
;         The address of the loaded message string.
;
; OUTPUTS:
;     <a href="RAM.html#MessageID">MessageID</a>:
;         Set to 0 if the message ends.
;
;     <a href="RAM.html#TextBox_MessagePaused">TextBox_MessagePaused</a>:
;         Set to 0xFF if paused.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         Clobbered.
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f53f" href="#f53f">[f53f]</a><a href="#TextBox_ShowMessage_Pause" class="la">TextBox_ShowMessage_Pause:</a><span class="ce">; [$f53f]</span></span>
<span class="l"><a class="anc" name="f53f" href="#f53f">[f53f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr">Message_StartAddr</a></span></span><span class="ce">; Load the lower byte of the message string address.</span></span>
<span class="l"><a class="anc" name="f542" href="#f542">[f542]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store it for length calculation.</span></span>
<span class="l"><a class="anc" name="f544" href="#f544">[f544]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Message_StartAddr_U">Message_StartAddr_U</a></span></span><span class="ce">; Load the upper byte.</span></span>
<span class="l"><a class="anc" name="f547" href="#f547">[f547]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if the next byte is 0xFF, in which case we just want
; to end the message immediately.
;
</div><span class="l"><a class="anc" name="f549" href="#f549">[f549]</a><span class="cd"><span class="i">LDY</span> <span class="o">a:<a href="RAM.html#Message_ProcessedLength">Message_ProcessedLength</a></span></span><span class="ce">; Load the message length.</span></span>
<span class="l"><a class="anc" name="f54c" href="#f54c">[f54c]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; Load the next byte of the message.</span></span>
<span class="l"><a class="anc" name="f54e" href="#f54e">[f54e]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$ff</span></span><span class="ce">; Is it 0xFF (end of message)?</span></span>
<span class="l"><a class="anc" name="f550" href="#f550">[f550]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#TextBox_ShowMessage_EndOfMessage">TextBox_ShowMessage_EndOfMessage</a></span></span><span class="ce">; If true, then end message.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The message isn't ending. We're paused instead.
;
</div><span class="l"><a class="anc" name="f552" href="#f552">[f552]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f554" href="#f554">[f554]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_MessagePaused">TextBox_MessagePaused</a></span></span><span class="ce">; Set the message as paused.</span></span>
<span class="l"></span>
<a name="TextBox_ShowMessage_Return"></a><div class="c">;
; XREFS:
;     <a href="#TextBox_ShowMessage_Space">TextBox_ShowMessage_Space</a>
;
</div><span class="l"><a class="anc" name="f557" href="#f557">[f557]</a><a href="#TextBox_ShowMessage_Return" class="la">TextBox_ShowMessage_Return:</a><span class="ce">; [$f557]</span></span>
<span class="l"><a class="anc" name="f557" href="#f557">[f557]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="TextBox_ShowMessage_EndOfMessage"></a><div class="c">;
; This is the end of the message.
;
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;     <a href="#TextBox_ShowMessage_Pause">TextBox_ShowMessage_Pause</a>
;     <a href="#TextBox_ShowMessage_Space">TextBox_ShowMessage_Space</a>
;
</div><span class="l"><a class="anc" name="f558" href="#f558">[f558]</a><a href="#TextBox_ShowMessage_EndOfMessage" class="la">TextBox_ShowMessage_EndOfMessage:</a><span class="ce">; [$f558]</span></span>
<span class="l"><a class="anc" name="f558" href="#f558">[f558]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f55a" href="#f55a">[f55a]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#MessageID">MessageID</a></span></span><span class="ce">; Store as the message ID (terminating message).</span></span>
<span class="l"><a class="anc" name="f55d" href="#f55d">[f55d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_ShowMessage_ShowPlayerTitle"></a><div class="cp">;============================================================================
; Show the player's current title in the textbox.
;
; This is message code 0xFB.
;
; INPUTS:
;     <a href="RAM.html#PlayerTitle">PlayerTitle</a>:
;         The player's current title.
;
;     <a href="#PLAYER_TITLE_STRINGS">PLAYER_TITLE_STRINGS</a>:
;         The table of title strings.
;
; OUTPUTS:
;     <a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a>:
;         The start offset/counter for title writing.
;
; CALLS:
;     <a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage_LoadMessage">TextBox_ShowMessage_LoadMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f55e" href="#f55e">[f55e]</a><a href="#TextBox_ShowMessage_ShowPlayerTitle" class="la">TextBox_ShowMessage_ShowPlayerTitle:</a><span class="ce">; [$f55e]</span></span>
<div class="c">;
; If it's 0xFB, the title rank will be inserted.
;
</div><span class="l"><a class="anc" name="f55e" href="#f55e">[f55e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$81</span></span><span class="ce">; A = 0x81</span></span>
<span class="l"><a class="anc" name="f560" href="#f560">[f560]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Textbox_TitleCharOffset">Textbox_TitleCharOffset</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f563" href="#f563">[f563]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#PlayerTitle">PlayerTitle</a></span></span><span class="ce">; Load the player's title.</span></span>
<span class="l"><a class="anc" name="f566" href="#f566">[f566]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to an index in the Player Titles table.</span></span>
<span class="l"><a class="anc" name="f567" href="#f567">[f567]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f568" href="#f568">[f568]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f569" href="#f569">[f569]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f56a" href="#f56a">[f56a]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f56b" href="#f56b">[f56b]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#PLAYER_TITLE_STRINGS">PLAYER_TITLE_STRINGS</a>,X</span></span><span class="ce">; Load the title string at X.</span></span>
<span class="l"><a class="anc" name="f56e" href="#f56e">[f56e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#TextBox_ShowMessageWithSound">TextBox_ShowMessageWithSound</a></span></span><span class="ce">; Show this title in the textbox.</span></span>
</pre><pre><a name="TextBox_ShowMessage_Fill4Lines"></a><div class="cp">;============================================================================
; TODO: Document TextBox_ShowMessage_Fill4Lines
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_ShowMessage_IncLineAndReset">TextBox_ShowMessage_IncLineAndReset</a>
;============================================================================
</div><span class="l"><a class="anc" name="f571" href="#f571">[f571]</a><a href="#TextBox_ShowMessage_Fill4Lines" class="la">TextBox_ShowMessage_Fill4Lines:</a><span class="ce">; [$f571]</span></span>
<div class="c">;
; Set the start position where text will be drawn.
;
</div><span class="l"><a class="anc" name="f571" href="#f571">[f571]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_X">TextBox_X</a></span></span><span class="ce">; X = textbox tile X coordinate.</span></span>
<span class="l"><a class="anc" name="f574" href="#f574">[f574]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f575" href="#f575">[f575]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; X += 2</span></span>
<span class="l"><a class="anc" name="f577" href="#f577">[f577]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a></span></span><span class="ce">; Store as the text X start position.</span></span>
<span class="l"><a class="anc" name="f579" href="#f579">[f579]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_Y">TextBox_Y</a></span></span><span class="ce">; Y = textbox tile Y coordinate.</span></span>
<span class="l"><a class="anc" name="f57c" href="#f57c">[f57c]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f57d" href="#f57d">[f57d]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$02</span></span><span class="ce">; Y += 2</span></span>
<span class="l"><a class="anc" name="f57f" href="#f57f">[f57f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span><span class="ce">; Store as the text Y start position.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Write 3 lines.
;
; This will be the available text characters, filling
; up the buffer. It will contain:
;
;     @ABCDEFGHIJKLMNO
;     PQRSTUVWXYZ[\]^_
;     `abcdefghijklmno
;     pqrstuvwxyz{}|~.
;
; This will effectively reserve space in the buffer.
;
</div><span class="l"><a class="anc" name="f581" href="#f581">[f581]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a></span></span><span class="ce">; Set the PPU address for the text position.</span></span>
<span class="l"><a class="anc" name="f584" href="#f584">[f584]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; X = scroll line offset</span></span>
<span class="l"><a class="anc" name="f587" href="#f587">[f587]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a></span></span><span class="ce">; Write a line and advance.</span></span>
<span class="l"><a class="anc" name="f58a" href="#f58a">[f58a]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a></span></span><span class="ce">; Write a line and advance.</span></span>
<span class="l"><a class="anc" name="f58d" href="#f58d">[f58d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLineCapped">TextBox_FillPlaceholderTextForLineCapped</a></span></span><span class="ce">; Write a line and advance.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear the final line.
;
</div><span class="l"><a class="anc" name="f590" href="#f590">[f590]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0 (start offset)</span></span>
<span class="l"><a class="anc" name="f592" href="#f592">[f592]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16 (line length)</span></span>
<span class="l"><a class="anc" name="f594" href="#f594">[f594]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a></span></span><span class="ce">; Write '0' 16 times, clearing the line.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the starting text position to the beginning text char/pos
; of the text box we just wrote to.
;
</div><span class="l"><a class="anc" name="f597" href="#f597">[f597]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f599" href="#f599">[f599]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store A as the lower byte of the PPU target address.</span></span>
<span class="l"><a class="anc" name="f59b" href="#f59b">[f59b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; A = scroll-aware line offset.</span></span>
<span class="l"><a class="anc" name="f59e" href="#f59e">[f59e]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f59f" href="#f59f">[f59f]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$14</span></span><span class="ce">; A += 20</span></span>
<span class="l"><a class="anc" name="f5a1" href="#f5a1">[f5a1]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store as the upper byte of the PPU target addres.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear out each of the lines that were just written.
;
</div><span class="l"><a class="anc" name="f5a3" href="#f5a3">[f5a3]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$10</span></span><span class="ce">; X = 16</span></span>
<span class="l"></span>
<a name=":f5a5:@LAB_PRG15_MIRROR__f5a5"></a><span class="l"><a class="anc" name="f5a5" href="#f5a5">[f5a5]</a><a href="#:f5a5:@LAB_PRG15_MIRROR__f5a5" class="lla">@LAB_PRG15_MIRROR__f5a5:</a><span class="ce">; [$f5a5]</span></span>
<span class="l"><a class="anc" name="f5a5" href="#f5a5">[f5a5]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="f5a6" href="#f5a6">[f5a6]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><a class="anc" name="f5a7" href="#f5a7">[f5a7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f5a9" href="#f5a9">[f5a9]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16</span></span>
<span class="l"><a class="anc" name="f5ab" href="#f5ab">[f5ab]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a></span></span><span class="ce">; Write '0' 16 times, clearing the line.</span></span>
<span class="l"><a class="anc" name="f5ae" href="#f5ae">[f5ae]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a></span></span><span class="ce">; Increment the offset by 16.</span></span>
<span class="l"><a class="anc" name="f5b1" href="#f5b1">[f5b1]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A from the 
stack (now 16).</span></span>
<span class="l"><a class="anc" name="f5b2" href="#f5b2">[f5b2]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f5b3" href="#f5b3">[f5b3]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="f5b4" href="#f5b4">[f5b4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f5a5">@LAB_PRG15_MIRROR__f5a5</a></span></span><span class="ce">; If X &gt; 0, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Increase the Y position to draw to by 3, after these lines.
;
</div><span class="l"><a class="anc" name="f5b6" href="#f5b6">[f5b6]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span><span class="ce">; <a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a> += 3</span></span>
<span class="l"><a class="anc" name="f5b8" href="#f5b8">[f5b8]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span></span>
<span class="l"><a class="anc" name="f5ba" href="#f5ba">[f5ba]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw a line of text to fill the address.
;
; This will be:
;
;     PQRSTUVWXYZ[\]^_
;
</div><span class="l"><a class="anc" name="f5bc" href="#f5bc">[f5bc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a></span></span><span class="ce">; Set the text draw position back.</span></span>
<span class="l"><a class="anc" name="f5bf" href="#f5bf">[f5bf]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; A = line scroll offset.</span></span>
<span class="l"><a class="anc" name="f5c2" href="#f5c2">[f5c2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_FillPlaceholderTextForLine">TextBox_FillPlaceholderTextForLine</a></span></span><span class="ce">; Write a line of text.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store the new line number offset.
;
</div><span class="l"><a class="anc" name="f5c5" href="#f5c5">[f5c5]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="f5c6" href="#f5c6">[f5c6]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="f5c7" href="#f5c7">[f5c7]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Cap the line number from 0..4.</span></span>
<span class="l"><a class="anc" name="f5c9" href="#f5c9">[f5c9]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f5cc" href="#f5cc">[f5cc]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_FillPlaceholderTextForLineCapped"></a><div class="cp">;============================================================================
; Write a line of arbitrary text, taking into account textbox scrolling.
;
; The text will be placeholder text, intended to be
; cleared later.
;
; This is used when a maximum of 4 lines will be shown.
; The provided line number will be capped to a value
; between 0 and 4 and written to the textbox draw address.
;
; INPUTS:
;     X:
;         The line number to write to.
;
;         This will be capped to a displayed line number.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a class="anc" name="f5cd" href="#f5cd">[f5cd]</a><a href="#TextBox_FillPlaceholderTextForLineCapped" class="la">TextBox_FillPlaceholderTextForLineCapped:</a><span class="ce">; [$f5cd]</span></span>
<span class="l"><a class="anc" name="f5cd" href="#f5cd">[f5cd]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; lineNum++</span></span>
<span class="l"><a class="anc" name="f5ce" href="#f5ce">[f5ce]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Cap the linenum to lines 0-4.
;
</div><span class="l"><a class="anc" name="f5cf" href="#f5cf">[f5cf]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_FillPlaceholderTextForLine"></a><div class="cp">;============================================================================
; Write a line of arbitrary text.
;
; The text will be placeholder text, intended to be
; cleared later.
;
; INPUTS:
;     A:
;         The line number to write to.
;
;         This will be a 0-based index into the textbox.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a class="anc" name="f5d1" href="#f5d1">[f5d1]</a><a href="#TextBox_FillPlaceholderTextForLine" class="la">TextBox_FillPlaceholderTextForLine:</a><span class="ce">; [$f5d1]</span></span>
<span class="l"><a class="anc" name="f5d1" href="#f5d1">[f5d1]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Calculate a character offset for the line number.
; Lines are 16 characters per line.
;
</div><span class="l"><a class="anc" name="f5d2" href="#f5d2">[f5d2]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Multiply by 16.</span></span>
<span class="l"><a class="anc" name="f5d3" href="#f5d3">[f5d3]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f5d4" href="#f5d4">[f5d4]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f5d5" href="#f5d5">[f5d5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add 64, giving us a value of "A".
;
</div><span class="l"><a class="anc" name="f5d6" href="#f5d6">[f5d6]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$40</span></span><span class="ce">; Add 64 (character code of "A").</span></span>
<span class="l"><a class="anc" name="f5d8" href="#f5d8">[f5d8]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_FillPlaceholderTextAtLineWithStartChar"></a><div class="cp">;============================================================================
; Write a line of arbitrary text, starting with a character.
;
; The text will be placeholder text, intended to be
; cleared later.
;
; INPUTS:
;     A:
;         The line number to write to.
;
;         This will be a 0-based index into the textbox.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new upper bounds of the PPU buffer.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_FillPlaceholderText">IScripts_FillPlaceholderText</a>
;============================================================================
</div><span class="l"><a class="anc" name="f5d9" href="#f5d9">[f5d9]</a><a href="#TextBox_FillPlaceholderTextAtLineWithStartChar" class="la">TextBox_FillPlaceholderTextAtLineWithStartChar:</a><span class="ce">; [$f5d9]</span></span>
<span class="l"><a class="anc" name="f5d9" href="#f5d9">[f5d9]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X (offset)</span></span>
<span class="l"><a class="anc" name="f5da" href="#f5da">[f5da]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the write length to 16 characters (max for a line).
;
</div><span class="l"><a class="anc" name="f5db" href="#f5db">[f5db]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><a class="anc" name="f5dd" href="#f5dd">[f5dd]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue this as the write length.</span></span>
<span class="l"><a class="anc" name="f5e0" href="#f5e0">[f5e0]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Begin the write loop.
;
</div><span class="l"><a class="anc" name="f5e1" href="#f5e1">[f5e1]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$10</span></span><span class="ce">; Y = 16</span></span>
<span class="l"></span>
<a name=":f5e3:@_loop"></a><span class="l"><a class="anc" name="f5e3" href="#f5e3">[f5e3]</a><a href="#:f5e3:@_loop" class="lla">@_loop:</a><span class="ce">; [$f5e3]</span></span>
<span class="l"><a class="anc" name="f5e3" href="#f5e3">[f5e3]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span><span class="ce">; Write the value to the buffer.</span></span>
<span class="l"><a class="anc" name="f5e6" href="#f5e6">[f5e6]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f5e7" href="#f5e7">[f5e7]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$01</span></span><span class="ce">; A++ (next character value)</span></span>
<span class="l"><a class="anc" name="f5e9" href="#f5e9">[f5e9]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="f5ea" href="#f5ea">[f5ea]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If Y &gt; 0, loop.</span></span>
<span class="l"><a class="anc" name="f5ec" href="#f5ec">[f5ec]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store the new offset as the PPU upper bounds.</span></span>
<span class="l"><a class="anc" name="f5ee" href="#f5ee">[f5ee]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A from the stack.</span></span>
<span class="l"><a class="anc" name="f5ef" href="#f5ef">[f5ef]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f5f0" href="#f5f0">[f5f0]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a></span></span><span class="ce">; Increment the PPU address by 32.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_Maybe_WriteLineOfChars"></a><div class="cp">;============================================================================
; Write an ASCII value to the textbox at the next position.
;
; INPUTS:
;     A:
;         The ASCII value to write.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new upper bounds of the PPU buffer.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The PPU target address to write to.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#PPU_IncrementAddrBy32">PPU_IncrementAddrBy32</a>
;     <a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a>
;
; XREFS:
;     <a href="#TextBox_ShowMessage">TextBox_ShowMessage</a>
;============================================================================
</div><span class="l"><a class="anc" name="f5f3" href="#f5f3">[f5f3]</a><a href="#TextBox_Maybe_WriteLineOfChars" class="la">TextBox_Maybe_WriteLineOfChars:</a><span class="ce">; [$f5f3]</span></span>
<div class="c">;
; Normalize the ASCII value into an index in the characters
; table.
;
</div><span class="l"><a class="anc" name="f5f3" href="#f5f3">[f5f3]</a><span class="cd"><span class="i">SEC</span></span><span class="ce">; C = 1</span></span>
<span class="l"><a class="anc" name="f5f4" href="#f5f4">[f5f4]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$20</span></span><span class="ce">; A -= 32 (normalize the value to a character lookup table)</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the address of the string address.
;
; Each glyph is 8 bytes, so this will normalize the character
; index to the proper byte offset.
;
</div><span class="l"><a class="anc" name="f5f6" href="#f5f6">[f5f6]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; X = 0</span></span>
<span class="l"><a class="anc" name="f5f8" href="#f5f8">[f5f8]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Set middle byte of string address to 0.</span></span>
<span class="l"><a class="anc" name="f5fa" href="#f5fa">[f5fa]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A = A * 8 (each glyph is 8 bytes)</span></span>
<span class="l"><a class="anc" name="f5fb" href="#f5fb">[f5fb]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f5fc" href="#f5fc">[f5fc]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Rotate upper byte left and add carry.</span></span>
<span class="l"><a class="anc" name="f5fe" href="#f5fe">[f5fe]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f5ff" href="#f5ff">[f5ff]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="f601" href="#f601">[f601]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f603" href="#f603">[f603]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Make the address relative to $8000.
;
</div><span class="l"><a class="anc" name="f605" href="#f605">[f605]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Load the upper byte of of the address.</span></span>
<span class="l"><a class="anc" name="f607" href="#f607">[f607]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$80</span></span><span class="ce">; Add 0x80 to it.</span></span>
<span class="l"><a class="anc" name="f609" href="#f609">[f609]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Store it back.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute the PPU target address.
;
</div><span class="l"><a class="anc" name="f60b" href="#f60b">[f60b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; A = 0</span></span>
<span class="l"><a class="anc" name="f60d" href="#f60d">[f60d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store as the starting upper byte of the PPU target address.</span></span>
<span class="l"><a class="anc" name="f60f" href="#f60f">[f60f]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_CharPosForLine">TextBox_CharPosForLine</a></span></span><span class="ce">; A = character position.</span></span>
<span class="l"><a class="anc" name="f612" href="#f612">[f612]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to a 16 byte address boundary.</span></span>
<span class="l"><a class="anc" name="f613" href="#f613">[f613]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f614" href="#f614">[f614]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f615" href="#f615">[f615]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f616" href="#f616">[f616]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store as the lower byte of the PPU target address.</span></span>
<span class="l"><a class="anc" name="f618" href="#f618">[f618]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_DrawnLineNum">TextBox_DrawnLineNum</a></span></span><span class="ce">; A = drawn line number.</span></span>
<span class="l"><a class="anc" name="f61b" href="#f61b">[f61b]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f61c" href="#f61c">[f61c]</a><span class="cd"><span class="i">ADC</span> <span class="o">a:<a href="RAM.html#TextBox_LineScrollOffset">TextBox_LineScrollOffset</a></span></span><span class="ce">; A += line scroll offset</span></span>
<span class="l"><a class="anc" name="f61f" href="#f61f">[f61f]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span><span class="ce">; Cap to a 0..4 line number.</span></span>
<span class="l"><a class="anc" name="f621" href="#f621">[f621]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$14</span></span><span class="ce">; A += 20</span></span>
<span class="l"><a class="anc" name="f623" href="#f623">[f623]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Set as the new upper byte of the PPU target address.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save the current bank and switch to bank 13 (strings).
;
</div><span class="l"><a class="anc" name="f625" href="#f625">[f625]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = current bank</span></span>
<span class="l"><a class="anc" name="f628" href="#f628">[f628]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack.</span></span>
<span class="l"><a class="anc" name="f629" href="#f629">[f629]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0d</span></span><span class="ce">; A = bank 13</span></span>
<span class="l"><a class="anc" name="f62b" href="#f62b">[f62b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to it.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Queue up the drawn line.
;
</div><span class="l"><a class="anc" name="f62e" href="#f62e">[f62e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16 (line length)</span></span>
<span class="l"><a class="anc" name="f630" href="#f630">[f630]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue as the line length.</span></span>
<span class="l"><a class="anc" name="f633" href="#f633">[f633]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a></span></span><span class="ce">; Write the first half of the line.</span></span>
<span class="l"><a class="anc" name="f636" href="#f636">[f636]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a></span></span><span class="ce">; Write the second half.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Finish up and restore the bank.
;
</div><span class="l"><a class="anc" name="f639" href="#f639">[f639]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store the new upper bounds for the PPU buffer.</span></span>
<span class="l"><a class="anc" name="f63b" href="#f63b">[f63b]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span><span class="ce">; Restore to the previous bank.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_Write8BytesFromTemp"></a><div class="cp">;============================================================================
; Write values from temp to the PPU buffer.
;
; This will write all values from <a href="RAM.html#Temp_Int24">Temp_Int24</a>
; until a value 128-255 are hit.
;
; INPUTS:
;     X:
;         The destination index into the buffer to write to.
;
; OUTPUTS:
;     None
;
; CALLS:
;     <a href="#PPUBuffer_WriteFromTemp">PPUBuffer_WriteFromTemp</a>
;
; XREFS:
;     <a href="#TextBox_Maybe_WriteLineOfChars">TextBox_Maybe_WriteLineOfChars</a>
;============================================================================
</div><span class="l"><a class="anc" name="f63e" href="#f63e">[f63e]</a><a href="#TextBox_Write8BytesFromTemp" class="la">TextBox_Write8BytesFromTemp:</a><span class="ce">; [$f63e]</span></span>
<span class="l"><a class="anc" name="f63e" href="#f63e">[f63e]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Y = 0</span></span>
<span class="l"></span>
<a name=":f640:@_loop"></a><span class="l"><a class="anc" name="f640" href="#f640">[f640]</a><a href="#:f640:@_loop" class="lla">@_loop:</a><span class="ce">; [$f640]</span></span>
<span class="l"><a class="anc" name="f640" href="#f640">[f640]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteFromTemp">PPUBuffer_WriteFromTemp</a></span></span><span class="ce">; Write a value from temp.</span></span>
<span class="l"><a class="anc" name="f643" href="#f643">[f643]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="f644" href="#f644">[f644]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span><span class="ce">; Consider values 0-127.</span></span>
<span class="l"><a class="anc" name="f646" href="#f646">[f646]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><a class="anc" name="f648" href="#f648">[f648]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="PLAYER_TITLE_STRINGS"></a><div class="c">;
; XREFS:
;     <a href="#TextBox_DisplayMessage">TextBox_DisplayMessage</a>
;     <a href="#TextBox_ShowMessage_ShowPlayerTitle">TextBox_ShowMessage_ShowPlayerTitle</a>
;
</div><span class="l"><a class="anc" name="f649" href="#f649">[f649]</a><a href="#PLAYER_TITLE_STRINGS" class="la">PLAYER_TITLE_STRINGS:</a><span class="ce">; [$f649]</span></span>
<span class="l"><a class="anc" name="f649" href="#f649">[f649]</a><span class="cd"><span class="i">db</span> <span class="o">"Novice          "</span></span><span class="ce">; [$f649] char</span></span>
<span class="l"><a class="anc" name="f659" href="#f659">[f659]</a><span class="cd"><span class="i">db</span> <span class="o">"Aspirant        "</span></span><span class="ce">; [$f659] char</span></span>
<span class="l"><a class="anc" name="f669" href="#f669">[f669]</a><span class="cd"><span class="i">db</span> <span class="o">"Battler         "</span></span><span class="ce">; [$f669] char</span></span>
<span class="l"><a class="anc" name="f679" href="#f679">[f679]</a><span class="cd"><span class="i">db</span> <span class="o">"Fighter         "</span></span><span class="ce">; [$f679] char</span></span>
<span class="l"><a class="anc" name="f689" href="#f689">[f689]</a><span class="cd"><span class="i">db</span> <span class="o">"Adept           "</span></span><span class="ce">; [$f689] char</span></span>
<span class="l"><a class="anc" name="f699" href="#f699">[f699]</a><span class="cd"><span class="i">db</span> <span class="o">"Chevalier       "</span></span><span class="ce">; [$f699] char</span></span>
<span class="l"><a class="anc" name="f6a9" href="#f6a9">[f6a9]</a><span class="cd"><span class="i">db</span> <span class="o">"Veteran         "</span></span><span class="ce">; [$f6a9] char</span></span>
<span class="l"><a class="anc" name="f6b9" href="#f6b9">[f6b9]</a><span class="cd"><span class="i">db</span> <span class="o">"Warrior         "</span></span><span class="ce">; [$f6b9] char</span></span>
<span class="l"><a class="anc" name="f6c9" href="#f6c9">[f6c9]</a><span class="cd"><span class="i">db</span> <span class="o">"Swordman        "</span></span><span class="ce">; [$f6c9] char</span></span>
<span class="l"><a class="anc" name="f6d9" href="#f6d9">[f6d9]</a><span class="cd"><span class="i">db</span> <span class="o">"Hero            "</span></span><span class="ce">; [$f6d9] char</span></span>
<span class="l"><a class="anc" name="f6e9" href="#f6e9">[f6e9]</a><span class="cd"><span class="i">db</span> <span class="o">"Soldier         "</span></span><span class="ce">; [$f6e9] char</span></span>
<span class="l"><a class="anc" name="f6f9" href="#f6f9">[f6f9]</a><span class="cd"><span class="i">db</span> <span class="o">"Myrmidon        "</span></span><span class="ce">; [$f6f9] char</span></span>
<span class="l"><a class="anc" name="f709" href="#f709">[f709]</a><span class="cd"><span class="i">db</span> <span class="o">"Champion        "</span></span><span class="ce">; [$f709] char</span></span>
<span class="l"><a class="anc" name="f719" href="#f719">[f719]</a><span class="cd"><span class="i">db</span> <span class="o">"Superhero       "</span></span><span class="ce">; [$f719] char</span></span>
<span class="l"><a class="anc" name="f729" href="#f729">[f729]</a><span class="cd"><span class="i">db</span> <span class="o">"Paladin         "</span></span><span class="ce">; [$f729] char</span></span>
<span class="l"><a class="anc" name="f739" href="#f739">[f739]</a><span class="cd"><span class="i">db</span> <span class="o">"Lord            "</span></span><span class="ce">; [$f739] char</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PLAYER_TITLE_EXP_NEEDED"></a><div class="cp">;============================================================================
; Experience requirements for each title.
;
; XREFS:
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;     <a href="#Player_CheckReachedNextTitle">Player_CheckReachedNextTitle</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;     <a href="#Player_CheckReachedNextTitle">Player_CheckReachedNextTitle</a>
;
</div><span class="l"><a class="anc" name="f749" href="#f749">[f749]</a><a href="#PLAYER_TITLE_EXP_NEEDED" class="la">PLAYER_TITLE_EXP_NEEDED:</a><span class="ce">; [$f749]</span></span>
<span class="l"><a class="anc" name="f749" href="#f749">[f749]</a><span class="cd"><span class="i">dw</span> <span class="o">$03e8</span></span><span class="ce">; [0]: Aspirant (1,000 exp)</span></span>
<span class="l"></span>
<a name="PLAYER_TITLE_EXP_NEEDED_1_"></a><div class="c">;
; XREFS:
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;
</div><span class="l"><a class="anc" name="f74b" href="#f74b">[f74b]</a><a href="#PLAYER_TITLE_EXP_NEEDED_1_" class="la">PLAYER_TITLE_EXP_NEEDED_1_:</a><span class="ce">; [$f74b]</span></span>
<span class="l"><a class="anc" name="f74b" href="#f74b">[f74b]</a><span class="cd"><span class="i">dw</span> <span class="o">$0898</span></span><span class="ce">; [1]: Battler (2,200 exp)</span></span>
<span class="l"><a class="anc" name="f74d" href="#f74d">[f74d]</a><span class="cd"><span class="i">dw</span> <span class="o">$0dac</span></span><span class="ce">; [2]: Fighter (3,500 exp)</span></span>
<span class="l"><a class="anc" name="f74f" href="#f74f">[f74f]</a><span class="cd"><span class="i">dw</span> <span class="o">$12c0</span></span><span class="ce">; [3]: Adept (4,800 exp)</span></span>
<span class="l"><a class="anc" name="f751" href="#f751">[f751]</a><span class="cd"><span class="i">dw</span> <span class="o">$1838</span></span><span class="ce">; [4]: Chevalier (6,200 exp)</span></span>
<span class="l"><a class="anc" name="f753" href="#f753">[f753]</a><span class="cd"><span class="i">dw</span> <span class="o">$1f40</span></span><span class="ce">; [5]: Veteran (8,000 exp)</span></span>
<span class="l"><a class="anc" name="f755" href="#f755">[f755]</a><span class="cd"><span class="i">dw</span> <span class="o">$2710</span></span><span class="ce">; [6]: Warrior (10,000 exp)</span></span>
<span class="l"><a class="anc" name="f757" href="#f757">[f757]</a><span class="cd"><span class="i">dw</span> <span class="o">$30d4</span></span><span class="ce">; [7]: Swordman (12,500 exp)</span></span>
<span class="l"><a class="anc" name="f759" href="#f759">[f759]</a><span class="cd"><span class="i">dw</span> <span class="o">$3a98</span></span><span class="ce">; [8]: Hero (15,000 exp)</span></span>
<span class="l"><a class="anc" name="f75b" href="#f75b">[f75b]</a><span class="cd"><span class="i">dw</span> <span class="o">$4650</span></span><span class="ce">; [9]: Soldier (18,000 exp)</span></span>
<span class="l"><a class="anc" name="f75d" href="#f75d">[f75d]</a><span class="cd"><span class="i">dw</span> <span class="o">$55f0</span></span><span class="ce">; [10]: Myrmidon (22,000 exp)</span></span>
<span class="l"><a class="anc" name="f75f" href="#f75f">[f75f]</a><span class="cd"><span class="i">dw</span> <span class="o">$6590</span></span><span class="ce">; [11]: Champion (26,000 exp)</span></span>
<span class="l"><a class="anc" name="f761" href="#f761">[f761]</a><span class="cd"><span class="i">dw</span> <span class="o">$7530</span></span><span class="ce">; [12]: Superhero (30,000 exp)</span></span>
<span class="l"><a class="anc" name="f763" href="#f763">[f763]</a><span class="cd"><span class="i">dw</span> <span class="o">$88b8</span></span><span class="ce">; [13]: Paladin (35,000 exp)</span></span>
<span class="l"><a class="anc" name="f765" href="#f765">[f765]</a><span class="cd"><span class="i">dw</span> <span class="o">$afc8</span></span><span class="ce">; [14]: Lord (45,000 exp)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="PLAYER_TITLE_GOLD"></a><div class="cp">;============================================================================
; Starting gold at each player title.
;
; XREFS:
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;
</div><span class="l"><a class="anc" name="f767" href="#f767">[f767]</a><a href="#PLAYER_TITLE_GOLD" class="la">PLAYER_TITLE_GOLD:</a><span class="ce">; [$f767]</span></span>
<span class="l"><a class="anc" name="f767" href="#f767">[f767]</a><span class="cd"><span class="i">dw</span> <span class="o">$01f4</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="f769" href="#f769">[f769]</a><span class="cd"><span class="i">dw</span> <span class="o">$0320</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="f76b" href="#f76b">[f76b]</a><span class="cd"><span class="i">dw</span> <span class="o">$04b0</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="f76d" href="#f76d">[f76d]</a><span class="cd"><span class="i">dw</span> <span class="o">$0640</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="f76f" href="#f76f">[f76f]</a><span class="cd"><span class="i">dw</span> <span class="o">$0834</span></span><span class="ce">; [4]:</span></span>
<span class="l"><a class="anc" name="f771" href="#f771">[f771]</a><span class="cd"><span class="i">dw</span> <span class="o">$0af0</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="f773" href="#f773">[f773]</a><span class="cd"><span class="i">dw</span> <span class="o">$0dac</span></span><span class="ce">; [6]:</span></span>
<span class="l"><a class="anc" name="f775" href="#f775">[f775]</a><span class="cd"><span class="i">dw</span> <span class="o">$10cc</span></span><span class="ce">; [7]:</span></span>
<span class="l"><a class="anc" name="f777" href="#f777">[f777]</a><span class="cd"><span class="i">dw</span> <span class="o">$1450</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="f779" href="#f779">[f779]</a><span class="cd"><span class="i">dw</span> <span class="o">$1838</span></span><span class="ce">; [9]:</span></span>
<span class="l"><a class="anc" name="f77b" href="#f77b">[f77b]</a><span class="cd"><span class="i">dw</span> <span class="o">$1d4c</span></span><span class="ce">; [10]:</span></span>
<span class="l"><a class="anc" name="f77d" href="#f77d">[f77d]</a><span class="cd"><span class="i">dw</span> <span class="o">$2328</span></span><span class="ce">; [11]:</span></span>
<span class="l"><a class="anc" name="f77f" href="#f77f">[f77f]</a><span class="cd"><span class="i">dw</span> <span class="o">$2904</span></span><span class="ce">; [12]:</span></span>
<span class="l"><a class="anc" name="f781" href="#f781">[f781]</a><span class="cd"><span class="i">dw</span> <span class="o">$32c8</span></span><span class="ce">; [13]:</span></span>
<span class="l"><a class="anc" name="f783" href="#f783">[f783]</a><span class="cd"><span class="i">dw</span> <span class="o">$3a98</span></span><span class="ce">; [14]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_GetInventoryIndexForItem"></a><div class="cp">;============================================================================
; Return the inventory for the given item.
;
; This takes an item with inventory bits and returns the
; inventory it resides in as a number between 1-5.
;
; INPUTS:
;     A:
;         The inventory item with inventory bits set.
;
; OUTPUTS:
;     A:
;         The index of the inventory:
;
;         0 = Weapons
;         1 = Armor
;         2 = Shields
;         3 = Magic
;         4 = Special
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_OpenShop">IScriptAction_OpenShop</a>
;     <a href="PRG12.html#Player_AddToInventory">Player_AddToInventory</a>
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;     <a href="PRG12.html#Player_LacksItem">Player_LacksItem</a>
;     <a href="PRG12.html#Player_RemoveItem">Player_RemoveItem</a>
;     <a href="PRG12.html#Shop_GetPlayerHasSelectedItem">Shop_GetPlayerHasSelectedItem</a>
;     <a href="PRG12.html#TextBox_DrawItemName">TextBox_DrawItemName</a>
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;============================================================================
</div><span class="l"><a class="anc" name="f785" href="#f785">[f785]</a><a href="#Player_GetInventoryIndexForItem" class="la">Player_GetInventoryIndexForItem:</a><span class="ce">; [$f785]</span></span>
<span class="l"><a class="anc" name="f785" href="#f785">[f785]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span><span class="ce">; Shift right 5, turning inventory bits into an index.</span></span>
<span class="l"><a class="anc" name="f786" href="#f786">[f786]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f787" href="#f787">[f787]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f788" href="#f788">[f788]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f789" href="#f789">[f789]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f78a" href="#f78a">[f78a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_GetInventoryBitForIndex"></a><div class="cp">;============================================================================
; Convert an inventory index to a bit for an item.
;
; This takes an inventory index and shifts it left 5,
; which turns it into an inventory bitmask that can be
; OR'd with an item ID.
;
; INPUTS:
;     A:
;         The inventory index.
;
;         0 = Weapons
;         1 = Armor
;         2 = Shields
;         3 = Magic
;         4 = Special
;
; OUTPUTS:
;     A:
;         The inventory bitmask.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_ShowSellMenu">IScriptAction_ShowSellMenu</a>
;     <a href="PRG12.html#PlayerMenu_DrawInventoryItems">PlayerMenu_DrawInventoryItems</a>
;     <a href="PRG12.html#PlayerMenu_EquipItem">PlayerMenu_EquipItem</a>
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;============================================================================
</div><span class="l"><a class="anc" name="f78b" href="#f78b">[f78b]</a><a href="#Player_GetInventoryBitForIndex" class="la">Player_GetInventoryBitForIndex:</a><span class="ce">; [$f78b]</span></span>
<span class="l"><a class="anc" name="f78b" href="#f78b">[f78b]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left 5 (here and the next 4 after falling through).</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Math_MultiplyBy16"></a><div class="cp">;============================================================================
; Multiply a value by 16.
;
; This seems to be primarily used for textbox widths.
; 16 is the max width of text in a box.
;
; INPUTS:
;     A:
;         The value to multiply.
;
; OUTPUTS:
;     A:
;         The resulting value.
;
; XREFS:
;     <a href="PRG12.html#Menu_UpdateAndDraw">Menu_UpdateAndDraw</a>
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;     <a href="PRG12.html#PlayerMenu_ShowSubmenu">PlayerMenu_ShowSubmenu</a>
;     <a href="PRG12.html#TextBox_DrawItemName">TextBox_DrawItemName</a>
;     <a href="#TextBox_GetBackingAttributeData">TextBox_GetBackingAttributeData</a>
;============================================================================
</div><span class="l"><a class="anc" name="f78c" href="#f78c">[f78c]</a><a href="#Math_MultiplyBy16" class="la">Math_MultiplyBy16:</a><span class="ce">; [$f78c]</span></span>
<span class="l"><a class="anc" name="f78c" href="#f78c">[f78c]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Shift left 4.</span></span>
<span class="l"><a class="anc" name="f78d" href="#f78d">[f78d]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f78e" href="#f78e">[f78e]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f78f" href="#f78f">[f78f]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f790" href="#f790">[f790]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_GetBackingAttributeData"></a><div class="cp">;============================================================================
; Return the attribute data for a given position in a textbox.
;
; This will load the data from the current area's block attributes.
;
; INPUTS:
;     <a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>:
;         The address of the loaded block attributes data
;         for the screen.
;
;     <a href="RAM.html#CurrentROMBank">CurrentROMBank</a>:
;         The current ROM bank.
;
;     <a href="RAM.html#ScreenBuffer">ScreenBuffer</a>:
;         The loaded screen buffer.
;
;     <a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a>:
;         The X position to load.
;
;     <a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a>:
;         The Y position to load.
;
; OUTPUTS:
;     A:
;         The loaded attribute data.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a>
;     <a href="#Math_MultiplyBy16">Math_MultiplyBy16</a>
;
; XREFS:
;     <a href="PRG12.html#TextBox_GetBackgroundAttributeData">TextBox_GetBackgroundAttributeData</a>
;============================================================================
</div><span class="l"><a class="anc" name="f791" href="#f791">[f791]</a><a href="#TextBox_GetBackingAttributeData" class="la">TextBox_GetBackingAttributeData:</a><span class="ce">; [$f791]</span></span>
<div class="c">;
; Preserve X and Y on the stack.
;
</div><span class="l"><a class="anc" name="f791" href="#f791">[f791]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y</span></span>
<span class="l"><a class="anc" name="f792" href="#f792">[f792]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="f793" href="#f793">[f793]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X</span></span>
<span class="l"><a class="anc" name="f794" href="#f794">[f794]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Preserve the current ROM bank.
;
</div><span class="l"><a class="anc" name="f795" href="#f795">[f795]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = Current ROM bank.</span></span>
<span class="l"><a class="anc" name="f798" href="#f798">[f798]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 3 (area metadata).
;
</div><span class="l"><a class="anc" name="f799" href="#f799">[f799]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span><span class="ce">; X = 3 (Area metadata bank)</span></span>
<span class="l"><a class="anc" name="f79b" href="#f79b">[f79b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Switch to the bank.</span></span>
<span class="l"><a class="anc" name="f79e" href="#f79e">[f79e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span><span class="ce">; A = Tile Y position for the text in the textbox.</span></span>
<span class="l"><a class="anc" name="f7a1" href="#f7a1">[f7a1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Math_MultiplyBy16">Math_MultiplyBy16</a></span></span><span class="ce">; Convert to an index in the block attributes data.</span></span>
<span class="l"><a class="anc" name="f7a4" href="#f7a4">[f7a4]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span><span class="ce">; Keep the upper nibble.</span></span>
<span class="l"><a class="anc" name="f7a6" href="#f7a6">[f7a6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store for the final result.</span></span>
<span class="l"><a class="anc" name="f7a8" href="#f7a8">[f7a8]</a><span class="cd"><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a></span></span><span class="ce">; OR the index with the tile X position for the text.</span></span>
<span class="l"><a class="anc" name="f7ab" href="#f7ab">[f7ab]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="f7ac" href="#f7ac">[f7ac]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$20</span></span><span class="ce">; Subtract 32.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the data attribute from the screen buffer at this index.
;
</div><span class="l"><a class="anc" name="f7ae" href="#f7ae">[f7ae]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (screen buffer lookup index)</span></span>
<span class="l"><a class="anc" name="f7af" href="#f7af">[f7af]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span><span class="ce">; Y = Screen buffer data at the index.</span></span>
<span class="l"><a class="anc" name="f7b2" href="#f7b2">[f7b2]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#CurrentArea_BlockAttributesAddr">CurrentArea_BlockAttributesAddr</a>),Y</span></span><span class="ce">; Load the block attributes at the given offset.</span></span>
<span class="l"><a class="anc" name="f7b4" href="#f7b4">[f7b4]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#textBox_GetAreaBehindTextBox_restoreAndReturn">textBox_GetAreaBehindTextBox_restoreAndReturn</a></span></span><span class="ce">; Jump to finish loading.</span></span>
<span class="l"></span>
</pre><pre><a name="Textbox_Maybe_GetAreaBehindTextbox"></a><div class="cp">;============================================================================
; TODO: Document Textbox_Maybe_GetAreaBehindTextbox
;
; INPUTS:
;     Y
;
; OUTPUTS:
;     A
;
; XREFS:
;     <a href="PRG12.html#TextBox_Close">TextBox_Close</a>
;============================================================================
</div><span class="l"><a class="anc" name="f7b7" href="#f7b7">[f7b7]</a><a href="#Textbox_Maybe_GetAreaBehindTextbox" class="la">Textbox_Maybe_GetAreaBehindTextbox:</a><span class="ce">; [$f7b7]</span></span>
<span class="l"><a class="anc" name="f7b7" href="#f7b7">[f7b7]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="f7b8" href="#f7b8">[f7b8]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f7b9" href="#f7b9">[f7b9]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="f7ba" href="#f7ba">[f7ba]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f7bb" href="#f7bb">[f7bb]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f7be" href="#f7be">[f7be]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f7bf" href="#f7bf">[f7bf]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="f7c1" href="#f7c1">[f7c1]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f7c4" href="#f7c4">[f7c4]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span></span>
<span class="l"><a class="anc" name="f7c7" href="#f7c7">[f7c7]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f7c8" href="#f7c8">[f7c8]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f7c9" href="#f7c9">[f7c9]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f7ca" href="#f7ca">[f7ca]</a><span class="cd"><span class="i">AND</span> <span class="o">#$f0</span></span></span>
<span class="l"><a class="anc" name="f7cc" href="#f7cc">[f7cc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f7ce" href="#f7ce">[f7ce]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a></span></span></span>
<span class="l"><a class="anc" name="f7d1" href="#f7d1">[f7d1]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f7d2" href="#f7d2">[f7d2]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f7d4" href="#f7d4">[f7d4]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="f7d5" href="#f7d5">[f7d5]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f7d7" href="#f7d7">[f7d7]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="f7d8" href="#f7d8">[f7d8]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#ScreenBuffer">ScreenBuffer</a>,X</span></span></span>
<span class="l"><a class="anc" name="f7db" href="#f7db">[f7db]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a></span></span></span>
<span class="l"><a class="anc" name="f7de" href="#f7de">[f7de]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span></span>
<span class="l"><a class="anc" name="f7e0" href="#f7e0">[f7e0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f7e2" href="#f7e2">[f7e2]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span></span>
<span class="l"><a class="anc" name="f7e5" href="#f7e5">[f7e5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f7e6" href="#f7e6">[f7e6]</a><span class="cd"><span class="i">AND</span> <span class="o">#$02</span></span></span>
<span class="l"><a class="anc" name="f7e8" href="#f7e8">[f7e8]</a><span class="cd"><span class="i">ORA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f7ea" href="#f7ea">[f7ea]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f7eb" href="#f7eb">[f7eb]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="f7ec" href="#f7ec">[f7ec]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>,X</span></span></span>
<span class="l"><a class="anc" name="f7ee" href="#f7ee">[f7ee]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f7f0" href="#f7f0">[f7f0]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#CurrentArea_BlockData1StartAddr">CurrentArea_BlockData1StartAddr</a>+1,X</span></span></span>
<span class="l"><a class="anc" name="f7f2" href="#f7f2">[f7f2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="f7f4" href="#f7f4">[f7f4]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"></span>
<a name="textBox_GetAreaBehindTextBox_restoreAndReturn"></a><div class="c">;
; XREFS:
;     <a href="#TextBox_GetBackingAttributeData">TextBox_GetBackingAttributeData</a>
;
</div><span class="l"><a class="anc" name="f7f6" href="#f7f6">[f7f6]</a><a href="#textBox_GetAreaBehindTextBox_restoreAndReturn" class="la">textBox_GetAreaBehindTextBox_restoreAndReturn:</a><span class="ce">; [$f7f6]</span></span>
<span class="l"><a class="anc" name="f7f6" href="#f7f6">[f7f6]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store the result temporarily.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the previous ROM bank.
;
</div><span class="l"><a class="anc" name="f7f8" href="#f7f8">[f7f8]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the save ROM bank from the stack.</span></span>
<span class="l"><a class="anc" name="f7f9" href="#f7f9">[f7f9]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A (ROM bank).</span></span>
<span class="l"><a class="anc" name="f7fa" href="#f7fa">[f7fa]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Restore the bank.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the original X and Y registers from the stack.
;
</div><span class="l"><a class="anc" name="f7fd" href="#f7fd">[f7fd]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the original X from the stack.</span></span>
<span class="l"><a class="anc" name="f7fe" href="#f7fe">[f7fe]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; Set back as X.</span></span>
<span class="l"><a class="anc" name="f7ff" href="#f7ff">[f7ff]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the original Y from the stack.</span></span>
<span class="l"><a class="anc" name="f800" href="#f800">[f800]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Set back as Y.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the result we calculated and return it.
;
</div><span class="l"><a class="anc" name="f801" href="#f801">[f801]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Load the calculated result.</span></span>
<span class="l"><a class="anc" name="f803" href="#f803">[f803]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; And return it.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_SetAddrForTextBoxPos"></a><div class="cp">;============================================================================
; Set the PPU address for drawing text.
;
; INPUTS:
;     <a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a>:
;         The screen being drawn into.
;
;     <a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a>:
;         The X position to draw text into.
;
;     <a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a>:
;         The Y position to draw text into.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The target address to draw to.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddInventoryItem_ClearTextBox">IScriptAction_AddInventoryItem_ClearTextBox</a>
;     <a href="PRG12.html#IScripts_FillPlaceholderText">IScripts_FillPlaceholderText</a>
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;     <a href="PRG12.html#PlayerMenu_ShowSubmenu">PlayerMenu_ShowSubmenu</a>
;     <a href="PRG12.html#TextBox_Close">TextBox_Close</a>
;     <a href="PRG12.html#TextBox_DrawItemImage">TextBox_DrawItemImage</a>
;     <a href="PRG12.html#TextBox_DrawItemName">TextBox_DrawItemName</a>
;     <a href="PRG12.html#TextBox_DrawStringLines">TextBox_DrawStringLines</a>
;     <a href="PRG12.html#TextBox_Open">TextBox_Open</a>
;     <a href="#TextBox_DrawZeroPaddedNumber">TextBox_DrawZeroPaddedNumber</a>
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;     <a href="#UI_DrawDigitsNoLeadingZeroes">UI_DrawDigitsNoLeadingZeroes</a>
;============================================================================
</div><span class="l"><a class="anc" name="f804" href="#f804">[f804]</a><a href="#PPU_SetAddrForTextBoxPos" class="la">PPU_SetAddrForTextBoxPos:</a><span class="ce">; [$f804]</span></span>
<span class="l"><a class="anc" name="f804" href="#f804">[f804]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_ScrollScreen">PPU_ScrollScreen</a></span></span><span class="ce">; A = Scroll screen used for drawing.</span></span>
<span class="l"><a class="anc" name="f806" href="#f806">[f806]</a><span class="cd"><span class="i">AND</span> <span class="o">#$01</span></span><span class="ce">; Convert to 0/1 (even/odd).</span></span>
<span class="l"><a class="anc" name="f808" href="#f808">[f808]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$08</span></span><span class="ce">; A += 8</span></span>
<span class="l"><a class="anc" name="f80a" href="#f80a">[f80a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store as the PPU target address.</span></span>
<span class="l"><a class="anc" name="f80c" href="#f80c">[f80c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsY">TextBox_ContentsY</a></span></span><span class="ce">; Load the text Y position.</span></span>
<span class="l"><a class="anc" name="f80f" href="#f80f">[f80f]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A = A * 16</span></span>
<span class="l"><a class="anc" name="f810" href="#f810">[f810]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f811" href="#f811">[f811]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f812" href="#f812">[f812]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="f813" href="#f813">[f813]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Rotate the upper byte of the target address left.</span></span>
<span class="l"><a class="anc" name="f815" href="#f815">[f815]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; A &lt;&lt; 1</span></span>
<span class="l"><a class="anc" name="f816" href="#f816">[f816]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Rotate the upper byte of the target address left.</span></span>
<span class="l"><a class="anc" name="f818" href="#f818">[f818]</a><span class="cd"><span class="i">ORA</span> <span class="o">a:<a href="RAM.html#TextBox_ContentsX">TextBox_ContentsX</a></span></span><span class="ce">; OR it with the X position.</span></span>
<span class="l"><a class="anc" name="f81b" href="#f81b">[f81b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store as the lower byte of the target address.</span></span>
<span class="l"><a class="anc" name="f81d" href="#f81d">[f81d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_IncrementAddrBy16"></a><div class="cp">;============================================================================
; Increment the PPU target address by 16.
;
; INPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The updated PPU target address.
;
; XREFS:
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a class="anc" name="f81e" href="#f81e">[f81e]</a><a href="#PPU_IncrementAddrBy16" class="la">PPU_IncrementAddrBy16:</a><span class="ce">; [$f81e]</span></span>
<span class="l"><a class="anc" name="f81e" href="#f81e">[f81e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span><span class="ce">; A = 16</span></span>
<span class="l"><a class="anc" name="f820" href="#f820">[f820]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a></span></span><span class="ce">; Unconditionally jump to <a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a>.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_IncrementAddrBy8"></a><div class="cp">;============================================================================
; Increment the PPU target address by 8.
;
; INPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The updated PPU target address.
;
; XREFS:
;     <a href="PRG12.html#TextBox_FillBackground">TextBox_FillBackground</a>
;============================================================================
</div><span class="l"><a class="anc" name="f822" href="#f822">[f822]</a><a href="#PPU_IncrementAddrBy8" class="la">PPU_IncrementAddrBy8:</a><span class="ce">; [$f822]</span></span>
<span class="l"><a class="anc" name="f822" href="#f822">[f822]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span><span class="ce">; A = 8</span></span>
<span class="l"><a class="anc" name="f824" href="#f824">[f824]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a></span></span><span class="ce">; Unconditionally jump to <a href="#PPU_IncrementAddrBy">PPU_IncrementAddrBy</a>.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_IncrementAddrBy32"></a><div class="cp">;============================================================================
; Increment the PPU target address by 32.
;
; INPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The updated PPU target address.
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddInventoryItem_ClearTextBox">IScriptAction_AddInventoryItem_ClearTextBox</a>
;     <a href="PRG12.html#TextBox_Close">TextBox_Close</a>
;     <a href="PRG12.html#TextBox_DrawItemImage">TextBox_DrawItemImage</a>
;     <a href="PRG12.html#TextBox_Open">TextBox_Open</a>
;     <a href="#TextBox_ClearTextTiles">TextBox_ClearTextTiles</a>
;     <a href="#TextBox_FillPlaceholderTextAtLineWithStartChar">TextBox_FillPlaceholderTextAtLineWithStartChar</a>
;============================================================================
</div><span class="l"><a class="anc" name="f826" href="#f826">[f826]</a><a href="#PPU_IncrementAddrBy32" class="la">PPU_IncrementAddrBy32:</a><span class="ce">; [$f826]</span></span>
<span class="l"><a class="anc" name="f826" href="#f826">[f826]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span><span class="ce">; Set the offset to 32.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_IncrementAddrBy"></a><div class="cp">;============================================================================
; Increment the PPU target address by a specified amount.
;
; INPUTS:
;     A:
;         The amount to increment by.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The existing PPU target address.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The updated PPU target address.
;
; XREFS:
;     <a href="PRG12.html#TextBox_DrawStringLines">TextBox_DrawStringLines</a>
;     <a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a>
;     <a href="#PPU_IncrementAddrBy8">PPU_IncrementAddrBy8</a>
;============================================================================
</div><span class="l"><a class="anc" name="f828" href="#f828">[f828]</a><a href="#PPU_IncrementAddrBy" class="la">PPU_IncrementAddrBy:</a><span class="ce">; [$f828]</span></span>
<span class="l"><a class="anc" name="f828" href="#f828">[f828]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f829" href="#f829">[f829]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; A += PPU_TargetAddr</span></span>
<span class="l"><a class="anc" name="f82b" href="#f82b">[f82b]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_storeAndReturn">@_storeAndReturn</a></span></span><span class="ce">; If it overflowed, jump. No need to increment the upper byte.</span></span>
<span class="l"><a class="anc" name="f82d" href="#f82d">[f82d]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Else, increment the upper byte by 1.</span></span>
<span class="l"></span>
<a name=":f82f:@_storeAndReturn"></a><span class="l"><a class="anc" name="f82f" href="#f82f">[f82f]</a><a href="#:f82f:@_storeAndReturn" class="lla">@_storeAndReturn:</a><span class="ce">; [$f82f]</span></span>
<span class="l"><a class="anc" name="f82f" href="#f82f">[f82f]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set the new target address.</span></span>
<span class="l"><a class="anc" name="f831" href="#f831">[f831]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_QueuePPUBufferTextBoxLength"></a><div class="cp">;============================================================================
; Queue a write to the PPU buffer for the textbox width.
;
; INPUTS:
;     <a href="RAM.html#TextBox_Width">TextBox_Width</a>:
;         The width of the textbox.
;
; OUTPUTS:
;     Y:
;         The textbox width.
;
; CALLS:
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;
; XREFS:
;     <a href="PRG12.html#TextBox_Open">TextBox_Open</a>
;============================================================================
</div><span class="l"><a class="anc" name="f832" href="#f832">[f832]</a><a href="#TextBox_QueuePPUBufferTextBoxLength" class="la">TextBox_QueuePPUBufferTextBoxLength:</a><span class="ce">; [$f832]</span></span>
<span class="l"><a class="anc" name="f832" href="#f832">[f832]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#TextBox_Width">TextBox_Width</a></span></span><span class="ce">; A = Textbox width</span></span>
<span class="l"><a class="anc" name="f835" href="#f835">[f835]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="f836" href="#f836">[f836]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Queue as the length.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_FillPPUBufferForTextWidth"></a><div class="cp">;============================================================================
; Fill a line of text within a textbox with a value.
;
; This will write to the PPU buffer for a given width. The
; width is expected to be at the last text position within
; the textbox. It will stop before it hits the padding
; before the text on the line.
;
; INPUTS:
;     A:
;         The value to write.
;
;     X:
;         The offset to write to.
;
;     Y:
;         The text position (+ 2).
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddInventoryItem_ClearTextBox">IScriptAction_AddInventoryItem_ClearTextBox</a>
;     <a href="PRG12.html#TextBox_Open">TextBox_Open</a>
;     <a href="#TextBox_FillPPUBufferForTextWidth">TextBox_FillPPUBufferForTextWidth</a>
;============================================================================
</div><span class="l"><a class="anc" name="f839" href="#f839">[f839]</a><a href="#TextBox_FillPPUBufferForTextWidth" class="la">TextBox_FillPPUBufferForTextWidth:</a><span class="ce">; [$f839]</span></span>
<span class="l"><a class="anc" name="f839" href="#f839">[f839]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span><span class="ce">; Set the value in the buffer at the given offset.</span></span>
<span class="l"><a class="anc" name="f83c" href="#f83c">[f83c]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="f83d" href="#f83d">[f83d]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$02</span></span><span class="ce">; Is it 2?</span></span>
<span class="l"><a class="anc" name="f83f" href="#f83f">[f83f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#TextBox_FillPPUBufferForTextWidth">TextBox_FillPPUBufferForTextWidth</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="f841" href="#f841">[f841]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_WriteFromTemp"></a><div class="cp">;============================================================================
; Write a value from a temp location to the PPU buffer.
;
; This will load a byte from <a href="RAM.html#Temp_Int24">Temp_Int24</a> and write
; it to the PPU buffer. The source offset will be
; advanced by 1.
;
; INPUTS:
;     X:
;         The destination index within the PPU buffer.
;
;     Y:
;         The offset from the address to load from.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The location of the address to load from.
;
; OUTPUTS:
;     X:
;         The new offset to write to (X + 1).
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_DrawMessage">PasswordScreen_DrawMessage</a>
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;     <a href="#TextBox_Write8BytesFromTemp">TextBox_Write8BytesFromTemp</a>
;============================================================================
</div><span class="l"><a class="anc" name="f842" href="#f842">[f842]</a><a href="#PPUBuffer_WriteFromTemp" class="la">PPUBuffer_WriteFromTemp:</a><span class="ce">; [$f842]</span></span>
<span class="l"><a class="anc" name="f842" href="#f842">[f842]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; Load the value from <a href="RAM.html#Temp_Int24">Temp_Int24</a> at offset Y.</span></span>
<span class="l"><a class="anc" name="f844" href="#f844">[f844]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_Set"></a><div class="cp">;============================================================================
; Write a value to the PPU buffer.
;
; This will write the value and then increment the offset.
;
; INPUTS:
;     A:
;         The value to write.
;
;     X:
;         The offset at which to write the buffer.
;
; OUTPUTS:
;     X:
;         The new offset to write to (X + 1).
;
;     <a href="RAM.html#PPUBuffer">PPUBuffer</a>:
;         The PPU buffer to write to.
;
; XREFS:
;     <a href="PRG12.html#DEADCODE_FUN_PRG12__9041">DEADCODE_FUN_PRG12__9041</a>
;     <a href="PRG12.html#PasswordScreen_WriteCharTile">PasswordScreen_WriteCharTile</a>
;     <a href="PRG12.html#TextBox_Close">TextBox_Close</a>
;     <a href="PRG12.html#TextBox_DrawItemImage">TextBox_DrawItemImage</a>
;     <a href="PRG12.html#TextBox_FillBackground">TextBox_FillBackground</a>
;     <a href="PRG12.html#TextBox_Open">TextBox_Open</a>
;     <a href="PRG12.html#UI_DrawString">UI_DrawString</a>
;     <a href="#PPUBuffer_WriteValueMany">PPUBuffer_WriteValueMany</a>
;     <a href="#TextBox_FillPPUBufferForTextWidth">TextBox_FillPPUBufferForTextWidth</a>
;     <a href="#TextBox_FillPlaceholderTextAtLineWithStartChar">TextBox_FillPlaceholderTextAtLineWithStartChar</a>
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;============================================================================
</div><span class="l"><a class="anc" name="f845" href="#f845">[f845]</a><a href="#PPUBuffer_Set" class="la">PPUBuffer_Set:</a><span class="ce">; [$f845]</span></span>
<span class="l"><a class="anc" name="f845" href="#f845">[f845]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPUBuffer">PPUBuffer</a>,X</span></span><span class="ce">; Store A in the PPU buffer at X.</span></span>
<span class="l"><a class="anc" name="f848" href="#f848">[f848]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X++</span></span>
<span class="l"><a class="anc" name="f849" href="#f849">[f849]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPUBuffer_WriteValueMany"></a><div class="cp">;============================================================================
; Write a value many types to the PPU buffer.
;
; This will write the provided value the specified number
; of times, starting at a given offset.
;
; The first byte written will be the length, and the
; remaining bytes will be the provided value repeated.
;
; INPUTS:
;     A:
;         The value to write.
;
;     Y:
;         The number of times to write the value.
;
; OUTPUTS:
;     X:
;         The new offset in the buffer after these values.
;
; XREFS:
;     <a href="#TextBox_ClearTextTiles">TextBox_ClearTextTiles</a>
;     <a href="#TextBox_ShowMessage_Fill4Lines">TextBox_ShowMessage_Fill4Lines</a>
;============================================================================
</div><span class="l"><a class="anc" name="f84a" href="#f84a">[f84a]</a><a href="#PPUBuffer_WriteValueMany" class="la">PPUBuffer_WriteValueMany:</a><span class="ce">; [$f84a]</span></span>
<span class="l"><a class="anc" name="f84a" href="#f84a">[f84a]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to the stack</span></span>
<span class="l"><a class="anc" name="f84b" href="#f84b">[f84b]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (length)</span></span>
<span class="l"><a class="anc" name="f84c" href="#f84c">[f84c]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Write the length to the buffer.</span></span>
<span class="l"><a class="anc" name="f84f" href="#f84f">[f84f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A from the stack</span></span>
<span class="l"></span>
<a name=":f850:@_loop"></a><span class="l"><a class="anc" name="f850" href="#f850">[f850]</a><a href="#:f850:@_loop" class="lla">@_loop:</a><span class="ce">; [$f850]</span></span>
<span class="l"><a class="anc" name="f850" href="#f850">[f850]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span><span class="ce">; Set the value in the PPU buffer.</span></span>
<span class="l"><a class="anc" name="f853" href="#f853">[f853]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="f854" href="#f854">[f854]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If Y &gt; 0, loop</span></span>
<span class="l"><a class="anc" name="f856" href="#f856">[f856]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Set the upper bounds to write.</span></span>
<span class="l"><a class="anc" name="f858" href="#f858">[f858]</a><span class="cd"><span class="i">RTS</span></span><span class="ce">; Return with the new offset.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="MMC1_LoadBankAndJump"></a><div class="cp">;============================================================================
; Performs a "Far JSR" to a code in another PRG bank.
;
; This takes in a bank in a the address within the bank (as
; an upper byte and a lower byte) from the next three bytes
; following this call. Specifically, it:
;
; 1. Steals the JSR return address off the stack to locate
;    the inline data.
;
; 2. Rewrites the return address so RTS will skip past the
;    3 data bytes.
;
; 3. Reads the inline bytes via (<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y to
;    get the bank/target.
;
; 4. Switches to the bank.
;
; 5. Pushes a trampoline address ($C5F8) and the target
;    address so that RTS returns into the trampoline, which
;    then JSRs to the target and later restores the original
;    bank before returning to the caller.
;
; This is notably used for invoking IScripts.
;
; INPUTS:
;     A:
;         The bank, upper address byte, and lower address
;         byte in stack order.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG14.html#Player_CheckHandlePressUpOnNPC">Player_CheckHandlePressUpOnNPC</a>
;     <a href="PRG14.html#Player_HandleTouchNPC">Player_HandleTouchNPC</a>
;     <a href="#GameLoop_CheckShowPlayerMenu">GameLoop_CheckShowPlayerMenu</a>
;     <a href="#Game_DecGloveDuration">Game_DecGloveDuration</a>
;     <a href="#Game_DecHourGlassDuration">Game_DecHourGlassDuration</a>
;     <a href="#Game_DecOintmentDuration">Game_DecOintmentDuration</a>
;     <a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a>
;     <a href="#Game_OpenDoorWithAKey">Game_OpenDoorWithAKey</a>
;     <a href="#Game_OpenDoorWithDemonsRing">Game_OpenDoorWithDemonsRing</a>
;     <a href="#Game_OpenDoorWithJKey">Game_OpenDoorWithJKey</a>
;     <a href="#Game_OpenDoorWithJoKey">Game_OpenDoorWithJoKey</a>
;     <a href="#Game_OpenDoorWithKKey">Game_OpenDoorWithKKey</a>
;     <a href="#Game_OpenDoorWithQKey">Game_OpenDoorWithQKey</a>
;     <a href="#Game_OpenDoorWithRingOfDworf">Game_OpenDoorWithRingOfDworf</a>
;     <a href="#Game_OpenDoorWithRingOfElf">Game_OpenDoorWithRingOfElf</a>
;     <a href="#Game_ShowStartScreen">Game_ShowStartScreen</a>
;     <a href="#Game_UnlockDoorWithUsableItem">Game_UnlockDoorWithUsableItem</a>
;     <a href="#IScripts_ClearPortraitImage">IScripts_ClearPortraitImage</a>
;     <a href="#Player_HandleDeath">Player_HandleDeath</a>
;     <a href="#Player_PickUpBattleHelmet">Player_PickUpBattleHelmet</a>
;     <a href="#Player_PickUpBattleSuit">Player_PickUpBattleSuit</a>
;     <a href="#Player_PickUpBlackOnyx">Player_PickUpBlackOnyx</a>
;     <a href="#Player_PickUpDragonSlayer">Player_PickUpDragonSlayer</a>
;     <a href="#Player_PickUpElixir">Player_PickUpElixir</a>
;     <a href="#Player_PickUpGlove">Player_PickUpGlove</a>
;     <a href="#Player_PickUpHourGlass">Player_PickUpHourGlass</a>
;     <a href="#Player_PickUpMagicalRod">Player_PickUpMagicalRod</a>
;     <a href="#Player_PickUpMattock">Player_PickUpMattock</a>
;     <a href="#Player_PickUpOintment">Player_PickUpOintment</a>
;     <a href="#Player_PickUpPendant">Player_PickUpPendant</a>
;     <a href="#Player_PickUpPoison">Player_PickUpPoison</a>
;     <a href="#Player_PickUpRedPotion">Player_PickUpRedPotion</a>
;     <a href="#Player_PickUpWingBoots">Player_PickUpWingBoots</a>
;     <a href="#Player_UseElixir">Player_UseElixir</a>
;     <a href="#Player_UseHourGlass">Player_UseHourGlass</a>
;     <a href="#Player_UseMattock">Player_UseMattock</a>
;     <a href="#Player_UseRedPotion">Player_UseRedPotion</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;============================================================================
</div><span class="l"><a class="anc" name="f859" href="#f859">[f859]</a><a href="#MMC1_LoadBankAndJump" class="la">MMC1_LoadBankAndJump:</a><span class="ce">; [$f859]</span></span>
<div class="c">;
; Save out the X, Y, and Z values to temporary variables.
;
</div><span class="l"><a class="anc" name="f859" href="#f859">[f859]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a></span></span><span class="ce">; Set <a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a> = A</span></span>
<span class="l"><a class="anc" name="f85b" href="#f85b">[f85b]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a></span></span><span class="ce">; Set <a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a> = X</span></span>
<span class="l"><a class="anc" name="f85d" href="#f85d">[f85d]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a></span></span><span class="ce">; Set <a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a> = Y</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Pop two bytes of A from the stack and transfer to the lower
; and middle bytes (in order) of <a href="RAM.html#Temp_Int24">Temp_Int24</a>.
;
</div><span class="l"><a class="anc" name="f85f" href="#f85f">[f85f]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pop A from the stack.</span></span>
<span class="l"><a class="anc" name="f860" href="#f860">[f860]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Lower byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"><a class="anc" name="f862" href="#f862">[f862]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull A from the stack.</span></span>
<span class="l"><a class="anc" name="f863" href="#f863">[f863]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Middle byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Save A to X. We'll increment this below if we overflow
; the add.
;
</div><span class="l"><a class="anc" name="f865" href="#f865">[f865]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Compute a new return low = <a href="RAM.html#Temp_Int24">Temp_Int24</a>.L + 3.
;
</div><span class="l"><a class="anc" name="f866" href="#f866">[f866]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; A = lower byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a>.</span></span>
<span class="l"><a class="anc" name="f868" href="#f868">[f868]</a><span class="cd"><span class="i">CLC</span></span><span class="ce">; C = 0</span></span>
<span class="l"><a class="anc" name="f869" href="#f869">[f869]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$03</span></span><span class="ce">; A = A + 3</span></span>
<span class="l"><a class="anc" name="f86b" href="#f86b">[f86b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; Upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If the upper byte overflowed, increment X.
;
</div><span class="l"><a class="anc" name="f86d" href="#f86d">[f86d]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_storeCurrentAddress">@_storeCurrentAddress</a></span></span><span class="ce">; If carry is cleared, jump.</span></span>
<span class="l"><a class="anc" name="f86f" href="#f86f">[f86f]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; X = X + 1</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f870:@_storeCurrentAddress"></a><div class="c">;
; Preserve the target address and ROM bank on the stack.
;
</div><span class="l"><a class="anc" name="f870" href="#f870">[f870]</a><a href="#:f870:@_storeCurrentAddress" class="lla">@_storeCurrentAddress:</a><span class="ce">; [$f870]</span></span>
<span class="l"><a class="anc" name="f870" href="#f870">[f870]</a><span class="cd"><span class="i">TXA</span></span><span class="ce">; A = X (our adjusted offset)</span></span>
<span class="l"><a class="anc" name="f871" href="#f871">[f871]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><a class="anc" name="f872" href="#f872">[f872]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; A = upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span>
<span class="l"><a class="anc" name="f874" href="#f874">[f874]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><a class="anc" name="f875" href="#f875">[f875]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span><span class="ce">; A = <a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span>
<span class="l"><a class="anc" name="f878" href="#f878">[f878]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store the loaded address and bank to jump to.
;
</div><span class="l"><a class="anc" name="f879" href="#f879">[f879]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$03</span></span><span class="ce">; Y = 3</span></span>
<span class="l"><a class="anc" name="f87b" href="#f87b">[f87b]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Upper byte of the address to jump to.</span></span>
<span class="l"><a class="anc" name="f87d" href="#f87d">[f87d]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span><span class="ce">; <a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a> = A</span></span>
<span class="l"><a class="anc" name="f87f" href="#f87f">[f87f]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y-- (2)</span></span>
<span class="l"><a class="anc" name="f880" href="#f880">[f880]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Lower byte of the address to jump to.</span></span>
<span class="l"><a class="anc" name="f882" href="#f882">[f882]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; Upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a> = A</span></span>
<span class="l"><a class="anc" name="f884" href="#f884">[f884]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y-- (1)</span></span>
<span class="l"><a class="anc" name="f885" href="#f885">[f885]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span><span class="ce">; A = Bank to load</span></span>
<span class="l"><a class="anc" name="f887" href="#f887">[f887]</a><span class="cd"><span class="i">TAX</span></span><span class="ce">; X = A</span></span>
<span class="l"><a class="anc" name="f888" href="#f888">[f888]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span><span class="ce">; Update the ROM bank to X.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Push the trampoline address $C5F8.
;
</div><span class="l"><a class="anc" name="f88b" href="#f88b">[f88b]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$f8</span></span><span class="ce">; A = 0xF8</span></span>
<span class="l"><a class="anc" name="f88d" href="#f88d">[f88d]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><a class="anc" name="f88e" href="#f88e">[f88e]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c5</span></span><span class="ce">; A = 0xC5</span></span>
<span class="l"><a class="anc" name="f890" href="#f890">[f890]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Push the target address for the trampoline.
;
</div><span class="l"><a class="anc" name="f891" href="#f891">[f891]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span><span class="ce">; A = <a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span>
<span class="l"><a class="anc" name="f893" href="#f893">[f893]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"><a class="anc" name="f894" href="#f894">[f894]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; A = upper byte of <a href="RAM.html#Temp_Int24">Temp_Int24</a>.</span></span>
<span class="l"><a class="anc" name="f896" href="#f896">[f896]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push A to stack</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Restore the original values for A, X, and Y.
;
</div><span class="l"><a class="anc" name="f897" href="#f897">[f897]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a></span></span><span class="ce">; A = <a href="RAM.html#BankedCallSetup_SavedA">BankedCallSetup_SavedA</a></span></span>
<span class="l"><a class="anc" name="f899" href="#f899">[f899]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a></span></span><span class="ce">; X = <a href="RAM.html#BankedCallSetup_SavedX">BankedCallSetup_SavedX</a></span></span>
<span class="l"><a class="anc" name="f89b" href="#f89b">[f89b]</a><span class="cd"><span class="i">LDY</span> <span class="o"><a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a></span></span><span class="ce">; Y = <a href="RAM.html#BankedCallSetup_SavedY">BankedCallSetup_SavedY</a></span></span>
<span class="l"><a class="anc" name="f89d" href="#f89d">[f89d]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="PPU_WriteTilesFromCHRRAM"></a><div class="cp">;============================================================================
; TODO: Document PPU_WriteTilesFromCHRRAM
;
; INPUTS:
;     X
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#SplashAnimation_DrawScenery">SplashAnimation_DrawScenery</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;============================================================================
</div><span class="l"><a class="anc" name="f89e" href="#f89e">[f89e]</a><a href="#PPU_WriteTilesFromCHRRAM" class="la">PPU_WriteTilesFromCHRRAM:</a><span class="ce">; [$f89e]</span></span>
<span class="l"><a class="anc" name="f89e" href="#f89e">[f89e]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f8a1" href="#f8a1">[f8a1]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="f8a2" href="#f8a2">[f8a2]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"><a class="anc" name="f8a5" href="#f8a5">[f8a5]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f8a7" href="#f8a7">[f8a7]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="f8a9" href="#f8a9">[f8a9]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="f8ac" href="#f8ac">[f8ac]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="f8ae" href="#f8ae">[f8ae]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="f8b1" href="#f8b1">[f8b1]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":f8b3:@LAB_PRG15_MIRROR__f8b3"></a><span class="l"><a class="anc" name="f8b3" href="#f8b3">[f8b3]</a><a href="#:f8b3:@LAB_PRG15_MIRROR__f8b3" class="lla">@LAB_PRG15_MIRROR__f8b3:</a><span class="ce">; [$f8b3]</span></span>
<span class="l"><a class="anc" name="f8b3" href="#f8b3">[f8b3]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$10</span></span></span>
<span class="l"></span>
<a name=":f8b5:@LAB_PRG15_MIRROR__f8b5"></a><span class="l"><a class="anc" name="f8b5" href="#f8b5">[f8b5]</a><a href="#:f8b5:@LAB_PRG15_MIRROR__f8b5" class="lla">@LAB_PRG15_MIRROR__f8b5:</a><span class="ce">; [$f8b5]</span></span>
<span class="l"><a class="anc" name="f8b5" href="#f8b5">[f8b5]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#IScriptOrCHRAddr">IScriptOrCHRAddr</a>),Y</span></span></span>
<span class="l"><a class="anc" name="f8b7" href="#f8b7">[f8b7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><a class="anc" name="f8ba" href="#f8ba">[f8ba]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="f8bb" href="#f8bb">[f8bb]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f8bf">@LAB_PRG15_MIRROR__f8bf</a></span></span></span>
<span class="l"><a class="anc" name="f8bd" href="#f8bd">[f8bd]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#IScriptOrCHRAddr_U">IScriptOrCHRAddr_U</a></span></span></span>
<span class="l"></span>
<a name=":f8bf:@LAB_PRG15_MIRROR__f8bf"></a><span class="l"><a class="anc" name="f8bf" href="#f8bf">[f8bf]</a><a href="#:f8bf:@LAB_PRG15_MIRROR__f8bf" class="lla">@LAB_PRG15_MIRROR__f8bf:</a><span class="ce">; [$f8bf]</span></span>
<span class="l"><a class="anc" name="f8bf" href="#f8bf">[f8bf]</a><span class="cd"><span class="i">DEX</span></span></span>
<span class="l"><a class="anc" name="f8c0" href="#f8c0">[f8c0]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f8b5">@LAB_PRG15_MIRROR__f8b5</a></span></span></span>
<span class="l"><a class="anc" name="f8c2" href="#f8c2">[f8c2]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f8c4" href="#f8c4">[f8c4]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f8b3">@LAB_PRG15_MIRROR__f8b3</a></span></span></span>
<span class="l"><a class="anc" name="f8c6" href="#f8c6">[f8c6]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="f8c7" href="#f8c7">[f8c7]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="f8c8" href="#f8c8">[f8c8]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name="UI_STATUS_SYMBOL_PPU_ADDR_L"></a><div class="cp">;============================================================================
; PPU address locations where statuc symbols are positioned.
;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;
</div><span class="l"><a class="anc" name="f8cb" href="#f8cb">[f8cb]</a><a href="#UI_STATUS_SYMBOL_PPU_ADDR_L" class="la">UI_STATUS_SYMBOL_PPU_ADDR_L:</a><span class="ce">; [$f8cb]</span></span>
<span class="l"><a class="anc" name="f8cb" href="#f8cb">[f8cb]</a><span class="cd"><span class="i">db</span> <span class="o">$41</span></span><span class="ce">; [0]: 0x2041 -- "M" (Magic)</span></span>
<span class="l"></span>
<a name="UI_STATUS_SYMBOL_PPU_ADDR_L_1_"></a><div class="c">;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;
</div><span class="l"><a class="anc" name="f8cc" href="#f8cc">[f8cc]</a><a href="#UI_STATUS_SYMBOL_PPU_ADDR_L_1_" class="la">UI_STATUS_SYMBOL_PPU_ADDR_L_1_:</a><span class="ce">; [$f8cc]</span></span>
<span class="l"><a class="anc" name="f8cc" href="#f8cc">[f8cc]</a><span class="cd"><span class="i">db</span> <span class="o">$61</span></span><span class="ce">; [1]: 0x2061 -- "P" (Power)</span></span>
<span class="l"><a class="anc" name="f8cd" href="#f8cd">[f8cd]</a><span class="cd"><span class="i">db</span> <span class="o">$6e</span></span><span class="ce">; [2]: 0x206E -- "G" (Gold)</span></span>
<span class="l"><a class="anc" name="f8ce" href="#f8ce">[f8ce]</a><span class="cd"><span class="i">db</span> <span class="o">$4e</span></span><span class="ce">; [3]: 0x204E -- "E" (Experience)</span></span>
<span class="l"><a class="anc" name="f8cf" href="#f8cf">[f8cf]</a><span class="cd"><span class="i">db</span> <span class="o">$56</span></span><span class="ce">; [4]: 0x2056 -- "T" (Time)</span></span>
<span class="l"><a class="anc" name="f8d0" href="#f8d0">[f8d0]</a><span class="cd"><span class="i">db</span> <span class="o">$5b</span></span><span class="ce">; [5]: 0x205B -- Top-left of "[" (Selected item)</span></span>
<span class="l"><a class="anc" name="f8d1" href="#f8d1">[f8d1]</a><span class="cd"><span class="i">db</span> <span class="o">$7b</span></span><span class="ce">; [6]: 0x207B -- Bottom-left of "[" (Selected item)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="UI_STATUS_TILES"></a><div class="cp">;============================================================================
; Tile indexes to display in the status area.
;
; Each of these will be placed horizontally at a start
; location (by <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>).
;
; A 0x00 means to end the run.
;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;============================================================================
</div><span class="l"></span>
<div class="c">;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;
</div><span class="l"><a class="anc" name="f8d2" href="#f8d2">[f8d2]</a><a href="#UI_STATUS_TILES" class="la">UI_STATUS_TILES:</a><span class="ce">; [$f8d2]</span></span>
<span class="l"><a class="anc" name="f8d2" href="#f8d2">[f8d2]</a><span class="cd"><span class="i">db</span> <span class="o">$1c</span></span><span class="ce">; [0]: "M" (Magic)</span></span>
<span class="l"></span>
<a name="UI_STATUS_TILES_1_"></a><div class="c">;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;
</div><span class="l"><a class="anc" name="f8d3" href="#f8d3">[f8d3]</a><a href="#UI_STATUS_TILES_1_" class="la">UI_STATUS_TILES_1_:</a><span class="ce">; [$f8d3]</span></span>
<span class="l"><a class="anc" name="f8d3" href="#f8d3">[f8d3]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [1]: ":"</span></span>
<span class="l"></span>
<a name="UI_STATUS_TILES_2_"></a><div class="c">;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;
</div><span class="l"><a class="anc" name="f8d4" href="#f8d4">[f8d4]</a><a href="#UI_STATUS_TILES_2_" class="la">UI_STATUS_TILES_2_:</a><span class="ce">; [$f8d4]</span></span>
<span class="l"><a class="anc" name="f8d4" href="#f8d4">[f8d4]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="f8d5" href="#f8d5">[f8d5]</a><span class="cd"><span class="i">db</span> <span class="o">$1f</span></span><span class="ce">; [3]: "P" (Power)</span></span>
<span class="l"><a class="anc" name="f8d6" href="#f8d6">[f8d6]</a><span class="cd"><span class="i">db</span> <span class="o">$0a</span></span><span class="ce">; [4]: ":"</span></span>
<span class="l"><a class="anc" name="f8d7" href="#f8d7">[f8d7]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [5]:</span></span>
<span class="l"><a class="anc" name="f8d8" href="#f8d8">[f8d8]</a><span class="cd"><span class="i">db</span> <span class="o">$16</span></span><span class="ce">; [6]: "G" (Gold)</span></span>
<span class="l"><a class="anc" name="f8d9" href="#f8d9">[f8d9]</a><span class="cd"><span class="i">db</span> <span class="o">$3a</span></span><span class="ce">; [7]: ":"</span></span>
<span class="l"><a class="anc" name="f8da" href="#f8da">[f8da]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [8]:</span></span>
<span class="l"><a class="anc" name="f8db" href="#f8db">[f8db]</a><span class="cd"><span class="i">db</span> <span class="o">$14</span></span><span class="ce">; [9]: "E" (Experience)</span></span>
<span class="l"><a class="anc" name="f8dc" href="#f8dc">[f8dc]</a><span class="cd"><span class="i">db</span> <span class="o">$3a</span></span><span class="ce">; [10]: ":"</span></span>
<span class="l"><a class="anc" name="f8dd" href="#f8dd">[f8dd]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [11]:</span></span>
<span class="l"><a class="anc" name="f8de" href="#f8de">[f8de]</a><span class="cd"><span class="i">db</span> <span class="o">$23</span></span><span class="ce">; [12]: "T" (Time)</span></span>
<span class="l"><a class="anc" name="f8df" href="#f8df">[f8df]</a><span class="cd"><span class="i">db</span> <span class="o">$3a</span></span><span class="ce">; [13]: ":"</span></span>
<span class="l"><a class="anc" name="f8e0" href="#f8e0">[f8e0]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [14]:</span></span>
<span class="l"><a class="anc" name="f8e1" href="#f8e1">[f8e1]</a><span class="cd"><span class="i">db</span> <span class="o">$2c</span></span><span class="ce">; [15]: Top of "[" (current item)</span></span>
<span class="l"><a class="anc" name="f8e2" href="#f8e2">[f8e2]</a><span class="cd"><span class="i">db</span> <span class="o">$3c</span></span><span class="ce">; [16]: &lt;blank space&gt;</span></span>
<span class="l"><a class="anc" name="f8e3" href="#f8e3">[f8e3]</a><span class="cd"><span class="i">db</span> <span class="o">$3d</span></span><span class="ce">; [17]: &lt;blank space&gt;</span></span>
<span class="l"><a class="anc" name="f8e4" href="#f8e4">[f8e4]</a><span class="cd"><span class="i">db</span> <span class="o">$2e</span></span><span class="ce">; [18]: Top of "]" (current item)</span></span>
<span class="l"><a class="anc" name="f8e5" href="#f8e5">[f8e5]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [19]:</span></span>
<span class="l"><a class="anc" name="f8e6" href="#f8e6">[f8e6]</a><span class="cd"><span class="i">db</span> <span class="o">$2d</span></span><span class="ce">; [20]: Bottom of "[" (current item)</span></span>
<span class="l"><a class="anc" name="f8e7" href="#f8e7">[f8e7]</a><span class="cd"><span class="i">db</span> <span class="o">$3e</span></span><span class="ce">; [21]: &lt;blank space&gt;</span></span>
<span class="l"><a class="anc" name="f8e8" href="#f8e8">[f8e8]</a><span class="cd"><span class="i">db</span> <span class="o">$3f</span></span><span class="ce">; [22]: &lt;blank space&gt;</span></span>
<span class="l"><a class="anc" name="f8e9" href="#f8e9">[f8e9]</a><span class="cd"><span class="i">db</span> <span class="o">$2f</span></span><span class="ce">; [23]: Bottom of "]" (current item)</span></span>
<span class="l"><a class="anc" name="f8ea" href="#f8ea">[f8ea]</a><span class="cd"><span class="i">db</span> <span class="o">$00</span></span><span class="ce">; [24]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawHUDSprites"></a><div class="cp">;============================================================================
; Draw the status symbols on the screen.
;
; This will draw the following:
;
;     "P" (Power)
;     "M" (Magic)
;     "E" (Experience)
;     "G" (Gold)
;     "T" (Time)
;     Parts of "[ ]" for item selection
;
; It will also draw the selected item.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="#Screen_SetupNew">Screen_SetupNew</a>
;============================================================================
</div><span class="l"><a class="anc" name="f8eb" href="#f8eb">[f8eb]</a><a href="#UI_DrawHUDSprites" class="la">UI_DrawHUDSprites:</a><span class="ce">; [$f8eb]</span></span>
<span class="l"><a class="anc" name="f8eb" href="#f8eb">[f8eb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="f8ed" href="#f8ed">[f8ed]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#UI_MPAndHPBarWidth">UI_MPAndHPBarWidth</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Fill the entire status area with 0 (blank).
; This is 4 rows of tiles.
;
</div><span class="l"><a class="anc" name="f8f0" href="#f8f0">[f8f0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span><span class="ce">; Set the upper byte for the draw position.</span></span>
<span class="l"><a class="anc" name="f8f2" href="#f8f2">[f8f2]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f8f5" href="#f8f5">[f8f5]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Set the lower byte for the draw position.</span></span>
<span class="l"><a class="anc" name="f8f7" href="#f8f7">[f8f7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store it.</span></span>
<span class="l"><a class="anc" name="f8fa" href="#f8fa">[f8fa]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$80</span></span><span class="ce">; Set Y = 128 (number of tiles to draw)</span></span>
<span class="l"><a class="anc" name="f8fc" href="#f8fc">[f8fc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Set the value to draw (blank tile).</span></span>
<span class="l"><a class="anc" name="f8fe" href="#f8fe">[f8fe]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span><span class="ce">; Clear all 128 tiles.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare to draw the symbols.
;
; This will loop through all positions, and then all tiles
; for that position. These are done as two separate lookup
; tables:
;
; 1. <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>: The lower
; addresses
;    of the PPU draw positions for placing each set of tiles.
;
;    This is incremented by 1 every time we finish placing tiles
;    for that area.
;
; 2. <a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>: The tiles to draw at the
; current
;
;    Each run of tiles terminates with a 0x00. The next index would
;    then match the next position. This is incremented by 1 every
;    time we place a tile.
;
</div><span class="l"><a class="anc" name="f901" href="#f901">[f901]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span><span class="ce">; Set X = 0 (start index in <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>.</span></span>
<span class="l"><a class="anc" name="f903" href="#f903">[f903]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span><span class="ce">; Set Y = 0 (start index at <a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f905:@_goToNextPosition"></a><div class="c">;
; Set the PPUADDR to $20XX, where XX comes from the
; <a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a> lookup table.
;
; Each of these will be the location of a static symbol
; to show in the status area.
;
</div><span class="l"><a class="anc" name="f905" href="#f905">[f905]</a><a href="#:f905:@_goToNextPosition" class="lla">@_goToNextPosition:</a><span class="ce">; [$f905]</span></span>
<span class="l"><a class="anc" name="f905" href="#f905">[f905]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f907" href="#f907">[f907]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store the upper draw position byte as 0x20.</span></span>
<span class="l"><a class="anc" name="f90a" href="#f90a">[f90a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#UI_STATUS_SYMBOL_PPU_ADDR_L">UI_STATUS_SYMBOL_PPU_ADDR_L</a>,X</span></span><span class="ce">; Load the lower byte from the lookup table based on the index.</span></span>
<span class="l"><a class="anc" name="f90d" href="#f90d">[f90d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span><span class="ce">; Store it as the lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f910:@_drawTiles"></a><div class="c">;
; Lay out tiles for UI elements starting at the current symbol
; address.
;
; This will write data from the <a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>
; table
; until it hits an end market (0x00).
;
; This is generally 2-4 tiles per address.
;
</div><span class="l"><a class="anc" name="f910" href="#f910">[f910]</a><a href="#:f910:@_drawTiles" class="lla">@_drawTiles:</a><span class="ce">; [$f910]</span></span>
<span class="l"><a class="anc" name="f910" href="#f910">[f910]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#UI_STATUS_TILES">UI_STATUS_TILES</a>,Y</span></span><span class="ce">; Load the tile to draw at the current tile index.</span></span>
<span class="l"><a class="anc" name="f913" href="#f913">[f913]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_advanceIndexes">@_advanceIndexes</a></span></span><span class="ce">; If this is 0x00, we've reached the end of the run. Advance indexes.</span></span>
<span class="l"><a class="anc" name="f915" href="#f915">[f915]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Else, write the tile.</span></span>
<span class="l"><a class="anc" name="f918" href="#f918">[f918]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; tileIndex++</span></span>
<span class="l"><a class="anc" name="f919" href="#f919">[f919]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_drawTiles">@_drawTiles</a></span></span><span class="ce">; Loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":f91b:@_advanceIndexes"></a><div class="c">;
; Advance to the next set of tiles and the next lower address
; (draw position) in the lookup tables.
;
</div><span class="l"><a class="anc" name="f91b" href="#f91b">[f91b]</a><a href="#:f91b:@_advanceIndexes" class="lla">@_advanceIndexes:</a><span class="ce">; [$f91b]</span></span>
<span class="l"><a class="anc" name="f91b" href="#f91b">[f91b]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; tileIndex++</span></span>
<span class="l"><a class="anc" name="f91c" href="#f91c">[f91c]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; position++</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Check if we've completed the lookup table.
;
; There's only 7 addresses/positions to work with.
;
</div><span class="l"><a class="anc" name="f91d" href="#f91d">[f91d]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$07</span></span><span class="ce">; Have we reached the end (draw position 7)?</span></span>
<span class="l"><a class="anc" name="f91f" href="#f91f">[f91f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_goToNextPosition">@_goToNextPosition</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We've finished drawing the status UI.
;
</div><span class="l"><a class="anc" name="f921" href="#f921">[f921]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_DrawSelectedItem">UI_DrawSelectedItem</a></span></span></span>
<span class="l"><a class="anc" name="f924" href="#f924">[f924]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="f926" href="#f926">[f926]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#IScriptOrCHRAddr">IScriptOrCHRAddr</a></span></span></span>
<span class="l"><a class="anc" name="f928" href="#f928">[f928]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$81</span></span></span>
<span class="l"><a class="anc" name="f92a" href="#f92a">[f92a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#IScriptOrCHRAddr_U">IScriptOrCHRAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="f92c" href="#f92c">[f92c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f92e" href="#f92e">[f92e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="f930" href="#f930">[f930]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="f932" href="#f932">[f932]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="f934" href="#f934">[f934]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="f936" href="#f936">[f936]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$3c</span></span></span>
<span class="l"><a class="anc" name="f938" href="#f938">[f938]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_WriteTilesFromCHRRAM">PPU_WriteTilesFromCHRRAM</a></span></span></span>
<span class="l"><a class="anc" name="f93b" href="#f93b">[f93b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_CheckReachedNextTitle"></a><div class="cp">;============================================================================
; Check if the player reached the next title.
;
; If the player's experience passed the necessary threshold,
; the title will be increased by 1. It will never go up more
; than 1.
;
; INPUTS:
;     <a href="RAM.html#Experience_U">Experience_U</a>:
;         The upper byte of the experience to check.
;
;     <a href="RAM.html#Experience">Experience</a>:
;         The lower byte of the experience to check.
;
;     <a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a>:
;         The current player title is checked.
;
; OUTPUTS:
;     <a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a>:
;         The player title is updated as needed.
;
; XREFS:
;     <a href="#Player_UpdateExperience">Player_UpdateExperience</a>
;============================================================================
</div><span class="l"><a class="anc" name="f93c" href="#f93c">[f93c]</a><a href="#Player_CheckReachedNextTitle" class="la">Player_CheckReachedNextTitle:</a><span class="ce">; [$f93c]</span></span>
<span class="l"><a class="anc" name="f93c" href="#f93c">[f93c]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a></span></span></span>
<span class="l"><a class="anc" name="f93f" href="#f93f">[f93f]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0f</span></span><span class="ce">; Have we hit the max title? (There are 15)</span></span>
<span class="l"><a class="anc" name="f941" href="#f941">[f941]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If yes, exit.</span></span>
<span class="l"><a class="anc" name="f943" href="#f943">[f943]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span><span class="ce">; Convert to an index in the lookup table.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the 16-bit experience level for the title.
;
</div><span class="l"><a class="anc" name="f944" href="#f944">[f944]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="f945" href="#f945">[f945]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Load the lower byte from the lookup table.</span></span>
<span class="l"><a class="anc" name="f948" href="#f948">[f948]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="#PLAYER_TITLE_EXP_NEEDED">PLAYER_TITLE_EXP_NEEDED</a>,X</span></span><span class="ce">; Compare it.</span></span>
<span class="l"><a class="anc" name="f94b" href="#f94b">[f94b]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Load the upper byte from the lookup table.</span></span>
<span class="l"><a class="anc" name="f94e" href="#f94e">[f94e]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="#PLAYER_TITLE_EXP_NEEDED">PLAYER_TITLE_EXP_NEEDED</a>+1,X</span></span><span class="ce">; Compare it.</span></span>
<span class="l"><a class="anc" name="f951" href="#f951">[f951]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If we're under, exit.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player has met the next title's requirements.
;
</div><span class="l"><a class="anc" name="f953" href="#f953">[f953]</a><span class="cd"><span class="i">INC</span> <span class="o">a:<a href="RAM.html#NextPlayerTitle">NextPlayerTitle</a></span></span><span class="ce">; We have enough. Increase the player's next title.</span></span>
<span class="l"></span>
<a name=":f956:@_return"></a><span class="l"><a class="anc" name="f956" href="#f956">[f956]</a><a href="#:f956:@_return" class="lla">@_return:</a><span class="ce">; [$f956]</span></span>
<span class="l"><a class="anc" name="f956" href="#f956">[f956]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_UpdateExperience"></a><div class="cp">;============================================================================
; Update experience for the player.
;
; This will update from upper and lower values in RAM.
;
; INPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of experience to add.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The upper byte of experience to add.
;
; OUTPUTS:
;     None
;
; XREFS:
;     <a href="PRG14.html#Player_AddExperienceFromSprite">Player_AddExperienceFromSprite</a>
;     <a href="#Player_Add100XP">Player_Add100XP</a>
;============================================================================
</div><span class="l"><a class="anc" name="f957" href="#f957">[f957]</a><a href="#Player_UpdateExperience" class="la">Player_UpdateExperience:</a><span class="ce">; [$f957]</span></span>
<div class="c">;
; Update the lower byte of experience.
;
</div><span class="l"><a class="anc" name="f957" href="#f957">[f957]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Load the current lower byte of experience.</span></span>
<span class="l"><a class="anc" name="f95a" href="#f95a">[f95a]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f95b" href="#f95b">[f95b]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="f95d" href="#f95d">[f95d]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Set the new lower byte of experience.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Update the upper byte of experience.
;
</div><span class="l"><a class="anc" name="f960" href="#f960">[f960]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Load the current upper byte of experience.</span></span>
<span class="l"><a class="anc" name="f963" href="#f963">[f963]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="f965" href="#f965">[f965]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Set the new upper byte of experience.</span></span>
<span class="l"><a class="anc" name="f968" href="#f968">[f968]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__f972">@LAB_PRG15_MIRROR__f972</a></span></span><span class="ce">; Can we add to the experience, or did we hit a max?</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; We hit the maximum amount of experience. Make sure
; this is capped.
;
</div><span class="l"><a class="anc" name="f96a" href="#f96a">[f96a]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f96c" href="#f96c">[f96c]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Set lower byte of experience to max.</span></span>
<span class="l"><a class="anc" name="f96f" href="#f96f">[f96f]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Set upper byte of experience to max.</span></span>
<span class="l"></span>
<a name=":f972:@LAB_PRG15_MIRROR__f972"></a><span class="l"><a class="anc" name="f972" href="#f972">[f972]</a><a href="#:f972:@LAB_PRG15_MIRROR__f972" class="lla">@LAB_PRG15_MIRROR__f972:</a><span class="ce">; [$f972]</span></span>
<span class="l"><a class="anc" name="f972" href="#f972">[f972]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_CheckReachedNextTitle">Player_CheckReachedNextTitle</a></span></span><span class="ce">; Check if the next title has been hit.</span></span>
<span class="l"></span>
<div class="c">;
; Fall through to the next function.
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawPlayerExperience"></a><div class="cp">;============================================================================
; Render the player experience.
;
; This will set the draw position to 0x2050 (the location of
; the first digit of the experience), store out the experience
; to render, and then trigger the render.
;
; INPUTS:
;     <a href="RAM.html#Experience_U">Experience_U</a>:
;         The upper byte of the experience.
;
;     <a href="RAM.html#Experience">Experience</a>:
;         The lower byte of the experience.
;
; OUTPUTS:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         The upper byte of the location to render to.
;
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         The lower byte of the location to render to.
;
;     $ee:
;         TODO: Currently unknown.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;
; XREFS:
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a class="anc" name="f975" href="#f975">[f975]</a><a href="#UI_DrawPlayerExperience" class="la">UI_DrawPlayerExperience:</a><span class="ce">; [$f975]</span></span>
<div class="c">;
; Set the address of the first digit of the experience to write
; (0x2050).
;
</div><span class="l"><a class="anc" name="f975" href="#f975">[f975]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f977" href="#f977">[f977]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Store 0x20 as the upper byte.</span></span>
<span class="l"><a class="anc" name="f979" href="#f979">[f979]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$50</span></span></span>
<span class="l"><a class="anc" name="f97b" href="#f97b">[f97b]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Store 0x50 as the upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Store the new experience back out to <a href="RAM.html#Temp_Int24">Temp_Int24</a> and
; <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1.
;
</div><span class="l"><a class="anc" name="f97d" href="#f97d">[f97d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience">Experience</a></span></span><span class="ce">; Load the lower byte of the experience.</span></span>
<span class="l"><a class="anc" name="f980" href="#f980">[f980]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Save to <a href="RAM.html#Temp_Int24">Temp_Int24</a>.</span></span>
<span class="l"><a class="anc" name="f982" href="#f982">[f982]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Experience_U">Experience_U</a></span></span><span class="ce">; Load the upper byte of the experience.</span></span>
<span class="l"><a class="anc" name="f985" href="#f985">[f985]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Save to <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1.</span></span>
<span class="l"><a class="anc" name="f987" href="#f987">[f987]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f989" href="#f989">[f989]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"><a class="anc" name="f98b" href="#f98b">[f98b]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$05</span></span></span>
<span class="l"><a class="anc" name="f98d" href="#f98d">[f98d]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a></span></span><span class="ce">; Trigger the render.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawTimeValue"></a><div class="cp">;============================================================================
; Draw the number of seconds remaining for an item.
;
; This is used for items like the Wingboots and Glove.
;
; Only the lower byte of the 24-bit value is ever needed.
;
; INPUTS:
;     A:
;         The number of seconds to draw.
;
; OUTPUTS:
;     None
;
; SIDE EFFECTS:
;     $ee:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;         Clobbered.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;
; XREFS:
;     <a href="#Game_DecWingBootsDuration">Game_DecWingBootsDuration</a>
;     <a href="#Player_UseWingBoots">Player_UseWingBoots</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a class="anc" name="f990" href="#f990">[f990]</a><a href="#UI_DrawTimeValue" class="la">UI_DrawTimeValue:</a><span class="ce">; [$f990]</span></span>
<div class="c">;
; Set the number of seconds remaining as a 24-bit integer.
;
; Only the lower byte is used. The rest are 0'd out.
;
</div><span class="l"><a class="anc" name="f990" href="#f990">[f990]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Set number of seconds as the lower byte.</span></span>
<span class="l"><a class="anc" name="f992" href="#f992">[f992]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="f994" href="#f994">[f994]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Set middle byte = 0.</span></span>
<span class="l"><a class="anc" name="f996" href="#f996">[f996]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; Set upper byte = 0.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the draw position (first digit of time remaining).
; This is 0x2058.
;
</div><span class="l"><a class="anc" name="f998" href="#f998">[f998]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f99a" href="#f99a">[f99a]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Set high byte of position as 0x20.</span></span>
<span class="l"><a class="anc" name="f99c" href="#f99c">[f99c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$58</span></span></span>
<span class="l"><a class="anc" name="f99e" href="#f99e">[f99e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set high byte of position as 0x58.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the digits with zero-padding.
;
</div><span class="l"><a class="anc" name="f9a0" href="#f9a0">[f9a0]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$02</span></span><span class="ce">; Set the number of digits to draw.</span></span>
<span class="l"><a class="anc" name="f9a2" href="#f9a2">[f9a2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a></span></span><span class="ce">; Draw the digits with zero-padding.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SubtractGold"></a><div class="cp">;============================================================================
; Subtract gold from the player.
;
; This takes in gold as the 24-bit
; $ee:<a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:<a href="RAM.html#Temp_Int24">Temp_Int24</a>
; and reduces those values from the player's gold.
;
; After subtracting, this will be drawn to the screen.
;
; INPUTS:
;     $ee:
;         The upper byte of the 24-bit gold value to subtract.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit gold value to
;         subtract.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit gold value to
;         subtract.
;
; OUTPUTS:
;     <a href="RAM.html#Gold_U">Gold_U</a>:
;         The new upper byte of the current gold value.
;
;     <a href="RAM.html#Gold_M">Gold_M</a>:
;         The new middle byte of the current gold value.
;
;     <a href="RAM.html#Gold">Gold</a>:
;         The new lower byte of the current gold value.
;
; CALLS:
;     <a href="#UI_DrawGoldValue">UI_DrawGoldValue</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_ProgressivelySubtractGold">IScripts_ProgressivelySubtractGold</a>
;============================================================================
</div><span class="l"><a class="anc" name="f9a5" href="#f9a5">[f9a5]</a><a href="#Player_SubtractGold" class="la">Player_SubtractGold:</a><span class="ce">; [$f9a5]</span></span>
<div class="c">;
; Subtract from the lower byte.
;
</div><span class="l"><a class="anc" name="f9a5" href="#f9a5">[f9a5]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Load the lower byte of the current amount.</span></span>
<span class="l"><a class="anc" name="f9a8" href="#f9a8">[f9a8]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="f9a9" href="#f9a9">[f9a9]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Subtract the provided value.</span></span>
<span class="l"><a class="anc" name="f9ab" href="#f9ab">[f9ab]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Store as the new lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Subtract from the middle byte.
;
</div><span class="l"><a class="anc" name="f9ae" href="#f9ae">[f9ae]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Load the middle byte of the current amount.</span></span>
<span class="l"><a class="anc" name="f9b1" href="#f9b1">[f9b1]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Subtract the provided value and the carry.</span></span>
<span class="l"><a class="anc" name="f9b3" href="#f9b3">[f9b3]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Store as the new middle byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Subtract from the upper byte.
;
</div><span class="l"><a class="anc" name="f9b6" href="#f9b6">[f9b6]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Load the upper byte of the current amount.</span></span>
<span class="l"><a class="anc" name="f9b9" href="#f9b9">[f9b9]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$00</span></span><span class="ce">; Subtract the carry.</span></span>
<span class="l"><a class="anc" name="f9bb" href="#f9bb">[f9bb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the new amount.
;
</div><span class="l"><a class="anc" name="f9be" href="#f9be">[f9be]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawGoldValue">UI_DrawGoldValue</a></span></span><span class="ce">; Draw the new amount of gold.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_AddGold"></a><div class="cp">;============================================================================
; Add gold to the player.
;
; This takes in gold as the 24-bit
; $ee:<a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:<a href="RAM.html#Temp_Int24">Temp_Int24</a>
; and adds those values from the player's gold.
;
; After adding, this will be drawn to the screen.
;
; INPUTS:
;     $ee:
;         The upper byte of the 24-bit gold value to add.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit gold value to add.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit gold value to add.
;
; OUTPUTS:
;     <a href="RAM.html#Gold_U">Gold_U</a>:
;         The new upper byte of the current gold value.
;
;     <a href="RAM.html#Gold_M">Gold_M</a>:
;         The new middle byte of the current gold value.
;
;     <a href="RAM.html#Gold">Gold</a>:
;         The new lower byte of the current gold value.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;
; XREFS:
;     <a href="PRG12.html#IScripts_ProgressivelyAddGold">IScripts_ProgressivelyAddGold</a>
;============================================================================
</div><span class="l"><a class="anc" name="f9c1" href="#f9c1">[f9c1]</a><a href="#Player_AddGold" class="la">Player_AddGold:</a><span class="ce">; [$f9c1]</span></span>
<div class="c">;
; Add to the lower byte.
;
</div><span class="l"><a class="anc" name="f9c1" href="#f9c1">[f9c1]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Load the lower byte of the current amount.</span></span>
<span class="l"><a class="anc" name="f9c4" href="#f9c4">[f9c4]</a><span class="cd"><span class="i">CLC</span></span></span>
<span class="l"><a class="anc" name="f9c5" href="#f9c5">[f9c5]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Add the new amount.</span></span>
<span class="l"><a class="anc" name="f9c7" href="#f9c7">[f9c7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Store as the new lower byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add to the middle byte.
;
</div><span class="l"><a class="anc" name="f9ca" href="#f9ca">[f9ca]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Load the middle byte of the current amount.</span></span>
<span class="l"><a class="anc" name="f9cd" href="#f9cd">[f9cd]</a><span class="cd"><span class="i">ADC</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Add the new amount + carry.</span></span>
<span class="l"><a class="anc" name="f9cf" href="#f9cf">[f9cf]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Store as the new middle byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Add to the upper byte.
;
</div><span class="l"><a class="anc" name="f9d2" href="#f9d2">[f9d2]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Load the upper byte of the current amount.</span></span>
<span class="l"><a class="anc" name="f9d5" href="#f9d5">[f9d5]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span><span class="ce">; Add the carry.</span></span>
<span class="l"><a class="anc" name="f9d7" href="#f9d7">[f9d7]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Store as the new upper byte.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If there's no carry, draw the value. Otherwise, we've
; maxed out the gold, so set that explicitly and then draw.
;
</div><span class="l"><a class="anc" name="f9da" href="#f9da">[f9da]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#UI_DrawGoldValue">UI_DrawGoldValue</a></span></span><span class="ce">; If no carry, draw the current amount.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Carry was set. We're maxed. Make it official.
;
</div><span class="l"><a class="anc" name="f9dc" href="#f9dc">[f9dc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$ff</span></span></span>
<span class="l"><a class="anc" name="f9de" href="#f9de">[f9de]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Set lower to max.</span></span>
<span class="l"><a class="anc" name="f9e1" href="#f9e1">[f9e1]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Set middle to max.</span></span>
<span class="l"><a class="anc" name="f9e4" href="#f9e4">[f9e4]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Set upper to max.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawGoldValue"></a><div class="cp">;============================================================================
; Draw the current gold display in the status UI.
;
; The gold will be rendered at the start position of
; 0x2070 (first digit of the gold amount).
;
; This is rendered zero-padded.
;
; INPUTS:
;     <a href="RAM.html#Gold_U">Gold_U</a>:
;         Upper byte of the 24-bit gold value.
;
;     <a href="RAM.html#Gold_M">Gold_M</a>:
;         Middle byte of the 24-bit gold value.
;
;     <a href="RAM.html#Gold">Gold</a>:
;         Lower byte of the 24-bit gold value.
;
; OUTPUTS:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;     $ee:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>:
;     <a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a>+1:
;         Clobbered.
;
; CALLS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>;;
;
; XREFS:
;     <a href="PRG14.html#Player_HandleTouchCoin">Player_HandleTouchCoin</a>
;     <a href="#Player_AddGold">Player_AddGold</a>
;     <a href="#Player_SubtractGold">Player_SubtractGold</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a class="anc" name="f9e7" href="#f9e7">[f9e7]</a><a href="#UI_DrawGoldValue" class="la">UI_DrawGoldValue:</a><span class="ce">; [$f9e7]</span></span>
<div class="c">;
; Set the draw position for the first digit of gold.
; This is 0x2070.
;
</div><span class="l"><a class="anc" name="f9e7" href="#f9e7">[f9e7]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="f9e9" href="#f9e9">[f9e9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span><span class="ce">; Set the upper byte to 0x20.</span></span>
<span class="l"><a class="anc" name="f9eb" href="#f9eb">[f9eb]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$70</span></span></span>
<span class="l"><a class="anc" name="f9ed" href="#f9ed">[f9ed]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span><span class="ce">; Set the lower byte to 0x70.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Load the gold into the 24-bit temporary integer used for
; drawing digits.
;
</div><span class="l"><a class="anc" name="f9ef" href="#f9ef">[f9ef]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold">Gold</a></span></span><span class="ce">; Load the lower byte of the gold value.</span></span>
<span class="l"><a class="anc" name="f9f2" href="#f9f2">[f9f2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Set a the lower byte for the digits to draw.</span></span>
<span class="l"><a class="anc" name="f9f4" href="#f9f4">[f9f4]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_M">Gold_M</a></span></span><span class="ce">; Load the middle byte of the gold value.</span></span>
<span class="l"><a class="anc" name="f9f7" href="#f9f7">[f9f7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Set a the middle byte for the digits to draw.</span></span>
<span class="l"><a class="anc" name="f9f9" href="#f9f9">[f9f9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#Gold_U">Gold_U</a></span></span><span class="ce">; Load the upper byte of the gold value.</span></span>
<span class="l"><a class="anc" name="f9fc" href="#f9fc">[f9fc]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; Set a the upper byte for the digits to draw.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Draw the new amount as 7 digits, zero-padded.
;
</div><span class="l"><a class="anc" name="f9fe" href="#f9fe">[f9fe]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="fa00" href="#fa00">[fa00]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a></span></span><span class="ce">; Draw 7 digits of gold.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="TextBox_DrawZeroPaddedNumber"></a><div class="cp">;============================================================================
; Draw a 0-padded 24-bit number at the textbox draw position.
;
; This will draw a number up to a specific number of digits
; (maximum of 7) at the current textbox draw position,
; filling the width with leading zeros.
;
; It starts by populating all zeros, and then follows up
; by filling in any values from the number.
;
; INPUTS:
;     Y:
;         The number of digits in total.
;
;     $ee:
;         The upper byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new write offset into the PPU buffer.
;
; CALLS:
;     <a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#UI_PopulateDigits">UI_PopulateDigits</a>
;
; XREFS:
;     <a href="PRG12.html#PlayerMenu_ShowStatusMenu">PlayerMenu_ShowStatusMenu</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa03" href="#fa03">[fa03]</a><a href="#TextBox_DrawZeroPaddedNumber" class="la">TextBox_DrawZeroPaddedNumber:</a><span class="ce">; [$fa03]</span></span>
<span class="l"><a class="anc" name="fa03" href="#fa03">[fa03]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a></span></span><span class="ce">; Set the PPU position address for the text.</span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawDigitsZeroPadded"></a><div class="cp">;============================================================================
; Draw a 0-padded 24-bit number to the screen.
;
; This will draw a number up to a specific number of digits
; (maximum of 7) at the current PPU target address, filling
; the width with leading zeros.
;
; It starts by populating all zeros, and then follows up
; by filling in any values from the number.
;
; INPUTS:
;     Y:
;         The number of digits in total.
;
;     $ee:
;         The upper byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new write offset into the PPU buffer.
;
; CALLS:
;     <a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#UI_PopulateDigits">UI_PopulateDigits</a>
;
; XREFS:
;     <a href="#UI_DrawGoldValue">UI_DrawGoldValue</a>
;     <a href="#UI_DrawPlayerExperience">UI_DrawPlayerExperience</a>
;     <a href="#UI_DrawTimeValue">UI_DrawTimeValue</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa06" href="#fa06">[fa06]</a><a href="#UI_DrawDigitsZeroPadded" class="la">UI_DrawDigitsZeroPadded:</a><span class="ce">; [$fa06]</span></span>
<span class="l"><a class="anc" name="fa06" href="#fa06">[fa06]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (number of digits).</span></span>
<span class="l"><a class="anc" name="fa07" href="#fa07">[fa07]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="fa08" href="#fa08">[fa08]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_PopulateDigits">UI_PopulateDigits</a></span></span><span class="ce">; Populate the ASCII digits to render.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name="UI_DrawDigitsZeroPadded_Populated"></a><div class="c">;
; Queue the number of tiles to draw in the PPU buffer.
;
;
; XREFS:
;     <a href="#UI_DrawDigitsNoLeadingZeroes">UI_DrawDigitsNoLeadingZeroes</a>
;
</div><span class="l"><a class="anc" name="fa0b" href="#fa0b">[fa0b]</a><a href="#UI_DrawDigitsZeroPadded_Populated" class="la">UI_DrawDigitsZeroPadded_Populated:</a><span class="ce">; [$fa0b]</span></span>
<span class="l"><a class="anc" name="fa0b" href="#fa0b">[fa0b]</a><span class="cd"><span class="i">PLA</span></span><span class="ce">; Pull the number of digits from the stack.</span></span>
<span class="l"><a class="anc" name="fa0c" href="#fa0c">[fa0c]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = A</span></span>
<span class="l"><a class="anc" name="fa0d" href="#fa0d">[fa0d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span><span class="ce">; Set as the number of tiles to draw in the PPU buffer.</span></span>
<span class="l"><a class="anc" name="fa10" href="#fa10">[fa10]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Store the number temporarily.</span></span>
<span class="l"><a class="anc" name="fa12" href="#fa12">[fa12]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span><span class="ce">; A = 7 (maximum number of digits).</span></span>
<span class="l"><a class="anc" name="fa14" href="#fa14">[fa14]</a><span class="cd"><span class="i">SEC</span></span></span>
<span class="l"><a class="anc" name="fa15" href="#fa15">[fa15]</a><span class="cd"><span class="i">SBC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Subtract the number of tiles to draw.</span></span>
<span class="l"><a class="anc" name="fa17" href="#fa17">[fa17]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = result (loop counter).</span></span>
<span class="l"></span>
<a name=":fa18:@_drawDigitsLoop"></a><span class="l"><a class="anc" name="fa18" href="#fa18">[fa18]</a><a href="#:fa18:@_drawDigitsLoop" class="lla">@_drawDigitsLoop:</a><span class="ce">; [$fa18]</span></span>
<span class="l"><a class="anc" name="fa18" href="#fa18">[fa18]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,Y</span></span><span class="ce">; Load the digit to draw at this index.</span></span>
<span class="l"><a class="anc" name="fa1b" href="#fa1b">[fa1b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span><span class="ce">; Set it in the PPU buffer.</span></span>
<span class="l"><a class="anc" name="fa1e" href="#fa1e">[fa1e]</a><span class="cd"><span class="i">INY</span></span><span class="ce">; Y++</span></span>
<span class="l"><a class="anc" name="fa1f" href="#fa1f">[fa1f]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$07</span></span><span class="ce">; Is it 7 (max)?</span></span>
<span class="l"><a class="anc" name="fa21" href="#fa21">[fa21]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_drawDigitsLoop">@_drawDigitsLoop</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"><a class="anc" name="fa23" href="#fa23">[fa23]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span><span class="ce">; Store the resulting PPU buffer write offset.</span></span>
<span class="l"><a class="anc" name="fa25" href="#fa25">[fa25]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawDigitsNoLeadingZeroes"></a><div class="cp">;============================================================================
; Draw a space-padded 24-bit number to the screen.
;
; This will draw a number up to a specific number of digits
; (maximum of 7) at the current PPU target address, filling
; the width with spaces.
;
; It starts by populating all spaces, and then follows up
; by filling in any values from the number.
;
; INPUTS:
;     Y:
;         The number of digits in total.
;
;     $ee:
;         The upper byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     <a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a>:
;         The new write offset into the PPU buffer.
;
; CALLS:
;     <a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a>
;     <a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a>
;     <a href="#PPUBuffer_Set">PPUBuffer_Set</a>
;     <a href="#UI_PopulateDigitsNoLeadingZeroes">UI_PopulateDigitsNoLeadingZeroes</a>
;
; XREFS:
;     <a href="PRG12.html#Shop_Draw">Shop_Draw</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa26" href="#fa26">[fa26]</a><a href="#UI_DrawDigitsNoLeadingZeroes" class="la">UI_DrawDigitsNoLeadingZeroes:</a><span class="ce">; [$fa26]</span></span>
<span class="l"><a class="anc" name="fa26" href="#fa26">[fa26]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_SetAddrForTextBoxPos">PPU_SetAddrForTextBoxPos</a></span></span><span class="ce">; Set the PPU position address for the text.</span></span>
<span class="l"><a class="anc" name="fa29" href="#fa29">[fa29]</a><span class="cd"><span class="i">TYA</span></span><span class="ce">; A = Y (number of digits)</span></span>
<span class="l"><a class="anc" name="fa2a" href="#fa2a">[fa2a]</a><span class="cd"><span class="i">PHA</span></span><span class="ce">; Push it to the stack.</span></span>
<span class="l"><a class="anc" name="fa2b" href="#fa2b">[fa2b]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_PopulateDigitsNoLeadingZeroes">UI_PopulateDigitsNoLeadingZeroes</a></span></span><span class="ce">; Populate the digits with no leading zeros.</span></span>
<span class="l"><a class="anc" name="fa2e" href="#fa2e">[fa2e]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#UI_DrawDigitsZeroPadded_Populated">UI_DrawDigitsZeroPadded_Populated</a></span></span><span class="ce">; Draw the digits.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_PopulateDigitsNoLeadingZeroes"></a><div class="cp">;============================================================================
; Populate digits but with leading "0"s empty.
;
; This will populate the digits and then loop through them
; (up to 6 digits), NULing out all leading "0" digits so
; they don't display.
;
; INPUTS:
;     X:
;         The starting index into the digits.
;
; OUTPUTS:
;     <a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>:
;         The updated digits.
;
; CALLS:
;     <a href="#UI_PopulateDigits">UI_PopulateDigits</a>
;
; XREFS:
;     <a href="#UI_DrawDigitsNoLeadingZeroes">UI_DrawDigitsNoLeadingZeroes</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa31" href="#fa31">[fa31]</a><a href="#UI_PopulateDigitsNoLeadingZeroes" class="la">UI_PopulateDigitsNoLeadingZeroes:</a><span class="ce">; [$fa31]</span></span>
<span class="l"><a class="anc" name="fa31" href="#fa31">[fa31]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_PopulateDigits">UI_PopulateDigits</a></span></span><span class="ce">; Populate the ASCII digits.</span></span>
<span class="l"><a class="anc" name="fa34" href="#fa34">[fa34]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; Start at the provided index + 1.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fa35:@_loop"></a><div class="c">;
; Check if the digit displays "0". If not, we're done.
;
</div><span class="l"><a class="anc" name="fa35" href="#fa35">[fa35]</a><a href="#:fa35:@_loop" class="lla">@_loop:</a><span class="ce">; [$fa35]</span></span>
<span class="l"><a class="anc" name="fa35" href="#fa35">[fa35]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,X</span></span><span class="ce">; Load the current ASCII digit.</span></span>
<span class="l"><a class="anc" name="fa38" href="#fa38">[fa38]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$30</span></span><span class="ce">; Is it an ASCII "0"?</span></span>
<span class="l"><a class="anc" name="fa3a" href="#fa3a">[fa3a]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_return">@_return</a></span></span><span class="ce">; If not, we're done.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Clear out the digit entirely.
;
</div><span class="l"><a class="anc" name="fa3c" href="#fa3c">[fa3c]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; NUL out this digit.</span></span>
<span class="l"><a class="anc" name="fa3e" href="#fa3e">[fa3e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,X</span></span><span class="ce">; Store that as the new digit value.</span></span>
<span class="l"><a class="anc" name="fa41" href="#fa41">[fa41]</a><span class="cd"><span class="i">INX</span></span><span class="ce">; i++</span></span>
<span class="l"><a class="anc" name="fa42" href="#fa42">[fa42]</a><span class="cd"><span class="i">CPX</span> <span class="o">#$06</span></span><span class="ce">; Are we at the end of the loop?</span></span>
<span class="l"><a class="anc" name="fa44" href="#fa44">[fa44]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not, loop again.</span></span>
<span class="l"></span>
<a name=":fa46:@_return"></a><span class="l"><a class="anc" name="fa46" href="#fa46">[fa46]</a><a href="#:fa46:@_return" class="lla">@_return:</a><span class="ce">; [$fa46]</span></span>
<span class="l"><a class="anc" name="fa46" href="#fa46">[fa46]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_PopulateDigits"></a><div class="cp">;============================================================================
; Populate RAM with the digits to set based in the status UI.
;
; This will take the 24-bit value stored in
; $ee:<a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:<a href="RAM.html#Temp_Int24">Temp_Int24</a>.
;
; It will loop through every digit, convert to ASCII, and
; store in <a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a> for render.
;
; INPUTS:
;     $ee:
;         The upper byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     <a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>:
;         The resulting digits in ASCII form.
;
; CALLS:
;     <a href="#UI_GetValueForDigit">UI_GetValueForDigit</a>
;
; XREFS:
;     <a href="#UI_DrawDigitsZeroPadded">UI_DrawDigitsZeroPadded</a>
;     <a href="#UI_PopulateDigitsNoLeadingZeroes">UI_PopulateDigitsNoLeadingZeroes</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa47" href="#fa47">[fa47]</a><a href="#UI_PopulateDigits" class="la">UI_PopulateDigits:</a><span class="ce">; [$fa47]</span></span>
<div class="c">;
; Prepare to loop 7 times (the max number of digits).
;
</div><span class="l"><a class="anc" name="fa47" href="#fa47">[fa47]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$06</span></span><span class="ce">; Set the upper bound for the loop. We'll count down.</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fa49:@_loop"></a><div class="c">;
; Get the value for the next digit and convert to ASCII.
;
</div><span class="l"><a class="anc" name="fa49" href="#fa49">[fa49]</a><a href="#:fa49:@_loop" class="lla">@_loop:</a><span class="ce">; [$fa49]</span></span>
<span class="l"><a class="anc" name="fa49" href="#fa49">[fa49]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_GetValueForDigit">UI_GetValueForDigit</a></span></span><span class="ce">; Get the value for this digit.</span></span>
<span class="l"><a class="anc" name="fa4c" href="#fa4c">[fa4c]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$30</span></span><span class="ce">; Normalize the value to an ASCII digit.</span></span>
<span class="l"><a class="anc" name="fa4e" href="#fa4e">[fa4e]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#UI_DigitsToRender">UI_DigitsToRender</a>,X</span></span><span class="ce">; Store in the target position in RAM.</span></span>
<span class="l"><a class="anc" name="fa51" href="#fa51">[fa51]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; i--</span></span>
<span class="l"><a class="anc" name="fa52" href="#fa52">[fa52]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; Loop if we're not done.</span></span>
<span class="l"><a class="anc" name="fa54" href="#fa54">[fa54]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_GetValueForDigit"></a><div class="cp">;============================================================================
; Return a numeric value for status line UI display.
;
; This takes a 24-bit value (representing the gold or
; experience, in practice) and converts it to a numeric
; value between 0 and 9.
;
; It does this by considering the unsigned integer value
; (stored as
; $ee:<a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:<a href="RAM.html#Temp_Int24">Temp_Int24</a>).
;
; It loops for each of the 24 bits, left-shifting and
; rotating the most-significant bit into A (the resulting
; value). If A &gt;= 10, it will subtract 10 and set the
; quotient bit incrementing @{symbol Temp3_L}. Rinse and
; repeat.
;
; After 24 iterations, the the remainder will be in A, and
; this will be a value between 0 and 9.
;
; The upper, middle, and lower values will be modified to
; divide by 10, which allows this to be called repeatedly
; to get every digit.
;
; INPUTS:
;     $ee:
;         The upper byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         The middle byte of the 24-bit value.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         The lower byte of the 24-bit value.
;
; OUTPUTS:
;     A:
;         The resulting digit (between 0 and 9).
;
;     $ee:
;         Upper byte of the floor of the value / 10.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>+1:
;         Middle byte of the floor of the value / 10.
;
;     <a href="RAM.html#Temp_Int24">Temp_Int24</a>:
;         Lower byte of the floor of the value / 10.
;
; XREFS:
;     <a href="#UI_PopulateDigits">UI_PopulateDigits</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa55" href="#fa55">[fa55]</a><a href="#UI_GetValueForDigit" class="la">UI_GetValueForDigit:</a><span class="ce">; [$fa55]</span></span>
<span class="l"><a class="anc" name="fa55" href="#fa55">[fa55]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$18</span></span><span class="ce">; Prepare to loop over the 24 bits.</span></span>
<span class="l"><a class="anc" name="fa57" href="#fa57">[fa57]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span><span class="ce">; Set A (our value) = 0.</span></span>
<span class="l"></span>
<a name=":fa59:@_loop"></a><span class="l"><a class="anc" name="fa59" href="#fa59">[fa59]</a><a href="#:fa59:@_loop" class="lla">@_loop:</a><span class="ce">; [$fa59]</span></span>
<span class="l"><a class="anc" name="fa59" href="#fa59">[fa59]</a><span class="cd"><span class="i">ASL</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Shift the low byte &lt;&lt; 1;
Set C as the out going bit.</span></span>
<span class="l"><a class="anc" name="fa5b" href="#fa5b">[fa5b]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span><span class="ce">; Set mid byte = (mid &lt;&lt; 1) | C</span></span>
<span class="l"><a class="anc" name="fa5d" href="#fa5d">[fa5d]</a><span class="cd"><span class="i">ROL</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span><span class="ce">; Set high byte = (high &lt;&lt; 1) | C</span></span>
<span class="l"><a class="anc" name="fa5f" href="#fa5f">[fa5f]</a><span class="cd"><span class="i">ROL</span> <span class="o">A</span></span><span class="ce">; Set A = (A &lt;&lt; 1) | outgoing bit of high byte</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; If the remainder (A) &gt;= 10, subtract 10 and set the
; quotient bit (by incrementing <a href="RAM.html#Temp_Int24">Temp_Int24</a>).
;
</div><span class="l"><a class="anc" name="fa60" href="#fa60">[fa60]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$0a</span></span><span class="ce">; Is A &gt;= 10?</span></span>
<span class="l"><a class="anc" name="fa62" href="#fa62">[fa62]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_finishLoopIter">@_finishLoopIter</a></span></span><span class="ce">; Branch if not.</span></span>
<span class="l"><a class="anc" name="fa64" href="#fa64">[fa64]</a><span class="cd"><span class="i">SBC</span> <span class="o">#$0a</span></span><span class="ce">; A &gt;= 10, so subtract 10.</span></span>
<span class="l"><a class="anc" name="fa66" href="#fa66">[fa66]</a><span class="cd"><span class="i">INC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span><span class="ce">; Set quotient bit to 1.</span></span>
<span class="l"></span>
<a name=":fa68:@_finishLoopIter"></a><span class="l"><a class="anc" name="fa68" href="#fa68">[fa68]</a><a href="#:fa68:@_finishLoopIter" class="lla">@_finishLoopIter:</a><span class="ce">; [$fa68]</span></span>
<span class="l"><a class="anc" name="fa68" href="#fa68">[fa68]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; i-- (process next bit)</span></span>
<span class="l"><a class="anc" name="fa69" href="#fa69">[fa69]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; Loop until we hit 0.</span></span>
<span class="l"><a class="anc" name="fa6b" href="#fa6b">[fa6b]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="STATUS_BAR_PPU_ADDR_L"></a><span class="l"><a class="anc" name="fa6c" href="#fa6c">[fa6c]</a><a href="#STATUS_BAR_PPU_ADDR_L" class="la">STATUS_BAR_PPU_ADDR_L:</a><span class="ce">; [$fa6c]</span></span>
<span class="l"><a class="anc" name="fa6c" href="#fa6c">[fa6c]</a><span class="cd"><span class="i">db</span> <span class="o">$63</span></span><span class="ce">; [0]: Power bar</span></span>
<span class="l"></span>
<a name="STATUS_BAR_PPU_ADDR_L_1_"></a><div class="c">;
; XREFS:
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;
</div><span class="l"><a class="anc" name="fa6d" href="#fa6d">[fa6d]</a><a href="#STATUS_BAR_PPU_ADDR_L_1_" class="la">STATUS_BAR_PPU_ADDR_L_1_:</a><span class="ce">; [$fa6d]</span></span>
<span class="l"><a class="anc" name="fa6d" href="#fa6d">[fa6d]</a><span class="cd"><span class="i">db</span> <span class="o">$43</span></span><span class="ce">; [1]: Mana bar</span></span>
<span class="l"><a class="anc" name="fa6e" href="#fa6e">[fa6e]</a><span class="cd"><span class="i">db</span> <span class="o">$08</span></span><span class="ce">; [0]: Power bar</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__fa6e_1_"></a><div class="c">;
; XREFS:
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;
</div><span class="l"><a class="anc" name="fa6f" href="#fa6f">[fa6f]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__fa6e_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__fa6e_1_:</a><span class="ce">; [$fa6f]</span></span>
<span class="l"><a class="anc" name="fa6f" href="#fa6f">[fa6f]</a><span class="cd"><span class="i">db</span> <span class="o">$09</span></span><span class="ce">; [1]: Manab ar</span></span>
<span class="l"><a class="anc" name="fa70" href="#fa70">[fa70]</a><span class="cd"><span class="i">db</span> <span class="o">$0c</span></span><span class="ce">; [0]: Power bar</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__fa70_1_"></a><div class="c">;
; XREFS:
;     <a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a>
;
</div><span class="l"><a class="anc" name="fa71" href="#fa71">[fa71]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__fa70_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__fa70_1_:</a><span class="ce">; [$fa71]</span></span>
<span class="l"><a class="anc" name="fa71" href="#fa71">[fa71]</a><span class="cd"><span class="i">db</span> <span class="o">$0d</span></span><span class="ce">; [1]: Mana bar</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__fa72"></a><span class="l"><a class="anc" name="fa72" href="#fa72">[fa72]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__fa72" class="la">BYTE_ARRAY_PRG15_MIRROR__fa72:</a><span class="ce">; [$fa72]</span></span>
<span class="l"><a class="anc" name="fa72" href="#fa72">[fa72]</a><span class="cd"><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [0]:</span></span>
<span class="l"></span>
<a name="BYTE_ARRAY_PRG15_MIRROR__fa72_1_"></a><span class="l"><a class="anc" name="fa73" href="#fa73">[fa73]</a><a href="#BYTE_ARRAY_PRG15_MIRROR__fa72_1_" class="la">BYTE_ARRAY_PRG15_MIRROR__fa72_1_:</a><span class="ce">; [$fa73]</span></span>
<span class="l"><a class="anc" name="fa73" href="#fa73">[fa73]</a><span class="cd"><span class="i">db</span> <span class="o">$d0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="fa74" href="#fa74">[fa74]</a><span class="cd"><span class="i">db</span> <span class="o">$60</span></span><span class="ce">; [2]:</span></span>
</pre><pre><a name="UI_DrawPlayerHPValue"></a><div class="cp">;============================================================================
; TODO: Document UI_DrawPlayerHPValue
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddHP">IScriptAction_AddHP</a>
;     <a href="#Player_AddHP">Player_AddHP</a>
;     <a href="#UI_DrawPlayerHP">UI_DrawPlayerHP</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa75" href="#fa75">[fa75]</a><a href="#UI_DrawPlayerHPValue" class="la">UI_DrawPlayerHPValue:</a><span class="ce">; [$fa75]</span></span>
<div class="c">;
; Cap the amount of HP to 80, if over.
;
</div><span class="l"><a class="anc" name="fa75" href="#fa75">[fa75]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$51</span></span></span>
<span class="l"><a class="anc" name="fa77" href="#fa77">[fa77]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fa7b">@LAB_PRG15_MIRROR__fa7b</a></span></span></span>
<span class="l"><a class="anc" name="fa79" href="#fa79">[fa79]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$50</span></span></span>
<span class="l"></span>
<a name=":fa7b:@LAB_PRG15_MIRROR__fa7b"></a><span class="l"><a class="anc" name="fa7b" href="#fa7b">[fa7b]</a><a href="#:fa7b:@LAB_PRG15_MIRROR__fa7b" class="lla">@LAB_PRG15_MIRROR__fa7b:</a><span class="ce">; [$fa7b]</span></span>
<span class="l"><a class="anc" name="fa7b" href="#fa7b">[fa7b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Temp_AddedHPValue">Temp_AddedHPValue</a></span></span></span>
<span class="l"><a class="anc" name="fa7e" href="#fa7e">[fa7e]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_HP_U">Player_HP_U</a></span></span></span>
<span class="l"><a class="anc" name="fa81" href="#fa81">[fa81]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="fa83" href="#fa83">[fa83]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#UI_DrawManaOrHPBar">UI_DrawManaOrHPBar</a></span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div><span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Player_SetMP"></a><div class="cp">;============================================================================
; Set the number of mana points for the player.
;
; Once set, the mana bar will be drawn to reflect the new amount.
;
; INPUT:
;     A:
;         The mana points to set.
;
; OUTPUT:
;     None
;
; XREFS:
;     <a href="PRG12.html#IScriptAction_AddMP">IScriptAction_AddMP</a>
;     <a href="#Player_AddMP">Player_AddMP</a>
;     <a href="#Player_ReduceMP">Player_ReduceMP</a>
;     <a href="#UI_DrawHUD">UI_DrawHUD</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa85" href="#fa85">[fa85]</a><a href="#Player_SetMP" class="la">Player_SetMP:</a><span class="ce">; [$fa85]</span></span>
<div class="c">;
; Cap the number of mana points to 80, if over.
;
</div><span class="l"><a class="anc" name="fa85" href="#fa85">[fa85]</a><span class="cd"><span class="i">CMP</span> <span class="o">#$51</span></span><span class="ce">; Check if over 80 mana points.</span></span>
<span class="l"><a class="anc" name="fa87" href="#fa87">[fa87]</a><span class="cd"><span class="i">BCC</span> <span class="o"><a href="#@_storePoints">@_storePoints</a></span></span><span class="ce">; If not over, we'll store what was passed in.</span></span>
<span class="l"><a class="anc" name="fa89" href="#fa89">[fa89]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$50</span></span><span class="ce">; Cap to 80 mana points.</span></span>
<span class="l"></span>
<a name=":fa8b:@_storePoints"></a><span class="l"><a class="anc" name="fa8b" href="#fa8b">[fa8b]</a><a href="#:fa8b:@_storePoints" class="lla">@_storePoints:</a><span class="ce">; [$fa8b]</span></span>
<span class="l"><a class="anc" name="fa8b" href="#fa8b">[fa8b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#Player_MP">Player_MP</a></span></span><span class="ce">; Set the player's current mana points.</span></span>
<span class="l"><a class="anc" name="fa8e" href="#fa8e">[fa8e]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$01</span></span></span>
<span class="l"></span>
<div class="c">;
; v-- Fall through --v
;
</div></pre><pre><a name="UI_DrawManaOrHPBar"></a><div class="cp">;============================================================================
; TODO: Document UI_DrawManaOrHPBar
;
; INPUTS:
;     A
;     Y
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#UI_DrawPlayerHPValue">UI_DrawPlayerHPValue</a>
;============================================================================
</div><span class="l"><a class="anc" name="fa90" href="#fa90">[fa90]</a><a href="#UI_DrawManaOrHPBar" class="la">UI_DrawManaOrHPBar:</a><span class="ce">; [$fa90]</span></span>
<div class="c">;
; Set the upper byte of the 24-bit integer of the value to draw.
;
</div><span class="l"><a class="anc" name="fa90" href="#fa90">[fa90]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"><a class="anc" name="fa92" href="#fa92">[fa92]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#UI_MPAndHPBarWidth">UI_MPAndHPBarWidth</a></span></span></span>
<span class="l"><a class="anc" name="fa95" href="#fa95">[fa95]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fa96" href="#fa96">[fa96]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fa97" href="#fa97">[fa97]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fa98" href="#fa98">[fa98]</a><span class="cd"><span class="i">CMP</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"><a class="anc" name="fa9a" href="#fa9a">[fa9a]</a><span class="cd"><span class="i">BCS</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fa9e">@LAB_PRG15_MIRROR__fa9e</a></span></span></span>
<span class="l"><a class="anc" name="fa9c" href="#fa9c">[fa9c]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"></span>
<a name=":fa9e:@LAB_PRG15_MIRROR__fa9e"></a><span class="l"><a class="anc" name="fa9e" href="#fa9e">[fa9e]</a><a href="#:fa9e:@LAB_PRG15_MIRROR__fa9e" class="lla">@LAB_PRG15_MIRROR__fa9e:</a><span class="ce">; [$fa9e]</span></span>
<span class="l"><a class="anc" name="fa9e" href="#fa9e">[fa9e]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Set the draw position for the bar to update.
; This will be based on the lower address from the
; <a href="#STATUS_BAR_PPU_ADDR_L">STATUS_BAR_PPU_ADDR_L</a> lookup table.
;
; Bar 0 is the Mana bar.
; Bar 1 is the Power bar.
;
</div><span class="l"><a class="anc" name="faa0" href="#faa0">[faa0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="faa2" href="#faa2">[faa2]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="faa4" href="#faa4">[faa4]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#STATUS_BAR_PPU_ADDR_L">STATUS_BAR_PPU_ADDR_L</a>,Y</span></span></span>
<span class="l"><a class="anc" name="faa7" href="#faa7">[faa7]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="faa9" href="#faa9">[faa9]</a><span class="cd"><span class="i">LDX</span> <span class="o">a:<a href="RAM.html#UI_MPAndHPBarWidth">UI_MPAndHPBarWidth</a></span></span></span>
<span class="l"><a class="anc" name="faac" href="#faac">[faac]</a><span class="cd"><span class="i">INX</span></span></span>
<span class="l"><a class="anc" name="faad" href="#faad">[faad]</a><span class="cd"><span class="i">TXA</span></span></span>
<span class="l"><a class="anc" name="faae" href="#faae">[faae]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><a class="anc" name="fab1" href="#fab1">[fab1]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"><a class="anc" name="fab3" href="#fab3">[fab3]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fab4" href="#fab4">[fab4]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fab5" href="#fab5">[fab5]</a><span class="cd"><span class="i">LSR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fab6" href="#fab6">[fab6]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fac6">@LAB_PRG15_MIRROR__fac6</a></span></span></span>
<span class="l"><a class="anc" name="fab8" href="#fab8">[fab8]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="fab9" href="#fab9">[fab9]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="fabb" href="#fabb">[fabb]</a><span class="cd"><span class="i">LDA</span> <span class="o">$fa6e,Y</span></span></span>
<span class="l"></span>
<a name=":fabe:@LAB_PRG15_MIRROR__fabe"></a><span class="l"><a class="anc" name="fabe" href="#fabe">[fabe]</a><a href="#:fabe:@LAB_PRG15_MIRROR__fabe" class="lla">@LAB_PRG15_MIRROR__fabe:</a><span class="ce">; [$fabe]</span></span>
<span class="l"><a class="anc" name="fabe" href="#fabe">[fabe]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><a class="anc" name="fac1" href="#fac1">[fac1]</a><span class="cd"><span class="i">DEC</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="fac3" href="#fac3">[fac3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fabe">@LAB_PRG15_MIRROR__fabe</a></span></span></span>
<span class="l"><a class="anc" name="fac5" href="#fac5">[fac5]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"></span>
<a name=":fac6:@LAB_PRG15_MIRROR__fac6"></a><span class="l"><a class="anc" name="fac6" href="#fac6">[fac6]</a><a href="#:fac6:@LAB_PRG15_MIRROR__fac6" class="lla">@LAB_PRG15_MIRROR__fac6:</a><span class="ce">; [$fac6]</span></span>
<span class="l"><a class="anc" name="fac6" href="#fac6">[fac6]</a><span class="cd"><span class="i">CMP</span> <span class="o">a:<a href="RAM.html#UI_MPAndHPBarWidth">UI_MPAndHPBarWidth</a></span></span></span>
<span class="l"><a class="anc" name="fac9" href="#fac9">[fac9]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fae2">@LAB_PRG15_MIRROR__fae2</a></span></span></span>
<span class="l"><a class="anc" name="facb" href="#facb">[facb]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="facc" href="#facc">[facc]</a><span class="cd"><span class="i">LDA</span> <span class="o">$fa70,Y</span></span></span>
<span class="l"><a class="anc" name="facf" href="#facf">[facf]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><a class="anc" name="fad2" href="#fad2">[fad2]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="fad3" href="#fad3">[fad3]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="fad4" href="#fad4">[fad4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$07</span></span></span>
<span class="l"></span>
<a name=":fad6:@LAB_PRG15_MIRROR__fad6"></a><span class="l"><a class="anc" name="fad6" href="#fad6">[fad6]</a><a href="#:fad6:@LAB_PRG15_MIRROR__fad6" class="lla">@LAB_PRG15_MIRROR__fad6:</a><span class="ce">; [$fad6]</span></span>
<span class="l"><a class="anc" name="fad6" href="#fad6">[fad6]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fad7" href="#fad7">[fad7]</a><span class="cd"><span class="i">CPY</span> <span class="o">a:<a href="RAM.html#UI_MPAndHPBarWidth">UI_MPAndHPBarWidth</a></span></span></span>
<span class="l"><a class="anc" name="fada" href="#fada">[fada]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fae2">@LAB_PRG15_MIRROR__fae2</a></span></span></span>
<span class="l"><a class="anc" name="fadc" href="#fadc">[fadc]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><a class="anc" name="fadf" href="#fadf">[fadf]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fad6">@LAB_PRG15_MIRROR__fad6</a></span></span></span>
<span class="l"></span>
<a name=":fae2:@LAB_PRG15_MIRROR__fae2"></a><span class="l"><a class="anc" name="fae2" href="#fae2">[fae2]</a><a href="#:fae2:@LAB_PRG15_MIRROR__fae2" class="lla">@LAB_PRG15_MIRROR__fae2:</a><span class="ce">; [$fae2]</span></span>
<span class="l"><a class="anc" name="fae2" href="#fae2">[fae2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$0b</span></span></span>
<span class="l"><a class="anc" name="fae4" href="#fae4">[fae4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><a class="anc" name="fae7" href="#fae7">[fae7]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="fae9" href="#fae9">[fae9]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"><a class="anc" name="faeb" href="#faeb">[faeb]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="faed" href="#faed">[faed]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Math_MultiplyBy16">Math_MultiplyBy16</a></span></span></span>
<span class="l"><a class="anc" name="faf0" href="#faf0">[faf0]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="faf1" href="#faf1">[faf1]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="faf3" href="#faf3">[faf3]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="faf5" href="#faf5">[faf5]</a><span class="cd"><span class="i">LDX</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"><a class="anc" name="faf7" href="#faf7">[faf7]</a><span class="cd"><span class="i">LDA</span> <span class="o">$fa72,X</span></span></span>
<span class="l"><a class="anc" name="fafa" href="#fafa">[fafa]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="fafc" href="#fafc">[fafc]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="fafe" href="#fafe">[fafe]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><a class="anc" name="fb01" href="#fb01">[fb01]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"><a class="anc" name="fb03" href="#fb03">[fb03]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb14">@LAB_PRG15_MIRROR__fb14</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fb05:@LAB_PRG15_MIRROR__fb05"></a><div class="c">;
; DEADCODE: All this is wired off behind <a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a>, which
;           is never actually set. This appears to be code they
;           were working on but never completed/got right. Which
;           would not be a shock since part of it reaches into
;           program code instead of an array of values.
;
</div><span class="l"><a class="anc" name="fb05" href="#fb05">[fb05]</a><a href="#:fb05:@LAB_PRG15_MIRROR__fb05" class="lla">@LAB_PRG15_MIRROR__fb05:</a><span class="ce">; [$fb05]</span></span>
<span class="l"><a class="anc" name="fb05" href="#fb05">[fb05]</a><span class="cd"><span class="i">LDA</span> <span class="o">$fb2f,Y</span></span></span>
<span class="l"><a class="anc" name="fb08" href="#fb08">[fb08]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fb09" href="#fb09">[fb09]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><a class="anc" name="fb0c" href="#fb0c">[fb0c]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fb0d" href="#fb0d">[fb0d]</a><span class="cd"><span class="i">AND</span> <span class="o">#$0f</span></span></span>
<span class="l"><a class="anc" name="fb0f" href="#fb0f">[fb0f]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb05">@LAB_PRG15_MIRROR__fb05</a></span></span></span>
<span class="l"><a class="anc" name="fb11" href="#fb11">[fb11]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="fb13" href="#fb13">[fb13]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name=":fb14:@LAB_PRG15_MIRROR__fb14"></a><span class="l"><a class="anc" name="fb14" href="#fb14">[fb14]</a><a href="#:fb14:@LAB_PRG15_MIRROR__fb14" class="lla">@LAB_PRG15_MIRROR__fb14:</a><span class="ce">; [$fb14]</span></span>
<span class="l"><a class="anc" name="fb14" href="#fb14">[fb14]</a><span class="cd"><span class="i">LDA</span> <span class="o">$fb37,Y</span></span></span>
<span class="l"><a class="anc" name="fb17" href="#fb17">[fb17]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fb18" href="#fb18">[fb18]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"><a class="anc" name="fb1b" href="#fb1b">[fb1b]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fb1c" href="#fb1c">[fb1c]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="fb1e" href="#fb1e">[fb1e]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb14">@LAB_PRG15_MIRROR__fb14</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fb20:@LAB_PRG15_MIRROR__fb20"></a><div class="c">;
; XXX Is this correct? It's reading from program code.
;
</div><span class="l"><a class="anc" name="fb20" href="#fb20">[fb20]</a><a href="#:fb20:@LAB_PRG15_MIRROR__fb20" class="lla">@LAB_PRG15_MIRROR__fb20:</a><span class="ce">; [$fb20]</span></span>
<span class="l"><a class="anc" name="fb20" href="#fb20">[fb20]</a><span class="cd"><span class="i">LDA</span> <span class="o">$fb27,Y</span></span></span>
<span class="l"><a class="anc" name="fb23" href="#fb23">[fb23]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fb24" href="#fb24">[fb24]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_Set">PPUBuffer_Set</a></span></span></span>
<span class="l"></span>
<a name=":fb27:@LAB_PRG15_MIRROR__fb27"></a><span class="l"><a class="anc" name="fb27" href="#fb27">[fb27]</a><a href="#:fb27:@LAB_PRG15_MIRROR__fb27" class="lla">@LAB_PRG15_MIRROR__fb27:</a><span class="ce">; [$fb27]</span></span>
<span class="l"><a class="anc" name="fb27" href="#fb27">[fb27]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fb28" href="#fb28">[fb28]</a><span class="cd"><span class="i">AND</span> <span class="o">#$07</span></span></span>
<span class="l"><a class="anc" name="fb2a" href="#fb2a">[fb2a]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fb20">@LAB_PRG15_MIRROR__fb20</a></span></span></span>
<span class="l"><a class="anc" name="fb2c" href="#fb2c">[fb2c]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="fb2e" href="#fb2e">[fb2e]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<a name="BYTE_PRG15_MIRROR__fb2f"></a><div class="c">;
; XREFS:
;     <a href="#LAB_PRG15_MIRROR__fb05">LAB_PRG15_MIRROR__fb05</a> [$PRG15_MIRROR::fb05]
;
</div><span class="l"><a class="anc" name="fb2f" href="#fb2f">[fb2f]</a><a href="#BYTE_PRG15_MIRROR__fb2f" class="la">BYTE_PRG15_MIRROR__fb2f:</a><span class="ce">; [$fb2f]</span></span>
<span class="l"><a class="anc" name="fb2f" href="#fb2f">[fb2f]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00</span></span><span class="ce">; [$fb2f] byte</span></span>
<span class="l"></span>
<a name="BYTE_PRG15_MIRROR__fb37"></a><div class="c">;
; XREFS:
;     <a href="#LAB_PRG15_MIRROR__fb14">LAB_PRG15_MIRROR__fb14</a> [$PRG15_MIRROR::fb14]
;
</div><span class="l"><a class="anc" name="fb37" href="#fb37">[fb37]</a><a href="#BYTE_PRG15_MIRROR__fb37" class="la">BYTE_PRG15_MIRROR__fb37:</a><span class="ce">; [$fb37]</span></span>
<span class="l"><a class="anc" name="fb37" href="#fb37">[fb37]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$80,$80,$80,$80,$ff,$00</span></span><span class="ce">; [$fb37] byte</span></span>
<span class="l"><a class="anc" name="fb47" href="#fb47">[fb47]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$c0,$c0,$c0,$c0,$ff,$00</span></span><span class="ce">; [$fb47] byte</span></span>
<span class="l"><a class="anc" name="fb57" href="#fb57">[fb57]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$e0,$e0,$e0,$e0,$ff,$00</span></span><span class="ce">; [$fb57] byte</span></span>
<span class="l"><a class="anc" name="fb67" href="#fb67">[fb67]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$f0,$f0,$f0,$f0,$ff,$00</span></span><span class="ce">; [$fb67] byte</span></span>
<span class="l"><a class="anc" name="fb77" href="#fb77">[fb77]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$f8,$f8,$f8,$f8,$ff,$00</span></span><span class="ce">; [$fb77] byte</span></span>
<span class="l"><a class="anc" name="fb87" href="#fb87">[fb87]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$fc,$fc,$fc,$fc,$ff,$00</span></span><span class="ce">; [$fb87] byte</span></span>
<span class="l"><a class="anc" name="fb97" href="#fb97">[fb97]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00,$00,$ff,$fe,$fe,$fe,$fe,$ff,$00</span></span><span class="ce">; [$fb97] byte</span></span>
<span class="l"><a class="anc" name="fba7" href="#fba7">[fba7]</a><span class="cd"><span class="i">db</span> <span class="o">$00,$ff,$00,$00,$00,$00,$ff,$00</span></span><span class="ce">; [$fba7] byte</span></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawSelectedItem"></a><div class="cp">;============================================================================
; TODO: Document UI_DrawSelectedItem
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;============================================================================
</div><span class="l"><a class="anc" name="fbaf" href="#fbaf">[fbaf]</a><a href="#UI_DrawSelectedItem" class="la">UI_DrawSelectedItem:</a><span class="ce">; [$fbaf]</span></span>
<span class="l"><a class="anc" name="fbaf" href="#fbaf">[fbaf]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$13</span></span></span>
<span class="l"><a class="anc" name="fbb1" href="#fbb1">[fbb1]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="fbb4" href="#fbb4">[fbb4]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="fbb6" href="#fbb6">[fbb6]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="fbb9" href="#fbb9">[fbb9]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span></span>
<span class="l"><a class="anc" name="fbbc" href="#fbbc">[fbbc]</a><span class="cd"><span class="i">BPL</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fbc5">@LAB_PRG15_MIRROR__fbc5</a></span></span></span>
<span class="l"><a class="anc" name="fbbe" href="#fbbe">[fbbe]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$40</span></span></span>
<span class="l"><a class="anc" name="fbc0" href="#fbc0">[fbc0]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="fbc2" href="#fbc2">[fbc2]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span></span>
<span class="l"></span>
<a name=":fbc5:@LAB_PRG15_MIRROR__fbc5"></a><span class="l"><a class="anc" name="fbc5" href="#fbc5">[fbc5]</a><a href="#:fbc5:@LAB_PRG15_MIRROR__fbc5" class="lla">@LAB_PRG15_MIRROR__fbc5:</a><span class="ce">; [$fbc5]</span></span>
<span class="l"><a class="anc" name="fbc5" href="#fbc5">[fbc5]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fbc6" href="#fbc6">[fbc6]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fbc7" href="#fbc7">[fbc7]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="fbc8" href="#fbc8">[fbc8]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="fbcb" href="#fbcb">[fbcb]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="fbcc" href="#fbcc">[fbcc]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="fbce" href="#fbce">[fbce]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"></span>
<a name=":fbd1:@LAB_PRG15_MIRROR__fbd1"></a><span class="l"><a class="anc" name="fbd1" href="#fbd1">[fbd1]</a><a href="#:fbd1:@LAB_PRG15_MIRROR__fbd1" class="lla">@LAB_PRG15_MIRROR__fbd1:</a><span class="ce">; [$fbd1]</span></span>
<span class="l"><a class="anc" name="fbd1" href="#fbd1">[fbd1]</a><span class="cd"><span class="i">LDA</span> <span class="o">$b4e4,Y</span></span></span>
<span class="l"><a class="anc" name="fbd4" href="#fbd4">[fbd4]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_Maybe_GetItemSpritePPUTileAddr">UI_Maybe_GetItemSpritePPUTileAddr</a></span></span></span>
<span class="l"><a class="anc" name="fbd7" href="#fbd7">[fbd7]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fbd8" href="#fbd8">[fbd8]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="fbd9" href="#fbd9">[fbd9]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":fbdb:@LAB_PRG15_MIRROR__fbdb"></a><span class="l"><a class="anc" name="fbdb" href="#fbdb">[fbdb]</a><a href="#:fbdb:@LAB_PRG15_MIRROR__fbdb" class="lla">@LAB_PRG15_MIRROR__fbdb:</a><span class="ce">; [$fbdb]</span></span>
<span class="l"><a class="anc" name="fbdb" href="#fbdb">[fbdb]</a><span class="cd"><span class="i">LDA</span> <span class="o">(<a href="RAM.html#Temp_Int24">Temp_Int24</a>),Y</span></span></span>
<span class="l"><a class="anc" name="fbdd" href="#fbdd">[fbdd]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span></span>
<span class="l"><a class="anc" name="fbe0" href="#fbe0">[fbe0]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fbe1" href="#fbe1">[fbe1]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="fbe3" href="#fbe3">[fbe3]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fbdb">@LAB_PRG15_MIRROR__fbdb</a></span></span></span>
<span class="l"><a class="anc" name="fbe5" href="#fbe5">[fbe5]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="fbe6" href="#fbe6">[fbe6]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="fbe7" href="#fbe7">[fbe7]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fbe8" href="#fbe8">[fbe8]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fbe9" href="#fbe9">[fbe9]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="fbeb" href="#fbeb">[fbeb]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fbd1">@LAB_PRG15_MIRROR__fbd1</a></span></span></span>
<span class="l"><a class="anc" name="fbed" href="#fbed">[fbed]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
<span class="l"></span>
</pre><pre><a name="UI_Maybe_GetItemSpritePPUTileAddr"></a><div class="cp">;============================================================================
; TODO: Document UI_Maybe_GetItemSpritePPUTileAddr
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;     <a href="#UI_DrawSelectedItem">UI_DrawSelectedItem</a>
;============================================================================
</div><span class="l"><a class="anc" name="fbf0" href="#fbf0">[fbf0]</a><a href="#UI_Maybe_GetItemSpritePPUTileAddr" class="la">UI_Maybe_GetItemSpritePPUTileAddr:</a><span class="ce">; [$fbf0]</span></span>
<span class="l"><a class="anc" name="fbf0" href="#fbf0">[fbf0]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fbf2" href="#fbf2">[fbf2]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="fbf4" href="#fbf4">[fbf4]</a><span class="cd"><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fbf6" href="#fbf6">[fbf6]</a><span class="cd"><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fbf7" href="#fbf7">[fbf7]</a><span class="cd"><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fbf9" href="#fbf9">[fbf9]</a><span class="cd"><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fbfa" href="#fbfa">[fbfa]</a><span class="cd"><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fbfc" href="#fbfc">[fbfc]</a><span class="cd"><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fbfd" href="#fbfd">[fbfd]</a><span class="cd"><span class="i">LSR</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fbff" href="#fbff">[fbff]</a><span class="cd"><span class="i">ROR</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fc00" href="#fc00">[fc00]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="fc02" href="#fc02">[fc02]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24">Temp_Int24</a></span></span></span>
<span class="l"><a class="anc" name="fc04" href="#fc04">[fc04]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fc06" href="#fc06">[fc06]</a><span class="cd"><span class="i">ADC</span> <span class="o">#$85</span></span></span>
<span class="l"><a class="anc" name="fc08" href="#fc08">[fc08]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_M">Temp_Int24_M</a></span></span></span>
<span class="l"><a class="anc" name="fc0a" href="#fc0a">[fc0a]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
</pre><pre><a name="Player_SetItem"></a><div class="cp">;============================================================================
; TODO: Document Player_SetItem
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#Player_Equip">Player_Equip</a>
;============================================================================
</div><span class="l"><a class="anc" name="fc0b" href="#fc0b">[fc0b]</a><a href="#Player_SetItem" class="la">Player_SetItem:</a><span class="ce">; [$fc0b]</span></span>
<span class="l"><a class="anc" name="fc0b" href="#fc0b">[fc0b]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#SelectedItem">SelectedItem</a></span></span></span>
<span class="l"><a class="anc" name="fc0e" href="#fc0e">[fc0e]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$13</span></span></span>
<span class="l"><a class="anc" name="fc10" href="#fc10">[fc10]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPU_TargetAddr_U">PPU_TargetAddr_U</a></span></span></span>
<span class="l"><a class="anc" name="fc12" href="#fc12">[fc12]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$c0</span></span></span>
<span class="l"><a class="anc" name="fc14" href="#fc14">[fc14]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPU_TargetAddr">PPU_TargetAddr</a></span></span></span>
<span class="l"><a class="anc" name="fc16" href="#fc16">[fc16]</a><span class="cd"><span class="i">ORA</span> <span class="o">#$80</span></span></span>
<span class="l"></span>
</pre><pre><a name="TextBox_LoadItemSourceTiles"></a><div class="cp">;============================================================================
; TODO: Document TextBox_LoadItemSourceTiles
;
; INPUTS:
;     A
;
; OUTPUTS:
;     TODO
;
; XREFS:
;     <a href="PRG12.html#TextBox_DrawItemImage">TextBox_DrawItemImage</a>
;============================================================================
</div><span class="l"><a class="anc" name="fc18" href="#fc18">[fc18]</a><a href="#TextBox_LoadItemSourceTiles" class="la">TextBox_LoadItemSourceTiles:</a><span class="ce">; [$fc18]</span></span>
<span class="l"><a class="anc" name="fc18" href="#fc18">[fc18]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="fc19" href="#fc19">[fc19]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Player_GetInventoryIndexForItem">Player_GetInventoryIndexForItem</a></span></span></span>
<span class="l"><a class="anc" name="fc1c" href="#fc1c">[fc1c]</a><span class="cd"><span class="i">TAX</span></span></span>
<span class="l"><a class="anc" name="fc1d" href="#fc1d">[fc1d]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE">FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE</a>,X</span></span></span>
<span class="l"><a class="anc" name="fc20" href="#fc20">[fc20]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Temp_Int24_U">Temp_Int24_U</a></span></span></span>
<span class="l"><a class="anc" name="fc22" href="#fc22">[fc22]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="#FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE">FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE</a>,X</span></span></span>
<span class="l"><a class="anc" name="fc25" href="#fc25">[fc25]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Maybe_Temp4">Maybe_Temp4</a></span></span></span>
<span class="l"><a class="anc" name="fc27" href="#fc27">[fc27]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="fc28" href="#fc28">[fc28]</a><span class="cd"><span class="i">AND</span> <span class="o">#$1f</span></span></span>
<span class="l"><a class="anc" name="fc2a" href="#fc2a">[fc2a]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fc2b" href="#fc2b">[fc2b]</a><span class="cd"><span class="i">ASL</span> <span class="o">A</span></span></span>
<span class="l"><a class="anc" name="fc2c" href="#fc2c">[fc2c]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="fc2d" href="#fc2d">[fc2d]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#CurrentROMBank">CurrentROMBank</a></span></span></span>
<span class="l"><a class="anc" name="fc30" href="#fc30">[fc30]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="fc31" href="#fc31">[fc31]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$0a</span></span></span>
<span class="l"><a class="anc" name="fc33" href="#fc33">[fc33]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_UpdateROMBank">MMC1_UpdateROMBank</a></span></span></span>
<span class="l"></span>
<a name=":fc36:@LAB_PRG15_MIRROR__fc36"></a><span class="l"><a class="anc" name="fc36" href="#fc36">[fc36]</a><a href="#:fc36:@LAB_PRG15_MIRROR__fc36" class="lla">@LAB_PRG15_MIRROR__fc36:</a><span class="ce">; [$fc36]</span></span>
<span class="l"><a class="anc" name="fc36" href="#fc36">[fc36]</a><span class="cd"><span class="i">LDA</span> <span class="o">($ee),Y</span></span></span>
<span class="l"><a class="anc" name="fc38" href="#fc38">[fc38]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#UI_Maybe_GetItemSpritePPUTileAddr">UI_Maybe_GetItemSpritePPUTileAddr</a></span></span></span>
<span class="l"><a class="anc" name="fc3b" href="#fc3b">[fc3b]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fc3c" href="#fc3c">[fc3c]</a><span class="cd"><span class="i">PHA</span></span></span>
<span class="l"><a class="anc" name="fc3d" href="#fc3d">[fc3d]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="fc3f" href="#fc3f">[fc3f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_QueueCommandOrLength">PPUBuffer_QueueCommandOrLength</a></span></span></span>
<span class="l"><a class="anc" name="fc42" href="#fc42">[fc42]</a><span class="cd"><span class="i">LDY</span> <span class="o">#$00</span></span></span>
<span class="l"></span>
<a name=":fc44:@LAB_PRG15_MIRROR__fc44"></a><span class="l"><a class="anc" name="fc44" href="#fc44">[fc44]</a><a href="#:fc44:@LAB_PRG15_MIRROR__fc44" class="lla">@LAB_PRG15_MIRROR__fc44:</a><span class="ce">; [$fc44]</span></span>
<span class="l"><a class="anc" name="fc44" href="#fc44">[fc44]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPUBuffer_WriteFromTemp">PPUBuffer_WriteFromTemp</a></span></span></span>
<span class="l"><a class="anc" name="fc47" href="#fc47">[fc47]</a><span class="cd"><span class="i">CPY</span> <span class="o">#$10</span></span></span>
<span class="l"><a class="anc" name="fc49" href="#fc49">[fc49]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fc44">@LAB_PRG15_MIRROR__fc44</a></span></span></span>
<span class="l"><a class="anc" name="fc4b" href="#fc4b">[fc4b]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#PPUBuffer_WriteOffset">PPUBuffer_WriteOffset</a></span></span></span>
<span class="l"><a class="anc" name="fc4d" href="#fc4d">[fc4d]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_IncrementAddrBy16">PPU_IncrementAddrBy16</a></span></span></span>
<span class="l"><a class="anc" name="fc50" href="#fc50">[fc50]</a><span class="cd"><span class="i">PLA</span></span></span>
<span class="l"><a class="anc" name="fc51" href="#fc51">[fc51]</a><span class="cd"><span class="i">TAY</span></span></span>
<span class="l"><a class="anc" name="fc52" href="#fc52">[fc52]</a><span class="cd"><span class="i">INY</span></span></span>
<span class="l"><a class="anc" name="fc53" href="#fc53">[fc53]</a><span class="cd"><span class="i">TYA</span></span></span>
<span class="l"><a class="anc" name="fc54" href="#fc54">[fc54]</a><span class="cd"><span class="i">AND</span> <span class="o">#$03</span></span></span>
<span class="l"><a class="anc" name="fc56" href="#fc56">[fc56]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@LAB_PRG15_MIRROR__fc36">@LAB_PRG15_MIRROR__fc36</a></span></span></span>
<span class="l"><a class="anc" name="fc58" href="#fc58">[fc58]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#MMC1_UpdatePRGBankToStackA">MMC1_UpdatePRGBankToStackA</a></span></span></span>
<span class="l"></span>
<a name="FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE"></a><div class="c">;
; XREFS:
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;
</div><span class="l"><a class="anc" name="fc5b" href="#fc5b">[fc5b]</a><a href="#FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE" class="la">FUN_PRG15_MIRROR__fc0b__LOWER_ADDR_TABLE:</a><span class="ce">; [$fc5b]</span></span>
<span class="l"><a class="anc" name="fc5b" href="#fc5b">[fc5b]</a><span class="cd"><span class="i">db</span> <span class="o">$a0</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="fc5c" href="#fc5c">[fc5c]</a><span class="cd"><span class="i">db</span> <span class="o">$b0</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="fc5d" href="#fc5d">[fc5d]</a><span class="cd"><span class="i">db</span> <span class="o">$c0</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="fc5e" href="#fc5e">[fc5e]</a><span class="cd"><span class="i">db</span> <span class="o">$d0</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="fc5f" href="#fc5f">[fc5f]</a><span class="cd"><span class="i">db</span> <span class="o">$e4</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<a name="FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE"></a><div class="c">;
; XREFS:
;     <a href="#TextBox_LoadItemSourceTiles">TextBox_LoadItemSourceTiles</a>
;
</div><span class="l"><a class="anc" name="fc60" href="#fc60">[fc60]</a><a href="#FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE" class="la">FUN_PRG15_MIRROR__fc0b__UPPER_ADDR_TABLE:</a><span class="ce">; [$fc60]</span></span>
<span class="l"><a class="anc" name="fc60" href="#fc60">[fc60]</a><span class="cd"><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [0]:</span></span>
<span class="l"><a class="anc" name="fc61" href="#fc61">[fc61]</a><span class="cd"><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [1]:</span></span>
<span class="l"><a class="anc" name="fc62" href="#fc62">[fc62]</a><span class="cd"><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [2]:</span></span>
<span class="l"><a class="anc" name="fc63" href="#fc63">[fc63]</a><span class="cd"><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [3]:</span></span>
<span class="l"><a class="anc" name="fc64" href="#fc64">[fc64]</a><span class="cd"><span class="i">db</span> <span class="o">$b4</span></span><span class="ce">; [4]:</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="Game_ShowStartScreen"></a><div class="cp">;============================================================================
; Show the start screen and handle game start or password selection.
;
; This is shown just after the game boots. The screen will
; be drawn and will wait on input from the player, allowing
; them to start the game or enter the password screen.
;
; INPUTS:
;     None.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Game_Start">Game_Start</a>
;     <a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a>
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>
;     <a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a>
;     <a href="#Player_Spawn">Player_Spawn</a>
;     <a href="#Screen_ResetSpritesForNonGame">Screen_ResetSpritesForNonGame</a>
;     <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>
;     <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;     <a href="#WaitForNextFrame">WaitForNextFrame</a>
;
; XREFS:
;     <a href="#Game_InitStateForStartScreen">Game_InitStateForStartScreen</a>
;============================================================================
</div><span class="l"><a class="anc" name="fc65" href="#fc65">[fc65]</a><a href="#Game_ShowStartScreen" class="la">Game_ShowStartScreen:</a><span class="ce">; [$fc65]</span></span>
<span class="l"><a class="anc" name="fc65" href="#fc65">[fc65]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$ff</span></span><span class="ce">; X = 0xFF</span></span>
<span class="l"><a class="anc" name="fc67" href="#fc67">[fc67]</a><span class="cd"><span class="i">TXS</span></span><span class="ce">; Store X in memory.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>.
;
</div><span class="l"><a class="anc" name="fc68" href="#fc68">[fc68]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><a class="anc" name="fc6b" href="#fc6b">[fc6b]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="fc6c" href="#fc6c">[fc6c]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fc6e:@_waitForInput"></a><div class="c">;
; Wait for a choice at the game's start screen.
;
</div><span class="l"><a class="anc" name="fc6e" href="#fc6e">[fc6e]</a><a href="#:fc6e:@_waitForInput" class="lla">@_waitForInput:</a><span class="ce">; [$fc6e]</span></span>
<span class="l"><a class="anc" name="fc6e" href="#fc6e">[fc6e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#WaitForNextFrame">WaitForNextFrame</a></span></span><span class="ce">; Wait for the next frame.</span></span>
<span class="l"><a class="anc" name="fc71" href="#fc71">[fc71]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#Screen_ResetSpritesForNonGame">Screen_ResetSpritesForNonGame</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>.
;
</div><span class="l"><a class="anc" name="fc74" href="#fc74">[fc74]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><a class="anc" name="fc77" href="#fc77">[fc77]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="fc78" href="#fc78">[fc78]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a></span></span>
<span class="l"></span>
<a name=":fc7a:@_afterCheckHandleInputFarJump"></a><span class="l"><a class="anc" name="fc7a" href="#fc7a">[fc7a]</a><a href="#:fc7a:@_afterCheckHandleInputFarJump" class="lla">@_afterCheckHandleInputFarJump:</a><span class="ce">; [$fc7a]</span></span>
<span class="l"><a class="anc" name="fc7a" href="#fc7a">[fc7a]</a><span class="cd"><span class="i">LDA</span> <span class="o"><a href="RAM.html#Joy1_ChangedButtonMask">Joy1_ChangedButtonMask</a></span></span><span class="ce">; Check the changed controller 1 button mask.</span></span>
<span class="l"><a class="anc" name="fc7c" href="#fc7c">[fc7c]</a><span class="cd"><span class="i">AND</span> <span class="o">#$10</span></span><span class="ce">; Was the Start button pressed?</span></span>
<span class="l"><a class="anc" name="fc7e" href="#fc7e">[fc7e]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_waitForInput">@_waitForInput</a></span></span><span class="ce">; If not, loop.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player pressed Start. Check what they chose.
;
; But first, play the titlescreen music.
;
</div><span class="l"><a class="anc" name="fc80" href="#fc80">[fc80]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$08</span></span></span>
<span class="l"><a class="anc" name="fc82" href="#fc82">[fc82]</a><span class="cd"><span class="i">STA</span> <span class="o"><a href="RAM.html#Music_Current">Music_Current</a></span></span></span>
<span class="l"><a class="anc" name="fc84" href="#fc84">[fc84]</a><span class="cd"><span class="i">LDA</span> <span class="o">a:<a href="RAM.html#DAT_0687">DAT_0687</a></span></span><span class="ce">; Check the chosen option.</span></span>
<span class="l"><a class="anc" name="fc87" href="#fc87">[fc87]</a><span class="cd"><span class="i">BEQ</span> <span class="o"><a href="#@_startGame">@_startGame</a></span></span><span class="ce">; If 0, they chose to start the game.
Else, fall through.</span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; The player chose to enter the Password screen.
;
; Switch to bank 12 and run <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>.
;
</div><span class="l"><a class="anc" name="fc89" href="#fc89">[fc89]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><a class="anc" name="fc8c" href="#fc8c">[fc8c]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="fc8d" href="#fc8d">[fc8d]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fc8f:@_afterPasswordScreenShow"></a><div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>.
;
</div><span class="l"><a class="anc" name="fc8f" href="#fc8f">[fc8f]</a><a href="#:fc8f:@_afterPasswordScreenShow" class="lla">@_afterPasswordScreenShow:</a><span class="ce">; [$fc8f]</span></span>
<span class="l"><a class="anc" name="fc8f" href="#fc8f">[fc8f]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><a class="anc" name="fc92" href="#fc92">[fc92]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="fc93" href="#fc93">[fc93]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#Player_SetInitialExpAndGold">Player_SetInitialExpAndGold</a></span></span>
<span class="l"></span>
<a name=":fc95:@_afterSetExpGoldFarJump"></a><span class="l"><a class="anc" name="fc95" href="#fc95">[fc95]</a><a href="#:fc95:@_afterSetExpGoldFarJump" class="lla">@_afterSetExpGoldFarJump:</a><span class="ce">; [$fc95]</span></span>
<span class="l"><a class="anc" name="fc95" href="#fc95">[fc95]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Player_Spawn">Player_Spawn</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fc98:@_startGame"></a><div class="c">;
; The player chose to start the game.
;
; Switch to bank 12 and run <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>.
;
</div><span class="l"><a class="anc" name="fc98" href="#fc98">[fc98]</a><a href="#:fc98:@_startGame" class="lla">@_startGame:</a><span class="ce">; [$fc98]</span></span>
<span class="l"><a class="anc" name="fc98" href="#fc98">[fc98]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><a class="anc" name="fc9b" href="#fc9b">[fc9b]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="fc9c" href="#fc9c">[fc9c]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#SplashAnimation_RunIntro">SplashAnimation_RunIntro</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fc9e:@_afterRunIntroFarJump"></a><div class="c">;
; Switch to bank 12 and run <a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a>.
;
</div><span class="l"><a class="anc" name="fc9e" href="#fc9e">[fc9e]</a><a href="#:fc9e:@_afterRunIntroFarJump" class="lla">@_afterRunIntroFarJump:</a><span class="ce">; [$fc9e]</span></span>
<span class="l"><a class="anc" name="fc9e" href="#fc9e">[fc9e]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#MMC1_LoadBankAndJump">MMC1_LoadBankAndJump</a></span></span><span class="ce">; Jump to:</span></span>
<span class="l"><a class="anc" name="fca1" href="#fca1">[fca1]</a><span class="cd"><span class="i">db</span> <span class="o">BANK_12_LOGIC</span></span><span class="ce">; Bank = 12</span></span>
<span class="l"><a class="anc" name="fca2" href="#fca2">[fca2]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a>-1</span></span><span class="ce">; Address = <a href="PRG12.html#Player_SetStartGameState">Player_SetStartGameState</a></span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fca4:@_afterSetStartGameStateFarJump"></a><div class="c">;
; Begin the game.
;
</div><span class="l"><a class="anc" name="fca4" href="#fca4">[fca4]</a><a href="#:fca4:@_afterSetStartGameStateFarJump" class="lla">@_afterSetStartGameStateFarJump:</a><span class="ce">; [$fca4]</span></span>
<span class="l"><a class="anc" name="fca4" href="#fca4">[fca4]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Game_Start">Game_Start</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="UI_DrawPromptInputSymbol"></a><div class="cp">;============================================================================
; Draw an input-requesting symbol.
;
; This is used to position and animate a symbol indicating
; a need for input.
;
; This is used for terminator symbols on textboxes and for the
; item selection symbols on the start screen and Buy/Sell menus.
;
; INPUTS:
;     A:
;         The sprite and animation frame offset.
;
;     X:
;         The X position of the symbol.
;
;     Y:
;         The Y position of the symbol.
;
; OUTPUTS:
;     None.
;
; CALLS:
;     <a href="#Sprite_SetAppearanceAddrFromOffset">Sprite_SetAppearanceAddrFromOffset</a>
;
; XREFS:
;     <a href="PRG12.html#Menu_UpdateAndDraw">Menu_UpdateAndDraw</a>
;     <a href="PRG12.html#PasswordScreen_DrawSelectionCursor">PasswordScreen_DrawSelectionCursor</a>
;     <a href="PRG12.html#StartScreen_CheckHandleInput">StartScreen_CheckHandleInput</a>
;     <a href="PRG12.html#TextBox_DrawDownArrowTerminatorSymbol">TextBox_DrawDownArrowTerminatorSymbol</a>
;     <a href="PRG12.html#TextBox_DrawQuestionMarkTerminatorSymbol">TextBox_DrawQuestionMarkTerminatorSymbol</a>
;     <a href="PRG12.html#TextBox_DrawUpArrowTerminatorSymbol">TextBox_DrawUpArrowTerminatorSymbol</a>
;============================================================================
</div><span class="l"><a class="anc" name="fca7" href="#fca7">[fca7]</a><a href="#UI_DrawPromptInputSymbol" class="la">UI_DrawPromptInputSymbol:</a><span class="ce">; [$fca7]</span></span>
<span class="l"><a class="anc" name="fca7" href="#fca7">[fca7]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosX">Arg_DrawSprite_PosX</a></span></span><span class="ce">; Set the X argument.</span></span>
<span class="l"><a class="anc" name="fca9" href="#fca9">[fca9]</a><span class="cd"><span class="i">STY</span> <span class="o"><a href="RAM.html#Arg_DrawSprite_PosY">Arg_DrawSprite_PosY</a></span></span><span class="ce">; Set the Y argument.</span></span>
<span class="l"><a class="anc" name="fcab" href="#fcab">[fcab]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="fcad" href="#fcad">[fcad]</a><span class="cd"><span class="i">STX</span> <span class="o"><a href="RAM.html#CurrentSprite_FlipMask">CurrentSprite_FlipMask</a></span></span><span class="ce">; Clear the flip mask.</span></span>
<span class="l"><a class="anc" name="fcaf" href="#fcaf">[fcaf]</a><span class="cd"><span class="i">JMP</span> <span class="o"><a href="#Sprite_SetAppearanceAddrFromOffset">Sprite_SetAppearanceAddrFromOffset</a></span></span><span class="ce">; Set the animation frame and offset of the sprite.</span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_FillData"></a><div class="cp">;============================================================================
; Fill the PPU with a single byte repeated `count` times.
;
; This will always write the value at least once and then
; decrement. If a count of 0 is passed, it will decrement
; to 0xFF, and then loop back down to 0.
;
; INPUTS:
;     A:
;         The value to write.
;
;     Y:
;         The number of times to write the value.
;
;         If 0, this will write 256 times.
;
; OUTPUTS:
;     <a href="RAM.html#PPUDATA">PPUDATA</a>:
;         This will be filled with values.
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="#PPU_ClearAllTilemaps">PPU_ClearAllTilemaps</a>
;     <a href="#PPU_FillData">PPU_FillData</a>
;     <a href="#UI_DrawHUDSprites">UI_DrawHUDSprites</a>
;     <a href="#UI_DrawSelectedItem">UI_DrawSelectedItem</a>
;============================================================================
</div><span class="l"><a class="anc" name="fcb2" href="#fcb2">[fcb2]</a><a href="#PPU_FillData" class="la">PPU_FillData:</a><span class="ce">; [$fcb2]</span></span>
<span class="l"><a class="anc" name="fcb2" href="#fcb2">[fcb2]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUDATA">PPUDATA</a></span></span><span class="ce">; Store the value in PPUDATA.</span></span>
<span class="l"><a class="anc" name="fcb5" href="#fcb5">[fcb5]</a><span class="cd"><span class="i">DEY</span></span><span class="ce">; Y--</span></span>
<span class="l"><a class="anc" name="fcb6" href="#fcb6">[fcb6]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><a class="anc" name="fcb8" href="#fcb8">[fcb8]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"></span>
<span class="l"></span>
</pre><pre><a name="PPU_ClearAllTilemaps"></a><div class="cp">;============================================================================
; Clear all tiles across all nametables.
;
; This will fill every tile with 0.
;
; INPUTS:
;     None
;
; OUTPUTS:
;     <a href="RAM.html#PPUADDR">PPUADDR</a>:
;         The updated address.
;
; CALLS:
;     <a href="#PPU_FillData">PPU_FillData</a>
;
; XREFS:
;     <a href="PRG12.html#PasswordScreen_Show">PasswordScreen_Show</a>
;     <a href="PRG12.html#StartScreen_Draw">StartScreen_Draw</a>
;============================================================================
</div><span class="l"><a class="anc" name="fcb9" href="#fcb9">[fcb9]</a><a href="#PPU_ClearAllTilemaps" class="la">PPU_ClearAllTilemaps:</a><span class="ce">; [$fcb9]</span></span>
<div class="c">;
; Set the start position to the top-left ($2000).
;
</div><span class="l"><a class="anc" name="fcb9" href="#fcb9">[fcb9]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$20</span></span></span>
<span class="l"><a class="anc" name="fcbb" href="#fcbb">[fcbb]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"><a class="anc" name="fcbe" href="#fcbe">[fcbe]</a><span class="cd"><span class="i">LDA</span> <span class="o">#$00</span></span></span>
<span class="l"><a class="anc" name="fcc0" href="#fcc0">[fcc0]</a><span class="cd"><span class="i">STA</span> <span class="o">a:<a href="RAM.html#PPUADDR">PPUADDR</a></span></span></span>
<span class="l"></span>
<span class="l"></span>
<div class="c">;
; Prepare the value and loop counter.
;
</div><span class="l"><a class="anc" name="fcc3" href="#fcc3">[fcc3]</a><span class="cd"><span class="i">TAY</span></span><span class="ce">; Y = 0 (value to write)</span></span>
<span class="l"><a class="anc" name="fcc4" href="#fcc4">[fcc4]</a><span class="cd"><span class="i">LDX</span> <span class="o">#$04</span></span><span class="ce">; X = 4 (loop counter)</span></span>
<span class="l"></span>
<span class="l"></span>
<a name=":fcc6:@_loop"></a><div class="c">;
; Begin the loop.
;
</div><span class="l"><a class="anc" name="fcc6" href="#fcc6">[fcc6]</a><a href="#:fcc6:@_loop" class="lla">@_loop:</a><span class="ce">; [$fcc6]</span></span>
<span class="l"><a class="anc" name="fcc6" href="#fcc6">[fcc6]</a><span class="cd"><span class="i">JSR</span> <span class="o"><a href="#PPU_FillData">PPU_FillData</a></span></span><span class="ce">; Fill 256 bytes of data.</span></span>
<span class="l"><a class="anc" name="fcc9" href="#fcc9">[fcc9]</a><span class="cd"><span class="i">DEX</span></span><span class="ce">; X--</span></span>
<span class="l"><a class="anc" name="fcca" href="#fcca">[fcca]</a><span class="cd"><span class="i">BNE</span> <span class="o"><a href="#@_loop">@_loop</a></span></span><span class="ce">; If not 0, loop.</span></span>
<span class="l"><a class="anc" name="fccc" href="#fccc">[fccc]</a><span class="cd"><span class="i">RTS</span></span></span>
<span class="l"><a class="anc" name="fccd" href="#fccd">[fccd]</a><span class="cd"><span class="i">hex</span> <span class="o">bd ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fccd] undefined</span></span>
<span class="l"><a class="anc" name="fcdd" href="#fcdd">[fcdd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fcdd] undefined</span></span>
<span class="l"><a class="anc" name="fced" href="#fced">[fced]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fced] undefined</span></span>
<span class="l"><a class="anc" name="fcfd" href="#fcfd">[fcfd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fcfd] undefined</span></span>
<span class="l"><a class="anc" name="fd0d" href="#fd0d">[fd0d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd0d] undefined</span></span>
<span class="l"><a class="anc" name="fd1d" href="#fd1d">[fd1d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd1d] undefined</span></span>
<span class="l"><a class="anc" name="fd2d" href="#fd2d">[fd2d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd2d] undefined</span></span>
<span class="l"><a class="anc" name="fd3d" href="#fd3d">[fd3d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd3d] undefined</span></span>
<span class="l"><a class="anc" name="fd4d" href="#fd4d">[fd4d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd4d] undefined</span></span>
<span class="l"><a class="anc" name="fd5d" href="#fd5d">[fd5d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd5d] undefined</span></span>
<span class="l"><a class="anc" name="fd6d" href="#fd6d">[fd6d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd6d] undefined</span></span>
<span class="l"><a class="anc" name="fd7d" href="#fd7d">[fd7d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd7d] undefined</span></span>
<span class="l"><a class="anc" name="fd8d" href="#fd8d">[fd8d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd8d] undefined</span></span>
<span class="l"><a class="anc" name="fd9d" href="#fd9d">[fd9d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fd9d] undefined</span></span>
<span class="l"><a class="anc" name="fdad" href="#fdad">[fdad]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdad] undefined</span></span>
<span class="l"><a class="anc" name="fdbd" href="#fdbd">[fdbd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdbd] undefined</span></span>
<span class="l"><a class="anc" name="fdcd" href="#fdcd">[fdcd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdcd] undefined</span></span>
<span class="l"><a class="anc" name="fddd" href="#fddd">[fddd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fddd] undefined</span></span>
<span class="l"><a class="anc" name="fded" href="#fded">[fded]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fded] undefined</span></span>
<span class="l"><a class="anc" name="fdfd" href="#fdfd">[fdfd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fdfd] undefined</span></span>
<span class="l"><a class="anc" name="fe0d" href="#fe0d">[fe0d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe0d] undefined</span></span>
<span class="l"><a class="anc" name="fe1d" href="#fe1d">[fe1d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe1d] undefined</span></span>
<span class="l"><a class="anc" name="fe2d" href="#fe2d">[fe2d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe2d] undefined</span></span>
<span class="l"><a class="anc" name="fe3d" href="#fe3d">[fe3d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe3d] undefined</span></span>
<span class="l"><a class="anc" name="fe4d" href="#fe4d">[fe4d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe4d] undefined</span></span>
<span class="l"><a class="anc" name="fe5d" href="#fe5d">[fe5d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe5d] undefined</span></span>
<span class="l"><a class="anc" name="fe6d" href="#fe6d">[fe6d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe6d] undefined</span></span>
<span class="l"><a class="anc" name="fe7d" href="#fe7d">[fe7d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe7d] undefined</span></span>
<span class="l"><a class="anc" name="fe8d" href="#fe8d">[fe8d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe8d] undefined</span></span>
<span class="l"><a class="anc" name="fe9d" href="#fe9d">[fe9d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fe9d] undefined</span></span>
<span class="l"><a class="anc" name="fead" href="#fead">[fead]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fead] undefined</span></span>
<span class="l"><a class="anc" name="febd" href="#febd">[febd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$febd] undefined</span></span>
<span class="l"><a class="anc" name="fecd" href="#fecd">[fecd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fecd] undefined</span></span>
<span class="l"><a class="anc" name="fedd" href="#fedd">[fedd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fedd] undefined</span></span>
<span class="l"><a class="anc" name="feed" href="#feed">[feed]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$feed] undefined</span></span>
<span class="l"><a class="anc" name="fefd" href="#fefd">[fefd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$fefd] undefined</span></span>
<span class="l"><a class="anc" name="ff0d" href="#ff0d">[ff0d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff0d] undefined</span></span>
<span class="l"><a class="anc" name="ff1d" href="#ff1d">[ff1d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff1d] undefined</span></span>
<span class="l"><a class="anc" name="ff2d" href="#ff2d">[ff2d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff2d] undefined</span></span>
<span class="l"><a class="anc" name="ff3d" href="#ff3d">[ff3d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff3d] undefined</span></span>
<span class="l"><a class="anc" name="ff4d" href="#ff4d">[ff4d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff4d] undefined</span></span>
<span class="l"><a class="anc" name="ff5d" href="#ff5d">[ff5d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff5d] undefined</span></span>
<span class="l"><a class="anc" name="ff6d" href="#ff6d">[ff6d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff6d] undefined</span></span>
<span class="l"><a class="anc" name="ff7d" href="#ff7d">[ff7d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff7d] undefined</span></span>
<span class="l"><a class="anc" name="ff8d" href="#ff8d">[ff8d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff8d] undefined</span></span>
<span class="l"><a class="anc" name="ff9d" href="#ff9d">[ff9d]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ff9d] undefined</span></span>
<span class="l"><a class="anc" name="ffad" href="#ffad">[ffad]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ffad] undefined</span></span>
<span class="l"><a class="anc" name="ffbd" href="#ffbd">[ffbd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ffbd] undefined</span></span>
<span class="l"><a class="anc" name="ffcd" href="#ffcd">[ffcd]</a><span class="cd"><span class="i">hex</span> <span class="o">ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff</span></span><span class="ce">; [$ffcd] undefined</span></span>
<span class="l"><a class="anc" name="ffdd" href="#ffdd">[ffdd]</a><span class="cd"><span class="i">db</span> <span class="o">$ff,$ff,$ff</span></span><span class="ce">; [$ffdd] undefined</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">db</span> <span class="o">$20</span></span><span class="ce">; Game title</span></span>
<span class="l"><a class="anc" name="ffe1" href="#ffe1">[ffe1]</a><span class="cd"><span class="i">db</span> <span class="o">$20,$20,$20,$20,$20,$20,$20,$46,$41,$58,$41,$4e,$41,$44,$55</span></span><span class="ce">; [$ffe1] string</span></span>
<span class="l"></span>
<span class="l"><span class="cd"><span class="i">dw</span> <span class="o">$4227</span></span><span class="ce">; PRG Checksum</span></span>
<span class="l"><a class="anc" name="fff2" href="#fff2">[fff2]</a><span class="cd"><span class="i">dw</span> <span class="o">$0000</span></span><span class="ce">; CHR CHecksum</span></span>
<span class="l"><a class="anc" name="fff4" href="#fff4">[fff4]</a><span class="cd"><span class="i">db</span> <span class="o">$48</span></span><span class="ce">; CHR size: 0 = 8KiB
CHR type: 0 = CHR ROM
PRG size: 5 = 512KiB</span></span>
<span class="l"><a class="anc" name="fff5" href="#fff5">[fff5]</a><span class="cd"><span class="i">db</span> <span class="o">$04</span></span><span class="ce">; Mapper:    4 = MMC
Nametable: 0 = Horizontal arrangement</span></span>
<span class="l"><a class="anc" name="fff6" href="#fff6">[fff6]</a><span class="cd"><span class="i">db</span> <span class="o">$01</span></span><span class="ce">; Title encoding: 1 = ASCII</span></span>
<span class="l"><a class="anc" name="fff7" href="#fff7">[fff7]</a><span class="cd"><span class="i">db</span> <span class="o">$07</span></span><span class="ce">; Title length: 8 bytes</span></span>
<span class="l"><a class="anc" name="fff8" href="#fff8">[fff8]</a><span class="cd"><span class="i">db</span> <span class="o">$18</span></span><span class="ce">; Licensee Code: Hudson Soft</span></span>
<span class="l"><a class="anc" name="fff9" href="#fff9">[fff9]</a><span class="cd"><span class="i">db</span> <span class="o">$94</span></span><span class="ce">; Header validation byte</span></span>
<span class="l"><a class="anc" name="fffa" href="#fffa">[fffa]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#OnInterrupt">OnInterrupt</a></span></span><span class="ce">; <a href="#OnInterrupt">OnInterrupt</a> [$PRG15_MIRROR::fffa]</span></span>
<span class="l"><a class="anc" name="fffc" href="#fffc">[fffc]</a><span class="cd"><span class="i">dw</span> <span class="o"><a href="#Game_Init">Game_Init</a></span></span><span class="ce">; <a href="#Game_Init">Game_Init</a> [$PRG15_MIRROR::fffc]</span></span>
<span class="l"><a class="anc" name="fffe" href="#fffe">[fffe]</a><span class="cd"><span class="i">db</span> <span class="o">$d5</span></span><span class="ce">; [$fffe] undefined</span></span>
<span class="l"></span>
<a name="MMC1_SERIAL"></a><div class="c">;
; XREFS:
;     <a href="#MMC1_Init">MMC1_Init</a>
;
</div><span class="l"><a class="anc" name="ffff" href="#ffff">[ffff]</a><a href="#MMC1_SERIAL" class="la">MMC1_SERIAL:</a><span class="ce">; [$ffff]</span></span>
<span class="l"><a class="anc" name="ffff" href="#ffff">[ffff]</a><span class="cd"><span class="i">db</span> <span class="o">$c9</span></span><span class="ce">; [$ffff] undefined</span></span>
</pre>
 </body>
</html>
